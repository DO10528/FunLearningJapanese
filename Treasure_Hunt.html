<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŸã‹ã‚‰ ã•ãŒã—ã‚²ãƒ¼ãƒ </title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #fffbe6 0%, #ffeccc 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
            color: #5a4a3a;
        }

        #sc-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px; 
            background-color: #ffffff;
            box-shadow: 0 8px 24px rgba(139, 115, 85, 0.15); 
            border-radius: 20px; 
            border: 3px solid #f7d899;
        }
        
        /* --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
        .sc-screen {
            display: none; /* åŸºæœ¬ã¯éè¡¨ç¤º */
        }
        .sc-screen.active {
            display: block; /* .active ãŒä»˜ã„ãŸã‚‚ã®ã ã‘è¡¨ç¤º */
        }

        h1, h2 {
            text-align: center;
            color: #d98a00;
        }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; }
        p { text-align: center; font-size: 1.2em; }

        /* --- ãƒœã‚¿ãƒ³å…±é€š --- */
        .sc-button {
            display: block;
            width: 90%;
            margin: 20px auto;
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            background-color: #ffb100;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 5px solid #d98a00;
        }
        .sc-button:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .sc-button:active {
            transform: scale(1.0) translateY(1px);
            border-bottom-width: 2px;
        }
        .sc-button-secondary {
             background-color: #6c757d;
             border-bottom-color: #4a4e52;
        }
        .sc-button-camera {
             background-color: #e64b3c;
             border-bottom-color: #b32a1e;
        }

        /* --- 1. å‹‰å¼·ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ --- */
        #sc-study-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .sc-study-item {
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sc-study-item:hover {
            background-color: #fffbe6;
        }
        .sc-study-item img {
            width: 100%;
            max-width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .sc-study-item p {
            font-size: 1.1em;
            font-weight: bold;
            margin: 5px 0 0 0;
        }

        /* --- 2. ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ --- */
        #sc-play-sound-button {
            background-color: #48dbfb;
            border-bottom-color: #00a9d9;
            font-size: 1.2em;
            padding: 15px;
        }

        /* --- 3. ã‚«ãƒ¡ãƒ©ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ --- */
        #sc-camera-view-wrapper {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        #sc-video-element {
            width: 100%;
            height: auto;
            display: block;
        }
        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯è£ã§æç”»ã™ã‚‹ãŸã‚éè¡¨ç¤º */
        #sc-canvas-element {
            display: none;
        }

        /* --- 4. çµæœã‚¹ã‚¯ãƒªãƒ¼ãƒ³ --- */
        #sc-result-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            display: block;
            margin: 10px auto;
            border-radius: 10px;
            border: 2px solid #ccc;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            .sc-button { font-size: 1.2em; padding: 15px; }
            #sc-study-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div id="sc-container">

        <div id="sc-screen-study" class="sc-screen active">
            <h1>ã“ã¨ã°ã‚’ãŠã¼ãˆã‚ˆã†</h1>
            <p style="text-align: left;">ã‚¿ãƒƒãƒ—ã—ã¦ãŠã¨ã‚’ ãã„ã¦ã­ã€‚</p>
            <div id="sc-study-grid">
                </div>
            <button id="sc-start-game-button" class="sc-button">ã‚²ãƒ¼ãƒ ã‚’ã¯ã˜ã‚ã‚‹</button>
        </div>

        <div id="sc-screen-game" class="sc-screen">
            <h2>ã•ãŒã—ã‚‚ã®ã‚²ãƒ¼ãƒ </h2>
            <p id="sc-game-prompt">ã—ãŸã®ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ã€ãã“ãˆãŸã‚‚ã®ã‚’ ã•ãŒã—ã¦ã­ï¼</p>
            <button id="sc-play-sound-button" class="sc-button">â–¶ ãŠã¨ã‚’ ãã</button>
            
            <button id="sc-open-camera-button" class="sc-button sc-button-camera" style="display: none;">
                ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’ ã²ã‚‰ã
            </button>
        </div>

        <div id="sc-screen-camera" class="sc-screen">
            <h2>ã¿ã¤ã‘ãŸã‚‰ã€ã—ã‚ƒã—ã‚“ã‚’ã¨ã‚ã†ï¼</h2>
            
            <div id="sc-camera-view-wrapper">
                <video id="sc-video-element" autoplay playsinline></video>
                <canvas id="sc-canvas-element"></canvas>
            </div>
            
            <button id="sc-take-picture-button" class="sc-button sc-button-camera">
                ğŸ“¸ ã—ã‚ƒã—ã‚“ã‚’ã¨ã‚‹
            </button>
            <button id="sc-cancel-camera-button" class="sc-button sc-button-secondary">
                ã‚‚ã©ã‚‹
            </button>
        </div>

        <div id="sc-screen-result" class="sc-screen">
            <h2>ã—ã‚ƒã—ã‚“ãŒ ã¨ã‚ŒãŸã‚ˆï¼</h2>
            <img id="sc-result-image" src="" alt="ã•ã¤ãˆã„ã—ãŸ ã—ã‚ƒã—ã‚“">
            <p id="sc-result-message">ã“ã‚Œã¯ã€Œã€‡ã€‡ã€ã§ã™ã‹ï¼Ÿ<br>ãŠã†ã¡ã®ã²ã¨ã¨ ã“ãŸãˆã‚ã‚ã›ã—ã¦ã­ï¼</p>
            
            <button id="sc-next-problem-button" class="sc-button">
                ã¤ãã®ã‚‚ã‚“ã ã„ã¸
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
            // â€»ç”»åƒã¨éŸ³å£°ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ã€ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
            const ASSET_PATH_IMG = 'assets/images/stationery/';
            const ASSET_PATH_SOUND = 'assets/sounds/stationery/';

            const stationeryWords = [
                { id: 'enpitsu', name: 'ãˆã‚“ã´ã¤', image: 'enpitsu.png', sound: 'enpitsu.mp3' },
                { id: 'keshigomu', name: 'ã‘ã—ã‚´ãƒ ', image: 'keshigomu.png', sound: 'keshigomu.mp3' },
                { id: 'pen', name: 'ãƒšãƒ³', image: 'pen.png', sound: 'pen.mp3' },
                { id: 'note', name: 'ãƒãƒ¼ãƒˆ', image: 'note.png', sound: 'note.mp3' },
                { id: 'hasami', name: 'ã¯ã•ã¿', image: 'hasami.png', sound: 'hasami.mp3' },
                { id: 'nori', name: 'ã®ã‚Š', image: 'nori.png', sound: 'nori.mp3' },
                { id: 'hotchkiss', name: 'ãƒ›ãƒƒãƒã‚­ã‚¹', image: 'hotchkiss.png', sound: 'hotchkiss.mp3' },
                { id: 'jougi', name: 'ã˜ã‚‡ã†ã', image: 'jougi.png', sound: 'jougi.mp3' },
                { id: 'fudebako', name: 'ãµã§ã°ã“', image: 'fudebako.png', sound: 'fudebako.mp3' },
                { id: 'crayon', name: 'ã‚¯ãƒ¬ãƒ¨ãƒ³', image: 'crayon.png', sound: 'crayon.mp3' }
            ];

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã‚’å‹•çš„ã«HTMLã«è¿½åŠ 
            const audioElements = {};
            stationeryWords.forEach(word => {
                const audio = new Audio(ASSET_PATH_SOUND + word.sound);
                audio.preload = 'auto';
                audioElements[word.id] = audio;
            });

            // --- 2. HTMLè¦ç´ ã®å–å¾— ---
            const screens = document.querySelectorAll('.sc-screen');
            const studyGridEl = document.getElementById('sc-study-grid');
            
            // å‹‰å¼·ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            const studyScreenEl = document.getElementById('sc-screen-study');
            const startGameButton = document.getElementById('sc-start-game-button');
            
            // ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            const gameScreenEl = document.getElementById('sc-screen-game');
            const gamePromptEl = document.getElementById('sc-game-prompt');
            const playSoundButton = document.getElementById('sc-play-sound-button');
            const openCameraButton = document.getElementById('sc-open-camera-button');
            
            // ã‚«ãƒ¡ãƒ©ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            const cameraScreenEl = document.getElementById('sc-screen-camera');
            const videoEl = document.getElementById('sc-video-element');
            const canvasEl = document.getElementById('sc-canvas-element');
            const takePictureButton = document.getElementById('sc-take-picture-button');
            const cancelCameraButton = document.getElementById('sc-cancel-camera-button');
            
            // çµæœã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            const resultScreenEl = document.getElementById('sc-screen-result');
            const resultImageEl = document.getElementById('sc-result-image');
            const resultMessageEl = document.getElementById('sc-result-message');
            const nextProblemButton = document.getElementById('sc-next-problem-button');

            // --- 3. çŠ¶æ…‹ç®¡ç†å¤‰æ•° ---
            let currentWord = null; // ç¾åœ¨ã®ãŠé¡Œ (ä¾‹: { id: 'enpitsu', ... })
            let videoStream = null; // ã‚«ãƒ¡ãƒ©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

            // --- 4. æ±ç”¨é–¢æ•° ---

            // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
            function showScreen(screenElement) {
                screens.forEach(s => s.classList.remove('active'));
                screenElement.classList.add('active');
            }

            // éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
            function playWordSound(wordId) {
                if (audioElements[wordId]) {
                    audioElements[wordId].currentTime = 0;
                    audioElements[wordId].play();
                }
            }

            // --- 5. å‹‰å¼·ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®åˆæœŸåŒ– ---
            function initStudyScreen() {
                studyGridEl.innerHTML = '';
                stationeryWords.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'sc-study-item';
                    item.onclick = () => playWordSound(word.id);
                    
                    const img = document.createElement('img');
                    img.src = ASSET_PATH_IMG + word.image;
                    img.alt = word.name;
                    
                    const p = document.createElement('p');
                    p.textContent = word.name;
                    
                    item.appendChild(img);
                    item.appendChild(p);
                    studyGridEl.appendChild(item);
                });
            }

            // --- 6. ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
            function setupNewProblem() {
                // ãƒ©ãƒ³ãƒ€ãƒ ã«å˜èªã‚’é¸ã¶
                const randomIndex = Math.floor(Math.random() * stationeryWords.length);
                currentWord = stationeryWords[randomIndex];
                
                gamePromptEl.textContent = 'ã—ãŸã®ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ã€ãã“ãˆãŸã‚‚ã®ã‚’ ã•ãŒã—ã¦ã­ï¼';
                playSoundButton.style.display = 'block';
                openCameraButton.style.display = 'none'; // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã¯ã¾ã éš ã™
                
                showScreen(gameScreenEl);
            }

            // ã€ŒãŠã¨ã‚’ ããã€ãƒœã‚¿ãƒ³
            playSoundButton.onclick = () => {
                playWordSound(currentWord.id);
                gamePromptEl.textContent = `ã€Œ${currentWord.name}ã€ã‚’ ã•ãŒã—ã¦ã­ï¼`;
                openCameraButton.style.display = 'block'; // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            };

            // ã€Œã‚«ãƒ¡ãƒ©ã‚’ ã²ã‚‰ãã€ãƒœã‚¿ãƒ³
            openCameraButton.onclick = () => {
                startCamera();
            };

            // --- 7. ã‚«ãƒ¡ãƒ©ã®ãƒ­ã‚¸ãƒƒã‚¯ (æœ€é‡è¦) ---

            // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹
            async function startCamera() {
                // æ—¢ã«èµ·å‹•ã—ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
                if (videoStream) {
                    showScreen(cameraScreenEl);
                    return;
                }
                
                try {
                    // ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨è¨±å¯ã‚’æ±‚ã‚ã‚‹
                    // { video: true } ã¯èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆã—ã‚ˆã†ã¨ã™ã‚‹ (ã‚¹ãƒãƒ›ã®å ´åˆ)
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                        audio: false 
                    });
                    
                    videoStream = stream; // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä¿æŒ
                    videoEl.srcObject = stream; // <video> è¦ç´ ã«æ˜ åƒã‚’æµã™
                    
                    videoEl.onloadedmetadata = () => {
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’æ˜ åƒã«åˆã‚ã›ã‚‹
                        canvasEl.width = videoEl.videoWidth;
                        canvasEl.height = videoEl.videoHeight;
                    };
                    
                    showScreen(cameraScreenEl); // ã‚«ãƒ¡ãƒ©ç”»é¢ã‚’è¡¨ç¤º
                    
                } catch (err) {
                    console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", err);
                    gamePromptEl.textContent = 'ã‚«ãƒ¡ãƒ©ã®ãã‚‡ã‹ãŒ ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                    // èƒŒé¢ã‚«ãƒ¡ãƒ©ãŒãªã‘ã‚Œã°ã€å‰é¢ã‚«ãƒ¡ãƒ©ã§è©¦ã™
                    if (err.name === "OverconstrainedError" || err.name === "NotFoundError") {
                         try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            videoStream = stream;
                            videoEl.srcObject = stream;
                            videoEl.onloadedmetadata = () => {
                                canvasEl.width = videoEl.videoWidth;
                                canvasEl.height = videoEl.videoHeight;
                            };
                            showScreen(cameraScreenEl);
                         } catch (err2) {
                             gamePromptEl.textContent = 'ã‚«ãƒ¡ãƒ©ãŒ ã¤ã‹ãˆã¾ã›ã‚“ã§ã—ãŸã€‚';
                         }
                    }
                }
            }
            
            // ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã™ã‚‹ (é‡è¦ï¼)
            function stopCamera() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                    videoEl.srcObject = null;
                }
            }

            // ã€Œã—ã‚ƒã—ã‚“ã‚’ã¨ã‚‹ã€ãƒœã‚¿ãƒ³
            takePictureButton.onclick = () => {
                // (1) ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æ˜ åƒã®1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
                const context = canvasEl.getContext('2d');
                context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
                
                // (2) ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿(DataURL)ã‚’å–å¾—
                const imageDataUrl = canvasEl.toDataURL('image/png');
                
                // (3) çµæœç”»é¢ã®<img>ã«ç”»åƒã‚’è¨­å®š
                resultImageEl.src = imageDataUrl;
                resultMessageEl.innerHTML = `ã“ã‚Œã¯ã€Œ${currentWord.name}ã€ã§ã™ã‹ï¼Ÿ<br>ãŠã†ã¡ã®ã²ã¨ã¨ ã“ãŸãˆã‚ã‚ã›ã—ã¦ã­ï¼`;
                
                // (4) ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã€çµæœç”»é¢ã‚’è¡¨ç¤º
                stopCamera();
                showScreen(resultScreenEl);
            };

            // ã€Œã‚‚ã©ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
            cancelCameraButton.onclick = () => {
                stopCamera();
                showScreen(gameScreenEl); // ã‚²ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
            };

            // --- 8. çµæœã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
            
            // ã€Œã¤ãã®ã‚‚ã‚“ã ã„ã¸ã€ãƒœã‚¿ãƒ³
            nextProblemButton.onclick = () => {
                resultImageEl.src = ''; // å¤ã„å†™çœŸã‚’ã‚¯ãƒªã‚¢
                setupNewProblem(); // æ¬¡ã®å•é¡Œã¸
            };

            // --- 9. ã‚²ãƒ¼ãƒ ã®é–‹å§‹ ---
            
            // ã€Œã‚²ãƒ¼ãƒ ã‚’ã¯ã˜ã‚ã‚‹ã€ãƒœã‚¿ãƒ³
            startGameButton.onclick = () => {
                setupNewProblem();
            };

            // æœ€åˆã®ç”»é¢ã‚’åˆæœŸåŒ–
            initStudyScreen();
            showScreen(studyScreenEl); // æœ€åˆã«å‹‰å¼·ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’è¡¨ç¤º

        });
    </script>

</body>
</html>