<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>あいさつゲーム - FunLearnJP</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 共通設定 (V2デザイン - 修正版) --- */
        :root {
            --primary: #5c7aff; /* Blue */
            --accent: #ffcc5c;  /* Yellow */
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        /* ★重要: 全要素のサイズ計算を統一してズレを防ぐ */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            /* 横スクロール防止 */
            overflow-x: hidden;
            width: 100%;
        }

        /* --- ヘッダー（V2統一デザイン） --- */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white;
            /* パディングをメインメニューと統一 */
            padding: 15px 20px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
            z-index: 100;
        }
        .header-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .header-container h1 {
            margin: 0;
            font-size: 1.4em;
            color: white;
        }
        .home-link {
            text-decoration: none;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .home-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* --- メインコンテナ / カードデザイン --- */
        .aq-main-container {
            flex-grow: 1;
            /* 左右のパディングをヘッダー(20px)と合わせる */
            padding: 20px;
            max-width: 650px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #aq-container {
            width: 100%;
            padding: 30px; 
            background-color: #ffffff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            border-radius: 25px; 
            border: 4px solid white;
            animation: pop-in 0.4s;
        }
        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        /* 画面切り替え */
        .aq-screen { display: none; }
        .aq-screen.active { display: block; }

        h1, h2 { text-align: center; color: var(--primary); }
        h1 { font-size: 2.2em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-bottom: 20px; }
        p { text-align: center; font-size: 1.1em; color: #666; }

        /* --- ボタン共通 (V2 3Dスタイル) --- */
        .aq-button {
            display: block; width: 90%; max-width: 350px;
            margin: 15px auto; padding: 15px; font-size: 1.4em;
            font-weight: 700; color: #fff; background-color: var(--correct-color); 
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 6px 0 #388e3c; /* Green Shadow */
            transition: all 0.1s ease-out; position: relative; top: 0;
            text-decoration: none;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }
        .aq-button:active { top: 4px; box-shadow: 0 2px 0 #388e3c; }
        
        .aq-button-secondary {
             background-color: #90a4ae;
             box-shadow: 0 4px 0 #546e7a;
             font-size: 1.1em;
             width: 200px;
             border-radius: 10px;
             margin-top: 20px;
        }
        .aq-button-secondary:active {
             top: 3px;
             box-shadow: 0 2px 0 #546e7a;
        }

        /* --- 1. 勉強スクリーン --- */
        #aq-study-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .aq-study-item {
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            background-color: #ffffff;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .aq-study-item:hover { background-color: #e3f2fd; transform: translateY(-2px); }
        .aq-study-item img {
            width: 100%; max-width: 70px; height: 70px; object-fit: contain;
        }
        .aq-study-item p {
            font-size: 1.1em; font-weight: bold; margin: 5px 0 0 0; color: #444;
        }

        /* --- 2. クイズスクリーン --- */
        
        #aq-question-number { 
            font-size: 1.1em; 
            color: var(--primary); 
            margin-bottom: 10px;
        }
        
        /* タイマー表示エリア */
        #aq-timer-box {
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            background-color: var(--incorrect-color); /* Red */
            margin: 15px auto;
            padding: 5px 15px; 
            border-radius: 10px;
            display: inline-block; 
        }

        /* 問題プロンプト */
        .question-prompt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; 
            margin-top: 5px;
            padding: 15px;
            background: #e3f2fd; /* Light Blue Background */
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #aq-question-text { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: #444;
            margin: 0;
            text-align: left;
            flex-grow: 1;
        }

        /* 音声再生ボタン */
        .sound-button {
            width: 55px; height: 55px; padding: 0;
            font-size: 1.8em; background-color: var(--primary);
            color: white; border: none; border-radius: 50%;
            cursor: pointer; flex-shrink: 0;
            box-shadow: 0 3px 0 #3f51b5;
        }
        .sound-button:active { 
            box-shadow: 0 1px 0 #3f51b5; 
            transform: translateY(2px);
        }
        .sound-button:hover:not(:disabled) { background-color: #4b63cc; }
        .sound-button:disabled { background-color: #cccccc; opacity: 0.7; }
        
        /* 選択肢 */
        .choices { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-top: 25px;
        }
        .choices button {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.4em; 
            font-weight: 700;
            cursor: pointer;
            background-color: #fff;
            color: var(--primary);
            border: 3px solid #ddd;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            text-align: center;
        }
        .choices button:hover:not(:disabled) { 
            background-color: #f0f4f8; 
            border-color: var(--primary);
            transform: scale(1.01);
        }
        .choices button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* 正解・不正解表示 */
        .choices button.correct { 
            border-color: var(--correct-color);
            background-color: #e8f5e9;
            box-shadow: 0 0 10px var(--correct-color);
            color: #1b5e20;
        }
        .choices button.incorrect {
            border-color: var(--incorrect-color);
            background-color: #fbe9e7;
            opacity: 0.8;
            color: #b71c1c;
        }
        
        /* 結果メッセージ */
        .result-message { 
            text-align: center; margin-top: 20px; padding: 15px; 
            border-radius: 10px; font-size: 1.2em; font-weight: bold;
            display: none; 
            animation: pop-in 0.3s;
        }
        .result-message.correct { background-color: #d4edda; color: #155724; }
        .result-message.incorrect { background-color: #f8d7da; color: #721c24; }
        
        /* 最終スコア */
        #aq-final-score { 
            text-align: center; font-size: 1.8em; 
            color: var(--primary); margin-top: 30px; 
            background-color: #e3f2fd; padding: 20px; border-radius: 15px;
            display: none; 
        }

        .navigation-buttons { text-align: center; margin-top: 20px; }
        
        /* ボタン配置の調整 */
        #aq-screen-quiz .navigation-buttons {
            display: flex; justify-content: center; gap: 15px;
        }
        #aq-screen-quiz .navigation-buttons a, 
        #aq-screen-quiz .navigation-buttons button {
            display: block; width: auto; max-width: 200px; margin: 0;
        }
        
        /* 認証ステータスのスタイル */
        #auth-status-aisatsu {
             text-align: center; font-size: 0.9em; margin-bottom: 10px; font-weight: bold; color: var(--primary);
        }

        @media (max-width: 400px) {
            #aq-study-grid { grid-template-columns: repeat(2, 1fr); }
            h1 { font-size: 1.8em; }
            #aq-question-text { font-size: 1.1em; }
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0BX3DD42C1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0BX3DD42C1');
    </script>
</head>
<body>
    
    <header>
        <div class="header-container">
            <h1>あいさつゲーム</h1>
            <a href="index.html" class="home-link"><i class="fa-solid fa-house"></i> ホームへ</a>
        </div>
    </header>

    <div class="aq-main-container">
        <div id="aq-container">
        
            <div id="auth-status-aisatsu">認証中...</div>

            <div id="aq-screen-study" class="aq-screen active">
                <h1>あいさつ を おぼえよう</h1>
                <p>イラストを タップ して おとを きいてね。</p>
                <div id="aq-study-grid">
                    </div>
                <button id="aq-start-quiz-button" class="aq-button">クイズを はじめる</button>
                <a href="index.html" class="aq-button aq-button-secondary">ホームにもどる</a>
            </div>
            
            <div id="aq-screen-quiz" class="aq-screen">
                <div class="question-area">
                    <p id="aq-question-number">だい 1 もん</p>
                    <div id="aq-timer-box" style="display: none;">のこり 10 びょう</div> 
                    
                    <p style="color:#444; font-size:1.1em;">ただしい あいさつを えらんでね：</p>
                    
                    <div class="question-prompt-container">
                        <h2 id="aq-question-text">もんだいぶんが ひょうじされます...</h2> 
                        <button id="aq-play-sound-button" class="sound-button"><i class="fa-solid fa-volume-up"></i></button>
                    </div>
                </div>

                <div class="choices" id="aq-choices-container">
                    </div>

                <div id="aq-result-message" class="result-message">
                    </div>
                
                <div id="aq-final-score">
                    </div>

                <div class="navigation-buttons">
                    <button id="aq-restart-button" class="aq-button aq-button-secondary" style="background-color: #00bcd4; box-shadow: 0 4px 0 #008ba3;">
                        <i class="fa-solid fa-rotate-right"></i> もういちど あそぶ
                    </button>
                    <a href="index.html" id="aq-home-button" class="aq-button aq-button-secondary">
                        <i class="fa-solid fa-house"></i> ホームにもどる
                    </a>
                </div>
            </div>
        </div>
    </div>

    <audio id="aq-sound-correct" src="assets/sounds/seikai.mp3" preload="auto"></audio>
    <audio id="aq-sound-incorrect" src="assets/sounds/bubu.mpode.js" preload="auto"></audio>

    <script type="module">
        // 1. Firebase SDKのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";


        // 2. あなたのFirebase設定 (index.htmlなどからコピー)
        const firebaseConfig = {
          apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
          authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
          projectId: "funlearningjapanese-b8e08",
          storageBucket: "funlearningjapanese-b8e08.appspot.com",
          messagingSenderId: "1055688629268",
          appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
          measurementId: "G-LCMXVLPS81"
        };

        // 3. Firebaseサービスの初期化とグローバル変数
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.currentUserId = null;
        const authStatusEl = document.getElementById('auth-status-aisatsu');
        
        // ポイントルール: 各問題の正解で1ポイント
        const POINTS_PER_QUESTION = 1; 
        
        // 4. 認証状態の監視
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                const userDocRef = doc(db, "users", window.currentUserId);
                const userDocSnap = await getDoc(userDocRef);
                let displayName = 'ユーザー';
                if (userDocSnap.exists()) {
                    displayName = userDocSnap.data().displayName || 'ユーザー';
                }
                authStatusEl.textContent = `✅ ログイン中: ${displayName}`;

            } else {
                window.currentUserId = null;
                authStatusEl.textContent = '❌ ゲストモード (ポイントは記録されません)';
            }
        });


        /**
         * ポイント加算関数 (Firestoreに記録)
         * @param {number} points - 加算するポイント数
         * @returns {Promise<boolean>} 成功/失敗
         */
        window.addPointsToUser = async function(points, wordKey) { 
            if (!window.currentUserId || points <= 0) {
                return false;
            }
            
            try {
                const userRef = doc(db, "users", window.currentUserId);
                const progressKey = `aisatsu_word_${wordKey}`; // 単語ごとのキー

                // 2. ポイントを加算
                await updateDoc(userRef, {
                    points: increment(points) 
                });
                
                console.log(`${points} ポイントを Firestore に加算しました (単語: ${wordKey})。`);
                return true;

            } catch (e) {
                console.error("ポイント更新エラー:", e);
                return false;
            }
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ----------------------------------------------------
            // ★★★ Firebase連携ポイント関数を再定義 (ダミー) ★★★
            // モジュールロードが遅れた場合のエラー回避のためのダミー関数
            if (typeof window.addPointsToUser !== 'function') {
                window.addPointsToUser = async () => { return false; };
            }
            const POINTS_PER_QUESTION = 1; // Firebase連携スクリプトと同期
            // ----------------------------------------------------

            // ----------------------------------------------------
            // データ定義
            // ----------------------------------------------------
            const SOUND_PATH_AISATSU = 'assets/sounds/aisatsu/';
            const IMAGE_PATH_AISATSU = 'assets/images/aisatsu/'; 

            // ★ id を使って音声ファイルを指定します
            const greetingsData = [
                { "id": 1, "situation": "あさ、おきたとき、または あったひとに いう あいさつは？ (朝)", "correct": "おはよう", "image": "ohayou.png", "wrongs": ["こんにちは", "こんばんは", "おやすみなさい"] },
                { "id": 2, "situation": "ひるま、ひとに あったときの あいさつは？ (昼)", "correct": "こんにちは", "image": "konnichiwa.png", "wrongs": ["おはよう", "こんばんは", "さようなら"] },
                { "id": 3, "situation": "ゆうがたから よるに かけて、ひとに あったときの あいさつは？ (夜)", "correct": "こんばんは", "image": "konbanwa.png", "wrongs": ["おはよう", "こんにちは", "ただいま"] },
                { "id": 4, "situation": "ねるまえに ひとに いう あいさつは？", "correct": "おやすみなさい", "image": "oyasumi.png", "wrongs": ["さようなら", "いただきます", "いってきます"] },
                { "id": 5, "situation": "これから いえを でかけるときの あいさつは？ (自分が)", "correct": "いってきます", "image": "ittekimasu.png", "wrongs": ["ただいま", "いってらっしゃい", "おかえりなさい"] },
                { "id": 6, "situation": "かぞくが でかけるときに、かえす ことばは？", "correct": "いってらっしゃい", "image": "itterasshai.png", "wrongs": ["いってきます", "ただいま", "おかえりなさい"] },
                { "id": 7, "situation": "そとから いえに かえってきたときの あいさつは？", "correct": "ただいま", "image": "tadaima.png", "wrongs": ["おかえりなさい", "いってきます", "ごちそうさま"] },
                { "id": 8, "situation": "「ただいま」と いわれたときの かえす ことばは？", "correct": "おかえりなさい", "image": "okaeri.png", "wrongs": ["いってきます", "さようなら", "ごめんなさい"] },
                { "id": 9, "situation": "なにかを してもらったときの、かんしゃの ことばは？", "correct": "ありがとう", "image": "arigatou.png", "wrongs": ["ごめんなさい", "いただきます", "おやすみなさい"] },
                { "id": 10, "situation": "わるいことを してしまったときの あいさつは？", "correct": "ごめんなさい", "image": "gomen.png", "wrongs": ["ありがとう", "こんにちは", "いただきます"] },
                { "id": 11, "situation": "ごはんを たべるまえの あいさつは？", "correct": "いただきます", "image": "itadakimasu.png", "wrongs": ["ごちそうさま", "ありがとう", "おかえりなさい"] },
                { "id": 12, "situation": "ごはんを たべおわった あとの あいさつは？", "correct": "ごちそうさま", "image": "gochisousama.png", "wrongs": ["いただきます", "こんにちは", "おやすみなさい"] },
                { "id": 13, "situation": "はじめて あうひとに いう、さいしょの あいさつは？", "correct": "はじめまして", "image": "hajimemashite.png", "wrongs": ["こんにちは", "さようなら", "いってきます"] },
                { "id": 14, "situation": "かぞくや ともだちと わかれるときの あいさつは？", "correct": "さようなら", "image": "sayounara.png", "wrongs": ["こんにちは", "おかえりなさい", "おやすみなさい"] }
            ];

            // --- 音声キャッシュ ---
            const audioCache = {};
            function loadAudio(path) {
                if (!audioCache[path]) {
                    const audio = new Audio(path);
                    audio.onerror = () => {
                        console.error("音声ファイルが見つかりません: " + path);
                    };
                    audioCache[path] = audio;
                }
                return audioCache[path];
            }
            
            const soundCorrect = document.getElementById('aq-sound-correct');
            const soundIncorrect = document.getElementById('aq-sound-incorrect');
            
            // --- DOM取得 ---
            const screens = document.querySelectorAll('.aq-screen');
            const studyScreen = document.getElementById('aq-screen-study');
            const quizScreen = document.getElementById('aq-screen-quiz');
            
            const studyGridEl = document.getElementById('aq-study-grid');
            const startQuizButton = document.getElementById('aq-start-quiz-button');
            
            const questionNumberEl = document.getElementById('aq-question-number');
            const timerBoxEl = document.getElementById('aq-timer-box');
            const questionTextEl = document.getElementById('aq-question-text');
            const playSoundButton = document.getElementById('aq-play-sound-button');
            const choicesContainerEl = document.getElementById('aq-choices-container');
            const resultMessageEl = document.getElementById('aq-result-message');
            const finalScoreEl = document.getElementById('aq-final-score');
            const restartButton = document.getElementById('aq-restart-button');

            // --- ゲーム状態変数 ---
            let allQuestions = []; 
            let currentQuestions = []; 
            let currentQuestionIndex = 0;
            let score = 0;
            let timer;
            let timeLeft = 10;
            let currentSituationSound = null;

            // ----------------------------------------------------
            // 汎用関数
            // ----------------------------------------------------
            function showScreen(screenElement) {
                screens.forEach(s => s.classList.remove('active'));
                screenElement.classList.add('active');
            }
            function playSound(audioElement) {
                if (audioElement) {
                    audioElement.currentTime = 0;
                    audioElement.play().catch(e => console.error("再生エラー:", e));
                }
            }
            function shuffleArray(array) {
                let newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            // ----------------------------------------------------
            // ★ 1. 勉強スクリーンのロジック
            // ----------------------------------------------------
            function initStudyScreen() {
                studyGridEl.innerHTML = '';
                greetingsData.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'aq-study-item';
                    
                    item.onclick = () => {
                        // word.id を使って 'situation' + id + '.mp3' を再生
                        const soundPath = `${SOUND_PATH_AISATSU}situation${word.id}.mp3`;
                        const answerSound = loadAudio(soundPath);
                        playSound(answerSound);
                    };
                    
                    const img = document.createElement('img');
                    img.src = IMAGE_PATH_AISATSU + word.image;
                    img.alt = word.correct;
                    
                    const p = document.createElement('p');
                    p.textContent = word.correct;
                    
                    item.appendChild(img);
                    item.appendChild(p);
                    studyGridEl.appendChild(item);
                });
            }

            // ----------------------------------------------------
            // ★ 2. クイズのメインロジック
            // ----------------------------------------------------

            function startGame() {
                allQuestions = shuffleArray([...greetingsData]);
                // クイズは全データを使用し、10問に制限する
                currentQuestions = allQuestions.slice(0, 10); 
                currentQuestionIndex = 0;
                score = 0;
                
                finalScoreEl.style.display = 'none';
                resultMessageEl.style.display = 'none';
                choicesContainerEl.style.display = 'grid';
                restartButton.style.display = 'none';
                playSoundButton.disabled = true; // 初期状態では音声を無効

                loadQuestion();
            }

            function loadQuestion() {
                clearInterval(timer);
                resultMessageEl.style.display = 'none';
                
                if (currentQuestionIndex >= currentQuestions.length) {
                    endGame();
                    return;
                }

                const problem = currentQuestions[currentQuestionIndex];
                
                questionNumberEl.textContent = `だい ${currentQuestionIndex + 1} もん`;
                questionTextEl.textContent = problem.situation;
                timerBoxEl.style.display = 'none'; 

                const wrongOptions = shuffleArray(problem.wrongs).slice(0, 2); 
                const options = shuffleArray([problem.correct, ...wrongOptions]);
                
                choicesContainerEl.innerHTML = '';
                options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.className = 'aq-button aq-option'; 
                    button.dataset.key = problem.correct; // 正解のキーをセット
                    button.style.fontSize = '1.2em';
                    button.style.margin = '0 auto';
                    button.textContent = optionText;
                    button.onclick = (e) => checkAnswer(e, problem.correct);
                    choicesContainerEl.appendChild(button);
                });
                
                // 問題の音声も situation + ID .mp3
                const soundFile = `situation${problem.id}.mp3`;
                currentSituationSound = loadAudio(SOUND_PATH_AISATSU + soundFile);
                playSoundButton.onclick = () => playSound(currentSituationSound);
                
                disableChoices(true);
                playSoundButton.disabled = true;

                // 音声が終わったらタイマー開始＆選択肢有効化
                currentSituationSound.onended = () => {
                    startTimer(); 
                    disableChoices(false); 
                    playSoundButton.disabled = false;
                };
                
                playSound(currentSituationSound);
            }

            function startTimer() {
                timeLeft = 10;
                timerBoxEl.textContent = `のこり ${timeLeft} びょう`;
                timerBoxEl.style.display = 'inline-block';
                
                clearInterval(timer); 
                timer = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                timeLeft--;
                timerBoxEl.textContent = `のこり ${timeLeft} びょう`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showResult(false, currentQuestions[currentQuestionIndex].correct);
                }
            }

            async function checkAnswer(event, correctAnswer) { // ★ async関数に変更
                clearInterval(timer); 
                
                const chosenButton = event.target;
                const chosenAnswer = chosenButton.textContent;
                
                // 正解のキーをポイント記録に使用
                const wordKey = chosenButton.dataset.key; 

                // 選択した答えに対応する ID を逆引きして音声を再生
                const chosenWordData = greetingsData.find(w => w.correct === chosenAnswer);
                
                if (chosenWordData) {
                    // 選んだ答えに対応する correct ファイルを再生
                    const answerSoundPath = `${SOUND_PATH_AISATSU}${chosenWordData.correct}.mp3`;
                    const answerSound = loadAudio(answerSoundPath);
                    playSound(answerSound);
                }

                disableChoices(true); 
                playSoundButton.disabled = true; 

                if (chosenAnswer === correctAnswer) {
                    score++;
                    chosenButton.classList.add('correct'); 
                    chosenButton.style.color = 'white';
                    
                    // ★★★ Firebase連携ポイント処理 ★★★
                    const success = await window.addPointsToUser(POINTS_PER_QUESTION, wordKey);
                    const pointResult = success ? "scored" : "error";
                    showResult(true, correctAnswer, pointResult);
                    // ★★★ Firebase連携ポイント処理 終了 ★★★
                    
                } else {
                    chosenButton.classList.add('incorrect'); 
                    chosenButton.style.color = 'white';
                    showResult(false, correctAnswer);
                }
            }

            function showResult(isCorrect, correctAnswer, pointResult = null) {
                if (isCorrect) {
                    let msg = 'せいかい！';
                    if (pointResult === "scored") {
                        msg += ` (+${POINTS_PER_QUESTION} ポイント記録)`;
                    } else if (pointResult === "error") {
                        msg += ' (ポイント記録エラー)';
                    }
                    
                    resultMessageEl.textContent = msg;
                    resultMessageEl.className = 'result-message correct';
                    playSound(soundCorrect);
                } else {
                    resultMessageEl.textContent = `ざんねん... せいかいは「${correctAnswer}」`;
                    resultMessageEl.className = 'result-message incorrect';
                    playSound(soundIncorrect);
                    
                    // 正解をハイライト
                    Array.from(choicesContainerEl.children).forEach(button => {
                        if (button.textContent === correctAnswer) {
                            button.classList.add('correct');
                        }
                    });
                }
                resultMessageEl.style.display = 'block';

                setTimeout(() => {
                    currentQuestionIndex++;
                    loadQuestion();
                }, 2000);
            }

            function disableChoices(disabled) {
                Array.from(choicesContainerEl.children).forEach(button => {
                    button.disabled = disabled;
                });
            }

            function endGame() {
                finalScoreEl.innerHTML = `おわり！<br>${currentQuestions.length}もんちゅう <span style="font-size:1.2em; color:var(--incorrect-color);">${score}</span> もん せいかい！`;
                finalScoreEl.style.display = 'block';
                
                questionNumberEl.textContent = 'おつかれさま';
                questionTextEl.textContent = 'クイズしゅうりょう';
                timerBoxEl.style.display = 'none';
                choicesContainerEl.style.display = 'none';
                resultMessageEl.style.display = 'none';
                
                restartButton.style.display = 'block';
                playSoundButton.disabled = true;
            }

            // ----------------------------------------------------
            // イベントリスナー
            // ----------------------------------------------------
            
            startQuizButton.onclick = () => {
                startGame();
                showScreen(quizScreen);
            };
            
            restartButton.addEventListener('click', startGame);

            // ----------------------------------------------------
            // ゲーム初期化
            // ----------------------------------------------------
            initStudyScreen();
            showScreen(studyScreen);

        });
    </script>
    </body>
</html>