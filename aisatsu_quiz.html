<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>あいさつゲーム - FunLearnJP</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 共通設定 --- */
        :root {
            --primary: #5c7aff;
            --accent: #ffcc5c;
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden; width: 100%;
            touch-action: manipulation;
        }

        /* ヘッダー */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white; padding: 15px 20px; width: 100%;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3); z-index: 100;
        }
        .header-container {
            max-width: 900px; margin: 0 auto; display: flex;
            justify-content: space-between; align-items: center; width: 100%;
        }
        .header-container h1 { margin: 0; font-size: 1.4em; color: white; }
        .home-link {
            text-decoration: none; color: white; font-weight: bold;
            padding: 5px 10px; border-radius: 5px; display: flex; align-items: center;
        }
        
        /* メインコンテナ */
        .aq-main-container {
            flex-grow: 1; padding: 20px; max-width: 650px;
            margin: 0 auto; width: 100%; display: flex;
            flex-direction: column; justify-content: center;
        }

        #aq-container {
            width: 100%; padding: 30px; background-color: #ffffff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-radius: 25px; 
            border: 4px solid white; animation: pop-in 0.4s;
        }
        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        .aq-screen { display: none; }
        .aq-screen.active { display: block; }

        h1 { text-align: center; color: var(--primary); font-size: 2.2em; margin-bottom: 20px; }
        p { text-align: center; font-size: 1.1em; color: #666; }

        /* ボタン */
        .aq-button {
            display: block; width: 90%; max-width: 350px;
            margin: 15px auto; padding: 15px; font-size: 1.4em;
            font-weight: 700; color: #fff; background-color: var(--correct-color); 
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 6px 0 #388e3c; transition: all 0.1s;
            text-decoration: none; text-align: center;
        }
        .aq-button:active { top: 4px; box-shadow: 0 2px 0 #388e3c; }
        
        .aq-button-secondary {
             background-color: #90a4ae; box-shadow: 0 4px 0 #546e7a;
             font-size: 1.1em; width: 200px; border-radius: 10px; margin-top: 20px;
        }

        /* 勉強画面グリッド */
        #aq-study-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .aq-study-item {
            border: 2px solid #e3f2fd; border-radius: 10px; background-color: #ffffff;
            text-align: center; padding: 10px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .aq-study-item:hover { background-color: #e3f2fd; transform: translateY(-2px); }
        .aq-study-item img { width: 100%; max-width: 70px; height: 70px; object-fit: contain; }
        .aq-study-item p { font-size: 1.1em; font-weight: bold; margin: 5px 0 0 0; color: #444; }

        /* クイズ画面 */
        #aq-question-number { font-size: 1.1em; color: var(--primary); margin-bottom: 10px; }
        
        #aq-timer-box {
            font-size: 1.5em; font-weight: bold; color: white;
            background-color: var(--incorrect-color); margin: 15px auto;
            padding: 5px 15px; border-radius: 10px; display: inline-block; 
        }

        .question-prompt-container {
            display: flex; align-items: center; justify-content: center; gap: 15px; 
            margin-top: 5px; padding: 15px; background: #e3f2fd; 
            border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #aq-question-text { font-size: 1.2em; font-weight: bold; color: #444; margin: 0; text-align: left; flex-grow: 1; }

        .sound-button {
            width: 55px; height: 55px; font-size: 1.8em; background-color: var(--primary);
            color: white; border: none; border-radius: 50%; cursor: pointer; flex-shrink: 0;
            box-shadow: 0 3px 0 #3f51b5;
        }
        .sound-button:active { box-shadow: 0 1px 0 #3f51b5; transform: translateY(2px); }
        
        .choices { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 25px; }
        .choices button {
            width: 100%; padding: 15px 20px; font-size: 1.4em; font-weight: 700;
            cursor: pointer; background-color: #fff; color: var(--primary);
            border: 3px solid #ddd; border-radius: 15px; text-align: center;
        }
        
        .choices button.correct-answer { 
            border-color: var(--correct-color); background-color: #e8f5e9; color: #1b5e20;
        }
        
        .result-message { 
            text-align: center; margin-top: 20px; padding: 15px; 
            border-radius: 10px; font-size: 1.2em; font-weight: bold; display: none; 
        }
        .result-message.correct { background-color: #d4edda; color: #155724; }
        .result-message.incorrect { background-color: #f8d7da; color: #721c24; }
        
        #aq-final-score { 
            text-align: center; font-size: 1.8em; color: var(--primary); 
            margin-top: 30px; background-color: #e3f2fd; padding: 20px; 
            border-radius: 15px; display: none; 
        }

        #auth-status-aisatsu { text-align: center; font-size: 0.9em; margin-bottom: 10px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>
    
    <header>
        <div class="header-container">
            <h1>あいさつゲーム</h1>
            <a href="index.html" class="home-link"><i class="fa-solid fa-house"></i> ホームへ</a>
        </div>
    </header>

    <div class="aq-main-container">
        <div id="aq-container">
        
            <div id="auth-status-aisatsu">認証中...</div>

            <div id="aq-screen-study" class="aq-screen active">
                <h1>あいさつ を おぼえよう</h1>
                <p>イラストを タップ して おとを きいてね。</p>
                <div id="aq-study-grid">
                    </div>
                <button id="aq-start-quiz-button" class="aq-button">クイズを はじめる</button>
                <a href="index.html" class="aq-button aq-button-secondary">ホームにもどる</a>
            </div>
            
            <div id="aq-screen-quiz" class="aq-screen">
                <div class="question-area">
                    <p id="aq-question-number">だい 1 もん</p>
                    <div id="aq-timer-box" style="display: none;">のこり 10 びょう</div> 
                    
                    <p style="color:#444; font-size:1.1em;">ただしい あいさつを えらんでね：</p>
                    
                    <div class="question-prompt-container">
                        <h2 id="aq-question-text">もんだい...</h2> 
                        <button id="aq-play-sound-button" class="sound-button"><i class="fa-solid fa-volume-up"></i></button>
                    </div>
                </div>

                <div class="choices" id="aq-choices-container"></div>

                <div id="aq-result-message" class="result-message"></div>
                <div id="aq-final-score"></div>

                <div class="navigation-buttons" style="text-align:center; margin-top:20px;">
                    <button id="aq-restart-button" class="aq-button aq-button-secondary" style="background-color: #00bcd4; display:none; margin: 0 auto;">
                        <i class="fa-solid fa-rotate-right"></i> もういちど あそぶ
                    </button>
                    <a href="index.html" id="aq-home-button" class="aq-button aq-button-secondary" style="margin: 20px auto; display:none;">
                        <i class="fa-solid fa-house"></i> ホームにもどる
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 設定・データ ---
            const SOUND_PATH_AISATSU = 'assets/sounds/aisatsu/';
            const IMAGE_PATH_AISATSU = 'assets/images/aisatsu/'; 
            const POINTS_PER_QUESTION = 1;
            
            // Web Speech API の初期化
            const synth = window.speechSynthesis;

            const greetingsData = [
                { "id": 1, "situation": "あさ、おきたとき、または あったひとに いう あいさつは？ (朝)", "correct": "おはよう", "image": "ohayou.png", "wrongs": ["こんにちは", "こんばんは", "おやすみなさい"] },
                { "id": 2, "situation": "ひるま、ひとに あったときの あいさつは？ (昼)", "correct": "こんにちは", "image": "konnichiwa.png", "wrongs": ["おはよう", "こんばんは", "さようなら"] },
                { "id": 3, "situation": "ゆうがたから よるに かけて、ひとに あったときの あいさつは？ (夜)", "correct": "こんばんは", "image": "konbanwa.png", "wrongs": ["おはよう", "こんにちは", "ただいま"] },
                { "id": 4, "situation": "ねるまえに ひとに いう あいさつは？", "correct": "おやすみなさい", "image": "oyasumi.png", "wrongs": ["さようなら", "いただきます", "いってきます"] },
                { "id": 5, "situation": "これから いえを でかけるときの あいさつは？ (自分が)", "correct": "いってきます", "image": "ittekimasu.png", "wrongs": ["ただいま", "いってらっしゃい", "おかえりなさい"] },
                { "id": 6, "situation": "かぞくが でかけるときに、かえす ことばは？", "correct": "いってらっしゃい", "image": "itterasshai.png", "wrongs": ["いってきます", "ただいま", "おかえりなさい"] },
                { "id": 7, "situation": "そとから いえに かえってきたときの あいさつは？", "correct": "ただいま", "image": "tadaima.png", "wrongs": ["おかえりなさい", "いってきます", "ごちそうさま"] },
                { "id": 8, "situation": "「ただいま」と いわれたときの かえす ことばは？", "correct": "おかえりなさい", "image": "okaeri.png", "wrongs": ["いってきます", "さようなら", "ごめんなさい"] },
                { "id": 9, "situation": "なにかを してもらったときの、かんしゃの ことばは？", "correct": "ありがとう", "image": "arigatou.png", "wrongs": ["ごめんなさい", "いただきます", "おやすみなさい"] },
                { "id": 10, "situation": "わるいことを してしまったときの あいさつは？", "correct": "ごめんなさい", "image": "gomen.png", "wrongs": ["ありがとう", "こんにちは", "いただきます"] },
                { "id": 11, "situation": "ごはんを たべるまえの あいさつは？", "correct": "いただきます", "image": "itadakimasu.png", "wrongs": ["ごちそうさま", "ありがとう", "おかえりなさい"] },
                { "id": 12, "situation": "ごはんを たべおわった あとの あいさつは？", "correct": "ごちそうさま", "image": "gochisousama.png", "wrongs": ["いただきます", "こんにちは", "おやすみなさい"] },
                { "id": 13, "situation": "はじめて あうひとに いう、さいしょの あいさつは？", "correct": "はじめまして", "image": "hajimemashite.png", "wrongs": ["こんにちは", "さようなら", "いってきます"] },
                { "id": 14, "situation": "かぞくや ともだちと わかれるときの あいさつは？", "correct": "さようなら", "image": "sayounara.png", "wrongs": ["こんにちは", "おかえりなさい", "おやすみなさい"] }
            ];

            // --- 音声キャッシュ (ファイル再生用) ---
            const audioCache = {};
            function loadAudio(path) {
                if (!audioCache[path]) {
                    audioCache[path] = new Audio(path);
                }
                return audioCache[path];
            }
            
            // --- DOM取得 ---
            const screens = document.querySelectorAll('.aq-screen');
            const studyScreen = document.getElementById('aq-screen-study');
            const quizScreen = document.getElementById('aq-screen-quiz');
            
            const studyGridEl = document.getElementById('aq-study-grid');
            const startQuizButton = document.getElementById('aq-start-quiz-button');
            
            const questionNumberEl = document.getElementById('aq-question-number');
            const timerBoxEl = document.getElementById('aq-timer-box');
            const questionTextEl = document.getElementById('aq-question-text');
            const playSoundButton = document.getElementById('aq-play-sound-button');
            const choicesContainerEl = document.getElementById('aq-choices-container');
            const resultMessageEl = document.getElementById('aq-result-message');
            const finalScoreEl = document.getElementById('aq-final-score');
            const restartButton = document.getElementById('aq-restart-button');
            const homeButton = document.getElementById('aq-home-button');

            // --- ゲーム変数 ---
            let currentQuestions = []; 
            let currentQuestionIndex = 0;
            let score = 0;
            let timer;
            let timeLeft = 10;
            let currentSituationSound = null;

            // ----------------------------------------------------
            // ★ Web Speech API 読み上げ関数 (練習モード用)
            // ----------------------------------------------------
            function speak(text) {
                if (synth.speaking) synth.cancel(); // 前の音声をキャンセル

                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.lang = 'ja-JP';
                utterThis.rate = 0.9; // 少しゆっくり

                // 声のリスト取得 (非同期対策)
                const voices = synth.getVoices();
                const jpVoice = voices.find(v => v.lang === 'ja-JP');
                if(jpVoice) utterThis.voice = jpVoice;

                synth.speak(utterThis);
            }

            // ----------------------------------------------------
            // 画面切り替え
            // ----------------------------------------------------
            function showScreen(screenElement) {
                screens.forEach(s => s.classList.remove('active'));
                screenElement.classList.add('active');
            }

            function shuffleArray(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            function playFileSound(path) {
                const audio = loadAudio(path);
                audio.currentTime = 0;
                audio.play().catch(e => console.log("再生エラー(ファイル):", e));
            }

            // ----------------------------------------------------
            // 1. 練習モード初期化
            // ----------------------------------------------------
            function initStudyScreen() {
                studyGridEl.textContent = '';
                greetingsData.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'aq-study-item';
                    
                    // ★ ここで Web Speech API を呼び出す
                    item.onclick = () => {
                        speak(word.correct);
                    };
                    
                    const img = document.createElement('img');
                    img.src = IMAGE_PATH_AISATSU + word.image;
                    img.alt = word.correct;
                    
                    const p = document.createElement('p');
                    p.textContent = word.correct;
                    
                    item.appendChild(img);
                    item.appendChild(p);
                    studyGridEl.appendChild(item);
                });
            }

            // ----------------------------------------------------
            // 2. クイズモード (ロジックは以前のままファイル再生)
            // ----------------------------------------------------
            function startGame() {
                currentQuestions = shuffleArray([...greetingsData]).slice(0, 10);
                currentQuestionIndex = 0;
                score = 0;
                
                finalScoreEl.style.display = 'none';
                resultMessageEl.style.display = 'none';
                choicesContainerEl.style.display = 'grid';
                restartButton.style.display = 'none';
                homeButton.style.display = 'none';
                
                loadQuestion();
            }

            function loadQuestion() {
                clearInterval(timer);
                resultMessageEl.style.display = 'none';
                
                if (currentQuestionIndex >= currentQuestions.length) {
                    endGame();
                    return;
                }

                const problem = currentQuestions[currentQuestionIndex];
                
                questionNumberEl.textContent = `だい ${currentQuestionIndex + 1} もん`;
                questionTextEl.textContent = problem.situation;
                timerBoxEl.style.display = 'none'; 

                // 選択肢作成
                const wrongOptions = shuffleArray(problem.wrongs).slice(0, 2); 
                const options = shuffleArray([problem.correct, ...wrongOptions]);
                
                choicesContainerEl.textContent = '';
                options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.onclick = (e) => checkAnswer(e, problem.correct);
                    choicesContainerEl.appendChild(button);
                });
                
                // ★ クイズの問題文はファイル再生 (situation1.mp3)
                const soundFile = `situation${problem.id}.mp3`;
                const soundPath = SOUND_PATH_AISATSU + soundFile;
                
                // ボタン設定
                playSoundButton.onclick = () => playFileSound(soundPath);
                
                // 自動再生
                playFileSound(soundPath);

                // ボタン無効化 (音声終了を待たずにタイマー開始する簡易実装)
                disableChoices(false);
                startTimer();
            }

            function startTimer() {
                timeLeft = 10;
                timerBoxEl.textContent = `のこり ${timeLeft} びょう`;
                timerBoxEl.style.display = 'inline-block';
                
                clearInterval(timer); 
                timer = setInterval(() => {
                    timeLeft--;
                    timerBoxEl.textContent = `のこり ${timeLeft} びょう`;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        showResult(false, currentQuestions[currentQuestionIndex].correct);
                    }
                }, 1000);
            }

            async function checkAnswer(event, correctAnswer) {
                clearInterval(timer); 
                const chosenButton = event.target;
                const chosenAnswer = chosenButton.textContent;
                
                disableChoices(true); 

                if (chosenAnswer === correctAnswer) {
                    score++;
                    chosenButton.classList.add('correct-answer');
                    
                    // Firebaseポイント加算
                    if (typeof window.addPointsToUser === 'function') {
                        await window.addPointsToUser(POINTS_PER_QUESTION, correctAnswer);
                    }
                    showResult(true, correctAnswer, "scored");
                } else {
                    chosenButton.style.backgroundColor = '#fbe9e7';
                    chosenButton.style.color = '#c62828';
                    chosenButton.style.borderColor = '#ef5350';
                    showResult(false, correctAnswer);
                }
            }

            function showResult(isCorrect, correctAnswer, pointResult) {
                if (isCorrect) {
                    resultMessageEl.textContent = 'せいかい！ (+1pt)';
                    resultMessageEl.className = 'result-message correct';
                    playFileSound('assets/sounds/seikai.mp3');
                } else {
                    resultMessageEl.textContent = `ざんねん... せいかいは「${correctAnswer}」`;
                    resultMessageEl.className = 'result-message incorrect';
                    playFileSound('assets/sounds/bubu.mp3');
                    
                    // 正解を表示
                    Array.from(choicesContainerEl.children).forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.add('correct-answer');
                        }
                    });
                }
                resultMessageEl.style.display = 'block';

                setTimeout(() => {
                    currentQuestionIndex++;
                    loadQuestion();
                }, 2000);
            }

            function disableChoices(disabled) {
                Array.from(choicesContainerEl.children).forEach(btn => btn.disabled = disabled);
            }

            function endGame() {
                finalScoreEl.innerHTML = `おわり！<br>10もんちゅう ${score} もん せいかい！`;
                finalScoreEl.style.display = 'block';
                
                questionNumberEl.textContent = 'おつかれさま';
                questionTextEl.textContent = 'クイズしゅうりょう';
                timerBoxEl.style.display = 'none';
                choicesContainerEl.style.display = 'none';
                resultMessageEl.style.display = 'none';
                
                restartButton.style.display = 'block';
                homeButton.style.display = 'block';
                playSoundButton.disabled = true; 
            }

            // --- イベント設定 ---
            startQuizButton.onclick = () => {
                startGame();
                showScreen(quizScreen);
            };
            restartButton.onclick = startGame;

            // --- 初期化 ---
            initStudyScreen();
            showScreen(studyScreen);
            
            // ページ読み込み時にvoicesを一度取得しておく（Chrome対策）
            synth.getVoices();
        });
    </script>
</body>
</html>