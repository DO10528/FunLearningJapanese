<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>います・ありますゲーム - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

<style>
    /* --- 共通デザイン --- */
    :root {
        --primary: #5c7aff;
        --accent: #ffcc5c;
        --bg-color: #f0f4f8;
        --text-color: #333;
        --imasu-color: #ff6f61;  /* 生き物カラー */
        --arimasu-color: #42a5f5; /* 物カラー */
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; flex-direction: column;
        user-select: none;
    }

    header {
        background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
        color: white; padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(161, 140, 209, 0.3); z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0;
        position: sticky; top: 0;
    }
    .logo { font-size: 1.2em; font-weight: 900; color: white; text-decoration: none; }
    .home-link { color: white; text-decoration: none; font-weight: bold; background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 20px; }

    .container {
        flex-grow: 1; padding: 20px;
        width: 100%; max-width: 900px; margin: 0 auto;
        display: flex; flex-direction: column; align-items: center;
        padding-bottom: 120px; /* 下部ボタン用スペース */
    }

    /* --- 画面切り替え --- */
    .screen { display: none; width: 100%; animation: fadeIn 0.4s; }
    .screen.active { display: flex; flex-direction: column; align-items: center; width: 100%; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- スタート画面（単語リスト左右分割） --- */
    .lists-row {
        display: flex; flex-direction: row;
        justify-content: center; align-items: flex-start;
        gap: 15px; width: 100%;
    }
    
    .list-col {
        flex: 1;
        display: flex; flex-direction: column; align-items: center;
    }

    .section-title {
        font-size: 1.1em; font-weight: bold; color: white;
        padding: 8px 15px; border-radius: 20px; margin-bottom: 15px;
        display: inline-block; width: 100%; text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .word-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        gap: 10px; width: 100%;
    }
    
    .word-card {
        background: white; border-radius: 12px; padding: 10px 5px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        border: 2px solid transparent; transition: transform 0.1s;
        height: 110px; width: 100%;
    }
    .word-card:active { transform: scale(0.95); }
    .word-card.imasu { border-bottom: 4px solid var(--imasu-color); }
    .word-card.arimasu { border-bottom: 4px solid var(--arimasu-color); }
    
    .word-icon { font-size: 2em; margin-bottom: 8px; }
    .word-text { font-size: 0.9em; font-weight: bold; text-align: center; line-height: 1.2; }

    /* 固定ボタンエリア */
    .start-btn-area {
        position: fixed; 
        bottom: 30px; 
        left: 0; right: 0;
        display: flex; justify-content: center;
        z-index: 500;
        pointer-events: none;
    }
    .big-start-btn {
        pointer-events: auto;
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: white; border: none; padding: 15px 50px;
        border-radius: 50px; font-size: 1.5em; font-weight: 900;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
        cursor: pointer; transition: transform 0.2s;
        border: 4px solid white;
    }
    .big-start-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* --- メニュー --- */
    .menu-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%;
    }
    .game-btn {
        background: white; border-radius: 15px; padding: 20px;
        text-align: center; cursor: pointer;
        box-shadow: 0 4px 0 #ddd; border: 2px solid transparent;
        transition: transform 0.1s;
    }
    .game-btn:active { transform: translateY(4px); box-shadow: none; }
    .game-btn h3 { margin: 10px 0 5px; color: var(--primary); }

    /* --- Level 1: ドラッグ&ドロップ --- */
    .drag-area {
        display: flex; width: 100%; height: 350px; gap: 10px; margin-top: 20px; position: relative;
        touch-action: none; 
    }
    .drop-zone {
        flex: 1; border-radius: 20px;
        display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
        padding: 20px; font-weight: 900; font-size: 1.5em; color: white;
        transition: all 0.2s;
    }
    .zone-imasu { background-color: var(--imasu-color); box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
    .zone-arimasu { background-color: var(--arimasu-color); box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
    
    .center-piece {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 110px; height: 110px; background: white;
        border-radius: 50%; 
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        display: flex; justify-content: center; align-items: center;
        font-size: 1.2em; font-weight: 900; cursor: grab; z-index: 10;
        border: 5px solid var(--accent);
        text-align: center; padding: 5px;
        touch-action: none; user-select: none;
    }
    
    .drag-ghost {
        position: fixed; pointer-events: none; z-index: 9999;
        width: 110px; height: 110px; background: white;
        border-radius: 50%; 
        border: 5px solid var(--accent);
        display: flex; justify-content: center; align-items: center;
        font-size: 1.2em; font-weight: 900; color: var(--text-color);
        box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        transform: translate(-50%, -50%);
        text-align: center; opacity: 0.9;
    }

    /* --- Level 2-4: クイズ形式 --- */
    .quiz-container {
        background: white; width: 100%; max-width: 500px;
        border-radius: 20px; padding: 20px; text-align: center;
        box-shadow: 0 8px 0 #eee;
    }
    
    .quiz-img-area {
        width: 100%; height: 180px; background: #f9f9f9;
        border-radius: 15px; margin-bottom: 15px;
        display: flex; justify-content: center; align-items: center;
        font-size: 3em; color: #555; border: 2px dashed #ddd;
        position: relative; overflow: hidden;
    }
    .quiz-img-area.small-img i, .quiz-img-area.small-img img {
        font-size: 2.5em; width: 60px; height: 60px;
    }
    
    .quiz-question { font-size: 1.3em; font-weight: bold; margin-bottom: 20px; line-height: 1.4; }
    .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } 
    
    .option-btn {
        background: #f0f4f8; border: 2px solid #ddd; border-radius: 12px;
        padding: 15px 5px; font-size: 1.0em; font-weight: bold; cursor: pointer;
        transition: all 0.1s; min-height: 60px; display: flex; align-items: center; justify-content: center;
    }
    .option-btn:active { transform: translateY(3px); background: #e3f2fd; }
    .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
    .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

    /* --- 確認モーダル --- */
    .feedback-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: none;
        justify-content: center; align-items: center; z-index: 200;
    }
    .feedback-box {
        background: white; padding: 30px; border-radius: 20px; text-align: center;
        width: 90%; max-width: 350px; animation: popIn 0.3s;
    }
    .next-btn {
        background: var(--primary); color: white; border: none;
        padding: 12px 30px; border-radius: 30px; font-size: 1.1em; font-weight: bold;
        cursor: pointer; margin-top: 15px; box-shadow: 0 4px 0 #3949ab;
    }
    .next-btn:active { transform: translateY(3px); box-shadow: none; }

    @keyframes popIn { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }

</style>
</head>
<body>

<header>
    <a href="index.html" class="logo"><i class="fa-solid fa-shapes"></i> います・あります</a>
    <a href="index.html" class="home-link"><i class="fa-solid fa-house"></i> ホーム</a>
</header>

<div class="container">
    <div id="auth-status" style="font-size:0.8em; color:#666; margin-bottom:10px;">認証中...</div>

    <div id="start-screen" class="screen active">
        
        <div class="lists-row">
            <div class="list-col">
                <div class="section-title" style="background:var(--imasu-color);">
                    <i class="fa-solid fa-heart"></i> います
                </div>
                <div id="list-imasu" class="word-grid"></div>
            </div>

            <div class="list-col">
                <div class="section-title" style="background:var(--arimasu-color);">
                    <i class="fa-solid fa-cube"></i> あります
                </div>
                <div id="list-arimasu" class="word-grid"></div>
            </div>
        </div>

        <div class="start-btn-area">
            <button class="big-start-btn" onclick="showMenu()">
                <i class="fa-solid fa-gamepad"></i> ゲームスタート！
            </button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <h2 style="color:var(--primary);">ゲームを えらんでね</h2>
        <div class="menu-grid">
            <div class="game-btn" onclick="startLevel(1)">
                <i class="fa-solid fa-hand-pointer fa-2x" style="color:var(--imasu-color);"></i>
                <h3>Level 1</h3>
                <p>います？あります？<br>(ドラッグ 10問)</p>
            </div>
            <div class="game-btn" onclick="startLevel(2)">
                <i class="fa-solid fa-map-location-dot fa-2x" style="color:var(--arimasu-color);"></i>
                <h3>Level 2</h3>
                <p>なにが ありますか？<br>(ランダム 10問)</p>
            </div>
            <div class="game-btn" onclick="startLevel(3)">
                <i class="fa-solid fa-comments fa-2x" style="color:#ab47bc;"></i>
                <h3>Level 3</h3>
                <p>だれが いますか？<br>(ランダム 10問)</p>
            </div>
            <div class="game-btn" onclick="startLevel(4)">
                <i class="fa-solid fa-building fa-2x" style="color:#ff9800;"></i>
                <h3>Level 4</h3>
                <p>どこですか？<br>(ランダム 10問)</p>
            </div>
        </div>
        <button onclick="showScreen('start-screen')" style="margin-top:30px; background:none; border:none; color:#999; cursor:pointer;">リストにもどる</button>
    </div>

    <div id="level1-screen" class="screen">
        <h2 style="margin:0;">どっちかな？ (10問)</h2>
        <p style="margin:5px 0; color:#666;">おとを きいて えらぼう！</p>
        
        <div class="drag-area" id="drag-area">
            <div class="drop-zone zone-imasu" id="zone-imasu">
                <div>います</div>
                <div style="font-size:0.5em; opacity:0.8;">(Living)</div>
            </div>
            <div class="drop-zone zone-arimasu" id="zone-arimasu">
                <div>あります</div>
                <div style="font-size:0.5em; opacity:0.8;">(Non-living)</div>
            </div>
        </div>
        <button onclick="showMenu()" style="margin-top:30px; background:none; border:none; color:#999; cursor:pointer;">やめる</button>
    </div>

    <div id="quiz-screen" class="screen">
        <h2 id="quiz-title">Level ?</h2>
        <div class="quiz-container">
            <div class="quiz-img-area" id="quiz-img"></div>
            <div class="quiz-question" id="quiz-question">もんだい</div>
            <button id="btn-replay" onclick="playQuizAudio()" style="margin-bottom:15px; border:none; background:#e3f2fd; color:var(--primary); padding:5px 15px; border-radius:20px; cursor:pointer;">
                <i class="fa-solid fa-volume-high"></i> もういちどきく
            </button>
            <div class="quiz-options" id="quiz-options"></div>
        </div>
        <button onclick="showMenu()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">やめる</button>
    </div>
</div>

<div id="feedback-modal" class="feedback-overlay">
    <div class="feedback-box">
        <div id="fb-icon" style="font-size:3em; margin-bottom:10px;"></div>
        <div id="fb-word" style="font-size:1.5em; font-weight:bold; color:var(--primary); margin:10px 0;"></div>
        <div id="fb-msg" style="color:#666; margin-bottom:10px;"></div>
        <button class="next-btn" onclick="nextQuestionAction()">つぎへ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.appspot.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    window.currentUserId = null;
    const authStatusEl = document.getElementById('auth-status');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUserId = user.uid;
            authStatusEl.textContent = "✅ ログイン中";
        } else {
            window.currentUserId = null;
            authStatusEl.textContent = "❌ ゲストモード";
        }
    });

    window.addPointsToUser = async function(points) {
        if (!window.currentUserId) return;
        try {
            await updateDoc(doc(db, "users", window.currentUserId), { points: increment(points) });
        } catch (e) { console.error(e); }
    }
</script>

<script>
    // --- データ ---
    // Type 1 = います (Living), Type 0 = あります (Non-living)
    // isPerson = true の場合は「だれ」
    const wordsData = [
        { id: "w01", text: "せんせい", type: 1, isPerson: true, icon: "fa-user-tie" },
        { id: "w02", text: "がくせい", type: 1, isPerson: true, icon: "fa-user-graduate" },
        { id: "w03", text: "ねこ", type: 1, isPerson: false, icon: "fa-cat" },
        { id: "w04", text: "いぬ", type: 1, isPerson: false, icon: "fa-dog" },
        { id: "w05", text: "とり", type: 1, isPerson: false, icon: "fa-crow" },
        { id: "w06", text: "さかな", type: 1, isPerson: false, icon: "fa-fish" },
        { id: "w07", text: "ぞう", type: 1, isPerson: false, icon: "fa-elephant" },
        { id: "w08", text: "おとこのひと", type: 1, isPerson: true, icon: "fa-person" },
        { id: "w09", text: "おんなのひと", type: 1, isPerson: true, icon: "fa-person-dress" },
        { id: "w10", text: "おとこのこ", type: 1, isPerson: true, icon: "fa-child" },
        { id: "w11", text: "おんなのこ", type: 1, isPerson: true, icon: "fa-child-dress" },
        { id: "w12", text: "パンダ", type: 1, isPerson: false, icon: "fa-paw" },
        { id: "w13", text: "うさぎ", type: 1, isPerson: false, icon: "fa-paw" },
        { id: "w14", text: "うま", type: 1, isPerson: false, icon: "fa-horse" },
        { id: "w15", text: "うし", type: 1, isPerson: false, icon: "fa-cow" },
        { id: "w16", text: "むし", type: 1, isPerson: false, icon: "fa-bug" },
        { id: "w17", text: "かえる", type: 1, isPerson: false, icon: "fa-frog" },
        { id: "w18", text: "ともだち", type: 1, isPerson: true, icon: "fa-user-group" },
        { id: "w19", text: "かぞく", type: 1, isPerson: true, icon: "fa-people-roof" },
        { id: "w20", text: "あかちゃん", type: 1, isPerson: true, icon: "fa-baby" },
        { id: "w21", text: "ほん", type: 0, icon: "fa-book" },
        { id: "w22", text: "えんぴつ", type: 0, icon: "fa-pen" },
        { id: "w23", text: "つくえ", type: 0, icon: "fa-table" },
        { id: "w24", text: "いす", type: 0, icon: "fa-chair" },
        { id: "w25", text: "とけい", type: 0, icon: "fa-clock" },
        { id: "w26", text: "かばん", type: 0, icon: "fa-briefcase" },
        { id: "w27", text: "テレビ", type: 0, icon: "fa-tv" },
        { id: "w28", text: "くるま", type: 0, icon: "fa-car" },
        { id: "w29", text: "でんしゃ", type: 0, icon: "fa-train" },
        { id: "w30", text: "いえ", type: 0, icon: "fa-house" },
        { id: "w31", text: "き", type: 0, icon: "fa-tree" },
        { id: "w32", text: "はな", type: 0, icon: "fa-fan" },
        { id: "w33", text: "ケータイ", type: 0, icon: "fa-mobile" },
        { id: "w34", text: "パソコン", type: 0, icon: "fa-laptop" },
        { id: "w35", text: "くつ", type: 0, icon: "fa-shoe-prints" },
        { id: "w36", text: "ぼうし", type: 0, icon: "fa-hat-cowboy" },
        { id: "w37", text: "かさ", type: 0, icon: "fa-umbrella" },
        { id: "w38", text: "れいぞうこ", type: 0, icon: "fa-snowflake" },
        { id: "w39", text: "ベッド", type: 0, icon: "fa-bed" },
        { id: "w40", text: "おふろ", type: 0, icon: "fa-bath" }
    ];

    // --- 音声 ---
    const synth = window.speechSynthesis;
    let currentQuizObj = null; 

    function speak(text, callback) {
        if (synth.speaking) synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = 'ja-JP';
        utterThis.rate = 0.9;
        if(callback) utterThis.onend = () => callback();
        synth.speak(utterThis);
    }

    function playQuizAudio() {
        if(!currentQuizObj) return;
        if (quizLvl === 4 && currentQuizObj.answerKana) {
            // Level 4 は質問 → 答えの流れ
            speak(currentQuizObj.text, () => {
                setTimeout(() => {
                    speak(currentQuizObj.answerKana);
                }, 1500);
            });
        } else {
            speak(currentQuizObj.text);
        }
    }

    function grantDailyPoint(questId) {
        if (!window.currentUserId) return;
        const today = new Date().toISOString().split('T')[0];
        const storageKey = `imasu_arimasu_points_${window.currentUserId}_${today}`;
        let answered = JSON.parse(localStorage.getItem(storageKey)) || [];
        if (!answered.includes(questId)) {
            if(window.addPointsToUser) window.addPointsToUser(1);
            answered.push(questId);
            localStorage.setItem(storageKey, JSON.stringify(answered));
        }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(synth.speaking) synth.cancel();
    }
    window.showMenu = () => showScreen('menu-screen');

    function initWordLists() {
        const iList = document.getElementById('list-imasu');
        const aList = document.getElementById('list-arimasu');
        iList.innerHTML = ''; aList.innerHTML = '';
        wordsData.forEach(w => {
            const div = document.createElement('div');
            div.className = `word-card ${w.type === 1 ? 'imasu' : 'arimasu'}`;
            div.innerHTML = `<i class="fa-solid ${w.icon} word-icon" style="color:${w.type===1?'var(--imasu-color)':'var(--arimasu-color)'}"></i><div class="word-text">${w.text}</div>`;
            div.onclick = () => speak(w.text);
            if (w.type === 1) iList.appendChild(div);
            else aList.appendChild(div);
        });
    }

    // --- Level 1 Logic (Drag) ---
    let lvl1Queue = [];
    let currentWord = null;

    window.startLevel = (lvl) => {
        if (lvl === 1) {
            const shuffled = [...wordsData].sort(() => Math.random() - 0.5);
            lvl1Queue = shuffled.slice(0, 10);
            showScreen('level1-screen');
            nextLevel1Question();
        } else {
            startQuizLevel(lvl);
        }
    };

    window.nextLevel1Question = () => {
        if (lvl1Queue.length === 0) {
            alert("Level 1 クリア！");
            showMenu();
            return;
        }
        currentWord = lvl1Queue.pop();
        
        const old = document.querySelector('.center-piece');
        if (old) old.remove();

        const area = document.getElementById('drag-area');
        const piece = document.createElement('div');
        piece.className = 'center-piece';
        piece.textContent = currentWord.text;
        
        setTimeout(() => speak(currentWord.text), 300);
        
        setupCommonDrag(piece);
        area.appendChild(piece);
    };

    let dragGhost = null;
    function setupCommonDrag(el) {
        const handleStart = (e) => {
            e.preventDefault();
            speak(currentWord.text);
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragGhost = document.createElement('div');
            dragGhost.className = 'drag-ghost';
            dragGhost.textContent = el.textContent;
            dragGhost.style.border = el.style.border; 
            dragGhost.style.left = clientX + 'px';
            dragGhost.style.top = clientY + 'px';
            document.body.appendChild(dragGhost);
            
            el.style.opacity = '0'; 

            if (e.type === 'touchstart') {
                document.addEventListener('touchmove', handleMove, {passive: false});
                document.addEventListener('touchend', handleEnd);
            } else {
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
            }
        };

        const handleMove = (e) => {
            e.preventDefault();
            if (!dragGhost) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragGhost.style.left = clientX + 'px';
            dragGhost.style.top = clientY + 'px';
        };

        const handleEnd = (e) => {
            document.removeEventListener('touchmove', handleMove);
            document.removeEventListener('touchend', handleEnd);
            document.removeEventListener('mousemove', handleMove);
            document.removeEventListener('mouseup', handleEnd);

            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;

            if (dragGhost) dragGhost.remove();
            dragGhost = null;
            el.style.opacity = '1';

            const target = document.elementFromPoint(clientX, clientY);
            if (target) {
                const zone = target.closest('.drop-zone');
                if (zone) checkDrop(zone, el);
            }
        };

        el.addEventListener('touchstart', handleStart, {passive: false});
        el.addEventListener('mousedown', handleStart);
    }

    function checkDrop(zone, piece) {
        const isImasuZone = zone.id === 'zone-imasu';
        const isCorrect = (isImasuZone && currentWord.type === 1) || (!isImasuZone && currentWord.type === 0);
        showFeedback(isCorrect, currentWord, () => {
             document.getElementById('feedback-modal').style.display = 'none';
             nextLevel1Question();
        });
        if (isCorrect) grantDailyPoint(`lvl1_${currentWord.id}`);
    }

    // --- Quiz Logic (Dynamic Generation) ---
    let quizQueue = [];
    let quizNow = null;
    let quizLvl = 0;

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    // Level 2 生成ロジック: ランダムな場所 + 適切な前置詞
    function generateLevel2() {
        const questions = [];
        const locations = [
            { text: "つくえ", icon: "fa-table", pos: ["うえ", "した"] },
            { text: "いす", icon: "fa-chair", pos: ["うえ", "した"] },
            { text: "かばん", icon: "fa-briefcase", pos: ["なか"] },
            { text: "はこ", icon: "fa-box-open", pos: ["なか", "うえ"] }, 
            { text: "へや", icon: "fa-door-open", pos: ["なか"] },
            { text: "ベッド", icon: "fa-bed", pos: ["うえ", "した"] },
            { text: "れいぞうこ", icon: "fa-snowflake", pos: ["なか"] }
        ];

        for(let i=0; i<10; i++) {
            const loc = locations[Math.floor(Math.random() * locations.length)];
            const pos = loc.pos[Math.floor(Math.random() * loc.pos.length)];
            
            // ターゲット（正解）を選ぶ
            const target = wordsData[Math.floor(Math.random() * wordsData.length)];
            const verb = target.type === 1 ? "います" : "あります";

            // 選択肢作成 (正解 + ダミー3つ)
            const others = shuffle(wordsData.filter(w => w.id !== target.id)).slice(0, 3);
            const options = shuffle([target, ...others]).map(w => w.text);
            const correctIdx = options.indexOf(target.text);

            questions.push({
                text: `${loc.text}の ${pos}に なにが ${verb}か？`,
                icon: target.icon, // 正解のターゲットアイコンを表示
                options: options,
                correct: correctIdx,
                targetWord: target 
            });
        }
        return questions;
    }

    // Level 3 生成ロジック: だれが/なにが いますか/ありますか ランダム
    function generateLevel3() {
        const questions = [];
        for(let i=0; i<10; i++) {
            const target = wordsData[Math.floor(Math.random() * wordsData.length)];
            const verb = target.type === 1 ? "います" : "あります";
            
            // ★修正: 人なら「だれ」、動物/物なら「なに」
            let qWord = "なに";
            if (target.type === 1 && target.isPerson) {
                qWord = "だれ";
            }

            // 選択肢作成
            const others = shuffle(wordsData.filter(w => w.id !== target.id)).slice(0, 3);
            const options = shuffle([target, ...others]).map(w => w.text);
            const correctIdx = options.indexOf(target.text);

            questions.push({
                text: `あそこに ${qWord}が ${verb}か？`,
                icon: target.icon, 
                options: options,
                correct: correctIdx,
                targetWord: target
            });
        }
        return questions;
    }

    // Level 4 生成ロジック: 場所と階数をランダム
    function generateLevel4() {
        const questions = [];
        const places = ["トイレ", "じむしょ", "しょくどう", "かいぎしつ", "うけつけ", "ロビー", "エレベーター"];
        const floors = ["1かい", "2かい", "3かい", "4かい", "5かい", "ちか1かい"];
        
        for(let i=0; i<10; i++) {
            const place = places[Math.floor(Math.random() * places.length)];
            const correctFloor = floors[Math.floor(Math.random() * floors.length)];
            
            // 選択肢 (正解 + ランダム3つ)
            const otherFloors = shuffle(floors.filter(f => f !== correctFloor)).slice(0, 3);
            const options = shuffle([correctFloor, ...otherFloors]);
            const correctIdx = options.indexOf(correctFloor);

            questions.push({
                text: `${place}は なんがい ですか？`,
                answerKana: `${place}は... ${correctFloor}に あります。`,
                icon: "fa-building",
                options: options,
                correct: correctIdx,
                targetWord: { text: correctFloor, icon: "fa-building" } 
            });
        }
        return questions;
    }

    function startQuizLevel(lvl) {
        quizLvl = lvl;
        if (lvl === 2) quizQueue = generateLevel2();
        else if (lvl === 3) quizQueue = generateLevel3();
        else if (lvl === 4) quizQueue = generateLevel4();

        showScreen('quiz-screen');
        document.getElementById('quiz-title').textContent = `Level ${lvl}`;
        const imgArea = document.getElementById('quiz-img');
        
        // ★修正: 前回Level 2に適用していた縮小クラスを削除
        imgArea.classList.remove('small-img');

        nextQuizQuestion();
    }

    function nextQuizQuestion() {
        if (quizQueue.length === 0) {
            alert(`Level ${quizLvl} クリア！`);
            showMenu();
            return;
        }
        quizNow = quizQueue.pop();
        currentQuizObj = quizNow; 
        
        const imgArea = document.getElementById('quiz-img');
        
        const iconColor = (quizNow.targetWord && quizNow.targetWord.type === 1) ? 'var(--imasu-color)' : 
                          (quizNow.targetWord && quizNow.targetWord.type === 0) ? 'var(--arimasu-color)' : '#555';
        
        imgArea.innerHTML = `<i class="fa-solid ${quizNow.icon}" style="color:${iconColor}"></i>`;
        
        document.getElementById('quiz-question').textContent = quizNow.text;

        playQuizAudio();
        
        const optsDiv = document.getElementById('quiz-options');
        optsDiv.innerHTML = '';
        quizNow.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => checkQuiz(idx, btn);
            optsDiv.appendChild(btn);
        });
    }

    function checkQuiz(idx, btn) {
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.disabled = true);
        const isCorrect = idx === quizNow.correct;
        
        if (isCorrect) {
            btn.classList.add('correct');
            grantDailyPoint(`lvl${quizLvl}_q`);
        } else {
            btn.classList.add('wrong');
            btns[quizNow.correct].classList.add('correct');
        }

        // Level 4 は答えの音声を流す
        if (quizLvl === 4) {
            setTimeout(() => speak(quizNow.answerKana), 200);
        }

        setTimeout(nextQuizQuestion, 2500); 
    }

    let onNextAction = null;
    window.nextQuestionAction = () => { if(onNextAction) onNextAction(); };

    function showFeedback(isCorrect, word, callback) {
        const modal = document.getElementById('feedback-modal');
        const icon = document.getElementById('fb-icon');
        const wText = document.getElementById('fb-word');
        const msg = document.getElementById('fb-msg');
        icon.innerHTML = `<i class="fa-solid ${word.icon}" style="color:${word.type===1?'var(--imasu-color)':'var(--arimasu-color)'}"></i>`;
        wText.textContent = word.text;
        if (isCorrect) {
            msg.textContent = "せいかい！ (Correct!)";
            msg.style.color = "#28a745";
        } else {
            msg.textContent = word.type === 1 ? "正解は「います」です" : "正解は「あります」です";
            msg.style.color = "#dc3545";
        }
        onNextAction = callback;
        modal.style.display = 'flex';
    }

    initWordLists();
</script>
</body>
</html>