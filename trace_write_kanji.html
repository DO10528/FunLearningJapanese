<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>漢字・かきかた道場 - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&family=Klee+One:wght@600&display=swap" rel="stylesheet">

<style>
    /* --- 共通デザイン --- */
    :root {
        --primary: #42a5f5; /* 漢字テーマ色 (青系) */
        --accent: #ffcc5c;
        --bg-color: #f0f4f8;
        --text-color: #333;
        --canvas-bg: #fff;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; flex-direction: column;
        user-select: none;
        touch-action: pan-y; /* スクロールは許可、ズーム等は抑制 */
    }

    /* --- ヘッダー --- */
    header {
        background: linear-gradient(135deg, #42a5f5 0%, #4facfe 100%);
        color: white; padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3); z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0;
    }
    .logo { font-size: 1.4em; font-weight: 900; color: white; text-decoration: none; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
    .home-link { color: white; text-decoration: none; font-weight: bold; background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 20px; }

    .container {
        flex-grow: 1; padding: 20px;
        width: 100%; max-width: 1000px; margin: 0 auto;
        display: flex; flex-direction: column; align-items: center;
    }

    /* --- 認証ステータス --- */
    #auth-status { font-size: 0.9em; color: #666; margin-bottom: 15px; background: white; padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* --- 漢字グリッド --- */
    .kanji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px; width: 100%;
        padding-bottom: 40px;
    }

    .kanji-card {
        background: white;
        border-radius: 15px;
        aspect-ratio: 1;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.1s;
        border: 2px solid transparent;
    }
    .kanji-card:hover { transform: translateY(-3px); box-shadow: 0 6px 10px rgba(0,0,0,0.1); }
    .kanji-card:active { transform: translateY(2px); box-shadow: none; }
    
    .kanji-char {
        font-family: 'Klee One', cursive; /* 教科書体 */
        font-size: 2.5em;
        color: #333;
        line-height: 1;
    }
    .kanji-meaning {
        font-size: 0.7em;
        color: #888;
        margin-top: 5px;
        text-align: center;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 90%;
    }

    /* --- 練習モーダル --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
        display: none; justify-content: center; align-items: center;
        z-index: 1000; padding: 20px;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }

    .modal-content {
        background: white;
        width: 100%; max-width: 800px;
        border-radius: 20px;
        overflow: hidden;
        display: flex; flex-direction: column;
        max-height: 90vh;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    /* ヘッダー */
    .modal-header {
        background: var(--bg-color); padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 2px solid #ddd;
    }
    .modal-title { font-weight: bold; font-size: 1.2em; color: #555; }
    .close-btn {
        background: #ddd; border: none; width: 36px; height: 36px; border-radius: 50%;
        font-size: 1.2em; color: #666; cursor: pointer;
    }

    /* メインエリア（左右分割） */
    .modal-body {
        display: flex; flex-direction: row;
        overflow-y: auto; flex-grow: 1;
        padding: 20px; gap: 20px;
        justify-content: center; align-items: flex-start;
    }

    /* 左：情報エリア */
    .info-panel {
        flex: 1; max-width: 300px;
        display: flex; flex-direction: column; gap: 15px;
    }
    .info-box {
        background: #f9f9f9; padding: 15px; border-radius: 12px;
        border-left: 5px solid var(--primary);
    }
    .info-label { font-size: 0.8em; color: #888; font-weight: bold; margin-bottom: 5px; }
    .info-text { font-size: 1.1em; font-weight: bold; color: #333; line-height: 1.4; }

    /* 右：練習エリア */
    .practice-panel {
        display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    
    .canvas-container {
        position: relative;
        width: 300px; height: 300px;
        background: white;
        border: 4px solid #42a5f5; border-radius: 15px;
        cursor: crosshair;
        touch-action: none; /* キャンバス内のスクロール無効化 */
    }
    
    /* ガイド用背景文字 */
    .canvas-guide {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        font-family: 'Klee One', cursive;
        font-size: 220px;
        color: #e0e0e0; /* 薄いグレー */
        pointer-events: none; /* タッチイベントを通す */
        user-select: none;
    }
    /* 十字リーダー */
    .canvas-lines {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
    }
    .line-v { position: absolute; left: 50%; top: 10%; bottom: 10%; width: 0; border-left: 1px dashed #ccc; }
    .line-h { position: absolute; top: 50%; left: 10%; right: 10%; height: 0; border-top: 1px dashed #ccc; }

    canvas {
        position: absolute; top: 0; left: 0;
        z-index: 10;
    }

    /* コントロール */
    .controls {
        display: flex; gap: 10px; width: 100%; justify-content: center; margin-top: 10px; flex-wrap: wrap;
    }
    .btn {
        padding: 10px 20px; border-radius: 30px; border: none;
        font-weight: bold; font-family: 'Zen Maru Gothic', sans-serif;
        cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 8px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }
    .btn:active { transform: translateY(3px); box-shadow: none; }
    
    .btn-audio { background: #ff9800; color: white; box-shadow: 0 4px 0 #e65100; }
    .btn-clear { background: #f44336; color: white; box-shadow: 0 4px 0 #d32f2f; }
    .btn-done { background: #4caf50; color: white; box-shadow: 0 4px 0 #388e3c; font-size: 1.2em; padding: 12px 40px; }

    /* スマホ対応 */
    @media (max-width: 700px) {
        .modal-body { flex-direction: column; align-items: center; padding: 10px; }
        .info-panel { width: 100%; max-width: 100%; order: 2; }
        .practice-panel { width: 100%; order: 1; }
        .canvas-container { width: 280px; height: 280px; }
        .canvas-guide { font-size: 200px; }
        .kanji-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; }
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

</style>
</head>
<body>

<header>
    <a href="index.html" class="logo"><i class="fa-solid fa-pen-nib"></i> 漢字・かきかた道場</a>
    <a href="index.html" class="home-link"><i class="fa-solid fa-house"></i> ホーム</a>
</header>

<div class="container">
    <div id="auth-status">認証中...</div>
    
    <div style="text-align:center; margin-bottom:20px;">
        <h2 style="color:var(--primary); margin-bottom:5px;">かんじを えらぼう</h2>
        <p>1年生の かんじ 80こ</p>
    </div>

    <div class="kanji-grid" id="kanji-grid">
        </div>
</div>

<div id="practice-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-paintbrush"></i> かきかた れんしゅう</div>
            <button class="close-btn" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="modal-body">
            
            <div class="practice-panel">
                <div class="canvas-container">
                    <div class="canvas-lines">
                        <div class="line-v"></div>
                        <div class="line-h"></div>
                    </div>
                    <div id="guide-char" class="canvas-guide"></div>
                    <canvas id="draw-canvas" width="300" height="300"></canvas>
                </div>
                
                <div class="controls">
                    <button class="btn btn-audio" onclick="playAudio()"><i class="fa-solid fa-volume-high"></i> きく</button>
                    <button class="btn btn-clear" onclick="clearCanvas()"><i class="fa-solid fa-eraser"></i> けす</button>
                    <button class="btn btn-done" onclick="finishPractice()"><i class="fa-regular fa-circle-check"></i> できた！</button>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-box">
                    <div class="info-label">オン（音読み）</div>
                    <div id="info-on" class="info-text"></div>
                </div>
                <div class="info-box">
                    <div class="info-label">くん（訓読み）</div>
                    <div id="info-kun" class="info-text"></div>
                </div>
                <div class="info-box">
                    <div class="info-label">いみ (Meaning)</div>
                    <div id="info-mean" class="info-text"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.appspot.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    window.currentUserId = null;
    const authStatusEl = document.getElementById('auth-status');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUserId = user.uid;
            authStatusEl.textContent = "✅ ログイン中";
        } else {
            window.currentUserId = null;
            authStatusEl.textContent = "❌ ゲストモード (ポイントはつきません)";
        }
    });

    // ポイント加算
    window.addPoints = async function(points) {
        if (!window.currentUserId) return;
        try {
            const userRef = doc(db, "users", window.currentUserId);
            await updateDoc(userRef, { points: increment(points) });
            console.log("Points added:", points);
        } catch (e) {
            console.error("Error adding points:", e);
        }
    }
</script>

<script>
    const synth = window.speechSynthesis;
    let voices = [];
    synth.onvoiceschanged = () => { voices = synth.getVoices(); };

    // --- データ ---
    const kanjiList = [
        { "kanji": "一", "kun": "ひと", "on": "いち", "meaning": "One" },
        { "kanji": "二", "kun": "ふた", "on": "に", "meaning": "Two" },
        { "kanji": "三", "kun": "み", "on": "さん", "meaning": "Three" },
        { "kanji": "四", "kun": "よ・よん", "on": "し", "meaning": "Four" },
        { "kanji": "五", "kun": "いつ", "on": "ご", "meaning": "Five" },
        { "kanji": "六", "kun": "む", "on": "ろく", "meaning": "Six" },
        { "kanji": "七", "kun": "なな", "on": "しち", "meaning": "Seven" },
        { "kanji": "八", "kun": "や", "on": "はち", "meaning": "Eight" },
        { "kanji": "九", "kun": "ここの", "on": "く・きゅう", "meaning": "Nine" },
        { "kanji": "十", "kun": "とお", "on": "じゅう", "meaning": "Ten" },
        { "kanji": "百", "kun": "もも", "on": "ひゃく", "meaning": "Hundred" },
        { "kanji": "千", "kun": "ち", "on": "せん", "meaning": "Thousand" },
        { "kanji": "万", "kun": "よろず", "on": "まん", "meaning": "Ten Thousand" },
        { "kanji": "円", "kun": "まる", "on": "えん", "meaning": "Yen, Circle" },
        { "kanji": "年", "kun": "とし", "on": "ねん", "meaning": "Year" },
        { "kanji": "月", "kun": "つき", "on": "げつ・がつ", "meaning": "Month, Moon" },
        { "kanji": "日", "kun": "ひ・か", "on": "にち・じつ", "meaning": "Day, Sun" },
        { "kanji": "火", "kun": "ひ", "on": "か", "meaning": "Fire" },
        { "kanji": "水", "kun": "みず", "on": "すい", "meaning": "Water" },
        { "kanji": "木", "kun": "き", "on": "もく・ぼく", "meaning": "Tree, Wood" },
        { "kanji": "金", "kun": "かね", "on": "きん", "meaning": "Gold, Money" },
        { "kanji": "土", "kun": "つち", "on": "ど", "meaning": "Earth, Soil" },
        { "kanji": "山", "kun": "やま", "on": "さん", "meaning": "Mountain" },
        { "kanji": "川", "kun": "かわ", "on": "せん", "meaning": "River" },
        { "kanji": "田", "kun": "た", "on": "でん", "meaning": "Rice field" },
        { "kanji": "人", "kun": "ひと", "on": "じん・にん", "meaning": "Person" },
        { "kanji": "大", "kun": "おお", "on": "だい・たい", "meaning": "Big, Large" },
        { "kanji": "小", "kun": "ちい", "on": "しょう", "meaning": "Small, Little" },
        { "kanji": "上", "kun": "うえ・あ", "on": "じょう", "meaning": "Up, Above" },
        { "kanji": "下", "kun": "した・さ", "on": "か・げ", "meaning": "Down, Below" },
        { "kanji": "口", "kun": "くち", "on": "こう・く", "meaning": "Mouth" },
        { "kanji": "耳", "kun": "みみ", "on": "じ", "meaning": "Ear" },
        { "kanji": "手", "kun": "て", "on": "しゅ", "meaning": "Hand" },
        { "kanji": "目", "kun": "め", "on": "もく", "meaning": "Eye" },
        { "kanji": "力", "kun": "ちから", "on": "りょく・りき", "meaning": "Power, Strength" },
        { "kanji": "父", "kun": "ちち", "on": "ふ", "meaning": "Father" },
        { "kanji": "母", "kun": "はは", "on": "ぼ", "meaning": "Mother" },
        { "kanji": "子", "kun": "こ", "on": "し・す", "meaning": "Child" },
        { "kanji": "女", "kun": "おんな", "on": "じょ・にょ", "meaning": "Woman" },
        { "kanji": "男", "kun": "おとこ", "on": "だん・なん", "meaning": "Man" },
        { "kanji": "先", "kun": "さき", "on": "せん", "meaning": "Ahead, Previous" },
        { "kanji": "生", "kun": "い・う・なま", "on": "せい・しょう", "meaning": "Life, Birth" },
        { "kanji": "学", "kun": "まな", "on": "がく", "meaning": "Study, Learning" },
        { "kanji": "校", "kun": "なし", "on": "こう", "meaning": "School" },
        { "kanji": "文", "kun": "ふみ", "on": "ぶん・もん", "meaning": "Sentence, Writing" },
        { "kanji": "字", "kun": "あざ", "on": "じ", "meaning": "Character, Letter" },
        { "kanji": "語", "kun": "かた", "on": "ご", "meaning": "Word, Language" },
        { "kanji": "前", "kun": "まえ", "on": "ぜん", "meaning": "Before, Front" },
        { "kanji": "後", "kun": "のち・うし・あと", "on": "ご・こう", "meaning": "After, Back" },
        { "kanji": "外", "kun": "そと・ほか", "on": "がい・げ", "meaning": "Outside" },
        { "kanji": "右", "kun": "みぎ", "on": "う・ゆう", "meaning": "Right" },
        { "kanji": "左", "kun": "ひだり", "on": "さ", "meaning": "Left" },
        { "kanji": "入", "kun": "い・はい", "on": "にゅう・じゅ", "meaning": "Enter, Insert" },
        { "kanji": "出", "kun": "で・だ", "on": "しゅつ・すい", "meaning": "Go out, Exit" },
        { "kanji": "立", "kun": "た", "on": "りつ・りゅう", "meaning": "Stand" },
        { "kanji": "休", "kun": "やす", "on": "きゅう", "meaning": "Rest, Day off" },
        { "kanji": "見", "kun": "み", "on": "けん", "meaning": "See, Look" },
        { "kanji": "行", "kun": "い・ゆ", "on": "こう・ぎょう", "meaning": "Go, Travel" },
        { "kanji": "来", "kun": "く・きた", "on": "らい", "meaning": "Come, Next" },
        { "kanji": "気", "kun": "なし", "on": "き・け", "meaning": "Spirit, Air, Mood" },
        { "kanji": "空", "kun": "そら・あ・から", "on": "くう", "meaning": "Sky, Empty" },
        { "kanji": "天", "kun": "あめ・あま", "on": "てん", "meaning": "Heaven, Sky" },
        { "kanji": "雨", "kun": "あめ・あま", "on": "う", "meaning": "Rain" },
        { "kanji": "早", "kun": "はや", "on": "そう", "meaning": "Early" },
        { "kanji": "草", "kun": "くさ", "on": "そう", "meaning": "Grass" },
        { "kanji": "虫", "kun": "むし", "on": "ちゅう", "meaning": "Insect" },
        { "kanji": "犬", "kun": "いぬ", "on": "けん", "meaning": "Dog" },
        { "kanji": "竹", "kun": "たけ", "on": "ちく", "meaning": "Bamboo" },
        { "kanji": "林", "kun": "はやし", "on": "りん", "meaning": "Woods" },
        { "kanji": "森", "kun": "もり", "on": "しん", "meaning": "Forest" },
        { "kanji": "石", "kun": "いし", "on": "せき", "meaning": "Stone" },
        { "kanji": "王", "kun": "なし", "on": "おう", "meaning": "King" },
        { "kanji": "玉", "kun": "たま", "on": "ぎょく", "meaning": "Ball, Jewel" },
        { "kanji": "車", "kun": "くるま", "on": "しゃ", "meaning": "Car, Vehicle" },
        { "kanji": "町", "kun": "まち", "on": "ちょう", "meaning": "Town, Village" },
        { "kanji": "村", "kun": "むら", "on": "そん", "meaning": "Village" },
        { "kanji": "音", "kun": "おと・ね", "on": "おん", "meaning": "Sound" },
        { "kanji": "糸", "kun": "いと", "on": "し", "meaning": "Thread" },
        { "kanji": "中", "kun": "なか", "on": "ちゅう", "meaning": "Middle, Inside" },
        { "kanji": "北", "kun": "きた", "on": "ほく", "meaning": "North" },
        { "kanji": "南", "kun": "みなみ", "on": "なん", "meaning": "South" },
        { "kanji": "西", "kun": "にし", "on": "せい・さい", "meaning": "West" },
        { "kanji": "東", "kun": "ひがし", "on": "とう", "meaning": "East" },
        { "kanji": "本", "kun": "もと", "on": "ほん", "meaning": "Book, Origin" },
        { "kanji": "名", "kun": "な", "on": "めい・みょう", "meaning": "Name" },
        { "kanji": "足", "kun": "あし", "on": "そく", "meaning": "Foot, Leg" },
        { "kanji": "赤", "kun": "あか", "on": "せき・しゃく", "meaning": "Red" },
        { "kanji": "青", "kun": "あお", "on": "せい・しょう", "meaning": "Blue" },
        { "kanji": "白", "kun": "しろ", "on": "はく", "meaning": "White" }
    ];

    const grid = document.getElementById('kanji-grid');
    const modal = document.getElementById('practice-modal');
    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
    
    let isDrawing = false;
    let currentKanji = null;

    // --- 初期化 ---
    function init() {
        kanjiList.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'kanji-card';
            card.innerHTML = `
                <div class="kanji-char">${item.kanji}</div>
                <div class="kanji-meaning">${item.meaning}</div>
            `;
            card.onclick = () => openModal(item);
            grid.appendChild(card);
        });
        setupCanvas();
    }

    // --- 音声再生 ---
    window.playAudio = () => {
        if (!currentKanji) return;
        if (synth.speaking) synth.cancel();

        const onText = currentKanji.on !== 'なし' ? currentKanji.on : '';
        const kunText = currentKanji.kun !== 'なし' ? currentKanji.kun : '';
        
        // 読み上げテキスト: "漢字。音読み、〇〇。訓読み、〇〇。"
        const utterText = `${currentKanji.kanji}。音読み、${onText}。訓読み、${kunText}`;
        
        const utterThis = new SpeechSynthesisUtterance(utterText);
        utterThis.lang = 'ja-JP';
        utterThis.rate = 0.9;
        
        // 女性声優先
        const femaleKeywords = ['Google', 'Microsoft', 'Kyoko', 'O-Ren', 'Haruka', 'Ayumi', 'Female'];
        const jpVoices = voices.filter(v => v.lang.includes('ja') || v.lang.includes('JP'));
        let targetVoice = null;
        for (const keyword of femaleKeywords) {
            targetVoice = jpVoices.find(v => v.name.includes(keyword));
            if (targetVoice) break;
        }
        if (targetVoice) utterThis.voice = targetVoice;
        
        synth.speak(utterThis);
    };

    // --- モーダル操作 ---
    window.openModal = (item) => {
        currentKanji = item;
        
        document.getElementById('info-on').textContent = item.on;
        document.getElementById('info-kun').textContent = item.kun;
        document.getElementById('info-mean').textContent = item.meaning;
        document.getElementById('guide-char').textContent = item.kanji;
        
        clearCanvas();
        modal.classList.add('active');
        
        // 自動再生はせず、ユーザーがボタンを押す形式にしています
    };

    window.closeModal = () => {
        modal.classList.remove('active');
        currentKanji = null;
    };

    // --- キャンバスロジック ---
    function setupCanvas() {
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDraw(e.touches[0]);
        }, { passive: false });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e.touches[0]);
        }, { passive: false });
        canvas.addEventListener('touchend', stopDraw);
    }

    function startDraw(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 12;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#333';
        ctx.globalAlpha = 0.8;

        ctx.beginPath();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.moveTo(x, y);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.lineTo(x, y);
        ctx.stroke();
    }

    function stopDraw() {
        isDrawing = false;
        ctx.closePath();
    }

    window.clearCanvas = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    window.finishPractice = () => {
        // ★修正点：1ポイント加算
        if (window.addPoints) {
            window.addPoints(1);
        }
        
        const btn = document.querySelector('.btn-done');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-star"></i> すごい！';
        btn.style.background = '#ff9800';
        
        setTimeout(() => {
            closeModal();
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '#4caf50';
            }, 500);
        }, 800);
    };

    init();

</script>
</body>
</html>