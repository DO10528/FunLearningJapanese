<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>合戦</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: #333;
        background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://www.transparenttextures.com/patterns/shattered-island.png');
        color: white; margin: 0; padding: 0;
        height: 100vh;
        display: flex; flex-direction: column; align-items: center;
    }

    .battle-header {
        width: 100%; padding: 15px; background: rgba(0,0,0,0.8);
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 2px solid #b71c1c;
    }
    .level-badge {
        font-family: 'Yuji Syuku', serif; font-size: 1.5em; color: #ffd700;
        text-shadow: 2px 2px 0 #b71c1c;
    }

    .main-area {
        flex-grow: 1; width: 100%; max-width: 600px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        padding: 20px; box-sizing: border-box; position: relative;
    }

    /* 学習（巻物） */
    .scroll-paper {
        background: #fdf5e6; color: #333;
        width: 100%; padding: 40px 20px;
        border-radius: 5px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        text-align: center; border-top: 10px solid #5d4037; border-bottom: 10px solid #5d4037;
    }
    .card-img { font-size: 6em; color: #1a237e; margin-bottom: 10px; }
    .card-word { font-size: 3em; font-family: 'Yuji Syuku', serif; margin: 0; }
    
    /* クイズ */
    /* いざ、勝負！をど真ん中に配置 */
    .quiz-title-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        background: rgba(0,0,0,0.7); z-index: 50;
        animation: fadeOut 2.5s forwards; pointer-events: none;
    }
    .quiz-title-text {
        font-family: 'Yuji Syuku', serif; font-size: 4em; color: #ffeb3b;
        text-shadow: 4px 4px 0 #b71c1c;
        animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeOut { 0%, 70% { opacity: 1; } 100% { opacity: 0; display: none; } }

    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
    .quiz-btn {
        background: #fff; border: 4px solid #5d4037;
        border-radius: 10px; padding: 15px;
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; position: relative; color: #333;
        min-height: 120px; justify-content: center;
    }
    
    .quiz-btn.slashed { border-color: #2e7d32; background: #e8f5e9; }
    .quiz-btn.wrong { border-color: #b71c1c; background: #ffebee; }
    .quiz-btn i { font-size: 3em; margin-bottom: 10px; color: #1a237e; }
    .quiz-btn span { font-weight: bold; font-size: 1.5em; }

    .next-btn {
        margin-top: 30px; padding: 10px 40px;
        background: #b71c1c; color: #fff; font-family: 'Yuji Syuku', serif; font-size: 1.5em;
        border: 2px solid #ffd700; border-radius: 30px; cursor: pointer;
    }

    /* 獲得モーダル */
    .loot-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 200;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        color: white; text-align: center;
    }
    .loot-item { font-size: 5em; margin: 20px 0; animation: popIn 0.5s; }
    .loot-name { font-size: 2.5em; font-family: 'Yuji Syuku', serif; color: #ffeb3b; }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="battle-header">
    <div class="level-badge" id="level-display">出陣</div>
    <a href="culture_map.html" style="color:white; text-decoration:none;">撤退</a>
</div>

<div class="main-area">
    <div id="learn-area" class="scroll-paper">
        <i id="learn-img" class="fa-solid fa-question card-img"></i>
        <h1 id="learn-jp" class="card-word">...</h1>
        <div id="learn-en" class="card-en" style="color:#555;">...</div>
        <button class="next-btn" style="margin-top:20px; width:50px; height:50px; padding:0; border-radius:50%;" onclick="playAudio()">
            <i class="fa-solid fa-volume-high"></i>
        </button>
    </div>

    <div id="quiz-area" class="hidden" style="width:100%;">
        
        <div class="quiz-title-overlay" id="quiz-overlay">
            <div class="quiz-title-text">いざ、勝負！</div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
             <button onclick="playQuizAudio()" style="background:#ffca28; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">
                <i class="fa-solid fa-volume-high"></i> 音をきく
            </button>
        </div>
        <div class="quiz-grid" id="quiz-options"></div>
    </div>

    <button id="action-btn" class="next-btn" onclick="nextStep()">次へ</button>
</div>

<div class="loot-modal" id="loot-modal">
    <h1 style="color:#f44336; font-family:'Yuji Syuku', serif; font-size:3em;">勝利!!</h1>
    <div id="item-view" class="hidden">
        <div class="loot-item" id="loot-icon"></div>
        <div class="loot-name" id="loot-name"></div>
        <p>戦利品を獲得しました</p>
    </div>
    <button class="next-btn" onclick="goBackToMap()">凱旋する</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebaseapp.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;
    let userState = { level:1, subLevel:1, inventory:[], equipped:{} };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if(user) {
            const snap = await getDoc(doc(db, "users", user.uid, "progress", "sengoku_rpg_v2"));
            if(snap.exists()) userState = snap.data();
        } else {
            const saved = sessionStorage.getItem('sengoku_save_v2');
            if(saved) userState = JSON.parse(saved);
        }
    });

    // 漢字データを含む辞書
    const CATEGORIES = {
        1: { title: "たべもの", words: [
            {hiragana:"おすし", kanji:"お寿司", en:"Sushi", icon:"fa-solid fa-fish"}, 
            {hiragana:"ラーメン", kanji:"ラーメン", en:"Ramen", icon:"fa-solid fa-bowl-food"},
            {hiragana:"うどん", kanji:"うどん", en:"Udon", icon:"fa-solid fa-bowl-rice"}, 
            {hiragana:"おにぎり", kanji:"おにぎり", en:"Rice ball", icon:"fa-solid fa-mountain"},
            {hiragana:"てんぷら", kanji:"天ぷら", en:"Tempura", icon:"fa-solid fa-shrimp"}, 
            {hiragana:"だんご", kanji:"団子", en:"Dango", icon:"fa-solid fa-ellipsis"},
            {hiragana:"なっとう", kanji:"納豆", en:"Natto", icon:"fa-solid fa-jar"}, 
            {hiragana:"たこやき", kanji:"たこ焼き", en:"Takoyaki", icon:"fa-solid fa-circle-dot"}
        ]},
        // 他のカテゴリも同様に構造変更が必要です
        2: { title: "あいさつ", words: [
            {hiragana:"おはよう", kanji:"おはよう", en:"Morning", icon:"fa-solid fa-sun"}
        ]}
    };
    
    // 設定言語取得
    const displayLang = localStorage.getItem('culture_lang') || 'hiragana';

    const DROP_TABLE = ['helm_1', 'armor_1', 'weapon_1', 'helm_2', 'armor_2', 'weapon_2', 'helm_3', 'weapon_3'];
    window.ITEM_DB = {
    // --- 頭 (Helm) ---
    'helm_1': { type: 'helm', name: '足軽の笠', icon: 'fa-solid fa-hat-cowboy', rarity: 'common', color: '#8d6e63' },
    'helm_2': { type: 'helm', name: '赤備えの兜', icon: 'fa-solid fa-helmet-safety', rarity: 'rare', color: '#d32f2f' },
    'helm_3': { type: 'helm', name: '三日月の兜', icon: 'fa-brands fa-fort-awesome', rarity: 'legend', color: '#ffd700' },
    'helm_nobu': { type: 'helm', name: '魔王の兜', icon: 'fa-solid fa-crown', rarity: 'legend', color: '#212121' },
    'helm_hide': { type: 'helm', name: '日輪の兜', icon: 'fa-solid fa-sun', rarity: 'legend', color: '#ffca28' },
    'helm_ninja': { type: 'helm', name: '忍び頭巾', icon: 'fa-solid fa-user-ninja', rarity: 'rare', color: '#424242' },

    // --- 体 (Armor) ---
    'armor_1': { type: 'armor', name: 'ボロの着物', icon: 'fa-solid fa-shirt', rarity: 'common', color: '#d7ccc8' },
    'armor_2': { type: 'armor', name: '侍の鎧', icon: 'fa-solid fa-shield-halved', rarity: 'rare', color: '#1a237e' },
    'armor_nobu': { type: 'armor', name: '南蛮マント', icon: 'fa-solid fa-user-secret', rarity: 'legend', color: '#b71c1c' },
    'armor_ninja': { type: 'armor', name: '忍び装束', icon: 'fa-solid fa-user-large', rarity: 'rare', color: '#000000' },

    // --- 武器 (Weapon) ---
    'weapon_1': { type: 'weapon', name: '竹刀', icon: 'fa-solid fa-candy-cane', rarity: 'common', color: '#a1887f' },
    'weapon_2': { type: 'weapon', name: '名刀・虎徹', icon: 'fa-solid fa-khanda', rarity: 'rare', color: '#cfd8dc' },
    'weapon_3': { type: 'weapon', name: '妖刀・村正', icon: 'fa-solid fa-fire', rarity: 'legend', color: '#d50000' },
    'weapon_gun': { type: 'weapon', name: '火縄銃', icon: 'fa-solid fa-gun', rarity: 'rare', color: '#5d4037' },
    'weapon_fan': { type: 'weapon', name: '軍配', icon: 'fa-solid fa-fan', rarity: 'rare', color: '#fbc02d' },
    'weapon_shuri': { type: 'weapon', name: '手裏剣', icon: 'fa-solid fa-star', rarity: 'common', color: '#757575' }
};

    const params = new URLSearchParams(window.location.search);
    const levelId = parseInt(params.get('level')) || 1;
    const subLevel = parseInt(params.get('sub')) || 1;
    const catData = CATEGORIES[levelId] || CATEGORIES[1];
    
    const WORDS_PER_STAGE = 2;
    const startIndex = (subLevel - 1) * WORDS_PER_STAGE;
    const wordList = catData.words;
    const targetWords = [];
    
    for(let i=0; i<WORDS_PER_STAGE; i++) {
        targetWords.push(wordList[(startIndex + i) % wordList.length]);
    }

    let currentStep = 0;
    let isQuizMode = false;
    let quizCount = 0;
    const MAX_QUIZ = 3;
    let currentQuizAnswer = null;

    document.getElementById('level-display').innerText = `${catData.title}・第${subLevel}戦`;

    // 単語表示用ヘルパー
    function getWordText(word) {
        if (displayLang === 'kanji') return word.kanji;
        if (displayLang === 'en') return word.en;
        return word.hiragana;
    }

    function updateUI() {
        const learnArea = document.getElementById('learn-area');
        const quizArea = document.getElementById('quiz-area');
        const actionBtn = document.getElementById('action-btn');

        if (!isQuizMode) {
            // 学習
            if (currentStep < targetWords.length) {
                learnArea.classList.remove('hidden');
                quizArea.classList.add('hidden');
                actionBtn.innerText = "次へ";

                const word = targetWords[currentStep];
                // 表示言語設定を反映
                document.getElementById('learn-jp').innerText = getWordText(word);
                // 英語設定の時は、サブテキストを日本語にするなどの工夫も可能だが、今回はそのまま
                document.getElementById('learn-en').innerText = (displayLang === 'en') ? word.hiragana : word.en;
                
                const img = document.getElementById('learn-img');
                img.className = `${word.icon} card-img`;
                
                setTimeout(() => speak(word.hiragana), 500);
            } else {
                startQuizMode();
            }
        } else {
            // クイズ
            if (quizCount < MAX_QUIZ) {
                learnArea.classList.add('hidden');
                quizArea.classList.remove('hidden');
                actionBtn.classList.add('hidden');
                generateQuiz();
            } else {
                finishBattle();
            }
        }
    }

    function generateQuiz() {
        const optionsArea = document.getElementById('quiz-options');
        optionsArea.innerHTML = '';
        const correctWord = targetWords[Math.floor(Math.random() * targetWords.length)];
        currentQuizAnswer = correctWord;
        
        let choices = [correctWord];
        const others = wordList.filter(w => w.hiragana !== correctWord.hiragana);
        for(let i=0; i<3; i++) {
            choices.push(others[Math.floor(Math.random() * others.length)]);
        }
        choices.sort(() => Math.random() - 0.5);

        choices.forEach(word => {
            const btn = document.createElement('div');
            btn.className = 'quiz-btn';
            btn.innerHTML = `
                <i class="${word.icon}"></i>
                <span>${getWordText(word)}</span>
            `;
            btn.onclick = () => checkAnswer(btn, word);
            optionsArea.appendChild(btn);
        });
        setTimeout(() => speak(correctWord.hiragana), 500);
    }

    window.playAudio = () => speak(targetWords[currentStep].hiragana);
    window.playQuizAudio = () => speak(currentQuizAnswer.hiragana);

    function checkAnswer(btn, word) {
        if (word.hiragana === currentQuizAnswer.hiragana) {
            btn.classList.add('slashed');
            speak("みごと！");
            quizCount++;
            setTimeout(updateUI, 1000);
        } else {
            btn.classList.add('wrong');
            speak("まだまだ");
        }
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        window.speechSynthesis.speak(ut);
    }

    window.nextStep = () => { currentStep++; updateUI(); }
    
    function startQuizMode() { 
        isQuizMode = true; 
        updateUI();
        // アニメーション再生
        const overlay = document.getElementById('quiz-overlay');
        overlay.style.display = 'flex';
        overlay.style.animation = 'none';
        overlay.offsetHeight; 
        overlay.style.animation = 'fadeOut 2.5s forwards';
    }

    async function finishBattle() {
        const dropId = DROP_TABLE[Math.floor(Math.random() * DROP_TABLE.length)];
        const itemInfo = ITEM_DB[dropId];

        const modal = document.getElementById('loot-modal');
        modal.style.display = 'flex';
        
        document.getElementById('item-view').classList.remove('hidden');
        document.getElementById('loot-icon').innerHTML = `<i class="${itemInfo.icon}" style="color:${itemInfo.color}"></i>`;
        document.getElementById('loot-name').innerText = itemInfo.name;

        // 進捗更新
        let nextLvl = userState.level;
        let nextSub = userState.subLevel;

        if (levelId === userState.level && subLevel === userState.subLevel) {
            nextSub++;
            if (nextSub > 10) { 
                nextLvl++;
                nextSub = 1;
            }
        }
        
        if(!userState.inventory) userState.inventory = [];
        if(!userState.inventory.includes(dropId)) userState.inventory.push(dropId);
        
        const newState = { 
            level: Math.max(userState.level, nextLvl), 
            subLevel: (nextLvl > userState.level) ? 1 : Math.max(userState.subLevel, nextSub),
            inventory: userState.inventory,
            equipped: userState.equipped,
            money: (userState.money || 0) + 50
        };

        if(currentUser) await setDoc(doc(db, "users", currentUser.uid, "progress", "sengoku_rpg_v2"), newState);
        else sessionStorage.setItem('sengoku_save_v2', JSON.stringify(newState));
    }

    window.goBackToMap = () => window.location.href = "culture_map.html";

    updateUI();
</script>

</body>
</html>