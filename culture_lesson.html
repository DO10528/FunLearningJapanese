<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>合戦</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: #333;
        background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://www.transparenttextures.com/patterns/shattered-island.png');
        color: white; margin: 0; padding: 0;
        height: 100vh;
        display: flex; flex-direction: column; align-items: center;
    }

    .battle-header {
        width: 100%; padding: 15px; background: rgba(0,0,0,0.8);
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 2px solid #b71c1c;
    }
    .level-badge {
        font-family: 'Yuji Syuku', serif; font-size: 1.5em; color: #ffd700;
        text-shadow: 2px 2px 0 #b71c1c;
    }

    .main-area {
        flex-grow: 1; width: 100%; max-width: 600px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        padding: 20px; box-sizing: border-box; position: relative;
    }

    /* 学習（巻物） */
    .scroll-paper {
        background: #fdf5e6; color: #333;
        width: 100%; padding: 40px 20px;
        border-radius: 5px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        text-align: center; border-top: 10px solid #5d4037; border-bottom: 10px solid #5d4037;
    }
    .card-img { font-size: 6em; color: #1a237e; margin-bottom: 10px; }
    .card-word { font-size: 3em; font-family: 'Yuji Syuku', serif; margin: 0; }
    
    /* クイズ */
    .quiz-title-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        background: rgba(0,0,0,0.7); z-index: 50;
        animation: fadeOut 2.5s forwards; pointer-events: none;
    }
    .quiz-title-text {
        font-family: 'Yuji Syuku', serif; font-size: 4em; color: #ffeb3b;
        text-shadow: 4px 4px 0 #b71c1c;
        animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeOut { 0%, 70% { opacity: 1; } 100% { opacity: 0; display: none; } }

    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
    .quiz-btn {
        background: #fff; border: 4px solid #5d4037;
        border-radius: 10px; padding: 15px;
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; position: relative; color: #333;
        min-height: 120px; justify-content: center;
    }
    
    .quiz-btn.slashed { border-color: #2e7d32; background: #e8f5e9; }
    .quiz-btn.wrong { border-color: #b71c1c; background: #ffebee; }
    .quiz-btn i { font-size: 3em; margin-bottom: 10px; color: #1a237e; }
    .quiz-btn span { font-weight: bold; font-size: 1.5em; }

    .next-btn {
        margin-top: 30px; padding: 10px 40px;
        background: #b71c1c; color: #fff; font-family: 'Yuji Syuku', serif; font-size: 1.5em;
        border: 2px solid #ffd700; border-radius: 30px; cursor: pointer;
    }

    /* 獲得モーダル */
    .loot-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 200;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        color: white; text-align: center;
    }
    .loot-item { font-size: 5em; margin: 20px 0; animation: popIn 0.5s; }
    .loot-name { font-size: 2.5em; font-family: 'Yuji Syuku', serif; color: #ffeb3b; }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="battle-header">
    <div class="level-badge" id="level-display">出陣</div>
    <a href="culture_map.html" style="color:white; text-decoration:none;">撤退</a>
</div>

<div class="main-area">
    <div id="learn-area" class="scroll-paper">
        <i id="learn-img" class="fa-solid fa-question card-img"></i>
        <h1 id="learn-jp" class="card-word">...</h1>
        <div id="learn-en" class="card-en" style="color:#555;">...</div>
        <button class="next-btn" style="margin-top:20px; width:50px; height:50px; padding:0; border-radius:50%;" onclick="playAudio()">
            <i class="fa-solid fa-volume-high"></i>
        </button>
    </div>

    <div id="quiz-area" class="hidden" style="width:100%;">
        
        <div class="quiz-title-overlay" id="quiz-overlay">
            <div class="quiz-title-text">いざ、勝負！</div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
             <button onclick="playQuizAudio()" style="background:#ffca28; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">
                <i class="fa-solid fa-volume-high"></i> 音をきく
            </button>
        </div>
        <div class="quiz-grid" id="quiz-options"></div>
    </div>

    <button id="action-btn" class="next-btn" onclick="nextStep()">次へ</button>
</div>

<div class="loot-modal" id="loot-modal">
    <h1 style="color:#f44336; font-family:'Yuji Syuku', serif; font-size:3em;">勝利!!</h1>
    <div id="item-view" class="hidden">
        <div class="loot-item" id="loot-icon"></div>
        <div class="loot-name" id="loot-name"></div>
        <p>戦利品を獲得しました</p>
    </div>
    <button class="next-btn" onclick="goBackToMap()">凱旋する</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebaseapp.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;
    let userState = { level:1, subLevel:1, inventory:[], equipped:{} };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if(user) {
            const snap = await getDoc(doc(db, "users", user.uid, "progress", "sengoku_rpg_v2"));
            if(snap.exists()) userState = snap.data();
        } else {
            const saved = sessionStorage.getItem('sengoku_save_v2');
            if(saved) userState = JSON.parse(saved);
        }
    });

    // --- 200単語データ ---
    const CATEGORIES = {
        1: { title: "たべもの", words: [
            {hiragana:"おすし", kanji:"お寿司", en:"Sushi", icon:"fa-solid fa-fish"}, 
            {hiragana:"ラーメン", kanji:"ラーメン", en:"Ramen", icon:"fa-solid fa-bowl-food"},
            {hiragana:"うどん", kanji:"うどん", en:"Udon", icon:"fa-solid fa-bowl-rice"}, 
            {hiragana:"おにぎり", kanji:"おにぎり", en:"Rice Ball", icon:"fa-solid fa-mountain"},
            {hiragana:"てんぷら", kanji:"天ぷら", en:"Tempura", icon:"fa-solid fa-shrimp"}, 
            {hiragana:"たこやき", kanji:"たこ焼き", en:"Takoyaki", icon:"fa-solid fa-circle-dot"},
            {hiragana:"なっとう", kanji:"納豆", en:"Natto", icon:"fa-solid fa-jar"}, 
            {hiragana:"みそしる", kanji:"味噌汁", en:"Miso Soup", icon:"fa-solid fa-mug-hot"},
            {hiragana:"やきとり", kanji:"焼き鳥", en:"Yakitori", icon:"fa-solid fa-drumstick-bite"},
            {hiragana:"ぎゅうどん", kanji:"牛丼", en:"Beef Bowl", icon:"fa-solid fa-bowl-food"},
            {hiragana:"カレー", kanji:"カレー", en:"Curry", icon:"fa-solid fa-utensil-spoon"},
            {hiragana:"オムライス", kanji:"オムライス", en:"Omelette Rice", icon:"fa-solid fa-egg"},
            {hiragana:"だんご", kanji:"団子", en:"Dango", icon:"fa-solid fa-ellipsis"},
            {hiragana:"たいやき", kanji:"たい焼き", en:"Taiyaki", icon:"fa-solid fa-fish"},
            {hiragana:"そば", kanji:"そば", en:"Soba", icon:"fa-solid fa-bacon"}, 
            {hiragana:"さしみ", kanji:"刺身", en:"Sashimi", icon:"fa-solid fa-fish-fins"},
            {hiragana:"もち", kanji:"餅", en:"Mochi", icon:"fa-solid fa-circle"},
            {hiragana:"おちゃ", kanji:"お茶", en:"Green Tea", icon:"fa-solid fa-leaf"},
            {hiragana:"おべんとう", kanji:"お弁当", en:"Bento", icon:"fa-solid fa-box-open"},
            {hiragana:"すきやき", kanji:"すき焼き", en:"Sukiyaki", icon:"fa-solid fa-fire-burner"}
        ]},
        2: { title: "あいさつ", words: [
            {hiragana:"おはよう", kanji:"おはよう", en:"Good Morning", icon:"fa-solid fa-sun"},
            {hiragana:"こんにちは", kanji:"こんにちは", en:"Hello", icon:"fa-regular fa-hand-spock"},
            {hiragana:"こんばんは", kanji:"こんばんは", en:"Good Evening", icon:"fa-solid fa-moon"},
            {hiragana:"おやすみ", kanji:"おやすみ", en:"Good Night", icon:"fa-solid fa-bed"},
            {hiragana:"ありがとう", kanji:"ありがとう", en:"Thank you", icon:"fa-solid fa-heart"},
            {hiragana:"ごめんね", kanji:"ごめんね", en:"Sorry", icon:"fa-solid fa-face-sad-tear"},
            {hiragana:"いただきます", kanji:"頂きます", en:"Let's eat", icon:"fa-solid fa-utensils"},
            {hiragana:"ごちそうさま", kanji:"ご馳走様", en:"Thanks for food", icon:"fa-solid fa-check"},
            {hiragana:"いってきます", kanji:"行ってきます", en:"I'm leaving", icon:"fa-solid fa-person-walking-arrow-right"},
            {hiragana:"いってらっしゃい", kanji:"行ってらっしゃい", en:"See you", icon:"fa-solid fa-hand"},
            {hiragana:"ただいま", kanji:"ただいま", en:"I'm home", icon:"fa-solid fa-house-user"},
            {hiragana:"おかえり", kanji:"おかえり", en:"Welcome back", icon:"fa-solid fa-door-open"},
            {hiragana:"バイバイ", kanji:"バイバイ", en:"Bye Bye", icon:"fa-solid fa-hand-peace"},
            {hiragana:"またね", kanji:"またね", en:"See you later", icon:"fa-solid fa-calendar-check"},
            {hiragana:"はじめまして", kanji:"初めまして", en:"Nice to meet you", icon:"fa-solid fa-handshake"},
            {hiragana:"よろしく", kanji:"よろしく", en:"Please treat me well", icon:"fa-solid fa-circle-check"},
            {hiragana:"はい", kanji:"はい", en:"Yes", icon:"fa-solid fa-check"},
            {hiragana:"いいえ", kanji:"いいえ", en:"No", icon:"fa-solid fa-xmark"},
            {hiragana:"おねがい", kanji:"お願い", en:"Please", icon:"fa-solid fa-hands-praying"},
            {hiragana:"かんぱい", kanji:"乾杯", en:"Cheers", icon:"fa-solid fa-beer-mug-empty"}
        ]},
        3: { title: "がっこう", words: [
            {hiragana:"せんせい", kanji:"先生", en:"Teacher", icon:"fa-solid fa-chalkboard-user"},
            {hiragana:"がくせい", kanji:"学生", en:"Student", icon:"fa-solid fa-child"},
            {hiragana:"えんぴつ", kanji:"鉛筆", en:"Pencil", icon:"fa-solid fa-pencil"},
            {hiragana:"けしごむ", kanji:"消しゴム", en:"Eraser", icon:"fa-solid fa-eraser"},
            {hiragana:"ノート", kanji:"ノート", en:"Notebook", icon:"fa-solid fa-book"},
            {hiragana:"きょうかしょ", kanji:"教科書", en:"Textbook", icon:"fa-solid fa-book-open"},
            {hiragana:"ランドセル", kanji:"ランドセル", en:"School Bag", icon:"fa-solid fa-suitcase"},
            {hiragana:"つくえ", kanji:"机", en:"Desk", icon:"fa-solid fa-table"},
            {hiragana:"いす", kanji:"椅子", en:"Chair", icon:"fa-solid fa-chair"},
            {hiragana:"こくばん", kanji:"黒板", en:"Blackboard", icon:"fa-solid fa-chalkboard"},
            {hiragana:"きょうしつ", kanji:"教室", en:"Classroom", icon:"fa-solid fa-school"},
            {hiragana:"きゅうしょく", kanji:"給食", en:"School Lunch", icon:"fa-solid fa-utensils"},
            {hiragana:"テスト", kanji:"テスト", en:"Test", icon:"fa-solid fa-file-pen"},
            {hiragana:"しゅくだい", kanji:"宿題", en:"Homework", icon:"fa-solid fa-house-laptop"},
            {hiragana:"ともだち", kanji:"友達", en:"Friend", icon:"fa-solid fa-user-group"},
            {hiragana:"はさみ", kanji:"ハサミ", en:"Scissors", icon:"fa-solid fa-scissors"},
            {hiragana:"のり", kanji:"のり", en:"Glue", icon:"fa-solid fa-bottle-droplet"},
            {hiragana:"じょうぎ", kanji:"定規", en:"Ruler", icon:"fa-solid fa-ruler-horizontal"},
            {hiragana:"とけい", kanji:"時計", en:"Clock", icon:"fa-solid fa-clock"},
            {hiragana:"チャイム", kanji:"チャイム", en:"Bell", icon:"fa-solid fa-bell"}
        ]},
        4: { title: "おうち", words: [
            {hiragana:"いえ", kanji:"家", en:"House", icon:"fa-solid fa-house"},
            {hiragana:"へや", kanji:"部屋", en:"Room", icon:"fa-solid fa-door-open"},
            {hiragana:"だいどころ", kanji:"台所", en:"Kitchen", icon:"fa-solid fa-kitchen-set"},
            {hiragana:"おふろ", kanji:"お風呂", en:"Bath", icon:"fa-solid fa-bath"},
            {hiragana:"トイレ", kanji:"トイレ", en:"Toilet", icon:"fa-solid fa-toilet"},
            {hiragana:"テレビ", kanji:"テレビ", en:"TV", icon:"fa-solid fa-tv"},
            {hiragana:"ベッド", kanji:"ベッド", en:"Bed", icon:"fa-solid fa-bed"},
            {hiragana:"ソファー", kanji:"ソファー", en:"Sofa", icon:"fa-solid fa-couch"},
            {hiragana:"まど", kanji:"窓", en:"Window", icon:"fa-regular fa-window-maximize"},
            {hiragana:"れいぞうこ", kanji:"冷蔵庫", en:"Fridge", icon:"fa-solid fa-snowflake"},
            {hiragana:"せんたくき", kanji:"洗濯機", en:"Washing Machine", icon:"fa-solid fa-shirt"},
            {hiragana:"テーブル", kanji:"テーブル", en:"Table", icon:"fa-solid fa-table"},
            {hiragana:"かぎ", kanji:"鍵", en:"Key", icon:"fa-solid fa-key"},
            {hiragana:"でんわ", kanji:"電話", en:"Phone", icon:"fa-solid fa-phone"},
            {hiragana:"でんき", kanji:"電気", en:"Light", icon:"fa-solid fa-lightbulb"},
            {hiragana:"かいだん", kanji:"階段", en:"Stairs", icon:"fa-solid fa-stairs"},
            {hiragana:"にわ", kanji:"庭", en:"Garden", icon:"fa-solid fa-tree"},
            {hiragana:"かぞく", kanji:"家族", en:"Family", icon:"fa-solid fa-people-roof"},
            {hiragana:"ねこ", kanji:"猫", en:"Cat", icon:"fa-solid fa-cat"},
            {hiragana:"いぬ", kanji:"犬", en:"Dog", icon:"fa-solid fa-dog"}
        ]},
        5: { title: "しぜん", words: [
            {hiragana:"やま", kanji:"山", en:"Mountain", icon:"fa-solid fa-mountain"},
            {hiragana:"かわ", kanji:"川", en:"River", icon:"fa-solid fa-water"},
            {hiragana:"うみ", kanji:"海", en:"Sea", icon:"fa-solid fa-umbrella-beach"},
            {hiragana:"そら", kanji:"空", en:"Sky", icon:"fa-solid fa-cloud-sun"},
            {hiragana:"たいよう", kanji:"太陽", en:"Sun", icon:"fa-solid fa-sun"},
            {hiragana:"つき", kanji:"月", en:"Moon", icon:"fa-solid fa-moon"},
            {hiragana:"ほし", kanji:"星", en:"Star", icon:"fa-solid fa-star"},
            {hiragana:"くも", kanji:"雲", en:"Cloud", icon:"fa-solid fa-cloud"},
            {hiragana:"あめ", kanji:"雨", en:"Rain", icon:"fa-solid fa-cloud-rain"},
            {hiragana:"ゆき", kanji:"雪", en:"Snow", icon:"fa-regular fa-snowflake"},
            {hiragana:"き", kanji:"木", en:"Tree", icon:"fa-solid fa-tree"},
            {hiragana:"はな", kanji:"花", en:"Flower", icon:"fa-solid fa-plant-wilt"},
            {hiragana:"はっぱ", kanji:"葉っぱ", en:"Leaf", icon:"fa-solid fa-leaf"},
            {hiragana:"むし", kanji:"虫", en:"Bug", icon:"fa-solid fa-bug"},
            {hiragana:"とり", kanji:"鳥", en:"Bird", icon:"fa-solid fa-crow"},
            {hiragana:"さかな", kanji:"魚", en:"Fish", icon:"fa-solid fa-fish"},
            {hiragana:"かぜ", kanji:"風", en:"Wind", icon:"fa-solid fa-wind"},
            {hiragana:"ひ", kanji:"火", en:"Fire", icon:"fa-solid fa-fire"},
            {hiragana:"いし", kanji:"石", en:"Stone", icon:"fa-solid fa-gem"},
            {hiragana:"にじ", kanji:"虹", en:"Rainbow", icon:"fa-solid fa-rainbow"}
        ]},
        6: { title: "からだ", words: [
            {hiragana:"あたま", kanji:"頭", en:"Head", icon:"fa-solid fa-user"},
            {hiragana:"め", kanji:"目", en:"Eye", icon:"fa-regular fa-eye"},
            {hiragana:"みみ", kanji:"耳", en:"Ear", icon:"fa-solid fa-ear-listen"},
            {hiragana:"くち", kanji:"口", en:"Mouth", icon:"fa-regular fa-face-smile"},
            {hiragana:"はな", kanji:"鼻", en:"Nose", icon:"fa-regular fa-face-flushed"},
            {hiragana:"て", kanji:"手", en:"Hand", icon:"fa-regular fa-hand"},
            {hiragana:"あし", kanji:"足", en:"Foot/Leg", icon:"fa-solid fa-shoe-prints"},
            {hiragana:"ゆび", kanji:"指", en:"Finger", icon:"fa-solid fa-hand-point-up"},
            {hiragana:"おなか", kanji:"お腹", en:"Stomach", icon:"fa-solid fa-person-pregnant"},
            {hiragana:"せなか", kanji:"背中", en:"Back", icon:"fa-solid fa-person-walking"},
            {hiragana:"は", kanji:"歯", en:"Tooth", icon:"fa-solid fa-tooth"},
            {hiragana:"かみのけ", kanji:"髪の毛", en:"Hair", icon:"fa-solid fa-user-hair-long"},
            {hiragana:"かお", kanji:"顔", en:"Face", icon:"fa-solid fa-face-smile"},
            {hiragana:"うで", kanji:"腕", en:"Arm", icon:"fa-solid fa-dumbbell"},
            {hiragana:"くび", kanji:"首", en:"Neck", icon:"fa-solid fa-user-tie"},
            {hiragana:"ひざ", kanji:"膝", en:"Knee", icon:"fa-solid fa-person-kneeling"},
            {hiragana:"しんぞう", kanji:"心臓", en:"Heart", icon:"fa-solid fa-heart-pulse"},
            {hiragana:"ち", kanji:"血", en:"Blood", icon:"fa-solid fa-droplet"},
            {hiragana:"ほね", kanji:"骨", en:"Bone", icon:"fa-solid fa-bone"},
            {hiragana:"こえ", kanji:"声", en:"Voice", icon:"fa-solid fa-microphone"}
        ]},
        7: { title: "いろ・かず", words: [
            {hiragana:"あか", kanji:"赤", en:"Red", icon:"fa-solid fa-circle", color:"#f44336"},
            {hiragana:"あお", kanji:"青", en:"Blue", icon:"fa-solid fa-circle", color:"#2196f3"},
            {hiragana:"きいろ", kanji:"黄色", en:"Yellow", icon:"fa-solid fa-circle", color:"#ffeb3b"},
            {hiragana:"みどり", kanji:"緑", en:"Green", icon:"fa-solid fa-circle", color:"#4caf50"},
            {hiragana:"くろ", kanji:"黒", en:"Black", icon:"fa-solid fa-circle", color:"#000000"},
            {hiragana:"しろ", kanji:"白", en:"White", icon:"fa-regular fa-circle", color:"#ffffff"},
            {hiragana:"いち", kanji:"一", en:"One", icon:"fa-solid fa-1"},
            {hiragana:"に", kanji:"二", en:"Two", icon:"fa-solid fa-2"},
            {hiragana:"さん", kanji:"三", en:"Three", icon:"fa-solid fa-3"},
            {hiragana:"よん", kanji:"四", en:"Four", icon:"fa-solid fa-4"},
            {hiragana:"ご", kanji:"五", en:"Five", icon:"fa-solid fa-5"},
            {hiragana:"ろく", kanji:"六", en:"Six", icon:"fa-solid fa-6"},
            {hiragana:"なな", kanji:"七", en:"Seven", icon:"fa-solid fa-7"},
            {hiragana:"はち", kanji:"八", en:"Eight", icon:"fa-solid fa-8"},
            {hiragana:"きゅう", kanji:"九", en:"Nine", icon:"fa-solid fa-9"},
            {hiragana:"じゅう", kanji:"十", en:"Ten", icon:"fa-solid fa-1"},
            {hiragana:"ひゃく", kanji:"百", en:"Hundred", icon:"fa-solid fa-c"},
            {hiragana:"まる", kanji:"丸", en:"Circle", icon:"fa-regular fa-circle"},
            {hiragana:"しかく", kanji:"四角", en:"Square", icon:"fa-regular fa-square"},
            {hiragana:"さんかく", kanji:"三角", en:"Triangle", icon:"fa-solid fa-play", color:"#333"}
        ]},
        8: { title: "でんとう", words: [
            {hiragana:"きもの", kanji:"着物", en:"Kimono", icon:"fa-solid fa-user-tie"},
            {hiragana:"げた", kanji:"下駄", en:"Geta", icon:"fa-solid fa-shoe-prints"},
            {hiragana:"はし", kanji:"箸", en:"Chopsticks", icon:"fa-solid fa-utensils"},
            {hiragana:"たたみ", kanji:"畳", en:"Tatami", icon:"fa-solid fa-border-all"},
            {hiragana:"じんじゃ", kanji:"神社", en:"Shrine", icon:"fa-solid fa-torii-gate"},
            {hiragana:"おてら", kanji:"お寺", en:"Temple", icon:"fa-solid fa-gopuram"},
            {hiragana:"にんじゃ", kanji:"忍者", en:"Ninja", icon:"fa-solid fa-user-ninja"},
            {hiragana:"さむらい", kanji:"侍", en:"Samurai", icon:"fa-solid fa-khanda"},
            {hiragana:"すもう", kanji:"相撲", en:"Sumo", icon:"fa-solid fa-users"},
            {hiragana:"おまつり", kanji:"お祭り", en:"Festival", icon:"fa-solid fa-drum"},
            {hiragana:"はなび", kanji:"花火", en:"Fireworks", icon:"fa-solid fa-explosion"},
            {hiragana:"さくら", kanji:"桜", en:"Cherry Blossom", icon:"fa-solid fa-fan"},
            {hiragana:"おんせん", kanji:"温泉", en:"Hot Spring", icon:"fa-solid fa-hot-tub-person"},
            {hiragana:"せんす", kanji:"扇子", en:"Fan", icon:"fa-solid fa-fan"},
            {hiragana:"おめん", kanji:"お面", en:"Mask", icon:"fa-solid fa-mask"},
            {hiragana:"かんじ", kanji:"漢字", en:"Kanji", icon:"fa-solid fa-font"},
            {hiragana:"さどう", kanji:"茶道", en:"Tea Ceremony", icon:"fa-solid fa-mug-hot"},
            {hiragana:"おりがみ", kanji:"折り紙", en:"Origami", icon:"fa-solid fa-note-sticky"},
            {hiragana:"ふじさん", kanji:"富士山", en:"Mt. Fuji", icon:"fa-solid fa-mountain-sun"},
            {hiragana:"おまもり", kanji:"お守り", en:"Charm", icon:"fa-solid fa-bag-shopping"}
        ]},
        9: { title: "あそび", words: [
            {hiragana:"ゲーム", kanji:"ゲーム", en:"Game", icon:"fa-solid fa-gamepad"},
            {hiragana:"ボール", kanji:"ボール", en:"Ball", icon:"fa-solid fa-baseball"},
            {hiragana:"にんぎょう", kanji:"人形", en:"Doll", icon:"fa-solid fa-robot"},
            {hiragana:"ふうせん", kanji:"風船", en:"Balloon", icon:"fa-solid fa-soap"},
            {hiragana:"すべりだい", kanji:"滑り台", en:"Slide", icon:"fa-solid fa-stairs"},
            {hiragana:"ブランコ", kanji:"ブランコ", en:"Swing", icon:"fa-solid fa-anchor"},
            {hiragana:"こうえん", kanji:"公園", en:"Park", icon:"fa-solid fa-tree"},
            {hiragana:"はしる", kanji:"走る", en:"Run", icon:"fa-solid fa-person-running"},
            {hiragana:"ジャンプ", kanji:"ジャンプ", en:"Jump", icon:"fa-solid fa-arrow-up"},
            {hiragana:"うたう", kanji:"歌う", en:"Sing", icon:"fa-solid fa-microphone"},
            {hiragana:"おどる", kanji:"踊る", en:"Dance", icon:"fa-solid fa-music"},
            {hiragana:"おえかき", kanji:"お絵かき", en:"Drawing", icon:"fa-solid fa-palette"},
            {hiragana:"えほん", kanji:"絵本", en:"Picture Book", icon:"fa-solid fa-book-open"},
            {hiragana:"プール", kanji:"プール", en:"Pool", icon:"fa-solid fa-water-ladder"},
            {hiragana:"サッカー", kanji:"サッカー", en:"Soccer", icon:"fa-solid fa-futbol"},
            {hiragana:"やきゅう", kanji:"野球", en:"Baseball", icon:"fa-solid fa-baseball-bat-ball"},
            {hiragana:"ピアノ", kanji:"ピアノ", en:"Piano", icon:"fa-solid fa-music"},
            {hiragana:"ギター", kanji:"ギター", en:"Guitar", icon:"fa-solid fa-guitar"},
            {hiragana:"カメラ", kanji:"カメラ", en:"Camera", icon:"fa-solid fa-camera"},
            {hiragana:"りょこう", kanji:"旅行", en:"Travel", icon:"fa-solid fa-plane"}
        ]},
        10: { title: "ばしょ", words: [
            {hiragana:"えき", kanji:"駅", en:"Station", icon:"fa-solid fa-train"},
            {hiragana:"でんしゃ", kanji:"電車", en:"Train", icon:"fa-solid fa-train-subway"},
            {hiragana:"バス", kanji:"バス", en:"Bus", icon:"fa-solid fa-bus"},
            {hiragana:"くるま", kanji:"車", en:"Car", icon:"fa-solid fa-car"},
            {hiragana:"ひこうき", kanji:"飛行機", en:"Airplane", icon:"fa-solid fa-plane-up"},
            {hiragana:"くうこう", kanji:"空港", en:"Airport", icon:"fa-solid fa-plane-arrival"},
            {hiragana:"びょういん", kanji:"病院", en:"Hospital", icon:"fa-solid fa-hospital"},
            {hiragana:"こうばん", kanji:"交番", en:"Police Box", icon:"fa-solid fa-building-shield"},
            {hiragana:"ゆうびんきょく", kanji:"郵便局", en:"Post Office", icon:"fa-solid fa-envelope"},
            {hiragana:"コンビニ", kanji:"コンビニ", en:"Conv. Store", icon:"fa-solid fa-store"},
            {hiragana:"スーパー", kanji:"スーパー", en:"Supermarket", icon:"fa-solid fa-cart-shopping"},
            {hiragana:"レストラン", kanji:"レストラン", en:"Restaurant", icon:"fa-solid fa-utensils"},
            {hiragana:"ホテル", kanji:"ホテル", en:"Hotel", icon:"fa-solid fa-hotel"},
            {hiragana:"としょかん", kanji:"図書館", en:"Library", icon:"fa-solid fa-book"},
            {hiragana:"ぎんこう", kanji:"銀行", en:"Bank", icon:"fa-solid fa-building-columns"},
            {hiragana:"はし", kanji:"橋", en:"Bridge", icon:"fa-solid fa-archway"},
            {hiragana:"みち", kanji:"道", en:"Street", icon:"fa-solid fa-road"},
            {hiragana:"まち", kanji:"町", en:"Town", icon:"fa-solid fa-city"},
            {hiragana:"うみ", kanji:"海", en:"Sea", icon:"fa-solid fa-water"},
            {hiragana:"にほん", kanji:"日本", en:"Japan", icon:"fa-solid fa-map"}
        ]}
    };
    
    // 設定言語取得
    const displayLang = localStorage.getItem('culture_lang') || 'hiragana';

    // ドロップアイテム設定 (ここも武将・忍者を加えて更新)
    const DROP_TABLE = [
        // コモン
        'helm_1', 'armor_1', 'weapon_1', 'weapon_shuri',
        // レア
        'helm_2', 'armor_2', 'weapon_2', 'helm_ninja', 'armor_ninja', 'weapon_gun', 'weapon_fan',
        // レジェンド
        'helm_3', 'weapon_3', 'helm_nobu', 'armor_nobu', 'helm_hide'
    ];
    
    // アイテムDB (マップと同じ)
    const ITEM_DB = {
        'helm_1': { name: '足軽の笠', icon: 'fa-solid fa-hat-cowboy', color:'#fff' },
        'helm_2': { name: '赤備えの兜', icon: 'fa-solid fa-helmet-safety', color:'#d32f2f' },
        'helm_3': { name: '三日月の兜', icon: 'fa-brands fa-fort-awesome', color:'#ffd700' },
        'helm_nobu': { name: '魔王の兜', icon: 'fa-solid fa-crown', color: '#212121' },
        'helm_hide': { name: '日輪の兜', icon: 'fa-solid fa-sun', color: '#ffca28' },
        'helm_ninja': { name: '忍び頭巾', icon: 'fa-solid fa-user-ninja', color: '#424242' },

        'armor_1': { name: 'ボロの着物', icon: 'fa-solid fa-shirt', color:'#fff' },
        'armor_2': { name: '侍の鎧', icon: 'fa-solid fa-shield-halved', color:'#1a237e' },
        'armor_nobu': { name: '南蛮マント', icon: 'fa-solid fa-user-secret', color: '#b71c1c' },
        'armor_ninja': { name: '忍び装束', icon: 'fa-solid fa-user-large', color: '#000000' },

        'weapon_1': { name: '竹刀', icon: 'fa-solid fa-candy-cane', color:'#fff' },
        'weapon_2': { name: '名刀・虎徹', icon: 'fa-solid fa-khanda', color:'#cfd8dc' },
        'weapon_3': { name: '妖刀・村正', icon: 'fa-solid fa-fire', color:'#b71c1c' },
        'weapon_gun': { name: '火縄銃', icon: 'fa-solid fa-gun', color: '#5d4037' },
        'weapon_fan': { name: '軍配', icon: 'fa-solid fa-fan', color: '#fbc02d' },
        'weapon_shuri': { name: '手裏剣', icon: 'fa-solid fa-star', color: '#757575' }
    };

    const params = new URLSearchParams(window.location.search);
    const levelId = parseInt(params.get('level')) || 1;
    const subLevel = parseInt(params.get('sub')) || 1;
    const catData = CATEGORIES[levelId] || CATEGORIES[1];
    
    const WORDS_PER_STAGE = 2;
    const startIndex = (subLevel - 1) * WORDS_PER_STAGE;
    const wordList = catData.words;
    const targetWords = [];
    
    for(let i=0; i<WORDS_PER_STAGE; i++) {
        targetWords.push(wordList[(startIndex + i) % wordList.length]);
    }

    let currentStep = 0;
    let isQuizMode = false;
    let quizCount = 0;
    const MAX_QUIZ = 3;
    let currentQuizAnswer = null;

    document.getElementById('level-display').innerText = `${catData.title}・第${subLevel}戦`;

    function getWordText(word) {
        if (displayLang === 'kanji') return word.kanji;
        if (displayLang === 'en') return word.en;
        return word.hiragana;
    }

    function updateUI() {
        const learnArea = document.getElementById('learn-area');
        const quizArea = document.getElementById('quiz-area');
        const actionBtn = document.getElementById('action-btn');

        if (!isQuizMode) {
            // 学習
            if (currentStep < targetWords.length) {
                learnArea.classList.remove('hidden');
                quizArea.classList.add('hidden');
                actionBtn.innerText = "次へ";

                const word = targetWords[currentStep];
                document.getElementById('learn-jp').innerText = getWordText(word);
                document.getElementById('learn-en').innerText = (displayLang === 'en') ? word.hiragana : word.en;
                
                const img = document.getElementById('learn-img');
                img.className = `${word.icon} card-img`;
                
                setTimeout(() => speak(word.hiragana), 500);
            } else {
                startQuizMode();
            }
        } else {
            // クイズ
            if (quizCount < MAX_QUIZ) {
                learnArea.classList.add('hidden');
                quizArea.classList.remove('hidden');
                actionBtn.classList.add('hidden');
                generateQuiz();
            } else {
                finishBattle();
            }
        }
    }

    function generateQuiz() {
        const optionsArea = document.getElementById('quiz-options');
        optionsArea.innerHTML = '';
        const correctWord = targetWords[Math.floor(Math.random() * targetWords.length)];
        currentQuizAnswer = correctWord;
        
        let choices = [correctWord];
        const others = wordList.filter(w => w.hiragana !== correctWord.hiragana);
        for(let i=0; i<3; i++) {
            choices.push(others[Math.floor(Math.random() * others.length)]);
        }
        choices.sort(() => Math.random() - 0.5);

        choices.forEach(word => {
            const btn = document.createElement('div');
            btn.className = 'quiz-btn';
            btn.innerHTML = `
                <i class="${word.icon}"></i>
                <span>${getWordText(word)}</span>
            `;
            btn.onclick = () => checkAnswer(btn, word);
            optionsArea.appendChild(btn);
        });
        setTimeout(() => speak(correctWord.hiragana), 500);
    }

    window.playAudio = () => speak(targetWords[currentStep].hiragana);
    window.playQuizAudio = () => speak(currentQuizAnswer.hiragana);

    function checkAnswer(btn, word) {
        if (word.hiragana === currentQuizAnswer.hiragana) {
            btn.classList.add('slashed');
            speak("みごと！");
            quizCount++;
            setTimeout(updateUI, 1000);
        } else {
            btn.classList.add('wrong');
            speak("まだまだ");
        }
    }

    function speak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        window.speechSynthesis.speak(ut);
    }

    window.nextStep = () => { currentStep++; updateUI(); }
    
    function startQuizMode() { 
        isQuizMode = true; 
        updateUI();
        const overlay = document.getElementById('quiz-overlay');
        overlay.style.display = 'flex';
        overlay.style.animation = 'none';
        overlay.offsetHeight; 
        overlay.style.animation = 'fadeOut 2.5s forwards';
    }

    async function finishBattle() {
        const dropId = DROP_TABLE[Math.floor(Math.random() * DROP_TABLE.length)];
        const itemInfo = ITEM_DB[dropId];

        const modal = document.getElementById('loot-modal');
        modal.style.display = 'flex';
        
        document.getElementById('item-view').classList.remove('hidden');
        document.getElementById('loot-icon').innerHTML = `<i class="${itemInfo.icon}" style="color:${itemInfo.color}"></i>`;
        document.getElementById('loot-name').innerText = itemInfo.name;

        // 進捗更新
        let nextLvl = userState.level;
        let nextSub = userState.subLevel;

        if (levelId === userState.level && subLevel === userState.subLevel) {
            nextSub++;
            if (nextSub > 10) { 
                nextLvl++;
                nextSub = 1;
            }
        }
        
        if(!userState.inventory) userState.inventory = [];
        if(!userState.inventory.includes(dropId)) userState.inventory.push(dropId);
        
        const newState = { 
            level: Math.max(userState.level, nextLvl), 
            subLevel: (nextLvl > userState.level) ? 1 : Math.max(userState.subLevel, nextSub),
            inventory: userState.inventory,
            equipped: userState.equipped,
            money: (userState.money || 0) + 50
        };

        if(currentUser) await setDoc(doc(db, "users", currentUser.uid, "progress", "sengoku_rpg_v2"), newState);
        else sessionStorage.setItem('sengoku_save_v2', JSON.stringify(newState));
    }

    window.goBackToMap = () => window.location.href = "culture_map.html";

    updateUI();
</script>

</body>
</html>