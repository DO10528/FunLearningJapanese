:root {
        --bg-paper: #f3e5ab;
        --urushi-red: #b71c1c;
        --indigo: #1a237e;
        --gold: #ffd700;
        --ink: #212121;
        --map-bg: #d7ccc8;
        --path-color: #5d4037;
    }

    body {
        font-family: 'Yuji Syuku', serif;
        margin: 0; padding: 0;
        height: 100vh; height: 100dvh;
        overflow: hidden;
        color: var(--ink);
        display: flex; flex-direction: column;
        background-color: var(--map-bg);
    }

    /* --- ヘッダー --- */
    header {
        background: rgba(33, 33, 33, 0.95); color: #fff;
        padding: 8px 15px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 3px solid var(--gold);
        z-index: 200;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        flex-shrink: 0;
    }
    .game-title { 
        font-size: 1.2em; display: flex; align-items: center; gap: 8px; 
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 
        white-space: nowrap;
    }
    
    .lang-switch {
        background: #3e2723; border: 1px solid var(--gold);
        color: var(--gold); padding: 3px; border-radius: 5px;
        font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
        font-size: 0.8em;
    }

    .header-right { display: flex; gap: 10px; align-items: center; }
    .status-item { color: var(--gold); font-size: 0.8em; white-space: nowrap; }

    /* --- マップエリア --- */
    .map-viewport {
        flex-grow: 1;
        min-height: 0; /* ★スマホでのFlexボックス崩れ防止 */
        overflow: auto;
        position: relative;
        cursor: grab;
        background-color: var(--map-bg);
        /* スマホ向けに背景をシンプル化 */
        background-image: radial-gradient(circle at 50% 50%, #efebe9 0%, #d7ccc8 100%);
        -webkit-overflow-scrolling: touch; 
    }
    .map-viewport:active { cursor: grabbing; }

    .map-world {
        position: relative;
        width: 2000px; height: 1200px;
        /* スマホで重くなるパターン描画を削除し、シンプルなグリッド風に変更 */
        background-color: #cfd8dc;
        background-image: 
            linear-gradient(#b0bec5 2px, transparent 2px),
            linear-gradient(90deg, #b0bec5 2px, transparent 2px);
        background-size: 100px 100px;
        opacity: 1;
    }

    .road-svg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 1;
    }
    .road-path {
        fill: none; stroke: var(--path-color); stroke-width: 6;
        stroke-dasharray: 15 5; stroke-linecap: round;
    }

    .map-deco {
        position: absolute; font-size: 4em; color: #5d4037; opacity: 0.8; z-index: 2;
        pointer-events: none;
    }
    @media (max-width: 600px) { .map-deco { font-size: 2.5em; } }
    .deco-torii { color: #b71c1c; }
    .deco-tree { color: #33691e; font-size: 5em; }

    /* --- ノード（城・武将アイコン） --- */
    .node-container {
        position: absolute;
        display: flex; flex-direction: column; align-items: center;
        z-index: 10;
        /* ★スマホ対策：filterは重いので削除し、opacityだけで表現 */
        opacity: 0.6; 
        transform-origin: bottom center;
        /* ハードウェアアクセラレーションを明示的にON */
        transform: translate3d(0,0,0);
        will-change: transform;
    }
    .node-container > * { transform: translateY(-100%); }

    .node-container.unlocked { cursor: pointer; opacity: 1; }

    .node-container.unlocked:hover {
        z-index: 50;
        transform: scale(1.15) translateY(-10px) translate3d(0,0,0);
    }

    .node-castle-area { position: relative; display: flex; justify-content: center; align-items: flex-end; }
    
    .node-img {
        color: #4e342e; 
        /* ドロップシャドウも重いのでスマホでは控えめに */
        filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.3));
        transition: color 0.3s ease; 
    }
    .node-container.unlocked:hover .node-img {
        color: var(--urushi-red);
    }
    
    .size-s { font-size: 4em; } .size-m { font-size: 6em; } .size-l { font-size: 8em; } .size-xl { font-size: 10em; color: var(--urushi-red); }
    /* スマホ用にサイズを少し調整 */
    @media (max-width: 600px) {
        .size-s { font-size: 3em; } .size-m { font-size: 4em; } .size-l { font-size: 5em; } .size-xl { font-size: 6em; }
    }

    .nobori {
        position: absolute; top: 10px; left: -30px;
        display: flex; flex-direction: column; align-items: center;
        z-index: 2; transition: transform 0.3s ease;
    }
    .node-container.unlocked:hover .nobori { transform: translateX(-5px) rotate(-5deg); }
    
    .nobori-flag {
        writing-mode: vertical-rl; font-family: 'Yuji Syuku', serif;
        background: var(--urushi-red); color: var(--gold);
        padding: 8px 4px 5px 4px; border: 2px solid var(--ink);
        font-size: 0.85em; border-bottom: none;
        letter-spacing: 2px;
        min-height: 60px;
    }
    .nobori-pole { width: 4px; height: 90px; background: var(--ink); margin-top: -2px; }
    .clan-crest {
        position: absolute; top: -15px; background: var(--gold); color: var(--ink);
        width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--ink);
        display: flex; justify-content: center; align-items: center; font-size: 1.2em;
    }

    .clear-flag {
        position: absolute; top: -20px; right: -20px; font-size: 2.5em; color: var(--gold);
        display: none; text-shadow: 2px 2px 0 #000; animation: wave 2s infinite ease-in-out; z-index: 3;
    }
    .node-container.cleared .clear-flag { display: block; }
    .node-container.cleared .node-img { color: var(--urushi-red); }
    .node-container.cleared .nobori-flag { background: var(--indigo); }

    .node-label {
        background: rgba(33, 33, 33, 0.95); color: #fff;
        padding: 5px 12px; border-radius: 4px;
        margin-top: -15px; 
        text-align: center;
        border: 2px solid var(--gold);
        font-size: 0.9em; white-space: nowrap;
        z-index: 100; /* ラベルを最前面に */
    }
    .node-sub { font-size: 0.7em; color: #ccc; display: block; margin-top: 2px;}

    @keyframes wave { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }

    /* --- アバター --- */
    #hero-avatar {
        position: absolute; width: 60px; height: 80px; 
        z-index: 150; /* Z-indexを強化 */
        pointer-events: none; 
        transition: all 1s ease-in-out;
        transform: translate(-50%, -100%); 
        left: 150px; top: 650px;
    }

    .avatar-parts { position: absolute; }
    .pawa-head { width: 50px; height: 45px; background: #fdd835; border-radius: 50%; top: 0; left: 5px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2); z-index: 10; }
    .pawa-body { width: 40px; height: 35px; background: #1a237e; border-radius: 20px 20px 10px 10px; top: 35px; left: 10px; z-index: 5; }
    .pawa-arm { width: 15px; height: 25px; background: #fdd835; border-radius: 10px; top: 38px; z-index: 6; }
    .pawa-arm.left { left: -5px; transform: rotate(20deg); }
    .pawa-arm.right { right: -5px; transform: rotate(-20deg); }
    .pawa-leg { width: 18px; height: 25px; background: #5d4037; border-radius: 10px; top: 60px; z-index: 4; }
    .pawa-leg.left { left: 5px; }
    .pawa-leg.right { right: 5px; }

    /* 装備CSS */
    .helm-part { position: absolute; z-index: 11; pointer-events: none; display: none; }
    .helm-1 { width: 60px; height: 30px; background: #8d6e63; border-radius: 50% 50% 10% 10%; top: -5px; left: 0; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.3); }
    .helm-2 { width: 54px; height: 40px; background: #d32f2f; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-2::before { content: ''; position: absolute; top: -15px; left: 10px; width: 34px; height: 20px; background: #ffd700; clip-path: polygon(0 100%, 50% 0, 100% 100%, 50% 80%); }
    .helm-3 { width: 54px; height: 40px; background: #212121; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-3::before { content: ''; position: absolute; top: -25px; left: 5px; width: 44px; height: 25px; background: #ffd700; border-radius: 50%; box-shadow: inset -5px -5px 0 #212121; }
    .helm-nobu { width: 54px; height: 45px; background: #212121; border-radius: 20% 20% 10% 10%; top: -15px; left: 3px; }
    .helm-nobu::before { content: ''; position: absolute; top: -10px; left: 0; width: 54px; height: 20px; background: #ffd700; clip-path: polygon(0 0, 20% 100%, 80% 100%, 100% 0, 50% 30%); }
    .helm-hide { width: 54px; height: 40px; background: #ffca28; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-hide::before { content: ''; position: absolute; top: -30px; left: -10px; width: 74px; height: 74px; background: #ffca28; border-radius: 50%; z-index: -1; opacity: 0.5; }
    .helm-ninja { width: 54px; height: 50px; background: #424242; border-radius: 50% 50% 10% 10%; top: -5px; left: 3px; }
    .helm-ninja::after { content: ''; position: absolute; top: 20px; left: 10px; width: 34px; height: 10px; background: #fdd835; }

    .armor-part { position: absolute; z-index: 5; pointer-events: none; display: none; }
    .armor-1 { background: #d7ccc8; } 
    .armor-2 { background: #1a237e; border: 2px solid #ffd700; } 
    .armor-nobu { background: #b71c1c; } 
    .armor-nobu::after { content: ''; position: absolute; top: 0; left: -10px; width: 60px; height: 50px; background: #b71c1c; border-radius: 10px; z-index: -1; transform: rotate(-5deg); }
    .armor-ninja { background: #000000; } 

    .weapon-part { position: absolute; z-index: 7; pointer-events: none; display: none; }
    .weapon-katana { width: 8px; height: 50px; background: #cfd8dc; border-radius: 4px; top: 25px; right: -15px; transform: rotate(45deg); border: 1px solid #546e7a; }
    .weapon-katana::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 8px; height: 15px; background: #3e2723; }
    .weapon-2 { background: #cfd8dc; }
    .weapon-3 { background: #d50000; box-shadow: 0 0 10px #d50000; }
    .weapon-gun { width: 10px; height: 40px; background: #5d4037; border-radius: 2px; top: 30px; right: -15px; transform: rotate(30deg); }
    .weapon-gun::before { content: ''; position: absolute; top: 0; left: 2px; width: 6px; height: 30px; background: #8d6e63; }
    .weapon-fan { width: 30px; height: 30px; background: #fbc02d; border-radius: 50% 50% 5px 5px; top: 30px; right: -20px; transform: rotate(20deg); }
    .weapon-fan::after { content: ''; position: absolute; bottom: -15px; left: 12px; width: 6px; height: 20px; background: #3e2723; }
    .weapon-shuri { width: 20px; height: 20px; background: #757575; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); top: 35px; right: -15px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- 蔵ボタン --- */
    .kura-btn {
        position: fixed; bottom: 20px; right: 20px;
        width: 80px; height: 80px;
        background: var(--urushi-red); color: white;
        border-radius: 50%; border: 4px solid var(--gold);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        font-size: 2em; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 150;
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        background-blend-mode: multiply;
        transition: transform 0.1s;
    }
    .kura-btn:active { transform: scale(0.95); }
    .kura-label { font-size: 0.5em; font-weight: bold; margin-top: -5px; color: var(--gold); text-shadow: 1px 1px 0 #000; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .kura-box {
        width: 95%; max-width: 600px; height: 90%;
        background: #fff8e1; border: 8px solid #5d4037;
        border-radius: 10px; padding: 15px;
        display: flex; flex-direction: column;
        position: relative;
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        box-sizing: border-box;
    }
    .item-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 10px; overflow-y: auto; flex-grow: 1; padding: 5px;
        -webkit-overflow-scrolling: touch; 
    }
    .item-slot {
        background: #d7ccc8; border: 3px solid #a1887f;
        aspect-ratio: 1; border-radius: 12px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; position: relative;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .item-slot.equipped { border-color: var(--urushi-red); background: #ffccbc; box-shadow: 0 0 10px var(--urushi-red); }
    .item-slot.equipped::after { content: "装備中"; position: absolute; bottom: 0; font-size: 0.6em; background: var(--urushi-red); color: white; width: 100%; text-align: center; border-radius: 0 0 8px 8px; padding: 2px 0; }
    .item-icon { font-size: 3em; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); }

    @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .kura-btn { bottom: calc(20px + env(safe-area-inset-bottom)); }
    }