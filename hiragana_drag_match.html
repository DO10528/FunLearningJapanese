<script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. データ定義 ---
            // ★修正点：ひらがな(hira)とファイル名(file)を分けて定義します
            const ILLUSTRATION_PATH_PREFIX = 'assets/images/hiragana_words/';
            const ILLUSTRATION_PATH_SUFFIX = '.png'; 

            const gameLevels = [
                { level: 1, words: [ { hira: 'あめ', file: 'ame' }, { hira: 'いぬ', file: 'inu' }, { hira: 'うし', file: 'ushi' }, { hira: 'えび', file: 'ebi' }, { hira: 'おに', file: 'oni' } ] },
                { level: 2, words: [ { hira: 'かに', file: 'kani' }, { hira: 'くるま', file: 'kuruma' }, { hira: 'けむし', file: 'kemushi' }, { hira: 'こま', file: 'koma' } ] },
                { level: 3, words: [ { hira: 'しか', file: 'shika' }, { hira: 'さる', file: 'saru' }, { hira: 'すし', file: 'sushi' }, { hira: 'せみ', file: 'semi' }, { hira: 'そば', file: 'soba' } ] },
                { level: 4, words: [ { hira: 'たこ', file: 'tako' }, { hira: 'つき', file: 'tsuki' }, { hira: 'てれび', file: 'terebi' }, { hira: 'とり', file: 'tori' } ] },
                { level: 5, words: [ { hira: 'なす', file: 'nasu' }, { hira: 'にほん', file: 'nihon' }, { hira: 'ぬの', file: 'nuno' }, { hira: 'ねこ', file: 'neko' }, { hira: 'のり', file: 'nori' } ] },
                { level: 6, words: [ { hira: 'はち', file: 'hachi' }, { hira: 'はし', file: 'hashi' }, { hira: 'ひと', file: 'hito' }, { hira: 'ふく', file: 'fuku' }, { hira: 'へび', file: 'hebi' }, { hira: 'ほし', file: 'hoshi' } ] },
                { level: 7, words: [ { hira: 'まくら', file: 'makura' }, { hira: 'みかん', file: 'mikan' }, { hira: 'むぎ', file: 'mugi' }, { hira: 'めだか', file: 'medaka' }, { hira: 'もも', file: 'momo' } ] },
                { level: 8, words: [ { hira: 'らくだ', file: 'rakuda' }, { hira: 'りんご', file: 'ringo' }, { hira: 'るんば', file: 'rumba' }, { hira: 'れもん', file: 'remon' }, { hira: 'ろば', file: 'roba' } ] },
                { level: 9, words: [ { hira: 'やぎ', file: 'yagi' }, { hira: 'ゆかた', file: 'yukata' }, { hira: 'ようかい', file: 'youkai' } ] },
                { level: 10, words: [ { hira: 'わに', file: 'wani' }, { hira: 'かばん', file: 'kaban' } ] }
            ];

            // --- 2. HTML要素の取得 ---
            const levelSelectionEl = document.getElementById('dm-level-selection');
            const levelTitleEl = document.getElementById('dm-level-title');
            const gameAreaEl = document.getElementById('dm-game-area');
            const illustPoolEl = document.getElementById('dm-illust-pool');
            const wordListEl = document.getElementById('dm-word-list');
            const feedbackEl = document.getElementById('dm-feedback');

            let currentLevelWords = [];
            let correctMatches = 0;

            // --- 3. ゲーム初期化 ---
            function initGame() {
                // レベルボタンを生成
                gameLevels.forEach(levelData => {
                    const button = document.createElement('button');
                    button.textContent = `レベル ${levelData.level}`;
                    button.onclick = () => loadLevel(levelData);
                    levelSelectionEl.appendChild(button);
                });
            }

            // --- 4. レベル読み込み ---
            function loadLevel(levelData) {
                currentLevelWords = levelData.words;
                correctMatches = 0;

                levelTitleEl.textContent = `レベル ${levelData.level} スタート！`;
                feedbackEl.textContent = '';
                feedbackEl.classList.remove('success');
                gameAreaEl.style.display = 'flex';

                // エリアをリセット
                illustPoolEl.innerHTML = '';
                wordListEl.innerHTML = '';

                // 配列をシャッフルしてランダムに表示する
                const shuffledWords = shuffleArray([...currentLevelWords]);
                const shuffledIllusts = shuffleArray([...currentLevelWords]);

                // 4-1. 単語リスト（ドロップ先）を生成
                shuffledWords.forEach(wordData => {
                    const row = document.createElement('div');
                    row.className = 'dm-word-row';

                    const dropTarget = document.createElement('div');
                    dropTarget.className = 'dm-drop-target';
                    dropTarget.dataset.word = wordData.hira; 

                    const label = document.createElement('span');
                    label.className = 'dm-word-label';
                    label.textContent = wordData.hira;

                    row.appendChild(dropTarget);
                    row.appendChild(label);
                    wordListEl.appendChild(row);
                });

                // 4-2. イラストリスト（ドラッグアイテム）を生成
                shuffledIllusts.forEach(wordData => {
                    const item = document.createElement('div');
                    item.className = 'dm-drag-item';
                    item.draggable = true;
                    item.dataset.word = wordData.hira;

                    const img = document.createElement('img');
                    img.src = `${ILLUSTRATION_PATH_PREFIX}${wordData.file}${ILLUSTRATION_PATH_SUFFIX}`;
                    img.alt = wordData.hira;
                    
                    // ★★★ バグ修正点 ★★★
                    // ドラッグ操作を妨害しないよう、画像自体はドラッグ不可にする
                    img.draggable = false; 

                    item.appendChild(img);
                    illustPoolEl.appendChild(item);
                });

                // 4-3. イベントリスナーを設定
                addDragDropListeners();
            }

            // --- 5. ドラッグ＆ドロップのイベントリスナー設定 ---
            function addDragDropListeners() {
                const dragItems = document.querySelectorAll('.dm-drag-item');
                const dropTargets = document.querySelectorAll('.dm-drop-target');

                // ドラッグするアイテム側の設定
                dragItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        if (item.classList.contains('matched')) {
                            e.preventDefault();
                            return;
                        }
                        e.dataTransfer.setData('text/plain', item.dataset.word);
                        setTimeout(() => item.style.opacity = '0.5', 0);
                    });

                    item.addEventListener('dragend', (e) => {
                        item.style.opacity = '1';
                    });
                });

                // ドロップ先エリア側の設定
                dropTargets.forEach(target => {
                    target.addEventListener('dragover', (e) => {
                        if (target.classList.contains('correct')) {
                            return;
                        }
                        e.preventDefault();
                        target.classList.add('drag-over');
                    });

                    target.addEventListener('dragleave', () => {
                        target.classList.remove('drag-over');
                    });

                    target.addEventListener('drop', (e) => {
                        e.preventDefault();
                        target.classList.remove('drag-over');

                        if (target.classList.contains('correct')) {
                            return;
                        }

                        const droppedWord = e.dataTransfer.getData('text/plain');
                        const targetWord = target.dataset.word;

                        // 答えチェック
                        checkMatch(droppedWord, targetWord, target);
                    });
                });
            }

            // --- 6. 答えのチェック ---
            function checkMatch(droppedWord, targetWord, targetElement) {
                if (droppedWord === targetWord) {
                    // --- 正解 ---
                    feedbackEl.textContent = 'せいかい！';
                    feedbackEl.classList.add('success');
                    
                    targetElement.classList.add('correct');
                    targetElement.innerHTML = ''; 
                    
                    const matchingDragItem = document.querySelector(`.dm-drag-item[data-word="${droppedWord}"]`);
                    if (matchingDragItem) {
                        matchingDragItem.classList.add('matched');
                        matchingDragItem.draggable = false;
                        targetElement.appendChild(matchingDragItem);
                    }
                    
                    correctMatches++;
                    checkLevelComplete();

                } else {
                    // --- 不正解 ---
                    feedbackEl.textContent = 'ちがうよ、もういちど！';
                    feedbackEl.classList.remove('success');
                }
            }

            // --- 7. レベルクリアのチェック ---
            function checkLevelComplete() {
                if (correctMatches === currentLevelWords.length) {
                    levelTitleEl.textContent = `レベルクリア！おめでとう！`;
                    feedbackEl.textContent = 'すべて かんぺき！';
                    feedbackEl.classList.add('success');
                }
            }

            // --- 8. ユーティリティ (配列シャッフル) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- 9. ゲーム開始 ---
            initGame();

        });
    </script>