<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ひらがな単語あわせゲーム</title>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        #dm-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            border: 3px solid #5c7aff;
        }

        #dm-container h1, #dm-container h2 {
            text-align: center;
            color: #5c7aff;
        }

        /* --- レベル選択 --- */
        #dm-level-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        #dm-level-selection button {
            padding: 10px 15px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            background-color: #5c7aff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #dm-level-selection button:hover {
            background-color: #4a65d1;
        }

        /* --- ゲームエリア --- */
        #dm-game-area {
            display: flex;
            flex-direction: column; /* スマホ用に縦並びをデフォルトに */
            gap: 20px;
        }

        #dm-illust-area, #dm-word-area {
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border: 2px dashed #ccc;
            min-height: 150px;
        }

        #dm-illust-area h3, #dm-word-area h3 {
            text-align: center;
            margin-top: 0;
            color: #555;
        }

        /* --- イラスト（ドラッグアイテム） --- */
        .dm-drag-item {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab;
            margin: 5px;
            display: inline-flex; /* 中央揃えのため */
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dm-drag-item:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .dm-drag-item img {
            width: 90%;
            height: 90%;
            object-fit: contain;
        }

        /* --- 単語（ドロップ先） --- */
        .dm-word-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 5px;
        }

        .dm-drop-target {
            width: 100px;
            height: 100px;
            border: 2px dashed #aaa;
            border-radius: 8px;
            background-color: #f0f8ff;
            margin-right: 15px;
            transition: background-color 0.2s, border-color 0.2s;
            /* ★改善点：中身を中央に配置 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dm-word-label {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        
        /* --- ドラッグ＆ドロップの視覚フィードバック --- */
        .dm-drop-target.drag-over {
            background-color: #e6f7ff;
            border-color: #5c7aff;
            border-style: solid;
        }
        
        /* ★改善点：正解のスタイルを調整 */
        .dm-drop-target.correct {
            border: 3px solid #28a745; /* 緑色 */
            background-color: #e6ffed;
            padding: 0; /* パディングを0にして... */
        }
        
        /* ★改善点：ドロップされたアイテムをマスにピッタリはめる */
        .dm-drop-target.correct .dm-drag-item {
            width: 100%;       /* 幅を100%に */
            height: 100%;      /* 高さを100%に */
            margin: 0;         /* マージンをリセット */
            box-shadow: none;  /* 影を消す */
            border: none;      /* 枠線を消す */
            opacity: 1 !important; /* 透明度を完全に戻す */
            cursor: not-allowed;
        }

        #dm-feedback {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 20px;
            min-height: 1.3em;
            color: #d9534f;
        }
        
        #dm-feedback.success {
            color: #28a745;
        }

        /* --- ボタンエリア --- */
        .dm-button-area {
            text-align: center;
            margin-top: 25px;
        }

        /* --- ホームに戻るボタン・リセットボタン --- */
        .dm-button {
            display: inline-block;
            margin: 0 5px;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dm-button-home {
            background-color: #6c757d; /* グレー */
        }
        .dm-button-home:hover {
            background-color: #5a6268;
        }
        
        .dm-button-reset {
            background-color: #ffc107; /* 黄色 */
            color: #333;
        }
        .dm-button-reset:hover {
            background-color: #e0a800;
        }


        /* --- 
          中サイズ以上の画面 (タブレット, PC) 
          イラストと単語を横並びにする 
        --- */
        @media (min-width: 600px) {
            #dm-game-area {
                flex-direction: row; /* 横並びにする */
            }
            #dm-illust-area {
                width: 40%;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-content: flex-start;
            }
            #dm-word-area {
                width: 60%;
            }
        }

    </style>
</head>
<body>

    <div id="dm-container">
        <h1>ひらがな単語あわせゲーム</h1>
        
        <div id="dm-level-selection">
            </div>

        <h2 id="dm-level-title"></h2>
        
        <div id="dm-game-area" style="display: none;">
            <div id="dm-illust-area">
                <h3>イラスト (ドラッグしてね)</h3>
                <div id="dm-illust-pool">
                    </div>
            </div>
            
            <div id="dm-word-area">
                <h3>ことば (ドロップするばしょ)</h3>
                <div id="dm-word-list">
                    </div>
            </div>
        </div>

        <div id="dm-feedback"></div>

        <div class="dm-button-area">
            <button id="dm-reset-placed-button" class="dm-button dm-button-reset" style="display: none;">
                イラストをもどす
            </button>
            <a href="index.html" class="dm-button dm-button-home">ホームにもどる</a>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. データ定義 ---
            // (かなのファイル名、ルートパス、両方に対応済み)
            const ILLUSTRATION_PATH_PREFIX = '/assets/images/hiragana_words/';
            const ILLUSTRATION_PATH_SUFFIX = '.png'; 

            const gameLevels = [
                { level: 1, words: [ { hira: 'あめ', file: 'あめ' }, { hira: 'いぬ', file: 'いぬ' }, { hira: 'うし', file: 'うし' }, { hira: 'えび', file: 'えび' }, { hira: 'おに', file: 'おに' } ] },
                { level: 2, words: [ { hira: 'かに', file: 'かに' }, { hira: 'き', file: 'き' },{ hira: 'くるま', file: 'くるま' }, { hira: 'けむし', file: 'けむし' }, { hira: 'こま', file: 'こま' } ] },
                { level: 3, words: [ { hira: 'しか', file: 'しか' }, { hira: 'さる', file: 'さる' }, { hira: 'すし', file: 'すし' }, { hira: 'せみ', file: 'せみ' }, { hira: 'そば', file: 'そば' } ] },
                { level: 4, words: [ { hira: 'たこ', file: 'たこ' }, { hira: 'はち', file: 'はち' },{ hira: 'つき', file: 'つき' }, { hira: 'てれび', file: 'てれび' }, { hira: 'とり', file: 'とり' } ] },
                { level: 5, words: [ { hira: 'なす', file: 'なす' }, { hira: 'にほん', file: 'にほん' }, { hira: 'ぬの', file: 'ぬの' }, { hira: 'ねこ', file: 'ねこ' }, { hira: 'のり', file: 'のり' } ] },
                { level: 6, words: [ { hira: 'はし', file: 'はし' }, { hira: 'ひとで', file: 'ひとで' }, { hira: 'ふく', file: 'ふく' }, { hira: 'へび', file: 'へび' }, { hira: 'ほし', file: 'ほし' } ] },
                { level: 7, words: [ { hira: 'まくら', file: 'まくら' }, { hira: 'みかん', file: 'みかん' }, { hira: 'むぎ', file: 'むぎ' }, { hira: 'めだか', file: 'めだか' }, { hira: 'もも', file: 'もも' } ] },
                { level: 8, words: [ { hira: 'らくだ', file: 'らくだ' }, { hira: 'りんご', file: 'りんご' }, { hira: 'るんば', file: 'るんば' }, { hira: 'れもん', file: 'れもん' }, { hira: 'ろば', file: 'ろば' } ] },
                { level: 9, words: [ { hira: 'やぎ', file: 'やぎ' }, { hira: 'ゆかた', file: 'ゆかた' }, { hira: 'ようかい', file: 'ようかい' } ] },
                { level: 10, words: [ { hira: 'わに', file: 'わに' }, { hira: 'かばん', file: 'かばん' } ] }
            ];

            // --- 2. HTML要素の取得 ---
            const levelSelectionEl = document.getElementById('dm-level-selection');
            const levelTitleEl = document.getElementById('dm-level-title');
            const gameAreaEl = document.getElementById('dm-game-area');
            const illustPoolEl = document.getElementById('dm-illust-pool');
            const wordListEl = document.getElementById('dm-word-list');
            const feedbackEl = document.getElementById('dm-feedback');
            // ★改善点：リセットボタンを取得
            const resetPlacedButton = document.getElementById('dm-reset-placed-button');

            let currentLevelData = null; // ★改善点：現在のレベル情報を保持
            let currentLevelWords = [];
            let correctMatches = 0;

            // --- 3. ゲーム初期化 ---
            function initGame() {
                // レベルボタンを生成
                gameLevels.forEach(levelData => {
                    const button = document.createElement('button');
                    button.textContent = `レベル ${levelData.level}`;
                    button.onclick = () => loadLevel(levelData);
                    levelSelectionEl.appendChild(button);
                });
            }

            // --- 4. レベル読み込み ---
            function loadLevel(levelData) {
                currentLevelData = levelData; // ★改善点：現在のレベル情報を保存
                currentLevelWords = levelData.words;
                correctMatches = 0;

                levelTitleEl.textContent = `レベル ${levelData.level} スタート！`;
                feedbackEl.textContent = '';
                feedbackEl.classList.remove('success');
                gameAreaEl.style.display = 'flex';
                
                // ★改善点：リセットボタンを表示
                resetPlacedButton.style.display = 'inline-block';
                resetPlacedButton.onclick = resetPlacedItems; // クリックイベントを設定

                // エリアをリセット
                illustPoolEl.innerHTML = '';
                wordListEl.innerHTML = '';

                const shuffledWords = shuffleArray([...currentLevelWords]);
                const shuffledIllusts = shuffleArray([...currentLevelWords]);

                // 4-1. 単語リスト（ドロップ先）を生成
                shuffledWords.forEach(wordData => {
                    const row = document.createElement('div');
                    row.className = 'dm-word-row';

                    const dropTarget = document.createElement('div');
                    dropTarget.className = 'dm-drop-target';
                    dropTarget.dataset.word = wordData.hira; 

                    const label = document.createElement('span');
                    label.className = 'dm-word-label';
                    label.textContent = wordData.hira;

                    row.appendChild(dropTarget);
                    row.appendChild(label);
                    wordListEl.appendChild(row);
                });

                // 4-2. イラストリスト（ドラッグアイテム）を生成
                shuffledIllusts.forEach(wordData => {
                    const item = document.createElement('div');
                    item.className = 'dm-drag-item';
                    item.draggable = true;
                    item.dataset.word = wordData.hira;

                    const img = document.createElement('img');
                    img.src = `${ILLUSTRATION_PATH_PREFIX}${wordData.file}${ILLUSTRATION_PATH_SUFFIX}`;
                    img.alt = wordData.hira;
                    
                    // (前回のバグ修正)
                    img.draggable = false; 

                    item.appendChild(img);
                    illustPoolEl.appendChild(item);
                });

                // 4-3. イベントリスナーを設定
                addDragDropListeners();
            }
            
            // ★改善点：置いたイラストを元に戻す関数
            function resetPlacedItems() {
                // 1. マッチしたアイテムをすべて探す
                const matchedItems = document.querySelectorAll('.dm-drag-item');
                // 2. 正解したドロップ先をすべて探す
                const correctDropZones = document.querySelectorAll('.dm-drop-target.correct');

                matchedItems.forEach(item => {
                    // ドロップ先(correct)に入っているアイテムだけを元に戻す
                    if (item.parentElement.classList.contains('dm-drop-target')) {
                        item.draggable = true;
                        illustPoolEl.appendChild(item); // イラストプールに戻す
                    }
                });

                // 3. ドロップ先の状態をリセット
                correctDropZones.forEach(zone => {
                    zone.classList.remove('correct');
                    zone.innerHTML = ''; // 中身を空にする
                });
                
                // 4. カウンターとフィードバックをリセット
                correctMatches = 0;
                feedbackEl.textContent = 'イラストをもどしました。';
                feedbackEl.classList.remove('success');
            }


            // --- 5. ドラッグ＆ドロップのイベントリスナー設定 ---
            // (前回のバグ修正済み)
            function addDragDropListeners() {
                const dragItems = document.querySelectorAll('.dm-drag-item');
                const dropTargets = document.querySelectorAll('.dm-drop-target');

                dragItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        if (!item.draggable) { // draggable=false で判定
                            e.preventDefault();
                            return;
                        }
                        e.dataTransfer.setData('text/plain', item.dataset.word);
                        setTimeout(() => item.style.opacity = '0.5', 0);
                    });

                    item.addEventListener('dragend', (e) => {
                        item.style.opacity = '1';
                    });
                });

                dropTargets.forEach(target => {
                    target.addEventListener('dragover', (e) => {
                        if (target.classList.contains('correct')) {
                            return;
                        }
                        e.preventDefault();
                        target.classList.add('drag-over');
                    });

                    target.addEventListener('dragleave', () => {
                        target.classList.remove('drag-over');
                    });

                    target.addEventListener('drop', (e) => {
                        e.preventDefault();
                        target.classList.remove('drag-over');

                        if (target.classList.contains('correct')) {
                            return;
                        }

                        const droppedWord = e.dataTransfer.getData('text/plain');
                        const targetWord = target.dataset.word;

                        checkMatch(droppedWord, targetWord, target);
                    });
                });
            }

            // --- 6. 答えのチェック ---
            function checkMatch(droppedWord, targetWord, targetElement) {
                if (droppedWord === targetWord) {
                    // --- 正解 ---
                    feedbackEl.textContent = 'せいかい！';
                    feedbackEl.classList.add('success');
                    
                    targetElement.classList.add('correct');
                    targetElement.innerHTML = ''; 
                    
                    const matchingDragItem = document.querySelector(`.dm-drag-item[data-word="${droppedWord}"]`);
                    if (matchingDragItem) {
                        // ★改善点： 'matched' クラスは不要
                        matchingDragItem.draggable = false;
                        targetElement.appendChild(matchingDragItem);
                    }
                    
                    correctMatches++;
                    checkLevelComplete(); // ★改善点：毎回レベルクリアかチェック

                } else {
                    // --- 不正解 ---
                    feedbackEl.textContent = 'ちがうよ、もういちど！';
                    feedbackEl.classList.remove('success');
                    
                    // 「1問でも間違えていれば合うまでする」
                    // → アイテムを戻さないので、これでOK
                }
            }

            // --- 7. レベルクリアのチェック ---
            // ★改善点：自動で次のレベルに進むロジック
            function checkLevelComplete() {
                if (correctMatches !== currentLevelWords.length) {
                    return; // まだ全部正解していない
                }

                // 全問正解！
                feedbackEl.textContent = 'レベルクリア！';
                feedbackEl.classList.add('success');
                resetPlacedButton.style.display = 'none'; // リセットボタンを隠す

                // 次のレベルを探す
                const currentLevelIndex = gameLevels.findIndex(level => level.level === currentLevelData.level);
                const nextLevelIndex = currentLevelIndex + 1;

                if (nextLevelIndex < gameLevels.length) {
                    // 次のレベルがある
                    const nextLevelData = gameLevels[nextLevelIndex];
                    levelTitleEl.textContent = `レベルクリア！ ${nextLevelData.level} にすすむよ！`;
                    
                    // 2秒待ってから次のレベルを読み込む
                    setTimeout(() => {
                        loadLevel(nextLevelData);
                    }, 2000);

                } else {
                    // 最終レベルをクリア
                    levelTitleEl.textContent = 'ぜんぶクリア！';
                    feedbackEl.textContent = '全レベル おめでとうございます！';
                }
            }

            // --- 8. ユーティリティ (配列シャッフル) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- 9. ゲーム開始 ---
            initGame();

        });
    </script>

</body>
</html>