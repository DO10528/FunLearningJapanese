<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ひらがな単語あわせゲーム</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        /* (スタイルは変更なしのため省略) */
        
        body {
            font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #f0f8ff 0%, #cce7ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        /* IDとクラス名を km- から hg- に変更 */
        #hg-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 30px; 
            background-color: #ffffff;
            box-shadow: 0 8px 24px rgba(0, 91, 179, 0.15); 
            border-radius: 20px; 
            border: none; 
        }

        #hg-container h1 {
            text-align: center;
            color: #005bb5;
            font-weight: 800; 
            font-size: 2.5em; 
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
        }
        
        #hg-container h2 {
            text-align: center;
            color: #5c7aff;
        }

        /* --- レベル選択 --- */
        #hg-level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        /* レベルボタン */
        #hg-level-selection button {
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 5px solid rgba(0,0,0,0.15);
        }
        #hg-level-selection button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        #hg-level-selection button:active {
            transform: scale(1.0) translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        #hg-level-selection button:nth-child(5n+1) { background-color: #ff6b6b; } /* 赤 */
        #hg-level-selection button:nth-child(5n+2) { background-color: #feca57; } /* 黄 */
        #hg-level-selection button:nth-child(5n+3) { background-color: #48dbfb; } /* 水色 */
        #hg-level-selection button:nth-child(5n+4) { background-color: #1dd1a1; } /* 緑 */
        #hg-level-selection button:nth-child(5n+5) { background-color: #ff9f43; } /* オレンジ */
        
        /* --- ゲームエリア (縦一列デザイン) --- */
        #hg-game-area {
            display: flex;
            flex-direction: row; 
            gap: 20px;
        }
        #hg-illust-area, #hg-word-area {
            padding: 15px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
            border: 2px dashed #ccc; 
            min-height: 150px;
        }
        #hg-illust-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #hg-word-area {
            flex: 1;
        }
        #hg-illust-pool {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        #hg-illust-area h3, #hg-word-area h3 {
            text-align: center; 
            margin-top: 0; 
            color: #555;
            width: 100%;
        }
        .hg-drag-item {
            width: 100px; height: 100px; background-color: #fff;
            border: 2px solid #ddd; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab; margin: 5px; display: inline-flex;
            justify-content: center; align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;

            /* ▼▼▼ スマホ・タブレット対応のために以下を追加 ▼▼▼ */
            /* (1) スクロールやズームと競合するのを防ぎ、遅延をなくす */
            touch-action: none;
            /* (2) iOSで長押しした際のメニューを無効化 */
            -webkit-touch-callout: none;
            /* (3) テキストや画像を選択しようとする動作を無効化 */
            user-select: none;
            -webkit-user-select: none;
        }
        .hg-drag-item:active {
            cursor: grabbing; transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .hg-drag-item img {
            width: 90%; height: 90%; object-fit: contain;
        }
        .hg-word-row {
            display: flex; align-items: center; margin-bottom: 10px;
            background-color: #fff; border-radius: 8px;
            border: 1px solid #ccc; padding: 5px;
        }
        .hg-drop-target {
            width: 100px; height: 100px; border: 2px dashed #aaa;
            border-radius: 8px; background-color: #f0f8ff;
            margin-right: 15px; transition: background-color 0.2s, border-color 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .hg-word-label {
            font-size: 1.8em; font-weight: bold; color: #333;
        }
        .hg-drop-target.drag-over {
            background-color: #e6f7ff; border-color: #5c7aff; border-style: solid;
        }
        
        .hg-drop-target.correct {
            border: 3px solid #28a745; background-color: #e6ffed; padding: 0;
        }
        
        /* 配置されたアイテムのスタイル (正解時) */
        .hg-drop-target.correct .hg-drag-item {
            width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; cursor: not-allowed;
        }
        
        /* 配置されたアイテムのスタイル (未判定時) */
        .hg-drop-target .hg-drag-item {
             width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; 
            cursor: pointer; 
        }
        /* ドラッグ中のアイテムはクリックできないようにする */
        .hg-drag-item:active {
            cursor: grabbing;
        }

        #hg-feedback {
            text-align: center; font-size: 1.3em; font-weight: bold;
            margin-top: 20px; min-height: 1.3em; color: #d9534f;
        }
        #hg-feedback.success { color: #28a745; }

        /* --- ボタンエリア --- */
        .hg-button-area {
            text-align: center;
            margin-top: 25px;
        }
        .hg-button {
            display: inline-block;
            margin: 0 5px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 4px solid rgba(0,0,0,0.15);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .hg-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .hg-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        .hg-button-home {
            background-color: #6c757d;
            border-bottom-color: #4a4e52;
        }
        .hg-button-reset {
            background-color: #ffc107;
            color: #333;
            border-bottom-color: #c69500;
        }

        /* --- スマホ用の調整 --- */
        @media (max-width: 600px) {
            #hg-container {
                padding: 15px;
            }
            #hg-container h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            #hg-level-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            #hg-level-selection button {
                font-size: 1.2em;
                padding: 15px;
            }
            #hg-game-area {
                flex-direction: row; 
                gap: 10px;
            }
            #hg-illust-area, #hg-word-area {
                padding: 5px; 
                min-height: 100px; 
            }
            #hg-illust-area h3, #hg-word-area h3 {
                font-size: 0.8em; 
                margin-bottom: 5px;
            }
            .hg-drag-item {
                width: 60px; height: 60px; margin: 2px;
            }
            .hg-drop-target {
                width: 60px; height: 60px; margin-right: 5px;
            }
            .hg-word-label {
                font-size: 1.0em; 
            }
            .hg-button {
                padding: 10px 15px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div id="hg-container">
        <h1 id="hg-main-title">ひらがな単語あわせゲーム</h1>
        
        <div id="hg-level-selection">
            </div>

        <h2 id="hg-level-title"></h2>
        
        <div id="hg-game-area" style="display: none;">
            <div id="hg-illust-area">
                <h3>イラスト (ドラッグしてね)</h3>
                <div id="hg-illust-pool">
                    </div>
            </div>
            
            <div id="hg-word-area">
                <h3>ことば (ドロップするばしょ)</h3>
                <div id="hg-word-list">
                    </div>
            </div>
        </div>

        <div id="hg-feedback"></div>

        <div class="hg-button-area">
            <button id="hg-reset-placed-button" class="hg-button hg-button-reset" style="display: none;">
                イラストをもどす
            </button>
            <button id="hg-home-button" class="hg-button hg-button-home">ホームにもどる</button>
        </div>
    </div>

    <audio id="hg-sound-correct" src="assets/sounds/seikai.mp3" preload="auto"></audio>
    <audio id="hg-sound-incorrect" src="assets/sounds/bubu.mp3" preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. データ定義 ---
            
            // ★★★ ひらがな用のパスに変更 ★★★
            const ILLUSTRATION_PATH_PREFIX = 'assets/images/hiragana_words/';
            const ILLUSTRATION_PATH_SUFFIX = '.png'; 

            // ★★★ ひらがな用のデータに変更 ★★★
            const gameLevels = [
                { level: 1, words: [ { hira: 'あめ', file: 'あめ' }, { hira: 'いぬ', file: 'いぬ' }, { hira: 'うし', file: 'うし' }, { hira: 'えび', file: 'えび' }, { hira: 'おに', file: 'おに' } ] },
                { level: 2, words: [ { hira: 'かに', file: 'かに' }, { hira: 'き', file: 'き' },{ hira: 'くるま', file: 'くるま' }, { hira: 'けむし', file: 'けむし' }, { hira: 'こま', file: 'こま' } ] },
                { level: 3, words: [ { hira: 'さる', file: 'さる' }, { hira: 'しか', file: 'しか' }, { hira: 'すし', file: 'すし' }, { hira: 'せみ', file: 'せみ' }, { hira: 'そば', file: 'そば' } ] },
                { level: 4, words: [ { hira: 'たこ', file: 'たこ' }, { hira: 'はち', file: 'はち' },{ hira: 'つき', file: 'つき' }, { hira: 'てれび', file: 'てれび' }, { hira: 'とり', file: 'とり' } ] },
                { level: 5, words: [ { hira: 'なす', file: 'なす' }, { hira: 'にほん', file: 'にほん' }, { hira: 'ぬの', file: 'ぬの' }, { hira: 'ねこ', file: 'ねこ' }, { hira: 'のり', file: 'のり' } ] },
                { level: 6, words: [ { hira: 'はし', file: 'はし' }, { hira: 'ひとで', file: 'ひとで' }, { hira: 'ふく', file: 'ふく' }, { hira: 'へび', file: 'へび' }, { hira: 'ほし', file: 'ほし' } ] },
                { level: 7, words: [ { hira: 'まくら', file: 'まくら' }, { hira: 'みかん', file: 'みかん' }, { hira: 'むぎ', file: 'むぎ' }, { hira: 'めだか', file: 'めだか' }, { hira: 'もも', file: 'もも' } ] },
                { level: 8, words: [ { hira: 'らくだ', file: 'らくだ' }, { hira: 'りんご', file: 'りんご' }, { hira: 'るんば', file: 'るんば' }, { hira: 'れもん', file: 'れもん' }, { hira: 'ろば', file: 'ろば' } ] },
                { level: 9, words: [ { hira: 'やぎ', file: 'やぎ' }, { hira: 'ゆかた', file: 'ゆかた' }, { hira: 'ようかい', file: 'ようかい' } ] },
                { level: 10, words: [ { hira: 'わに', file: 'わに' }, { hira: 'かばん', file: 'かばん' } ] }
            ];

            // --- 2. HTML要素の取得 (IDを hg- に変更) ---
            const mainTitleEl = document.getElementById('hg-main-title'); 
            const levelSelectionEl = document.getElementById('hg-level-selection');
            const levelTitleEl = document.getElementById('hg-level-title');
            const gameAreaEl = document.getElementById('hg-game-area');
            const illustPoolEl = document.getElementById('hg-illust-pool');
            const wordListEl = document.getElementById('hg-word-list');
            const feedbackEl = document.getElementById('hg-feedback');
            const resetPlacedButton = document.getElementById('hg-reset-placed-button');
            const homeButton = document.getElementById('hg-home-button'); 

            const soundCorrect = document.getElementById('hg-sound-correct');
            const soundIncorrect = document.getElementById('hg-sound-incorrect');


            let currentLevelData = null; 
            let currentLevelWords = [];

            // --- 3. ゲーム初期化 ---
            function initGame() {
                gameLevels.forEach(levelData => {
                    const button = document.createElement('button');
                    button.textContent = `レベル ${levelData.level}`;
                    button.onclick = () => loadLevel(levelData);
                    levelSelectionEl.appendChild(button);
                });
                
                homeButton.onclick = () => {
                    window.location.href = 'index.html'; 
                };
            }
            
            function showLevelSelect() {
                gameAreaEl.style.display = 'none';
                levelTitleEl.textContent = '';
                feedbackEl.textContent = '';
                resetPlacedButton.style.display = 'none';
                
                levelSelectionEl.style.display = 'grid'; 
                mainTitleEl.style.display = 'block';

                homeButton.onclick = () => {
                    window.location.href = 'index.html';
                };
            }

            // --- 4. レベル読み込み ---
            function loadLevel(levelData) {
                levelSelectionEl.style.display = 'none';
                mainTitleEl.style.display = 'none';
                
                currentLevelData = levelData; 
                currentLevelWords = levelData.words;

                levelTitleEl.textContent = `レベル ${levelData.level} スタート！`;
                feedbackEl.textContent = '';
                feedbackEl.classList.remove('success');
                gameAreaEl.style.display = 'flex';
                
                resetPlacedButton.style.display = 'none'; // ロジック上、まだ非表示

                homeButton.onclick = () => showLevelSelect();

                illustPoolEl.innerHTML = '';
                wordListEl.innerHTML = '';

                const shuffledWords = shuffleArray([...currentLevelWords]);
                const shuffledIllusts = shuffleArray([...currentLevelWords]);

                // 4-1. 単語リスト（ドロップ先）を生成
                shuffledWords.forEach(wordData => {
                    const row = document.createElement('div');
                    row.className = 'hg-word-row';
                    const dropTarget = document.createElement('div');
                    dropTarget.className = 'hg-drop-target';
                    dropTarget.dataset.word = wordData.hira; 
                    dropTarget.id = `hg-target-${wordData.hira}`; 
                    
                    const label = document.createElement('span');
                    label.className = 'hg-word-label';
                    label.textContent = wordData.hira;
                    row.appendChild(dropTarget);
                    row.appendChild(label);
                    wordListEl.appendChild(row);
                });

                // 4-2. イラストリスト（ドラッグアイテム）を生成
                shuffledIllusts.forEach(wordData => {
                    const item = document.createElement('div');
                    item.className = 'hg-drag-item';
                    item.draggable = true;
                    item.dataset.word = wordData.hira;
                    item.id = `hg-item-${wordData.hira}`; 
                    item.dataset.initialParentId = 'hg-illust-pool';
                    
                    const img = document.createElement('img');
                    img.src = `${ILLUSTRATION_PATH_PREFIX}${wordData.file}${ILLUSTRATION_PATH_SUFFIX}`;
                    img.alt = wordData.hira;
                    img.draggable = false; 
                    item.appendChild(img);
                    illustPoolEl.appendChild(item);
                });

                // 4-3. イベントリスナーを設定
                addDragDropListeners();
            }
            
            // ★★★ クリックでアイテムをプールに戻す関数 ★★★
            function returnItemToPool(event) {
                const itemToReturn = event.currentTarget; 
                const parentTarget = itemToReturn.parentElement;

                // 1. プールに戻す
                illustPoolEl.appendChild(itemToReturn);
                
                // 2. 再度ドラッグできるようにする
                itemToReturn.draggable = true;
                
                // 3. クリックイベントを削除
                itemToReturn.removeEventListener('click', returnItemToPool);
                
                // 4. 親スロットのスタイルをリセット
                if (parentTarget && parentTarget.classList.contains('hg-drop-target')) {
                    parentTarget.classList.remove('correct'); // correctクラスがあっても削除
                }

                // 5. 判定をリセットし、フィードバックを更新
                feedbackEl.textContent = 'イラストをもどしました。';
                feedbackEl.classList.remove('success');
            }


            // --- 5. ドラッグ＆ドロップのイベントリスナー設定 (★タッチ対応版に差し替え) ---
            function addDragDropListeners() {
                const dragItems = document.querySelectorAll('.hg-drag-item');
                const dropTargets = document.querySelectorAll('.hg-drop-target');
                
                // --- タッチ操作用の変数 ---
                let ghostItem = null;      // 指に追随するゴースト（コピー）
                let currentDragItem = null; // ドラッグ中の元のアイテム
                let lastTouchTarget = null; // 最後に指が乗ったターゲット

                // --- 1. マウス イベント (既存のロジック) ---
                dragItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        if (!item.draggable) { e.preventDefault(); return; }
                        e.dataTransfer.setData('text/plain', item.id);
                        setTimeout(() => item.style.opacity = '0.5', 0);
                    });
                    item.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                    });
                });

                dropTargets.forEach(target => {
                    target.addEventListener('dragover', (e) => {
                        if (target.querySelector('.hg-drag-item')) return;
                        e.preventDefault();
                        target.classList.add('drag-over');
                    });
                    target.addEventListener('dragleave', () => {
                        target.classList.remove('drag-over');
                    });
                    target.addEventListener('drop', (e) => {
                        e.preventDefault();
                        target.classList.remove('drag-over');
                        if (target.querySelector('.hg-drag-item')) return;
                        
                        const dragItemId = e.dataTransfer.getData('text/plain');
                        const dragItem = document.getElementById(dragItemId);

                        if (dragItem) {
                            target.innerHTML = ''; 
                            target.appendChild(dragItem);
                            dragItem.draggable = false; 
                            dragItem.addEventListener('click', returnItemToPool);
                            checkFinalAnswers();
                        }
                    });
                });

                // --- 2. タッチ イベント (★ここからが追加ロジック) ---

                // (A) アイテムを指で押し始めた時 (touchstart)
                dragItems.forEach(item => {
                    item.addEventListener('touchstart', (e) => {
                        if (!item.draggable) return;

                        currentDragItem = item; // 元のアイテムを記憶

                        // (1) ゴースト（指に追随するコピー）を作成
                        ghostItem = item.cloneNode(true);
                        ghostItem.style.position = 'absolute';
                        ghostItem.style.pointerEvents = 'none'; // ゴースト自体がタッチを邪魔しないように
                        ghostItem.style.zIndex = '1000';
                        ghostItem.style.opacity = '0.8';
                        ghostItem.style.transform = 'scale(1.1)'; // 少し大きくして掴んだ感を出す
                        document.body.appendChild(ghostItem);

                        // (2) 元のアイテムを半透明にする
                        item.style.opacity = '0.4';

                        // (3) ゴーストを指の位置に配置
                        updateGhostPosition(e.touches[0]);

                    }, { passive: true }); // passive: true で開始
                });

                // (B) 指を動かした時 (touchmove)
                document.addEventListener('touchmove', (e) => {
                    if (!currentDragItem || !ghostItem) return;

                    // ★重要：ここで preventDefault を呼び、ドラッグ中の画面スクロールを止める
                    e.preventDefault(); 
                    
                    // (1) ゴーストを指の位置に更新
                    updateGhostPosition(e.touches[0]);

                    // (2) 指の下にある要素を特定
                    const touch = e.touches[0];
                    ghostItem.style.display = 'none'; // 一瞬ゴーストを消して、下の要素をチェック
                    const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                    ghostItem.style.display = ''; // すぐに戻す

                    let currentTouchTarget = null;
                    if (elementUnder && elementUnder.classList.contains('hg-drop-target')) {
                        currentTouchTarget = elementUnder;
                    }

                    // (3) ドロップ先のハイライトを更新
                    if (lastTouchTarget && lastTouchTarget !== currentTouchTarget) {
                        lastTouchTarget.classList.remove('drag-over');
                    }
                    if (currentTouchTarget && !currentTouchTarget.querySelector('.hg-drag-item')) {
                        currentTouchTarget.classList.add('drag-over');
                        lastTouchTarget = currentTouchTarget;
                    } else {
                        lastTouchTarget = null;
                    }

                }, { passive: false }); // ★ passive: false で preventDefault を許可

                // (C) 指を離した時 (touchend)
                document.addEventListener('touchend', (e) => {
                    if (!currentDragItem || !ghostItem) return;

                    // (1) 指を離した場所の要素を特定
                    const touch = e.changedTouches[0];
                    ghostItem.style.display = 'none';
                    const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                    ghostItem.style.display = '';

                    let dropTarget = null;
                    if (elementUnder && elementUnder.classList.contains('hg-drop-target')) {
                        dropTarget = elementUnder;
                    }

                    // (2) 有効なドロップ先（＝空のターゲット）か判定
                    if (dropTarget && !dropTarget.querySelector('.hg-drag-item')) {
                        // --- ドロップ成功 ---
                        dropTarget.innerHTML = ''; 
                        dropTarget.appendChild(currentDragItem); // ★元のアイテムを配置
                        currentDragItem.draggable = false;
                        currentDragItem.style.opacity = '1'; // 透明度を戻す
                        
                        // 「クリックで戻る」イベントを追加
                        currentDragItem.addEventListener('click', returnItemToPool);
                        
                        // 答え合わせを実行
                        checkFinalAnswers();
                        
                    } else {
                        // --- ドロップ失敗 (元の場所に戻す) ---
                        currentDragItem.style.opacity = '1'; // 透明度を戻す
                    }
                    
                    // (3) 後片付け
                    document.body.removeChild(ghostItem);
                    ghostItem = null;
                    currentDragItem = null;
                    if (lastTouchTarget) {
                        lastTouchTarget.classList.remove('drag-over');
                    }
                    lastTouchTarget = null;
                });

                // --- タッチ操作用の補助関数 ---
                function updateGhostPosition(touch) {
                    if (!ghostItem) return;
                    // ゴーストが指の中心に来るように調整
                    ghostItem.style.left = (touch.clientX - ghostItem.offsetWidth / 2) + 'px';
                    ghostItem.style.top = (touch.clientY - ghostItem.offsetHeight / 2) + 'px';
                }
            }
            // ▲▲▲ ここまでが addDragDropListeners 関数 ▲▲▲


            // --- 6. (checkMatch() は削除) ---

            // --- 7. 最終判定ロジック ---
            function checkFinalAnswers() {
                const dropTargets = document.querySelectorAll('.hg-drop-target');
                const totalTargets = currentLevelWords.length;
                let filledCount = 0;
                let allCorrect = true;

                // 1. すべてのスロットが埋まっているか確認
                dropTargets.forEach(target => {
                    if (target.querySelector('.hg-drag-item')) {
                        filledCount++;
                    }
                });

                // 2. スロットがすべて埋まっていない場合は終了
                if (filledCount < totalTargets) {
                    feedbackEl.textContent = `あと ${totalTargets - filledCount} こ。`;
                    feedbackEl.classList.remove('success');
                    return; 
                }

                // 3. スロットがすべて埋まった場合 (filledCount === totalTargets)
                //    答え合わせを実行
                dropTargets.forEach(target => {
                    const placedItem = target.querySelector('.hg-drag-item');
                    const targetWord = target.dataset.word;
                    const placedWord = placedItem.dataset.word;
                    
                    if (targetWord !== placedWord) {
                        allCorrect = false; 
                    }
                });

                // 4. 最終判定結果
                if (allCorrect) {
                    // ★ 全問正解
                    soundCorrect.currentTime = 0;
                    soundCorrect.play();
                    
                    dropTargets.forEach(target => {
                         target.classList.add('correct');
                         // 正解確定後、もうクリックで戻せないようにイベント削除
                         const placedItem = target.querySelector('.hg-drag-item');
                         if (placedItem) {
                             placedItem.removeEventListener('click', returnItemToPool);
                             placedItem.style.cursor = 'not-allowed'; 
                         }
                    });
                    
                    levelTitleEl.textContent = 'レベルクリア！';
                    feedbackEl.textContent = 'おめでとうございます！ぜんぶせいかい！';
                    feedbackEl.classList.add('success');
                    resetPlacedButton.style.display = 'none'; 
                    
                    // 次のレベルへ
                    const currentLevelIndex = gameLevels.findIndex(level => level.level === currentLevelData.level);
                    const nextLevelIndex = currentLevelIndex + 1;
                    
                    if (nextLevelIndex < gameLevels.length) {
                        const nextLevelData = gameLevels[nextLevelIndex];
                        levelTitleEl.textContent = `レベルクリア！ ${nextLevelData.level} にすすむよ！`;
                        setTimeout(() => {
                            loadLevel(nextLevelData);
                        }, 2000); 
                    } else {
                        levelTitleEl.textContent = 'ぜんぶクリア！';
                        feedbackEl.textContent = '全レベル おめでとうございます！';
                    }
                    
                } else {
                    // ★ 1つでも間違いがある
                    soundIncorrect.currentTime = 0;
                    soundIncorrect.play();
                    
                    feedbackEl.textContent = 'ちがうところがあるよ。まちがっているイラストをクリックして、もどしてね。';
                    feedbackEl.classList.remove('success');
                    
                    // 「イラストをもどす」ボタンはここでは表示しない
                    // (カタカナ版のロジックでは、個別にクリックして戻すため)
                }
            }

            // --- 8. ユーティリティ (配列シャッフル) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- 9. ゲーム開始 ---
            initGame();

        });
    </script>

</body>
</html>