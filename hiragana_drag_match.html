<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ひらがなゲーム</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<div id="user-info"></div>
<div id="streak-display"></div>
<div id="points-display"></div>

<div id="main-menu" class="locked">
    <!-- ゲーム選択ボタンなど -->
</div>

<div id="auth-modal" class="modal">
    <div id="login-view">
        <input type="text" id="login-gamename" placeholder="ゲーム名">
        <input type="password" id="login-password" placeholder="パスワード">
        <button id="login-submit-btn">ログイン</button>
        <div id="login-message"></div>
    </div>
    <div id="signup-view">
        <input type="text" id="signup-gamename" placeholder="新しいゲーム名">
        <input type="password" id="signup-password" placeholder="パスワード">
        <button id="signup-submit-btn">登録してログイン</button>
        <div id="signup-message"></div>
    </div>
    <button class="btn-close">閉じる</button>
</div>

<button id="login-btn">ログイン</button>
<button id="signup-btn">新規登録</button>
<button id="guest-btn">ゲストでプレイ</button>
<button id="logout-btn">ログアウト</button>

<script>
const GAME_ID = 'hiragana_game'; // ゲームごとのユニークID

// -------------------
// 言語管理 (略: 先ほどの translations を使用)
// -------------------
function updateLanguageUI(lang) {
    const langData = translations[lang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (langData[key]) el.textContent = langData[key];
    });
    document.querySelectorAll('[data-i18n-html]').forEach(el => {
        const key = el.getAttribute('data-i18n-html');
        if (langData[key]) el.innerHTML = langData[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (langData[key]) el.placeholder = langData[key];
    });
    document.getElementById('lang-ja')?.classList.remove('active');
    document.getElementById('lang-en')?.classList.remove('active');
    document.getElementById(`lang-${lang}`)?.classList.add('active');
    updateAuthenticationUI();
}
window.setLanguage = function(lang) {
    if (!translations[lang]) return;
    localStorage.setItem('preferredLang', lang);
    updateLanguageUI(lang);
};

// -------------------
// 認証・ポイント管理
// -------------------
const USER_STORAGE_KEY = 'user_accounts';
const SESSION_STORAGE_KEY = 'current_user';
const GUEST_NAME = 'ゲスト';
const LANG_DEFAULT = 'ja';

function getUsers() {
    const usersJson = localStorage.getItem(USER_STORAGE_KEY);
    return usersJson ? JSON.parse(usersJson) : {};
}
function saveUsers(users) {
    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
}
function getCurrentLang() {
    return localStorage.getItem('preferredLang') || LANG_DEFAULT;
}
function getTodayDateString() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
function parseDate(dateString) {
    if (!dateString) return null;
    const parts = dateString.split('-');
    return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
}

function updateStreak(user) {
    const todayStr = getTodayDateString();
    if (!user.streak || !user.last_login) {
        user.streak = 1;
        user.last_login = todayStr;
        return user;
    }
    if (user.last_login === todayStr) return user;

    const lastLoginDate = parseDate(user.last_login);
    const yesterday = new Date(parseDate(todayStr));
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    const yesterdayStr = `${yesterday.getUTCFullYear()}-${String(yesterday.getUTCMonth() + 1).padStart(2,'0')}-${String(yesterday.getUTCDate()).padStart(2,'0')}`;

    if (user.last_login === yesterdayStr) user.streak += 1;
    else user.streak = 1;
    user.last_login = todayStr;
    return user;
}

// --- ポイント加算 ---
window.addPoints = function(amount, gameId) {
    const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY);
    if (!currentUser || currentUser === GUEST_NAME) return false;
    if (typeof amount !== 'number' || amount <= 0) return false;

    let users = getUsers();
    let user = users[currentUser];
    if (!user) return false;

    user.points = (user.points || 0) + amount;

    if (gameId) {
        user.progress = user.progress || {};
        user.progress[gameId] = user.progress[gameId] || { total_points: 0 };
        user.progress[gameId].total_points += amount;
    }

    users[currentUser] = user;
    saveUsers(users);
    updateAuthenticationUI();
    return true;
};

// --- セッション ---
function setSession(gameName) {
    sessionStorage.setItem(SESSION_STORAGE_KEY, gameName);
    if (gameName !== GUEST_NAME) {
        let users = getUsers();
        let user = users[gameName];
        if (user) {
            user = updateStreak(user);
            users[gameName] = user;
            saveUsers(users);
        }
    }
    updateAuthenticationUI();
}
function logout() { sessionStorage.removeItem(SESSION_STORAGE_KEY); updateAuthenticationUI(); }
function playAsGuest() { setSession(GUEST_NAME); }

// --- UI 更新 ---
const userInfoEl = document.getElementById('user-info');
const streakDisplayEl = document.getElementById('streak-display');
const pointsDisplayEl = document.getElementById('points-display');
const loginBtn = document.getElementById('login-btn');
const signupBtn = document.getElementById('signup-btn');
const guestBtn = document.getElementById('guest-btn');
const logoutBtn = document.getElementById('logout-btn');
const initialMessageEl = document.getElementById('initial-message');
const mainMenuEl = document.getElementById('main-menu');

function updateAuthenticationUI() {
    const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY);
    const lang = getCurrentLang();
    const langData = translations[lang] || translations[LANG_DEFAULT];
    const isLoggedIn = !!currentUser;
    const isGuest = currentUser === GUEST_NAME;

    if (isLoggedIn && !isGuest) {
        const users = getUsers();
        const user = users[currentUser];
        if (!user) { logout(); return; }

        userInfoEl.textContent = `${currentUser}${langData['status_welcome']}`;
        streakDisplayEl.textContent = langData['streak_text'].replace('%DAYS%', user.streak || 0);
        pointsDisplayEl.textContent = langData['points_text'].replace('%POINTS%', user.points || 0);
        streakDisplayEl.style.display = 'block';
        pointsDisplayEl.style.display = 'block';

        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        guestBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        mainMenuEl.classList.remove('locked');
    } else if (isGuest) {
        userInfoEl.textContent = langData['status_guest'];
        streakDisplayEl.style.display = 'none';
        pointsDisplayEl.style.display = 'none';
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        guestBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        mainMenuEl.classList.remove('locked');
    } else {
        userInfoEl.textContent = langData['auth_status_default'];
        streakDisplayEl.style.display = 'none';
        pointsDisplayEl.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        signupBtn.style.display = 'inline-block';
        guestBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        mainMenuEl.classList.add('locked');
    }
}

// --- 認証イベント ---
document.getElementById('signup-submit-btn').addEventListener('click', e => {
    e.preventDefault();
    const gamename = document.getElementById('signup-gamename').value.trim();
    const password = document.getElementById('signup-password').value;
    const messageEl = document.getElementById('signup-message');
    if (!gamename || !password) { messageEl.textContent='必須です'; return; }
    if (gamename === GUEST_NAME) { messageEl.textContent='予約名です'; return; }

    const users = getUsers();
    if (users[gamename]) { messageEl.textContent='既存です'; return; }

    users[gamename] = { password, name: gamename, streak:0, last_login:null, points:0, progress:{} };
    saveUsers(users);
    setSession(gamename);
    document.getElementById('auth-modal').style.display='none';
    messageEl.textContent='';
});
document.getElementById('login-submit-btn').addEventListener('click', e => {
    e.preventDefault();
    const gamename = document.getElementById('login-gamename').value.trim();
    const password = document.getElementById('login-password').value;
    const messageEl = document.getElementById('login-message');
    const users = getUsers();
    const user = users[gamename];
    if (user && user.password === password) { setSession(gamename); document.getElementById('auth-modal').style.display='none'; messageEl.textContent=''; }
    else { messageEl.textContent='ゲーム名またはパスワードが違います'; }
});

loginBtn.addEventListener('click', ()=>{ document.getElementById('login-view').style.display='block'; document.getElementById('signup-view').style.display='none'; document.getElementById('auth-modal').style.display='flex'; });
signupBtn.addEventListener('click', ()=>{ document.getElementById('login-view').style.display='none'; document.getElementById('signup-view').style.display='block'; document.getElementById('auth-modal').style.display='flex'; });
guestBtn.addEventListener('click', playAsGuest);
logoutBtn.addEventListener('click', logout);
document.querySelectorAll('.btn-close').forEach(btn => btn.addEventListener('click', ()=>{ document.getElementById('auth-modal').style.display='none'; }));

document.addEventListener('DOMContentLoaded', () => { setLanguage(localStorage.getItem('preferredLang')||LANG_DEFAULT); });

</script>
</body>
</html>
