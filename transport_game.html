<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åì„ÅÜ„Å§„ÅÜ „ÅÆ „Ç≤„Éº„É† - FunLearnJP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- „Éá„Ç∂„Ç§„É≥ÂÆöÁæ© (Main ScreenÊ∫ñÊã†) --- */
        :root {
            --primary: #5c7aff;
            --accent: #ffcc5c;
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; padding-bottom: 40px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white; padding: 15px 20px; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 5px 12px; border-radius: 20px; text-decoration: none;
            font-size: 0.9em; font-weight: bold; display: flex; align-items: center; gap: 5px;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .page-title { font-size: 1.2em; font-weight: 900; margin: 0; }
        .auth-status { font-size: 0.8em; opacity: 0.9; }

        /* --- „Ç≥„É≥„ÉÜ„Éä --- */
        .game-container {
            background: white;
            max-width: 800px; width: 95%;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-top: 20px; margin-bottom: 20px;
        }

        /* --- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Çø„Éñ --- */
        .nav-area { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; 
        }
        .nav-btn {
            padding: 8px 16px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer;
            background: #eee; color: #666; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-btn.active { 
            background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(92, 122, 255, 0.3); 
        }

        /* --- ÁîªÈù¢Âàá„ÇäÊõø„Åà --- */
        .screen { display: none; animation: popIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        h2 { text-align: center; color: #555; margin: 0 0 20px 0; font-size: 1.4em; }

        /* --- „Çπ„Çø„Éá„Ç£„É¢„Éº„Éâ („Ç´„Éº„Éâ) --- */
        .word-section { margin-bottom: 30px; border-bottom: 2px dashed #eee; padding-bottom: 20px; }
        .section-label {
            background: #e0e7ff; color: var(--primary);
            padding: 6px 15px; border-radius: 15px; display: inline-block; 
            font-weight: bold; margin-bottom: 15px; font-size: 1em;
        }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px;
        }
        .card {
            background: #fff; border: 2px solid #eee; border-radius: 15px;
            padding: 10px 5px; text-align: center; cursor: pointer;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .card:active { transform: scale(0.95); background: #f0f4ff; }
        
        .emoji-img { font-size: 3rem; line-height: 1.2; margin-bottom: 5px; }
        .card span { font-size: 0.9em; font-weight: bold; color: #555; }

        /* --- „Ç≤„Éº„É†ÂÖ±ÈÄöUI --- */
        .question-box {
            background: #fff8e1; color: #f57f17;
            padding: 15px; border-radius: 15px; border: 2px solid #ffecb3;
            text-align: center; font-size: 1.1em; font-weight: bold; margin-bottom: 20px;
        }
        .main-image {
            width: 140px; height: 140px; 
            margin: 10px auto 20px auto; display: flex; justify-content: center; align-items: center;
            background: white; border-radius: 20px; 
            border: 4px solid #eee; font-size: 5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* ‰∏¶„Å≥Êõø„Åà„Ç®„É™„Ç¢ */
        .sortable-area {
            min-height: 70px; background: #f8f9fa; border-radius: 15px;
            padding: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            margin-bottom: 15px; border: 2px dashed #ccc; transition: background 0.2s;
        }
        .word-block {
            background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 10px 15px; border-radius: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 rgba(92, 122, 255, 0.2); user-select: none; font-size: 1em;
            transition: transform 0.1s;
        }
        .word-block:active { transform: translateY(2px); box-shadow: none; }

        /* Yes/No „Éú„Çø„É≥ */
        .yes-no-area { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .choice-btn {
            flex: 1; max-width: 140px; padding: 12px; border-radius: 50px;
            border: none; font-size: 1.1em; font-weight: bold; cursor: pointer; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .choice-btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-yes { background: var(--correct-color); }
        .btn-no { background: var(--incorrect-color); }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ‰øÆÊ≠£Ë≥™Âïè„Ç®„É™„Ç¢ */
        .fix-area { 
            margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 15px; animation: popIn 0.3s;
        }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .option-btn {
            background: white; border: 2px solid #ddd; padding: 15px; border-radius: 12px;
            font-weight: bold; cursor: pointer; font-size: 1.1em; color: #555;
            box-shadow: 0 3px 0 #eee; height: 70px;
        }
        .option-btn:active { transform: translateY(2px); box-shadow: none; }

        /* „Éì„ÉÉ„Ç∞„Éú„Çø„É≥ */
        .big-btn {
            background: var(--primary); color: white; border: none; padding: 12px 40px;
            font-size: 1.1em; font-weight: bold; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 0 #3949ab; display: block; margin: 20px auto 0 auto;
            transition: transform 0.1s;
        }
        .big-btn:active { transform: translateY(3px); box-shadow: none; }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback-msg {
            text-align: center; font-weight: 900; min-height: 30px; margin-top: 15px; font-size: 1.3em;
        }

        /* „Ç≤„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pointGet { 0% { opacity:0; transform:translateY(0); } 50% { opacity:1; transform:translateY(-20px); } 100% { opacity:0; transform:translateY(-40px); } }
        .point-anim { position: absolute; color: #ffcc5c; font-weight: bold; font-size: 1.5em; pointer-events: none; animation: pointGet 1s ease-out forwards; }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-house"></i> „Éõ„Éº„É†</a>
        <h1 class="page-title">„Åì„ÅÜ„Å§„ÅÜ„Ç≤„Éº„É†</h1>
    </div>
    <div class="auth-status" id="auth-status-display">...</div>
</header>

<div class="game-container">
    
    <div class="nav-area">
        <button class="nav-btn active" onclick="switchScreen('study')"><i class="fa-solid fa-book"></i> ÂçòË™û</button>
        <button class="nav-btn" onclick="switchScreen('game1')"><i class="fa-solid fa-pen"></i> Êñá‰Ωú„Çä</button>
        <button class="nav-btn" onclick="switchScreen('game2')"><i class="fa-solid fa-location-dot"></i> Â†¥ÊâÄ</button>
        <button class="nav-btn" onclick="switchScreen('game3')"><i class="fa-solid fa-bus"></i> ‰πó„ÇäÁâ©</button>
        <button class="nav-btn" onclick="switchScreen('game4')"><i class="fa-solid fa-star"></i> „Åæ„Å®„ÇÅ</button>
    </div>

    <div id="screen-study" class="screen active">
        <h2><i class="fa-solid fa-volume-high"></i> „Åì„Å®„Å∞ „Çí „Åä„Åº„Åà„Çà„ÅÜ</h2>
        <p style="text-align:center; font-size:0.9em; color:#666; margin-bottom:20px;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ Èü≥„Çí„Åç„ÅÑ„Å¶„Å≠</p>

        <div class="word-section">
            <div class="section-label">üôÇ „Å≤„Å® (People)</div>
            <div class="grid" id="grid-people"></div>
        </div>
        <div class="word-section">
            <div class="section-label">üöó „ÅÆ„Çä„ÇÇ„ÅÆ (Transports)</div>
            <div class="grid" id="grid-transport"></div>
        </div>
        <div class="word-section">
            <div class="section-label">üè´ „Å∞„Åó„Çá (Places)</div>
            <div class="grid" id="grid-place"></div>
        </div>
        <div class="word-section">
            <div class="section-label">üèÉ „Å©„ÅÜ„Åï (Verbs)</div>
            <div class="grid" id="grid-verb"></div>
        </div>
    </div>

    <div id="screen-game1" class="screen">
        <h2>Game 1: „Å∂„Çì „Çí „Å§„Åè„Çç„ÅÜ</h2>
        <div class="question-box" id="q1-text">English Sentence</div>
        <div class="sortable-area" id="area-game1"></div>
        <div class="sortable-area" id="pool-game1" style="border: 2px solid #e0e7ff; background:white;"></div>
        <div id="feedback-game1" class="feedback-msg"></div>
        <button class="big-btn" onclick="checkGame1()">„Åì„Åü„Åà„ÅÇ„Çè„Åõ</button>
    </div>

    <div id="screen-game2" class="screen">
        <h2>Game 2: „Å©„Åì„Å∏ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü</h2>
        <div id="img-game2" class="main-image">üè´</div>
        <div class="question-box" id="q2-text">Ë≥™ÂïèÊñá</div>
        
        <div id="area-yesno-game2" class="yes-no-area">
            <button id="g2-yes" class="choice-btn btn-yes" onclick="answerGame2(true)">„ÅØ„ÅÑ</button>
            <button id="g2-no" class="choice-btn btn-no" onclick="answerGame2(false)">„ÅÑ„ÅÑ„Åà</button>
        </div>
        
        <div id="area-fix-game2" class="fix-area" style="display:none;">
            <p style="text-align:center; font-weight:bold; color:#ef5350;">„Åü„Å†„Åó„ÅÑ „Å∞„Åó„Çá „ÅØ „Å©„Å£„Å°Ôºü</p>
            <div class="options-grid" id="opts-game2"></div>
        </div>
        <div id="feedback-game2" class="feedback-msg"></div>
    </div>

    <div id="screen-game3" class="screen">
        <h2>Game 3: „Å©„ÅÜ„ÇÑ„Å£„Å¶ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü</h2>
        <div id="img-game3" class="main-image">üöå</div>
        <div class="question-box" id="q3-text">Ë≥™ÂïèÊñá</div>
        
        <div id="area-yesno-game3" class="yes-no-area">
            <button id="g3-yes" class="choice-btn btn-yes" onclick="answerGame3(true)">„ÅØ„ÅÑ</button>
            <button id="g3-no" class="choice-btn btn-no" onclick="answerGame3(false)">„ÅÑ„ÅÑ„Åà</button>
        </div>
        
        <div id="area-fix-game3" class="fix-area" style="display:none;">
            <p style="text-align:center; font-weight:bold; color:#ef5350;">„Å©„ÅÜ„ÇÑ„Å£„Å¶ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü</p>
            <div class="options-grid" id="opts-game3"></div>
        </div>
        <div id="feedback-game3" class="feedback-msg"></div>
    </div>

    <div id="screen-game4" class="screen">
        <h2>Game 4: „Åú„Çì„Å∂ „ÅÑ„Åà„Çã„Åã„Å™Ôºü</h2>
        <p style="text-align:center; font-size:0.9em; color:#666;">(„Å†„Çå„Åå ‚Üí „Å©„ÅÜ„ÇÑ„Å£„Å¶ ‚Üí „Å©„Åì„Å∏ ‚Üí „Å©„ÅÜ„Åô„Çã)</p>
        <div class="question-box" id="q4-text">English</div>
        <div class="sortable-area" id="area-game4"></div>
        <div class="sortable-area" id="pool-game4" style="border: 2px solid #e0e7ff; background:white;"></div>
        <div id="feedback-game4" class="feedback-msg"></div>
        <button class="big-btn" onclick="checkGame4()">„Åì„Åü„Åà„ÅÇ„Çè„Åõ</button>
    </div>

</div>

<script type="module" src="js/firebase-config.js"></script>

<script>
    // --- „Éá„Éº„ÇøÂÆöÁæ© ---
    const verbs = [
        { id: 'go', name: '„ÅÑ„Åç„Åæ„Åô', en: 'go', emoji: '‚û°Ô∏è' },
        { id: 'come', name: '„Åç„Åæ„Åô', en: 'come', emoji: '‚¨ÖÔ∏è' },
        { id: 'return', name: '„Åã„Åà„Çä„Åæ„Åô', en: 'return', emoji: 'üè†' }
    ];

    const transports = [
        { id: 'bus', name: '„Éê„Çπ', en: 'bus', emoji: 'üöå', particle: '„Åß' },
        { id: 'train', name: '„Åß„Çì„Åó„ÇÉ', en: 'train', emoji: 'üöÉ', particle: '„Åß' },
        { id: 'car', name: '„Åè„Çã„Åæ', en: 'car', emoji: 'üöó', particle: '„Åß' },
        { id: 'walk', name: '„ÅÇ„Çã„ÅÑ„Å¶', en: 'on foot', emoji: 'üö∂', particle: '' }, 
        { id: 'bicycle', name: '„Åò„Å¶„Çì„Åó„ÇÉ', en: 'bicycle', emoji: 'üö≤', particle: '„Åß' },
        { id: 'taxi', name: '„Çø„ÇØ„Ç∑„Éº', en: 'taxi', emoji: 'üöï', particle: '„Åß' },
        { id: 'shinkansen', name: '„Åó„Çì„Åã„Çì„Åõ„Çì', en: 'Shinkansen', emoji: 'üöÖ', particle: '„Åß' },
        { id: 'plane', name: '„Å≤„Åì„ÅÜ„Åç', en: 'plane', emoji: '‚úàÔ∏è', particle: '„Åß' },
        { id: 'ship', name: '„Åµ„Å≠', en: 'ship', emoji: 'üö¢', particle: '„Åß' }
    ];

    const places = [
        { id: 'school', name: '„Åå„Å£„Åì„ÅÜ', en: 'school', emoji: 'üè´' },
        { id: 'hospital', name: '„Å≥„Çá„ÅÜ„ÅÑ„Çì', en: 'hospital', emoji: 'üè•' },
        { id: 'restaurant', name: '„É¨„Çπ„Éà„É©„É≥', en: 'restaurant', emoji: 'üçΩÔ∏è' },
        { id: 'bank', name: '„Åé„Çì„Åì„ÅÜ', en: 'bank', emoji: 'üè¶' },
        { id: 'home', name: '„ÅÜ„Å°', en: 'home', emoji: 'üè†' },
        { id: 'park', name: '„Åì„ÅÜ„Åà„Çì', en: 'park', emoji: 'üõù' },
        { id: 'station', name: '„Åà„Åç', en: 'station', emoji: 'üöâ' },
        { id: 'supermarket', name: '„Çπ„Éº„Éë„Éº', en: 'supermarket', emoji: 'üõí' },
        { id: 'conbini', name: '„Ç≥„É≥„Éì„Éã', en: 'convenience store', emoji: 'üè™' }
    ];

    const people = [
        { id: 'me', name: '„Çè„Åü„Åó', en: 'I', emoji: 'üòä' },
        { id: 'you', name: '„ÅÇ„Å™„Åü', en: 'You', emoji: 'ü´µ' },
        { id: 'teacher', name: '„Åõ„Çì„Åõ„ÅÑ', en: 'Teacher', emoji: 'üë©‚Äçüè´' },
        { id: 'father', name: '„Åä„Å®„ÅÜ„Åï„Çì', en: 'Father', emoji: 'üë®' },
        { id: 'mother', name: '„Åä„Åã„ÅÇ„Åï„Çì', en: 'Mother', emoji: 'üë©' },
        { id: 'friend', name: '„Å®„ÇÇ„Å†„Å°', en: 'Friend', emoji: 'üë´' }
    ];

    // --- ÂÖ±ÈÄöÈñ¢Êï∞ ---
    function speak(text) {
        window.speechSynthesis.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP';
        ut.rate = 0.9;
        window.speechSynthesis.speak(ut);
    }
    function playSeikai() { new Audio('assets/sounds/seikai.mp3').play().catch(()=>{}); }
    function playBubu() { new Audio('assets/sounds/bubu.mp3').play().catch(()=>{}); }

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + screenId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(event && event.target) event.target.classList.add('active');
        
        if (screenId === 'study') initStudy();
        if (screenId === 'game1') initGame1();
        if (screenId === 'game2') initGame2();
        if (screenId === 'game3') initGame3();
        if (screenId === 'game4') initGame4();
    }

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    // --- Study Mode ---
    function initStudy() {
        renderGrid('grid-people', people);
        renderGrid('grid-transport', transports);
        renderGrid('grid-place', places);
        renderGrid('grid-verb', verbs);
    }

    function renderGrid(elemId, dataList) {
        const container = document.getElementById(elemId);
        container.textContent = '';
        dataList.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            div.textContent = `<div class="emoji-img">${item.emoji}</div><span>${item.name}</span>`;
            div.onclick = () => speak(item.name);
            container.appendChild(div);
        });
    }

    // --- Game 1 ---
    let g1Answer = [], g1CurrentId = "";
    
    function initGame1() {
        document.getElementById('feedback-game1').innerText = '';
        document.getElementById('area-game1').textContent = '';
        
        const sub = getRandom(people);
        const plc = getRandom(places);
        const vrb = getRandom(verbs);

        // IDÁîüÊàê (‰æã: g1_me_school_go)
        g1CurrentId = `g1_${sub.id}_${plc.id}_${vrb.id}`;

        let enVerb = vrb.en;
        if(sub.id !== 'me' && sub.id !== 'you' && sub.id !== 'friend') enVerb += 's'; 
        if(sub.id === 'you' || sub.id === 'friend' || sub.id === 'me') enVerb = vrb.en;
        document.getElementById('q1-text').innerText = `${sub.en} ${enVerb} to ${plc.en}.`;
        
        const parts = [
            { text: sub.name + '„ÅØ', type: 'sub' },
            { text: plc.name + '„Å´', type: 'plc' }, 
            { text: vrb.name, type: 'vrb' }
        ];
        g1Answer = parts.map(p => p.text).join('');

        const pool = document.getElementById('pool-game1');
        pool.textContent = '';
        shuffle([...parts]).forEach(p => {
            const btn = document.createElement('div');
            btn.className = 'word-block';
            btn.innerText = p.text;
            btn.onclick = () => moveBlock(btn, 'pool-game1', 'area-game1');
            pool.appendChild(btn);
        });
    }

    function moveBlock(el, fromId, toId) {
        const parent = el.parentNode;
        if(parent.id === fromId) document.getElementById(toId).appendChild(el);
        else document.getElementById(fromId).appendChild(el);
        speak(el.innerText);
    }

    function checkGame1() {
        const blocks = document.querySelectorAll('#area-game1 .word-block');
        let userAnswer = "";
        blocks.forEach(b => userAnswer += b.innerText);
        const fb = document.getElementById('feedback-game1');
        if (userAnswer === g1Answer) {
            fb.innerText = "‚≠ïÔ∏è „Åõ„ÅÑ„Åã„ÅÑÔºÅ";
            fb.style.color = "var(--correct-color)";
            playSeikai();
            if(window.addPointsToUser) window.addPointsToUser(g1CurrentId);
            setTimeout(() => initGame1(), 2000);
        } else {
            fb.innerText = "‚ùå „Å°„Åå„ÅÑ„Åæ„Åô...";
            fb.style.color = "var(--incorrect-color)";
            playBubu();
        }
    }

    // --- Game 2 ---
    let g2Target, g2CurrentId = "";
    let g2IsCorrectCase;

    function initGame2() {
        resetGameUI('game2');
        g2Target = getRandom(places);
        g2IsCorrectCase = Math.random() > 0.5;
        
        // IDÁîüÊàê (‰æã: g2_school_yes „Åæ„Åü„ÅØ g2_school_no)
        g2CurrentId = `g2_${g2Target.id}_${g2IsCorrectCase ? 'yes' : 'no'}`;

        document.getElementById('img-game2').innerText = g2Target.emoji;

        let qText = "";
        if (g2IsCorrectCase) {
            qText = `${g2Target.name} „Å´ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü`;
        } else {
            let wrong;
            do { wrong = getRandom(places); } while(wrong.id === g2Target.id);
            qText = `${wrong.name} „Å´ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü`;
        }
        document.getElementById('q2-text').innerText = qText;
        speak(qText);
    }

    function answerGame2(isYes) {
        const fb = document.getElementById('feedback-game2');
        if ( (g2IsCorrectCase && isYes) || (!g2IsCorrectCase && !isYes) ) {
            if(isYes) {
                fb.innerText = `‚≠ïÔ∏è „ÅØ„ÅÑ„ÄÅ${g2Target.name} „Å´ „ÅÑ„Åç„Åæ„Åô„ÄÇ`;
                fb.style.color = "var(--correct-color)";
                playSeikai();
                if(window.addPointsToUser) window.addPointsToUser(g2CurrentId);
                setTimeout(() => initGame2(), 2000);
            } else {
                playSeikai();
                setTimeout(() => showFixQuestion2(), 1000);
            }
            disableYesNo('game2');
        } else {
            fb.innerText = "‚ùå „Å°„Åå„ÅÑ„Åæ„Åô...";
            fb.style.color = "var(--incorrect-color)";
            playBubu();
        }
    }

    function showFixQuestion2() {
        const fixArea = document.getElementById('area-fix-game2');
        fixArea.style.display = 'block';
        const optsDiv = document.getElementById('opts-game2');
        optsDiv.textContent = '';
        
        let dummy = getRandom(places);
        while(dummy.id === g2Target.id) dummy = getRandom(places);
        
        const choices = shuffle([g2Target, dummy]);
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = c.name;
            btn.onclick = () => {
                if(c.id === g2Target.id) {
                    document.getElementById('feedback-game2').innerText = `‚≠ïÔ∏è „Åõ„ÅÑ„Åã„ÅÑÔºÅ ${g2Target.name} „Å´ „ÅÑ„Åç„Åæ„Åô„ÄÇ`;
                    playSeikai();
                    if(window.addPointsToUser) window.addPointsToUser(g2CurrentId);
                    optsDiv.querySelectorAll('button').forEach(b => b.disabled = true);
                    setTimeout(() => initGame2(), 2000);
                } else {
                    playBubu();
                }
            };
            optsDiv.appendChild(btn);
        });
        speak("„Å©„Åì„Å∏ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü");
    }

    // --- Game 3 ---
    let g3Target, g3CurrentId = "";
    let g3IsCorrectCase;

    function initGame3() {
        resetGameUI('game3');
        g3Target = getRandom(transports);
        g3IsCorrectCase = Math.random() > 0.5;
        g3CurrentId = `g3_${g3Target.id}_${g3IsCorrectCase ? 'yes' : 'no'}`;

        document.getElementById('img-game3').innerText = g3Target.emoji;

        let targetWord = g3Target.name + (g3Target.particle || '');
        let qText = "";
        if (g3IsCorrectCase) {
            qText = `${targetWord} „ÅÑ„Åç„Åæ„Åô„ÅãÔºü`;
        } else {
            let wrong;
            do { wrong = getRandom(transports); } while(wrong.id === g3Target.id);
            let wrongWord = wrong.name + (wrong.particle || '');
            qText = `${wrongWord} „ÅÑ„Åç„Åæ„Åô„ÅãÔºü`;
        }
        document.getElementById('q3-text').innerText = qText;
        speak(qText);
    }

    function answerGame3(isYes) {
        const fb = document.getElementById('feedback-game3');
        let targetWord = g3Target.name + (g3Target.particle || '');

        if ( (g3IsCorrectCase && isYes) || (!g3IsCorrectCase && !isYes) ) {
            if(isYes) {
                fb.innerText = `‚≠ïÔ∏è „ÅØ„ÅÑ„ÄÅ${targetWord} „ÅÑ„Åç„Åæ„Åô„ÄÇ`;
                fb.style.color = "var(--correct-color)";
                playSeikai();
                if(window.addPointsToUser) window.addPointsToUser(g3CurrentId);
                setTimeout(() => initGame3(), 2000);
            } else {
                playSeikai();
                setTimeout(() => showFixQuestion3(), 1000);
            }
            disableYesNo('game3');
        } else {
            fb.innerText = "‚ùå „Å°„Åå„ÅÑ„Åæ„Åô...";
            fb.style.color = "var(--incorrect-color)";
            playBubu();
        }
    }

    function showFixQuestion3() {
        document.getElementById('area-fix-game3').style.display = 'block';
        const optsDiv = document.getElementById('opts-game3');
        optsDiv.textContent = '';
        
        let dummy = getRandom(transports);
        while(dummy.id === g3Target.id) dummy = getRandom(transports);
        
        const choices = shuffle([g3Target, dummy]);
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = c.name;
            btn.onclick = () => {
                if(c.id === g3Target.id) {
                    let text = c.name + (c.particle || '');
                    document.getElementById('feedback-game3').innerText = `‚≠ïÔ∏è „Åõ„ÅÑ„Åã„ÅÑÔºÅ ${text} „ÅÑ„Åç„Åæ„Åô„ÄÇ`;
                    playSeikai();
                    if(window.addPointsToUser) window.addPointsToUser(g3CurrentId);
                    optsDiv.querySelectorAll('button').forEach(b => b.disabled = true);
                    setTimeout(() => initGame3(), 2000);
                } else {
                    playBubu();
                }
            };
            optsDiv.appendChild(btn);
        });
        speak("„Å©„ÅÜ„ÇÑ„Å£„Å¶ „ÅÑ„Åç„Åæ„Åô„ÅãÔºü");
    }

    // --- Game 4 ---
    let g4Answer = "", g4CurrentId = "";

    function initGame4() {
        document.getElementById('feedback-game4').innerText = '';
        document.getElementById('area-game4').textContent = '';

        const sub = getRandom(people);
        const trn = getRandom(transports);
        const plc = getRandom(places);
        const vrb = getRandom(verbs);

        // IDÁîüÊàê (‰æã: g4_me_bus_school_go)
        g4CurrentId = `g4_${sub.id}_${trn.id}_${plc.id}_${vrb.id}`;

        let enVerb = vrb.en;
        if(sub.id !== 'me' && sub.id !== 'you') enVerb += 's';
        let enTrn = trn.id === 'walk' ? 'on foot' : `by ${trn.en}`;
        
        const enText = `${sub.en} ${enVerb} to ${plc.en} ${enTrn}.`;
        document.getElementById('q4-text').innerText = enText;
        
        const p1 = sub.name + '„ÅØ';
        const p2 = trn.name + (trn.particle || '');
        const p3 = plc.name + '„Å´';
        const p4 = vrb.name;

        g4Answer = p1 + p2 + p3 + p4;

        const parts = [p1, p2, p3, p4];
        const pool = document.getElementById('pool-game4');
        pool.textContent = '';
        shuffle(parts).forEach(txt => {
            const btn = document.createElement('div');
            btn.className = 'word-block';
            btn.innerText = txt;
            btn.onclick = () => moveBlock(btn, 'pool-game4', 'area-game4');
            pool.appendChild(btn);
        });
    }

    function checkGame4() {
        const blocks = document.querySelectorAll('#area-game4 .word-block');
        let userAnswer = "";
        blocks.forEach(b => userAnswer += b.innerText);
        const fb = document.getElementById('feedback-game4');
        if (userAnswer === g4Answer) {
            fb.innerText = "‚≠ïÔ∏è „Åã„Çì„Å∫„Åç„Åß„ÅôÔºÅ";
            fb.style.color = "var(--correct-color)";
            playSeikai();
            if(window.addPointsToUser) window.addPointsToUser(g4CurrentId);
            setTimeout(() => initGame4(), 2000);
        } else {
            fb.innerText = "‚ùå „Åä„Åó„ÅÑÔºÅ";
            fb.style.color = "var(--incorrect-color)";
            playBubu();
        }
    }

    function resetGameUI(gameId) {
        const yesBtn = document.getElementById(`g${gameId.slice(-1)}-yes`);
        const noBtn = document.getElementById(`g${gameId.slice(-1)}-no`);
        yesBtn.disabled = false; noBtn.disabled = false;
        document.getElementById(`area-fix-${gameId}`).style.display = 'none';
        document.getElementById(`feedback-${gameId}`).innerText = '';
    }
    function disableYesNo(gameId) {
        const yesBtn = document.getElementById(`g${gameId.slice(-1)}-yes`);
        const noBtn = document.getElementById(`g${gameId.slice(-1)}-no`);
        yesBtn.disabled = true; noBtn.disabled = true;
    }

    initStudy();
</script>
</body>
</html>