<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="main_title">Fun Learning Japanese - Next Gen</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

<style>
    /* --- åŸºæœ¬è¨­å®š --- */
    :root {
        --primary: #5c7aff;
        --accent: #ffcc5c;
        --bg-color: #f4f7fc;
        --text-color: #333;
    }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        padding-bottom: 80px;
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    header {
        background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
        position: sticky;
        top: 0;
        z-index: 100;
    }
    .logo { font-size: 1.4em; font-weight: 900; display: flex; align-items: center; gap: 10px; }
    .lang-switch button {
        background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
        color: white; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 0.8em;
    }
    .lang-switch button.active { background: white; color: var(--primary); font-weight: bold; }

    /* --- ãƒ’ãƒ¼ãƒ­ãƒ¼ --- */
    .hero-section {
        background: white; text-align: center; padding: 30px 20px;
        border-radius: 0 0 30px 30px; margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .hero-section h1 { margin: 0; color: var(--primary); font-size: 1.6em; }

    /* --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ --- */
    .dashboard-card {
        background: white; margin: 20px; padding: 20px;
        border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: flex; align-items: center; gap: 15px;
    }
    .avatar-circle {
        width: 60px; height: 60px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.8em; background: #e0e7ff; color: var(--primary);
    }
    .user-meta { flex-grow: 1; }
    .level-bar-container {
        background: #eee; height: 10px; border-radius: 5px; margin-top: 8px; overflow: hidden;
    }
    .level-bar-fill {
        background: linear-gradient(90deg, #ffcc5c, #ff6f61); height: 100%; width: 0%; transition: width 0.5s ease;
    }
    .status-badges { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85em; font-weight: bold; }
    .badge-streak { color: #ff6f61; }
    .badge-points { color: #f0ad4e; }

    /* --- èªè¨¼ãƒœã‚¿ãƒ³ --- */
    .auth-action-area { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .btn-auth {
        padding: 10px 20px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
    }
    .btn-auth:active { transform: translateY(4px); box-shadow: none; }
    .btn-login { background: #4caf50; color: white; }
    .btn-signup { background: var(--primary); color: white; }
    .btn-guest { background: #90a4ae; color: white; }

    /* --- ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .section-header {
        padding: 0 20px; margin-bottom: 15px;
        display: flex; align-items: center; justify-content: space-between;
    }
    .section-title { font-size: 1.2em; color: #444; display: flex; align-items: center; gap: 8px; margin: 0; }
    .section-title i { color: var(--primary); }
    
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºæ™‚ç”¨) */
    .btn-back {
        background: #eee; border: none; padding: 5px 15px; border-radius: 20px;
        font-size: 0.9em; font-weight: bold; color: #666; cursor: pointer;
        display: none; /* åˆæœŸã¯éè¡¨ç¤º */
    }
    .btn-back:hover { background: #ddd; }

    .grid-container {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px; padding: 0 20px 40px 20px; max-width: 1000px; margin: 0 auto;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .game-card {
        background: white; border-radius: 15px; padding: 20px;
        text-align: center; text-decoration: none; color: var(--text-color);
        box-shadow: 0 4px 0 #e0e0e0; border: 2px solid #f0f0f0;
        transition: all 0.2s; cursor: pointer;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        height: 130px; position: relative; overflow: hidden;
    }
    .game-card:active { transform: translateY(2px); box-shadow: 0 2px 0 #e0e0e0; }
    
    /* ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚©ãƒ«ãƒ€ã£ã½ã„ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .category-card {
        border-color: #bbdefb; background: #e3f2fd;
    }
    .category-card .card-icon { color: #1976d2; }

    .card-icon { font-size: 2.5em; margin-bottom: 10px; color: var(--primary); }
    .card-title { font-weight: 700; font-size: 0.95em; line-height: 1.3; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-box {
        background: white; width: 90%; max-width: 400px; padding: 30px;
        border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
    }
    .modal-box input {
        width: 100%; padding: 12px; margin: 10px 0;
        border: 2px solid #eee; border-radius: 10px; box-sizing: border-box;
    }
    
    .ranking-fab {
        position: fixed; bottom: 20px; right: 20px;
        background: #ffcc5c; color: #d35400; width: 60px; height: 60px;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 1.5em; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        cursor: pointer; z-index: 90; border: 3px solid white;
    }

    .hidden { display: none !important; }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body>

<header>
    <div class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</div>
    <div class="lang-switch">
        <button id="lang-ja" onclick="setLanguage('ja')" class="active">JP</button>
        <button id="lang-en" onclick="setLanguage('en')">EN</button>
    </div>
</header>

<div class="hero-section">
    <h1 data-i18n="main_title">æ¥½ã—ãæ—¥æœ¬èªã‚’å­¦ã¼ã†ï¼</h1>
</div>

<div id="guest-welcome" class="auth-action-area">
    <button id="login-btn" class="btn-auth btn-login"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="btn_login">ãƒ­ã‚°ã‚¤ãƒ³</span></button>
    <button id="signup-btn" class="btn-auth btn-signup"><i class="fa-solid fa-user-plus"></i> <span data-i18n="btn_signup">ç™»éŒ²</span></button>
    <button id="guest-btn" class="btn-auth btn-guest"><i class="fa-solid fa-gamepad"></i> <span data-i18n="btn_guest">ã‚²ã‚¹ãƒˆ</span></button>
</div>

<div id="user-dashboard" class="dashboard-card hidden">
    <div class="avatar-circle"><i class="fa-solid fa-user-astronaut"></i></div>
    <div class="user-meta">
        <div style="display:flex; justify-content:space-between;">
            <span id="user-name" style="font-weight:bold; font-size:1.1em;">User</span>
            <span style="font-size:0.9em; color:#666;">Lv.<span id="user-lvl">1</span></span>
        </div>
        <div class="level-bar-container"><div id="level-fill" class="level-bar-fill"></div></div>
        <div class="status-badges">
            <span class="badge-streak"><i class="fa-solid fa-fire"></i> <span id="streak-val">0</span> Day</span>
            <span class="badge-points"><i class="fa-solid fa-star"></i> <span id="point-val">0</span> Pt</span>
        </div>
    </div>
    <button id="logout-btn" style="background:none; border:none; color:#999; cursor:pointer;"><i class="fa-solid fa-right-from-bracket"></i></button>
</div>

<div class="section-header">
    <h3 class="section-title"><i class="fa-solid fa-book-open"></i> <span data-i18n="group_kiso">åŸºç¤ãƒ»å˜èª</span></h3>
</div>
<div class="grid-container">
    <a href="kiso.html" class="game-card">
        <i class="fa-solid fa-pen-nib card-icon" style="color:#ff6f61;"></i>
        <span class="card-title" data-i18n="btn_kiso">ã²ã‚‰ãŒãª<br>ã‚«ã‚¿ã‚«ãƒŠ</span>
    </a>
    <a href="hiragana_video_list.html" class="game-card">
        <i class="fa-solid fa-video card-icon" style="color:#ffcc5c;"></i>
        <span class="card-title" data-i18n="btn_hiragana_video">å‹•ç”»ç·´ç¿’</span>
    </a>
    <a href="keiyoshi_list.html" class="game-card">
        <i class="fa-solid fa-book card-icon" style="color:#66bb6a;"></i>
        <span class="card-title" data-i18n="btn_keiyoshi_list">å½¢å®¹è©ãƒªã‚¹ãƒˆ</span>
    </a>
    <a href="kanji_list.html" class="game-card">
        <i class="fa-solid fa-scroll card-icon" style="color:#42a5f5;"></i>
        <span class="card-title" data-i18n="btn_kanji_list">æ¼¢å­—ãƒªã‚¹ãƒˆ</span>
    </a>
</div>

<div class="section-header">
    <h3 class="section-title"><i class="fa-solid fa-gamepad"></i> <span id="game-section-title" data-i18n="group_game">ã‚²ãƒ¼ãƒ ã§éŠã¶</span></h3>
    <button id="game-back-btn" class="btn-back" onclick="renderGameCategories()"><i class="fa-solid fa-arrow-left"></i> ã‚‚ã©ã‚‹</button>
</div>

<div id="game-grid" class="grid-container fade-in">
    </div>

<div id="fab-ranking" class="ranking-fab" onclick="toggleRanking()"><i class="fa-solid fa-trophy"></i></div>

<div id="ranking-modal" class="modal-overlay">
    <div class="modal-box" style="text-align:left;">
        <h2 style="text-align:center; color:#f0ad4e;"><i class="fa-solid fa-crown"></i> Top 5</h2>
        <ul id="ranking-list" style="list-style:none; padding:0;"></ul>
        <button onclick="document.getElementById('ranking-modal').style.display='none'" style="width:100%; padding:10px; margin-top:10px; border:none; border-radius:8px; background:#eee;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="auth-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modal-title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <p id="modal-msg" style="color:red; font-size:0.9em;"></p>
        <input type="text" id="auth-name" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
        <input type="password" id="auth-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="modal-submit" class="btn-auth btn-login" style="width:100%; margin-top:10px;">å®Ÿè¡Œ</button>
        <button id="modal-close" style="width:100%; margin-top:10px; border:none; background:white; color:#666; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© (çœç•¥ - å¤‰æ›´ãªã—) ---
    const i18nData = {
        ja: { 
            main_title: "Fun Learning Japanese", btn_login: "ãƒ­ã‚°ã‚¤ãƒ³", btn_signup: "ç™»éŒ²", btn_guest: "ã‚²ã‚¹ãƒˆ", 
            group_kiso: "åŸºç¤ãƒ»å˜èª", group_game: "ã‚²ãƒ¼ãƒ ",
            btn_kiso: "ã²ã‚‰ãŒãªåŸºç¤", btn_hiragana_video: "å‹•ç”»ç·´ç¿’", btn_keiyoshi_list: "å½¢å®¹è©ãƒªã‚¹ãƒˆ", btn_kanji_list: "æ¼¢å­—ãƒªã‚¹ãƒˆ",
            cat_hiragana: "ã²ã‚‰ãŒãª", cat_katakana: "ã‚«ã‚¿ã‚«ãƒŠ", cat_shiritori: "ã—ã‚Šã¨ã‚Š", cat_word_other: "ã“ã¨ã°",
            cat_clock: "ã¨ã‘ã„", cat_kanji_game: "ã‹ã‚“ã˜", cat_keiyoshi_game: "ã‘ã„ã‚ˆã†ã—", cat_sentence: "ã¶ã‚“ã—ã‚‡ã†"
        },
        en: { 
            main_title: "Fun Learning Japanese", btn_login: "Login", btn_signup: "Sign Up", btn_guest: "Guest", 
            group_kiso: "Basics", group_game: "Games",
            btn_kiso: "Kana Basics", btn_hiragana_video: "Video Practice", btn_keiyoshi_list: "Adj List", btn_kanji_list: "Kanji List",
            cat_hiragana: "Hiragana", cat_katakana: "Katakana", cat_shiritori: "Shiritori", cat_word_other: "Words",
            cat_clock: "Clock", cat_kanji_game: "Kanji", cat_keiyoshi_game: "Adjectives", cat_sentence: "Sentence"
        }
    };

    const gameStructure = [
        // 1. ã²ã‚‰ãŒãª (4ã‚²ãƒ¼ãƒ )
        {
            id: "hiragana",
            icon: "fa-solid fa-h", 
            color: "#ff6f61", // èµ¤ç³»
            titleKey: "cat_hiragana",
            games: [
                { url: "hiragana_v2.html", title: "ã²ã‚‰ãŒãªå˜èª", icon: "fa-solid fa-shapes" },
                { url: "hiragana2_v2.html", title: "ä¸¦ã³æ›¿ãˆ", icon: "fa-solid fa-sort-alpha-down" },
                { url: "hiragana_match_v2.html", title: "ã²ã‚‰ãŒãªãƒãƒƒãƒ", icon: "fa-solid fa-hand-pointer" },
                { url: "meteor_quiz.html", title: "éš•çŸ³ã‚¯ã‚¤ã‚º", icon: "fa-solid fa-meteor" } 
            ]
        },
        // 2. ã‚«ã‚¿ã‚«ãƒŠ (1ã‚²ãƒ¼ãƒ )
        {
            id: "katakana",
            icon: "fa-solid fa-k", 
            color: "#ffa726", // ã‚ªãƒ¬ãƒ³ã‚¸ç³»
            titleKey: "cat_katakana",
            games: [
                { url: "katakana_match_v2.html", title: "ã‚«ã‚¿ã‚«ãƒŠãƒãƒƒãƒ", icon: "fa-solid fa-hand-pointer" }
            ]
        },
        // 3. ã—ã‚Šã¨ã‚Š (2ã‚²ãƒ¼ãƒ )
        {
            id: "shiritori",
            icon: "fa-solid fa-comments", 
            color: "#f0ad4e", // é»„è‰²ç³»
            titleKey: "cat_shiritori",
            games: [
                { url: "shiritori_v2.html", title: "ã—ã‚Šã¨ã‚Š1", icon: "fa-solid fa-comment-dots" },
                { url: "shiritori2_v2.html", title: "ã—ã‚Šã¨ã‚Š2", icon: "fa-regular fa-comments" }
            ]
        },
        // 4. ã“ã¨ã° (ã—ã‚Šã¨ã‚Šä»¥å¤– 3ã‚²ãƒ¼ãƒ )
        {
            id: "word_other",
            icon: "fa-solid fa-microphone", 
            color: "#00bcd4", // ã‚·ã‚¢ãƒ³ç³»
            titleKey: "cat_word_other",
            games: [
                { url: "verb_v2.html", title: "ã©ã†ã—ã‚²ãƒ¼ãƒ ", icon: "fa-solid fa-person-running" },
                { url: "treasure_Hunt_v2.html", title: "å®æ¢ã—", icon: "fa-solid fa-gem" },
                { url: "aisatsu_quiz_v2.html", title: "ã‚ã„ã•ã¤", icon: "fa-solid fa-hand-spock" },
            ]
        },
        // 5. ã¨ã‘ã„ (2ã‚²ãƒ¼ãƒ )
        {
            id: "clock",
            icon: "fa-solid fa-clock", 
            color: "#42a5f5", // é’ç³»
            titleKey: "cat_clock",
            games: [
                { url: "clock.html", title: "ã¨ã‘ã„1", icon: "fa-regular fa-clock" },
                { url: "clock2.html", title: "ã¨ã‘ã„2", icon: "fa-solid fa-stopwatch" }
            ]
        },
        // 6. ã‹ã‚“ã˜ (1ã‚²ãƒ¼ãƒ )
        {
            id: "kanji_game",
            icon: "fa-solid fa-pen-fancy", 
            color: "#66bb6a", // ç·‘ç³»
            titleKey: "cat_kanji_game",
            games: [
                { url: "kanji_quiz.html", title: "ã‹ã‚“ã˜ã‚¯ã‚¤ã‚º", icon: "fa-solid fa-scroll" }
            ]
        },
        // 7. ã‘ã„ã‚ˆã†ã— (2ã‚²ãƒ¼ãƒ )
        {
            id: "keiyoshi_game",
            icon: "fa-solid fa-star-half-stroke", 
            color: "#ab47bc", // ç´«ç³»
            titleKey: "cat_keiyoshi_game",
            games: [
                { url: "keiyoshi.html", title: "ã‘ã„ã‚ˆã†ã—1", icon: "fa-solid fa-star-half-stroke" },
                { url: "adjective_quiz.html", title: "ã‘ã„ã‚ˆã†ã—2", icon: "fa-regular fa-star" },
            ]
        },
        // 8. ã¶ã‚“ã—ã‚‡ã† (1ã‚²ãƒ¼ãƒ )
        {
            id: "sentence",
            icon: "fa-solid fa-layer-group", 
            color: "#546e7a", // ã‚°ãƒ¬ãƒ¼ç³»
            titleKey: "cat_sentence",
            games: [
                { url: "sentence_puzzle.html", title: "ã¶ã‚“ã¥ãã‚Š", icon: "fa-solid fa-layer-group" }
            ]
        }
    ];

    // --- DOMè¦ç´ å–å¾— ---
    const gameGrid = document.getElementById('game-grid');
    const backBtn = document.getElementById('game-back-btn');
    const kisoSection = document.querySelector('.section-header:first-of-type').parentNode; // ã€ŒåŸºç¤ãƒ»å˜èªã€å…¨ä½“
    const kisoGrid = kisoSection.querySelector('.grid-container'); // åŸºç¤ãƒ»å˜èªã®ã‚°ãƒªãƒƒãƒ‰

    let currentLang = 'ja';

    // 1. ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹)
    function renderGameCategories() {
        gameGrid.innerHTML = '';
        backBtn.style.display = 'none';
        document.getElementById('game-section-title').textContent = i18nData[currentLang].group_game;

        // â˜…åŸºç¤ãƒ»å˜èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤º
        kisoSection.style.display = 'block';
        kisoGrid.style.display = 'grid'; // åŸºç¤å˜èªã®ã‚«ãƒ¼ãƒ‰ã‚’å†è¡¨ç¤º

        gameStructure.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'game-card category-card';
            
            // â˜…ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®æ–°ã—ã„ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
            div.onclick = () => handleCategoryClick(cat);
            
            const title = i18nData[currentLang][cat.titleKey] || cat.titleKey;
            
            div.innerHTML = `
                <i class="${cat.icon} card-icon" style="color:${cat.color}"></i>
                <span class="card-title">${title}</span>
                <span style="font-size:0.8em; color:#666; margin-top:5px;">${cat.games.length} Games</span>
            `;
            gameGrid.appendChild(div);
        });
        
        gameGrid.classList.remove('fade-in');
        void gameGrid.offsetWidth;
        gameGrid.classList.add('fade-in');
    }
    
    // 2. ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    function handleCategoryClick(category) {
        // â˜…åŸºç¤ãƒ»å˜èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        kisoSection.style.display = 'none';

        // ã‚«ãƒ†ã‚´ãƒªå†…ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        renderGameList(category);
    }

    // 3. ã‚«ãƒ†ã‚´ãƒªå†…ã®ã‚²ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function renderGameList(category) {
        gameGrid.innerHTML = '';
        backBtn.style.display = 'block'; // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('game-section-title').textContent = i18nData[currentLang][category.titleKey];

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã«æˆ»ã‚‹é–¢æ•°ã«è¨­å®š
        backBtn.onclick = renderGameCategories; 

        category.games.forEach(game => {
            const a = document.createElement('a');
            a.href = game.url;
            a.className = 'game-card';
            a.innerHTML = `
                <i class="${game.icon} card-icon" style="color:${category.color}"></i>
                <span class="card-title">${game.title}</span>
            `;
            gameGrid.appendChild(a);
        });

        gameGrid.classList.remove('fade-in');
        void gameGrid.offsetWidth;
        gameGrid.classList.add('fade-in');
    }


    // --- èªè¨¼ãƒ»UIãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
    const USER_KEY = 'user_accounts';
    const SESS_KEY = 'current_user';
    
    function updateUI() {
        const user = sessionStorage.getItem(SESS_KEY);
        if (user) {
            document.getElementById('guest-welcome').classList.add('hidden');
            document.getElementById('user-dashboard').classList.remove('hidden');
            let users = JSON.parse(localStorage.getItem(USER_KEY) || '{}');
            let userData = users[user] || { points: 0, streak: 0 };
            if(user === 'ã‚²ã‚¹ãƒˆ') userData = { points: 0, streak: 0 };
            document.getElementById('user-name').textContent = user;
            document.getElementById('streak-val').textContent = userData.streak;
            document.getElementById('point-val').textContent = userData.points;
            const level = Math.floor(userData.points / 100) + 1;
            document.getElementById('user-lvl').textContent = level;
            document.getElementById('level-fill').style.width = `${(userData.points % 100)}%`;
        } else {
            document.getElementById('guest-welcome').classList.remove('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
        }
    }

    document.getElementById('login-btn').onclick = () => openAuthModal('login');
    document.getElementById('signup-btn').onclick = () => openAuthModal('signup');
    document.getElementById('guest-btn').onclick = () => { sessionStorage.setItem(SESS_KEY, 'ã‚²ã‚¹ãƒˆ'); updateUI(); };
    document.getElementById('logout-btn').onclick = () => { sessionStorage.removeItem(SESS_KEY); updateUI(); };

    const modal = document.getElementById('auth-modal');
    let authMode = 'login';
    function openAuthModal(mode) {
        authMode = mode;
        modal.style.display = 'flex';
        document.getElementById('modal-title').textContent = mode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²';
        document.getElementById('modal-msg').textContent = '';
    }
    document.getElementById('modal-close').onclick = () => modal.style.display = 'none';
    document.getElementById('modal-submit').onclick = () => {
        const name = document.getElementById('auth-name').value;
        const pass = document.getElementById('auth-pass').value;
        const msg = document.getElementById('modal-msg');
        let users = JSON.parse(localStorage.getItem(USER_KEY) || '{}');
        if (!name || !pass) { msg.textContent = 'å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
        if (authMode === 'signup') {
            if (users[name]) { msg.textContent = 'ãã®åå‰ã¯ä½¿ã‚ã‚Œã¦ã„ã¾ã™'; return; }
            users[name] = { password: pass, points: 0, streak: 1 };
            localStorage.setItem(USER_KEY, JSON.stringify(users));
            sessionStorage.setItem(SESS_KEY, name);
        } else {
            if (!users[name] || users[name].password !== pass) { msg.textContent = 'åå‰ã‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'; return; }
            sessionStorage.setItem(SESS_KEY, name);
        }
        modal.style.display = 'none';
        updateUI();
    };

    window.setLanguage = (lang) => {
        currentLang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if(i18nData[lang][key]) el.textContent = i18nData[lang][key];
        });
        document.getElementById('lang-ja').classList.toggle('active', lang === 'ja');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        
        // å¸¸ã«ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºã«æˆ»ã™
        renderGameCategories();
    };

    window.toggleRanking = () => {
        const rModal = document.getElementById('ranking-modal');
        const list = document.getElementById('ranking-list');
        rModal.style.display = 'flex';
        list.innerHTML = '';
        let users = JSON.parse(localStorage.getItem(USER_KEY) || '{}');
        let sorted = Object.keys(users).map(k => ({name: k, pt: users[k].points || 0})).sort((a,b) => b.pt - a.pt).slice(0,5);
        sorted.forEach((u, i) => {
            const icon = i===0 ? 'ğŸ¥‡' : i===1 ? 'ğŸ¥ˆ' : i===2 ? 'ğŸ¥‰' : `${i+1}.`;
            list.innerHTML += `<li style="padding:10px; border-bottom:1px dashed #ccc; font-weight:bold;">${icon} ${u.name} <span style="float:right; color:#f0ad4e;">${u.pt}pt</span></li>`;
        });
    };

    // åˆæœŸåŒ–
    updateUI();
    renderGameCategories();
</script>
</body>
</html>