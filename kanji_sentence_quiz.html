<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¼¢å­—ãƒ»æ–‡ç« ã‚¯ã‚¤ã‚º - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

<style>
    /* --- å…±é€šè¨­å®š --- */
    :root {
        --primary: #42a5f5;
        --primary-dark: #1565c0;
        --accent: #ffca28;
        --bg-color: #f0f4f8;
        --text-color: #333;
        --correct: #4caf50;
        --wrong: #f44336;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0; padding-bottom: 80px;
        min-height: 100vh;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
        background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        color: white; padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 15px rgba(66, 165, 245, 0.3);
        position: sticky; top: 0; z-index: 100;
    }
    .logo { font-size: 1.2em; font-weight: 900; display: flex; gap: 10px; align-items: center; color: white; text-decoration: none; }
    .btn-home {
        background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
        color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer;
        font-size: 0.9em; font-weight: bold; text-decoration: none;
    }

    /* --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
    .screen { display: none; padding: 20px; max-width: 800px; margin: 0 auto; animation: fadeIn 0.3s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 1. æ–‡ç« ä¸€è¦§ãƒªã‚¹ãƒˆ --- */
    .list-header { text-align: center; margin-bottom: 20px; }
    .list-title { font-size: 1.5em; font-weight: 900; color: var(--primary-dark); margin: 0; }
    .list-desc { color: #666; font-size: 0.9em; }

    .sentence-list { display: flex; flex-direction: column; gap: 15px; }
    .list-item {
        background: white; border-radius: 15px; padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: flex-start; gap: 15px;
        border-left: 5px solid var(--primary);
    }
    .play-icon-btn {
        background: #e3f2fd; color: var(--primary); border: none; width: 40px; height: 40px;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        cursor: pointer; font-size: 1.2em; flex-shrink: 0;
    }
    .play-icon-btn:active { background: var(--primary); color: white; }
    .item-text { flex-grow: 1; font-weight: bold; font-size: 1.1em; line-height: 1.6; }
    .item-en { display: block; font-size: 0.8em; color: #888; font-weight: normal; margin-top: 5px; }
    
    ruby { ruby-position: over; }
    rt { font-size: 0.6em; color: #999; }

    /* --- å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ --- */
    .fixed-footer {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; padding: 15px 20px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        display: flex; justify-content: center; z-index: 200;
    }
    .btn-start-game {
        background: linear-gradient(135deg, #ffca28 0%, #ff6f00 100%);
        color: white; border: none; padding: 15px 60px;
        border-radius: 50px; font-size: 1.4em; font-weight: 900;
        cursor: pointer; box-shadow: 0 4px 15px rgba(255, 111, 0, 0.4);
        width: 100%; max-width: 400px;
        transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-start-game:active { transform: scale(0.98); }

    /* --- 2. ãƒ¬ãƒ™ãƒ«é¸æŠ --- */
    .level-grid { display: grid; gap: 20px; padding: 20px 0; }
    .level-card {
        background: white; border-radius: 20px; padding: 20px;
        display: flex; align-items: center; gap: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer;
        transition: transform 0.2s; border: 2px solid transparent;
    }
    .level-card:active { transform: scale(0.98); background: #fafafa; }
    .lvl-badge {
        background: var(--primary); color: white; width: 60px; height: 60px;
        border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        font-weight: 900; line-height: 1;
    }
    .lvl-badge span:first-child { font-size: 0.8em; }
    .lvl-badge span:last-child { font-size: 1.8em; }
    .lvl-info h3 { margin: 0; font-size: 1.3em; color: #444; }
    .lvl-info p { margin: 5px 0 0; color: #777; font-size: 0.9em; }

    /* --- 3. ã‚²ãƒ¼ãƒ ç”»é¢ --- */
    .progress-area {
        margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #555;
    }
    .progress-bar {
        flex-grow: 1; height: 10px; background: #bbdefb; margin: 0 15px; border-radius: 5px; overflow: hidden;
    }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

    .question-card {
        background: white; border-radius: 20px; padding: 30px 20px;
        text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px; position: relative; min-height: 200px; display: flex; flex-direction: column; justify-content: center;
    }
    .sentence-box { font-size: 1.4em; line-height: 1.8; font-weight: bold; color: #444; text-align: left; }
    
    /* ä¼šè©±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .context-line { color: #888; font-size: 0.9em; margin-bottom: 10px; border-left: 3px solid #ddd; padding-left: 10px; }
    .current-line { color: #333; font-weight: 900; }

    .blank-part {
        display: inline-block; padding: 0 5px; border-bottom: 3px solid var(--primary);
        color: var(--primary); min-width: 60px; text-align: center; transition: all 0.3s;
    }
    .blank-part.solved { border-bottom-color: var(--correct); color: var(--correct); transform: scale(1.1); }
    .english-hint { font-size: 0.9em; color: #888; margin-top: 15px; font-weight: normal; border-top: 1px dashed #eee; padding-top: 10px; }

    .choices-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .choice-btn {
        background: white; border: 2px solid #ddd; border-radius: 15px;
        padding: 15px 5px; font-size: 2em; font-weight: 900; color: #555;
        cursor: pointer; box-shadow: 0 4px 0 #ccc; transition: transform 0.1s;
    }
    .choice-btn:active { transform: translateY(4px); box-shadow: none; }
    .choice-btn.correct { background: var(--correct); color: white; border-color: var(--correct); box-shadow: 0 4px 0 #2e7d32; }
    .choice-btn.wrong { background: var(--wrong); color: white; border-color: var(--wrong); box-shadow: 0 4px 0 #c62828; opacity: 0.6; }

    .feedback-overlay {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 8em; font-weight: 900; opacity: 0; pointer-events: none;
        text-shadow: 0 0 20px rgba(255,255,255,0.8); z-index: 10;
    }
    @keyframes popMark { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1); } }

    /* --- 4. çµæœç”»é¢ --- */
    .result-content { text-align: center; background: white; border-radius: 20px; padding: 40px 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .score-large { font-size: 4em; color: var(--primary); font-weight: 900; }
    .btn-restart {
        background: var(--primary); color: white; border: none; padding: 15px 40px;
        border-radius: 30px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px;
        box-shadow: 0 4px 0 #1565c0;
    }

</style>
</head>
<body>

<header>
    <a href="index.html" class="logo"><i class="fa-solid fa-pen-fancy"></i> æ¼¢å­—ãƒ»æ–‡ç« ã‚¯ã‚¤ã‚º</a>
    <a href="index.html" class="btn-home">ãƒ›ãƒ¼ãƒ </a>
</header>

<div id="view-list" class="screen active">
    <div class="list-header">
        <h2 class="list-title"><i class="fa-solid fa-book-open"></i> æ–‡ç« ãƒªã‚¹ãƒˆ</h2>
        <p class="list-desc">éŸ³å£°ã‚’ãã„ã¦ã€æ¼¢å­—ã‚’è¦šãˆã‚ˆã†ï¼</p>
    </div>
    <div id="study-list-container" class="sentence-list">
        </div>
    <div style="height: 60px;"></div>
</div>

<div id="footer-bar" class="fixed-footer">
    <button class="btn-start-game" onclick="showLevelSelect()">
        <i class="fa-solid fa-gamepad"></i> ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
    </button>
</div>

<div id="view-level" class="screen">
    <h2 style="text-align:center; color:#555;">ãƒ¬ãƒ™ãƒ«ã‚’ãˆã‚‰ã‚“ã§ã­</h2>
    <div class="level-grid">
        <div class="level-card" onclick="startGame(1)">
            <div class="lvl-badge" style="background:#4caf50;"><span>Lv.</span><span>1</span></div>
            <div class="lvl-info">
                <h3>ãŸã‚“ã¶ã‚“ (1æ–‡)</h3>
                <p>çŸ­ã„æ–‡ç« ã®ç·´ç¿’ã§ã™ã€‚</p>
            </div>
        </div>
        <div class="level-card" onclick="startGame(2)">
            <div class="lvl-badge" style="background:#2196f3;"><span>Lv.</span><span>2</span></div>
            <div class="lvl-info">
                <h3>A-B ã‹ã„ã‚</h3>
                <p>ãµãŸã‚Šã®ä¼šè©±ã§ã™ã€‚</p>
            </div>
        </div>
        <div class="level-card" onclick="startGame(3)">
            <div class="lvl-badge" style="background:#ff9800;"><span>Lv.</span><span>3</span></div>
            <div class="lvl-info">
                <h3>A-B-C ã‹ã„ã‚</h3>
                <p>3äººã®ä¼šè©±ãƒ»ç‰©èªã§ã™ã€‚</p>
            </div>
        </div>
        <div class="level-card" style="opacity:0.6; cursor:not-allowed;">
            <div class="lvl-badge" style="background:#9e9e9e;"><span>Lv.</span><span>4</span></div>
            <div class="lvl-info">
                <h3>ã‚‚ã£ã¨ã¡ã‚‡ã†ã¶ã‚“</h3>
                <p>(ã˜ã‚…ã‚“ã³ã¡ã‚…ã†)</p>
            </div>
        </div>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <button onclick="showList()" style="background:none; border:none; color:#777; text-decoration:underline; cursor:pointer;">ãƒªã‚¹ãƒˆã«ã‚‚ã©ã‚‹</button>
    </div>
</div>

<div id="view-game" class="screen">
    <div class="progress-area">
        <button onclick="quitGame()" style="background:none; border:none; color:#999; font-size:0.9em;"><i class="fa-solid fa-arrow-left"></i> ã‚‚ã©ã‚‹</button>
        <span style="flex-grow:1; text-align:center;">Q.<span id="q-num">1</span></span>
        <span><span id="score">0</span>pt</span>
    </div>
    <div style="padding:0 20px;"><div class="progress-bar"><div id="prog-bar" class="progress-fill"></div></div></div>
    <br>

    <div class="question-card">
        <div id="feedback" class="feedback-overlay"></div>
        <div class="sentence-box" id="sentence-display"></div>
        <div class="english-hint" id="english-display"></div>
    </div>

    <div class="choices-grid" id="choices-container"></div>
</div>

<div id="view-result" class="screen">
    <div class="result-content">
        <h2>ã‘ã£ã‹ ã¯ã£ã´ã‚‡ã†ï¼</h2>
        <div class="score-large"><span id="final-score">0</span><span style="font-size:0.4em;">/100</span></div>
        <p id="result-comment" style="font-size:1.2em; margin:20px 0; color:#555;">...</p>
        <button class="btn-restart" onclick="showLevelSelect()">ãƒ¬ãƒ™ãƒ«ã›ã‚“ãŸã</button>
        <br><br>
        <button onclick="showList()" style="background:none; border:none; color:#777; text-decoration:underline; cursor:pointer;">ãƒªã‚¹ãƒˆã«ã‚‚ã©ã‚‹</button>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;

    function speak(text, onFinished) {
        if (synth.speaking) synth.cancel();
        const cleanText = text.replace(/<rt>.*?<\/rt>/g, '').replace(/<[^>]*>/g, '');
        const utterThis = new SpeechSynthesisUtterance(cleanText);
        utterThis.lang = 'ja-JP';
        utterThis.rate = 1.0; 
        utterThis.onend = () => { if (onFinished) onFinished(); };
        utterThis.onerror = () => { if (onFinished) onFinished(); };
        synth.speak(utterThis);
    }

    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const level1Data = [
        { pre: "<ruby>æœ<rt>ã‚ã•</rt></ruby>ã”<ruby>é£¯<rt>ã¯ã‚“</rt></ruby>ã‚’", reading: "ãŸ", target: "é£Ÿ", post: "ã¹ã¾ã—ãŸã€‚", wrong1: "é£²", wrong2: "è¦‹", en: "I ate breakfast." },
        { pre: "<ruby>æ˜ ç”»<rt>ãˆã„ãŒ</rt></ruby>ã‚’", reading: "ã¿", target: "è¦‹", post: "ã¾ã™ã€‚", wrong1: "è²", wrong2: "ç›®", en: "I watch a movie." },
        { pre: "<ruby>å›³æ›¸é¤¨<rt>ã¨ã—ã‚‡ã‹ã‚“</rt></ruby>ã§<ruby>æœ¬<rt>ã»ã‚“</rt></ruby>ã‚’", reading: "ã‚ˆ", target: "èª­", post: "ã¿ã¾ã™ã€‚", wrong1: "èª", wrong2: "è©±", en: "I read a book at the library." },
        { pre: "<ruby>éŠ€è¡Œ<rt>ãã‚“ã“ã†</rt></ruby>ã¸", reading: "ã„", target: "è¡Œ", post: "ãã¾ã™ã€‚", wrong1: "ä¼‘", wrong2: "æ¥", en: "I go to the bank." },
        { pre: "<ruby>çˆç²<rt>ã‚³ãƒ¼ãƒ’ãƒ¼</rt></ruby>ã‚’", reading: "ã®", target: "é£²", post: "ã¿ã¾ã™ã€‚", wrong1: "é£Ÿ", wrong2: "é£¯", en: "I drink coffee." },
        { pre: "ãã‚‡ã†ã¯", reading: "ã‚ã‚", target: "é›¨", post: "ã§ã™ã­ã€‚", wrong1: "é›ª", wrong2: "å¤©", en: "It is rainy today, isn't it?" },
        { pre: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§", reading: "ã‹", target: "è²·", post: "ã„ã‚‚ã®ã‚’ã—ã¾ã™ã€‚", wrong1: "è¦‹", wrong2: "è²", en: "I shop at the supermarket." },
        { pre: "<ruby>ä»•äº‹<rt>ã—ã”ã¨</rt></ruby>ã‚’", reading: "ã‚„ã™", target: "ä¼‘", post: "ã¿ã¾ã™ã€‚", wrong1: "ä½“", wrong2: "æœ¬", en: "I take a day off work." },
        { pre: "<ruby>éŸ³æ¥½<rt>ãŠã‚“ãŒã</rt></ruby>ã‚’", reading: "ã", target: "è", post: "ãã¾ã™ã€‚", wrong1: "é–“", wrong2: "è€³", en: "I listen to music." },
        { pre: "<ruby>æ‰‹ç´™<rt>ã¦ãŒã¿</rt></ruby>ã‚’", reading: "ã‹", target: "æ›¸", post: "ãã¾ã™ã€‚", wrong1: "èª­", wrong2: "å¤", en: "I write a letter." },
        { pre: "<ruby>å½¼<rt>ã‹ã‚Œ</rt></ruby>ã¯ã€Œã„ã„ãˆã€ã¨", reading: "ã„", target: "è¨€", post: "ã„ã¾ã—ãŸã€‚", wrong1: "èª", wrong2: "å£", en: "He said 'No'." },
        { pre: "ã“ã‚Œã¯100", reading: "ãˆã‚“", target: "å††", post: "ã§ã™ã€‚", wrong1: "å£", wrong2: "å›", en: "This is 100 yen." },
        { pre: "ã‚ãªãŸã®", reading: "ãª", target: "å", post: "<ruby>å‰<rt>ã¾ãˆ</rt></ruby>ã¯ãªã‚“ã§ã™ã‹ã€‚", wrong1: "å¤š", wrong2: "å¤•", en: "What is your name?" },
        { pre: "ã‚ãã“ã«", reading: "ã‹ã‚", target: "å·", post: "ãŒã‚ã‚Šã¾ã™ã€‚", wrong1: "ä¸‰", wrong2: "å±±", en: "There is a river over there." },
        { pre: "<ruby>å³<rt>ã¿ã</rt></ruby>ã®", reading: "ã‚ã—", target: "è¶³", post: "ãŒ<ruby>ç—›<rt>ã„ãŸ</rt></ruby>ã„ã§ã™ã€‚", wrong1: "å£", wrong2: "èµ°", en: "My right leg hurts." }
    ];

    // Lv2: A-Bä¼šè©±ã‚»ãƒƒãƒˆ (ã‚°ãƒ«ãƒ¼ãƒ—åŒ–)
    // 1ã¤ã®é…åˆ—ã®ä¸­ã«ã€Œä¼šè©±ã®æµã‚Œã€é †ã«å•é¡Œã‚’å…¥ã‚Œã‚‹
    const level2Groups = [
        [ // Conversation 1 (Lunch)
            { pre: "ãŠãªã‹ãŒ <ruby>ç©º<rt>ã™</rt></ruby>ãã¾ã—ãŸã­ã€‚<ruby>ä½•<rt>ãªã«</rt></ruby>", reading: "ã˜", target: "æ™‚", post: "ã§ã™ã‹ã€‚", wrong1: "åˆ†", wrong2: "å¯º", en: "I'm hungry. What time is it?", role: "A" },
            { pre: "12æ™‚ã§ã™ã€‚<ruby>æ˜¼<rt>ã²ã‚‹</rt></ruby>ã”<ruby>é£¯<rt>ã¯ã‚“</rt></ruby>ã‚’", reading: "ãŸ", target: "é£Ÿ", post: "ã¹ã¾ã—ã‚‡ã†ã€‚", wrong1: "é£²", wrong2: "è¦‹", en: "It's 12 o'clock. Let's eat lunch.", role: "B", prev: "A: ãŠãªã‹ãŒ ã™ãã¾ã—ãŸã­ã€‚ä½•æ™‚ã§ã™ã‹ã€‚" }
        ],
        [ // Conversation 2 (Weather)
            { pre: "ä»Šæ—¥ã¯", reading: "ã¦ã‚“", target: "å¤©", post: "<ruby>æ°—<rt>ã</rt></ruby>ãŒ ã„ã„ã§ã™ã­ã€‚", wrong1: "å¤§", wrong2: "å¤«", en: "The weather is nice today.", role: "A" },
            { pre: "ãã†ã§ã™ã­ã€‚<ruby>å¤–<rt>ãã¨</rt></ruby>ã«", reading: "ã„", target: "è¡Œ", post: "ãã¾ã—ã‚‡ã†ã€‚", wrong1: "ä¼‘", wrong2: "æ¥", en: "That's right. Let's go outside.", role: "B", prev: "A: ä»Šæ—¥ã¯ å¤©æ°—ãŒ ã„ã„ã§ã™ã­ã€‚" }
        ],
        [ // Conversation 3 (Name)
            { pre: "ã‚ãªãŸã®", reading: "ãª", target: "å", post: "<ruby>å‰<rt>ã¾ãˆ</rt></ruby>ã¯ ä½•ã§ã™ã‹ã€‚", wrong1: "å¤•", wrong2: "å¤š", en: "What is your name?", role: "A" },
            { pre: "<ruby>ç”°<rt>ãŸ</rt></ruby>", reading: "ãªã‹", target: "ä¸­", post: "ã§ã™ã€‚ã‚ˆã‚ã—ããŠ<ruby>é¡˜<rt>ã­ãŒ</rt></ruby>ã„ã—ã¾ã™ã€‚", wrong1: "å£", wrong2: "æ—¥", en: "I am Tanaka. Nice to meet you.", role: "B", prev: "A: ã‚ãªãŸã® åå‰ã¯ ä½•ã§ã™ã‹ã€‚" }
        ],
        [ // Conversation 4 (Book)
            { pre: "ã“ã® <ruby>æœ¬<rt>ã»ã‚“</rt></ruby>ã¯", reading: "ãªã‚“", target: "ä½•", post: "ã§ã™ã‹ã€‚", wrong1: "ä¼º", wrong2: "åŒ", en: "What is this book?", role: "A" },
            { pre: "ãã‚Œã¯ <ruby>æ—¥æœ¬<rt>ã«ã»ã‚“</rt></ruby>ã®", reading: "ãã‚‹ã¾", target: "è»Š", post: "ã® <ruby>æœ¬<rt>ã»ã‚“</rt></ruby>ã§ã™ã€‚", wrong1: "æ±", wrong2: "é€£", en: "That is a book about Japanese cars.", role: "B", prev: "A: ã“ã® æœ¬ã¯ ä½•ã§ã™ã‹ã€‚" }
        ],
        [ // Conversation 5 (Sick)
            { pre: "<ruby>é¡”è‰²<rt>ã‹ãŠã„ã‚</rt></ruby>ãŒ", reading: "ã‚ã‚‹", target: "æ‚ª", post: "ã„ã§ã™ã­ã€‚", wrong1: "äºœ", wrong2: "è¥¿", en: "You look pale.", role: "A" },
            { pre: "ã¯ã„ã€ä»Šæ—¥ã¯ <ruby>ä¼šç¤¾<rt>ã‹ã„ã—ã‚ƒ</rt></ruby>ã‚’", reading: "ã‚„ã™", target: "ä¼‘", post: "ã¿ã¾ã™ã€‚", wrong1: "ä½“", wrong2: "æ¥", en: "Yes, I will take a day off today.", role: "B", prev: "A: é¡”è‰²ãŒ æ‚ªã„ã§ã™ã­ã€‚" }
        ]
    ];

    // Lv3: A-B-Cä¼šè©±ã‚»ãƒƒãƒˆ (ã‚°ãƒ«ãƒ¼ãƒ—åŒ–)
    const level3Groups = [
        [ // Conversation 1 (Mountain)
            { pre: "ç§ã¯ <ruby>æ—¥æœ¬<rt>ã«ã»ã‚“</rt></ruby>ã®", reading: "ã‚„ã¾", target: "å±±", post: "ãŒ <ruby>å¥½<rt>ã™</rt></ruby>ãã§ã™ã€‚", wrong1: "å‡º", wrong2: "å·", en: "I like Japanese mountains.", role: "A" },
            { pre: "<ruby>æ—¥æ›œæ—¥<rt>ã«ã¡ã‚ˆã†ã³</rt></ruby>ã« <ruby>çˆ¶<rt>ã¡ã¡</rt></ruby>ã¨", reading: "ã„", target: "è¡Œ", post: "ãã¾ã—ãŸã€‚", wrong1: "ä¼‘", wrong2: "æ¥", en: "I went with my father on Sunday.", role: "B", prev: "A: ç§ã¯ æ—¥æœ¬ã® å±±ãŒ å¥½ãã§ã™ã€‚" },
            { pre: "ãŸãã•ã‚“ <ruby>æ­©<rt>ã‚ã‚‹</rt></ruby>ãã¾ã—ãŸã€‚ã¨ã¦ã‚‚", reading: "ãŸã®", target: "æ¥½", post: "ã—ã‹ã£ãŸã§ã™ã€‚", wrong1: "è–¬", wrong2: "æ±", en: "We walked a lot. It was very fun.", role: "C", prev: "A: ç§ã¯ æ—¥æœ¬ã® å±±ãŒ å¥½ãã§ã™ã€‚<br>B: æ—¥æ›œæ—¥ã« çˆ¶ã¨ è¡Œãã¾ã—ãŸã€‚" }
        ],
        [ // Conversation 2 (Cooking)
            { pre: "ç§ã®", reading: "ã¯ã¯", target: "æ¯", post: "ã¯ <ruby>æ–™ç†<rt>ã‚Šã‚‡ã†ã‚Š</rt></ruby>ãŒ <ruby>ä¸Šæ‰‹<rt>ã˜ã‚‡ã†ãš</rt></ruby>ã§ã™ã€‚", wrong1: "æ¯", wrong2: "æµ·", en: "My mother is good at cooking.", role: "A" },
            { pre: "<ruby>æ¯æ—¥<rt>ã¾ã„ã«ã¡</rt></ruby> ãŠã„ã—ã„ ã”<ruby>é£¯<rt>ã¯ã‚“</rt></ruby>ã‚’", reading: "ã¤ã", target: "ä½œ", post: "ã‚Šã¾ã™ã€‚", wrong1: "æ˜¨", wrong2: "ä¼‘", en: "She makes delicious meals every day.", role: "B", prev: "A: ç§ã® æ¯ã¯ æ–™ç†ãŒ ä¸Šæ‰‹ã§ã™ã€‚" },
            { pre: "ç§ã¯ ã„ã¤ã‚‚ ãŸãã•ã‚“", reading: "ãŸ", target: "é£Ÿ", post: "ã¹ã¾ã™ã€‚", wrong1: "é£²", wrong2: "è‰¯", en: "I always eat a lot.", role: "C", prev: "A: ç§ã® æ¯ã¯ æ–™ç†ãŒ ä¸Šæ‰‹ã§ã™ã€‚<br>B: æ¯æ—¥ ãŠã„ã—ã„ ã”é£¯ã‚’ ä½œã‚Šã¾ã™ã€‚" }
        ],
        [ // Conversation 3 (Train)
            { pre: "ãã®ã† <ruby>å‹<rt>ã¨ã‚‚</rt></ruby>ã ã¡ã«", reading: "ã‚", target: "ä¼š", post: "ã„ã¾ã—ãŸã€‚", wrong1: "ä»Š", wrong2: "åˆ", en: "I met a friend yesterday.", role: "A" },
            { pre: "ç§ãŸã¡ã¯ <ruby>é›»è»Š<rt>ã§ã‚“ã—ã‚ƒ</rt></ruby>ã§", reading: "ãˆã", target: "é§…", post: "ã¾ã§ <ruby>è¡Œ<rt>ã„</rt></ruby>ãã¾ã—ãŸã€‚", wrong1: "é¦¬", wrong2: "é¨“", en: "We went to the station by train.", role: "B", prev: "A: ãã®ã† å‹ã ã¡ã« ä¼šã„ã¾ã—ãŸã€‚" },
            { pre: "ãã“ã§ <ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ã„", reading: "ã¿ã›", target: "åº—", post: "ã‚’ <ruby>è¦‹<rt>ã¿</rt></ruby>ã¾ã—ãŸã€‚", wrong1: "åº„", wrong2: "åº«", en: "We saw a new shop there.", role: "C", prev: "A: ãã®ã† å‹ã ã¡ã« ä¼šã„ã¾ã—ãŸã€‚<br>B: ç§ãŸã¡ã¯ é›»è»Šã§ é§…ã¾ã§ è¡Œãã¾ã—ãŸã€‚" }
        ]
    ];

    // --- ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ•° ---
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let totalQuestions = 0;

    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        const footer = document.getElementById('footer-bar');
        if(id === 'view-list') footer.style.display = 'flex';
        else footer.style.display = 'none';
        
        window.scrollTo(0, 0);
    }

    // --- 1. æ–‡ç« ä¸€è¦§ç”Ÿæˆ ---
    function initList() {
        const container = document.getElementById('study-list-container');
        container.innerHTML = '';
        
        // ãƒªã‚¹ãƒˆç”¨ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«ã™ã‚‹ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚‚åˆ†è§£ï¼‰
        let allData = [...level1Data];
        level2Groups.forEach(grp => allData.push(...grp));
        level3Groups.forEach(grp => allData.push(...grp));
        
        allData.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            
            const fullHtml = `${q.pre}<span style="color:var(--primary);">${q.target}</span>${q.post}`;
            
            div.innerHTML = `
                <button class="play-icon-btn" onclick="playSentence(${idx})"><i class="fa-solid fa-volume-high"></i></button>
                <div class="item-text">
                    ${fullHtml}
                    <span class="item-en">${q.en}</span>
                </div>
            `;
            container.appendChild(div);
            q._tempId = idx; // å†ç”Ÿç”¨ã«IDä¿æŒ
        });
        
        showScreen('view-list');
    }

    // ä¸€è¦§ç”»é¢ã§ã®å†ç”Ÿ
    window.playSentence = function(idx) {
        let allData = [...level1Data];
        level2Groups.forEach(grp => allData.push(...grp));
        level3Groups.forEach(grp => allData.push(...grp));

        const q = allData[idx];
        const rawHtml = (q.pre + q.target + q.post);
        speak(rawHtml);
    };

    window.showList = function() { showScreen('view-list'); };
    window.showLevelSelect = function() { showScreen('view-level'); };

    // --- 3. ã‚²ãƒ¼ãƒ é–‹å§‹ ---
    window.startGame = function(level) {
        currentQuestions = [];
        
        if (level === 1) {
            // Level 1: å˜ç‹¬ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            let source = [...level1Data];
            source.sort(() => 0.5 - Math.random());
            currentQuestions = source.slice(0, 10);
        } 
        else if (level === 2) {
            // Level 2: ä¼šè©±ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã‹ã‚‰å±•é–‹
            let groups = [...level2Groups];
            groups.sort(() => 0.5 - Math.random());
            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é †ç•ªã«ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«è¿½åŠ ï¼ˆA->Bã®é †åºã¯ç¶­æŒï¼‰
            groups.forEach(grp => {
                currentQuestions.push(...grp);
            });
            // å…¨éƒ¨å‡ºã™ã¨å¤šã„ã®ã§ã€ä¾‹ãˆã°3ã‚°ãƒ«ãƒ¼ãƒ—åˆ†(6å•)ãªã©ã«åˆ¶é™ã—ã¦ã‚‚ã‚ˆã„ãŒã€ä»Šå›ã¯å…¨ã‚°ãƒ«ãƒ¼ãƒ—å‡ºé¡Œ
        } 
        else if (level === 3) {
            // Level 3: ä¼šè©±ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            let groups = [...level3Groups];
            groups.sort(() => 0.5 - Math.random());
            groups.forEach(grp => {
                currentQuestions.push(...grp);
            });
        }
        
        totalQuestions = currentQuestions.length;
        currentIndex = 0;
        score = 0;
        showScreen('view-game');
        updateUI();
        showQuestion();
    };

    window.quitGame = function() {
        showLevelSelect();
    };

    function updateUI() {
        document.getElementById('q-num').textContent = currentIndex + 1;
        const pointPerQ = Math.floor(100 / totalQuestions);
        document.getElementById('score').textContent = score * pointPerQ;
        
        const pct = ((currentIndex) / totalQuestions) * 100;
        document.getElementById('prog-bar').style.width = `${pct}%`;
    }

    function showQuestion() {
        updateUI();
        const q = currentQuestions[currentIndex];
        
        const sentenceDisplay = document.getElementById('sentence-display');
        const englishDisplay = document.getElementById('english-display');
        const choicesContainer = document.getElementById('choices-container');
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå‰ã®æ–‡ï¼‰ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
        let htmlContent = "";
        if (q.prev) {
            htmlContent += `<div class="context-line">${q.prev}</div>`;
        }
        
        // ç¾åœ¨ã®å•é¡Œæ–‡
        htmlContent += `<div class="current-line">${q.pre}<span id="blank-spot" class="blank-part">(${q.reading})</span>${q.post}</div>`;
        
        sentenceDisplay.innerHTML = htmlContent;
        englishDisplay.textContent = q.en;

        const choices = [q.target, q.wrong1, q.wrong2];
        choices.sort(() => 0.5 - Math.random());

        choicesContainer.innerHTML = '';
        choices.forEach(char => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = char;
            btn.onclick = () => checkAnswer(btn, char, q);
            choicesContainer.appendChild(btn);
        });
    }

    function checkAnswer(btn, selected, q) {
        const allBtns = document.querySelectorAll('.choice-btn');
        allBtns.forEach(b => b.disabled = true);
        const feedback = document.getElementById('feedback');

        const isCorrect = (selected === q.target);
        
        if (isCorrect) {
            score++;
            btn.classList.add('correct');
            feedback.textContent = 'â­•';
            feedback.style.color = '#4caf50';
            
            const blank = document.getElementById('blank-spot');
            blank.textContent = q.target;
            blank.classList.add('solved');
        } else {
            btn.classList.add('wrong');
            feedback.textContent = 'âŒ';
            feedback.style.color = '#f44336';
            allBtns.forEach(b => { if(b.textContent === q.target) b.classList.add('correct'); });
            
            const blank = document.getElementById('blank-spot');
            blank.textContent = q.target; 
            blank.style.color = '#f44336';
        }

        feedback.style.animation = 'none';
        feedback.offsetHeight; 
        feedback.style.animation = 'popMark 0.6s ease';

        // èª­ã¿ä¸Šã’ -> æ¬¡ã¸
        const fullSentenceHtml = q.pre + q.target + q.post;
        
        setTimeout(() => {
            speak(fullSentenceHtml, () => {
                setTimeout(() => {
                    currentIndex++;
                    if (currentIndex < totalQuestions) {
                        showQuestion();
                    } else {
                        endGame();
                    }
                }, 500);
            });
        }, 500);
    }

    function endGame() {
        showScreen('view-result');
        // ç°¡æ˜“ã‚¹ã‚³ã‚¢è¨ˆç®—
        const pointPerQ = Math.floor(100 / totalQuestions);
        const finalScore = score * pointPerQ;
        // 100ç‚¹ã«ãªã‚‰ãªã„å ´åˆã®ç«¯æ•°å‡¦ç†ï¼ˆæº€ç‚¹ãªã‚‰100ã«ã™ã‚‹ï¼‰
        const displayScore = (score === totalQuestions) ? 100 : finalScore;
        
        document.getElementById('final-score').textContent = displayScore;
        
        const comment = document.getElementById('result-comment');
        if(displayScore === 100) comment.textContent = "ã™ã°ã‚‰ã—ã„ï¼ã‹ã‚“ãºãã§ã™ï¼ğŸ‰";
        else if(displayScore >= 80) comment.textContent = "ã™ã”ã„ï¼ãã®ã¡ã‚‡ã†ã—ã§ã™ï¼âœ¨";
        else comment.textContent = "ã¾ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã­ã€‚ğŸ’ª";
    }

    // åˆæœŸåŒ–
    window.onload = initList;

</script>
</body>
</html>