<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>どうしゲーム - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
<style>
        /* --- Common Settings --- */
        :root {
            --primary: #5c7aff;
            --accent: #ffcc5c;
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
            z-index: 100;
        }
        .header-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-container h1 {
            margin: 0;
            font-size: 1.4em;
            color: white;
        }
        .home-link {
            text-decoration: none;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .home-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Main Container --- */
        .main-container {
            flex-grow: 1;
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- Card Design --- */
        #dv-container-card {
            width: 100%;
            padding: 30px; 
            background-color: #ffffff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            border-radius: 25px; 
            border: 4px solid white; 
            animation: dv-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes dv-pop-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1.0); opacity: 1; }
        }

        .dv-screen { display: none; }
        .dv-screen.active { display: block; }

        h1, h2 { text-align: center; color: var(--primary); }
        h1 { font-size: 2.2em; margin-bottom: 20px; }
        h2 { font-size: 1.8em; margin-bottom: 20px; }
        p { text-align: center; font-size: 1.1em; color: #666; }

        /* --- Icons & Animations --- */
        .game-icon {
            font-size: 5em;
            color: var(--text-color);
            transition: transform 0.3s;
        }
        /* CSS Animations for Verbs */
        @keyframes eatAnim { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(10deg); } }
        @keyframes drinkAnim { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-5px) rotate(-20deg); } }
        @keyframes sleepAnim { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes walkAnim { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-5deg); } 75% { transform: translateX(5px) rotate(5deg); } }
        @keyframes listenAnim { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .anim-eat { animation: eatAnim 1s infinite ease-in-out; }
        .anim-drink { animation: drinkAnim 1.5s infinite ease-in-out; }
        .anim-sleep { animation: sleepAnim 3s infinite ease-in-out; }
        .anim-walk { animation: walkAnim 1s infinite linear; }
        .anim-listen { animation: listenAnim 0.8s infinite ease-in-out; }


        /* --- Buttons --- */
        .dv-button {
            display: block; width: 90%; margin: 15px auto; padding: 20px; 
            font-size: 1.5em; font-weight: 700; color: #fff; border: none; 
            border-radius: 15px; cursor: pointer; box-shadow: 0 6px 0 rgba(0,0,0,0.15); 
            transition: all 0.1s ease-out; position: relative; top: 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }
        .dv-button:active { top: 4px; box-shadow: 0 2px 0 rgba(0,0,0,0.15); }

        #dv-menu-game1 { background-color: #66bb6a; box-shadow: 0 6px 0 #388e3c; }
        #dv-menu-game1:active { box-shadow: 0 2px 0 #388e3c; }
        #dv-menu-game2 { background-color: #ffa726; box-shadow: 0 6px 0 #f57c00; }
        #dv-menu-game2:active { box-shadow: 0 2px 0 #f57c00; }
        #dv-menu-game3 { background-color: #4fc3f7; box-shadow: 0 6px 0 #0288d1; }
        #dv-menu-game3:active { box-shadow: 0 2px 0 #0288d1; }

        .dv-button-secondary {
             background-color: #90a4ae; box-shadow: 0 4px 0 #546e7a;
             font-size: 1.1em; padding: 10px 15px; width: 180px; margin-top: 25px;
             border-radius: 10px; display: inline-flex; justify-content: center;
             align-items: center; gap: 8px; border: none; color: white;
             font-weight: bold; cursor: pointer; position: relative; top: 0;
        }
        .dv-button-secondary:active { box-shadow: 0 2px 0 #546e7a; top: 4px; }

        .dv-feedback {
            text-align: center; font-size: 1.3em; font-weight: bold;
            margin-top: 20px; min-height: 1.3em; color: var(--incorrect-color); 
            opacity: 0; transition: opacity 0.2s;
        }
        .dv-feedback.show { opacity: 1; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dv-feedback.success { color: var(--correct-color); } 
        @keyframes popIn { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }


        /* --- Game 1 (Action) --- */
        #dv-game1-icon-area {
            width: 90%; height: 150px; margin: 10px auto;
            background: #f1f8e9; border: 3px dashed #c5e1a5; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
        }
        #dv-game1-play-btn {
            font-size: 1.2em; background: var(--primary); color: white;
            border: none; padding: 10px 20px; border-radius: 50px;
            cursor: pointer; box-shadow: 0 4px 0 #3f51b5; margin-bottom: 10px;
        }
        #dv-game1-play-btn:active { transform: translateY(4px); box-shadow: none; }

        #dv-game1-options {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;
        }
        .dv-game1-option-card {
            border: 4px solid var(--accent); border-radius: 15px; padding: 20px 10px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff;
            transition: all 0.2s; text-align: center; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 120px;
        }
        .dv-game1-option-card:hover { transform: scale(1.03); background-color: #fff8e1; }
        .dv-game1-option-card i { font-size: 3em; color: #555; margin-bottom: 10px; }
        .dv-game1-option-card.disabled { opacity: 0.5; pointer-events: none; }


        /* --- Game 2 (Tense - Improved) --- */
        #dv-game2-container {
            width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .dv-game2-context-box {
            width: 90%; padding: 15px; border-radius: 15px;
            text-align: center; font-weight: bold; font-size: 1.5em;
            border: 4px solid; position: relative; background: white;
        }
        .dv-game2-context-box.future {
            border-color: #4fc3f7; color: #0288d1; background: #e1f5fe;
        }
        .dv-game2-context-box.past {
            border-color: #ffb74d; color: #ef6c00; background: #fff3e0;
        }
        .dv-game2-arrow { font-size: 2em; margin: 10px 0; color: #999; }
        
        #dv-game2-main-icon {
            font-size: 4em; color: #555; margin: 10px;
            padding: 20px; background: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #dv-game2-options {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 10px;
        }
        .dv-game2-option-button {
            padding: 20px; font-size: 1.2em;
            background-color: var(--primary); box-shadow: 0 6px 0 #3f51b5;
        }
        .dv-game2-option-button.correct { background-color: var(--correct-color); box-shadow: 0 6px 0 #388e3c; }
        .dv-game2-option-button.incorrect { background-color: var(--incorrect-color); box-shadow: 0 6px 0 #c62828; }


        /* --- Game 3 (Sentence) --- */
        #dv-game3-drop-zone {
            display: flex; justify-content: center; align-items: center;
            min-height: 80px; background: #e3f2fd; border: 3px dashed #90caf9;
            border-radius: 10px; padding: 10px; margin: 10px auto; width: 95%;
        }
        #dv-game3-particle { font-size: 2em; font-weight: bold; margin: 0 5px; color: var(--primary); }
        .dv-game3-slot {
            flex: 1; height: 70px; border: 3px dashed #ccc; border-radius: 8px;
            background: #f5f5f5; display: flex; justify-content: center; align-items: center;
        }
        .dv-game3-card-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            min-height: 60px; border: 2px solid #eee; border-radius: 10px; padding: 10px; margin-top: 5px;
        }
        .dv-game3-card {
            padding: 10px 15px; font-size: 1.1em; font-weight: bold;
            background-color: #fff; border: 3px solid #00b87a; color: #008a5e;
            border-radius: 10px; cursor: pointer; box-shadow: 0 3px 5px rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 5px;
        }
        .dv-game3-card i { font-size: 1.2em; }
        .dv-game3-slot .dv-game3-card {
            width: 100%; height: 100%; justify-content: center;
            border: none; background: transparent; box-shadow: none;
        }
        .dv-game3-card[data-type="noun"] { border-color: #4fc3f7; color: #0288d1; }
        .dv-game3-card[data-type="verb"] { border-color: #81c784; color: #388e3c; }

</style>
</head>
<body>

    <header>
        <div class="header-container">
            <h1>どうしゲーム</h1>
            <a href="index.html" class="home-link"><i class="fa-solid fa-house"></i> ホームへ</a>
        </div>
    </header>

    <div class="main-container">
        <div id="dv-container-card">

            <div id="dv-screen-menu" class="dv-screen active">
                <h1>どうしゲーム</h1>
                <p>音(おと)も イラストも 新しくなったよ！</p>
                <button id="dv-menu-game1" class="dv-button"><i class="fa-solid fa-ear-listen"></i> 1. アクション (きく)</button>
                <button id="dv-menu-game2" class="dv-button"><i class="fa-solid fa-calendar-days"></i> 2. いま？ むかし？</button>
                <button id="dv-menu-game3" class="dv-button"><i class="fa-solid fa-shapes"></i> 3. ぶん を つくる</button>
            </div>

            <div id="dv-screen-game1" class="dv-screen">
                <h2>1. アクション (きく)</h2>
                <p>ボタンをおして、きこえた アクション を えらぼう！</p>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button id="dv-game1-play-btn" onclick="playCurrentGame1Sound()"><i class="fa-solid fa-volume-high"></i> もういちど きく</button>
                </div>
                
                <div id="dv-game1-options"></div>
                
                <div id="dv-game1-feedback" class="dv-feedback"></div>
                <div style="text-align: center;">
                    <button class="dv-button-secondary dv-back-to-menu"><i class="fa-solid fa-arrow-left"></i> もどる</button>
                </div>
            </div>

            <div id="dv-screen-game2" class="dv-screen">
                <h2>2. いま？ むかし？</h2>
                <p>「あした」は "ます"、「きのう」は "ました"！</p>

                <div id="dv-game2-container">
                    <div id="dv-game2-context" class="dv-game2-context-box">
                        <i class="fa-solid fa-calendar-check"></i> <span id="dv-game2-time-text"></span>
                    </div>

                    <div class="dv-game2-arrow"><i class="fa-solid fa-arrow-down"></i></div>

                    <div id="dv-game2-main-icon-container">
                        <i id="dv-game2-main-icon" class="fa-solid fa-question"></i>
                    </div>

                    <div id="dv-game2-options">
                        <button id="dv-game2-option1" class="dv-button dv-game2-option-button"></button>
                        <button id="dv-game2-option2" class="dv-button dv-game2-option-button"></button>
                    </div>
                </div>

                <div id="dv-game2-feedback" class="dv-feedback"></div>
                <div style="text-align: center;">
                    <button class="dv-button-secondary dv-back-to-menu"><i class="fa-solid fa-arrow-left"></i> もどる</button>
                </div>
            </div>

            <div id="dv-screen-game3" class="dv-screen">
                <h2>3. ぶん を つくる</h2>
                <p>カードを おして、ただしい ぶん を つくろう！</p>

                <div id="dv-game3-drop-zone">
                    <div id="dv-game3-slot-noun" class="dv-game3-slot"></div>
                    <span id="dv-game3-particle">を</span>
                    <div id="dv-game3-slot-verb" class="dv-game3-slot"></div>
                </div>

                <p style="margin-top: 15px; font-size: 0.9em; font-weight: bold; color: #0288d1;">【めいし (Noun)】</p>
                <div id="dv-game3-card-container-noun" class="dv-game3-card-container"></div>
                
                <p style="margin-top: 5px; font-size: 0.9em; font-weight: bold; color: #388e3c;">【どうし (Verb)】</p>
                <div id="dv-game3-card-container-verb" class="dv-game3-card-container"></div>

                <button id="dv-game3-check-button" class="dv-button" style="background:#5c7aff;">できた！</button>
                <div id="dv-game3-feedback" class="dv-feedback"></div>
                <div style="text-align: center;">
                    <button class="dv-button-secondary dv-back-to-menu"><i class="fa-solid fa-arrow-left"></i> もどる</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Point System ---
            const GAME_ID_VERB = 'verb_game'; 
            const USER_STORAGE_KEY_VERB = 'user_accounts'; 
            const SESSION_STORAGE_KEY_VERB = 'current_user'; 
            const GUEST_NAME_VERB = 'ゲスト'; 

            let gameTimer = null; 

            function getTodayDateString() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            }

            function checkAndAwardPoints(gameType, verbId) {
                const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY_VERB);
                if (!currentUser || currentUser === GUEST_NAME_VERB) return "guest"; 

                const usersJson = localStorage.getItem(USER_STORAGE_KEY_VERB);
                let users = usersJson ? JSON.parse(usersJson) : {};
                let user = users[currentUser];
                if (!user) return "error"; 

                const today = getTodayDateString();
                const progressKey = `${GAME_ID_VERB}_${gameType}_${verbId}`;

                user.progress = user.progress || {};
                user.progress[progressKey] = user.progress[progressKey] || {};

                if (user.progress[progressKey][today] === true) return "already_scored"; 

                user.points = (user.points || 0) + 1;
                user.progress[progressKey][today] = true;
                users[currentUser] = user;
                localStorage.setItem(USER_STORAGE_KEY_VERB, JSON.stringify(users));
                return "scored"; 
            }

            // ----------------------------------------------------
            // Data Definitions (No external images/audio)
            // ----------------------------------------------------
            // icon: FontAwesome classes
            // animation: CSS animation class defined in style
            const verbData = [
                { id: 'tabemasu', masu: 'たべます', mashita: 'たべました', icon: 'fa-solid fa-bowl-rice', animation: 'anim-eat', noun: 'ごはん', nounIcon: 'fa-solid fa-bowl-rice' },
                { id: 'nomimasu', masu: 'のみます', mashita: 'のみました', icon: 'fa-solid fa-mug-hot', animation: 'anim-drink', noun: 'ジュース', nounIcon: 'fa-solid fa-glass-water' },
                { id: 'nemasu', masu: 'ねます', mashita: 'ねました', icon: 'fa-solid fa-bed', animation: 'anim-sleep', noun: 'ベッド', nounIcon: 'fa-solid fa-bed' },
                { id: 'mimasu', masu: 'みます', mashita: 'みました', icon: 'fa-solid fa-tv', animation: 'anim-listen', noun: 'テレビ', nounIcon: 'fa-solid fa-tv' },
                { id: 'yomimasu', masu: 'よみます', mashita: 'よみました', icon: 'fa-solid fa-book-open', animation: 'anim-listen', noun: 'ほん', nounIcon: 'fa-solid fa-book' },
                { id: 'kakimasu', masu: 'かきます', mashita: 'かきました', icon: 'fa-solid fa-pen', animation: 'anim-eat', noun: 'え', nounIcon: 'fa-solid fa-image' },
                { id: 'kikimasu', masu: 'ききます', mashita: 'ききました', icon: 'fa-solid fa-headphones', animation: 'anim-listen', noun: 'おんがく', nounIcon: 'fa-solid fa-music' },
                { id: 'kaimasu', masu: 'かいます', mashita: 'かいました', icon: 'fa-solid fa-cart-shopping', animation: 'anim-walk', noun: 'おかし', nounIcon: 'fa-solid fa-cookie' },
                { id: 'ikimasu', masu: 'いきます', mashita: 'いきました', icon: 'fa-solid fa-person-walking', animation: 'anim-walk', noun: null, nounIcon: null },
                { id: 'kimasu', masu: 'きます', mashita: 'きました', icon: 'fa-solid fa-person-walking-arrow-right', animation: 'anim-walk', noun: null, nounIcon: null }
            ];

            // ----------------------------------------------------
            // Web Speech API (Browser Text-to-Speech)
            // ----------------------------------------------------
            function speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Stop previous
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ja-JP'; // Japanese
                    utterance.rate = 1.0; 
                    utterance.pitch = 1.0;
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn("Web Speech API not supported.");
                }
            }
            
            // Simple beep sounds for feedback (using Web Audio API or simple tone not needed, simply Speech for "Seikai"?)
            // Let's use Speech for feedback too to keep it asset-free.
            function speakFeedback(isCorrect) {
                if(isCorrect) speak("せいかい！");
                else speak("ちがうよ");
            }

            // ----------------------------------------------------
            // DOM & Logic
            // ----------------------------------------------------
            const screens = document.querySelectorAll('.dv-screen');
            const menuScreen = document.getElementById('dv-screen-menu');
            
            function showScreen(screen) {
                screens.forEach(s => s.classList.remove('active'));
                screen.classList.add('active');
            }

            function shuffle(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            // Setup Menu
            document.querySelectorAll('.dv-back-to-menu').forEach(btn => {
                btn.onclick = () => showScreen(menuScreen);
            });

            document.getElementById('dv-menu-game1').onclick = () => { setupGame1(); showScreen(document.getElementById('dv-screen-game1')); };
            document.getElementById('dv-menu-game2').onclick = () => { setupGame2(); showScreen(document.getElementById('dv-screen-game2')); };
            document.getElementById('dv-menu-game3').onclick = () => { setupGame3(); showScreen(document.getElementById('dv-screen-game3')); };

            // --- Game 1: Action (Listen) ---
            let game1Target = null;
            
            window.playCurrentGame1Sound = function() {
                if(game1Target) speak(game1Target.masu);
            }

            function setupGame1() {
                const optionsDiv = document.getElementById('dv-game1-options');
                const feedback = document.getElementById('dv-game1-feedback');
                optionsDiv.textContent = '';
                feedback.textContent = '';
                feedback.className = 'dv-feedback';

                const shuffled = shuffle([...verbData]);
                const choices = shuffled.slice(0, 4);
                game1Target = choices[Math.floor(Math.random() * choices.length)];

                // Play sound (Delayed slightly to allow screen transition)
                setTimeout(() => speak(game1Target.masu), 500);

                choices.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'dv-game1-option-card';
                    // Use FontAwesome Icon instead of Image
                    card.innerHTML = `<i class="${v.icon}"></i>`;
                    
                    card.onclick = () => {
                        if (v.id === game1Target.id) {
                            card.style.background = '#dcedc8';
                            card.innerHTML = `<i class="${v.icon} ${v.animation}"></i>`; // Add animation
                            feedback.textContent = 'せいかい！';
                            feedback.className = 'dv-feedback show success';
                            speakFeedback(true);
                            checkAndAwardPoints('game1', v.id);
                            setTimeout(setupGame1, 2000);
                        } else {
                            feedback.textContent = 'ちがうよ';
                            feedback.className = 'dv-feedback show';
                            speakFeedback(false);
                        }
                    };
                    optionsDiv.appendChild(card);
                });
            }

            // --- Game 2: Tense (Now vs Past) ---
            // Improved logic: Show "Tomorrow" or "Yesterday" context box
            let game2Target = null;
            let game2IsPast = false;

            function setupGame2() {
                const feedback = document.getElementById('dv-game2-feedback');
                feedback.textContent = '';
                feedback.className = 'dv-feedback';
                
                game2Target = verbData[Math.floor(Math.random() * verbData.length)];
                game2IsPast = Math.random() < 0.5;

                // Update Context Box
                const contextBox = document.getElementById('dv-game2-context');
                const timeText = document.getElementById('dv-game2-time-text');
                
                contextBox.className = 'dv-game2-context-box ' + (game2IsPast ? 'past' : 'future');
                // Explicit text prompt
                timeText.textContent = game2IsPast ? 'きのう (Past)' : 'あした (Future)';

                // Show Verb Icon
                const mainIcon = document.getElementById('dv-game2-main-icon');
                mainIcon.className = game2Target.icon; // Reset class
                
                // Setup Options
                const opt1 = document.getElementById('dv-game2-option1');
                const opt2 = document.getElementById('dv-game2-option2');
                
                // Shuffle order
                const isOrderNormal = Math.random() < 0.5;
                const txt1 = isOrderNormal ? game2Target.masu : game2Target.mashita;
                const txt2 = isOrderNormal ? game2Target.mashita : game2Target.masu;
                
                opt1.textContent = txt1;
                opt2.textContent = txt2;
                
                opt1.onclick = () => checkGame2(txt1, opt1);
                opt2.onclick = () => checkGame2(txt2, opt2);
                
                // Reset button styles
                opt1.className = 'dv-button dv-game2-option-button';
                opt2.className = 'dv-button dv-game2-option-button';
            }

            function checkGame2(selectedText, btn) {
                const correctText = game2IsPast ? game2Target.mashita : game2Target.masu;
                const feedback = document.getElementById('dv-game2-feedback');

                if (selectedText === correctText) {
                    btn.classList.add('correct');
                    feedback.textContent = 'せいかい！';
                    feedback.className = 'dv-feedback show success';
                    speak(correctText); // Speak the correct answer
                    checkAndAwardPoints('game2', game2Target.id);
                    setTimeout(setupGame2, 2000);
                } else {
                    btn.classList.add('incorrect');
                    feedback.textContent = 'ちがうよ';
                    feedback.className = 'dv-feedback show';
                    speakFeedback(false);
                }
            }

            // --- Game 3: Sentence Building ---
            function setupGame3() {
                const nounContainer = document.getElementById('dv-game3-card-container-noun');
                const verbContainer = document.getElementById('dv-game3-card-container-verb');
                const slotNoun = document.getElementById('dv-game3-slot-noun');
                const slotVerb = document.getElementById('dv-game3-slot-verb');
                const feedback = document.getElementById('dv-game3-feedback');
                const checkBtn = document.getElementById('dv-game3-check-button');

                nounContainer.textContent = '';
                verbContainer.textContent = '';
                slotNoun.textContent = '';
                slotVerb.textContent = '';
                feedback.textContent = '';
                feedback.className = 'dv-feedback';
                checkBtn.disabled = false;
                checkBtn.style.background = '#5c7aff';

                // Filter verbs that have nouns
                const availableVerbs = verbData.filter(v => v.noun);
                const shuffled = shuffle(availableVerbs).slice(0, 3); // Pick 3 random pairs

                const nounCards = [];
                const verbCards = [];

                shuffled.forEach(v => {
                    nounCards.push({ id: v.id, text: v.noun, icon: v.nounIcon, type: 'noun' });
                    verbCards.push({ id: v.id, text: v.masu, icon: v.icon, type: 'verb' });
                });

                shuffle(nounCards).forEach(data => createGame3Card(data, nounContainer));
                shuffle(verbCards).forEach(data => createGame3Card(data, verbContainer));

                checkBtn.onclick = () => {
                    const n = slotNoun.querySelector('.dv-game3-card');
                    const v = slotVerb.querySelector('.dv-game3-card');
                    if(!n || !v) {
                        feedback.textContent = 'カードを えらんでね';
                        feedback.className = 'dv-feedback show';
                        return;
                    }
                    if(n.dataset.id === v.dataset.id) {
                        feedback.textContent = 'せいかい！';
                        feedback.className = 'dv-feedback show success';
                        speak(n.textContent + "を" + v.textContent);
                        checkAndAwardPoints('game3', n.dataset.id);
                        setTimeout(setupGame3, 2500);
                    } else {
                        feedback.textContent = 'ちがうよ';
                        feedback.className = 'dv-feedback show';
                        speakFeedback(false);
                        // Return cards
                        nounContainer.appendChild(n);
                        verbContainer.appendChild(v);
                    }
                };
            }

            function createGame3Card(data, container) {
                const el = document.createElement('div');
                el.className = 'dv-game3-card';
                el.dataset.id = data.id;
                el.dataset.type = data.type;
                el.innerHTML = `<i class="${data.icon}"></i> ${data.text}`;
                
                el.onclick = () => {
                    // Move logic
                    const targetSlot = (data.type === 'noun') ? document.getElementById('dv-game3-slot-noun') : document.getElementById('dv-game3-slot-verb');
                    const originalContainer = (data.type === 'noun') ? document.getElementById('dv-game3-card-container-noun') : document.getElementById('dv-game3-card-container-verb');
                    
                    speak(data.text); // Speak card text on click

                    if(el.parentElement === targetSlot) {
                        originalContainer.appendChild(el); // Return
                    } else {
                        if(targetSlot.children.length > 0) {
                            originalContainer.appendChild(targetSlot.firstChild); // Swap
                        }
                        targetSlot.appendChild(el);
                    }
                };
                container.appendChild(el);
            }

        });
    </script>
</body>
</html>