<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>文法並び替えゲーム</title>
    
    <link rel="stylesheet" href="css/style.css"> 
    
    <link rel="stylesheet" href="css/sentence_puzzle.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0BX3DD42C1"></script>
    <script src="js/sentence_puzzle.js"></script>
    </head>
<body>
    
    <h1>文法並び替えパズル</h1>
    
    <div id="sp-game-main-container" class="container">
        
        <div id="auth-status-sentence">認証中...</div>

        <div id="sp-status-area">
            <p id="sp-score-display">正解数: 0 / 0 問</p>
            <h3 id="sp-question-text" class="sp-quiz-hint-text">文を正しく並び替えて完成させよう！</h3>
        </div>

        <div id="sp-puzzle-area">
            
            <div id="sp-drop-zone-container">
                <p class="sp-area-title">【答えを作る場所】</p>
                <div id="sp-drop-zone">
                    </div>
            </div>

            <div id="sp-english-translation-container">
                <p class="sp-area-title">【答えの英文】</p>
                <p id="sp-english-translation" style="font-size: 1.3em; color: #4CAF50; font-weight: bold; padding: 10px; border: 2px dashed #4CAF50; border-radius: 8px;">
                    Loading...
                </p>
            </div>
            <div id="sp-card-selection-area">
                <p class="sp-area-title">【使うカード】</p>
                <div id="sp-card-container">
                    </div>
            </div>
            
            <p id="sp-feedback-message" class="sp-quiz-feedback-message hidden">答えを選んでね！</p>

            <div id="sp-action-buttons" class="sp-game-controls-area">
                <button id="sp-reset-button" class="sp-action-button sp-secondary">リセット</button>
                <button id="sp-check-button" class="sp-action-button sp-primary">答え合わせ</button>
            </div>
            </div>

        <div style="margin-top: 30px;">
             <a href="index.html" class="sp-action-button sp-tertiary">ホームに戻る</a>
        </div>
    </div>

    <script type="module" src="js/firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // ----------------------------------------------------
            // ★★★ Firebase連携ポイント設定 ★★★
            // ----------------------------------------------------
            // モジュールで定義した関数のフォールバック
            if (typeof window.addPointsToUser !== 'function') {
                window.addPointsToUser = async () => { return false; };
            }
            const POINTS_PER_QUESTION = 1;

            // ----------------------------------------------------
            // DOM要素と定数の定義
            // ----------------------------------------------------
            const DATA_PATH = 'data/sentence_data.json';

            const dropZone = document.getElementById('sp-drop-zone');
            const cardContainer = document.getElementById('sp-card-container');
            const checkButton = document.getElementById('sp-check-button');
            const resetButton = document.getElementById('sp-reset-button');
            const feedbackMessage = document.getElementById('sp-feedback-message');
            const questionText = document.getElementById('sp-question-text');
            const scoreDisplay = document.getElementById('sp-score-display');
            const englishTranslation = document.getElementById('sp-english-translation');

            const SOUND_CORRECT_PATH = 'assets/sounds/seikai.mp3'; 
            const SOUND_INCORRECT_PATH = 'assets/sounds/bubu.mp3'; 
            
            let allTemplates = [];         
            let wordPool = {};             
            let currentCorrectParts = [];
            let currentTemplate = null; 
            let score = 0;
            let totalQuestions = 0;
            let currentQuestionIndex = 0;

            // ----------------------------------------------------
            // 初期化とデータ読み込み
            // ----------------------------------------------------

            async function initializeGame() {
                try {
                    const response = await fetch(DATA_PATH);
                    const data = await response.json();
                    
                    allTemplates = shuffleArray(data.templates); 
                    wordPool = data.word_pool;
                    totalQuestions = allTemplates.length;

                    if (totalQuestions === 0) {
                        questionText.textContent = "エラー: 問題テンプレートがありません。";
                        return;
                    }

                    checkButton.addEventListener('click', checkAnswer);
                    resetButton.addEventListener('click', resetPuzzle);
                    
                    startNewQuestion();
                } catch (error) {
                    console.error("データの読み込みまたはゲーム初期化に失敗しました:", error);
                    questionText.textContent = "エラー: ゲームを開始できませんでした。ファイルパスを確認してください。";
                }
            }

            /**
             * 新しい問題を出題する
             */
            function startNewQuestion() {
                if (currentQuestionIndex >= totalQuestions) {
                    endGame();
                    return;
                }

                currentTemplate = allTemplates[currentQuestionIndex]; 
                const { japaneseParts, englishText } = generateRandomSentence(currentTemplate);
                currentCorrectParts = japaneseParts; 

                // 1. UIをリセット
                dropZone.textContent = '';
                cardContainer.textContent = '';
                feedbackMessage.classList.add('hidden');
                feedbackMessage.className = 'sp-quiz-feedback-message hidden'; 
                checkButton.disabled = false;
                resetButton.disabled = false;
                
                // 2. 問題情報を表示
                questionText.textContent = `ヒント: ${currentTemplate.hint}`;
                englishTranslation.textContent = englishText; 
                updateScoreDisplay();

                // 3. カードを生成し、シャッフルして配置
                const shuffledParts = shuffleArray([...japaneseParts]);
                
                shuffledParts.forEach((part, index) => {
                    const card = document.createElement('div');
                    card.textContent = part; 
                    card.classList.add('puzzle-card'); 
                    
                    card.dataset.id = `${part}-${index}-${currentQuestionIndex}`; 
                    cardContainer.appendChild(card);
                });
                
                // 4. クリックイベントを設定
                setupCardEvents();
            }

            /**
             * 文型テンプレートと単語プールからランダムな文と英文を生成する
             */
            function generateRandomSentence(template) {
                const japaneseParts = [];
                let englishText = template.english; 
                const replacements = [];

                template.pattern.forEach(partKey => {
                    if (partKey.startsWith('P_') || partKey.startsWith('N_') || partKey.startsWith('A_') || partKey.startsWith('V_')) {
                        const pool = wordPool[partKey];
                        
                        if (pool && pool.length > 0) {
                            const randomItem = pool[Math.floor(Math.random() * pool.length)];
                            japaneseParts.push(randomItem.japanese);
                            replacements.push({ 
                                placeholder: `(${partKey})`, 
                                replacement: randomItem.english 
                            });
                        } else {
                            japaneseParts.push("[エラー]"); 
                        }
                    } else {
                        japaneseParts.push(partKey);
                    }
                });
                
                replacements.forEach(item => {
                    englishText = englishText.replace(item.placeholder, item.replacement);
                });
                
                englishText = englishText.replace(/\(N_[^\)]+\)|\(A_[^\)]+\)|\(V_[^\)]+\)|\(P_[^\)]+\)/g, '');
                
                if (!englishText.match(/[.!?]$/)) {
                    englishText += '.';
                }

                return { japaneseParts, englishText: englishText.trim() };
            }

            // ----------------------------------------------------
            // イベント設定とクリック処理
            // ----------------------------------------------------
            
            function setupCardEvents() {
                document.querySelectorAll('.puzzle-card').forEach(card => {
                    card.addEventListener('click', handleCardClick); 
                });
            }

            function handleCardClick(e) {
                const clickedCard = e.target.closest('.puzzle-card');
                if (!clickedCard) return;

                if (clickedCard.classList.contains('correct-slot')) {
                    return;
                }

                if (clickedCard.parentNode === dropZone) {
                    cardContainer.appendChild(clickedCard);
                    clickedCard.classList.remove('wrong-slot');
                } 
                else {
                    dropZone.appendChild(clickedCard);
                }
                
                feedbackMessage.classList.add('hidden');
            }

            // ----------------------------------------------------
            // 正誤判定とゲーム制御 (asyncに変更)
            // ----------------------------------------------------

            async function checkAnswer() {
                checkButton.disabled = true;
                resetButton.disabled = true;
                
                const droppedCards = [...dropZone.querySelectorAll('.puzzle-card')];
                
                if (droppedCards.length !== currentCorrectParts.length) {
                    displayFeedback(false, `❌ カードの数が違います。（${currentCorrectParts.length}枚必要です）`);
                    checkButton.disabled = false;
                    resetButton.disabled = false;
                    return;
                }

                let isCorrect = true;
                
                droppedCards.forEach((card, index) => {
                    const correctWord = currentCorrectParts[index];
                    
                    if (card.textContent === correctWord) {
                        card.classList.add('correct-slot');
                        card.classList.remove('wrong-slot');
                    } else {
                        card.classList.add('wrong-slot');
                        card.classList.remove('correct-slot');
                        isCorrect = false;
                    }
                });

                if (isCorrect) {
                    playSound(SOUND_CORRECT_PATH); 
                    
                    // ★★★ Firebaseポイント加算 ★★★
                    // IDがない場合のフォールバックとして英文を使用
                    const pointKey = currentTemplate.id || currentTemplate.english;
                    const result = await window.addPointsToUser(POINTS_PER_QUESTION, pointKey);
                    
                    let msg = `🎉 素晴らしい！正解です。`;
                    if (result) {
                        msg += ' (+1 ポイント！)';
                    }
                    // ★★★★★★★★★★★★★★★★★★★★★★★

                    score++;
                    currentQuestionIndex++;
                    displayFeedback(true, msg);
                    
                    setTimeout(startNewQuestion, 2000);
                    
                } else {
                    playSound(SOUND_INCORRECT_PATH); 
                    displayFeedback(false, `🤔 残念、並び順が違います。カードをクリックして戻すか、リセットして再挑戦！`);
                    checkButton.disabled = false;
                    resetButton.disabled = false;
                }
            }

            function resetPuzzle() {
                const cardsToMove = [...dropZone.querySelectorAll('.puzzle-card')];
                
                cardsToMove.forEach(card => {
                    cardContainer.appendChild(card);
                    card.classList.remove('correct-slot', 'wrong-slot');
                });
                
                dropZone.textContent = '';
                displayFeedback(false, `パズルをリセットしました。`);
                feedbackMessage.className = 'sp-quiz-feedback-message hidden';
                checkButton.disabled = false;
                resetButton.disabled = false;
            }

            function displayFeedback(isCorrect, message) {
                feedbackMessage.textContent = message;
                feedbackMessage.classList.remove('hidden'); 
                feedbackMessage.classList.remove('feedback-correct', 'feedback-incorrect');
                
                if (isCorrect) {
                    feedbackMessage.classList.add('feedback-correct');
                } else {
                    feedbackMessage.classList.add('feedback-incorrect');
                }
            }

            function updateScoreDisplay() {
                scoreDisplay.textContent = `正解数: ${score} / ${totalQuestions} 問`;
            }

            function endGame() {
                playSound(SOUND_CORRECT_PATH); 
                questionText.textContent = `🎉 ゲームクリア！`;
                englishTranslation.textContent = `おめでとうございます！`;
                dropZone.textContent = '';
                cardContainer.textContent = '';
                checkButton.disabled = true;
                resetButton.disabled = true;
                displayFeedback(true, `全問終了！最終スコアは ${score} 点です。`);
            }

            // ----------------------------------------------------
            // ユーティリティ
            // ----------------------------------------------------
            
            function playSound(path) {
                const audio = new Audio(path);
                audio.play().catch(e => console.error("音声再生エラー:", e));
            }

            function shuffleArray(array) {
                let newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            // ゲーム開始
            initializeGame();
        });
    </script>
    </body>
</html>