<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カタカナ単語あわせゲーム</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        /* （元のスタイルをそのまま利用） */
        body {
            font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #f0f8ff 0%, #cce7ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        #km-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 30px; 
            background-color: #ffffff;
            box-shadow: 0 8px 24px rgba(0, 91, 179, 0.15); 
            border-radius: 20px; 
            border: none; 
        }

        #km-container h1 {
            text-align: center;
            color: #005bb5;
            font-weight: 800; 
            font-size: 2.5em; 
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
        }
        
        #km-container h2 {
            text-align: center;
            color: #5c7aff;
        }

        /* --- レベル選択 --- */
        #km-level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        /* レベルボタン */
        #km-level-selection button {
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 5px solid rgba(0,0,0,0.15);
        }
        #km-level-selection button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        #km-level-selection button:active {
            transform: scale(1.0) translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        #km-level-selection button:nth-child(5n+1) { background-color: #ff6b6b; } /* 赤 */
        #km-level-selection button:nth-child(5n+2) { background-color: #feca57; } /* 黄 */
        #km-level-selection button:nth-child(5n+3) { background-color: #48dbfb; } /* 水色 */
        #km-level-selection button:nth-child(5n+4) { background-color: #1dd1a1; } /* 緑 */
        #km-level-selection button:nth-child(5n+5) { background-color: #ff9f43; } /* オレンジ */
        
        /* --- ゲームエリア (縦一列デザイン) --- */
        #km-game-area {
            display: flex;
            flex-direction: row; 
            gap: 20px;
        }
        #km-illust-area, #km-word-area {
            padding: 15px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
            border: 2px dashed #ccc; 
            min-height: 150px;
        }
        #km-illust-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #km-word-area {
            flex: 1;
        }
        #km-illust-pool {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        #km-illust-area h3, #km-word-area h3 {
            text-align: center; 
            margin-top: 0; 
            color: #555;
            width: 100%;
        }
        .km-drag-item {
            width: 100px; height: 100px; background-color: #fff;
            border: 2px solid #ddd; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab; margin: 5px; display: inline-flex;
            justify-content: center; align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;

            /* ▼▼▼ モバイル最適化のためのCSS ▼▼▼ */
            touch-action: none;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
            /* ▲▲▲ モバイル最適化のためのCSS ▲▲▲ */
        }
        
        .km-drag-item img {
            width: 90%; height: 90%; object-fit: contain;
        }
        .km-word-row {
            display: flex; align-items: center; margin-bottom: 10px;
            background-color: #fff; border-radius: 8px;
            border: 1px solid #ccc; padding: 5px;
        }
        .km-drop-target {
            width: 100px; height: 100px; border: 2px dashed #aaa;
            border-radius: 8px; background-color: #f0f8ff;
            margin-right: 15px; transition: background-color 0.2s, border-color 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .km-word-label {
            font-size: 1.8em; font-weight: bold; color: #333;
        }
        .km-drop-target.drag-over {
            background-color: #e6f7ff; border-color: #5c7aff; border-style: solid;
        }
        
        .km-drop-target.correct {
            border: 3px solid #28a745; background-color: #e6ffed; padding: 0;
        }
        
        /* 配置されたアイテムのスタイル (正解時) */
        .km-drop-target.correct .km-drag-item {
            width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; cursor: not-allowed;
        }
        
        /* 配置されたアイテムのスタイル (未判定時) */
        .km-drop-target .km-drag-item {
             width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; 
            cursor: pointer; 
        }
        
        /* タッチイベントで指に追随させるためのゴーストスタイル */
        .km-touch-ghost {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
            transform: scale(1.1);
        }


        #km-feedback {
            text-align: center; font-size: 1.3em; font-weight: bold;
            margin-top: 20px; min-height: 1.3em; color: #d9534f;
        }
        #km-feedback.success { color: #28a745; }

        /* --- ボタンエリア --- */
        .km-button-area {
            text-align: center;
            margin-top: 25px;
        }
        .km-button {
            display: inline-block;
            margin: 0 5px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 4px solid rgba(0,0,0,0.15);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .km-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .km-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        .km-button-home {
            background-color: #6c757d;
            border-bottom-color: #4a4e52;
        }
        .km-button-reset {
            background-color: #ffc107;
            color: #333;
            border-bottom-color: #c69500;
        }

        /* --- スマホ用の調整 --- */
        @media (max-width: 600px) {
            #km-container {
                padding: 15px;
            }
            #km-container h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            #km-level-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            #km-level-selection button {
                font-size: 1.2em;
                padding: 15px;
            }
            #km-game-area {
                flex-direction: row; 
                gap: 10px;
            }
            #km-illust-area, #km-word-area {
                padding: 5px; 
                min-height: 100px; 
            }
            #km-illust-area h3, #km-word-area h3 {
                font-size: 0.8em; 
                margin-bottom: 5px;
            }
            .km-drag-item {
                width: 60px; height: 60px; margin: 2px;
            }
            .km-drop-target {
                width: 60px; height: 60px; margin-right: 5px;
            }
            .km-word-label {
                font-size: 1.0em; 
            }
            .km-button {
                padding: 10px 15px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div id="km-container">
        <h1 id="km-main-title">カタカナ単語あわせゲーム</h1>
        
        <div id="km-level-selection">
            </div>

        <h2 id="km-level-title"></h2>
        
        <div id="km-game-area" style="display: none;">
            <div id="km-illust-area">
                <h3>イラスト (ドラッグしてね)</h3>
                <div id="km-illust-pool">
                    </div>
            </div>
            
            <div id="km-word-area">
                <h3>ことば (ドロップするばしょ)</h3>
                <div id="km-word-list">
                    </div>
            </div>
        </div>

        <div id="km-feedback"></div>

        <div class="km-button-area">
            <button id="km-reset-placed-button" class="km-button km-button-reset" style="display: none;">
                イラストをもどす
            </button>
            <button id="km-home-button" class="km-button km-button-home">ホームにもどる</button>
        </div>
    </div>

    <audio id="km-sound-correct" src="assets/sounds/seikai.mp3" preload="auto"></audio>
    <audio id="km-sound-incorrect" src="assets/sounds/bubu.mp3" preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. データ定義 ---
            const ILLUSTRATION_PATH_PREFIX = 'assets/images/katakana_words/'; 
            const ILLUSTRATION_PATH_SUFFIX = '.png'; 

            const gameLevels = [
                { level: 1, words: [ { hira: 'アイス', file: 'アイス' }, { hira: 'イヤホン', file: 'イヤホン' }, { hira: 'ウインナー', file: 'ウインナー' }, { hira: 'エプロン', file: 'エプロン' }, { hira: 'オムライス', file: 'オムライス' } ] },
                { level: 2, words: [ { hira: 'カレンダー', file: 'カレンダー' }, { hira: 'キャベツ', file: 'キャベツ' }, { hira: 'クレヨン', file: 'クレヨン' }, { hira: 'ケーキ', file: 'ケーキ' }, { hira: 'コップ', file: 'コップ' } ] },
                { level: 3, words: [ { hira: 'サッカー', file: 'サッカー' }, { hira: 'シャツ', file: 'シャツ' }, { hira: 'ストロー', file: 'ストロー' }, { hira: 'セーター', file: 'セーター' }, { hira: 'ソーダ', file: 'ソーダ' } ] },
                { level: 4, words: [ { hira: 'タオル', file: 'タオル' }, { hira: 'チョコ', file: 'チョコ' }, { hira: 'ツナ', file: 'ツナ' }, { hira: 'テント', file: 'テント' }, { hira: 'トナカイ', file: 'トナカイ' } ] },
                { level: 5, words: [ { hira: 'ナマズ', file: 'ナマズ' }, { hira: 'ニワトリ', file: 'ニワトリ' }, { hira: 'ヌードル', file: 'ヌードル' }, { hira: 'ネクタイ', file: 'ネクタイ' }, { hira: 'ノート', file: 'ノート' } ] },
                { level: 6, words: [ { hira: 'ハンガー', file: 'ハンガー' }, { hira: 'ヒトデ', file: 'ヒトデ' }, { hira: 'フグ', file: 'フグ' }, { hira: 'ヘルメット', file: 'ヘルメット' }, { hira: 'ホタテ', file: 'ホタテ' } ] },
                { level: 7, words: [ { hira: 'マフラー', file: 'マフラー' }, { hira: 'ミミズ', file: 'ミミズ' }, { hira: 'ムササビ', file: 'ムササビ' }, { hira: 'メダカ', file: 'メダカ' }, { hira: 'メモ', file: 'メモ' } ] },
                { level: 8, words: [ { hira: 'タイヤ', file: 'タイヤ' }, { hira: 'ユーフォー', file: 'ユーフォー' }, { hira: 'ヨーヨー', file: 'ヨーヨー' }, { hira: 'ワイン', file: 'ワイン' }, { hira: 'パン', file: 'パン' } ] },
                { level: 9, words: [ { hira: 'ラーメン', file: 'ラーメン' }, { hira: 'リュック', file: 'リュック' }, { hira: 'ルビー', file: 'ルビー' }, { hira: 'レタス', file: 'レタス' }, { hira: 'ロケット', file: 'ロケット' } ] }
            ];

            // --- 2. HTML要素の取得 ---
            const mainTitleEl = document.getElementById('km-main-title'); 
            const levelSelectionEl = document.getElementById('km-level-selection');
            const levelTitleEl = document.getElementById('km-level-title');
            const gameAreaEl = document.getElementById('km-game-area');
            const illustPoolEl = document.getElementById('km-illust-pool');
            const wordListEl = document.getElementById('km-word-list');
            const feedbackEl = document.getElementById('km-feedback');
            const resetPlacedButton = document.getElementById('km-reset-placed-button');
            const homeButton = document.getElementById('km-home-button'); 

            const soundCorrect = document.getElementById('km-sound-correct');
            const soundIncorrect = document.getElementById('km-sound-incorrect');


            let currentLevelData = null; 
            let currentLevelWords = [];

            // --- 3. ゲーム初期化 ---
            function initGame() {
                gameLevels.forEach(levelData => {
                    const button = document.createElement('button');
                    button.textContent = `レベル ${levelData.level}`;
                    button.onclick = () => loadLevel(levelData);
                    levelSelectionEl.appendChild(button);
                });
                
                homeButton.onclick = () => {
                    window.location.href = 'index.html'; 
                };
            }
            
            function showLevelSelect() {
                gameAreaEl.style.display = 'none';
                levelTitleEl.textContent = '';
                feedbackEl.textContent = '';
                resetPlacedButton.style.display = 'none';
                
                levelSelectionEl.style.display = 'grid'; 
                mainTitleEl.style.display = 'block';

                homeButton.onclick = () => {
                    window.location.href = 'index.html';
                };
            }

           // --- 4. レベル読み込み ---
function loadLevel(levelData) {
    levelSelectionEl.style.display = 'none';
    mainTitleEl.style.display = 'none';
    
    currentLevelData = levelData; 
    currentLevelWords = levelData.words;

    levelTitleEl.textContent = `レベル ${levelData.level} スタート！`;
    feedbackEl.textContent = '';
    feedbackEl.classList.remove('success');
    gameAreaEl.style.display = 'flex';
    
    resetPlacedButton.style.display = 'none';

    homeButton.onclick = () => showLevelSelect();

    illustPoolEl.innerHTML = '';
    wordListEl.innerHTML = '';

    const shuffledWords = shuffleArray([...currentLevelWords]);
    const shuffledIllusts = shuffleArray([...currentLevelWords]);

    // 4-1. 単語リスト（ドロップ先）を生成
    shuffledWords.forEach(wordData => {
        const row = document.createElement('div');
        row.className = 'km-word-row';
        const dropTarget = document.createElement('div');
        dropTarget.className = 'km-drop-target';
        dropTarget.dataset.word = wordData.hira; 
        dropTarget.id = `km-target-${wordData.hira}`; 
        
        const label = document.createElement('span');
        label.className = 'km-word-label';
        label.textContent = wordData.hira;
        row.appendChild(dropTarget);
        row.appendChild(label);
        wordListEl.appendChild(row);
    });

    // 4-2. イラストリスト（ドラッグアイテム）を生成
    shuffledIllusts.forEach(wordData => {
        const item = document.createElement('div');
        item.className = 'km-drag-item';
        
        // PCでドラッグできるように 'draggable = true'
        item.draggable = true;
        
        item.dataset.word = wordData.hira;
        item.id = `km-item-${wordData.hira}`; 
        item.dataset.initialParentId = 'km-illust-pool';
        
        const img = document.createElement('img');
        img.src = `${ILLUSTRATION_PATH_PREFIX}${wordData.file}${ILLUSTRATION_PATH_SUFFIX}`;
        img.alt = wordData.hira;
        img.draggable = false; 
        item.appendChild(img);
        illustPoolEl.appendChild(item);
    });

    // 4-3. イベントリスナーを設定
    addDragDropListeners();
}


// --- 5. ドラッグ＆ドロップのイベントリスナー設定 (PC/タッチ両対応版) ---

let ghostItem = null;      
let currentDragItem = null; 
let lastTouchTarget = null; 

function updateGhostPosition(touch) {
    if (!ghostItem) return;
    ghostItem.style.left = (touch.clientX - ghostItem.offsetWidth / 2) + 'px';
    ghostItem.style.top = (touch.clientY - ghostItem.offsetHeight / 2) + 'px';
}

/**
 * クリック/タップで配置済みアイテムを元に戻す処理
 */
function returnItemToPool(e) {
    // クリックされたアイテム（またはイベントターゲット）
    const item = e.currentTarget || e.target;
    if (!item || !item.classList.contains('km-drag-item')) return;

    const parent = item.parentElement;
    // 親がドロップターゲットなら、そのターゲットから除去
    if (parent && parent.classList.contains('km-drop-target')) {
        parent.removeChild(item);
        parent.classList.remove('drag-over');
        parent.classList.remove('correct');
    }
    // イラストプールへ戻す
    illustPoolEl.appendChild(item);

    // 状態を初期化
    item.style.opacity = '1';
    item.draggable = true;
    item.style.cursor = 'grab';
    // クリックで戻すイベントはプールに戻したら外しておく（既に付与されている場合）
    item.removeEventListener('click', returnItemToPool);

    // もしフィードバックが「まちがい」が出ているなら更新
    checkFinalAnswers();
}

function addDragDropListeners() {
    const dragItems = document.querySelectorAll('.km-drag-item');
    const dropTargets = document.querySelectorAll('.km-drop-target');
    
    // --- 1. PC/マウス イベント (標準の D&D API を使用) ---
    const transparentImage = new Image();
    transparentImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 

    dragItems.forEach(item => {
        // PCドラッグ開始
        item.addEventListener('dragstart', (e) => {
            // e.dataTransfer がない環境はガード
            try {
                e.dataTransfer.setData('text/plain', item.id);
                if (e.dataTransfer && e.dataTransfer.setDragImage) {
                    e.dataTransfer.setDragImage(transparentImage, 0, 0);
                }
            } catch (err) {
                // ignore
            }
            setTimeout(() => item.style.opacity = '0.5', 0);
        });

        item.addEventListener('dragend', (e) => {
            e.target.style.opacity = '1';
        });

        // クリックで戻す（配置後に付けるが、安全のためここでも外しておく）
        item.removeEventListener('click', returnItemToPool);

        // --- タッチ用イベント (※ passive:false にして preventDefault を効かせる) ---
        item.addEventListener('touchstart', (e) => {
            // すでにタッチドラッグ中なら無視
            if (currentDragItem) return;

            // タッチでのドラッグ開始 — ブラウザのデフォルト動作抑止
            if (e.cancelable) e.preventDefault();

            currentDragItem = item;
            // 保存して一時的にドラッグ不可に（mouseのエミュレートを防ぐ）
            item._wasDraggable = item.draggable;
            item.draggable = false;

            ghostItem = item.cloneNode(true);
            ghostItem.classList.add('km-touch-ghost'); 
            document.body.appendChild(ghostItem);

            item.style.opacity = '0.4';
            const touch = e.touches[0];
            updateGhostPosition(touch);

        }, { passive: false });

        // クリックで戻す（主に配置後に使うため、ここでは付けない。配置時に付与）
    });

    dropTargets.forEach(target => {
        target.addEventListener('dragover', (e) => {
            // 空きがないなら許可しない
            if (target.querySelector('.km-drag-item')) return;
            e.preventDefault();
            target.classList.add('drag-over');
        });
        target.addEventListener('dragleave', () => {
            target.classList.remove('drag-over');
        });
        target.addEventListener('drop', (e) => {
            e.preventDefault();
            target.classList.remove('drag-over');
            if (target.querySelector('.km-drag-item')) return;
            
            const dragItemId = (e.dataTransfer && e.dataTransfer.getData) ? e.dataTransfer.getData('text/plain') : null;
            const dragItem = dragItemId ? document.getElementById(dragItemId) : null;

            if (dragItem) {
                target.innerHTML = ''; 
                target.appendChild(dragItem);
                dragItem.draggable = false; 
                dragItem.addEventListener('click', returnItemToPool); // クリックで戻す機能を再設定
                dragItem.style.cursor = 'pointer';
                checkFinalAnswers();
            }
        });
    });

    // --- 2. タッチ イベント (ドキュメント全体で監視) ---
    document.addEventListener('touchmove', (e) => {
        if (!currentDragItem || !ghostItem) return;

        // タッチ移動中のスクロール防止
        if (e.cancelable) e.preventDefault();

        const touch = e.touches[0];
        updateGhostPosition(touch);

        // ghost非表示にして下の要素を判定する（ghostが要素を隠さないように）
        ghostItem.style.display = 'none'; 
        const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
        ghostItem.style.display = ''; 

        let currentTouchTarget = null;
        if (elementUnder && (elementUnder.classList.contains('km-drop-target') || elementUnder.parentElement?.classList.contains('km-drop-target'))) {
             currentTouchTarget = elementUnder.classList.contains('km-drop-target') ? elementUnder : elementUnder.parentElement;
        }

        if (lastTouchTarget && lastTouchTarget !== currentTouchTarget) {
            lastTouchTarget.classList.remove('drag-over');
        }
        if (currentTouchTarget && currentTouchTarget.classList.contains('km-drop-target') && !currentTouchTarget.querySelector('.km-drag-item')) {
            currentTouchTarget.classList.add('drag-over');
            lastTouchTarget = currentTouchTarget;
        } else {
            if (lastTouchTarget) lastTouchTarget.classList.remove('drag-over');
            lastTouchTarget = null;
        }

    }, { passive: false }); 

    document.addEventListener('touchend', (e) => {
        if (!currentDragItem || !ghostItem) return;

        // ドロップ先は最後に見つけたターゲット
        let dropTarget = lastTouchTarget; 
        
        if (dropTarget && !dropTarget.querySelector('.km-drag-item')) {
            // ドロップ成功
            dropTarget.classList.remove('drag-over');
            dropTarget.innerHTML = ''; 
            dropTarget.appendChild(currentDragItem); 
            
            currentDragItem.style.opacity = '1'; 
            currentDragItem.draggable = false; // 配置後はPCでもドラッグ不可にする
            currentDragItem.addEventListener('click', returnItemToPool); 
            currentDragItem.style.cursor = 'pointer';
            
            checkFinalAnswers();
            
        } else {
            // ドロップ失敗（元の場所に戻す）
            currentDragItem.style.opacity = '1'; 
            // もし元の親がプールであれば append し直す（通常は自動で残る）
            const initParent = document.getElementById(currentDragItem.dataset.initialParentId || 'km-illust-pool');
            if (initParent && !initParent.contains(currentDragItem)) {
                initParent.appendChild(currentDragItem);
            }
        }
        
        // 後片付け（ghost と状態復元）
        if (ghostItem && ghostItem.parentElement) {
            document.body.removeChild(ghostItem);
        }
        ghostItem = null;

        // タッチ開始時に一時的に変更した draggable を戻す
        if (currentDragItem && typeof currentDragItem._wasDraggable !== 'undefined') {
            currentDragItem.draggable = !!currentDragItem._wasDraggable;
            delete currentDragItem._wasDraggable;
        }

        currentDragItem = null;
        lastTouchTarget = null;
    });
}
// ▲▲▲ addDragDropListeners 関数ここまで ▲▲▲


            // --- 7. 最終判定ロジック ---
            function checkFinalAnswers() {
                const dropTargets = document.querySelectorAll('.km-drop-target');
                const totalTargets = currentLevelWords.length;
                let filledCount = 0;
                let allCorrect = true;

                dropTargets.forEach(target => {
                    if (target.querySelector('.km-drag-item')) {
                        filledCount++;
                    }
                });

                if (filledCount < totalTargets) {
                    feedbackEl.textContent = `あと ${totalTargets - filledCount} こ。`;
                    feedbackEl.classList.remove('success');
                    return; 
                }

                dropTargets.forEach(target => {
                    const placedItem = target.querySelector('.km-drag-item');
                    const targetWord = target.dataset.word;
                    const placedWord = placedItem.dataset.word;
                    
                    if (targetWord !== placedWord) {
                        allCorrect = false; 
                    }
                });

                if (allCorrect) {
                    // 正解時
                    try { soundCorrect.currentTime = 0; soundCorrect.play(); } catch (e) {}
                    
                    dropTargets.forEach(target => {
                         target.classList.add('correct');
                         const placedItem = target.querySelector('.km-drag-item');
                         if (placedItem) {
                             placedItem.removeEventListener('click', returnItemToPool);
                             placedItem.style.cursor = 'not-allowed'; 
                         }
                    });
                    
                    levelTitleEl.textContent = 'レベルクリア！';
                    feedbackEl.textContent = 'おめでとうございます！ぜんぶせいかい！';
                    feedbackEl.classList.add('success');
                    resetPlacedButton.style.display = 'none'; 
                    
                    const currentLevelIndex = gameLevels.findIndex(level => level.level === currentLevelData.level);
                    const nextLevelIndex = currentLevelIndex + 1;
                    
                    if (nextLevelIndex < gameLevels.length) {
                        const nextLevelData = gameLevels[nextLevelIndex];
                        levelTitleEl.textContent = `レベルクリア！ ${nextLevelData.level} にすすむよ！`;
                        setTimeout(() => {
                            loadLevel(nextLevelData);
                        }, 1200); 
                    } else {
                        levelTitleEl.textContent = 'ぜんぶクリア！';
                        feedbackEl.textContent = '全レベル おめでとうございます！';
                    }
                    
                } else {
                    // 間違いあり
                    try { soundIncorrect.currentTime = 0; soundIncorrect.play(); } catch (e) {}
                    
                    feedbackEl.textContent = 'ちがうところがあるよ。まちがっているイラストをクリックして、もどしてね。';
                    feedbackEl.classList.remove('success');
                }
            }

            // --- 8. ユーティリティ (配列シャッフル) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- 9. ゲーム開始 ---
            initGame();

        });
    </script>

</body>
</html>
