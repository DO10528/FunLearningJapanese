<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã²ã‚‰ãŒãªå˜èªã‚²ãƒ¼ãƒ  - FunLearnJP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS ã‚’èª­ã¿è¾¼ã¿ã¾ã™ (ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ«ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- ã‚«ãƒ©ãƒ¼è¨­å®š --- */
        :root {
            --primary: #5c7aff;
            --accent: #ffcc5c;
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3); z-index: 100;
        }
        .logo { font-size: 1.4em; font-weight: 900; display: flex; align-items: center; gap: 10px; color: white; text-decoration: none; }
        .home-icon { color: white; font-size: 1.5em; transition: transform 0.2s; }

        /* --- ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .main-container {
            flex-grow: 1; padding: 20px; max-width: 700px;
            margin: 0 auto; width: 100%; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: center;
        }

        /* --- ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .quiz-card {
            background: white; border-radius: 25px; padding: 30px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); text-align: center;
            border: 4px solid white; width: 100%; box-sizing: border-box;
        }

        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ --- */
        .menu-icon { font-size: 5em; color: #ff6f61; margin-bottom: 15px; animation: bounce 2s infinite; }
        .menu-title { font-size: 2em; color: var(--primary); margin: 0 0 10px 0; }
        .menu-desc { color: #666; margin-bottom: 20px; font-size: 1.1em; }
        .rule-box { background: #fff8e1; padding: 15px; border-radius: 15px; margin-bottom: 25px; color: #5d4037; }
        
        .start-btn {
            background: linear-gradient(to bottom, #5c7aff, #4b63cc);
            color: white; font-size: 1.6em; font-weight: 900;
            padding: 15px 50px; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 6px 0 #3f51b5;
            margin-bottom: 15px; display: inline-block; width: 80%; max-width: 300px;
        }
        .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #3f51b5; }
        .home-btn-text { color: #999; text-decoration: none; font-weight: bold; display: block; margin-top: 10px; }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ --- */
        .score-board {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 10px 20px;
            background: white; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-weight: bold; color: var(--primary);
        }

        .image-frame {
            width: 200px; height: 200px; margin: 0 auto 20px;
            background: #fffbea; border: 6px solid var(--accent);
            border-radius: 25px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .image-frame img { width: 90%; height: 90%; object-fit: contain; }
        
        .question-text { font-size: 1.4em; font-weight: bold; color: #444; margin-bottom: 20px; }

        /* --- é¸æŠè‚¢ã‚°ãƒªãƒƒãƒ‰ --- */
        .choices-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; margin-bottom: 20px;
        }

        .choice-btn {
            background-color: #ffffff; border: 3px solid #dce0e5; border-radius: 15px;
            color: #555; font-size: 1.3em; font-weight: 800;
            padding: 15px 5px; width: 100%; min-height: 70px;
            cursor: pointer; box-shadow: 0 4px 0 #cfd8dc; transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .choice-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: 0 6px 0 #cfd8dc; }
        .choice-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .choice-btn.correct { background-color: var(--correct-color); border-color: var(--correct-color); color: white; box-shadow: 0 4px 0 #2e7d32; }
        .choice-btn.incorrect { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: white; opacity: 0.6; box-shadow: none; }
        .choice-btn.disabled { pointer-events: none; }

        .feedback-area { min-height: 1.5em; margin-top: 10px; font-size: 1.3em; font-weight: 900; }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* â˜…â˜…â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
        #ranking-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000; 
            max-height: 90vh;
            overflow-y: auto;
            width: 90%; /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            max-width: 300px;
            transform: translateX(0); /* åˆæœŸä½ç½® */
            transition: transform 0.3s ease-out;
        }
        /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚ŒãŒã¡ãªã®ã§ã€å³ä¸Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        @media (max-width: 768px) {
            .main-container { padding-right: 20px; } 
            #ranking-panel {
                top: auto;
                bottom: 20px;
                right: 50%;
                transform: translateX(50%);
                width: 95%;
                max-width: 350px;
            }
        }

    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</a>
        <a href="index.html" class="home-icon"><i class="fa-solid fa-house"></i></a>
    </header>

    <div class="main-container">
        
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="quiz-menu-area" class="pop-in">
            <div class="quiz-card">
                <i class="fa-solid fa-shapes menu-icon"></i>
                <h1 class="menu-title">ã²ã‚‰ãŒãªå˜èª</h1>
                <p class="menu-desc">ãˆ ã‚’ ã¿ã¦ ãŸã ã—ã„ ã“ã¨ã° ã‚’ãˆã‚‰ã¼ã†ï¼</p>
                <div class="rule-box">
                    <div id="quiz-score-message">
                        ãœã‚“ã¶ã§ <strong>10ã‚‚ã‚“</strong> ã‚ã‚‹ã‚ˆã€‚<br>ãŒã‚“ã°ã£ã¦ ã‚¯ãƒªã‚¢ã—ã‚ˆã†ï¼
                    </div>
                    <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
                    <div id="auth-status" class="mt-3 text-sm font-medium text-indigo-700">èªè¨¼ä¸­...</div>
                </div>
                <button id="quizStartButton" class="start-btn" onclick="game.start()">
                    <i class="fa-solid fa-play"></i> ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <a href="index.html" class="home-btn-text">ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹</a>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="quiz-game-area" style="display:none;" class="pop-in">
            <div class="score-board">
                <span id="quiz-turn-message">å• 1 / 10</span>
                <span><i class="fa-solid fa-star" style="color:#f0ad4e;"></i> <span id="score-val">0</span></span>
            </div>
            <div class="quiz-card">
                <div id="quiz-image-area" class="image-frame">
                    <!-- ç”»åƒãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
                </div>
                <h3 id="quiz-question-text" class="question-text">ã“ã®ã‚¤ãƒ©ã‚¹ãƒˆã¯ã©ã‚Œã‹ãªï¼Ÿ</h3>
                <div id="choice-buttons-area" class="choices-grid">
                    <!-- ãƒœã‚¿ãƒ³ãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
                </div>
                <p id="quiz-feedback" class="feedback-area"></p>
                <div style="margin-top: 10px;">
                    <button onclick="location.reload()" style="background:none; border:none; color:#999; cursor:pointer; text-decoration:underline;">ã‚„ã‚ã‚‹</button>
                </div>
            </div>
        </div>

    </div>

    <!-- â˜…â˜…â˜… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ‘ãƒãƒ«ã‚’ã‚²ãƒ¼ãƒ ç”»é¢ã®å¤–ã«è¿½åŠ  â˜…â˜…â˜… -->
    <div id="ranking-panel" class="w-full max-w-xs bg-white rounded-xl shadow-2xl p-4 transition-transform duration-300 transform">
        
        <!-- åˆæœŸåŒ–ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="loading-overlay" class="rounded-xl">
            <div class="text-lg font-semibold text-gray-700">
                <svg class="animate-spin h-5 w-5 mr-3 inline text-indigo-500" viewBox="0 0 24 24">
                    <!-- SVG for spinner -->
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...
            </div>
        </div>

        <h2 class="text-xl font-bold mb-3 text-indigo-700 border-b pb-2">ğŸ† ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="my-score-card" class="bg-indigo-50 p-3 rounded-lg border border-indigo-200 mb-4 shadow-sm">
            <p class="text-sm font-medium text-indigo-600">ã‚ãªãŸã®ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="my-current-score" class="font-bold text-lg ml-2">---</span></p>
            <p class="text-xs text-indigo-400 mt-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="user-id-display">èª­ã¿è¾¼ã¿ä¸­...</span></p>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ -->
        <ul id="leaderboard-list" class="space-y-2">
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
            <li class="text-gray-500">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>
        </ul>
    </div>

    <!-- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« -->
    <audio id="snd-correct" src="assets/sounds/seikai.mp3"></audio>
    <audio id="snd-incorrect" src="assets/sounds/bubu.mp3"></audio>
    <audio id="snd-fanfare" src="assets/sounds/fanfare.mp3"></audio>

<!-- â˜…â˜…â˜… Firebase & ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜… -->
<script type="module">
    // Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, onSnapshot, orderBy, limit, serverTimestamp, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Firestoreã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    setLogLevel('debug');

    // â˜…â˜…â˜… ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨FirebaseåˆæœŸåŒ– â˜…â˜…â˜…
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // æ—¢å­˜ã®Firebaseè¨­å®šã‚’å„ªå…ˆã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šãŒã‚ã‚Œã°ãã‚Œã‚’ãƒ‘ãƒ¼ã‚¹
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebasestorage.app",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(defaultFirebaseConfig));
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app = null;
    let auth = null;
    let db = null;
    let currentUserId = null;
    let userDisplayName = null;
    const LEADERBOARD_COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard`;

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°UIè¦ç´ 
    const authStatusEl = document.getElementById('auth-status');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const leaderboardListEl = document.getElementById('leaderboard-list');
    const myCurrentScoreEl = document.getElementById('my-current-score');
    const loadingOverlayEl = document.getElementById('loading-overlay');

    let isConfigValid = true;

    if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
        console.error("Firebaseã®è¨­å®šæƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
        if(authStatusEl) authStatusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        if(loadingOverlayEl) loadingOverlayEl.style.display = 'none';
        isConfigValid = false;
    }

    if (isConfigValid) {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            initializeAuth(); // èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
        } catch (error) {
            console.error("FirebaseåˆæœŸåŒ–ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:", error);
            if(authStatusEl) authStatusEl.textContent = `è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ${error.message}`;
            if(loadingOverlayEl) loadingOverlayEl.style.display = 'none';
            isConfigValid = false;
        }
    }

    /**
     * èªè¨¼ã‚’åˆæœŸåŒ–ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚
     * await ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã€å‡¦ç†ãŒç¢ºå®Ÿã«å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
     */
    async function initializeAuth() {
        if (!isConfigValid) return;
        try {
            // setPersistenceã¯éåŒæœŸãªã®ã§awaitã‚’è¿½åŠ 
            await setPersistence(auth, browserSessionPersistence); 
            
            if (initialAuthToken) {
                // signInWithCustomTokenã¯éåŒæœŸãªã®ã§awaitã‚’è¿½åŠ 
                await signInWithCustomToken(auth, initialAuthToken); 
                console.log("ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
            } else {
                // signInAnonymouslyã¯éåŒæœŸãªã®ã§awaitã‚’è¿½åŠ 
                await signInAnonymously(auth); 
                console.log("åŒ¿åã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
            }
        } catch (error) {
            console.error("Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€UIã«ã‚‚è¡¨ç¤º
            if(authStatusEl) authStatusEl.textContent = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
    }

    onAuthStateChanged(auth, (user) => {
        // userãŒnullï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰ã®å ´åˆã§ã‚‚å®‰å…¨ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
        if (user) {
            currentUserId = user.uid;
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã®ä¸€éƒ¨ã‹ã‚‰ä½œæˆ
            userDisplayName = `Player_${user.uid.substring(0, 4)}`; 
            if(userIdDisplayEl) userIdDisplayEl.textContent = user.uid;
            if(authStatusEl) authStatusEl.textContent = `âœ… èªè¨¼æ¸ˆã¿: ${userDisplayName}`;
            
            startLeaderboardListener();
        } else {
            currentUserId = null;
            userDisplayName = null;
            if(userIdDisplayEl) userIdDisplayEl.textContent = 'æœªèªè¨¼';
            if(authStatusEl) authStatusEl.textContent = 'âŒ æœªèªè¨¼';
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ã‚‚ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’éš ã™
        }
        if(loadingOverlayEl) loadingOverlayEl.style.display = 'none'; 
    });


    /**
     * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚
     */
    function startLeaderboardListener() {
        if (!currentUserId || !db) return;

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€scoreã®ã¿ã§ä¸¦ã¹æ›¿ãˆã¾ã™ã€‚
        const leaderboardQuery = query(
            collection(db, LEADERBOARD_COLLECTION_PATH),
            orderBy('score', 'desc'),
            limit(10)
        );

        onSnapshot(leaderboardQuery, (snapshot) => {
            if(!leaderboardListEl) return;
            leaderboardListEl.innerHTML = ''; 

            if (snapshot.empty) {
                leaderboardListEl.innerHTML = '<li class="text-gray-500 p-2">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                return;
            }
            
            let myRank = -1;

            snapshot.forEach((docSnap, index) => {
                const data = docSnap.data();
                const rank = index + 1;
                const isCurrentUser = data.userId === currentUserId;

                if (isCurrentUser) {
                    myRank = rank;
                }

                const itemClass = isCurrentUser
                    ? 'bg-yellow-100 font-bold border-yellow-400'
                    : 'bg-white border-gray-200';
                
                const rankText = `<span class="font-extrabold w-6 text-center">${rank}.</span>`;
                const scoreText = `<span class="text-lg text-indigo-600 ml-auto">${data.score.toLocaleString()}</span>`;
                
                const listItem = `
                    <li class="flex items-center p-2 rounded-lg border shadow-sm ${itemClass}">
                        ${rankText}
                        <span class="ml-2 truncate">${data.username}</span>
                        ${scoreText}
                    </li>
                `;
                leaderboardListEl.innerHTML += listItem;
            });
            
            // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            const myDocRef = doc(db, LEADERBOARD_COLLECTION_PATH, currentUserId);
            getDoc(myDocRef).then(myDocSnap => {
                if (!myCurrentScoreEl) return;
                if (myDocSnap.exists()) {
                    myCurrentScoreEl.textContent = `${myDocSnap.data().score.toLocaleString()} (ç¾åœ¨ã®é †ä½: ${myRank !== -1 ? myRank : 'åœå¤–'})`;
                } else {
                    myCurrentScoreEl.textContent = 'ã‚¹ã‚³ã‚¢æœªç™»éŒ²';
                }
            }).catch(e => console.error("è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢å–å¾—ã‚¨ãƒ©ãƒ¼:", e));

        }, (error) => {
            console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            if(leaderboardListEl) leaderboardListEl.innerHTML = '<li class="text-red-500 p-2">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</li>';
        });
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’Firestoreã«é€ä¿¡ã—ã€ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     * @param {number} finalScore - ä»Šå›ã®ã‚²ãƒ¼ãƒ ã§ç²å¾—ã—ãŸã‚¹ã‚³ã‚¢ï¼ˆãƒã‚¤ã‚¹ã‚³ã‚¢ã§ã¯ãªã„ï¼‰ã€‚
     */
    async function submitScore(finalScore) {
        if (!currentUserId || !db) {
            console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ãªã„ã‹ã€DBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚³ã‚¢ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚");
            return;
        }

        const docRef = doc(db, LEADERBOARD_COLLECTION_PATH, currentUserId);
        
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€æ—¢å­˜ã®ã‚¹ã‚³ã‚¢ã‚ˆã‚Šã‚‚é«˜ã„å ´åˆã«ã®ã¿æ›´æ–°ã‚’ä¿è¨¼
        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);

                // æ—¢å­˜ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ (ãªã„å ´åˆã¯0)
                const currentHighScore = docSnap.exists() ? docSnap.data().score : 0;

                if (finalScore > currentHighScore) {
                    transaction.set(docRef, {
                        userId: currentUserId,
                        username: userDisplayName,
                        score: finalScore,
                        updatedAt: serverTimestamp(), // æœ€çµ‚æ›´æ–°æ—¥æ™‚
                    });
                    console.log(`ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${finalScore}`);
                } else if (!docSnap.exists()) {
                     // åˆå›ç™»éŒ²
                     transaction.set(docRef, {
                        userId: currentUserId,
                        username: userDisplayName,
                        score: finalScore,
                        updatedAt: serverTimestamp(),
                    });
                     console.log(`åˆå›ã‚¹ã‚³ã‚¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸ: ${finalScore}`);
                } else {
                    console.log(`ä»Šå›ã®ã‚¹ã‚³ã‚¢(${finalScore})ã¯ãƒã‚¤ã‚¹ã‚³ã‚¢(${currentHighScore})ã‚’è¶…ãˆã¾ã›ã‚“ã§ã—ãŸã€‚`);
                }
            });
        } catch (error) {
            console.error("ã‚¹ã‚³ã‚¢é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
        }
    }
    // --------------------------------------------------
    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ (ç”»åƒã¯assets/images/ã«ã‚ã‚‹å‰æ)
    // --------------------------------------------------
    const QUESTIONS = [
        { id: 'ahiru', img: 'assets/images/ahiru.png', ans: 'ã‚ã²ã‚‹', wrong: ['ã‚ã‚Š', 'ã†ã—', 'ã‚ã‚'] },
        { id: 'ajisai', img: 'assets/images/ajisai.png', ans: 'ã‚ã˜ã•ã„', wrong: ['ã•ãã‚‰', 'ã²ã¾ã‚ã‚Š', 'ã‚†ã‚Š'] },
        { id: 'aka', img: 'assets/images/aka.png', ans: 'ã‚ã‹', wrong: ['ã‚ãŠ', 'ã¿ã©ã‚Š', 'ãã‚'] },
        { id: 'ame', img: 'assets/images/ame.png', ans: 'ã‚ã‚', wrong: ['ã‚†ã', 'ãŸã„ã‚ˆã†', 'ãã‚‚'] },
        { id: 'ao', img: 'assets/images/ao.png', ans: 'ã‚ãŠ', wrong: ['ã‚ã‹', 'ãã„ã‚', 'ã—ã‚'] },
        { id: 'ari', img: 'assets/images/ari.png', ans: 'ã‚ã‚Š', wrong: ['ã„ã¬', 'ã­ã“', 'ãã†'] },
        { id: 'ashi', img: 'assets/images/ashi.png', ans: 'ã‚ã—', wrong: ['ã¦', 'ã‹ãŠ', 'ãã¡'] },
        { id: 'atsui', img: 'assets/images/atsui.png', ans: 'ã‚ã¤ã„', wrong: ['ã•ã‚€ã„', 'ã„ãŸã„', 'ã‚ã‚‹ã„'] },
        { id: 'banana', img: 'assets/images/banana.png', ans: 'ã°ãªãª', wrong: ['ã‚Šã‚“ã”', 'ã¿ã‹ã‚“', 'ã„ã¡ã”'] },
        { id: 'batsu', img: 'assets/images/batsu.png', ans: 'ã°ã¤', wrong: ['ã¾ã‚‹', 'ã—ã‹ã', 'ã•ã‚“ã‹ã'] },
        { id: 'buta', img: 'assets/images/buta.png', ans: 'ã¶ãŸ', wrong: ['ã†ã¾', 'ã†ã—', 'ã—ã‹'] },
        { id: 'cho', img: 'assets/images/cho.png', ans: 'ã¡ã‚‡ã†', wrong: ['ã¯ã¡', 'ã‚ã‚Š', 'ã›ã¿'] },
        { id: 'churippu', img: 'assets/images/churippu.png', ans: 'ã¡ã‚…ãƒ¼ã‚Šã£ã·', wrong: ['ã•ãã‚‰', 'ã°ã‚‰', 'ã‚ã˜ã•ã„'] },
        { id: 'daikon', img: 'assets/images/daikon.png', ans: 'ã ã„ã“ã‚“', wrong: ['ã«ã‚“ã˜ã‚“', 'ãŸã¾ã­ã', 'ãªã™'] },
        { id: 'dango', img: 'assets/images/dango.png', ans: 'ã ã‚“ã”', wrong: ['ãŠã‚‚ã¡', 'ãŠã‹ã—', 'ã¾ã‚“ã˜ã‚…ã†'] },
        { id: 'daruma', img: 'assets/images/daruma.png', ans: 'ã ã‚‹ã¾', wrong: ['ã“ã¾', 'ã‘ã‚“ç‰', 'ãŠã‚‚ã¡ã‚ƒ'] },
        { id: 'densha', img: 'assets/images/densha.png', ans: 'ã§ã‚“ã—ã‚ƒ', wrong: ['ãã‚‹ã¾', 'ã²ã“ã†ã', 'ãµã­'] },
        { id: 'ebi', img: 'assets/images/ebi.png', ans: 'ãˆã³', wrong: ['ã‹ã«', 'ã„ã‹', 'ãŸã“'] },
        { id: 'ehon', img: 'assets/images/ehon.png', ans: 'ãˆã»ã‚“', wrong: ['ã»ã‚“', 'ã–ã£ã—', 'ãƒãƒ¼ãƒˆ'] },
        { id: 'enpitsu', img: 'assets/images/enpitsu.png', ans: 'ãˆã‚“ã´ã¤', wrong: ['ãƒšãƒ³', 'ã‘ã—ã”ã‚€', 'ã¯ã•ã¿'] },
        { id: 'fujisan', img: 'assets/images/fujisan.png', ans: 'ãµã˜ã•ã‚“', wrong: ['ã‚„ã¾', 'ã‹ã‚', 'ã¿ãšã†ã¿'] },
        { id: 'fuku', img: 'assets/images/fuku.png', ans: 'ãµã', wrong: ['ã¼ã†ã—', 'ãã¤', 'ã‚ºãƒœãƒ³'] },
        { id: 'fune', img: 'assets/images/fune.png', ans: 'ãµã­', wrong: ['ãã‚‹ã¾', 'ã§ã‚“ã—ã‚ƒ', 'ã²ã“ã†ã'] },
        { id: 'gakko', img: 'assets/images/gakko.png', ans: 'ãŒã£ã“ã†', wrong: ['ã„ãˆ', 'ã¿ã¡', 'ã‚„ã¾'] },
        { id: 'ginko', img: 'assets/images/ginko.png', ans: 'ãã‚“ã“ã†', wrong: ['ãŒã£ã“ã†', 'ã³ã‚‡ã†ã„ã‚“', 'ã“ã†ãˆã‚“'] },
        { id: 'gohan', img: 'assets/images/gohan.png', ans: 'ã”ã¯ã‚“', wrong: ['ãƒ‘ãƒ³', 'ã‚ã‚“', 'ãŠã«ãã‚Š'] },
        { id: 'gorira', img: 'assets/images/gorira.png', ans: 'ã”ã‚Šã‚‰', wrong: ['ã•ã‚‹', 'ãã¾', 'ã‚‰ã„ãŠã‚“'] },
        { id: 'gyoza', img: 'assets/images/gyoza.png', ans: 'ãã‚‡ã†ã–', wrong: ['ã‚‰ãƒ¼ã‚ã‚“', 'ã™ã—', 'ã‚„ãã«ã'] },
        { id: 'ha', img: 'assets/images/ha.png', ans: 'ã¯', wrong: ['ã‚', 'ã¿ã¿', 'ãã¡'] },
        { id: 'hana', img: 'assets/images/hana.png', ans: 'ã¯ãª', wrong: ['ã', 'ã¯ã£ã±', 'ãã•'] },
        { id: 'hanabi', img: 'assets/images/hanabi.png', ans: 'ã¯ãªã³', wrong: ['ã»ã—', 'ã¤ã', 'ãŸã„ã‚ˆã†'] },
        { id: 'hasami', img: 'assets/images/hasami.png', ans: 'ã¯ã•ã¿', wrong: ['ãƒŠã‚¤ãƒ•', 'ãƒ•ã‚©ãƒ¼ã‚¯', 'ã‚¹ãƒ—ãƒ¼ãƒ³'] },
        { id: 'hashi', img: 'assets/images/hashi.png', ans: 'ã¯ã—', wrong: ['ãƒ•ã‚©ãƒ¼ã‚¯', 'ã‚¹ãƒ—ãƒ¼ãƒ³', 'ãƒŠã‚¤ãƒ•'] },
        { id: 'hebi', img: 'assets/images/hebi.png', ans: 'ã¸ã³', wrong: ['ã‚ã«', 'ã¨ã‹ã’', 'ã‹ã‚'] },
        { id: 'hi', img: 'assets/images/hi.png', ans: 'ã²', wrong: ['ã¿ãš', 'ã¤ã¡', 'ã‹ãœ'] },
        { id: 'hikoki', img: 'assets/images/hikoki.png', ans: 'ã²ã“ã†ã', wrong: ['ãã‚‹ã¾', 'ã§ã‚“ã—ã‚ƒ', 'ãµã­'] },
        { id: 'himawari', img: 'assets/images/himawari.png', ans: 'ã²ã¾ã‚ã‚Š', wrong: ['ã•ãã‚‰', 'ã°ã‚‰', 'ã¡ã‚…ãƒ¼ã‚Šã£ã·'] },
        { id: 'hoshi', img: 'assets/images/hoshi.png', ans: 'ã»ã—', wrong: ['ã¤ã', 'ãŸã„ã‚ˆã†', 'ãã‚‚'] },
        { id: 'ichi', img: 'assets/images/ichi.png', ans: 'ã„ã¡', wrong: ['ã«', 'ã•ã‚“', 'ã‚ˆã‚“'] },
        { id: 'ichigo', img: 'assets/images/ichigo.png', ans: 'ã„ã¡ã”', wrong: ['ã‚Šã‚“ã”', 'ã¿ã‹ã‚“', 'ã°ãªãª'] },
        { id: 'ika', img: 'assets/images/ika.png', ans: 'ã„ã‹', wrong: ['ãŸã“', 'ãˆã³', 'ã‹ã«'] },
        { id: 'inu', img: 'assets/images/inu.png', ans: 'ã„ã¬', wrong: ['ã­ã“', 'ã¶ãŸ', 'ã†ã¾'] },
        { id: 'iruka', img: 'assets/images/iruka.png', ans: 'ã„ã‚‹ã‹', wrong: ['ãã˜ã‚‰', 'ã•ã‹ãª', 'ãºã‚“ãã‚“'] },
        { id: 'ishi', img: 'assets/images/ishi.png', ans: 'ã„ã—', wrong: ['ã', 'ã¿ãš', 'ã¤ã¡'] },
        { id: 'isu', img: 'assets/images/isu.png', ans: 'ã„ã™', wrong: ['ã¤ããˆ', 'ãƒ†ãƒ¼ãƒ–ãƒ«', 'ãƒ™ãƒƒãƒ‰'] },
        { id: 'jitensha', img: 'assets/images/jitensha.png', ans: 'ã˜ã¦ã‚“ã—ã‚ƒ', wrong: ['ãã‚‹ã¾', 'ã§ã‚“ã—ã‚ƒ', 'ãƒã‚¤ã‚¯'] },
        { id: 'kaban', img: 'assets/images/kaban.png', ans: 'ã‹ã°ã‚“', wrong: ['ã•ã„ãµ', 'ãµãã‚', 'ãã¤'] },
        { id: 'kaeru', img: 'assets/images/kaeru.png', ans: 'ã‹ãˆã‚‹', wrong: ['ã¸ã³', 'ã¨ã‹ã’', 'ã‚ã«'] },
        { id: 'kagi', img: 'assets/images/kagi.png', ans: 'ã‹ã', wrong: ['ãƒ‰ã‚¢', 'ã‹ã¹', 'ã¨ã³ã‚‰'] },
        { id: 'kame', img: 'assets/images/kame.png', ans: 'ã‹ã‚', wrong: ['ã¨ã‹ã’', 'ã‚ã«', 'ã¸ã³'] },
        { id: 'kasa', img: 'assets/images/kasa.png', ans: 'ã‹ã•', wrong: ['ã¼ã†ã—', 'ãµã', 'ãã¤'] },
        { id: 'kawa', img: 'assets/images/kawa.png', ans: 'ã‹ã‚', wrong: ['ã†ã¿', 'ã¿ãšã†ã¿', 'ã„ã‘'] },
        { id: 'keito', img: 'assets/images/keito.png', ans: 'ã‘ã„ã¨', wrong: ['ã„ã¨', 'ã¬ã®', 'ãµã'] },
        { id: 'kocha', img: 'assets/images/kocha.png', ans: 'ã“ã†ã¡ã‚ƒ', wrong: ['ãŠã¡ã‚ƒ', 'ã¿ãš', 'ã‚³ãƒ¼ãƒ’ãƒ¼'] },
        { id: 'kodomo', img: 'assets/images/kodomo.png', ans: 'ã“ã©ã‚‚', wrong: ['ãŠã¨ãª', 'ã›ã‚“ã›ã„', 'ãŒãã›ã„'] },
        { id: 'koi', img: 'assets/images/koi.png', ans: 'ã“ã„', wrong: ['ã•ã‹ãª', 'ãŸã„', 'ã¾ãã‚'] },
        { id: 'koma', img: 'assets/images/koma.png', ans: 'ã“ã¾', wrong: ['ã ã‚‹ã¾', 'ã‘ã‚“ç‰', 'ãŠã‚‚ã¡ã‚ƒ'] },
        { id: 'koppu', img: 'assets/images/koppu.png', ans: 'ã‚³ãƒƒãƒ—', wrong: ['ã•ã‚‰', 'ã¡ã‚ƒã‚ã‚“', 'ãŠã‚ã‚“'] },
        { id: 'kuchi', img: 'assets/images/kuchi.png', ans: 'ãã¡', wrong: ['ã‚', 'ã¯ãª', 'ã¿ã¿'] },
        { id: 'kuma', img: 'assets/images/kuma.png', ans: 'ãã¾', wrong: ['ã”ã‚Šã‚‰', 'ã±ã‚“ã ', 'ã‚‰ã„ãŠã‚“'] },
        { id: 'kumo', img: 'assets/images/kumo.png', ans: 'ãã‚‚', wrong: ['ãŸã„ã‚ˆã†', 'ã¤ã', 'ã»ã—'] },
        { id: 'kuro', img: 'assets/images/kuro.png', ans: 'ãã‚', wrong: ['ã—ã‚', 'ã‚ã‹', 'ã‚ãŠ'] },
        { id: 'kuruma', img: 'assets/images/kuruma.png', ans: 'ãã‚‹ã¾', wrong: ['ã§ã‚“ã—ã‚ƒ', 'ã²ã“ã†ã', 'ãµã­'] },
        { id: 'kutsu', img: 'assets/images/kutsu.png', ans: 'ãã¤', wrong: ['ãã¤ã—ãŸ', 'ãµã', 'ã¼ã†ã—'] },
        { id: 'mado', img: 'assets/images/mado.png', ans: 'ã¾ã©', wrong: ['ãƒ‰ã‚¢', 'ã‹ã¹', 'ã‚†ã‹'] },
        { id: 'maguro', img: 'assets/images/maguro.png', ans: 'ã¾ãã‚', wrong: ['ãŸã„', 'ã•ã‹ãª', 'ãˆã³'] },
        { id: 'makura', img: 'assets/images/makura.png', ans: 'ã¾ãã‚‰', wrong: ['ãƒ™ãƒƒãƒ‰', 'ãµã¨ã‚“', 'ã¾ã£ã¨'] },
        { id: 'mame', img: 'assets/images/mame.png', ans: 'ã¾ã‚', wrong: ['ã„ã‚‚', 'ã‚„ã•ã„', 'ãã®ã“'] },
        { id: 'manga', img: 'assets/images/manga.png', ans: 'ã¾ã‚“ãŒ', wrong: ['ã»ã‚“', 'ã–ã£ã—', 'ã—ã‚“ã¶ã‚“'] },
        { id: 'megane', img: 'assets/images/megane.png', ans: 'ã‚ãŒã­', wrong: ['ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ', 'ã¼ã†ã—', 'ãã¤'] },
        { id: 'michi', img: 'assets/images/michi.png', ans: 'ã¿ã¡', wrong: ['ã‹ã‚', 'ã‚„ã¾', 'ã†ã¿'] },
        { id: 'midori', img: 'assets/images/midori.png', ans: 'ã¿ã©ã‚Š', wrong: ['ã‚ã‹', 'ã‚ãŠ', 'ãã„ã‚'] },
        { id: 'mikan', img: 'assets/images/mikan.png', ans: 'ã¿ã‹ã‚“', wrong: ['ã‚Šã‚“ã”', 'ã°ãªãª', 'ã„ã¡ã”'] },
        { id: 'mizuumi', img: 'assets/images/mizuumi.png', ans: 'ã¿ãšã†ã¿', wrong: ['ã†ã¿', 'ã‹ã‚', 'ã„ã‘'] },
        { id: 'momo', img: 'assets/images/momo.png', ans: 'ã‚‚ã‚‚', wrong: ['ã‚Šã‚“ã”', 'ã„ã¡ã”', 'ã¿ã‹ã‚“'] },
        { id: 'mori', img: 'assets/images/mori.png', ans: 'ã‚‚ã‚Š', wrong: ['ã‚„ã¾', 'ã‹ã‚', 'ã†ã¿'] },
        { id: 'mushi', img: 'assets/images/mushi.png', ans: 'ã‚€ã—', wrong: ['ã„ã¬', 'ã­ã“', 'ã•ã‹ãª'] },
        { id: 'nabe', img: 'assets/images/nabe.png', ans: 'ãªã¹', wrong: ['ã•ã‚‰', 'ã¡ã‚ƒã‚ã‚“', 'ã‚³ãƒƒãƒ—'] },
        { id: 'namazu', img: 'assets/images/namazu.png', ans: 'ãªã¾ãš', wrong: ['ã•ã‹ãª', 'ã†ãªã', 'ã©ã˜ã‚‡ã†'] },
        { id: 'nami', img: 'assets/images/nami.png', ans: 'ãªã¿', wrong: ['ã‹ã‚', 'ã†ã¿', 'ã¿ãšã†ã¿'] },
        { id: 'nana', img: 'assets/images/nana.png', ans: 'ãªãª', wrong: ['ã‚ã', 'ã¯ã¡', 'ãã‚…ã†'] },
        { id: 'nashi', img: 'assets/images/nashi.png', ans: 'ãªã—', wrong: ['ã‚Šã‚“ã”', 'ã¿ã‹ã‚“', 'ã„ã¡ã”'] },
        { id: 'nasu', img: 'assets/images/nasu.png', ans: 'ãªã™', wrong: ['ãã‚…ã†ã‚Š', 'ã«ã‚“ã˜ã‚“', 'ãƒ”ãƒ¼ãƒãƒ³'] },
        { id: 'neko', img: 'assets/images/neko.png', ans: 'ã­ã“', wrong: ['ã„ã¬', 'ã¶ãŸ', 'ã†ã¾'] },
        { id: 'nezumi', img: 'assets/images/nezumi.png', ans: 'ã­ãšã¿', wrong: ['ã­ã“', 'ã„ã¬', 'ã†ã•ã'] },
        { id: 'niwa', img: 'assets/images/niwa.png', ans: 'ã«ã‚', wrong: ['ã„ãˆ', 'ãŒã£ã“ã†', 'ã“ã†ãˆã‚“'] },
        { id: 'nori', img: 'assets/images/nori.png', ans: 'ã®ã‚Š', wrong: ['ã”ã¯ã‚“', 'ãƒ‘ãƒ³', 'ã•ã‹ãª'] },
        { id: 'nuigurumi', img: 'assets/images/nuigurumi.png', ans: 'ã¬ã„ãã‚‹ã¿', wrong: ['ã«ã‚“ãã‚‡ã†', 'ãŠã‚‚ã¡ã‚ƒ', 'ã ã‚‹ã¾'] },
        { id: 'nurie', img: 'assets/images/nurie.png', ans: 'ã¬ã‚Šãˆ', wrong: ['ãˆã»ã‚“', 'ã¾ã‚“ãŒ', 'ã–ã£ã—'] },
        { id: 'oka', img: 'assets/images/oka.png', ans: 'ãŠã‹', wrong: ['ã‚„ã¾', 'ã‹ã‚', 'ã¿ãšã†ã¿'] },
        { id: 'okashi', img: 'assets/images/okashi.png', ans: 'ãŠã‹ã—', wrong: ['ã”ã¯ã‚“', 'ãƒ‘ãƒ³', 'ã‚„ã•ã„'] },
        { id: 'omocha', img: 'assets/images/omocha.png', ans: 'ãŠã‚‚ã¡ã‚ƒ', wrong: ['ã¬ã„ãã‚‹ã¿', 'ã«ã‚“ãã‚‡ã†', 'ã ã‚‹ã¾'] },
        { id: 'oni', img: 'assets/images/oni.png', ans: 'ãŠã«', wrong: ['ã‹ã¿', 'ã²ã¨', 'ã“ã©ã‚‚'] },
        { id: 'onigiri', img: 'assets/images/onigiri.png', ans: 'ãŠã«ãã‚Š', wrong: ['ã”ã¯ã‚“', 'ãƒ‘ãƒ³', 'ã‚ã‚“'] },
        { id: 'onsen', img: 'assets/images/onsen.png', ans: 'ãŠã‚“ã›ã‚“', wrong: ['ã‹ã‚', 'ã†ã¿', 'ã¿ãšã†ã¿'] },
        { id: 'panda', img: 'assets/images/panda.png', ans: 'ã±ã‚“ã ', wrong: ['ãã¾', 'ã•ã‚‹', 'ã‚‰ã„ãŠã‚“'] },
        { id: 'raion', img: 'assets/images/raion.png', ans: 'ã‚‰ã„ãŠã‚“', wrong: ['ãã¾', 'ã¨ã‚‰', 'ãã†'] },
        { id: 'ramen', img: 'assets/images/ramen.png', ans: 'ãƒ©ãƒ¼ãƒ¡ãƒ³', wrong: ['ã†ã©ã‚“', 'ãã°', 'ãƒ‘ã‚¹ã‚¿'] },
        { id: 'rappa', img: 'assets/images/rappa.png', ans: 'ã‚‰ã£ã±', wrong: ['ãŸã„ã“', 'ã‚®ã‚¿ãƒ¼', 'ãƒ”ã‚¢ãƒ'] },
        { id: 'ringo', img: 'assets/images/ringo.png', ans: 'ã‚Šã‚“ã”', wrong: ['ã¿ã‹ã‚“', 'ã„ã¡ã”', 'ã°ãªãª'] },
        { id: 'risu', img: 'assets/images/risu.png', ans: 'ã‚Šã™', wrong: ['ã­ã“', 'ã„ã¬', 'ã†ã•ã'] },
        { id: 'roku', img: 'assets/images/roku.png', ans: 'ã‚ã', wrong: ['ã”', 'ãªãª', 'ã¯ã¡'] },
        { id: 'sakana', img: 'assets/images/sakana.png', ans: 'ã•ã‹ãª', wrong: ['ã¨ã‚Š', 'ã„ã¬', 'ã­ã“'] },
        { id: 'sakura', img: 'assets/images/sakura.png', ans: 'ã•ãã‚‰', wrong: ['ã²ã¾ã‚ã‚Š', 'ã¡ã‚…ãƒ¼ã‚Šã£ã·', 'ã°ã‚‰'] },
        { id: 'saru', img: 'assets/images/saru.png', ans: 'ã•ã‚‹', wrong: ['ã”ã‚Šã‚‰', 'ãã¾', 'ã±ã‚“ã '] },
        { id: 'semi', img: 'assets/images/semi.png', ans: 'ã›ã¿', wrong: ['ã¡ã‚‡ã†', 'ã¯ã¡', 'ã‚ã‚Š'] },
        { id: 'shiitake', img: 'assets/images/shiitake.png', ans: 'ã—ã„ãŸã‘', wrong: ['ãã®ã“', 'ã¾ã‚', 'ã‚„ã•ã„'] },
        { id: 'shika', img: 'assets/images/shika.png', ans: 'ã—ã‹', wrong: ['ã†ã¾', 'ã†ã—', 'ã¶ãŸ'] },
        { id: 'shiro', img: 'assets/images/shiro.png', ans: 'ã—ã‚', wrong: ['ãã‚', 'ã‚ã‹', 'ã‚ãŠ'] },
        { id: 'suika', img: 'assets/images/suika.png', ans: 'ã™ã„ã‹', wrong: ['ã‚Šã‚“ã”', 'ã¿ã‹ã‚“', 'ã°ãªãª'] },
        { id: 'sushi', img: 'assets/images/sushi.png', ans: 'ã™ã—', wrong: ['ã•ã‹ãª', 'ã”ã¯ã‚“', 'ã‚„ã•ã„'] },
        { id: 'suzume', img: 'assets/images/suzume.png', ans: 'ã™ãšã‚', wrong: ['ã¨ã‚Š', 'ã¤ã°ã‚', 'ã¯ã¨'] },
        { id: 'tai', img: 'assets/images/tai.png', ans: 'ãŸã„', wrong: ['ã¾ãã‚', 'ã•ã‹ãª', 'ã“ã„'] },
        { id: 'tako', img: 'assets/images/tako.png', ans: 'ãŸã“', wrong: ['ã„ã‹', 'ãˆã³', 'ã‹ã«'] },
        { id: 'tamago', img: 'assets/images/tamago.png', ans: 'ãŸã¾ã”', wrong: ['ã”ã¯ã‚“', 'ãƒ‘ãƒ³', 'ã‚„ã•ã„'] },
        { id: 'tanuki', img: 'assets/images/tanuki.png', ans: 'ãŸã¬ã', wrong: ['ãã¤ã­', 'ã„ã¬', 'ã­ã“'] },
        { id: 'te', img: 'assets/images/te.png', ans: 'ã¦', wrong: ['ã‚ã—', 'ã‹ãŠ', 'ã¿ã¿'] },
        { id: 'terebi', img: 'assets/images/terebi.png', ans: 'ãƒ†ãƒ¬ãƒ“', wrong: ['ãƒ©ã‚¸ã‚ª', 'ã‚¹ãƒãƒ›', 'ãƒ‘ã‚½ã‚³ãƒ³'] },
        { id: 'tofu', img: 'assets/images/tofu.png', ans: 'ã¨ã†ãµ', wrong: ['ã¾ã‚', 'ã”ã¯ã‚“', 'ãƒ‘ãƒ³'] },
        { id: 'tokei', img: 'assets/images/tokei.png', ans: 'ã¨ã‘ã„', wrong: ['ã‹ã', 'ãƒ‰ã‚¢', 'ã‹ã¹'] },
        { id: 'tomato', img: 'assets/images/tomato.png', ans: 'ã¨ã¾ã¨', wrong: ['ãã‚…ã†ã‚Š', 'ãªã™', 'ãƒ”ãƒ¼ãƒãƒ³'] },
        { id: 'tori', img: 'assets/images/tori.png', ans: 'ã¨ã‚Š', wrong: ['ã„ã¬', 'ã­ã“', 'ã•ã‹ãª'] },
        { id: 'tsubame', img: 'assets/images/tsubame.png', ans: 'ã¤ã°ã‚', wrong: ['ã™ãšã‚', 'ã¯ã¨', 'ã¨ã‚Š'] },
        { id: 'tsuki', img: 'assets/images/tsuki.png', ans: 'ã¤ã', wrong: ['ãŸã„ã‚ˆã†', 'ã»ã—', 'ãã‚‚'] },
        { id: 'tsukue', img: 'assets/images/tsukue.png', ans: 'ã¤ããˆ', wrong: ['ã„ã™', 'ãƒ†ãƒ¼ãƒ–ãƒ«', 'ãƒ™ãƒƒãƒ‰'] },
        { id: 'ude', img: 'assets/images/ude.png', ans: 'ã†ã§', wrong: ['ã‚ã—', 'ã¦', 'ã‹ãŠ'] },
        { id: 'uma', img: 'assets/images/uma.png', ans: 'ã†ã¾', wrong: ['ã„ã¬', 'ã­ã“', 'ã¶ãŸ'] },
        { id: 'umi', img: 'assets/images/umi.png', ans: 'ã†ã¿', wrong: ['ã‹ã‚', 'ã‚„ã¾', 'ã¿ãšã†ã¿'] },
        { id: 'usagi', img: 'assets/images/usagi.png', ans: 'ã†ã•ã', wrong: ['ã­ã“', 'ã„ã¬', 'ã‚Šã™'] },
        { id: 'ushi', img: 'assets/images/ushi.png', ans: 'ã†ã—', wrong: ['ã¶ãŸ', 'ã†ã¾', 'ã—ã‹'] },
        { id: 'wani', img: 'assets/images/wani.png', ans: 'ã‚ã«', wrong: ['ã¨ã‹ã’', 'ã¸ã³', 'ã‹ã‚'] },
        { id: 'yagi', img: 'assets/images/yagi.png', ans: 'ã‚„ã', wrong: ['ã²ã¤ã˜', 'ã†ã¾', 'ã†ã—'] },
        { id: 'yama', img: 'assets/images/yama.png', ans: 'ã‚„ã¾', wrong: ['ã‹ã‚', 'ã†ã¿', 'ã¿ã¡'] },
        { id: 'yuki', img: 'assets/images/yuki.png', ans: 'ã‚†ã', wrong: ['ã‚ã‚', 'ãã‚‚', 'ãŸã„ã‚ˆã†'] },
        { id: 'yubiwa', img: 'assets/images/yubiwa.png', ans: 'ã‚†ã³ã‚', wrong: ['ãã¤', 'ãµã', 'ã¼ã†ã—'] },
    ];

    // --------------------------------------------------
    // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚¯ãƒ©ã‚¹
    // --------------------------------------------------
    class HiraganaGame {
        constructor() {
            this.questions = [];
            this.currentQIndex = 0;
            this.score = 0;
            this.isAnswering = false;

            // DOMè¦ç´ 
            this.menuArea = document.getElementById('quiz-menu-area');
            this.gameArea = document.getElementById('quiz-game-area');
            this.turnMsg = document.getElementById('quiz-turn-message');
            this.scoreVal = document.getElementById('score-val');
            this.imgArea = document.getElementById('quiz-image-area');
            this.btnArea = document.getElementById('choice-buttons-area');
            this.feedback = document.getElementById('quiz-feedback');
            
            // éŸ³å£°
            this.sndCorrect = document.getElementById('snd-correct');
            this.sndIncorrect = document.getElementById('snd-incorrect');
            this.sndFanfare = document.getElementById('snd-fanfare');
        }

        start() {
            // å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã‚»ãƒƒãƒˆ (10å•ã«é™å®š)
            this.questions = [...QUESTIONS].sort(() => Math.random() - 0.5).slice(0, 10);
            this.currentQIndex = 0;
            this.score = 0;
            this.updateScoreUI();

            this.menuArea.style.display = 'none';
            this.gameArea.style.display = 'block';
            this.nextQuestion();
        }

        nextQuestion() {
            if (this.currentQIndex >= this.questions.length) {
                this.finishGame();
                return;
            }

            this.isAnswering = true;
            this.feedback.textContent = '';
            this.turnMsg.textContent = `å• ${this.currentQIndex + 1} / ${this.questions.length}`;

            const q = this.questions[this.currentQIndex];

            // ç”»åƒè¡¨ç¤º (ç”»åƒãƒ‘ã‚¹ã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ä¿®æ­£ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ã£ãŸHTMLæ–­ç‰‡ã®å½¢ã¯ä½¿ç”¨ã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ãŸ)
            // ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã§æ—¢ã«å«ã¾ã‚Œã¦ãŠã‚Šã€æ­£å¸¸ã«å‹•ä½œã—ã¾ã™ã€‚
            const img = new Image();
            img.src = q.img;
            // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ
            img.onerror = () => { 
                this.imgArea.innerHTML = `<p style="font-size:2em">ğŸ–¼ï¸</p><p>(${q.ans}ã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)</p>`;
            }; 
            this.imgArea.innerHTML = '';
            this.imgArea.appendChild(img);


            // é¸æŠè‚¢ä½œæˆ
            let allAnswers = QUESTIONS.map(item => item.ans).filter(ans => ans !== q.ans);
            
            // é–“é•ã„ã®é¸æŠè‚¢ã¯3ã¤
            const wrongChoices = [...q.wrong]
                .filter(w => w !== q.ans)
                .slice(0, 3) 
                .concat(allAnswers) 
                .filter((value, index, self) => self.indexOf(value) === index) 
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            const choices = [q.ans, ...wrongChoices].sort(() => Math.random() - 0.5);
            
            this.btnArea.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => this.checkAnswer(btn, choice, q.ans); 
                this.btnArea.appendChild(btn);
            });
        }

        checkAnswer(btn, choice, correctAns) {
            if (!this.isAnswering) return;
            this.isAnswering = false;

            const allBtns = document.querySelectorAll('.choice-btn');
            allBtns.forEach(b => b.classList.add('disabled'));

            if (choice === correctAns) {
                // æ­£è§£
                btn.classList.add('correct');
                this.sndCorrect.currentTime = 0; 
                this.sndCorrect.play().catch(e=>{});
                this.feedback.textContent = 'ã›ã„ã‹ã„ï¼';
                this.feedback.style.color = 'var(--correct-color)';
                // ã‚¹ã‚³ã‚¢åŠ ç®—ã¯10ç‚¹
                this.score += 10;
                this.updateScoreUI();
            } else {
                // ä¸æ­£è§£
                btn.classList.add('incorrect');
                this.sndIncorrect.currentTime = 0; 
                this.sndIncorrect.play().catch(e=>{});
                this.feedback.textContent = `ã–ã‚“ã­ã‚“â€¦ ã“ãŸãˆã¯ã€Œ${correctAns}ã€ã ã‚ˆ`;
                this.feedback.style.color = 'var(--incorrect-color)';

                // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’æ•™ãˆã¦ã‚ã’ã‚‹
                allBtns.forEach(b => {
                    if (b.textContent === correctAns) b.classList.add('correct');
                });
            }

            // æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                this.currentQIndex++;
                this.nextQuestion();
            }, 1500);
        }

        updateScoreUI() {
            this.scoreVal.textContent = this.score;
        }

        async finishGame() {
            this.imgArea.innerHTML = '<i class="fa-solid fa-crown" style="font-size:5em; color:#ffd700;"></i>';
            this.btnArea.innerHTML = '';
            this.feedback.textContent = `ãŠã—ã¾ã„ï¼ ${this.score}ã¦ã‚“ï¼`;
            this.feedback.style.color = 'var(--primary)';
            
            this.sndFanfare.currentTime = 0;
            this.sndFanfare.play().catch(e=>{});

            // â˜…â˜…â˜… Firebaseã¸ã‚¹ã‚³ã‚¢é€ä¿¡ (ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²) â˜…â˜…â˜…
            // ã‚²ãƒ¼ãƒ ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ (1å•10ç‚¹Ã—10å•ã§æœ€å¤§100ç‚¹) ã‚’ãã®ã¾ã¾é€ä¿¡
            const finalScore = this.score;
            if (finalScore > 0) {
                 await submitScore(finalScore); 
                 this.feedback.innerHTML += '<br><span style="font-size:0.8em; color:#666;">ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã—ã¾ã—ãŸï¼</span>';
            } else {
                 this.feedback.innerHTML += '<br><span style="font-size:0.8em; color:#666;">ã‚¹ã‚³ã‚¢ãŒ0ç‚¹ã®ãŸã‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚</span>';
            }
            
            // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
            setTimeout(() => {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'start-btn';
                retryBtn.textContent = 'ã‚‚ã†ã„ã¡ã©';
                retryBtn.onclick = () => location.reload();
                this.btnArea.appendChild(retryBtn);
                this.btnArea.style.display = 'flex';
                this.btnArea.style.justifyContent = 'center';
            }, 1000);
        }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ã—ã¦HTMLã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
    window.game = new HiraganaGame();
    
    // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ (ä»»æ„)
    QUESTIONS.forEach(q => { const i = new Image(); i.src = q.img; });

</script>

</body>
</html>