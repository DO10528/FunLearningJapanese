<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ひらがな単語ゲーム - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

<style>
    /* --- カラー設定 --- */
    :root {
        --primary: #5c7aff;
        --accent: #ffcc5c;
        --bg-color: #f4f7fc;
        --text-color: #333;
        --correct-color: #4caf50;
        --incorrect-color: #ef5350;
    }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0; min-height: 100vh;
        display: flex; flex-direction: column;
    }

    /* --- ヘッダー --- */
    header {
        background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
        color: white; padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3); z-index: 100;
    }
    .logo { font-size: 1.4em; font-weight: 900; display: flex; align-items: center; gap: 10px; color: white; text-decoration: none; }
    .home-icon { color: white; font-size: 1.5em; transition: transform 0.2s; }

    /* --- メインレイアウト --- */
    .main-container {
        flex-grow: 1; padding: 20px; max-width: 700px;
        margin: 0 auto; width: 100%; box-sizing: border-box;
        display: flex; flex-direction: column; justify-content: center;
    }

    /* --- カードデザイン --- */
    .quiz-card {
        background: white; border-radius: 25px; padding: 30px 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08); text-align: center;
        border: 4px solid white; width: 100%; box-sizing: border-box;
    }

    /* --- メニュー画面 --- */
    .menu-icon { font-size: 5em; color: #ff6f61; margin-bottom: 15px; animation: bounce 2s infinite; }
    .menu-title { font-size: 2em; color: var(--primary); margin: 0 0 10px 0; }
    .menu-desc { color: #666; margin-bottom: 20px; font-size: 1.1em; }
    .rule-box { background: #fff8e1; padding: 15px; border-radius: 15px; margin-bottom: 25px; color: #5d4037; }
    
    .start-btn {
        background: linear-gradient(to bottom, #5c7aff, #4b63cc);
        color: white; font-size: 1.6em; font-weight: 900;
        padding: 15px 50px; border: none; border-radius: 50px;
        cursor: pointer; box-shadow: 0 6px 0 #3f51b5;
        margin-bottom: 15px; display: inline-block; width: 80%; max-width: 300px;
    }
    .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #3f51b5; }
    .home-btn-text { color: #999; text-decoration: none; font-weight: bold; display: block; margin-top: 10px; }

    /* --- ゲーム画面 --- */
    .score-board {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; padding: 10px 20px;
        background: white; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        font-weight: bold; color: var(--primary);
    }

    .image-frame {
        width: 200px; height: 200px; margin: 0 auto 20px;
        background: #fffbea; border: 6px solid var(--accent);
        border-radius: 25px; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
    }
    .image-frame img { width: 90%; height: 90%; object-fit: contain; }
    
    .question-text { font-size: 1.4em; font-weight: bold; color: #444; margin-bottom: 20px; }

    /* --- 選択肢グリッド --- */
    .choices-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        width: 100%; margin-bottom: 20px;
    }

    .choice-btn {
        background-color: #ffffff; border: 3px solid #dce0e5; border-radius: 15px;
        color: #555; font-size: 1.3em; font-weight: 800;
        padding: 15px 5px; width: 100%; min-height: 70px;
        cursor: pointer; box-shadow: 0 4px 0 #cfd8dc; transition: all 0.1s;
        display: flex; justify-content: center; align-items: center;
    }
    .choice-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: 0 6px 0 #cfd8dc; }
    .choice-btn:active { transform: translateY(2px); box-shadow: none; }
    
    .choice-btn.correct { background-color: var(--correct-color); border-color: var(--correct-color); color: white; box-shadow: 0 4px 0 #2e7d32; }
    .choice-btn.incorrect { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: white; opacity: 0.6; box-shadow: none; }
    .choice-btn.disabled { pointer-events: none; }

    .feedback-area { min-height: 1.5em; margin-top: 10px; font-size: 1.3em; font-weight: 900; }
    
    /* アニメーション */
    .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

</style>
</head>
<body>

    <header>
        <a href="index.html" class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</a>
        <a href="index.html" class="home-icon"><i class="fa-solid fa-house"></i></a>
    </header>

    <div class="main-container">
        
        <!-- メニュー画面 -->
        <div id="quiz-menu-area" class="pop-in">
            <div class="quiz-card">
                <i class="fa-solid fa-shapes menu-icon"></i>
                <h1 class="menu-title">ひらがな単語</h1>
                <p class="menu-desc">え を みて ただしい ことば をえらぼう！</p>
                <div class="rule-box">
                    <div id="quiz-score-message">
                        ぜんぶで <strong>10もん</strong> あるよ。<br>がんばって クリアしよう！
                    </div>
                </div>
                <button id="quizStartButton" class="start-btn" onclick="game.start()">
                    <i class="fa-solid fa-play"></i> スタート！
                </button>
                <a href="index.html" class="home-btn-text">ホームにもどる</a>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="quiz-game-area" style="display:none;" class="pop-in">
            <div class="score-board">
                <span id="quiz-turn-message">問 1 / 10</span>
                <span><i class="fa-solid fa-star" style="color:#f0ad4e;"></i> <span id="score-val">0</span></span>
            </div>
            <div class="quiz-card">
                <div id="quiz-image-area" class="image-frame">
                    <!-- 画像がここに入ります -->
                </div>
                <h3 id="quiz-question-text" class="question-text">このイラストはどれかな？</h3>
                <div id="choice-buttons-area" class="choices-grid">
                    <!-- ボタンがここに入ります -->
                </div>
                <p id="quiz-feedback" class="feedback-area"></p>
                <div style="margin-top: 10px;">
                    <button onclick="location.reload()" style="background:none; border:none; color:#999; cursor:pointer; text-decoration:underline;">やめる</button>
                </div>
            </div>
        </div>

    </div>

    <!-- 音声ファイル -->
    <audio id="snd-correct" src="assets/sounds/seikai.mp3"></audio>
    <audio id="snd-incorrect" src="assets/sounds/bubu.mp3"></audio>
    <audio id="snd-fanfare" src="assets/sounds/fanfare.mp3"></audio>

<!-- ★★★ Firebase & ゲームロジック ★★★ -->
<script type="module">
    // Firebase SDKのインポート
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase設定 (あなたのプロジェクトの鍵)
    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebasestorage.app",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    // Firebase初期化
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --------------------------------------------------
    // ゲームデータ (画像はassets/images/にある前提)
    // --------------------------------------------------
    // ユーザー提供のファイル名リストに基づき、データ構造を更新しました。
    // 「reading」がないため、ここでは「ans」と「wrong」のデータのみを使用します。
    const QUESTIONS = [
        { id: 'ahiru', img: 'assets/images/ahiru.png', ans: 'あひる', wrong: ['あり', 'うし', 'あめ'] },
        { id: 'ajisai', img: 'assets/images/ajisai.png', ans: 'あじさい', wrong: ['さくら', 'ひまわり', 'ゆり'] },
        { id: 'aka', img: 'assets/images/aka.png', ans: 'あか', wrong: ['あお', 'みどり', 'くろ'] },
        { id: 'ame', img: 'assets/images/ame.png', ans: 'あめ', wrong: ['ゆき', 'たいよう', 'くも'] },
        { id: 'ao', img: 'assets/images/ao.png', ans: 'あお', wrong: ['あか', 'きいろ', 'しろ'] },
        { id: 'ari', img: 'assets/images/ari.png', ans: 'あり', wrong: ['いぬ', 'ねこ', 'ぞう'] },
        { id: 'ashi', img: 'assets/images/ashi.png', ans: 'あし', wrong: ['て', 'かお', 'くち'] },
        { id: 'atsui', img: 'assets/images/atsui.png', ans: 'あつい', wrong: ['さむい', 'いたい', 'わるい'] },
        { id: 'banana', img: 'assets/images/banana.png', ans: 'ばなな', wrong: ['りんご', 'みかん', 'いちご'] },
        { id: 'batsu', img: 'assets/images/batsu.png', ans: 'ばつ', wrong: ['まる', 'しかく', 'さんかく'] },
        { id: 'buta', img: 'assets/images/buta.png', ans: 'ぶた', wrong: ['うま', 'うし', 'しか'] },
        { id: 'cho', img: 'assets/images/cho.png', ans: 'ちょう', wrong: ['はち', 'あり', 'せみ'] },
        { id: 'churippu', img: 'assets/images/churippu.png', ans: 'ちゅーりっぷ', wrong: ['さくら', 'ばら', 'あじさい'] },
        { id: 'daikon', img: 'assets/images/daikon.png', ans: 'だいこん', wrong: ['にんじん', 'たまねぎ', 'なす'] },
        { id: 'dango', img: 'assets/images/dango.png', ans: 'だんご', wrong: ['おもち', 'おかし', 'まんじゅう'] },
        { id: 'daruma', img: 'assets/images/daruma.png', ans: 'だるま', wrong: ['こま', 'けん玉', 'おもちゃ'] },
        { id: 'densha', img: 'assets/images/densha.png', ans: 'でんしゃ', wrong: ['くるま', 'ひこうき', 'ふね'] },
        { id: 'ebi', img: 'assets/images/ebi.png', ans: 'えび', wrong: ['かに', 'いか', 'たこ'] },
        { id: 'ehon', img: 'assets/images/ehon.png', ans: 'えほん', wrong: ['ほん', 'ざっし', 'ノート'] },
        { id: 'enpitsu', img: 'assets/images/enpitsu.png', ans: 'えんぴつ', wrong: ['ペン', 'けしごむ', 'はさみ'] },
        { id: 'fujisan', img: 'assets/images/fujisan.png', ans: 'ふじさん', wrong: ['やま', 'かわ', 'みずうみ'] },
        { id: 'fuku', img: 'assets/images/fuku.png', ans: 'ふく', wrong: ['ぼうし', 'くつ', 'ズボン'] },
        { id: 'fune', img: 'assets/images/fune.png', ans: 'ふね', wrong: ['くるま', 'でんしゃ', 'ひこうき'] },
        { id: 'gakko', img: 'assets/images/gakko.png', ans: 'がっこう', wrong: ['いえ', 'みち', 'やま'] },
        { id: 'ginko', img: 'assets/images/ginko.png', ans: 'ぎんこう', wrong: ['がっこう', 'びょういん', 'こうえん'] },
        { id: 'gohan', img: 'assets/images/gohan.png', ans: 'ごはん', wrong: ['パン', 'めん', 'おにぎり'] },
        { id: 'gorira', img: 'assets/images/gorira.png', ans: 'ごりら', wrong: ['さる', 'くま', 'らいおん'] },
        { id: 'gyoza', img: 'assets/images/gyoza.png', ans: 'ぎょうざ', wrong: ['らーめん', 'すし', 'やきにく'] },
        { id: 'ha', img: 'assets/images/ha.png', ans: 'は', wrong: ['め', 'みみ', 'くち'] },
        { id: 'hana', img: 'assets/images/hana.png', ans: 'はな', wrong: ['き', 'はっぱ', 'くさ'] },
        { id: 'hanabi', img: 'assets/images/hanabi.png', ans: 'はなび', wrong: ['ほし', 'つき', 'たいよう'] },
        { id: 'hasami', img: 'assets/images/hasami.png', ans: 'はさみ', wrong: ['ナイフ', 'フォーク', 'スプーン'] },
        { id: 'hashi', img: 'assets/images/hashi.png', ans: 'はし', wrong: ['フォーク', 'スプーン', 'ナイフ'] },
        { id: 'hebi', img: 'assets/images/hebi.png', ans: 'へび', wrong: ['わに', 'とかげ', 'かめ'] },
        { id: 'hi', img: 'assets/images/hi.png', ans: 'ひ', wrong: ['みず', 'つち', 'かぜ'] },
        { id: 'hikoki', img: 'assets/images/hikoki.png', ans: 'ひこうき', wrong: ['くるま', 'でんしゃ', 'ふね'] },
        { id: 'himawari', img: 'assets/images/himawari.png', ans: 'ひまわり', wrong: ['さくら', 'ばら', 'ちゅーりっぷ'] },
        { id: 'hoshi', img: 'assets/images/hoshi.png', ans: 'ほし', wrong: ['つき', 'たいよう', 'くも'] },
        { id: 'ichi', img: 'assets/images/ichi.png', ans: 'いち', wrong: ['に', 'さん', 'よん'] },
        { id: 'ichigo', img: 'assets/images/ichigo.png', ans: 'いちご', wrong: ['りんご', 'みかん', 'ばなな'] },
        { id: 'ika', img: 'assets/images/ika.png', ans: 'いか', wrong: ['たこ', 'えび', 'かに'] },
        { id: 'inu', img: 'assets/images/inu.png', ans: 'いぬ', wrong: ['ねこ', 'ぶた', 'うま'] },
        { id: 'iruka', img: 'assets/images/iruka.png', ans: 'いるか', wrong: ['くじら', 'さかな', 'ぺんぎん'] },
        { id: 'ishi', img: 'assets/images/ishi.png', ans: 'いし', wrong: ['き', 'みず', 'つち'] },
        { id: 'isu', img: 'assets/images/isu.png', ans: 'いす', wrong: ['つくえ', 'テーブル', 'ベッド'] },
        { id: 'jitensha', img: 'assets/images/jitensha.png', ans: 'じてんしゃ', wrong: ['くるま', 'でんしゃ', 'バイク'] },
        { id: 'kaban', img: 'assets/images/kaban.png', ans: 'かばん', wrong: ['さいふ', 'ふくろ', 'くつ'] },
        { id: 'kaeru', img: 'assets/images/kaeru.png', ans: 'かえる', wrong: ['へび', 'とかげ', 'わに'] },
        { id: 'kagi', img: 'assets/images/kagi.png', ans: 'かぎ', wrong: ['ドア', 'かべ', 'とびら'] },
        { id: 'kame', img: 'assets/images/kame.png', ans: 'かめ', wrong: ['とかげ', 'わに', 'へび'] },
        { id: 'kasa', img: 'assets/images/kasa.png', ans: 'かさ', wrong: ['ぼうし', 'ふく', 'くつ'] },
        { id: 'kawa', img: 'assets/images/kawa.png', ans: 'かわ', wrong: ['うみ', 'みずうみ', 'いけ'] },
        { id: 'keito', img: 'assets/images/keito.png', ans: 'けいと', wrong: ['いと', 'ぬの', 'ふく'] },
        { id: 'kocha', img: 'assets/images/kocha.png', ans: 'こうちゃ', wrong: ['おちゃ', 'みず', 'コーヒー'] },
        { id: 'kodomo', img: 'assets/images/kodomo.png', ans: 'こども', wrong: ['おとな', 'せんせい', 'がくせい'] },
        { id: 'koi', img: 'assets/images/koi.png', ans: 'こい', wrong: ['さかな', 'たい', 'まぐろ'] },
        { id: 'koma', img: 'assets/images/koma.png', ans: 'こま', wrong: ['だるま', 'けん玉', 'おもちゃ'] },
        { id: 'koppu', img: 'assets/images/koppu.png', ans: 'コップ', wrong: ['さら', 'ちゃわん', 'おわん'] },
        { id: 'kuchi', img: 'assets/images/kuchi.png', ans: 'くち', wrong: ['め', 'はな', 'みみ'] },
        { id: 'kuma', img: 'assets/images/kuma.png', ans: 'くま', wrong: ['ごりら', 'ぱんだ', 'らいおん'] },
        { id: 'kumo', img: 'assets/images/kumo.png', ans: 'くも', wrong: ['たいよう', 'つき', 'ほし'] },
        { id: 'kuro', img: 'assets/images/kuro.png', ans: 'くろ', wrong: ['しろ', 'あか', 'あお'] },
        { id: 'kuruma', img: 'assets/images/kuruma.png', ans: 'くるま', wrong: ['でんしゃ', 'ひこうき', 'ふね'] },
        { id: 'kutsu', img: 'assets/images/kutsu.png', ans: 'くつ', wrong: ['くつした', 'ふく', 'ぼうし'] },
        { id: 'mado', img: 'assets/images/mado.png', ans: 'まど', wrong: ['ドア', 'かべ', 'ゆか'] },
        { id: 'maguro', img: 'assets/images/maguro.png', ans: 'まぐろ', wrong: ['たい', 'さかな', 'えび'] },
        { id: 'makura', img: 'assets/images/makura.png', ans: 'まくら', wrong: ['ベッド', 'ふとん', 'まっと'] },
        { id: 'mame', img: 'assets/images/mame.png', ans: 'まめ', wrong: ['いも', 'やさい', 'きのこ'] },
        { id: 'manga', img: 'assets/images/manga.png', ans: 'まんが', wrong: ['ほん', 'ざっし', 'しんぶん'] },
        { id: 'megane', img: 'assets/images/megane.png', ans: 'めがね', wrong: ['コンタクト', 'ぼうし', 'くつ'] },
        { id: 'michi', img: 'assets/images/michi.png', ans: 'みち', wrong: ['かわ', 'やま', 'うみ'] },
        { id: 'midori', img: 'assets/images/midori.png', ans: 'みどり', wrong: ['あか', 'あお', 'きいろ'] },
        { id: 'mikan', img: 'assets/images/mikan.png', ans: 'みかん', wrong: ['りんご', 'ばなな', 'いちご'] },
        { id: 'mizuumi', img: 'assets/images/mizuumi.png', ans: 'みずうみ', wrong: ['うみ', 'かわ', 'いけ'] },
        { id: 'momo', img: 'assets/images/momo.png', ans: 'もも', wrong: ['りんご', 'いちご', 'みかん'] },
        { id: 'mori', img: 'assets/images/mori.png', ans: 'もり', wrong: ['やま', 'かわ', 'うみ'] },
        { id: 'mushi', img: 'assets/images/mushi.png', ans: 'むし', wrong: ['いぬ', 'ねこ', 'さかな'] },
        { id: 'nabe', img: 'assets/images/nabe.png', ans: 'なべ', wrong: ['さら', 'ちゃわん', 'コップ'] },
        { id: 'namazu', img: 'assets/images/namazu.png', ans: 'なまず', wrong: ['さかな', 'うなぎ', 'どじょう'] },
        { id: 'nami', img: 'assets/images/nami.png', ans: 'なみ', wrong: ['かわ', 'うみ', 'みずうみ'] },
        { id: 'nana', img: 'assets/images/nana.png', ans: 'なな', wrong: ['ろく', 'はち', 'きゅう'] },
        { id: 'nashi', img: 'assets/images/nashi.png', ans: 'なし', wrong: ['りんご', 'みかん', 'いちご'] },
        { id: 'nasu', img: 'assets/images/nasu.png', ans: 'なす', wrong: ['きゅうり', 'にんじん', 'ピーマン'] },
        { id: 'neko', img: 'assets/images/neko.png', ans: 'ねこ', wrong: ['いぬ', 'ぶた', 'うま'] },
        { id: 'nezumi', img: 'assets/images/nezumi.png', ans: 'ねずみ', wrong: ['ねこ', 'いぬ', 'うさぎ'] },
        { id: 'niwa', img: 'assets/images/niwa.png', ans: 'にわ', wrong: ['いえ', 'がっこう', 'こうえん'] },
        { id: 'nori', img: 'assets/images/nori.png', ans: 'のり', wrong: ['ごはん', 'パン', 'さかな'] },
        { id: 'nuigurumi', img: 'assets/images/nuigurumi.png', ans: 'ぬいぐるみ', wrong: ['にんぎょう', 'おもちゃ', 'だるま'] },
        { id: 'nurie', img: 'assets/images/nurie.png', ans: 'ぬりえ', wrong: ['えほん', 'まんが', 'ざっし'] },
        { id: 'oka', img: 'assets/images/oka.png', ans: 'おか', wrong: ['やま', 'かわ', 'みずうみ'] },
        { id: 'okashi', img: 'assets/images/okashi.png', ans: 'おかし', wrong: ['ごはん', 'パン', 'やさい'] },
        { id: 'omocha', img: 'assets/images/omocha.png', ans: 'おもちゃ', wrong: ['ぬいぐるみ', 'にんぎょう', 'だるま'] },
        { id: 'oni', img: 'assets/images/oni.png', ans: 'おに', wrong: ['かみ', 'ひと', 'こども'] },
        { id: 'onigiri', img: 'assets/images/onigiri.png', ans: 'おにぎり', wrong: ['ごはん', 'パン', 'めん'] },
        { id: 'onsen', img: 'assets/images/onsen.png', ans: 'おんせん', wrong: ['かわ', 'うみ', 'みずうみ'] },
        { id: 'panda', img: 'assets/images/panda.png', ans: 'ぱんだ', wrong: ['くま', 'さる', 'らいおん'] },
        { id: 'raion', img: 'assets/images/raion.png', ans: 'らいおん', wrong: ['くま', 'とら', 'ぞう'] },
        { id: 'ramen', img: 'assets/images/ramen.png', ans: 'ラーメン', wrong: ['うどん', 'そば', 'パスタ'] },
        { id: 'rappa', img: 'assets/images/rappa.png', ans: 'らっぱ', wrong: ['たいこ', 'ギター', 'ピアノ'] },
        { id: 'ringo', img: 'assets/images/ringo.png', ans: 'りんご', wrong: ['みかん', 'いちご', 'ばなな'] },
        { id: 'risu', img: 'assets/images/risu.png', ans: 'りす', wrong: ['ねこ', 'いぬ', 'うさぎ'] },
        { id: 'roku', img: 'assets/images/roku.png', ans: 'ろく', wrong: ['ご', 'なな', 'はち'] },
        { id: 'sakana', img: 'assets/images/sakana.png', ans: 'さかな', wrong: ['とり', 'いぬ', 'ねこ'] },
        { id: 'sakura', img: 'assets/images/sakura.png', ans: 'さくら', wrong: ['ひまわり', 'ちゅーりっぷ', 'ばら'] },
        { id: 'saru', img: 'assets/images/saru.png', ans: 'さる', wrong: ['ごりら', 'くま', 'ぱんだ'] },
        { id: 'semi', img: 'assets/images/semi.png', ans: 'せみ', wrong: ['ちょう', 'はち', 'あり'] },
        { id: 'shiitake', img: 'assets/images/shiitake.png', ans: 'しいたけ', wrong: ['きのこ', 'まめ', 'やさい'] },
        { id: 'shika', img: 'assets/images/shika.png', ans: 'しか', wrong: ['うま', 'うし', 'ぶた'] },
        { id: 'shiro', img: 'assets/images/shiro.png', ans: 'しろ', wrong: ['くろ', 'あか', 'あお'] },
        { id: 'suika', img: 'assets/images/suika.png', ans: 'すいか', wrong: ['りんご', 'みかん', 'ばなな'] },
        { id: 'sushi', img: 'assets/images/sushi.png', ans: 'すし', wrong: ['さかな', 'ごはん', 'やさい'] },
        { id: 'suzume', img: 'assets/images/suzume.png', ans: 'すずめ', wrong: ['とり', 'つばめ', 'はと'] },
        { id: 'tai', img: 'assets/images/tai.png', ans: 'たい', wrong: ['まぐろ', 'さかな', 'こい'] },
        { id: 'tako', img: 'assets/images/tako.png', ans: 'たこ', wrong: ['いか', 'えび', 'かに'] },
        { id: 'tamago', img: 'assets/images/tamago.png', ans: 'たまご', wrong: ['ごはん', 'パン', 'やさい'] },
        { id: 'tanuki', img: 'assets/images/tanuki.png', ans: 'たぬき', wrong: ['きつね', 'いぬ', 'ねこ'] },
        { id: 'te', img: 'assets/images/te.png', ans: 'て', wrong: ['あし', 'かお', 'みみ'] },
        { id: 'terebi', img: 'assets/images/terebi.png', ans: 'テレビ', wrong: ['ラジオ', 'スマホ', 'パソコン'] },
        { id: 'tofu', img: 'assets/images/tofu.png', ans: 'とうふ', wrong: ['まめ', 'ごはん', 'パン'] },
        { id: 'tokei', img: 'assets/images/tokei.png', ans: 'とけい', wrong: ['かぎ', 'ドア', 'かべ'] },
        { id: 'tomato', img: 'assets/images/tomato.png', ans: 'とまと', wrong: ['きゅうり', 'なす', 'ピーマン'] },
        { id: 'tori', img: 'assets/images/tori.png', ans: 'とり', wrong: ['いぬ', 'ねこ', 'さかな'] },
        { id: 'tsubame', img: 'assets/images/tsubame.png', ans: 'つばめ', wrong: ['すずめ', 'はと', 'とり'] },
        { id: 'tsuki', img: 'assets/images/tsuki.png', ans: 'つき', wrong: ['たいよう', 'ほし', 'くも'] },
        { id: 'tsukue', img: 'assets/images/tsukue.png', ans: 'つくえ', wrong: ['いす', 'テーブル', 'ベッド'] },
        { id: 'ude', img: 'assets/images/ude.png', ans: 'うで', wrong: ['あし', 'て', 'かお'] },
        { id: 'uma', img: 'assets/images/uma.png', ans: 'うま', wrong: ['いぬ', 'ねこ', 'ぶた'] },
        { id: 'umi', img: 'assets/images/umi.png', ans: 'うみ', wrong: ['かわ', 'やま', 'みずうみ'] },
        { id: 'usagi', img: 'assets/images/usagi.png', ans: 'うさぎ', wrong: ['ねこ', 'いぬ', 'りす'] },
        { id: 'ushi', img: 'assets/images/ushi.png', ans: 'うし', wrong: ['ぶた', 'うま', 'しか'] },
        { id: 'wani', img: 'assets/images/wani.png', ans: 'わに', wrong: ['とかげ', 'へび', 'かめ'] },
        { id: 'yagi', img: 'assets/images/yagi.png', ans: 'やぎ', wrong: ['ひつじ', 'うま', 'うし'] },
        { id: 'yama', img: 'assets/images/yama.png', ans: 'やま', wrong: ['かわ', 'うみ', 'みち'] },
        { id: 'yuki', img: 'assets/images/yuki.png', ans: 'ゆき', wrong: ['あめ', 'くも', 'たいよう'] },
        { id: 'yubiwa', img: 'assets/images/yubiwa.png', ans: 'ゆびわ', wrong: ['くつ', 'ふく', 'ぼうし'] },
    ];

    // --------------------------------------------------
    // ゲームロジッククラス
    // --------------------------------------------------
    class HiraganaGame {
        constructor() {
            this.questions = [];
            this.currentQIndex = 0;
            this.score = 0;
            this.isAnswering = false;

            // DOM要素
            this.menuArea = document.getElementById('quiz-menu-area');
            this.gameArea = document.getElementById('quiz-game-area');
            this.turnMsg = document.getElementById('quiz-turn-message');
            this.scoreVal = document.getElementById('score-val');
            this.imgArea = document.getElementById('quiz-image-area');
            this.btnArea = document.getElementById('choice-buttons-area');
            this.feedback = document.getElementById('quiz-feedback');

            // 音声
            this.sndCorrect = document.getElementById('snd-correct');
            this.sndIncorrect = document.getElementById('snd-incorrect');
            this.sndFanfare = document.getElementById('snd-fanfare');
        }

        start() {
            // 問題をシャッフルしてセット (10問に限定)
            this.questions = [...QUESTIONS].sort(() => Math.random() - 0.5).slice(0, 10);
            this.currentQIndex = 0;
            this.score = 0;
            this.updateScoreUI();

            this.menuArea.style.display = 'none';
            this.gameArea.style.display = 'block';
            this.nextQuestion();
        }

        nextQuestion() {
            if (this.currentQIndex >= this.questions.length) {
                this.finishGame();
                return;
            }

            this.isAnswering = true;
            this.feedback.textContent = '';
            this.turnMsg.textContent = `問 ${this.currentQIndex + 1} / ${this.questions.length}`;

            const q = this.questions[this.currentQIndex];

            // 画像表示 (ない場合はプレースホルダー)
            const img = new Image();
            img.src = q.img;
            // エラー時のフォールバック画像
            img.onerror = () => { img.src = 'https://placehold.co/200x200/ef5350/ffffff?text=' + q.ans; }; 
            this.imgArea.innerHTML = '';
            this.imgArea.appendChild(img);

            // 選択肢作成
            let allAnswers = QUESTIONS.map(item => item.ans).filter(ans => ans !== q.ans);
            
            // 間違いの選択肢は3つ
            const wrongChoices = [...q.wrong]
                .filter(w => w !== q.ans)
                .slice(0, 3) // 既存の間違い候補から最大3つ
                .concat(allAnswers) // 残りを全体から補充
                .filter((value, index, self) => self.indexOf(value) === index) // 重複除去
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            const choices = [q.ans, ...wrongChoices].sort(() => Math.random() - 0.5);
            
            this.btnArea.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => this.checkAnswer(btn, choice, q.ans);
                this.btnArea.appendChild(btn);
            });
        }

        checkAnswer(btn, choice, correctAns) {
            if (!this.isAnswering) return;
            this.isAnswering = false;

            const allBtns = document.querySelectorAll('.choice-btn');
            allBtns.forEach(b => b.classList.add('disabled'));

            if (choice === correctAns) {
                // 正解
                btn.classList.add('correct');
                this.sndCorrect.currentTime = 0; 
                this.sndCorrect.play().catch(e=>{});
                this.feedback.textContent = 'せいかい！';
                this.feedback.style.color = 'var(--correct-color)';
                this.score += 10;
                this.updateScoreUI();
            } else {
                // 不正解
                btn.classList.add('incorrect');
                this.sndIncorrect.currentTime = 0; 
                this.sndIncorrect.play().catch(e=>{});
                this.feedback.textContent = `ざんねん… こたえは「${correctAns}」だよ`;
                this.feedback.style.color = 'var(--incorrect-color)';

                // 正解のボタンを教えてあげる
                allBtns.forEach(b => {
                    if (b.textContent === correctAns) b.classList.add('correct');
                });
            }

            // 次の問題へ
            setTimeout(() => {
                this.currentQIndex++;
                this.nextQuestion();
            }, 1500);
        }

        updateScoreUI() {
            this.scoreVal.textContent = this.score;
        }

        async finishGame() {
            this.imgArea.innerHTML = '<i class="fa-solid fa-crown" style="font-size:5em; color:#ffd700;"></i>';
            this.btnArea.innerHTML = '';
            this.feedback.textContent = `おしまい！ ${this.score}てん！`;
            this.feedback.style.color = 'var(--primary)';
            
            this.sndFanfare.currentTime = 0;
            this.sndFanfare.play().catch(e=>{});

            // ★★★ Firebaseへポイント送信 ★★★
            const user = sessionStorage.getItem('current_user');
            if (user && user !== 'ゲスト') {
                try {
                    const userRef = doc(db, "users", user);
                    await updateDoc(userRef, {
                        points: increment(this.score)
                    });
                    this.feedback.innerHTML += '<br><span style="font-size:0.8em; color:#666;">ランキングに反映しました！</span>';
                } catch (e) {
                    console.error("Error updating score: ", e);
                }
            }

            // リトライボタン
            setTimeout(() => {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'start-btn';
                retryBtn.textContent = 'もういちど';
                retryBtn.onclick = () => location.reload();
                this.btnArea.appendChild(retryBtn);
                this.btnArea.style.display = 'flex';
                this.btnArea.style.justifyContent = 'center';
            }, 1000);
        }
    }

    // グローバルに公開してHTMLから呼べるようにする
    window.game = new HiraganaGame();
    
    // 画像プリロード (任意)
    QUESTIONS.forEach(q => { const i = new Image(); i.src = q.img; });

</script>

</body>
</html>