<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Å≤„Çâ„Åå„Å™ÂçòË™û„Ç≤„Éº„É† - FunLearnJP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- „Ç´„É©„ÉºË®≠ÂÆö --- */
        :root {
            --primary: #5c7aff;
            --accent: #ffcc5c;
            --bg-color: #f4f7fc;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #ef5350;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3); z-index: 100;
        }
        .logo { font-size: 1.4em; font-weight: 900; display: flex; align-items: center; gap: 10px; color: white; text-decoration: none; }
        .home-icon { color: white; font-size: 1.5em; transition: transform 0.2s; }

        /* --- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        .main-container {
            flex-grow: 1; padding: 20px; max-width: 700px;
            margin: 0 auto; width: 100%; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: center;
        }

        /* --- „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ --- */
        .quiz-card {
            background: white; border-radius: 25px; padding: 30px 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); text-align: center;
            border: 4px solid white; width: 100%; box-sizing: border-box;
        }

        /* --- „É°„Éã„É•„ÉºÁîªÈù¢ --- */
        .menu-icon { font-size: 5em; color: #ff6f61; margin-bottom: 15px; animation: bounce 2s infinite; }
        .menu-title { font-size: 2em; color: var(--primary); margin: 0 0 10px 0; }
        .menu-desc { color: #666; margin-bottom: 20px; font-size: 1.1em; }
        .rule-box { background: #fff8e1; padding: 15px; border-radius: 15px; margin-bottom: 25px; color: #5d4037; }
        
        .start-btn {
            background: linear-gradient(to bottom, #5c7aff, #4b63cc);
            color: white; font-size: 1.6em; font-weight: 900;
            padding: 15px 50px; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 6px 0 #3f51b5;
            margin-bottom: 15px; display: inline-block; width: 80%; max-width: 300px;
        }
        .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #3f51b5; }
        .home-btn-text { color: #999; text-decoration: none; font-weight: bold; display: block; margin-top: 10px; }

        /* --- „Ç≤„Éº„É†ÁîªÈù¢ --- */
        .score-board {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 10px 20px;
            background: white; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-weight: bold; color: var(--primary);
        }

        .image-frame {
            width: 200px; height: 200px; margin: 0 auto 20px;
            background: #fffbea; border: 6px solid var(--accent);
            border-radius: 25px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .image-frame img { width: 90%; height: 90%; object-fit: contain; }
        
        .question-text { font-size: 1.4em; font-weight: bold; color: #444; margin-bottom: 20px; }

        /* --- ÈÅ∏ÊäûËÇ¢„Ç∞„É™„ÉÉ„Éâ --- */
        .choices-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; margin-bottom: 20px;
        }

        .choice-btn {
            background-color: #ffffff; border: 3px solid #dce0e5; border-radius: 15px;
            color: #555; font-size: 1.3em; font-weight: 800;
            padding: 15px 5px; width: 100%; min-height: 70px;
            cursor: pointer; box-shadow: 0 4px 0 #cfd8dc; transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .choice-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: 0 6px 0 #cfd8dc; }
        .choice-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .choice-btn.correct { background-color: var(--correct-color); border-color: var(--correct-color); color: white; box-shadow: 0 4px 0 #2e7d32; }
        .choice-btn.incorrect { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: white; opacity: 0.6; box-shadow: none; }
        .choice-btn.disabled { pointer-events: none; }

        .feedback-area { min-height: 1.5em; margin-top: 10px; font-size: 1.3em; font-weight: 900; }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</a>
        <a href="index.html" class="home-icon"><i class="fa-solid fa-house"></i></a>
    </header>

    <div class="main-container">
        
        <div id="quiz-menu-area" class="pop-in">
            <div class="quiz-card">
                <i class="fa-solid fa-shapes menu-icon"></i>
                <h1 class="menu-title">„Å≤„Çâ„Åå„Å™ÂçòË™û</h1>
                <p class="menu-desc">„Åà „Çí „Åø„Å¶ „Åü„Å†„Åó„ÅÑ „Åì„Å®„Å∞ „Çí„Åà„Çâ„Åº„ÅÜÔºÅ</p>
                <div class="rule-box">
                    <div id="quiz-score-message">
                        „Åú„Çì„Å∂„Åß <strong>10„ÇÇ„Çì</strong> „ÅÇ„Çã„Çà„ÄÇ<br>
                        „Åä„Å™„Åò„ÇÇ„Çì„Å†„ÅÑ„ÅØ 1Êó•1„Éù„Ç§„É≥„Éà„Å†„ÇàÔºÅ
                    </div>
                    <div id="auth-status" class="mt-3 text-sm font-medium text-indigo-700">Ë™çË®º‰∏≠...</div>
                </div>
                <button id="quizStartButton" class="start-btn" onclick="game.start()">
                    <i class="fa-solid fa-play"></i> „Çπ„Çø„Éº„ÉàÔºÅ
                </button>
                <a href="index.html" class="home-btn-text">„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã</a>
            </div>
        </div>

        <div id="quiz-game-area" style="display:none;" class="pop-in">
            <div class="score-board">
                <span id="quiz-turn-message">Âïè 1 / 10</span>
                <span><i class="fa-solid fa-star" style="color:#f0ad4e;"></i> <span id="score-val">0</span></span>
            </div>
            <div class="quiz-card">
                <div id="quiz-image-area" class="image-frame">
                    </div>
                <h3 id="quiz-question-text" class="question-text">„Åì„ÅÆ„Ç§„É©„Çπ„Éà„ÅØ„Å©„Çå„Åã„Å™Ôºü</h3>
                <div id="choice-buttons-area" class="choices-grid">
                    </div>
                <p id="quiz-feedback" class="feedback-area"></p>
                <div style="margin-top: 10px;">
                    <button onclick="location.reload()" style="background:none; border:none; color:#999; cursor:pointer; text-decoration:underline;">„ÇÑ„ÇÅ„Çã</button>
                </div>
            </div>
        </div>

    </div>

    <audio id="snd-correct" src="assets/sounds/seikai.mp3"></audio>
    <audio id="snd-incorrect" src="assets/sounds/bubu.mp3"></audio>
    <audio id="snd-fanfare" src="assets/sounds/fanfare.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // ‚òÖ‚òÖ‚òÖ Firebase Config ‚òÖ‚òÖ‚òÖ
    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebasestorage.app",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    let app = null, auth = null, db = null;
    let currentUserId = null;
    let userDisplayName = null;
    const authStatusEl = document.getElementById('auth-status');

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (error) {
        if(authStatusEl) authStatusEl.textContent = `„Ç®„É©„Éº: ${error.message}`;
    }

    if (auth) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userDisplayName = user.displayName || `Player`;
                if(authStatusEl) authStatusEl.textContent = `‚úÖ „É≠„Ç∞„Ç§„É≥‰∏≠: ${userDisplayName}`;
            } else {
                currentUserId = null;
                userDisplayName = '„Ç≤„Çπ„Éà';
                if(authStatusEl) authStatusEl.textContent = '‚ùå „Ç≤„Çπ„Éà„É¢„Éº„Éâ („Éù„Ç§„É≥„Éà„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì)';
            }
        });
    }

    /**
     * ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºö1Êó•1ÂõûÂà∂Èôê‰ªò„Åç„ÅÆ„Éù„Ç§„É≥„ÉàÂä†ÁÆóÈñ¢Êï∞ ‚òÖ‚òÖ‚òÖ
     * Firestore„ÅÆ„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„Çí‰ΩøÁî®„Åó„Å¶Ê≠£Á¢∫„Å´Ë®àÁÆó„Åó„Åæ„Åô
     */
    async function submitDailyPoints(correctQuestionIds) {
        if (!currentUserId || !db || correctQuestionIds.length === 0) return 0;

        const userRef = doc(db, "users", currentUserId);
        // ‰ªäÊó•„ÅÆÊó•‰ªòÊñáÂ≠óÂàó„Çí‰ΩúÊàê (‰æã: "2023-12-17") - „É¶„Éº„Ç∂„Éº„ÅÆ„É≠„Éº„Ç´„É´ÊôÇÈñì„Éô„Éº„Çπ
        const todayStr = new Date().toDateString();

        try {
            const addedPoints = await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userRef);
                
                if (!userDoc.exists()) {
                    // „Éâ„Ç≠„É•„É°„É≥„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
                    transaction.set(userRef, {
                        displayName: userDisplayName,
                        points: correctQuestionIds.length,
                        solvedDate: todayStr,
                        solvedIds: correctQuestionIds,
                        lastLogin: new Date().toISOString()
                    });
                    return correctQuestionIds.length;
                }

                const data = userDoc.data();
                const lastSolvedDate = data.solvedDate || "";
                let solvedIds = data.solvedIds || [];
                let currentPoints = data.points || 0;

                // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„Åü„Çâ„ÄÅÊ∏à„Çì„Å†ÂïèÈ°å„É™„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
                if (lastSolvedDate !== todayStr) {
                    solvedIds = [];
                }

                // „Åæ„Å†Ëß£„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂïèÈ°åID„Å†„Åë„Çí„Ç´„Ç¶„É≥„Éà
                let newPoints = 0;
                const newSolvedIds = [...solvedIds];

                correctQuestionIds.forEach(id => {
                    if (!newSolvedIds.includes(id)) {
                        newPoints++;
                        newSolvedIds.push(id);
                    }
                });

                // „Éù„Ç§„É≥„Éà„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞
                if (newPoints > 0) {
                    transaction.update(userRef, {
                        points: currentPoints + newPoints,
                        solvedDate: todayStr,
                        solvedIds: newSolvedIds,
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Êó•‰ªòÊõ¥Êñ∞„Å†„Åë„Åó„Å¶„Åä„ÅèÔºà„É≠„Ç∞„Ç§„É≥Ë®òÈå≤„Å®„Åó„Å¶Ôºâ
                    if (lastSolvedDate !== todayStr) {
                         transaction.update(userRef, {
                            solvedDate: todayStr,
                            solvedIds: [] // ‰ªäÊó•„ÅØ„Åæ„Å†0„Éù„Ç§„É≥„Éà„Å†„ÅåÊó•‰ªò„ÅØÊõ¥Êñ∞
                         });
                    }
                }

                return newPoints; // ÂÆüÈöõ„Å´Â¢ó„Åà„Åü„Éù„Ç§„É≥„Éà„ÇíËøî„Åô
            });

            return addedPoints;
        } catch (e) {
            console.error("„Éù„Ç§„É≥„ÉàÂá¶ÁêÜ„Ç®„É©„Éº:", e);
            return 0;
        }
    }

    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã (Game„ÇØ„É©„Çπ„Åã„ÇâÂëº„Å∂„Åü„ÇÅ)
    window.submitDailyPoints = submitDailyPoints;

    // =========================================================
    // „Ç≤„Éº„É†„Éá„Éº„Çø (ID„ÇíËøΩÂä†)
    // =========================================================
    const QUESTIONS = [
        { id: 'ahiru', img: 'assets/images/ahiru.png', ans: '„ÅÇ„Å≤„Çã', wrong: ['„ÅÇ„Çä', '„ÅÜ„Åó', '„ÅÇ„ÇÅ'] },
        { id: 'ajisai', img: 'assets/images/ajisai.png', ans: '„ÅÇ„Åò„Åï„ÅÑ', wrong: ['„Åï„Åè„Çâ', '„Å≤„Åæ„Çè„Çä', '„ÇÜ„Çä'] },
        { id: 'aka', img: 'assets/images/aka.png', ans: '„ÅÇ„Åã', wrong: ['„ÅÇ„Åä', '„Åø„Å©„Çä', '„Åè„Çç'] },
        { id: 'ame', img: 'assets/images/ame.png', ans: '„ÅÇ„ÇÅ', wrong: ['„ÇÜ„Åç', '„Åü„ÅÑ„Çà„ÅÜ', '„Åè„ÇÇ'] },
        { id: 'ao', img: 'assets/images/ao.png', ans: '„ÅÇ„Åä', wrong: ['„ÅÇ„Åã', '„Åç„ÅÑ„Çç', '„Åó„Çç'] },
        { id: 'ari', img: 'assets/images/ari.png', ans: '„ÅÇ„Çä', wrong: ['„ÅÑ„Å¨', '„Å≠„Åì', '„Åû„ÅÜ'] },
        { id: 'ashi', img: 'assets/images/ashi.png', ans: '„ÅÇ„Åó', wrong: ['„Å¶', '„Åã„Åä', '„Åè„Å°'] },
        { id: 'atsui', img: 'assets/images/atsui.png', ans: '„ÅÇ„Å§„ÅÑ', wrong: ['„Åï„ÇÄ„ÅÑ', '„ÅÑ„Åü„ÅÑ', '„Çè„Çã„ÅÑ'] },
        { id: 'banana', img: 'assets/images/banana.png', ans: '„Å∞„Å™„Å™', wrong: ['„Çä„Çì„Åî', '„Åø„Åã„Çì', '„ÅÑ„Å°„Åî'] },
        { id: 'batsu', img: 'assets/images/batsu.png', ans: '„Å∞„Å§', wrong: ['„Åæ„Çã', '„Åó„Åã„Åè', '„Åï„Çì„Åã„Åè'] },
        { id: 'buta', img: 'assets/images/buta.png', ans: '„Å∂„Åü', wrong: ['„ÅÜ„Åæ', '„ÅÜ„Åó', '„Åó„Åã'] },
        { id: 'cho', img: 'assets/images/cho.png', ans: '„Å°„Çá„ÅÜ', wrong: ['„ÅØ„Å°', '„ÅÇ„Çä', '„Åõ„Åø'] },
        { id: 'churippu', img: 'assets/images/churippu.png', ans: '„Å°„ÇÖ„Éº„Çä„Å£„Å∑', wrong: ['„Åï„Åè„Çâ', '„Å∞„Çâ', '„ÅÇ„Åò„Åï„ÅÑ'] },
        { id: 'daikon', img: 'assets/images/daikon.png', ans: '„Å†„ÅÑ„Åì„Çì', wrong: ['„Å´„Çì„Åò„Çì', '„Åü„Åæ„Å≠„Åé', '„Å™„Åô'] },
        { id: 'dango', img: 'assets/images/dango.png', ans: '„Å†„Çì„Åî', wrong: ['„Åä„ÇÇ„Å°', '„Åä„Åã„Åó', '„Åæ„Çì„Åò„ÇÖ„ÅÜ'] },
        { id: 'daruma', img: 'assets/images/daruma.png', ans: '„Å†„Çã„Åæ', wrong: ['„Åì„Åæ', '„Åë„ÇìÁéâ', '„Åä„ÇÇ„Å°„ÇÉ'] },
        { id: 'densha', img: 'assets/images/densha.png', ans: '„Åß„Çì„Åó„ÇÉ', wrong: ['„Åè„Çã„Åæ', '„Å≤„Åì„ÅÜ„Åç', '„Åµ„Å≠'] },
        { id: 'ebi', img: 'assets/images/ebi.png', ans: '„Åà„Å≥', wrong: ['„Åã„Å´', '„ÅÑ„Åã', '„Åü„Åì'] },
        { id: 'ehon', img: 'assets/images/ehon.png', ans: '„Åà„Åª„Çì', wrong: ['„Åª„Çì', '„Åñ„Å£„Åó', '„Éé„Éº„Éà'] },
        { id: 'enpitsu', img: 'assets/images/enpitsu.png', ans: '„Åà„Çì„Å¥„Å§', wrong: ['„Éö„É≥', '„Åë„Åó„Åî„ÇÄ', '„ÅØ„Åï„Åø'] },
        { id: 'fujisan', img: 'assets/images/fujisan.png', ans: '„Åµ„Åò„Åï„Çì', wrong: ['„ÇÑ„Åæ', '„Åã„Çè', '„Åø„Åö„ÅÜ„Åø'] },
        { id: 'fuku', img: 'assets/images/fuku.png', ans: '„Åµ„Åè', wrong: ['„Åº„ÅÜ„Åó', '„Åè„Å§', '„Ç∫„Éú„É≥'] },
        { id: 'fune', img: 'assets/images/fune.png', ans: '„Åµ„Å≠', wrong: ['„Åè„Çã„Åæ', '„Åß„Çì„Åó„ÇÉ', '„Å≤„Åì„ÅÜ„Åç'] },
        { id: 'gakko', img: 'assets/images/gakko.png', ans: '„Åå„Å£„Åì„ÅÜ', wrong: ['„ÅÑ„Åà', '„Åø„Å°', '„ÇÑ„Åæ'] },
        { id: 'ginko', img: 'assets/images/ginko.png', ans: '„Åé„Çì„Åì„ÅÜ', wrong: ['„Åå„Å£„Åì„ÅÜ', '„Å≥„Çá„ÅÜ„ÅÑ„Çì', '„Åì„ÅÜ„Åà„Çì'] },
        { id: 'gohan', img: 'assets/images/gohan.png', ans: '„Åî„ÅØ„Çì', wrong: ['„Éë„É≥', '„ÇÅ„Çì', '„Åä„Å´„Åé„Çä'] },
        { id: 'gorira', img: 'assets/images/gorira.png', ans: '„Åî„Çä„Çâ', wrong: ['„Åï„Çã', '„Åè„Åæ', '„Çâ„ÅÑ„Åä„Çì'] },
        { id: 'gyoza', img: 'assets/images/gyoza.png', ans: '„Åé„Çá„ÅÜ„Åñ', wrong: ['„Çâ„Éº„ÇÅ„Çì', '„Åô„Åó', '„ÇÑ„Åç„Å´„Åè'] },
        { id: 'ha', img: 'assets/images/ha.png', ans: '„ÅØ', wrong: ['„ÇÅ', '„Åø„Åø', '„Åè„Å°'] },
        { id: 'hana', img: 'assets/images/hana.png', ans: '„ÅØ„Å™', wrong: ['„Åç', '„ÅØ„Å£„Å±', '„Åè„Åï'] },
        { id: 'hanabi', img: 'assets/images/hanabi.png', ans: '„ÅØ„Å™„Å≥', wrong: ['„Åª„Åó', '„Å§„Åç', '„Åü„ÅÑ„Çà„ÅÜ'] },
        { id: 'hasami', img: 'assets/images/hasami.png', ans: '„ÅØ„Åï„Åø', wrong: ['„Éä„Ç§„Éï', '„Éï„Ç©„Éº„ÇØ', '„Çπ„Éó„Éº„É≥'] },
        { id: 'hashi', img: 'assets/images/hashi.png', ans: '„ÅØ„Åó', wrong: ['„Éï„Ç©„Éº„ÇØ', '„Çπ„Éó„Éº„É≥', '„Éä„Ç§„Éï'] },
        { id: 'hebi', img: 'assets/images/hebi.png', ans: '„Å∏„Å≥', wrong: ['„Çè„Å´', '„Å®„Åã„Åí', '„Åã„ÇÅ'] },
        { id: 'hi', img: 'assets/images/hi.png', ans: '„Å≤', wrong: ['„Åø„Åö', '„Å§„Å°', '„Åã„Åú'] },
        { id: 'hikoki', img: 'assets/images/hikoki.png', ans: '„Å≤„Åì„ÅÜ„Åç', wrong: ['„Åè„Çã„Åæ', '„Åß„Çì„Åó„ÇÉ', '„Åµ„Å≠'] },
        { id: 'himawari', img: 'assets/images/himawari.png', ans: '„Å≤„Åæ„Çè„Çä', wrong: ['„Åï„Åè„Çâ', '„Å∞„Çâ', '„Å°„ÇÖ„Éº„Çä„Å£„Å∑'] },
        { id: 'hoshi', img: 'assets/images/hoshi.png', ans: '„Åª„Åó', wrong: ['„Å§„Åç', '„Åü„ÅÑ„Çà„ÅÜ', '„Åè„ÇÇ'] },
        { id: 'ichi', img: 'assets/images/ichi.png', ans: '„ÅÑ„Å°', wrong: ['„Å´', '„Åï„Çì', '„Çà„Çì'] },
        { id: 'ichigo', img: 'assets/images/ichigo.png', ans: '„ÅÑ„Å°„Åî', wrong: ['„Çä„Çì„Åî', '„Åø„Åã„Çì', '„Å∞„Å™„Å™'] },
        { id: 'ika', img: 'assets/images/ika.png', ans: '„ÅÑ„Åã', wrong: ['„Åü„Åì', '„Åà„Å≥', '„Åã„Å´'] },
        { id: 'inu', img: 'assets/images/inu.png', ans: '„ÅÑ„Å¨', wrong: ['„Å≠„Åì', '„Å∂„Åü', '„ÅÜ„Åæ'] },
        { id: 'iruka', img: 'assets/images/iruka.png', ans: '„ÅÑ„Çã„Åã', wrong: ['„Åè„Åò„Çâ', '„Åï„Åã„Å™', '„Å∫„Çì„Åé„Çì'] },
        { id: 'ishi', img: 'assets/images/ishi.png', ans: '„ÅÑ„Åó', wrong: ['„Åç', '„Åø„Åö', '„Å§„Å°'] },
        { id: 'isu', img: 'assets/images/isu.png', ans: '„ÅÑ„Åô', wrong: ['„Å§„Åè„Åà', '„ÉÜ„Éº„Éñ„É´', '„Éô„ÉÉ„Éâ'] },
        { id: 'jitensha', img: 'assets/images/jitensha.png', ans: '„Åò„Å¶„Çì„Åó„ÇÉ', wrong: ['„Åè„Çã„Åæ', '„Åß„Çì„Åó„ÇÉ', '„Éê„Ç§„ÇØ'] },
        { id: 'kaban', img: 'assets/images/kaban.png', ans: '„Åã„Å∞„Çì', wrong: ['„Åï„ÅÑ„Åµ', '„Åµ„Åè„Çç', '„Åè„Å§'] },
        { id: 'kaeru', img: 'assets/images/kaeru.png', ans: '„Åã„Åà„Çã', wrong: ['„Å∏„Å≥', '„Å®„Åã„Åí', '„Çè„Å´'] },
        { id: 'kagi', img: 'assets/images/kagi.png', ans: '„Åã„Åé', wrong: ['„Éâ„Ç¢', '„Åã„Åπ', '„Å®„Å≥„Çâ'] },
        { id: 'kame', img: 'assets/images/kame.png', ans: '„Åã„ÇÅ', wrong: ['„Å®„Åã„Åí', '„Çè„Å´', '„Å∏„Å≥'] },
        { id: 'kasa', img: 'assets/images/kasa.png', ans: '„Åã„Åï', wrong: ['„Åº„ÅÜ„Åó', '„Åµ„Åè', '„Åè„Å§'] },
        { id: 'kawa', img: 'assets/images/kawa.png', ans: '„Åã„Çè', wrong: ['„ÅÜ„Åø', '„Åø„Åö„ÅÜ„Åø', '„ÅÑ„Åë'] },
        { id: 'keito', img: 'assets/images/keito.png', ans: '„Åë„ÅÑ„Å®', wrong: ['„ÅÑ„Å®', '„Å¨„ÅÆ', '„Åµ„Åè'] },
        { id: 'kocha', img: 'assets/images/kocha.png', ans: '„Åì„ÅÜ„Å°„ÇÉ', wrong: ['„Åä„Å°„ÇÉ', '„Åø„Åö', '„Ç≥„Éº„Éí„Éº'] },
        { id: 'kodomo', img: 'assets/images/kodomo.png', ans: '„Åì„Å©„ÇÇ', wrong: ['„Åä„Å®„Å™', '„Åõ„Çì„Åõ„ÅÑ', '„Åå„Åè„Åõ„ÅÑ'] },
        { id: 'koi', img: 'assets/images/koi.png', ans: '„Åì„ÅÑ', wrong: ['„Åï„Åã„Å™', '„Åü„ÅÑ', '„Åæ„Åê„Çç'] },
        { id: 'koma', img: 'assets/images/koma.png', ans: '„Åì„Åæ', wrong: ['„Å†„Çã„Åæ', '„Åë„ÇìÁéâ', '„Åä„ÇÇ„Å°„ÇÉ'] },
        { id: 'koppu', img: 'assets/images/koppu.png', ans: '„Ç≥„ÉÉ„Éó', wrong: ['„Åï„Çâ', '„Å°„ÇÉ„Çè„Çì', '„Åä„Çè„Çì'] },
        { id: 'kuchi', img: 'assets/images/kuchi.png', ans: '„Åè„Å°', wrong: ['„ÇÅ', '„ÅØ„Å™', '„Åø„Åø'] },
        { id: 'kuma', img: 'assets/images/kuma.png', ans: '„Åè„Åæ', wrong: ['„Åî„Çä„Çâ', '„Å±„Çì„Å†', '„Çâ„ÅÑ„Åä„Çì'] },
        { id: 'kumo', img: 'assets/images/kumo.png', ans: '„Åè„ÇÇ', wrong: ['„Åü„ÅÑ„Çà„ÅÜ', '„Å§„Åç', '„Åª„Åó'] },
        { id: 'kuro', img: 'assets/images/kuro.png', ans: '„Åè„Çç', wrong: ['„Åó„Çç', '„ÅÇ„Åã', '„ÅÇ„Åä'] },
        { id: 'kuruma', img: 'assets/images/kuruma.png', ans: '„Åè„Çã„Åæ', wrong: ['„Åß„Çì„Åó„ÇÉ', '„Å≤„Åì„ÅÜ„Åç', '„Åµ„Å≠'] },
        { id: 'kutsu', img: 'assets/images/kutsu.png', ans: '„Åè„Å§', wrong: ['„Åè„Å§„Åó„Åü', '„Åµ„Åè', '„Åº„ÅÜ„Åó'] },
        { id: 'mado', img: 'assets/images/mado.png', ans: '„Åæ„Å©', wrong: ['„Éâ„Ç¢', '„Åã„Åπ', '„ÇÜ„Åã'] },
        { id: 'maguro', img: 'assets/images/maguro.png', ans: '„Åæ„Åê„Çç', wrong: ['„Åü„ÅÑ', '„Åï„Åã„Å™', '„Åà„Å≥'] },
        { id: 'makura', img: 'assets/images/makura.png', ans: '„Åæ„Åè„Çâ', wrong: ['„Éô„ÉÉ„Éâ', '„Åµ„Å®„Çì', '„Åæ„Å£„Å®'] },
        { id: 'mame', img: 'assets/images/mame.png', ans: '„Åæ„ÇÅ', wrong: ['„ÅÑ„ÇÇ', '„ÇÑ„Åï„ÅÑ', '„Åç„ÅÆ„Åì'] },
        { id: 'manga', img: 'assets/images/manga.png', ans: '„Åæ„Çì„Åå', wrong: ['„Åª„Çì', '„Åñ„Å£„Åó', '„Åó„Çì„Å∂„Çì'] },
        { id: 'megane', img: 'assets/images/megane.png', ans: '„ÇÅ„Åå„Å≠', wrong: ['„Ç≥„É≥„Çø„ÇØ„Éà', '„Åº„ÅÜ„Åó', '„Åè„Å§'] },
        { id: 'michi', img: 'assets/images/michi.png', ans: '„Åø„Å°', wrong: ['„Åã„Çè', '„ÇÑ„Åæ', '„ÅÜ„Åø'] },
        { id: 'midori', img: 'assets/images/midori.png', ans: '„Åø„Å©„Çä', wrong: ['„ÅÇ„Åã', '„ÅÇ„Åä', '„Åç„ÅÑ„Çç'] },
        { id: 'mikan', img: 'assets/images/mikan.png', ans: '„Åø„Åã„Çì', wrong: ['„Çä„Çì„Åî', '„Å∞„Å™„Å™', '„ÅÑ„Å°„Åî'] },
        { id: 'mizuumi', img: 'assets/images/mizuumi.png', ans: '„Åø„Åö„ÅÜ„Åø', wrong: ['„ÅÜ„Åø', '„Åã„Çè', '„ÅÑ„Åë'] },
        { id: 'momo', img: 'assets/images/momo.png', ans: '„ÇÇ„ÇÇ', wrong: ['„Çä„Çì„Åî', '„ÅÑ„Å°„Åî', '„Åø„Åã„Çì'] },
        { id: 'mori', img: 'assets/images/mori.png', ans: '„ÇÇ„Çä', wrong: ['„ÇÑ„Åæ', '„Åã„Çè', '„ÅÜ„Åø'] },
        { id: 'mushi', img: 'assets/images/mushi.png', ans: '„ÇÄ„Åó', wrong: ['„ÅÑ„Å¨', '„Å≠„Åì', '„Åï„Åã„Å™'] },
        { id: 'nabe', img: 'assets/images/nabe.png', ans: '„Å™„Åπ', wrong: ['„Åï„Çâ', '„Å°„ÇÉ„Çè„Çì', '„Ç≥„ÉÉ„Éó'] },
        { id: 'namazu', img: 'assets/images/namazu.png', ans: '„Å™„Åæ„Åö', wrong: ['„Åï„Åã„Å™', '„ÅÜ„Å™„Åé', '„Å©„Åò„Çá„ÅÜ'] },
        { id: 'nami', img: 'assets/images/nami.png', ans: '„Å™„Åø', wrong: ['„Åã„Çè', '„ÅÜ„Åø', '„Åø„Åö„ÅÜ„Åø'] },
        { id: 'nana', img: 'assets/images/nana.png', ans: '„Å™„Å™', wrong: ['„Çç„Åè', '„ÅØ„Å°', '„Åç„ÇÖ„ÅÜ'] },
        { id: 'nashi', img: 'assets/images/nashi.png', ans: '„Å™„Åó', wrong: ['„Çä„Çì„Åî', '„Åø„Åã„Çì', '„ÅÑ„Å°„Åî'] },
        { id: 'nasu', img: 'assets/images/nasu.png', ans: '„Å™„Åô', wrong: ['„Åç„ÇÖ„ÅÜ„Çä', '„Å´„Çì„Åò„Çì', '„Éî„Éº„Éû„É≥'] },
        { id: 'neko', img: 'assets/images/neko.png', ans: '„Å≠„Åì', wrong: ['„ÅÑ„Å¨', '„Å∂„Åü', '„ÅÜ„Åæ'] },
        { id: 'nezumi', img: 'assets/images/nezumi.png', ans: '„Å≠„Åö„Åø', wrong: ['„Å≠„Åì', '„ÅÑ„Å¨', '„ÅÜ„Åï„Åé'] },
        { id: 'niwa', img: 'assets/images/niwa.png', ans: '„Å´„Çè', wrong: ['„ÅÑ„Åà', '„Åå„Å£„Åì„ÅÜ', '„Åì„ÅÜ„Åà„Çì'] },
        { id: 'nori', img: 'assets/images/nori.png', ans: '„ÅÆ„Çä', wrong: ['„Åî„ÅØ„Çì', '„Éë„É≥', '„Åï„Åã„Å™'] },
        { id: 'nuigurumi', img: 'assets/images/nuigurumi.png', ans: '„Å¨„ÅÑ„Åê„Çã„Åø', wrong: ['„Å´„Çì„Åé„Çá„ÅÜ', '„Åä„ÇÇ„Å°„ÇÉ', '„Å†„Çã„Åæ'] },
        { id: 'nurie', img: 'assets/images/nurie.png', ans: '„Å¨„Çä„Åà', wrong: ['„Åà„Åª„Çì', '„Åæ„Çì„Åå', '„Åñ„Å£„Åó'] },
        { id: 'oka', img: 'assets/images/oka.png', ans: '„Åä„Åã', wrong: ['„ÇÑ„Åæ', '„Åã„Çè', '„Åø„Åö„ÅÜ„Åø'] },
        { id: 'okashi', img: 'assets/images/okashi.png', ans: '„Åä„Åã„Åó', wrong: ['„Åî„ÅØ„Çì', '„Éë„É≥', '„ÇÑ„Åï„ÅÑ'] },
        { id: 'omocha', img: 'assets/images/omocha.png', ans: '„Åä„ÇÇ„Å°„ÇÉ', wrong: ['„Å¨„ÅÑ„Åê„Çã„Åø', '„Å´„Çì„Åé„Çá„ÅÜ', '„Å†„Çã„Åæ'] },
        { id: 'oni', img: 'assets/images/oni.png', ans: '„Åä„Å´', wrong: ['„Åã„Åø', '„Å≤„Å®', '„Åì„Å©„ÇÇ'] },
        { id: 'onigiri', img: 'assets/images/onigiri.png', ans: '„Åä„Å´„Åé„Çä', wrong: ['„Åî„ÅØ„Çì', '„Éë„É≥', '„ÇÅ„Çì'] },
        { id: 'onsen', img: 'assets/images/onsen.png', ans: '„Åä„Çì„Åõ„Çì', wrong: ['„Åã„Çè', '„ÅÜ„Åø', '„Åø„Åö„ÅÜ„Åø'] },
        { id: 'panda', img: 'assets/images/panda.png', ans: '„Å±„Çì„Å†', wrong: ['„Åè„Åæ', '„Åï„Çã', '„Çâ„ÅÑ„Åä„Çì'] },
        { id: 'raion', img: 'assets/images/raion.png', ans: '„Çâ„ÅÑ„Åä„Çì', wrong: ['„Åè„Åæ', '„Å®„Çâ', '„Åû„ÅÜ'] },
        { id: 'ramen', img: 'assets/images/ramen.png', ans: '„É©„Éº„É°„É≥', wrong: ['„ÅÜ„Å©„Çì', '„Åù„Å∞', '„Éë„Çπ„Çø'] },
        { id: 'rappa', img: 'assets/images/rappa.png', ans: '„Çâ„Å£„Å±', wrong: ['„Åü„ÅÑ„Åì', '„ÇÆ„Çø„Éº', '„Éî„Ç¢„Éé'] },
        { id: 'ringo', img: 'assets/images/ringo.png', ans: '„Çä„Çì„Åî', wrong: ['„Åø„Åã„Çì', '„ÅÑ„Å°„Åî', '„Å∞„Å™„Å™'] },
        { id: 'risu', img: 'assets/images/risu.png', ans: '„Çä„Åô', wrong: ['„Å≠„Åì', '„ÅÑ„Å¨', '„ÅÜ„Åï„Åé'] },
        { id: 'roku', img: 'assets/images/roku.png', ans: '„Çç„Åè', wrong: ['„Åî', '„Å™„Å™', '„ÅØ„Å°'] },
        { id: 'sakana', img: 'assets/images/sakana.png', ans: '„Åï„Åã„Å™', wrong: ['„Å®„Çä', '„ÅÑ„Å¨', '„Å≠„Åì'] },
        { id: 'sakura', img: 'assets/images/sakura.png', ans: '„Åï„Åè„Çâ', wrong: ['„Å≤„Åæ„Çè„Çä', '„Å°„ÇÖ„Éº„Çä„Å£„Å∑', '„Å∞„Çâ'] },
        { id: 'saru', img: 'assets/images/saru.png', ans: '„Åï„Çã', wrong: ['„Åî„Çä„Çâ', '„Åè„Åæ', '„Å±„Çì„Å†'] },
        { id: 'semi', img: 'assets/images/semi.png', ans: '„Åõ„Åø', wrong: ['„Å°„Çá„ÅÜ', '„ÅØ„Å°', '„ÅÇ„Çä'] },
        { id: 'shiitake', img: 'assets/images/shiitake.png', ans: '„Åó„ÅÑ„Åü„Åë', wrong: ['„Åç„ÅÆ„Åì', '„Åæ„ÇÅ', '„ÇÑ„Åï„ÅÑ'] },
        { id: 'shika', img: 'assets/images/shika.png', ans: '„Åó„Åã', wrong: ['„ÅÜ„Åæ', '„ÅÜ„Åó', '„Å∂„Åü'] },
        { id: 'shiro', img: 'assets/images/shiro.png', ans: '„Åó„Çç', wrong: ['„Åè„Çç', '„ÅÇ„Åã', '„ÅÇ„Åä'] },
        { id: 'suika', img: 'assets/images/suika.png', ans: '„Åô„ÅÑ„Åã', wrong: ['„Çä„Çì„Åî', '„Åø„Åã„Çì', '„Å∞„Å™„Å™'] },
        { id: 'sushi', img: 'assets/images/sushi.png', ans: '„Åô„Åó', wrong: ['„Åï„Åã„Å™', '„Åî„ÅØ„Çì', '„ÇÑ„Åï„ÅÑ'] },
        { id: 'suzume', img: 'assets/images/suzume.png', ans: '„Åô„Åö„ÇÅ', wrong: ['„Å®„Çä', '„Å§„Å∞„ÇÅ', '„ÅØ„Å®'] },
        { id: 'tai', img: 'assets/images/tai.png', ans: '„Åü„ÅÑ', wrong: ['„Åæ„Åê„Çç', '„Åï„Åã„Å™', '„Åì„ÅÑ'] },
        { id: 'tako', img: 'assets/images/tako.png', ans: '„Åü„Åì', wrong: ['„ÅÑ„Åã', '„Åà„Å≥', '„Åã„Å´'] },
        { id: 'tamago', img: 'assets/images/tamago.png', ans: '„Åü„Åæ„Åî', wrong: ['„Åî„ÅØ„Çì', '„Éë„É≥', '„ÇÑ„Åï„ÅÑ'] },
        { id: 'tanuki', img: 'assets/images/tanuki.png', ans: '„Åü„Å¨„Åç', wrong: ['„Åç„Å§„Å≠', '„ÅÑ„Å¨', '„Å≠„Åì'] },
        { id: 'te', img: 'assets/images/te.png', ans: '„Å¶', wrong: ['„ÅÇ„Åó', '„Åã„Åä', '„Åø„Åø'] },
        { id: 'terebi', img: 'assets/images/terebi.png', ans: '„ÉÜ„É¨„Éì', wrong: ['„É©„Ç∏„Ç™', '„Çπ„Éû„Éõ', '„Éë„ÇΩ„Ç≥„É≥'] },
        { id: 'tofu', img: 'assets/images/tofu.png', ans: '„Å®„ÅÜ„Åµ', wrong: ['„Åæ„ÇÅ', '„Åî„ÅØ„Çì', '„Éë„É≥'] },
        { id: 'tokei', img: 'assets/images/tokei.png', ans: '„Å®„Åë„ÅÑ', wrong: ['„Åã„Åé', '„Éâ„Ç¢', '„Åã„Åπ'] },
        { id: 'tomato', img: 'assets/images/tomato.png', ans: '„Å®„Åæ„Å®', wrong: ['„Åç„ÇÖ„ÅÜ„Çä', '„Å™„Åô', '„Éî„Éº„Éû„É≥'] },
        { id: 'tori', img: 'assets/images/tori.png', ans: '„Å®„Çä', wrong: ['„ÅÑ„Å¨', '„Å≠„Åì', '„Åï„Åã„Å™'] },
        { id: 'tsubame', img: 'assets/images/tsubame.png', ans: '„Å§„Å∞„ÇÅ', wrong: ['„Åô„Åö„ÇÅ', '„ÅØ„Å®', '„Å®„Çä'] },
        { id: 'tsuki', img: 'assets/images/tsuki.png', ans: '„Å§„Åç', wrong: ['„Åü„ÅÑ„Çà„ÅÜ', '„Åª„Åó', '„Åè„ÇÇ'] },
        { id: 'tsukue', img: 'assets/images/tsukue.png', ans: '„Å§„Åè„Åà', wrong: ['„ÅÑ„Åô', '„ÉÜ„Éº„Éñ„É´', '„Éô„ÉÉ„Éâ'] },
        { id: 'ude', img: 'assets/images/ude.png', ans: '„ÅÜ„Åß', wrong: ['„ÅÇ„Åó', '„Å¶', '„Åã„Åä'] },
        { id: 'uma', img: 'assets/images/uma.png', ans: '„ÅÜ„Åæ', wrong: ['„ÅÑ„Å¨', '„Å≠„Åì', '„Å∂„Åü'] },
        { id: 'umi', img: 'assets/images/umi.png', ans: '„ÅÜ„Åø', wrong: ['„Åã„Çè', '„ÇÑ„Åæ', '„Åø„Åö„ÅÜ„Åø'] },
        { id: 'usagi', img: 'assets/images/usagi.png', ans: '„ÅÜ„Åï„Åé', wrong: ['„Å≠„Åì', '„ÅÑ„Å¨', '„Çä„Åô'] },
        { id: 'ushi', img: 'assets/images/ushi.png', ans: '„ÅÜ„Åó', wrong: ['„Å∂„Åü', '„ÅÜ„Åæ', '„Åó„Åã'] },
        { id: 'wani', img: 'assets/images/wani.png', ans: '„Çè„Å´', wrong: ['„Å®„Åã„Åí', '„Å∏„Å≥', '„Åã„ÇÅ'] },
        { id: 'yagi', img: 'assets/images/yagi.png', ans: '„ÇÑ„Åé', wrong: ['„Å≤„Å§„Åò', '„ÅÜ„Åæ', '„ÅÜ„Åó'] },
        { id: 'yama', img: 'assets/images/yama.png', ans: '„ÇÑ„Åæ', wrong: ['„Åã„Çè', '„ÅÜ„Åø', '„Åø„Å°'] },
        { id: 'yuki', img: 'assets/images/yuki.png', ans: '„ÇÜ„Åç', wrong: ['„ÅÇ„ÇÅ', '„Åè„ÇÇ', '„Åü„ÅÑ„Çà„ÅÜ'] },
        { id: 'yubiwa', img: 'assets/images/yubiwa.png', ans: '„ÇÜ„Å≥„Çè', wrong: ['„Åè„Å§', '„Åµ„Åè', '„Åº„ÅÜ„Åó'] },
    ];

    // --------------------------------------------------
    // „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ„ÇØ„É©„Çπ (Â§âÊõ¥„Å™„Åó)
    // --------------------------------------------------
    class HiraganaGame {
        constructor() {
            this.questions = [];
            this.currentQIndex = 0;
            this.score = 0;
            this.correctQuestionIds = []; // ‚òÖÊ≠£Ëß£„Åó„ÅüID„ÇíË®òÈå≤
            this.isAnswering = false;

            // DOMË¶ÅÁ¥†
            this.menuArea = document.getElementById('quiz-menu-area');
            this.gameArea = document.getElementById('quiz-game-area');
            this.turnMsg = document.getElementById('quiz-turn-message');
            this.scoreVal = document.getElementById('score-val');
            this.imgArea = document.getElementById('quiz-image-area');
            this.btnArea = document.getElementById('choice-buttons-area');
            this.feedback = document.getElementById('quiz-feedback');
            
            // Èü≥Â£∞
            this.sndCorrect = document.getElementById('snd-correct');
            this.sndIncorrect = document.getElementById('snd-incorrect');
            this.sndFanfare = document.getElementById('snd-fanfare');
        }

        start() {
            // ÂïèÈ°å„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åó„Å¶„Çª„ÉÉ„Éà (10Âïè„Å´ÈôêÂÆö)
            this.questions = [...QUESTIONS].sort(() => Math.random() - 0.5).slice(0, 10);
            this.currentQIndex = 0;
            this.score = 0;
            this.correctQuestionIds = []; // „É™„Çª„ÉÉ„Éà
            this.updateScoreUI();

            this.menuArea.style.display = 'none';
            this.gameArea.style.display = 'block';
            this.nextQuestion();
        }

        nextQuestion() {
            if (this.currentQIndex >= this.questions.length) {
                this.finishGame();
                return;
            }

            this.isAnswering = true;
            this.feedback.textContent = '';
            this.turnMsg.textContent = `Âïè ${this.currentQIndex + 1} / ${this.questions.length}`;

            const q = this.questions[this.currentQIndex];

            // ÁîªÂÉèË°®Á§∫ (ÁîªÂÉè„Éë„Çπ„Å®„Ç®„É©„ÉºÂá¶ÁêÜ„Çí‰øÆÊ≠£„Åó„ÄÅ„É¶„Éº„Ç∂„Éº„ÅåÈÄÅ„Å£„ÅüHTMLÊñ≠Áâá„ÅÆÂΩ¢„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åó„Åü)
            const img = new Image();
            img.src = q.img;
            // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁîªÂÉè
            img.onerror = () => { 
                this.imgArea.innerHTML = `<p style="font-size:2em">üñºÔ∏è</p><p>(${q.ans}„ÅÆÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì)</p>`;
            }; 
            this.imgArea.innerHTML = '';
            this.imgArea.appendChild(img);


            // ÈÅ∏ÊäûËÇ¢‰ΩúÊàê
            let allAnswers = QUESTIONS.map(item => item.ans).filter(ans => ans !== q.ans);
            
            // ÈñìÈÅï„ÅÑ„ÅÆÈÅ∏ÊäûËÇ¢„ÅØ3„Å§
            const wrongChoices = [...q.wrong]
                .filter(w => w !== q.ans)
                .slice(0, 3) 
                .concat(allAnswers) 
                .filter((value, index, self) => self.indexOf(value) === index) 
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            const choices = [q.ans, ...wrongChoices].sort(() => Math.random() - 0.5);
            
            this.btnArea.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => this.checkAnswer(btn, choice, q); 
                this.btnArea.appendChild(btn);
            });
        }

        checkAnswer(btn, choice, q) {
            if (!this.isAnswering) return;
            this.isAnswering = false;

            const correctAns = q.ans;
            const allBtns = document.querySelectorAll('.choice-btn');
            allBtns.forEach(b => b.classList.add('disabled'));

            if (choice === correctAns) {
                // Ê≠£Ëß£
                btn.classList.add('correct');
                this.sndCorrect.currentTime = 0; 
                this.sndCorrect.play().catch(e=>{});
                this.feedback.textContent = '„Åõ„ÅÑ„Åã„ÅÑÔºÅ';
                this.feedback.style.color = 'var(--correct-color)';
                // „Çπ„Ç≥„Ç¢Âä†ÁÆó
                this.score += 1;
                this.correctQuestionIds.push(q.id); // ‚òÖÊ≠£Ëß£„Åó„ÅüÂïèÈ°å„ÅÆID„ÇíË®òÈå≤
                this.updateScoreUI();
            } else {
                // ‰∏çÊ≠£Ëß£
                btn.classList.add('incorrect');
                this.sndIncorrect.currentTime = 0; 
                this.sndIncorrect.play().catch(e=>{});
                this.feedback.textContent = `„Åñ„Çì„Å≠„Çì‚Ä¶ „Åì„Åü„Åà„ÅØ„Äå${correctAns}„Äç„Å†„Çà`;
                this.feedback.style.color = 'var(--incorrect-color)';

                // Ê≠£Ëß£„ÅÆ„Éú„Çø„É≥„ÇíÊïô„Åà„Å¶„ÅÇ„Åí„Çã
                allBtns.forEach(b => {
                    if (b.textContent === correctAns) b.classList.add('correct');
                });
            }

            // Ê¨°„ÅÆÂïèÈ°å„Å∏
            setTimeout(() => {
                this.currentQIndex++;
                this.nextQuestion();
            }, 1500);
        }

        updateScoreUI() {
            this.scoreVal.textContent = this.score;
        }

        async finishGame() {
            this.imgArea.innerHTML = '<i class="fa-solid fa-crown" style="font-size:5em; color:#ffd700;"></i>';
            this.btnArea.innerHTML = '';
            this.feedback.innerHTML = `„Åä„Åó„Åæ„ÅÑÔºÅ<br>Ê≠£Ëß£Êï∞: ${this.score} / 10`;
            this.feedback.style.color = 'var(--primary)';
            
            this.sndFanfare.currentTime = 0;
            this.sndFanfare.play().catch(e=>{});

            // ‚òÖ‚òÖ‚òÖ 1Êó•1ÂõûÂà∂Èôê‰ªò„Åç„Éù„Ç§„É≥„ÉàÂä†ÁÆóÂá¶ÁêÜ ‚òÖ‚òÖ‚òÖ
            if (currentUserId && this.correctQuestionIds.length > 0) {
                this.feedback.innerHTML += `<br><span class="text-sm text-gray-500">„Éù„Ç§„É≥„ÉàË®àÁÆó‰∏≠...</span>`;
                
                // window.submitDailyPointsÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const earnedPoints = await window.submitDailyPoints(this.correctQuestionIds);
                
                if (earnedPoints > 0) {
                    this.feedback.innerHTML += `<br><span class="text-lg font-bold text-green-600">‚ú® ‰ªäÊó•„ÅÆÁç≤Âæó„Éù„Ç§„É≥„Éà: +${earnedPoints}pt ‚ú®</span>`;
                } else {
                    this.feedback.innerHTML += `<br><span class="text-sm text-gray-400">Ôºà„Åì„ÅÆÂïèÈ°å„ÅØ‰ªäÊó•„Åô„Åß„Å´„ÇØ„É™„Ç¢Ê∏à„Åø„Åß„ÅôÔºâ</span>`;
                }
            } else if (!currentUserId) {
                this.feedback.innerHTML += `<br><span class="text-sm text-gray-400">„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®„Éù„Ç§„É≥„Éà„ÅåË≤Ø„Åæ„Çã„ÇàÔºÅ</span>`;
            } else {
                this.feedback.innerHTML += `<br><span class="text-sm text-gray-400">„Éù„Ç§„É≥„ÉàÁç≤Âæó„Å™„Åó</span>`;
            }
            
            // „É™„Éà„É©„Ç§„Éú„Çø„É≥
            setTimeout(() => {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'start-btn';
                retryBtn.textContent = '„ÇÇ„ÅÜ„ÅÑ„Å°„Å©';
                retryBtn.onclick = () => location.reload();
                this.btnArea.appendChild(retryBtn);
                this.btnArea.style.display = 'flex';
                this.btnArea.style.justifyContent = 'center';
            }, 1000);
        }
    }

    // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã„Åó„Å¶HTML„Åã„ÇâÂëº„Åπ„Çã„Çà„ÅÜ„Å´„Åô„Çã
    window.game = new HiraganaGame();
    
    // ÁîªÂÉè„Éó„É™„É≠„Éº„Éâ (‰ªªÊÑè)
    QUESTIONS.forEach(q => { const i = new Image(); i.src = q.img; });

</script>

</body>
</html>