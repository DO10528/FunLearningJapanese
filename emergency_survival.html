<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>緊急・薬局サバイバル</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;500;700;900&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #d32f2f; /* 緊急・医療をイメージしたレッド */
        --secondary: #2e7d32; /* 薬局のグリーン */
        --accent: #ffb300;
        --bg-color: #ffebee;
        --text-color: #333;
        --success: #4caf50;
        --error: #f44336;
    }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0; padding-bottom: 100px;
        min-height: 100vh;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* ヘッダー */
    header {
        background: linear-gradient(135deg, #c62828 0%, #ef5350 100%);
        color: white; padding: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 100;
    }
    .header-btn {
        background: rgba(255,255,255,0.2); padding: 5px 15px;
        border-radius: 20px; color: white; text-decoration: none;
        font-size: 0.9em; border: none; cursor: pointer; font-weight: bold;
    }

    /* メインコンテナ */
    #main-container { padding: 20px; max-width: 600px; margin: 0 auto; }

    .screen { display: none; animation: fadeIn 0.3s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* 練習画面 */
    .learning-section {
        background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-left: 6px solid var(--primary);
    }
    .learning-section.pharmacy-cat { border-left-color: var(--secondary); }
    .learning-section.pharmacy-cat .cat-title { color: var(--secondary); }
    
    .cat-title { font-size: 1.2em; font-weight: 700; margin-bottom: 15px; color: #b71c1c; display: flex; align-items: center; gap: 10px; }
    
    .phrase-item {
        display: flex; align-items: center; /* 上下中央揃え */
        padding: 12px 0; border-bottom: 1px dashed #eee;
        gap: 12px; /* アイコン、テキスト、ボタンの間隔 */
    }
    .phrase-item:last-child { border-bottom: none; }
    
    .phrase-text-group { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; /* 左側に寄せるため幅を最大化 */ }
    .phrase-text { font-weight: 700; font-size: 1.1em; color: #333; }
    .phrase-en { font-weight: 400; font-size: 0.85em; color: #888; }
    
    /* 修正: FontAwesomeのアイコン用ボックス */
    .phrase-icon-box {
        width: 50px; height: 50px; flex-shrink: 0;
        border-radius: 12px;
        display: flex; justify-content: center; align-items: center;
        background: #ffebee; color: var(--primary);
        font-size: 1.5em; /* アイコンの大きさ */
    }
    .pharmacy-cat .phrase-icon-box {
        background: #e8f5e9; color: var(--secondary);
    }

    .play-btn {
        background: #fce4ec; color: var(--primary); width: 45px; height: 45px;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
        font-size: 1.1em;
    }
    .pharmacy-cat .play-btn { background: #e8f5e9; color: var(--secondary); }
    .play-btn:active { transform: scale(0.95); }

    /* モード選択画面 */
    .mode-select-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
    .mode-btn {
        background: white; border: 2px solid transparent; padding: 30px; border-radius: 20px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.08); cursor: pointer; text-align: center;
        color: #444; transition: transform 0.1s, box-shadow 0.1s;
    }
    .mode-btn:active { transform: translateY(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .mode-btn.med-mode i { color: var(--secondary); }
    .mode-btn.emg-mode i { color: var(--primary); }
    .mode-btn i { font-size: 3em; margin-bottom: 15px; }
    .mode-btn .mode-title { font-weight: 900; font-size: 1.4em; display: block; margin-bottom: 5px; }
    .mode-btn .mode-desc { font-size: 0.9em; color: #777; }

    /* ゲーム画面 */
    .game-header { text-align: center; margin-bottom: 20px; font-weight: bold; color: #555; }
    
    /* シチュエーション（状況）エリア */
    .situation-area {
        background: #fff3e0; border-radius: 15px; padding: 20px; margin-bottom: 25px;
        text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 2px dashed #ffb74d;
    }
    .situation-label { font-size: 0.85em; font-weight: bold; color: #ef6c00; margin-bottom: 10px; display:block; }
    .situation-text { font-size: 1.3em; font-weight: 700; color: #333; }

    /* プレイヤー（回答）エリア */
    .player-area {
        background: white; border-radius: 20px; padding: 30px 20px;
        text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        position: relative; border: 4px solid var(--primary);
    }
    .target-label { font-size: 0.9em; color: #777; font-weight: bold; margin-bottom: 10px; }
    .target-phrase { font-size: 1.6em; font-weight: 900; color: var(--primary); margin-bottom: 30px; }
    
    .mic-btn {
        width: 80px; height: 80px; border-radius: 50%; border: none;
        background: var(--error); color: white; font-size: 2.5em;
        cursor: pointer; box-shadow: 0 6px 0 #c62828; display: flex; justify-content: center; align-items: center;
        margin: 0 auto; transition: transform 0.1s, box-shadow 0.1s;
    }
    .mic-btn:active { transform: translateY(6px); box-shadow: 0 0 0 #c62828; }
    .mic-btn.listening {
        background: var(--error);
        animation: pulse 1.5s infinite;
        box-shadow: 0 0 0 transparent; transform: translateY(6px);
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
        100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    .feedback-text {
        margin-top: 20px; font-size: 1.2em; font-weight: bold; min-height: 1.5em;
    }
    .fb-success { color: var(--success); }
    .fb-fail { color: var(--error); }
    .recognized-text { font-size: 0.9em; color: #666; margin-top: 5px; }

    /* 下部固定ボタン */
    .fixed-bottom-btn {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px;
        background: var(--primary); color: white; border: none;
        padding: 15px; border-radius: 30px; font-size: 1.2em; font-weight: 900;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
        z-index: 90; display: flex; justify-content: center; align-items: center; gap: 10px;
    }
    .fixed-bottom-btn:active { transform: translateX(-50%) translateY(4px); box-shadow: none; }

</style>
</head>
<body>

<header>
    <div style="font-weight:900; font-size:1.1em;"><i class="fa-solid fa-truck-medical"></i> 緊急サバイバル</div>
    <button class="header-btn" onclick="goBack()" id="header-back-btn" style="display:none;">
        <i class="fa-solid fa-arrow-left"></i> 戻る
    </button>
</header>

<div id="main-container">

    <div id="screen-learning" class="screen active">
        <h2 style="text-align:center; color:#c62828; margin-bottom:20px;">ピンチの時に使う言葉</h2>
        <div id="learning-content"></div>
        <div style="height: 60px;"></div>
    </div>

    <div id="screen-select" class="screen">
        <h2 style="text-align:center; color:#c62828;">シチュエーションを選択</h2>
        <div class="mode-select-grid">
            <button class="mode-btn med-mode" onclick="startGame('pharmacy')">
                <i class="fa-solid fa-pills"></i>
                <span class="mode-title">症状・薬局</span>
                <span class="mode-desc">体調不良や、薬を買う時の言葉</span>
            </button>
            <button class="mode-btn emg-mode" onclick="startGame('emergency')">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span class="mode-title">緊急・トラブル</span>
                <span class="mode-desc">助けを呼ぶ時や、忘れ物をした時</span>
            </button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <span id="game-title">症状・薬局</span> <span id="game-progress" style="margin-left:10px; color:#999;">(1/8)</span>
        </div>

        <div class="situation-area">
            <span class="situation-label"><i class="fa-regular fa-comment-dots"></i> Situation (状況)</span>
            <div class="situation-text" id="situation-text">You have a headache.</div>
        </div>

        <div class="player-area" id="player-area-box">
            <div class="target-label">こう言いましょう（マイクを押して読んでね）</div>
            <div class="target-phrase" id="target-phrase">頭が痛いです</div>
            
            <button class="mic-btn" id="mic-btn" onclick="toggleSpeechRecognition()">
                <i class="fa-solid fa-microphone"></i>
            </button>
            
            <div class="feedback-text" id="feedback-text"></div>
            <div class="recognized-text" id="recognized-text"></div>
        </div>
    </div>

</div>

<button id="start-game-btn" class="fixed-bottom-btn" onclick="showScreen('screen-select')">
    <i class="fa-solid fa-kit-medical"></i> ゲームスタート！
</button>

<script>
// --- データ ---
// 画像リンク(iconImage)をやめ、FontAwesomeのクラス名(faIcon)に変更しました。
const learningData = [
    {
        title: "症状 (Symptoms)", icon: "fa-head-side-cough", class: "",
        phrases: [
            { text: "頭が痛いです", en: "I have a headache.", speech: "あたまがいたいです", faIcon: "fa-bolt" },
            { text: "お腹が痛いです", en: "I have a stomachache.", speech: "おなかがいたいです", faIcon: "fa-face-grimace" },
            { text: "熱があります", en: "I have a fever.", speech: "ねつがあります", faIcon: "fa-temperature-high" },
            { text: "気持ち悪いです", en: "I feel sick / nauseous.", speech: "きもちわるいです", faIcon: "fa-face-dizzy" },
            { text: "咳が出ます", en: "I have a cough.", speech: "せきがでます", faIcon: "fa-head-side-cough" },
            { text: "喉が痛いです", en: "I have a sore throat.", speech: "のどがいたいです", faIcon: "fa-lungs-virus" },
            { text: "めまいがします", en: "I feel dizzy.", speech: "めまいがします", faIcon: "fa-asterisk" },
            { text: "寒気がします", en: "I have chills.", speech: "さむけがします", faIcon: "fa-temperature-arrow-down" },
            { text: "アレルギーがあります", en: "I have an allergy.", speech: "あれるぎーがあります", faIcon: "fa-leaf" }
        ]
    },
    {
        title: "薬局 (At the Pharmacy)", icon: "fa-capsules", class: "pharmacy-cat",
        phrases: [
            { text: "風邪薬はありますか？", en: "Do you have cold medicine?", speech: "かぜぐすりはありますか", faIcon: "fa-pills" },
            { text: "痛み止めをください", en: "I'd like a painkiller, please.", speech: "いたみどめをください", faIcon: "fa-capsules" },
            { text: "胃薬をください", en: "I'd like stomach medicine, please.", speech: "いぐすりをください", faIcon: "fa-prescription-bottle-medical" },
            { text: "目薬はありますか？", en: "Do you have eye drops?", speech: "めぐすりはありますか", faIcon: "fa-eye-dropper" },
            { text: "酔い止めをください", en: "I'd like motion sickness medicine.", speech: "よいどめをください", faIcon: "fa-car" },
            { text: "虫刺されの薬はどこですか？", en: "Where is the medicine for insect bites?", speech: "むしさされのくすりはどこですか", faIcon: "fa-bug" },
            { text: "湿布はありますか？", en: "Do you have pain relief patches?", speech: "しっぷはありますか", faIcon: "fa-note-sticky" },
            { text: "絆創膏はどこですか？", en: "Where are the band-aids?", speech: "ばんそうこうはどこですか", faIcon: "fa-bandage" },
            { text: "マスクをください", en: "I'd like a mask, please.", speech: "ますくをください", faIcon: "fa-mask-face" }
        ]
    },
    {
        title: "緊急・助け (Emergency & Help)", icon: "fa-bell", class: "",
        phrases: [
            { text: "助けて！", en: "Help!", speech: "たすけて", faIcon: "fa-hand-holding-hand" },
            { text: "救急車を呼んでください", en: "Please call an ambulance.", speech: "きゅうきゅうしゃをよんでください", faIcon: "fa-truck-medical" },
            { text: "警察を呼んでください", en: "Please call the police.", speech: "けいさつをよんでください", faIcon: "fa-building-shield" },
            { text: "病院に行きたいです", en: "I want to go to a hospital.", speech: "びょういんにいきたいです", faIcon: "fa-hospital" }
        ]
    },
    {
        title: "トラブル・紛失 (Trouble & Lost)", icon: "fa-passport", class: "",
        phrases: [
            { text: "パスポートをなくしました", en: "I lost my passport.", speech: "ぱすぽーとをなくしました", faIcon: "fa-passport" },
            { text: "財布を落としました", en: "I dropped my wallet.", speech: "さいふをおとしました", faIcon: "fa-wallet" },
            { text: "カバンを盗まれました", en: "My bag was stolen.", speech: "かばんをぬすまれました", faIcon: "fa-suitcase-rolling" },
            { text: "道に迷いました", en: "I am lost.", speech: "みちにまよいました", faIcon: "fa-map-location-dot" }
        ]
    }
];

// ゲームで判定を緩くするためのデータ
const gameData = {
    pharmacy: {
        title: "症状・薬局",
        color: "#2e7d32",
        questions: [
            { situation: "You have a headache.", target: "頭が痛いです", accepts: ["あたまがいたいです"] },
            { situation: "You have a stomachache.", target: "お腹が痛いです", accepts: ["おなかがいたいです"] },
            { situation: "You have a cough.", target: "咳が出ます", accepts: ["せきがでます", "せきがでています"] },
            { situation: "You feel dizzy.", target: "めまいがします", accepts: ["めまいがします"] },
            { situation: "Ask for a painkiller.", target: "痛み止めをください", accepts: ["いたみどめをください", "いたみどめください"] },
            { situation: "Ask for stomach medicine.", target: "胃薬をください", accepts: ["いぐすりをください", "いぐすりください"] },
            { situation: "Ask if they have eye drops.", target: "目薬はありますか？", accepts: ["めぐすりはありますか", "めぐすりありますか"] },
            { situation: "Ask for motion sickness medicine.", target: "酔い止めをください", accepts: ["よいどめをください", "よいどめください"] }
        ]
    },
    emergency: {
        title: "緊急・トラブル",
        color: "#d32f2f",
        questions: [
            { situation: "Ask for help!", target: "助けて！", accepts: ["たすけて", "たすけてください"] },
            { situation: "Ask someone to call an ambulance.", target: "救急車を呼んでください", accepts: ["きゅうきゅうしゃをよんでください"] },
            { situation: "Ask someone to call the police.", target: "警察を呼んでください", accepts: ["けいさつをよんでください"] },
            { situation: "You lost your passport.", target: "パスポートをなくしました", accepts: ["ぱすぽーとをなくしました"] },
            { situation: "You dropped your wallet.", target: "財布を落としました", accepts: ["さいふをおとしました"] },
            { situation: "You are lost.", target: "道に迷いました", accepts: ["みちにまよいました"] }
        ]
    }
};

// --- アプリ状態 ---
let historyStack = ['screen-learning'];
let currentGameType = null;
let currentQuestionIndex = 0;
let isListening = false;

// --- 音声関連 API ---
const synth = window.speechSynthesis;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = false;
    recognition.continuous = false;
}

// --- 初期化・描画 ---
window.onload = () => {
    renderLearning();
    updateHeader();
};

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    if (historyStack[historyStack.length - 1] !== id) {
        historyStack.push(id);
    }
    
    document.getElementById('start-game-btn').style.display = (id === 'screen-learning') ? 'flex' : 'none';
    updateHeader();
    window.scrollTo(0,0);
}

window.goBack = () => {
    if (historyStack.length > 1) {
        historyStack.pop(); 
        const prev = historyStack[historyStack.length - 1];
        
        if (synth.speaking) synth.cancel();
        if (isListening && recognition) recognition.stop();
        
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(prev).classList.add('active');
        document.getElementById('start-game-btn').style.display = (prev === 'screen-learning') ? 'flex' : 'none';
        updateHeader();
    }
};

function updateHeader() {
    const backBtn = document.getElementById('header-back-btn');
    const current = historyStack[historyStack.length - 1];
    backBtn.style.display = (current === 'screen-learning') ? 'none' : 'block';
}

// 1. 練習画面（FontAwesomeアイコンで描画）
function renderLearning() {
    const container = document.getElementById('learning-content');
    container.innerHTML = '';
    
    learningData.forEach(cat => {
        const section = document.createElement('div');
        section.className = `learning-section ${cat.class}`;
        
        let phrasesHtml = '';
        cat.phrases.forEach(phrase => {
            // テキスト、アイコン(faIcon)、再生ボタンの順に並べる
            phrasesHtml += `
                <div class="phrase-item">
                    <div class="phrase-text-group">
                        <span class="phrase-text">${phrase.text}</span>
                        <span class="phrase-en">${phrase.en}</span>
                    </div>
                    <div class="phrase-icon-box">
                        <i class="fa-solid ${phrase.faIcon}"></i>
                    </div>
                    <button class="play-btn" onclick="speakText('${phrase.speech || phrase.text}')">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>
                </div>`;
        });

        section.innerHTML = `
            <div class="cat-title"><i class="fa-solid ${cat.icon}"></i> ${cat.title}</div>
            <div>${phrasesHtml}</div>
        `;
        container.appendChild(section);
    });
}

window.speakText = (text) => {
    if (synth.speaking) synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ja-JP';
    utter.rate = 0.85; // 少しゆっくりめに発音
    synth.speak(utter);
};

// 2. ゲームロジック
window.startGame = (type) => {
    if (!SpeechRecognition) {
        alert("お使いのブラウザは音声認識に対応していません。SafariかChromeをご利用ください。");
        return;
    }
    currentGameType = type;
    currentQuestionIndex = 0;
    
    // UIの色をモードに合わせて変更
    document.getElementById('player-area-box').style.borderColor = gameData[type].color;
    document.getElementById('target-phrase').style.color = gameData[type].color;

    // シャッフルして出題
    gameData[type].questions.sort(() => Math.random() - 0.5);

    showScreen('screen-game');
    document.getElementById('game-title').textContent = gameData[type].title;
    loadQuestion();
};

function loadQuestion() {
    const qList = gameData[currentGameType].questions;
    const qData = qList[currentQuestionIndex];
    
    document.getElementById('game-progress').textContent = `(${currentQuestionIndex + 1}/${qList.length})`;
    document.getElementById('situation-text').textContent = qData.situation;
    document.getElementById('target-phrase').textContent = qData.target;
    
    document.getElementById('feedback-text').textContent = "";
    document.getElementById('recognized-text').textContent = "";
    document.getElementById('mic-btn').classList.remove('listening');
    isListening = false;
}

// 3. 音声認識と判定
window.toggleSpeechRecognition = () => {
    const micBtn = document.getElementById('mic-btn');
    const feedbackText = document.getElementById('feedback-text');
    
    if (synth.speaking) synth.cancel();

    if (isListening) {
        recognition.stop();
        return;
    }

    try {
        recognition.start();
        isListening = true;
        micBtn.classList.add('listening');
        feedbackText.textContent = "聞いています...";
        feedbackText.className = "feedback-text";
    } catch (e) {
        console.error(e);
    }
};

if (recognition) {
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('recognized-text').textContent = `あなたの発音: 「${transcript}」`;
        checkAnswer(transcript);
    };

    recognition.onend = () => {
        isListening = false;
        document.getElementById('mic-btn').classList.remove('listening');
        if (document.getElementById('feedback-text').textContent === "聞いています...") {
            document.getElementById('feedback-text').textContent = "音声が認識できませんでした。もう一度！";
            document.getElementById('feedback-text').className = "feedback-text fb-fail";
        }
    };

    recognition.onerror = (event) => {
        isListening = false;
        document.getElementById('mic-btn').classList.remove('listening');
        document.getElementById('feedback-text').textContent = "エラーが発生しました。";
    };
}

// カンマやスペースを削除して比較するための関数
function calculateSimilarity(s1, s2) {
    const cleanS1 = s1.toLowerCase().replace(/[\s、。！？!?,，]/g, '');
    const cleanS2 = s2.toLowerCase().replace(/[\s、。！？!?,，]/g, '');
    
    if (cleanS1 === cleanS2) return 100;
    if (cleanS1.length === 0 || cleanS2.length === 0) return 0;

    let costs = [];
    for (let i = 0; i <= cleanS1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= cleanS2.length; j++) {
            if (i === 0) {
                costs[j] = j;
            } else if (j > 0) {
                let newValue = costs[j - 1];
                if (cleanS1.charAt(i - 1) !== cleanS2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) costs[cleanS2.length] = lastValue;
    }
    const distance = costs[cleanS2.length];
    const maxLen = Math.max(cleanS1.length, cleanS2.length);
    return ((1 - distance / maxLen) * 100);
}

function checkAnswer(transcript) {
    const qData = gameData[currentGameType].questions[currentQuestionIndex];
    const fbText = document.getElementById('feedback-text');
    
    let maxSimilarity = calculateSimilarity(transcript, qData.target);
    
    qData.accepts.forEach(acc => {
        const sim = calculateSimilarity(transcript, acc);
        if (sim > maxSimilarity) maxSimilarity = sim;
    });

    console.log(`Similarity: ${maxSimilarity.toFixed(1)}%`);

    if (maxSimilarity >= 90) { 
        fbText.textContent = "合格！ (Excellent)";
        fbText.className = "feedback-text fb-success";
        
        const utter = new SpeechSynthesisUtterance("ピンポーン！");
        utter.rate = 1.5; synth.speak(utter);

        // 正解したら1.5秒後に次へ
        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < gameData[currentGameType].questions.length) {
                loadQuestion();
            } else {
                alert("クリアおめでとうございます！緊急時もこれで安心ですね。");
                goBack();
            }
        }, 1500);

    } else {
        fbText.textContent = `惜しい！もう一度！ (一致率: ${Math.floor(maxSimilarity)}%)`;
        fbText.className = "feedback-text fb-fail";
    }
}
</script>

</body>
</html>