<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åü„Åã„Çâ „Åï„Åå„Åó„Ç≤„Éº„É†</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #fffbe6 0%, #ffeccc 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
            color: #5a4a3a;
        }

        #sc-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px; 
            background-color: #ffffff;
            box-shadow: 0 8px 24px rgba(139, 115, 85, 0.15); 
            border-radius: 20px; 
            border: 3px solid #f7d899;
        }
        
        .sc-screen { display: none; }
        .sc-screen.active { display: block; }
        h1, h2 { text-align: center; color: #d98a00; }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; }
        p { text-align: center; font-size: 1.2em; }

        /* --- „Éú„Çø„É≥ÂÖ±ÈÄö --- */
        .sc-button {
            display: block; width: 90%; margin: 20px auto;
            padding: 20px; font-size: 1.5em; font-weight: 700;
            color: #fff; background-color: #ffb100; border: none;
            border-radius: 15px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 5px solid #d98a00;
        }
        .sc-button:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .sc-button:active {
            transform: scale(1.0) translateY(1px);
            border-bottom-width: 2px;
        }
        .sc-button-secondary {
             background-color: #6c757d;
             border-bottom-color: #4a4e52;
        }
        .sc-button-camera {
             background-color: #e64b3c;
             border-bottom-color: #b32a1e;
        }

        /* --- 1. ÂãâÂº∑„Çπ„ÇØ„É™„Éº„É≥ --- */
        #sc-study-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .sc-study-item {
            border: 2px solid #f0f0f0; border-radius: 10px;
            text-align: center; padding: 10px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .sc-study-item:hover { background-color: #fffbe6; }
        .sc-study-item img {
            width: 100%; max-width: 80px; height: 80px; object-fit: contain;
        }
        .sc-study-item p { font-size: 1.1em; font-weight: bold; margin: 5px 0 0 0; }

        /* --- 2. „Ç≤„Éº„É†„Çπ„ÇØ„É™„Éº„É≥ --- */
        #sc-play-sound-button {
            background-color: #48dbfb;
            border-bottom-color: #00a9d9;
            font-size: 1.2em; padding: 15px;
        }

        /* --- 3. „Ç´„É°„É©„Çπ„ÇØ„É™„Éº„É≥ --- */
        #sc-camera-view-wrapper {
            position: relative; width: 100%;
            background-color: #000; border-radius: 10px; overflow: hidden;
        }
        #sc-video-element { width: 100%; height: auto; display: block; }
        #sc-canvas-element { display: none; }

        /* --- 4. ÁµêÊûú„Çπ„ÇØ„É™„Éº„É≥ --- */
        #sc-result-comparison-area {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            align-items: start;
        }
        .sc-result-box {
            border: 2px solid #f7d899;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        .sc-result-box h3 {
            font-size: 1.1em;
            color: #d98a00;
            margin: 0 0 10px 0;
        }
        .sc-result-box img { 
            width: 100%;
            height: auto;
            max-height: 250px; 
            object-fit: contain;
            border-radius: 5px;
        }
        #sc-problem-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #d98a00;
            margin-top: 10px;
        }
        #sc-self-assess-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        #sc-correct-button {
            background-color: #28a745; /* Á∑ë */
            border-bottom-color: #1e7e34;
            font-size: 1.2em;
            margin-top: 0; 
        }
        #sc-incorrect-button {
            background-color: #e64b3c; /* Ëµ§ */
            border-bottom-color: #b32a1e;
            font-size: 1.2em;
            margin-top: 0; 
        }


        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            .sc-button { font-size: 1.2em; padding: 15px; }
            #sc-study-grid { grid-template-columns: repeat(2, 1fr); }
            .sc-result-box img { max-height: 150px; }
        }
    </style>
    </head>
<body>

    <div id="sc-container">

        <div id="sc-screen-study" class="sc-screen active">
            <h1>„Åì„Å®„Å∞„Çí„Åä„Åº„Åà„Çà„ÅÜ</h1>
            <p style="text-align: left;">„Çø„ÉÉ„Éó„Åó„Å¶„Åä„Å®„Çí „Åç„ÅÑ„Å¶„Å≠„ÄÇ</p>
            <div id="sc-study-grid">
                </div>
            <button id="sc-start-game-button" class="sc-button">„Ç≤„Éº„É†„Çí„ÅØ„Åò„ÇÅ„Çã</button>
            <a href="index.html" class="sc-button sc-button-secondary">„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã</a>
        </div>

        <div id="sc-screen-game" class="sc-screen">
            <h2>„Åï„Åå„Åó„ÇÇ„ÅÆ„Ç≤„Éº„É†</h2>
            <p id="sc-game-prompt">„Åó„Åü„ÅÆ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶„ÄÅ„Åç„Åì„Åà„Åü„ÇÇ„ÅÆ„Çí „Åï„Åå„Åó„Å¶„Å≠ÔºÅ</p>
            <button id="sc-play-sound-button" class="sc-button">‚ñ∂ „Åä„Å®„Çí „Åç„Åè</button>
            <button id="sc-open-camera-button" class="sc-button sc-button-camera" style="display: none;">
                üì∑ „Ç´„É°„É©„Çí „Å≤„Çâ„Åè
            </button>
            <a href="index.html" class="sc-button sc-button-secondary">„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã</a>
        </div>

        <div id="sc-screen-camera" class="sc-screen">
            <h2>„Åø„Å§„Åë„Åü„Çâ„ÄÅ„Åó„ÇÉ„Åó„Çì„Çí„Å®„Çç„ÅÜÔºÅ</h2>
            <div id="sc-camera-view-wrapper">
                <video id="sc-video-element" autoplay playsinline></video>
                <canvas id="sc-canvas-element"></canvas>
            </div>
            <button id="sc-take-picture-button" class="sc-button sc-button-camera">
                üì∏ „Åó„ÇÉ„Åó„Çì„Çí„Å®„Çã
            </button>
            <button id="sc-cancel-camera-button" class="sc-button sc-button-secondary">
                „ÇÇ„Å©„Çã
            </button>
        </div>

        <div id="sc-screen-result" class="sc-screen">
            <h2>„Åì„Åü„Åà„ÅÇ„Çè„Åõ</h2>
            <p>„Åä„Å™„Åò „ÇÇ„ÅÆ „Å†„Å£„Åü„Åã„Å™Ôºü</p>
            
            <div id="sc-result-comparison-area">
                <div class="sc-result-box">
                    <h3>„ÇÇ„Çì„Å†„ÅÑ</h3>
                    <img id="sc-problem-image" src="" alt="„ÇÇ„Çì„Å†„ÅÑ„ÅÆ „Åà">
                    <p id="sc-problem-name"></p>
                </div>
                <div class="sc-result-box">
                    <h3>„ÅÇ„Å™„Åü„ÅÆ„Åó„ÇÉ„Åó„Çì</h3>
                    <img id="sc-result-image" src="" alt="„Åï„Å§„Åà„ÅÑ„Åó„Åü „Åó„ÇÉ„Åó„Çì">
                </div>
            </div>
            
            <p style="font-weight: bold; font-size: 1.2em; margin-top: 20px;">
                „Åä„Å™„Åò „Åß„Åó„Åü„ÅãÔºü
            </p>
            
            <div id="sc-self-assess-buttons">
                 <button id="sc-correct-button" class="sc-button">
                    ‚≠ïÔ∏è „ÅØ„ÅÑÔºÅ („Åä„Å™„Åò)
                 </button>
                 <button id="sc-incorrect-button" class="sc-button">
                    ‚ùå „ÅÑ„ÅÑ„Åà („Å°„Åå„ÅÜ)
                 </button>
            </div>

            <a href="index.html" class="sc-button sc-button-secondary">„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ----------------------------------------------------
            // ‚òÖ‚òÖ‚òÖ „Éù„Ç§„É≥„Éà„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö („Ç¢„Ç§„ÉÜ„É†ID„Åî„Å®„Å´1Êó•1Âõû) ‚òÖ‚òÖ‚òÖ
            // ----------------------------------------------------
            const GAME_ID_SCAVENGER = 'scavenger_hunt_game'; // „Ç≤„Éº„É†ID
            
            const USER_STORAGE_KEY_SCAVENGER = 'user_accounts'; 
            const SESSION_STORAGE_KEY_SCAVENGER = 'current_user'; 
            const GUEST_NAME_SCAVENGER = '„Ç≤„Çπ„Éà'; 

            function getTodayDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // „Éù„Ç§„É≥„ÉàÂä†ÁÆó„Éª„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞ („Ç¢„Ç§„ÉÜ„É†ID„Çí„Ç≠„Éº„Å´„Åô„Çã)
            function checkAndAwardPoints(itemId) {
                const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY_SCAVENGER);
                if (!currentUser || currentUser === GUEST_NAME_SCAVENGER) return "guest"; 

                const usersJson = localStorage.getItem(USER_STORAGE_KEY_SCAVENGER);
                let users = usersJson ? JSON.parse(usersJson) : {};
                let user = users[currentUser];
                if (!user) return "error"; 

                const today = getTodayDateString();
                // „Ç≠„Éº„Çí„Äå„Ç≤„Éº„É†ID + „Ç¢„Ç§„ÉÜ„É†ID„Äç„Å´„Åô„Çã
                const progressKey = `${GAME_ID_SCAVENGER}_item_${itemId}`;

                user.progress = user.progress || {};
                user.progress[progressKey] = user.progress[progressKey] || {};

                // „Åù„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Åß„ÄÅ‰ªäÊó•„Åô„Åß„Å´„Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (user.progress[progressKey][today] === true) return "already_scored"; 

                // „Éù„Ç§„É≥„ÉàÂä†ÁÆó
                user.points = (user.points || 0) + 1;
                user.progress[progressKey][today] = true;
                
                users[currentUser] = user;
                localStorage.setItem(USER_STORAGE_KEY_SCAVENGER, JSON.stringify(users));
                console.log(`[Game] ${currentUser} gained 1 point for item "${itemId}". Total: ${user.points}`);
                return "scored"; 
            }
            // ----------------------------------------------------
            // ‚òÖ‚òÖ‚òÖ „Éù„Ç§„É≥„Éà„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö („Åì„Åì„Åæ„Åß) ‚òÖ‚òÖ‚òÖ
            // ----------------------------------------------------


            // --- 1. „Éá„Éº„ÇøÂÆöÁæ© ---
            const ASSET_PATH_IMG = 'assets/images/stationery/';
            const ASSET_PATH_SOUND = 'assets/sounds/stationery/';

            const stationeryWords = [
                { id: 'enpitsu', name: '„Åà„Çì„Å¥„Å§', image: 'enpitsu.png', sound: 'enpitsu.mp3' },
                { id: 'keshigomu', name: '„Åë„Åó„Ç¥„É†', image: 'keshigomu.png', sound: 'keshigomu.mp3' },
                { id: 'pen', name: '„Éö„É≥', image: 'pen.png', sound: 'pen.mp3' },
                { id: 'note', name: '„Éé„Éº„Éà', image: 'note.png', sound: 'note.mp3' },
                { id: 'hasami', name: '„ÅØ„Åï„Åø', image: 'hasami.png', sound: 'hasami.mp3' },
                { id: 'nori', name: '„ÅÆ„Çä', image: 'nori.png', sound: 'nori.mp3' },
                { id: 'hotchkiss', name: '„Éõ„ÉÉ„ÉÅ„Ç≠„Çπ', image: 'hotchkiss.png', sound: 'hotchkiss.mp3' },
                { id: 'jougi', name: '„Åò„Çá„ÅÜ„Åé', image: 'jougi.png', sound: 'jougi.mp3' },
                { id: 'fudebako', name: '„Åµ„Åß„Å∞„Åì', image: 'fudebako.png', sound: 'fudebako.mp3' },
                { id: 'crayon', name: '„ÇØ„É¨„É®„É≥', image: 'crayon.png', sound: 'crayon.mp3' }
            ];

            const audioElements = {};
            stationeryWords.forEach(word => {
                const audio = new Audio(ASSET_PATH_SOUND + word.sound);
                audio.preload = 'auto';
                audioElements[word.id] = audio;
            });

            // --- 2. HTMLË¶ÅÁ¥†„ÅÆÂèñÂæó ---
            const screens = document.querySelectorAll('.sc-screen');
            const studyGridEl = document.getElementById('sc-study-grid');
            
            const studyScreenEl = document.getElementById('sc-screen-study');
            const startGameButton = document.getElementById('sc-start-game-button');
            
            const gameScreenEl = document.getElementById('sc-screen-game');
            const gamePromptEl = document.getElementById('sc-game-prompt');
            const playSoundButton = document.getElementById('sc-play-sound-button');
            const openCameraButton = document.getElementById('sc-open-camera-button');
            
            const cameraScreenEl = document.getElementById('sc-screen-camera');
            const videoEl = document.getElementById('sc-video-element');
            const canvasEl = document.getElementById('sc-canvas-element');
            const takePictureButton = document.getElementById('sc-take-picture-button');
            const cancelCameraButton = document.getElementById('sc-cancel-camera-button');
            
            const resultScreenEl = document.getElementById('sc-screen-result');
            const scProblemImageEl = document.getElementById('sc-problem-image'); 
            const scProblemNameEl = document.getElementById('sc-problem-name');   
            const resultImageEl = document.getElementById('sc-result-image');     
            const scCorrectButton = document.getElementById('sc-correct-button');     
            const scIncorrectButton = document.getElementById('sc-incorrect-button'); 

            // --- 3. Áä∂ÊÖãÁÆ°ÁêÜÂ§âÊï∞ ---
            let currentWord = null; 
            let videoStream = null; 

            // --- 4. Ê±éÁî®Èñ¢Êï∞ ---
            function showScreen(screenElement) {
                screens.forEach(s => s.classList.remove('active'));
                screenElement.classList.add('active');
            }

            function playWordSound(wordId) {
                if (audioElements[wordId]) {
                    audioElements[wordId].currentTime = 0;
                    audioElements[wordId].play();
                }
            }

            // --- 5. ÂãâÂº∑„Çπ„ÇØ„É™„Éº„É≥„ÅÆÂàùÊúüÂåñ ---
            function initStudyScreen() {
                studyGridEl.innerHTML = '';
                stationeryWords.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'sc-study-item';
                    item.onclick = () => playWordSound(word.id);
                    
                    const img = document.createElement('img');
                    img.src = ASSET_PATH_IMG + word.image;
                    img.alt = word.name;
                    
                    const p = document.createElement('p');
                    p.textContent = word.name;
                    
                    item.appendChild(img);
                    item.appendChild(p);
                    studyGridEl.appendChild(item);
                });
            }

            // --- 6. „Ç≤„Éº„É†„Çπ„ÇØ„É™„Éº„É≥„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ ---
            function setupNewProblem() {
                const randomIndex = Math.floor(Math.random() * stationeryWords.length);
                currentWord = stationeryWords[randomIndex];
                
                gamePromptEl.textContent = '„Åó„Åü„ÅÆ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶„ÄÅ„Åç„Åì„Åà„Åü„ÇÇ„ÅÆ„Çí „Åï„Åå„Åó„Å¶„Å≠ÔºÅ';
                playSoundButton.style.display = 'block';
                openCameraButton.style.display = 'none'; 
                
                showScreen(gameScreenEl);
            }

            playSoundButton.onclick = () => {
                playWordSound(currentWord.id);
                gamePromptEl.textContent = `„Äå${currentWord.name}„Äç„Çí „Åï„Åå„Åó„Å¶„Å≠ÔºÅ`;
                openCameraButton.style.display = 'block'; 
            };

            openCameraButton.onclick = () => {
                startCamera();
            };

            // --- 7. „Ç´„É°„É©„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ ---
            async function startCamera() {
                if (videoStream) {
                    showScreen(cameraScreenEl);
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, 
                        audio: false 
                    });
                    
                    videoStream = stream; 
                    videoEl.srcObject = stream; 
                    videoEl.onloadedmetadata = () => {
                        canvasEl.width = videoEl.videoWidth;
                        canvasEl.height = videoEl.videoHeight;
                    };
                    showScreen(cameraScreenEl); 
                    
                } catch (err) {
                    console.error("„Ç´„É°„É©„Ç®„É©„Éº:", err);
                    gamePromptEl.textContent = '„Ç´„É°„É©„ÅÆ„Åç„Çá„Åã„Åå „ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                    if (err.name === "OverconstrainedError" || err.name === "NotFoundError") {
                         try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            videoStream = stream;
                            videoEl.srcObject = stream;
                            videoEl.onloadedmetadata = () => {
                                canvasEl.width = videoEl.videoWidth;
                                canvasEl.height = videoEl.videoHeight;
                            };
                            showScreen(cameraScreenEl);
                         } catch (err2) {
                             gamePromptEl.textContent = '„Ç´„É°„É©„Åå „Å§„Åã„Åà„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                         }
                    }
                }
            }
            
            function stopCamera() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                    videoEl.srcObject = null;
                }
            }

            takePictureButton.onclick = () => {
                const context = canvasEl.getContext('2d');
                context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
                const imageDataUrl = canvasEl.toDataURL('image/png');
                
                resultImageEl.src = imageDataUrl; 
                scProblemImageEl.src = ASSET_PATH_IMG + currentWord.image; 
                scProblemNameEl.textContent = currentWord.name; 
                
                stopCamera();
                showScreen(resultScreenEl);
            };

            cancelCameraButton.onclick = () => {
                stopCamera();
                showScreen(gameScreenEl); 
            };

            // --- 8. ÁµêÊûú„Çπ„ÇØ„É™„Éº„É≥„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ ---
            
            function startNextProblem() {
                resultImageEl.src = ''; 
                scProblemImageEl.src = ''; 
                scProblemNameEl.textContent = ''; 
                setupNewProblem(); 
            }

            // „Äå„ÅØ„ÅÑÔºÅ(„Åä„Å™„Åò)„Äç„Éú„Çø„É≥
            scCorrectButton.onclick = () => {
                // ‚òÖ‚òÖ‚òÖ „Éù„Ç§„É≥„Éà‰ªò‰∏é („Äå„ÅØ„ÅÑ„Äç„ÇíÊäº„Åó„Å¶Ê≠£Ëß£„Å®„Åó„ÅüÊôÇ) ‚òÖ‚òÖ‚òÖ
                const result = checkAndAwardPoints(currentWord.id);
                if (result === "scored") {
                    alert("„Åõ„ÅÑ„Åã„ÅÑÔºÅ (+1 „Éù„Ç§„É≥„ÉàÔºÅ)");
                } else {
                    alert("„Åõ„ÅÑ„Åã„ÅÑÔºÅ");
                }
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

                startNextProblem();
            };
            
            // „Äå„ÅÑ„ÅÑ„Åà („Å°„Åå„ÅÜ)„Äç„Éú„Çø„É≥
            scIncorrectButton.onclick = () => {
                alert("„Åñ„Çì„Å≠„ÇìÔºÅ„Å§„Åé„ÅØ „Åå„Çì„Å∞„Çç„ÅÜÔºÅ");
                startNextProblem();
            };

            // --- 9. „Ç≤„Éº„É†„ÅÆÈñãÂßã ---
            startGameButton.onclick = () => {
                setupNewProblem();
            };
            initStudyScreen();
            showScreen(studyScreenEl); 

        });
    </script>
    </body>
</html>