<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>日本のマナー・文化クイズ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #4caf50; /* マナー＝グリーンのイメージ */
        --accent: #ffeb3b;
        --bg-color: #e8f5e9;
        --text-color: #333;
    }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0; padding-bottom: 100px; /* 下部ボタン用スペース */
        min-height: 100vh;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* ヘッダー */
    header {
        background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
        color: white; padding: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 100;
    }
    .home-link { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; color: white; text-decoration: none; font-size: 0.8em; }

    /* メインコンテナ */
    #main-container {
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .screen { display: none; animation: fadeIn 0.3s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* 練習カード */
    .learning-card {
        background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        border-left: 6px solid var(--primary);
    }
    .cat-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #2e7d32; }
    
    /* 学習アイテム（画像＋テキスト） */
    .manner-item {
        display: flex; flex-direction: column; /* スマホ向けに縦積みに */
        gap: 10px;
        padding: 15px 0;
        border-bottom: 1px dashed #eee;
    }
    .manner-item:last-child { border-bottom: none; }
    
    .manner-img-box {
        width: 100%;
        text-align: center;
        background: #f1f8e9;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #c8e6c9; /* 画像枠を追加 */
    }
    .manner-img {
        width: 100%;
        height: 180px; /* 高さを固定で見やすく */
        object-fit: cover;
        display: block;
    }
    .manner-text {
        display: flex; gap: 10px; align-items: flex-start;
        font-size: 1.05em;
        line-height: 1.5;
        padding: 5px;
    }
    .check-icon { color: var(--primary); margin-top: 4px; flex-shrink: 0; }


    /* ゲーム選択ボタン */
    .cat-select-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    }
    .cat-btn {
        background: white; border: none; padding: 20px; border-radius: 15px;
        box-shadow: 0 4px 0 #ddd; cursor: pointer; text-align: center;
        font-family: inherit; color: #555; transition: transform 0.1s;
    }
    .cat-btn:active { transform: translateY(4px); box-shadow: none; }
    .cat-btn i { font-size: 2em; display: block; margin-bottom: 10px; color: var(--primary); }
    .cat-btn span { font-weight: bold; font-size: 1.1em; }

    /* クイズ画面 */
    .quiz-box {
        background: white; border-radius: 20px; padding: 20px;
        text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    .question-text { font-size: 1.2em; font-weight: bold; margin: 20px 0; }
    
    .options-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    .option-btn {
        background: #f1f8e9; border: 2px solid #c8e6c9; padding: 15px;
        border-radius: 12px; font-size: 1.0em; font-weight: bold; color: #333;
        cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;
        transition: background 0.2s;
    }
    .option-btn:active { background: #dcedc8; transform: scale(0.98); }
    .option-tag {
        background: var(--primary); color: white; width: 30px; height: 30px;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        flex-shrink: 0; font-weight: bold;
    }

    /* フィードバックモーダル */
    .feedback-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); display: none; /* 背景を少し濃く */
        justify-content: center; align-items: center; z-index: 1000;
    }
    .feedback-box {
        background: white; padding: 40px 30px; border-radius: 25px; text-align: center; width: 85%; max-width: 400px;
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; flex-direction: column; align-items: center; /* 中身を中央揃え */
    }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .fb-icon { font-size: 5em; margin-bottom: 15px; }
    .fb-correct { color: #4caf50; }
    .fb-wrong { color: #f44336; }
    
    /* フィードバック画面専用の「次へ」ボタン */
    .fb-action-btn {
        background: #ff9800; color: white; border: none;
        padding: 15px 40px; border-radius: 30px; font-size: 1.2em; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
        margin-top: 25px; /* 上に余白 */
        display: block; /* ブロック要素にして中央揃えを効かせる */
        width: auto; /* 幅はなりゆき、または固定 */
        min-width: 200px;
        transition: transform 0.1s;
    }
    .fb-action-btn:active { transform: translateY(4px); box-shadow: none; }


    /* 下部固定ボタン（練習画面用） */
    .fixed-bottom-btn {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px;
        background: #ff9800; color: white; border: none;
        padding: 15px; border-radius: 30px; font-size: 1.2em; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
        z-index: 90; display: flex; justify-content: center; align-items: center; gap: 10px;
        transition: transform 0.1s;
    }
    .fixed-bottom-btn:active { transform: translateX(-50%) translateY(4px); }

</style>
</head>
<body>

<header>
    <div style="font-weight:900;"><i class="fa-solid fa-user-check"></i> 日本のマナー</div>
    <a href="index.html" class="home-link">ホームへ</a>
</header>

<div id="main-container">

    <div id="screen-learning" class="screen active">
        <h2 style="text-align:center; color:#2e7d32; margin-bottom:20px;">知っておきたい日本の習慣</h2>
        <div id="learning-content"></div>
        <div style="height: 60px;"></div> </div>

    <div id="screen-select" class="screen">
        <h2 style="text-align:center; color:#2e7d32;">クイズのジャンルを選ぼう</h2>
        <div class="cat-select-grid" id="cat-grid"></div>
        <button onclick="showScreen('screen-learning')" style="margin-top:30px; background:none; border:2px solid #ccc; padding:10px; border-radius:20px; color:#777; width:100%; cursor:pointer; font-weight:bold;">練習に戻る</button>
    </div>

    <div id="screen-quiz" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="quiz-cat-name" style="font-weight:bold; color:var(--primary);">カテゴリ</span>
            <span id="quiz-progress" style="font-size:0.9em; color:#666;">1/5</span>
        </div>
        
        <div class="quiz-box">
            <div id="quiz-question" class="question-text">ここに問題が表示されます</div>
            <div class="options-grid" id="quiz-options"></div>
        </div>

        <button onclick="quitGame()" style="margin-top:30px; background:#eceff1; color:#555; border:none; padding:10px 20px; border-radius:20px; width:100%;">やめる</button>
    </div>

</div>

<button id="start-game-btn" class="fixed-bottom-btn" onclick="showScreen('screen-select')">
    <i class="fa-solid fa-gamepad"></i> ゲームに挑戦！
</button>

<div id="feedback-modal" class="feedback-overlay">
    <div class="feedback-box">
        <div id="fb-icon" class="fb-icon"></div>
        <div id="fb-text" style="font-size:1.8em; font-weight:bold; margin-bottom:10px;"></div>
        <div id="fb-detail" style="font-size:1.0em; color:#555; margin-bottom:10px; line-height:1.4;"></div>
        
        <button id="fb-next-btn" class="fb-action-btn" onclick="nextQuestion()">次へ</button>
    </div>
</div>

<script type="module" src="js/firebase-config.js"></script>

<script>
// --- データ（Geminiが生成したダミー画像リンク付き） ---
// お客様は画像ファイルを用意する必要はありません。このまま動きます。
const mannersData = {
    shrine: {
        title: "神社・お寺",
        icon: "fa-torii-gate",
        learning: [
            { text: "鳥居（とりい）をくぐる前に、軽く一礼（いちれい）します。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：鳥居の前でお辞儀" },
            { text: "神社では「二礼・二拍手・一礼」でお参りします。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：神社で手を叩く様子" },
            { text: "お寺では拍手（はくしゅ）をしません。静かに手を合わせます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：お寺で静かに合掌" }
        ],
        quizzes: [
            { q: "神社でお参りする時、どうしますか？", options: [{t:"2回おじぎ、2回はくしゅ、1回おじぎ", c:true}, {t:"静かに手をあわせるだけ", c:false}] },
            { q: "お寺でお参りする時、どうしますか？", options: [{t:"静かに手をあわせる", c:true}, {t:"大きな音ではくしゅする", c:false}] },
            { q: "鳥居（とりい）の前で どうしますか？", options: [{t:"一礼（いちれい）する", c:true}, {t:"走って通る", c:false}] },
            { q: "お参りの前に 手と口を どうしますか？", options: [{t:"水で きよめる（あらう）", c:true}, {t:"何もしない", c:false}] }
        ]
    },
    onsen: {
        title: "温泉・お風呂",
        icon: "fa-hot-tub-person",
        learning: [
            { text: "湯船（ゆぶね）に入る前に、必ず「かけ湯」をするか、体を洗います。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：温泉でかけ湯をする" },
            { text: "タオルは湯船の中に入れません（頭の上に乗せるのはOK）。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：頭にタオルを乗せて入浴" },
            { text: "脱衣所（だついじょ）に戻る前に、体をよく拭きます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：風呂上がりに体を拭く" }
        ],
        quizzes: [
            { q: "湯船（ゆぶね）に入る前に 何をしますか？", options: [{t:"頭や体をあらう（かけ湯）", c:true}, {t:"何もしないで入る", c:false}] },
            { q: "タオルは どこに置きますか？", options: [{t:"頭の上や お風呂の外", c:true}, {t:"お湯の中に入れる", c:false}] },
            { q: "お風呂から出る時、どうしますか？", options: [{t:"体をよくふく", c:true}, {t:"ぬれたまま出る", c:false}] },
            { q: "長い髪は どうしますか？", options: [{t:"ゴムでむすぶ", c:true}, {t:"お湯につける", c:false}] }
        ]
    },
    meal: {
        title: "食事",
        icon: "fa-utensils",
        learning: [
            { text: "食べる前は「いただきます」、食べた後は「ごちそうさま」と言います。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：食事の挨拶（いただきます）" },
            { text: "お箸（はし）からお箸へ、食べ物を渡してはいけません。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：箸渡しの禁止（×マーク）" },
            { text: "お茶碗（ちゃわん）は手に持って食べます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：茶碗を持ってご飯を食べる" }
        ],
        quizzes: [
            { q: "ご飯を食べ終わった時、何と言いますか？", options: [{t:"ごちそうさまでした", c:true}, {t:"いただきます", c:false}] },
            { q: "ご飯を食べる時、お茶碗は どうしますか？", options: [{t:"手にもって食べる", c:true}, {t:"机においたまま食べる", c:false}] },
            { q: "お箸（はし）のマナーで 正しいのは？", options: [{t:"お箸でおかずをつかむ", c:true}, {t:"お箸からお箸へ 食べ物をわたす", c:false}] },
            { q: "ご飯を食べる前、何と言いますか？", options: [{t:"いただきます", c:true}, {t:"こんにちは", c:false}] }
        ]
    },
    train: {
        title: "電車・公共",
        icon: "fa-train-subway",
        learning: [
            { text: "電車の中では、電話で話しません。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：電車内での通話禁止" },
            { text: "優先席（ゆうせんせき）はお年寄りや体の不自由な人のための席です。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：優先席マークと座る人" },
            { text: "電車を待つ時は、列（れつ）を作って並びます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：ホームで整列乗車" }
        ],
        quizzes: [
            { q: "電車で電話がかかってきました。どうしますか？", options: [{t:"出ない / 後でかけなおす", c:true}, {t:"大きな声で話す", c:false}] },
            { q: "電車を待つ時、どうしますか？", options: [{t:"列（れつ）にならぶ", c:true}, {t:"ドアの前で 割り込む", c:false}] },
            { q: "優先席（ゆうせんせき）は 誰の席ですか？", options: [{t:"お年寄りや 妊婦さん", c:true}, {t:"誰でもいい", c:false}] },
            { q: "電車に乗る時、どちらが先ですか？", options: [{t:"降りる人が先", c:true}, {t:"乗る人が先", c:false}] }
        ]
    },
    daily: {
        title: "挨拶・日常",
        icon: "fa-handshake",
        learning: [
            { text: "お辞儀（おじぎ）は、相手に合わせて角度を変えます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：丁寧なお辞儀" },
            { text: "日本の家に入る時は、靴（くつ）を脱ぎます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：玄関で靴を脱ぐ" },
            { text: "脱いだ靴は、つま先をドアの方に向けて揃えます。", image: "https://placehold.co/600x400/e8f5e9/2e7d32?text=イラスト：脱いだ靴を揃える" }
        ],
        quizzes: [
            { q: "日本の家に入る時、どうしますか？", options: [{t:"くつをぬぐ", c:true}, {t:"くつをはいたまま入る", c:false}] },
            { q: "ぬいだ靴は どうしますか？", options: [{t:"向きをそろえて おく", c:true}, {t:"そのままにする", c:false}] },
            { q: "おじぎ（Bow）は いつしますか？", options: [{t:"あいさつの時", c:true}, {t:"電話の時", c:false}] },
            { q: "プレゼントを渡す時、何と言いますか？", options: [{t:"つまらないものですが...", c:true}, {t:"これは高いですよ！", c:false}] }
        ]
    }
};

// --- アプリロジック ---
let currentCategory = null;
let currentQuizIndex = 0;
let currentScore = 0;
const synth = window.speechSynthesis;

window.showScreen = (id) => {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // 学習モードの時だけ固定ボタンを表示
    const btn = document.getElementById('start-game-btn');
    if(id === 'screen-learning') {
        btn.style.display = 'flex';
        renderLearning();
    } else {
        btn.style.display = 'none';
    }

    if(id === 'screen-select') renderCategoryButtons();
    window.scrollTo(0,0);
};

// 1. 練習画面の描画（イラスト付き）
function renderLearning() {
    const container = document.getElementById('learning-content');
    container.textContent = '';
    
    Object.keys(mannersData).forEach(key => {
        const data = mannersData[key];
        const card = document.createElement('div');
        card.className = 'learning-card';
        
        let listHtml = '';
        data.learning.forEach(item => {
            // イラストを追加
            listHtml += `
                <li class="manner-item">
                    <div class="manner-img-box"><img src="${item.image}" class="manner-img" alt="マナーイラスト"></div>
                    <div class="manner-text">
                        <i class="fa-solid fa-check check-icon"></i> 
                        <span>${item.text}</span>
                    </div>
                </li>`;
        });

        card.innerHTML = `
            <div class="cat-title"><i class="fa-solid ${data.icon}"></i> ${data.title}</div>
            <ul class="manner-list">${listHtml}</ul>
        `;
        container.appendChild(card);
    });
}

// 2. カテゴリ選択ボタンの描画
function renderCategoryButtons() {
    const grid = document.getElementById('cat-grid');
    grid.textContent = '';
    Object.keys(mannersData).forEach(key => {
        const data = mannersData[key];
        const btn = document.createElement('button');
        btn.className = 'cat-btn';
        btn.innerHTML = `<i class="fa-solid ${data.icon}"></i><span>${data.title}</span>`;
        btn.onclick = () => startGame(key);
        grid.appendChild(btn);
    });
}

// 3. ゲーム開始
window.startGame = (catKey) => {
    currentCategory = mannersData[catKey];
    currentQuizIndex = 0;
    currentScore = 0;
    // シャッフル
    currentCategory.quizzes.sort(() => Math.random() - 0.5);
    
    showScreen('screen-quiz');
    document.getElementById('quiz-cat-name').textContent = currentCategory.title;
    loadQuiz();
};

function loadQuiz() {
    const qData = currentCategory.quizzes[currentQuizIndex];
    document.getElementById('quiz-progress').textContent = `${currentQuizIndex + 1} / ${currentCategory.quizzes.length}`;
    document.getElementById('quiz-question').textContent = qData.q;
    speak(qData.q);

    const optionsDiv = document.getElementById('quiz-options');
    optionsDiv.textContent = '';

    // 選択肢シャッフル
    const options = [...qData.options].sort(() => Math.random() - 0.5);

    options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        const label = idx === 0 ? "A" : idx === 1 ? "B" : "C";
        btn.innerHTML = `<span class="option-tag">${label}</span> <span>${opt.t}</span>`;
        btn.onclick = () => checkAnswer(opt.c, opt.t);
        optionsDiv.appendChild(btn);
    });
}

function speak(text) {
    if (synth.speaking) synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ja-JP';
    synth.speak(utter);
}

// 4. 判定
window.checkAnswer = (isCorrect, text) => {
    const modal = document.getElementById('feedback-modal');
    const icon = document.getElementById('fb-icon');
    const title = document.getElementById('fb-text');
    const detail = document.getElementById('fb-detail');
    const nextBtn = document.getElementById('fb-next-btn');

    modal.style.display = 'flex';
    
    // 読み上げ
    speak(isCorrect ? "せいかい！" : "ちがいます");

    if (isCorrect) {
        currentScore++;
        icon.innerHTML = '<i class="fa-regular fa-circle fb-correct"></i>';
        title.textContent = "正解！";
        title.style.color = "#4caf50";
        detail.textContent = "すばらしい！そのとおりです。";
        // ポイント加算（1問正解で10pt）
        if(window.addPoints) window.addPoints(10);
    } else {
        icon.innerHTML = '<i class="fa-solid fa-xmark fb-wrong"></i>';
        title.textContent = "残念...";
        title.style.color = "#f44336";
        detail.textContent = "正しいのは... 他の答えです。";
    }

    if (currentQuizIndex >= currentCategory.quizzes.length - 1) {
        nextBtn.textContent = "結果を見る";
        nextBtn.onclick = showResult;
    } else {
        nextBtn.textContent = "次へ";
        nextBtn.onclick = () => {
            modal.style.display = 'none';
            nextQuestion();
        };
    }
};

window.nextQuestion = () => {
    currentQuizIndex++;
    loadQuiz();
};

window.showResult = () => {
    document.getElementById('feedback-modal').style.display = 'none';
    alert(`お疲れ様でした！\n正解数: ${currentScore} / ${currentCategory.quizzes.length}\n獲得ポイント: ${currentScore * 10}pt`);
    showScreen('screen-select');
};

window.quitGame = () => {
    if(confirm("ゲームをやめますか？")) {
        showScreen('screen-select');
    }
};

// 初期化
window.onload = () => {
    renderLearning();
    showScreen('screen-learning');
};
</script>

</body>
</html>