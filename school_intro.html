<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>がっこう と います・あります</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4a69bd;
            --secondary: #60a3bc;
            --accent: #f6b93b;
            --bg: #f8f9fa;
            --text: #2d3436;
            --success: #78e08f;
            --danger: #e55039;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0; padding-bottom: 100px;
            overflow-x: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        ruby { ruby-align: center; }
        rt { font-size: 0.6em; color: #666; font-weight: 500; }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; padding: 15px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-weight: 900; font-size: 1.2em; }
        .nav-btn {
            border: none; background: rgba(255,255,255,0.25); padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-weight: bold; color: white;
        }

        #main-container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 練習画面 */
        .section-title {
            color: var(--primary); font-size: 1.2em; border-bottom: 2px dashed #ccc;
            padding-bottom: 5px; margin-top: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
        }
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .vocab-card {
            background: white; border: 2px solid #e1e8f0; border-radius: 12px; padding: 10px 5px;
            text-align: center; cursor: pointer; transition: 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .vocab-card:active { transform: scale(0.95); background: #f0f4f8; }
        .vocab-card img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 5px; }
        .vocab-card span { display: block; font-size: 0.8em; font-weight: bold; }
        .type-imasu { border-color: #ff9ff3; }
        .type-arimasu { border-color: #48dbfb; }

        /* クイズ画面 */
        .game-card {
            background: white; border-radius: 25px; padding: 20px; text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); border: 4px solid var(--primary);
            min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .mission-text { font-size: 1.2em; color: #555; font-weight: bold; margin-bottom: 15px; }
        
        .image-combo { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .combo-item { display: flex; flex-direction: column; align-items: center; }
        .combo-item img { width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background: #f8f9fa; padding: 5px; border: 2px solid #eee; }
        .plus-icon { font-size: 1.5em; color: #ccc; }

        /* ゲーム1 選択肢 */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .option-btn {
            background: white; border: 3px solid #e1e8f0; border-radius: 15px; padding: 15px 5px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 4px 0 #e1e8f0;
        }
        .option-btn:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
        .option-btn.correct { border-color: var(--success); background: #f1fcf5; box-shadow: 0 4px 0 var(--success); }
        .option-btn.incorrect { border-color: var(--danger); background: #fdf0ed; box-shadow: 0 4px 0 var(--danger); }
        .opt-images { display: flex; gap: 5px; }
        .opt-images img { width: 50px; height: 50px; object-fit: contain; }

        /* マイク */
        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--danger);
            color: white; font-size: 2.5em; box-shadow: 0 6px 0 #c0392b; cursor: pointer; transition: 0.1s;
            margin: 10px auto; display: flex; justify-content: center; align-items: center;
        }
        .mic-btn:active { transform: translateY(6px); box-shadow: 0 0 0 transparent; }
        .mic-btn.listening { animation: pulse 1s infinite; background: #ff7675; box-shadow: none; transform: translateY(6px); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(214, 48, 49, 0); } 100% { box-shadow: 0 0 0 0 rgba(214, 48, 49, 0); } }

        .feedback-text { font-size: 1.2em; font-weight: bold; margin-top: 15px; min-height: 1.5em; }
        .user-transcript { font-size: 0.9em; color: #888; margin-top: 5px; font-weight: bold; }

        /* モード選択ボタン */
        .mode-btn {
            width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 15px; border: none;
            font-size: 1.1em; font-weight: bold; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: flex-start; gap: 15px; cursor: pointer;
        }
        .mode-btn:active { transform: translateY(4px); box-shadow: none; }
        .m1 { background: #ff9ff3; } .m2 { background: #feca57; } .m3 { background: #48dbfb; } .m4 { background: #1dd1a1; }

        /* 常に下部に表示するスタートボタン */
        .fixed-bottom-btn {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--accent); color: #d35400; border: none;
            padding: 15px; border-radius: 30px; font-size: 1.2em; font-weight: 900;
            box-shadow: 0 6px 0 #e67e22, 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 90;
            display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.1s;
        }
        .fixed-bottom-btn:active { transform: translate(-50%, 6px); box-shadow: 0 0 0 transparent, 0 4px 10px rgba(0,0,0,0.2); }
        .btn-mode-return { background: #b2bec3; color: white; box-shadow: 0 6px 0 #636e72, 0 10px 20px rgba(0,0,0,0.2); }

        .hidden { display: none !important; }
        .status-icon { position: absolute; font-size: 3em; color: var(--danger); font-weight: 900; z-index: 10; text-shadow: 2px 2px 0 white; }

    </style>
</head>
<body>

<header>
    <div class="header-title"><i class="fa-solid fa-school"></i> がっこう と います/あります</div>
    <button class="nav-btn" onclick="location.href='index.html'"><i class="fa-solid fa-house"></i></button>
</header>

<div id="main-container">

    <div id="screen-learning" class="screen active">
        <div class="section-title"><i class="fa-solid fa-map-location"></i> がっこうの へや</div>
        <div class="vocab-grid" id="grid-places"></div>

        <div class="section-title"><i class="fa-solid fa-person"></i> います（いきもの）</div>
        <div class="vocab-grid" id="grid-imasu"></div>

        <div class="section-title"><i class="fa-solid fa-box"></i> あります（もの）</div>
        <div class="vocab-grid" id="grid-arimasu"></div>
        <div style="height: 60px;"></div>
    </div>

    <div id="screen-modes" class="screen">
        <h3 style="text-align: center; color: var(--primary);">どのゲームであそぶ？</h3>
        <button class="mode-btn m1" onclick="startGame(1)"><i class="fa-solid fa-ear-listen fa-fw"></i> ゲーム1：きいて えらぼう</button>
        <button class="mode-btn m2" onclick="startGame(2)"><i class="fa-solid fa-microphone fa-fw"></i> ゲーム2：だれ/なに がいる？</button>
        <button class="mode-btn m3" onclick="startGame(3)"><i class="fa-solid fa-up-down-left-right fa-fw"></i> ゲーム3：うえ/した/なか</button>
        <button class="mode-btn m4" onclick="startGame(4)"><i class="fa-solid fa-comments fa-fw"></i> ゲーム4：はい/いいえ 会話</button>
        <div style="height: 60px;"></div>
    </div>

    <div id="screen-play" class="screen">
        <div class="game-card">
            <div id="mission-text" class="mission-text"></div>
            
            <div id="image-area" class="image-combo"></div>

            <div id="options-area" class="options-grid hidden"></div>

            <button id="mic-btn" class="mic-btn hidden" onclick="toggleSpeech()">
                <i class="fa-solid fa-microphone"></i>
            </button>
            
            <div id="feedback-text" class="feedback-text"></div>
            <div id="user-transcript" class="user-transcript"></div>
        </div>
        <div style="height: 60px;"></div>
    </div>

</div>

<button id="fixed-action-btn" class="fixed-bottom-btn" onclick="handleBottomBtnClick()">
    <i class="fa-solid fa-play"></i> <span id="fixed-btn-text">ゲームスタート！</span>
</button>

<audio id="sound-correct" src="assets/sounds/seikai.mp3" preload="auto"></audio>
<audio id="sound-incorrect" src="assets/sounds/bubu.mp3" preload="auto"></audio>

<script>
    // --- 画像パス ---
    const IMG_PATH = 'assets/images/school/'; // ※フォルダ名は環境に合わせて変更してください

    // --- データ定義 ---
    const places = [
        { word: 'きょうしつ', kanji: '教室', accepts: ['きょうしつ', '教室'] },
        { word: 'ばいてん', kanji: '売店', accepts: ['ばいてん', '売店'] },
        { word: 'しょくどう', kanji: '食堂', accepts: ['しょくどう', '食堂'] },
        { word: 'としょしつ', kanji: '図書室', accepts: ['としょしつ', '図書室'] },
        { word: 'りかしつ', kanji: '理科室', accepts: ['りかしつ', '理科室'] },
        { word: 'コンピューターしつ', kanji: 'PC室', accepts: ['こんぴゅーたーしつ', 'コンピューター室', 'pc室'] },
        { word: 'ほけんしつ', kanji: '保健室', accepts: ['ほけんしつ', '保健室'] },
        { word: 'じむしつ', kanji: '事務室', accepts: ['じむしつ', '事務室'] },
        { word: 'たいいくかん', kanji: '体育館', accepts: ['たいいくかん', '体育館'] },
        { word: 'こうてい', kanji: '校庭', accepts: ['こうてい', '校庭'] }
    ];

    const living = [ // います
        { word: 'せんせい', kanji: '先生', accepts: ['せんせい', '先生'] },
        { word: 'ともだち', kanji: '友達', accepts: ['ともだち', '友達', 'お友達'] },
        { word: 'がくせい', kanji: '学生', accepts: ['がくせい', '学生', '生徒', 'せいと'] }
    ];

    const objects = [ // あります
        { word: 'ほん', kanji: '本', accepts: ['ほん', '本'] },
        { word: 'ノート', kanji: 'ノート', accepts: ['のーと', 'ノート'] },
        { word: 'テレビ', kanji: 'テレビ', accepts: ['てれび', 'テレビ'] },
        { word: 'ほんだな', kanji: '本棚', accepts: ['ほんだな', '本棚'] },
        { word: 'こくばん', kanji: '黒板', accepts: ['こくばん', '黒板'] },
        { word: 'とけい', kanji: '時計', accepts: ['とけい', '時計'] },
        { word: 'つくえ', kanji: '机', accepts: ['つくえ', '机'] },
        { word: 'いす', kanji: '椅子', accepts: ['いす', '椅子'] },
        { word: 'かばん', kanji: '鞄', accepts: ['かばん', 'カバン', '鞄'] },
        { word: 'ボール', kanji: 'ボール', accepts: ['ぼーる', 'ボール'] }
    ];

    const positions = [
        { word: 'うえ', kanji: '上', accepts: ['うえ', '上'] },
        { word: 'した', kanji: '下', accepts: ['した', '下'] },
        { word: 'なか', kanji: '中', accepts: ['なか', '中'] }
    ];

    // --- アプリのステータス ---
    let currentScreen = 'screen-learning';
    let currentMode = 0;
    let quizData = {}; 
    let game4Step = 1; // 1: 〇〇がいますか？ 2: 〇〇もいますか？

    // --- 音声関連 ---
    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = false;
        recognition.continuous = false;
    }

    const soundCorrect = document.getElementById('sound-correct');
    const soundIncorrect = document.getElementById('sound-incorrect');

    // --- 初期化 ---
    window.onload = () => {
        renderGrid('grid-places', places, '');
        renderGrid('grid-imasu', living, 'type-imasu');
        renderGrid('grid-arimasu', objects, 'type-arimasu');
    };

    function renderGrid(containerId, items, extraClass) {
        const grid = document.getElementById(containerId);
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = `vocab-card ${extraClass}`;
            card.textContent = `
                <img src="${IMG_PATH}${item.word}.png" onerror="this.src='https://placehold.co/80?text=img'" alt="${item.word}">
                <span>${item.kanji}</span>
            `;
            card.onclick = () => speakText(item.word);
            grid.appendChild(card);
        });
    }

    function speakText(text) {
        if (synth.speaking) synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ja-JP'; utter.rate = 0.9;
        synth.speak(utter);
    }

    // --- 画面遷移＆ボタン制御 ---
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        currentScreen = id;
        updateBottomBtn();
    }

    function updateBottomBtn() {
        const btn = document.getElementById('fixed-action-btn');
        const text = document.getElementById('fixed-btn-text');
        
        if (currentScreen === 'screen-learning') {
            btn.className = 'fixed-bottom-btn';
            btn.textContent = '<i class="fa-solid fa-play"></i> <span id="fixed-btn-text">ゲームスタート！</span>';
        } else if (currentScreen === 'screen-modes') {
            btn.className = 'fixed-bottom-btn btn-mode-return';
            btn.textContent = '<i class="fa-solid fa-book"></i> <span id="fixed-btn-text">れんしゅう に もどる</span>';
        } else {
            btn.className = 'fixed-bottom-btn btn-mode-return';
            btn.textContent = '<i class="fa-solid fa-list"></i> <span id="fixed-btn-text">ゲームを えらぶ</span>';
        }
    }

    function handleBottomBtnClick() {
        if(synth.speaking) synth.cancel();
        if(isListening && recognition) recognition.stop();
        
        if (currentScreen === 'screen-learning') {
            switchScreen('screen-modes');
        } else if (currentScreen === 'screen-modes') {
            switchScreen('screen-learning');
        } else if (currentScreen === 'screen-play') {
            switchScreen('screen-modes');
        }
    }

    // --- 配列ユーティリティ ---
    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(arr) { return arr.sort(() => 0.5 - Math.random()); }
    function cleanText(t) { return t.replace(/[\s、。！？!?,，]/g, ''); }

    // --- ゲーム開始 ---
    window.startGame = function(mode) {
        currentMode = mode;
        switchScreen('screen-play');
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('feedback-text').textContent = '';
        document.getElementById('user-transcript').textContent = '';
        document.getElementById('feedback-text').className = 'feedback-text';
        document.getElementById('mic-btn').classList.add('hidden');
        document.getElementById('options-area').classList.add('hidden');
        document.getElementById('image-area').textContent = '';

        if (currentMode === 1) setupGame1();
        else if (currentMode === 2) setupGame2();
        else if (currentMode === 3) setupGame3();
        else if (currentMode === 4) { game4Step = 1; setupGame4(); }
    }

    // ------------------------------------------
    // ゲーム1: リスニング (2択)
    // ------------------------------------------
    function setupGame1() {
        document.getElementById('mission-text').textContent = 'きいて えらぼう！';
        document.getElementById('options-area').classList.remove('hidden');

        // 正解データ
        const isLiving = Math.random() < 0.5;
        const targetList = isLiving ? living : objects;
        const verb = isLiving ? 'います' : 'あります';
        
        const place = getRandom(places);
        const item = getRandom(targetList);
        const correctSentence = `${place.word} に ${item.word} が ${verb}`;

        // ダミーデータ
        const dummyPlace = getRandom(places);
        let dummyItem = getRandom(targetList);
        while(dummyItem.word === item.word) dummyItem = getRandom(targetList);

        const options = shuffle([
            { place: place, item: item, isCorrect: true },
            { place: dummyPlace, item: dummyItem, isCorrect: false }
        ]);

        const optArea = document.getElementById('options-area');
        optArea.textContent = '';
        
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.textContent = `
                <div class="opt-images">
                    <img src="${IMG_PATH}${opt.place.word}.png" onerror="this.src='https://placehold.co/50'">
                    <i class="fa-solid fa-plus" style="margin:auto; color:#ccc;"></i>
                    <img src="${IMG_PATH}${opt.item.word}.png" onerror="this.src='https://placehold.co/50'">
                </div>
            `;
            btn.onclick = () => {
                if(btn.classList.contains('disabled')) return;
                checkGame1(btn, opt.isCorrect);
            };
            optArea.appendChild(btn);
        });

        // 音声再生ボタン
        const imgArea = document.getElementById('image-area');
        const playBtn = document.createElement('button');
        playBtn.className = 'mic-btn';
        playBtn.style.background = '#4a69bd'; playBtn.style.boxShadow = '0 6px 0 #1e3799';
        playBtn.textContent = '<i class="fa-solid fa-volume-high"></i>';
        playBtn.onclick = () => speakText(correctSentence);
        imgArea.appendChild(playBtn);

        setTimeout(() => speakText(correctSentence), 500);
    }

    function checkGame1(btn, isCorrect) {
        const opts = document.querySelectorAll('.option-btn');
        opts.forEach(o => o.classList.add('disabled'));

        if (isCorrect) {
            btn.classList.add('correct');
            soundCorrect.currentTime = 0; soundCorrect.play();
            document.getElementById('feedback-text').textContent = 'せいかい！';
            document.getElementById('feedback-text').classList.add('success');
            setTimeout(nextQuestion, 1500);
        } else {
            btn.classList.add('incorrect');
            soundIncorrect.currentTime = 0; soundIncorrect.play();
            document.getElementById('feedback-text').textContent = 'ちがうよ！';
            setTimeout(() => {
                btn.classList.remove('incorrect');
                opts.forEach(o => o.classList.remove('disabled'));
                document.getElementById('feedback-text').textContent = '';
            }, 1000);
        }
    }

    // ------------------------------------------
    // ゲーム2: スピーキング (だれがいる？なにがある？)
    // ------------------------------------------
    function setupGame2() {
        document.getElementById('mission-text').textContent = 'だれ / なに が いる？';
        document.getElementById('mic-btn').classList.remove('hidden');

        const isLiving = Math.random() < 0.5;
        const targetList = isLiving ? living : objects;
        const verb = isLiving ? 'います' : 'あります';
        const qWord = isLiving ? 'だれ' : 'なに';
        
        quizData.place = getRandom(places);
        quizData.item = getRandom(targetList);
        quizData.verb = verb;

        const qSentence = `${quizData.place.word} に ${qWord} が ${verb} か`;

        drawComboImage(quizData.place.word, quizData.item.word);
        
        // 正解パターン生成
        quizData.accepts = [];
        quizData.place.accepts.forEach(p => {
            quizData.item.accepts.forEach(i => {
                quizData.accepts.push(`${p}に${i}が${verb}`);
            });
        });

        setTimeout(() => speakText(qSentence), 500);
    }

    // ------------------------------------------
    // ゲーム3: スピーキング (うえ/した/なか)
    // ------------------------------------------
    function setupGame3() {
        document.getElementById('mission-text').textContent = 'どこに ある？';
        document.getElementById('mic-btn').classList.remove('hidden');

        // ベースになるもの（机か、部屋か）
        const useObjectAsBase = Math.random() < 0.5;
        let base, pos;
        if(useObjectAsBase) {
            base = getRandom(objects.filter(o => o.word === 'つくえ' || o.word === 'いす' || o.word === 'ほんだな'));
            pos = getRandom(positions.filter(p => p.word === 'うえ' || p.word === 'した'));
        } else {
            base = getRandom(places);
            pos = { word: 'なか', kanji: '中', accepts: ['なか', '中'] };
        }

        const isLiving = Math.random() < 0.5;
        const item = getRandom(isLiving ? living : objects);
        const verb = isLiving ? 'います' : 'あります';
        const qWord = isLiving ? 'だれ' : 'なに';

        quizData.base = base;
        quizData.pos = pos;
        quizData.item = item;
        quizData.verb = verb;

        const qSentence = `${base.word} の ${pos.word} に ${qWord} が ${verb} か`;

        // 画像描画
        const imgArea = document.getElementById('image-area');
        imgArea.textContent = `
            <div class="combo-item">
                <img src="${IMG_PATH}${base.word}.png" onerror="this.src='https://placehold.co/80'">
            </div>
            <div style="font-weight:bold; font-size:1.5em;">の ${pos.kanji} に</div>
            <div class="combo-item">
                <img src="${IMG_PATH}${item.word}.png" onerror="this.src='https://placehold.co/80'">
            </div>
        `;

        // 正解パターン
        quizData.accepts = [];
        base.accepts.forEach(b => {
            pos.accepts.forEach(p => {
                item.accepts.forEach(i => {
                    quizData.accepts.push(`${b}の${p}に${i}が${verb}`);
                });
            });
        });

        setTimeout(() => speakText(qSentence), 500);
    }

    // ------------------------------------------
    // ゲーム4: 会話 (はい/いいえ、〇〇も)
    // ------------------------------------------
    function setupGame4() {
        document.getElementById('mic-btn').classList.remove('hidden');
        
        if (game4Step === 1) {
            document.getElementById('mission-text').textContent = 'しつもんに こたえよう！';
            
            quizData.place = getRandom(places);
            const isLiving = Math.random() < 0.5;
            quizData.isLiving = isLiving;
            quizData.verb = isLiving ? 'います' : 'あります';
            quizData.negVerb = isLiving ? 'いません' : 'ありません';
            
            const targetList = isLiving ? living : objects;
            quizData.item1 = getRandom(targetList);
            
            quizData.item2 = getRandom(targetList);
            while(quizData.item2.word === quizData.item1.word) quizData.item2 = getRandom(targetList);
            
            quizData.hasItem2 = Math.random() < 0.5; // 次の質問で「はい」か「いいえ」か

            drawComboImage(quizData.place.word, quizData.item1.word);
            
            // Step1は常に「はい、います/あります」
            quizData.accepts = [`はい${quizData.verb}`, `はい、${quizData.verb}`];
            
            const qSentence = `${quizData.place.word} に ${quizData.item1.word} が ${quizData.verb} か`;
            setTimeout(() => speakText(qSentence), 500);

        } else if (game4Step === 2) {
            document.getElementById('mission-text').textContent = '〇〇 も いる？';
            
            drawComboImage(quizData.place.word, quizData.item2.word, !quizData.hasItem2);

            if (quizData.hasItem2) {
                quizData.accepts = [`はい${quizData.verb}`, `はい、${quizData.verb}`];
            } else {
                quizData.accepts = [`いいえ${quizData.negVerb}`, `いいえ、${quizData.negVerb}`];
            }

            const qSentence = `${quizData.item2.word} も ${quizData.verb} か`;
            setTimeout(() => speakText(qSentence), 500);
        }
    }

    function drawComboImage(img1, img2, showCross = false) {
        const imgArea = document.getElementById('image-area');
        imgArea.textContent = `
            <div class="combo-item">
                <img src="${IMG_PATH}${img1}.png" onerror="this.src='https://placehold.co/80'">
            </div>
            <i class="fa-solid fa-plus plus-icon"></i>
            <div class="combo-item" style="position:relative;">
                <img src="${IMG_PATH}${img2}.png" onerror="this.src='https://placehold.co/80'">
                ${showCross ? '<i class="fa-solid fa-xmark status-icon"></i>' : ''}
            </div>
        `;
    }

    // --- 音声認識の共通処理 (Game 2, 3, 4) ---
    window.toggleSpeech = function() {
        if (!recognition) return alert("お使いのブラウザは音声認識に対応していません。");
        if (isListening) { recognition.stop(); return; }

        isListening = true;
        const btn = document.getElementById('mic-btn');
        btn.classList.add('listening');
        document.getElementById('user-transcript').textContent = "きいています...";

        if (synth.speaking) synth.cancel();
        try { recognition.start(); } catch(e){}

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('user-transcript').textContent = `「${transcript}」`;
            handleSpeechResult(transcript);
        };

        recognition.onend = () => { isListening = false; btn.classList.remove('listening'); };
        recognition.onerror = () => { 
            isListening = false; btn.classList.remove('listening');
            document.getElementById('user-transcript').textContent = "うまくききとれませんでした";
        };
    }

    function handleSpeechResult(transcript) {
        const cleanSpoken = cleanText(transcript);
        let maxSim = 0;

        quizData.accepts.forEach(acc => {
            const sim = calculateSimilarity(cleanSpoken, cleanText(acc));
            if (sim > maxSim) maxSim = sim;
        });

        const fb = document.getElementById('feedback-text');
        
        // 類似度80%以上で正解
        if (maxSim >= 80) {
            soundCorrect.currentTime = 0; soundCorrect.play();
            fb.textContent = 'せいかい！';
            fb.className = 'feedback-text success';
            document.getElementById('mic-btn').classList.add('hidden');
            
            setTimeout(() => {
                if (currentMode === 4 && game4Step === 1) {
                    game4Step = 2;
                    setupGame4();
                } else {
                    nextQuestion();
                }
            }, 1500);
        } else {
            soundIncorrect.currentTime = 0; soundIncorrect.play();
            fb.textContent = 'もういちど！';
            fb.className = 'feedback-text danger';
        }
    }

    // レーベンシュタイン距離ベースの類似度
    function calculateSimilarity(s1, s2) {
        if (s1 === s2) return 100;
        if (!s1 || !s2) return 0;
        let costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastVal = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) costs[j] = j;
                else if (j > 0) {
                    let newVal = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newVal = Math.min(Math.min(newVal, lastVal), costs[j]) + 1;
                    costs[j - 1] = lastVal; lastVal = newVal;
                }
            }
            if (i > 0) costs[s2.length] = lastVal;
        }
        return ((1 - costs[s2.length] / Math.max(s1.length, s2.length)) * 100);
    }

</script>
</body>
</html>