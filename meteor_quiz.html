<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隕石英単語クイズ</title>
    
    <link rel="stylesheet" href="css/style.css"> 
    
    <link rel="stylesheet" href="css/meteor_quiz.css">
    
    <script src="js/meteor_quiz.js" defer></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0BX3DD42C1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-0BX3DD42C1');
    </script>
</head>
<body>
    <header>
        <h1>隕石英単語クイズ</h1>
    </header>

    <div style="text-align: center; margin-bottom: 20px;">
        <a href="index.html" class="back-button">ホームに戻る</a>
    </div>

    <div id="game-container">
        <div id="sky-area">
            </div>

        <div id="ground-area">
            </div>

        <div id="info-bar">
            <p>スコア: <span id="score">0</span></p>
            <p>ライフ: <span id="life">3</span></p>
        </div>
    </div>

    <div id="quiz-modal" class="hidden">
        <div id="quiz-box">
            <p id="question-text"></p>
            <div id="quiz-image-area"></div>
            <div id="choice-buttons-area"></div>
            <p id="quiz-feedback" class="feedback-message"></p>
        </div>
    </div>

    <div id="explosion-template" class="explosion hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // あなたのFirebase設定
        const firebaseConfig = {
          apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
          authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
          projectId: "funlearningjapanese-b8e08",
          storageBucket: "funlearningjapanese-b8e08.firebasestorage.app",
          messagingSenderId: "1055688629268",
          appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
          measurementId: "G-LCMXVLPS81"
        };

        // Firebaseサービスの初期化とグローバル変数
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // グローバルスコープに公開される変数
        window.currentUserId = null;
        window.userDisplayName = null;

        // 認証状態の監視とUIDの取得
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                
                // ユーザーの displayName を取得
                const userDocRef = doc(db, "users", window.currentUserId);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    window.userDisplayName = userDocSnap.data().displayName || `ユーザー_${user.uid.substring(0, 4)}`;
                } else {
                    window.userDisplayName = `ユーザー_${user.uid.substring(0, 4)}`;
                }

            } else {
                window.currentUserId = null;
                window.userDisplayName = 'ゲスト';
            }
        });


        /**
         * グローバルなポイント加算関数
         * 外部JSファイルからポイントを加算するために、windowスコープに定義します。
         * @param {number} points - 加算するポイント数
         * @returns {Promise<boolean>} 成功/失敗
         */
        window.addPointsToUser = async function(points) {
            if (!window.currentUserId || points <= 0) {
                console.warn("ポイント加算スキップ: ユーザーが未認証またはポイントが0以下です。");
                return false;
            }
            
            try {
                const userRef = doc(db, "users", window.currentUserId);
                // Firestoreのincrementを使って、既存の値に安全に加算
                await updateDoc(userRef, {
                    points: increment(points) 
                });
                console.log(`[Firebase] ${points} ポイントを加算しました。`);
                return true;

            } catch (e) {
                console.error("ポイント更新エラー:", e);
                return false;
            }
        }
    </script>
</body>
</html>