<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>空港サバイバル - 入国審査と税関</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
--primary: #1976d2; /* 空港・パスポートをイメージしたブルー */
--accent: #ffb300;
--bg-color: #e3f2fd;
--text-color: #333;
--success: #4caf50;
--error: #f44336;
}

body {
font-family: 'Zen Maru Gothic', sans-serif;
background-color: var(--bg-color);
color: var(--text-color);
margin: 0; padding: 0; padding-bottom: 100px;
min-height: 100vh;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

/* ルビ（ふりがな）のスタイル調整 */
ruby { ruby-align: center; }
rt { font-size: 0.6em; color: #555; font-weight: 500; }

/* ヘッダー */
header {
background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
color: white; padding: 15px;
box-shadow: 0 4px 10px rgba(0,0,0,0.2);
display: flex; justify-content: space-between; align-items: center;
position: sticky; top: 0; z-index: 100;
}
.header-btn {
background: rgba(255,255,255,0.2); padding: 5px 15px;
border-radius: 20px; color: white; text-decoration: none;
font-size: 0.9em; border: none; cursor: pointer; font-weight: bold;
}

/* メインコンテナ */
#main-container { padding: 20px; max-width: 600px; margin: 0 auto; }

.screen { display: none; animation: fadeIn 0.3s ease; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* 練習画面 */
.learning-section {
background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-left: 6px solid var(--primary);
}
.cat-title { font-size: 1.2em; font-weight: 700; margin-bottom: 15px; color: #1565c0; display: flex; align-items: center; gap: 10px; }
.phrase-item {
display: flex; justify-content: space-between; align-items: center;
padding: 12px 0; border-bottom: 1px dashed #eee;
}
.phrase-item:last-child { border-bottom: none; }
.phrase-text-group { display: flex; flex-direction: column; gap: 4px; }
.phrase-text { font-weight: 700; font-size: 1.1em; color: #333; line-height: 1.5; }
.phrase-en { font-weight: 400; font-size: 0.85em; color: #888; }
.play-btn {
background: #e3f2fd; color: var(--primary); width: 45px; height: 45px;
border-radius: 50%; display: flex; justify-content: center; align-items: center;
border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
font-size: 1.1em;
}
.play-btn:active { background: #bbdefb; }

/* モード選択画面 */
.mode-select-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
.mode-btn {
background: white; border: 2px solid transparent; padding: 30px; border-radius: 20px;
box-shadow: 0 6px 15px rgba(0,0,0,0.08); cursor: pointer; text-align: center;
color: #444; transition: transform 0.1s, box-shadow 0.1s;
}
.mode-btn:active { transform: translateY(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.mode-btn i { font-size: 3em; margin-bottom: 15px; color: var(--primary); }
.mode-btn .mode-title { font-weight: 900; font-size: 1.4em; display: block; margin-bottom: 5px; }
.mode-btn .mode-desc { font-size: 0.9em; color: #777; }

/* ゲーム画面 */
.game-header { text-align: center; margin-bottom: 20px; font-weight: bold; color: #555; }
/* 審査官（質問）エリア */
.examiner-area {
display: flex; gap: 15px; align-items: flex-start; margin-bottom: 30px;
}
.examiner-icon {
width: 60px; height: 60px; background: #cfd8dc; border-radius: 50%;
display: flex; justify-content: center; align-items: center; font-size: 2em; color: white;
flex-shrink: 0; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.chat-bubble-examiner {
background: white; padding: 15px 20px; border-radius: 0 20px 20px 20px;
box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 1.2em; font-weight: 700;
color: #333; position: relative; width: 100%; line-height: 1.5;
}
.chat-bubble-examiner::before {
content: ''; position: absolute; top: 0; left: -10px;
border-width: 0 10px 15px 0; border-style: solid; border-color: transparent white transparent transparent;
}

/* プレイヤー（回答）エリア */
.player-area {
background: white; border-radius: 20px; padding: 30px 20px;
text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
position: relative; border: 4px solid var(--primary);
}
.target-label { font-size: 0.9em; color: #777; font-weight: bold; margin-bottom: 10px; }
.target-phrase { font-size: 1.6em; font-weight: 900; color: var(--primary); margin-bottom: 30px; line-height: 1.4; }
.mic-btn {
width: 80px; height: 80px; border-radius: 50%; border: none;
background: var(--error); color: white; font-size: 2.5em;
cursor: pointer; box-shadow: 0 6px 0 #c62828; display: flex; justify-content: center; align-items: center;
margin: 0 auto; transition: transform 0.1s, box-shadow 0.1s;
}
.mic-btn:active { transform: translateY(6px); box-shadow: 0 0 0 #c62828; }
.mic-btn.listening {
background: var(--error);
animation: pulse 1.5s infinite;
box-shadow: 0 0 0 transparent; transform: translateY(6px);
}
@keyframes pulse {
0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
}

.feedback-text {
margin-top: 20px; font-size: 1.2em; font-weight: bold; min-height: 1.5em;
}
.fb-success { color: var(--success); }
.fb-fail { color: var(--error); }
.recognized-text { font-size: 0.9em; color: #666; margin-top: 5px; }

/* 下部固定ボタン */
.fixed-bottom-btn {
position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
width: 90%; max-width: 400px;
background: var(--accent); color: #d84315; border: none;
padding: 15px; border-radius: 30px; font-size: 1.2em; font-weight: 900;
box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
z-index: 90; display: flex; justify-content: center; align-items: center; gap: 10px;
}
.fixed-bottom-btn:active { transform: translateX(-50%) translateY(4px); box-shadow: none; }

</style>
</head>
<body>

<header>
<div style="font-weight:900; font-size:1.1em;"><i class="fa-solid fa-passport"></i> 空港サバイバル</div>
<div style="display: flex; gap: 10px;">
<button class="header-btn" onclick="goBack()" id="header-back-btn" style="display:none;">
<i class="fa-solid fa-arrow-left"></i> 戻る
</button>
<button class="header-btn" onclick="location.href='index.html'" id="header-home-btn">
<i class="fa-solid fa-house"></i> ホーム
</button>
</div>
</header>

<div id="main-container">

<div id="screen-learning" class="screen active">
<h2 style="text-align:center; color:#1565c0; margin-bottom:20px;">空港で使う言葉を練習しよう</h2>
<div id="learning-content"></div>
<div style="height: 60px;"></div>
</div>

<div id="screen-select" class="screen">
<h2 style="text-align:center; color:#1565c0;">シチュエーションを選択</h2>
<div class="mode-select-grid">
<button class="mode-btn" onclick="startGame('immigration')">
<i class="fa-solid fa-user-tie"></i>
<span class="mode-title">入国審査</span>
<span class="mode-desc">目的や期間などの質問に答えます</span>
</button>
<button class="mode-btn" onclick="startGame('customs')">
<i class="fa-solid fa-suitcase"></i>
<span class="mode-title">税関 (Customs)</span>
<span class="mode-desc">荷物やお金についての質問に答えます</span>
</button>
</div>
</div>

<div id="screen-game" class="screen">
<div class="game-header">
<span id="game-title">入国審査</span> <span id="game-progress" style="margin-left:10px; color:#999;">(1/5)</span>
</div>

<div class="examiner-area">
<div class="examiner-icon"><i class="fa-solid fa-user-shield"></i></div>
<div class="chat-bubble-examiner" id="examiner-text">目的は何ですか？</div>
</div>

<div class="player-area">
<div class="target-label">あなたの答え（マイクを押して読んでね）</div>
<div class="target-phrase" id="target-phrase">観光です</div>
<button class="mic-btn" id="mic-btn" onclick="toggleSpeechRecognition()">
<i class="fa-solid fa-microphone"></i>
</button>
<div class="feedback-text" id="feedback-text"></div>
<div class="recognized-text" id="recognized-text"></div>
</div>
</div>

</div>

<button id="start-game-btn" class="fixed-bottom-btn" onclick="showScreen('screen-select')">
<i class="fa-solid fa-plane-departure"></i> ゲームスタート！
</button>

<script>
// --- ふりがなを除去してテキストだけにする便利関数（正誤判定・音声読み上げ用） ---
function stripRuby(htmlString) {
if (!htmlString) return '';
// <rt>タグとその中身（ふりがな）を削除
let text = htmlString.replace(/<rt>.*?<\/rt>/g, '');
// 残りのHTMLタグ（<ruby>など）を削除してプレーンテキストにする
return text.replace(/<[^>]*>/g, '');
}

// --- データ ---
// 漢字の上にフリガナ（rubyタグ）を追加しました
const learningData = [
{
title: "基本・書類 (Basics)", icon: "fa-passport",
phrases: [
{ text: "パスポートを<ruby>見<rt>み</rt></ruby>せてください", en: "Please show your passport.", speech: "ぱすぽーとをみせてください" },
{ text: "はい、どうぞ", en: "Here you go.", speech: "はいどうぞ" }
]
},
{
title: "目的 (Purpose)", icon: "fa-camera",
phrases: [
{ text: "<ruby>観光<rt>かんこう</rt></ruby>です", en: "For sightseeing.", speech: "かんこうです" },
{ text: "<ruby>仕事<rt>しごと</rt></ruby>です", en: "For business.", speech: "しごとです" },
{ text: "<ruby>留学<rt>りゅうがく</rt></ruby>です", en: "To study abroad.", speech: "りゅうがくです" }
]
},
{
title: "期間 (Duration)", icon: "fa-calendar-days",
phrases: [
{ text: "<ruby>5日間<rt>いつかかん</rt></ruby>です", en: "For 5 days.", speech: "いつかかんです" },
{ text: "<ruby>1週間<rt>いっしゅうかん</rt></ruby>です", en: "For 1 week.", speech: "いっしゅうかんです" },
{ text: "<ruby>2週間<rt>にしゅうかん</rt></ruby>です", en: "For 2 weeks.", speech: "にしゅうかんです" },
{ text: "<ruby>14日間<rt>じゅうよっかかん</rt></ruby>です", en: "For 14 days.", speech: "じゅうよっかかんです" },
{ text: "<ruby>1ヶ月<rt>いっかげつ</rt></ruby>です", en: "For 1 month.", speech: "いっかげつです" }
]
},
{
title: "滞在先 (Accommodation)", icon: "fa-hotel",
phrases: [
{ text: "<ruby>東京<rt>とうきょう</rt></ruby>のホテルです", en: "A hotel in Tokyo.", speech: "とうきょうのほてるです" },
{ text: "<ruby>友達<rt>ともだち</rt></ruby>の<ruby>家<rt>いえ</rt></ruby>です", en: "My friend's house.", speech: "ともだちのいえです" },
{ text: "<ruby>京都<rt>きょうと</rt></ruby>に<ruby>行<rt>い</rt></ruby>きます", en: "I am going to Kyoto.", speech: "きょうとにいきます" }
]
},
{
title: "同伴者 (Companions)", icon: "fa-users",
phrases: [
{ text: "<ruby>一人<rt>ひとり</rt></ruby>です", en: "I am alone.", speech: "ひとりです" },
{ text: "<ruby>家族<rt>かぞく</rt></ruby>と<ruby>来<rt>き</rt></ruby>ました", en: "I came with my family.", speech: "かぞくときました" },
{ text: "<ruby>友達<rt>ともだち</rt></ruby>と<ruby>一緒<rt>いっしょ</rt></ruby>です", en: "I am with my friend.", speech: "ともだちといっしょです" }
]
},
{
title: "税関・所持金 (Customs & Money)", icon: "fa-money-bill-wave",
phrases: [
{ text: "ありません", en: "I have nothing to declare.", speech: "ありません" },
{ text: "<ruby>10万円<rt>じゅうまんえん</rt></ruby>くらいです", en: "About 100,000 yen.", speech: "じゅうまんえんくらいです" },
{ text: "<ruby>20万円<rt>にじゅうまんえん</rt></ruby>くらいです", en: "About 200,000 yen.", speech: "にじゅうまんえんくらいです" },
{ text: "クレジットカードです", en: "I have a credit card.", speech: "くれじっとかーどです" },
{ text: "VISAカードです", en: "I have a VISA card.", speech: "びざかーどです" },
{ text: "トラベルカードです", en: "I have a travel card.", speech: "とらべるかーどです" }
]
}
];

// ゲームデータにもフリガナ（rubyタグ）を追加
const gameData = {
immigration: {
title: "入国審査",
questions: [
{ examiner: "パスポートを<ruby>見<rt>み</rt></ruby>せてください。", target: "はい、どうぞ", accepts: ["はいどうぞ", "はい"] },
{ examiner: "<ruby>目的<rt>もくてき</rt></ruby>は<ruby>何<rt>なん</rt></ruby>ですか？", target: "<ruby>観光<rt>かんこう</rt></ruby>です", accepts: ["かんこうです"] },
{ examiner: "どのくらい<ruby>滞在<rt>たいざい</rt></ruby>しますか？", target: "<ruby>2週間<rt>にしゅうかん</rt></ruby>です", accepts: ["にしゅうかんです", "2しゅうかんです"] },
{ examiner: "どこに<ruby>泊<rt>と</rt></ruby>まりますか？", target: "<ruby>東京<rt>とうきょう</rt></ruby>のホテルです", accepts: ["とうきょうのほてるです"] },
{ examiner: "<ruby>誰<rt>だれ</rt></ruby>と<ruby>来<rt>き</rt></ruby>ましたか？", target: "<ruby>家族<rt>かぞく</rt></ruby>と<ruby>来<rt>き</rt></ruby>ました", accepts: ["かぞくときました"] }
]
},
customs: {
title: "税関",
questions: [
{ examiner: "<ruby>申告<rt>しんこく</rt></ruby>するものはありますか？", target: "ありません", accepts: [] },
{ examiner: "<ruby>所持金<rt>しょじきん</rt></ruby>はいくらですか？", target: "<ruby>10万円<rt>じゅうまんえん</rt></ruby>くらいです", accepts: ["じゅうまんえんくらいです", "十万円くらいです", "100000円くらいです", "100,000円くらいです"] },
{ examiner: "<ruby>他<rt>ほか</rt></ruby>に<ruby>支払<rt>しはら</rt></ruby>いのカードはありますか？", target: "VISAカードです", accepts: ["びざかーどです", "クレジットカードです", "visaかーどです", "visaカードです"] },
{ examiner: "カバンの<ruby>中身<rt>なかみ</rt></ruby>を<ruby>見<rt>み</rt></ruby>せてください。", target: "はい、わかりました", accepts: ["はいわかりました", "はい"] }
]
}
};

// --- アプリ状態 ---
let historyStack = ['screen-learning'];
let currentGameType = null;
let currentQuestionIndex = 0;
let isListening = false;

// --- 音声関連 API ---
const synth = window.speechSynthesis;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

if (SpeechRecognition) {
recognition = new SpeechRecognition();
recognition.lang = 'ja-JP';
recognition.interimResults = false;
recognition.continuous = false;
}

// --- 初期化・描画 ---
window.onload = () => {
renderLearning();
updateHeader();
};

function showScreen(id) {
document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
document.getElementById(id).classList.add('active');
if (historyStack[historyStack.length - 1] !== id) {
historyStack.push(id);
}
document.getElementById('start-game-btn').style.display = (id === 'screen-learning') ? 'flex' : 'none';
updateHeader();
window.scrollTo(0,0);
}

window.goBack = () => {
if (historyStack.length > 1) {
historyStack.pop();
const prev = historyStack[historyStack.length - 1];
if (synth.speaking) synth.cancel();
if (isListening && recognition) recognition.stop();
document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
document.getElementById(prev).classList.add('active');
document.getElementById('start-game-btn').style.display = (prev === 'screen-learning') ? 'flex' : 'none';
updateHeader();
}
};

function updateHeader() {
const backBtn = document.getElementById('header-back-btn');
const homeBtn = document.getElementById('header-home-btn');
const current = historyStack[historyStack.length - 1];
if (current === 'screen-learning') {
backBtn.style.display = 'none';
if (homeBtn) homeBtn.style.display = 'block';
} else {
backBtn.style.display = 'block';
if (homeBtn) homeBtn.style.display = 'none';
}
}

// 1. 練習画面
function renderLearning() {
const container = document.getElementById('learning-content');
container.innerHTML = '';
learningData.forEach(cat => {
const section = document.createElement('div');
section.className = 'learning-section';
let phrasesHtml = '';
cat.phrases.forEach(phrase => {
phrasesHtml += `
<div class="phrase-item">
<div class="phrase-text-group">
<span class="phrase-text">${phrase.text}</span>
<span class="phrase-en">${phrase.en}</span>
</div>
<button class="play-btn" onclick="speakText('${phrase.speech || stripRuby(phrase.text)}')">
<i class="fa-solid fa-volume-high"></i>
</button>
</div>`;
});

section.innerHTML = `
<div class="cat-title"><i class="fa-solid ${cat.icon}"></i> ${cat.title}</div>
<div>${phrasesHtml}</div>
`;
container.appendChild(section);
});
}

window.speakText = (text) => {
if (synth.speaking) synth.cancel();
const utter = new SpeechSynthesisUtterance(text);
utter.lang = 'ja-JP';
utter.rate = 0.85;
synth.speak(utter);
};

// 2. ゲームロジック
window.startGame = (type) => {
if (!SpeechRecognition) {
alert("お使いのブラウザは音声認識に対応していません。SafariかChromeをご利用ください。");
return;
}
currentGameType = type;
currentQuestionIndex = 0;
showScreen('screen-game');
document.getElementById('game-title').textContent = gameData[type].title;
loadQuestion();
};

function loadQuestion() {
const qList = gameData[currentGameType].questions;
const qData = qList[currentQuestionIndex];
document.getElementById('game-progress').textContent = `(${currentQuestionIndex + 1}/${qList.length})`;
// HTMLとしてレンダリングするため、textContentではなくinnerHTMLを使用
document.getElementById('examiner-text').innerHTML = qData.examiner;
document.getElementById('target-phrase').innerHTML = qData.target;
document.getElementById('feedback-text').textContent = "";
document.getElementById('recognized-text').textContent = "";
document.getElementById('mic-btn').classList.remove('listening');
isListening = false;

// 読み上げるときはルビを取り除いたテキストを使用
setTimeout(() => { speakText(stripRuby(qData.examiner)); }, 500);
}

// 3. 音声認識と判定
window.toggleSpeechRecognition = () => {
const micBtn = document.getElementById('mic-btn');
const feedbackText = document.getElementById('feedback-text');
if (synth.speaking) synth.cancel();

if (isListening) {
recognition.stop();
return;
}

try {
recognition.start();
isListening = true;
micBtn.classList.add('listening');
feedbackText.textContent = "聞いています...";
feedbackText.className = "feedback-text";
} catch (e) {
console.error(e);
}
};

if (recognition) {
recognition.onresult = (event) => {
const transcript = event.results[0][0].transcript;
document.getElementById('recognized-text').textContent = `あなたの発音: 「${transcript}」`;
checkAnswer(transcript);
};

recognition.onend = () => {
isListening = false;
document.getElementById('mic-btn').classList.remove('listening');
if (document.getElementById('feedback-text').textContent === "聞いています...") {
document.getElementById('feedback-text').textContent = "音声が認識できませんでした。もう一度！";
document.getElementById('feedback-text').className = "feedback-text fb-fail";
}
};

recognition.onerror = (event) => {
isListening = false;
document.getElementById('mic-btn').classList.remove('listening');
document.getElementById('feedback-text').textContent = "エラーが発生しました。";
};
}

// カンマやスペース、さらにHTMLタグ(ルビ)を削除して比較する関数
function calculateSimilarity(s1, s2) {
// 比較する前にHTMLタグを取り除き、純粋なテキスト同士にする
const cleanS1 = stripRuby(s1).toLowerCase().replace(/[\s、。！？!?,，]/g, '');
const cleanS2 = stripRuby(s2).toLowerCase().replace(/[\s、。！？!?,，]/g, '');
if (cleanS1 === cleanS2) return 100;
if (cleanS1.length === 0 || cleanS2.length === 0) return 0;

let costs = [];
for (let i = 0; i <= cleanS1.length; i++) {
let lastValue = i;
for (let j = 0; j <= cleanS2.length; j++) {
if (i === 0) {
costs[j] = j;
} else if (j > 0) {
let newValue = costs[j - 1];
if (cleanS1.charAt(i - 1) !== cleanS2.charAt(j - 1)) {
newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
}
costs[j - 1] = lastValue;
lastValue = newValue;
}
}
if (i > 0) costs[cleanS2.length] = lastValue;
}
const distance = costs[cleanS2.length];
const maxLen = Math.max(cleanS1.length, cleanS2.length);
return ((1 - distance / maxLen) * 100);
}

function checkAnswer(transcript) {
const qData = gameData[currentGameType].questions[currentQuestionIndex];
const fbText = document.getElementById('feedback-text');
let maxSimilarity = calculateSimilarity(transcript, qData.target);
qData.accepts.forEach(acc => {
const sim = calculateSimilarity(transcript, acc);
if (sim > maxSimilarity) maxSimilarity = sim;
});

console.log(`Similarity: ${maxSimilarity.toFixed(1)}%`);

if (maxSimilarity >= 90) {
fbText.textContent = "合格！ (Excellent)";
fbText.className = "feedback-text fb-success";
const utter = new SpeechSynthesisUtterance("ピンポーン！");
utter.rate = 1.5; synth.speak(utter);

setTimeout(() => {
currentQuestionIndex++;
if (currentQuestionIndex < gameData[currentGameType].questions.length) {
loadQuestion();
} else {
alert("クリアおめでとうございます！");
goBack();
}
}, 1500);

} else {
fbText.textContent = `惜しい！もう一度！ (一致率: ${Math.floor(maxSimilarity)}%)`;
fbText.className = "feedback-text fb-fail";
}
}
</script>

</body>
</html>