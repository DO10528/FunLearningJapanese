<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã²ã‚‰ã‚«ã‚¿ã‚ã‚ã› - FunLearnJP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&family=Klee+One:wght@600&display=swap" rel="stylesheet">

<style>
    /* --- å…±é€šè¨­å®š (é’ãƒ»ç™½åŸºèª¿) --- */
    :root {
        --primary: #00bcd4; /* ã‚·ã‚¢ãƒ³ */
        --secondary: #0097a7; /* æ¿ƒã„ã‚·ã‚¢ãƒ³ (å½±ç”¨) */
        --accent: #ff4081; /* ãƒ”ãƒ³ã‚¯ */
        --bg-color: #e0f7fa; /* è–„ã„æ°´è‰² */
        --text-color: #333;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; flex-direction: column;
        overflow-x: hidden;
        user-select: none;
        touch-action: manipulation;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
        background: #FFF;
        border-bottom: 3px solid var(--primary);
        padding: 10px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        z-index: 100;
    }
    .logo { font-size: 1.4em; font-weight: 900; color: var(--primary); text-decoration: none; display: flex; gap: 8px; align-items: center; }
    .home-icon { color: var(--primary); font-size: 1.5em; transition: transform 0.2s; }
    .home-icon:active { transform: scale(0.9); }

    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .game-container {
        flex-grow: 1;
        display: flex; flex-direction: column; align-items: center;
        padding: 20px;
        width: 100%; max-width: 800px; margin: 0 auto;
    }

    /* --- ãƒ¬ãƒ™ãƒ«é¸æŠç”»é¢ --- */
    .menu-card {
        background: white;
        border-radius: 25px;
        padding: 40px 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        text-align: center;
        width: 100%;
        max-width: 600px;
        animation: popIn 0.4s;
    }

    .menu-icon { font-size: 4em; color: #5c7aff; margin-bottom: 15px; animation: bounce 2s infinite; }
    .menu-title { font-size: 1.8em; color: var(--primary); margin: 0 0 10px 0; font-weight: 900; }
    
    .level-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
        margin-top: 20px;
    }

    .level-btn {
        background: white;
        border: none;
        border-radius: 15px;
        padding: 20px 10px;
        font-size: 1.2em;
        font-weight: 800;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 0 rgba(0,0,0,0.15);
        transition: all 0.1s;
        text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
    }
    .level-btn:nth-child(5n+1) { background-color: #ff6b6b; }
    .level-btn:nth-child(5n+2) { background-color: #feca57; }
    .level-btn:nth-child(5n+3) { background-color: #48dbfb; }
    .level-btn:nth-child(5n+4) { background-color: #1dd1a1; }
    .level-btn:nth-child(5n+5) { background-color: #ff9f43; }

    .level-btn:hover { transform: translateY(-3px); filter: brightness(1.1); }
    .level-btn:active { transform: translateY(2px); box-shadow: none; }

    .home-btn-back {
        background: #90a4ae; color: white; border: none;
        border-bottom: 4px solid #607d8b;
        padding: 10px 30px; border-radius: 50px; font-weight: bold;
        text-decoration: none; display: inline-block; cursor: pointer;
    }
    .home-btn-back:active { transform: translateY(2px); border-bottom-width: 2px; }


    /* --- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ --- */
    #game-play-area {
        display: none;
        width: 100%;
        flex-direction: column;
        align-items: center;
    }

    .game-header-info {
        display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 10px;
    }
    .level-display {
        font-size: 1.2em; font-weight: bold; color: var(--primary);
        background: white; padding: 5px 15px; border-radius: 15px;
        box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }
    .back-to-menu {
        background: #e0e0e0; color: #666; border: none;
        padding: 5px 15px; border-radius: 15px; font-weight: bold; cursor: pointer;
    }

    /* --- ã‚²ãƒ¼ãƒ ç›¤é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .board {
        display: flex;
        justify-content: center;
        width: 100%;
        gap: 15px;
        margin-bottom: 20px;
        align-items: stretch;
    }

    /* å·¦å³ã®ãƒ—ãƒ¼ãƒ« (3Dé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´) */
    .pool-column {
        display: flex; flex-direction: column;
        width: 95px;
        align-items: center;
        background: #FFF;
        /* ç«‹ä½“çš„ãªãƒœãƒ¼ãƒ€ãƒ¼ã¨å½± */
        border: 3px solid #80deea; /* æ˜ã‚‹ã„è‰²ã§å…‰æ²¢æ„Ÿ */
        border-bottom-color: var(--secondary); /* æš—ã„è‰²ã§å½± */
        border-right-color: var(--secondary);
        border-radius: 15px;
        padding: 0;
        min-height: 350px;
        /* æ·±ã„å½±ã§æµ®ãä¸ŠãŒã‚Šã‚’è¡¨ç¾ */
        box-shadow: 0 6px 0 var(--secondary), 0 8px 10px rgba(0,0,0,0.15);
        overflow: hidden;
    }
    .pool-header {
        background: var(--primary);
        color: #FFF;
        font-weight: 900;
        padding: 8px 0;
        text-align: center;
        width: 100%;
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã«å°‘ã—å½± */
        box-shadow: 0 2px 0 var(--secondary);
    }
    .pool-area { 
        margin-top: 0; padding: 15px 10px; width: 100%; display: flex; flex-direction: column; gap: 10px; align-items: center; flex-grow: 1;
    }

    /* ä¸­å¤®ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒªã‚¢ */
    .center-area {
        flex-grow: 1;
        max-width: 280px;
        display: flex; flex-direction: column;
        gap: 12px;
        padding: 10px;
        background: rgba(255,255,255,0.5);
        border-radius: 20px;
        border: 2px dashed var(--primary);
    }

    /* ãƒšã‚¢ã‚’ä½œã‚‹è¡Œ */
    .pair-row {
        display: flex;
        justify-content: center; align-items: center;
        background: #FFF;
        border-radius: 12px;
        padding: 5px;
        border: 2px solid var(--secondary);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        gap: 10px;
        height: 70px;
    }

    .pair-divider {
        color: var(--secondary); font-size: 1.5em; font-weight: bold;
    }

    /* --- ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚¹ãƒ­ãƒƒãƒˆ --- */
    .slot {
        width: 55px; height: 55px;
        background: #F5F5F5;
        border: 2px dashed #CCC;
        border-radius: 10px;
        display: flex; justify-content: center; align-items: center;
        transition: all 0.2s;
    }
    .slot.drag-over { background: #b2ebf2; border-color: var(--primary); border-style: solid; transform: scale(1.05); }
    .pool-slot { border: none; background: transparent; }

    /* ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹æ–‡å­—ãƒãƒƒãƒ— (3Dé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´) */
    .char-chip {
        width: 55px; height: 55px;
        background: #FFF;
        border-radius: 10px;
        /* ç«‹ä½“çš„ãªãƒœãƒ¼ãƒ€ãƒ¼ */
        border: 3px solid;
        /* ä¸‹ã¨å³ã«åšã¿ã®ã‚ã‚‹å½± */
        box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        display: flex; justify-content: center; align-items: center;
        font-family: 'Klee One', cursive; 
        font-size: 2rem;
        font-weight: 600;
        cursor: grab;
        touch-action: none; z-index: 10;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    
    /* ã²ã‚‰ãŒãªï¼šèµ¤ç³»3D */
    .char-hira { 
        color: #d81b60; 
        border-color: #f8bbd0; /* æ˜ã‚‹ã„è‰² */
        border-bottom-color: #c2185b; /* æš—ã„è‰² */
        border-right-color: #c2185b;
    } 
    /* ã‚«ã‚¿ã‚«ãƒŠï¼šé’ç³»3D */
    .char-kata { 
        color: #1565c0; 
        border-color: #bbdefb; /* æ˜ã‚‹ã„è‰² */
        border-bottom-color: #1976d2; /* æš—ã„è‰² */
        border-right-color: #1976d2;
    } 

    /* æŠ¼ã—ãŸã¨ãã®å‡¹ã¿è¡¨ç¾ */
    .char-chip:active { 
        transform: translateY(2px); 
        box-shadow: 0 0 0 rgba(0,0,0,0.1);
        cursor: grabbing; z-index: 100; 
    }

    /* ã‚´ãƒ¼ã‚¹ãƒˆ */
    .ghost { position: fixed; pointer-events: none; z-index: 1000; opacity: 0.8; transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

    /* --- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
    .controls { width: 100%; text-align: center; margin-top: auto; padding-bottom: 20px; }
    .check-btn {
        background-color: var(--primary); color: white; border: none;
        border-bottom: 4px solid var(--secondary); padding: 12px 40px;
        border-radius: 50px; font-size: 1.6em; font-weight: 900;
        font-family: 'Zen Maru Gothic', sans-serif;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.1s;
    }
    .check-btn:active { transform: translateY(3px); border-bottom-width: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        display: none; justify-content: center; align-items: center; z-index: 2000;
    }
    .modal-content {
        background: #FFF; padding: 40px; border-radius: 25px;
        text-align: center; animation: popIn 0.3s;
        border: 3px solid var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .modal-content h2 { color: var(--primary); font-size: 2.2em; margin: 0 0 20px 0; font-weight: 900; }
    .next-btn {
        background: var(--primary); color: white; border: none; 
        border-bottom: 4px solid var(--secondary); padding: 12px 35px;
        font-size: 1.3em; font-weight: bold; border-radius: 12px; cursor: pointer;
        font-family: 'Zen Maru Gothic', sans-serif;
    }
    .next-btn:active { transform: translateY(3px); border-bottom-width: 1px; }
    
    .point-feedback {
        font-size: 1em; color: var(--correct-color); font-weight: bold; margin-top: 10px;
    }

    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

    @media (max-width: 500px) {
        .board { gap: 10px; }
        .pool-column { width: 85px; }
        .center-area { max-width: 230px; } 
        .slot, .char-chip { width: 50px; height: 50px; font-size: 1.6rem; border-width: 2px; }
        .pair-row { height: 60px; gap: 5px; border-width: 2px; }
        .check-btn { font-size: 1.4em; padding: 10px 30px; border-bottom-width: 3px; }
        
        .level-grid { grid-template-columns: repeat(3, 1fr); }
    }
</style>
</head>
<body>

<header>
    <a href="index.html" class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</a>
    <a href="index.html" class="home-icon"><i class="fa-solid fa-house"></i></a>
</header>

<div class="game-container">
    
    <div id="level-menu-area" class="menu-card">
        <div class="menu-icon"><i class="fa-solid fa-right-left"></i></div>
        <h1 class="menu-title">ã²ã‚‰ã‚«ã‚¿ã‚ã‚ã›</h1>
        <p style="color:#666; margin-bottom:10px;">ã‚ãã³ãŸã„ ãƒ¬ãƒ™ãƒ«ã‚’ ãˆã‚‰ã‚“ã§ã­</p>
        
        <div id="auth-status" style="margin-bottom: 20px; font-weight: bold; color: var(--primary);">èªè¨¼ä¸­...</div>

        <div id="level-grid" class="level-grid">
            </div>
        
        <button onclick="location.href='index.html'" class="home-btn-back">ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹</button>
    </div>

    <div id="game-play-area">
        
        <div class="game-header-info">
            <span id="level-indicator" class="level-display">ãƒ¬ãƒ™ãƒ« 1</span>
            <button class="back-to-menu" onclick="showLevelMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
        </div>

        <div class="board">
            <div class="pool-column">
                <div class="pool-header">ã²ã‚‰ãŒãª</div>
                <div id="hira-pool" class="pool-area"></div>
            </div>

            <div class="center-area" id="pair-rows">
                </div>

            <div class="pool-column">
                <div class="pool-header">ã‚«ã‚¿ã‚«ãƒŠ</div>
                <div id="kata-pool" class="pool-area"></div>
            </div>
        </div>

        <div class="controls">
            <button class="check-btn" onclick="checkAnswer()">ã“ãŸãˆã‚ã‚ã›ï¼</button>
        </div>
    </div>

</div>

<div id="success-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ã ã„ã›ã„ã‹ã„ï¼ğŸ‰</h2>
        <p id="modal-point-feedback" class="point-feedback"></p>
        <button class="next-btn" onclick="nextLevel()">ã¤ãã® ãƒ¬ãƒ™ãƒ«ã¸ Go!</button>
    </div>
</div>

<audio id="snd-correct" src="assets/sounds/seikai.mp3"></audio>
<audio id="snd-incorrect" src="assets/sounds/bubu.mp3"></audio>

<script type="module">
    // 1. Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";


    // 2. ã‚ãªãŸã®Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.appspot.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    // 3. Firebaseã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let currentUserId = null;
    const authStatusEl = document.getElementById('auth-status');
    const POINTS_PER_LEVEL = 1; // â˜…â˜…â˜… ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ã§1ãƒã‚¤ãƒ³ãƒˆã«è¨­å®š â˜…â˜…â˜…
    let isLevelClear = false; // äºŒé‡ãƒã‚¤ãƒ³ãƒˆåŠ ç®—é˜²æ­¢ãƒ•ãƒ©ã‚°

    // 4. èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            const userDocRef = doc(db, "users", currentUserId);
            const userDocSnap = await getDoc(userDocRef);
            let displayName = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            if (userDocSnap.exists()) {
                displayName = userDocSnap.data().displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            }
            authStatusEl.textContent = `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${displayName}`;

        } else {
            currentUserId = null;
            authStatusEl.textContent = 'âŒ ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ (ãƒã‚¤ãƒ³ãƒˆã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“)';
        }
    });


    /**
     * ãƒã‚¤ãƒ³ãƒˆåŠ ç®—é–¢æ•° (Firestoreã«è¨˜éŒ²)
     * @param {number} points - åŠ ç®—ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆæ•°
     */
    async function addPointsToUser(points) {
        if (!currentUserId || points <= 0 || isLevelClear) {
            if(isLevelClear) console.log("ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã‚¹ã‚­ãƒƒãƒ—: ãƒ¬ãƒ™ãƒ«ã¯ã™ã§ã«ã‚¯ãƒªã‚¢ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            return false;
        }
        
        try {
            const userRef = doc(db, "users", currentUserId);
            await updateDoc(userRef, {
                points: increment(points) 
            });
            console.log(`${points} ãƒã‚¤ãƒ³ãƒˆã‚’ Firestore ã«åŠ ç®—ã—ã¾ã—ãŸã€‚`);
            isLevelClear = true; // æˆåŠŸæ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            return true;

        } catch (e) {
            console.error("ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
            return false;
        }
    }
    
    // ----------------------------------------------------
    // â˜…â˜…â˜… ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (DOMContentLoadedã§å®Ÿè¡Œã•ã‚Œã¦ã„ãŸéƒ¨åˆ†) â˜…â˜…â˜…
    // ----------------------------------------------------
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© (å…¨10ãƒ¬ãƒ™ãƒ«) ---
    const levels = [
        { id: 1, chars: [ {h:'ã‚',k:'ã‚¢'}, {h:'ã„',k:'ã‚¤'}, {h:'ã†',k:'ã‚¦'}, {h:'ãˆ',k:'ã‚¨'}, {h:'ãŠ',k:'ã‚ª'} ] },
        { id: 2, chars: [ {h:'ã‹',k:'ã‚«'}, {h:'ã',k:'ã‚­'}, {h:'ã',k:'ã‚¯'}, {h:'ã‘',k:'ã‚±'}, {h:'ã“',k:'ã‚³'} ] },
        { id: 3, chars: [ {h:'ã•',k:'ã‚µ'}, {h:'ã—',k:'ã‚·'}, {h:'ã™',k:'ã‚¹'}, {h:'ã›',k:'ã‚»'}, {h:'ã',k:'ã‚½'} ] },
        { id: 4, chars: [ {h:'ãŸ',k:'ã‚¿'}, {h:'ã¡',k:'ãƒ'}, {h:'ã¤',k:'ãƒ„'}, {h:'ã¦',k:'ãƒ†'}, {h:'ã¨',k:'ãƒˆ'} ] },
        { id: 5, chars: [ {h:'ãª',k:'ãƒŠ'}, {h:'ã«',k:'ãƒ‹'}, {h:'ã¬',k:'ãƒŒ'}, {h:'ã­',k:'ãƒ'}, {h:'ã®',k:'ãƒ'} ] },
        { id: 6, chars: [ {h:'ã¯',k:'ãƒ'}, {h:'ã²',k:'ãƒ’'}, {h:'ãµ',k:'ãƒ•'}, {h:'ã¸',k:'ãƒ˜'}, {h:'ã»',k:'ãƒ›'} ] },
        { id: 7, chars: [ {h:'ã¾',k:'ãƒ'}, {h:'ã¿',k:'ãƒŸ'}, {h:'ã‚€',k:'ãƒ '}, {h:'ã‚',k:'ãƒ¡'}, {h:'ã‚‚',k:'ãƒ¢'} ] },
        { id: 8, chars: [ {h:'ã‚„',k:'ãƒ¤'}, {h:'ã‚†',k:'ãƒ¦'}, {h:'ã‚ˆ',k:'ãƒ¨'} ] }, 
        { id: 9, chars: [ {h:'ã‚‰',k:'ãƒ©'}, {h:'ã‚Š',k:'ãƒª'}, {h:'ã‚‹',k:'ãƒ«'}, {h:'ã‚Œ',k:'ãƒ¬'}, {h:'ã‚',k:'ãƒ­'} ] },
        { id: 10, chars: [ {h:'ã‚',k:'ãƒ¯'}, {h:'ã‚’',k:'ãƒ²'}, {h:'ã‚“',k:'ãƒ³'} ] } 
    ];

    let currentLevelIndex = 0;

    // DOM
    const levelMenuArea = document.getElementById('level-menu-area');
    const gamePlayArea = document.getElementById('game-play-area');
    const levelGrid = document.getElementById('level-grid');
    
    const hiraPool = document.getElementById('hira-pool');
    const kataPool = document.getElementById('kata-pool');
    const pairArea = document.getElementById('pair-rows');
    const levelIndicator = document.getElementById('level-indicator');
    const modal = document.getElementById('success-modal');
    const modalPointFeedback = document.getElementById('modal-point-feedback');
    
    const sndCorrect = document.getElementById('snd-correct');
    const sndIncorrect = document.getElementById('snd-incorrect');

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }


    // --- åˆæœŸåŒ– ---
    window.addEventListener('load', () => {
        initLevelMenu();
    });

    function initLevelMenu() {
        levelGrid.innerHTML = '';
        levels.forEach((level, index) => {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            btn.textContent = level.id;
            btn.onclick = () => startGame(index);
            levelGrid.appendChild(btn);
        });
        showLevelMenu();
    }

    function showLevelMenu() {
        levelMenuArea.style.display = 'block';
        gamePlayArea.style.display = 'none';
    }

    function startGame(idx) {
        currentLevelIndex = idx;
        levelMenuArea.style.display = 'none';
        gamePlayArea.style.display = 'flex';
        loadLevel(currentLevelIndex);
    }

    function loadLevel(idx) {
        hiraPool.innerHTML = '';
        kataPool.innerHTML = '';
        pairArea.innerHTML = '';
        modal.style.display = 'none';
        isLevelClear = false; // â˜…ãƒ¬ãƒ™ãƒ«é–‹å§‹æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆâ˜…
        
        if (idx >= levels.length) {
            alert("å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ã™ã”ã„ï¼");
            showLevelMenu();
            return;
        }

        const levelData = levels[idx];
        levelIndicator.textContent = `ãƒ¬ãƒ™ãƒ« ${levelData.id}`;

        // ä¸­å¤®ã®è¡Œã‚’ä½œæˆ
        levelData.chars.forEach((_, i) => {
            const row = document.createElement('div');
            row.className = 'pair-row';
            const hSlot = createSlot('hira-slot');
            const div = document.createElement('div');
            div.className = 'pair-divider';
            div.textContent = '=';
            const kSlot = createSlot('kata-slot');
            
            row.appendChild(hSlot);
            row.appendChild(div);
            row.appendChild(kSlot);
            pairArea.appendChild(row);
        });

        // ãƒãƒƒãƒ—ä½œæˆ (ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
        const hiraChips = shuffleArray([...levelData.chars]);
        const kataChips = shuffleArray([...levelData.chars]);

        hiraChips.forEach(c => createChip(c.h, 'hira', c.k, hiraPool));
        kataChips.forEach(c => createChip(c.k, 'kata', c.h, kataPool));
    }

    function createSlot(type) {
        const slot = document.createElement('div');
        slot.className = `slot ${type}`;
        return slot;
    }

    function createChip(text, type, pairValue, container) {
        const chip = document.createElement('div');
        chip.className = `char-chip char-${type}`;
        chip.textContent = text;
        chip.dataset.value = text;
        chip.dataset.pair = pairValue; // ã“ã®ãƒãƒƒãƒ—ã®å¯¾ã«ãªã‚‹æ–‡å­—
        chip.dataset.type = type;

        const poolSlot = createSlot('pool-slot');
        poolSlot.appendChild(chip);
        container.appendChild(poolSlot);

        setupDrag(chip);
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—åˆ¶å¾¡ ---
    let draggedItem = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;
    let ghost = null;
    let originSlot = null;

    function setupDrag(el) {
        el.addEventListener('mousedown', startDrag);
        el.addEventListener('touchstart', startDrag, {passive: false});
    }

    function startDrag(e) {
        if(isLevelClear) return;
        e.preventDefault();
        draggedItem = e.target;
        originSlot = draggedItem.parentElement;

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const rect = draggedItem.getBoundingClientRect();
        touchOffsetX = clientX - rect.left;
        touchOffsetY = clientY - rect.top;

        ghost = draggedItem.cloneNode(true);
        ghost.className += ' ghost';
        ghost.style.width = rect.width + 'px';
        ghost.style.height = rect.height + 'px';
        document.body.appendChild(ghost);
        moveGhost(clientX, clientY);

        draggedItem.style.opacity = '0.3';

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);
    }

    function onMove(e) {
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        moveGhost(clientX, clientY);

        const target = getTargetSlot(clientX, clientY);
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('drag-over'));
        if (target && isValidDrop(target, draggedItem)) {
            target.classList.add('drag-over');
        }
    }

    function moveGhost(x, y) {
        if(ghost) {
            ghost.style.left = (x - touchOffsetX) + 'px';
            ghost.style.top = (y - touchOffsetY) + 'px';
        }
    }

    function onEnd(e) {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onEnd);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
        
        if(ghost) ghost.remove();
        ghost = null;
        
        draggedItem.style.opacity = '1';

        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
        const target = getTargetSlot(clientX, clientY);

        document.querySelectorAll('.slot').forEach(s => s.classList.remove('drag-over'));

        if (target && isValidDrop(target, draggedItem)) {
            if (target.children.length > 0) {
                const existing = target.children[0];
                originSlot.appendChild(existing);
            }
            target.appendChild(draggedItem);
            // playClickSound(); // ã‚¯ãƒªãƒƒã‚¯éŸ³ãŒæœªå®šç¾©ã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
        }
        draggedItem = null;
    }

    function getTargetSlot(x, y) {
        const el = document.elementFromPoint(x, y);
        if (!el) return null;
        return el.closest('.slot');
    }

    function isValidDrop(slot, item) {
        if (slot.classList.contains('pool-slot')) return true;
        if (slot.classList.contains('hira-slot') && item.dataset.type === 'hira' && slot.children.length === 0) return true;
        if (slot.classList.contains('kata-slot') && item.dataset.type === 'kata' && slot.children.length === 0) return true;
        return false;
    }

    // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    window.checkAnswer = async () => { // â˜… asyncé–¢æ•°ã«å¤‰æ›´
        if(isLevelClear) return; // äºŒé‡ãƒã‚§ãƒƒã‚¯é˜²æ­¢

        const rows = document.querySelectorAll('.pair-row');
        let allCorrect = true;
        let isFull = true;

        rows.forEach(row => {
            const hSlot = row.querySelector('.hira-slot');
            const kSlot = row.querySelector('.kata-slot');
            if (hSlot.children.length === 0 || kSlot.children.length === 0) {
                isFull = false;
            }
        });

        if (!isFull) {
            try { sndIncorrect.currentTime = 0; sndIncorrect.play(); } catch(e){}
            return; 
        }

        rows.forEach(row => {
            const hItem = row.querySelector('.hira-slot').children[0];
            const kItem = row.querySelector('.kata-slot').children[0];
            
            // hItemã®ãƒšã‚¢å€¤ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ã¨kItemã®å€¤ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ã‚’æ¯”è¼ƒ
            if (hItem.dataset.pair !== kItem.dataset.value) { 
                allCorrect = false;
            }
        });

        if (allCorrect) {
            try { sndCorrect.currentTime = 0; sndCorrect.play(); } catch(e){}
            
            // â˜…â˜…â˜… Firebaseãƒã‚¤ãƒ³ãƒˆåŠ ç®— â˜…â˜…â˜…
            let ptMsg = 'ãƒã‚¤ãƒ³ãƒˆã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚';
            if (typeof addPointsToUser === 'function') {
                const success = await addPointsToUser(POINTS_PER_LEVEL);
                if (success) {
                    ptMsg = `ãƒœãƒ¼ãƒŠã‚¹ +${POINTS_PER_LEVEL}pt ã‚²ãƒƒãƒˆï¼`;
                } else if (currentUserId) {
                    ptMsg = 'ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                }
            } else {
                 ptMsg = 'ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²ãªã—ã€‚';
            }
            modalPointFeedback.textContent = ptMsg;
            // â˜…â˜…â˜… Firebaseãƒã‚¤ãƒ³ãƒˆåŠ ç®— çµ‚äº† â˜…â˜…â˜…

            modal.style.display = 'flex'; 
        } else {
            try { sndIncorrect.currentTime = 0; sndIncorrect.play(); } catch(e){}
        }
    };

    window.nextLevel = () => {
        currentLevelIndex++;
        loadLevel(currentLevelIndex);
    };

</script>

</body>
</html>