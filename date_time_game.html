<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´ãƒ»æœˆãƒ»æ—¥ãƒ»æ›œæ—¥ ãƒ‘ã‚ºãƒ«ãƒã‚¹ã‚¿ãƒ¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- å…±é€šè¨­å®š (ãƒã‚¤ãƒ“ãƒ¼ãƒ†ãƒ¼ãƒ: æ™‚é–“ãƒ»æš¦) --- */
        :root {
            --primary: #3f51b5; /* ãƒã‚¤ãƒ“ãƒ¼ãƒ–ãƒ«ãƒ¼ */
            --primary-light: #7986cb;
            --primary-dark: #1a237e;
            --accent: #ffca28; /* é»„è‰² */
            --correct: #4CAF50; /* ç·‘ */
            --incorrect: #F44336; /* èµ¤ */
            --bg-color: #e8eaf6; /* è–„ã„é’èƒŒæ™¯ */
            --text-color: #333;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(26, 35, 126, 0.3);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        #auth-status {
            color: #ffca28;
            font-weight: 700;
        }
        .home-link {
            background: rgba(255,255,255,0.2); color: white;
            padding: 8px 15px; border-radius: 20px;
            transition: background 0.2s;
            text-decoration: none; font-weight: bold;
            cursor: pointer; /* è¿½åŠ  */
        }
        .home-link:hover { background: rgba(255,255,255,0.4); }

        .container {
            max-width: 900px; margin: 20px auto; padding: 20px;
            flex-grow: 1;
        }
        
        /* --- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ --- */
        #mode-selection {
            text-align: center;
            padding: 50px 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .mode-card {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            padding: 20px;
            margin: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2em;
            font-weight: 700;
            border: 4px solid var(--primary);
            box-shadow: 0 4px 0 var(--primary);
        }
        .mode-card:hover {
            background-color: var(--accent);
            color: #333;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--primary);
        }
        .mode-card:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--primary);
        }
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢å…±é€š --- */
        .game-area {
            display: none;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        [id^="question-counter-"] {
            text-align: right;
            font-size: 1.1em;
            color: var(--primary-dark);
            font-weight: 700;
            margin-bottom: 15px;
        }

        /* --- ãƒ¢ãƒ¼ãƒ‰1: èª­ã¿æ–¹ (é¸æŠè‚¢) --- */
        #mode1-question-box {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.5em;
            font-weight: 900;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .choice-btn {
            background: var(--primary-light);
            color: var(--primary-dark);
            border: 2px solid var(--primary);
            padding: 15px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .choice-btn:hover:not(.selected):not(.answered) {
            background-color: var(--accent);
        }
        .choice-btn.selected {
            border: 4px solid var(--accent);
            background-color: #fffff0;
        }
        .choice-btn.correct {
            background-color: var(--correct);
            color: white;
            border-color: var(--correct);
        }
        .choice-btn.incorrect {
            background-color: var(--incorrect);
            color: white;
            border-color: var(--incorrect);
        }

        /* --- ãƒ¢ãƒ¼ãƒ‰2: èãå–ã‚Š (ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³) & ãƒ¢ãƒ¼ãƒ‰3: æ—¥å¸¸ä¼šè©± (ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³) --- */
        .listening-prompt, .situational-prompt {
            text-align: center;
            margin-bottom: 25px;
        }
        #play-audio-btn {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            font-size: 1.4em;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        #play-audio-btn:hover {
            background: var(--primary-dark);
        }
        
        .dropdown-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
            margin-bottom: 30px;
        }
        .dropdown-group {
            text-align: left;
        }
        .dropdown-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--primary-dark);
        }
        select {
            padding: 10px;
            font-size: 1.1em;
            border-radius: 6px;
            border: 2px solid var(--primary-light);
            min-width: 150px;
            appearance: none; 
            background-color: white;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%233f51b5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: border-color 0.2s;
        }
        select:focus {
            border-color: var(--accent);
            outline: none;
        }

        /* --- å…±é€šãƒ•ãƒƒã‚¿ãƒ¼/æ“ä½œãƒœã‚¿ãƒ³ --- */
        [id^="feedback-message-"] {
            text-align: center;
            font-size: 1.3em;
            font-weight: 900;
            min-height: 40px;
            margin-top: 15px;
        }
        .action-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .action-buttons button {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        .action-buttons button:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        .action-buttons button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        /* --- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ --- */
        #scoreboard {
            background: var(--primary-dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }
        #score-text {
            font-size: 1.2em;
            font-weight: 700;
        }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 1.4em; font-weight: 900; color: white;">
            <i class="fa-solid fa-calendar-alt"></i> ãƒ‘ã‚ºãƒ«ãƒã‚¹ã‚¿ãƒ¼
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="home-link" onclick="goBackToModeSelection()">
                <i class="fa-solid fa-arrow-left"></i> ã‚²ãƒ¼ãƒ ã‚’é¸ã¶
            </button>
            <div id="auth-status" style="font-size:0.9em;">ã‚²ã‚¹ãƒˆ</div>
        </div>
    </header>

    <div class="container">
        <h1>å¹´ãƒ»æœˆãƒ»æ—¥ãƒ»æ›œæ—¥ ã‚²ãƒ¼ãƒ </h1>
        
        <div id="mode-selection">
            <h2>ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
            <div id="daily-point-limit" style="margin-top: 15px; font-weight: 700; color: var(--incorrect);">
                </div>
            <div class="mode-grid">
                <div class="mode-card" onclick="startGame(1)">
                    <i class="fa-solid fa-pencil"></i> èª­ã¿æ–¹ãƒ¢ãƒ¼ãƒ‰ (å››æŠ)<br><span style="font-size:0.8em; font-weight:normal;">(æ¼¢å­—ã®èª­ã¿æ–¹ãƒã‚§ãƒƒã‚¯)</span>
                </div>
                <div class="mode-card" onclick="startGame(2)">
                    <i class="fa-solid fa-volume-high"></i> èãå–ã‚Šãƒ¢ãƒ¼ãƒ‰ (ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³)<br><span style="font-size:0.8em; font-weight:normal;">(èã„ãŸæ—¥ä»˜ã‚’é¸æŠ)</span>
                </div>
                <div class="mode-card" onclick="startGame(3)">
                    <i class="fa-solid fa-comments"></i> æ—¥å¸¸ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ (ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³)<br><span style="font-size:0.8em; font-weight:normal;">(æ–‡è„ˆã‹ã‚‰ã®æ—¥ä»˜æ¨æ¸¬)</span>
                </div>
            </div>
        </div>

        <div id="mode1-game" class="game-area">
            <div id="question-counter-1">å• 0 / 10</div>
            <div id="mode1-question-box"></div>
            <div class="choice-grid" id="mode1-choices"></div>
            <div id="feedback-message-1" style="min-height: 40px;"></div>
            <div class="action-buttons">
                <button id="mode1-check-btn" onclick="checkAnswer(1)" disabled>ç­”ãˆã‚‹</button>
                <button id="mode1-next-btn" onclick="nextQuestion(1)" style="display:none;">æ¬¡ã¸</button>
            </div>
        </div>

        <div id="mode2-game" class="game-area">
            <div id="question-counter-2">å• 0 / 10</div>
            <div class="listening-prompt">
                <h2>èã“ãˆãŸæ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <button id="play-audio-btn" onclick="speakCurrentQuestion(2)">
                    <i class="fa-solid fa-play"></i> éŸ³å£°ã‚’å†ç”Ÿ
                </button>
            </div>
            <div class="dropdown-container" id="mode2-dropdowns">
                </div>
            <div id="feedback-message-2" style="min-height: 40px;"></div>
            <div class="action-buttons">
                <button id="mode2-check-btn" onclick="checkAnswer(2)">ç­”ãˆã‚‹</button>
                <button id="mode2-next-btn" onclick="nextQuestion(2)" style="display:none;">æ¬¡ã¸</button>
            </div>
        </div>

        <div id="mode3-game" class="game-area">
            <div id="question-counter-3">å• 0 / 10</div>
            <div class="situational-prompt">
                <h2 id="mode3-question-text" style="font-size:1.4em; color:var(--primary-dark);"></h2>
                <button id="read-question-btn" onclick="speakCurrentQuestion(3)" style="background:none; border:none; color:var(--primary); font-size:1.1em; cursor:pointer;"><i class="fa-solid fa-volume-high"></i> å•é¡Œã‚’èª­ã‚€</button>
            </div>
            <div class="dropdown-container" id="mode3-dropdowns">
                </div>
            <div id="feedback-message-3" style="min-height: 40px;"></div>
            <div class="action-buttons">
                <button id="mode3-check-btn" onclick="checkAnswer(3)">ç­”ãˆã‚‹</button>
                <button id="mode3-next-btn" onclick="nextQuestion(3)" style="display:none;">æ¬¡ã¸</button>
            </div>
        </div>
        
        <div id="scoreboard" style="display:none;">
            <h2>ã‚²ãƒ¼ãƒ çµæœ</h2>
            <div id="score-text"></div>
            <div style="margin-top: 10px;">
                <button onclick="resetGame()" style="background:#fff; color:var(--primary-dark); padding:10px 20px; border-radius:5px; border:none; font-weight:bold; cursor:pointer;">
                    <i class="fa-solid fa-rotate-left"></i> ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
                </button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { 
        getFirestore, doc, updateDoc, increment, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.appspo.com", 
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã«é–¢æ•°ã‚’è¨­å®š
    window.db = db;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.getDoc = getDoc;
    window.increment = increment;
    window.currentUser = null;
    
    onAuthStateChanged(auth, (user) => {
        const el = document.getElementById('auth-status');
        if (user) {
            window.currentUser = user;
            el.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
        } else {
            window.currentUser = "ã‚²ã‚¹ãƒˆ";
            el.textContent = "ã‚²ã‚¹ãƒˆ";
        }
    });

    /**
     * 1æ—¥1ãƒã‚¤ãƒ³ãƒˆåˆ¶é™ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹
     * @param {number} qId - ç¾åœ¨ã®å•é¡ŒID (currentQuestionIndex + 1)
     * @param {string} gameName - ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID (ä¾‹: 'date_time_1')
     * @returns {Promise<boolean>} ãƒã‚¤ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸã‹ã©ã†ã‹
     */
    window.addPuzzlePoints = async (qId, gameName) => {
        if (!window.currentUser || window.currentUser === "ã‚²ã‚¹ãƒˆ") return false;
        
        const today = new Date().toISOString().split('T')[0];
        const scoreId = `${gameName}_${qId}`;

        try {
            const userRef = window.doc(window.db, "users", window.currentUser.uid);
            const userSnap = await window.getDoc(userRef);

            if (userSnap.exists()) {
                const data = userSnap.data();
                const dailyTracker = data.dailyTracker || {};

                // 1. ãƒã‚¤ãƒ³ãƒˆä»˜ä¸æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
                if (dailyTracker[scoreId] === today) {
                    return false;
                }

                // 2. ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã¨ãƒˆãƒ©ãƒƒã‚«ãƒ¼æ›´æ–°
                const newDailyTracker = { ...dailyTracker, [scoreId]: today };

                await window.updateDoc(userRef, {
                    points: window.increment(1),
                    dailyTracker: newDailyTracker
                });

                return true;
            }
            return false;

        } catch(e) { 
            console.error("Error updating puzzle points:", e); 
            return false;
        }
    };
</script>

<script>
    const cssVars = {
        incorrect: getComputedStyle(document.documentElement).getPropertyValue('--incorrect').trim(),
        correct: getComputedStyle(document.documentElement).getPropertyValue('--correct').trim()
    };
    
    function updateScore() {} 

    const GAME_BASE_ID = "date_time"; 

    const dateOptions = {
        years: [
            { kanji: 'ä»Šå¹´', kana: 'ã“ã¨ã—' },
            { kanji: 'å»å¹´', kana: 'ãã‚‡ã­ã‚“' },
            { kanji: 'æ¥å¹´', kana: 'ã‚‰ã„ã­ã‚“' },
            { kanji: 'ä½•å¹´', kana: 'ãªã‚“ã­ã‚“' }
        ],
        months: [
            { kanji: 'ä¸€æœˆ', kana: 'ã„ã¡ãŒã¤' }, { kanji: 'äºŒæœˆ', kana: 'ã«ãŒã¤' }, { kanji: 'ä¸‰æœˆ', kana: 'ã•ã‚“ãŒã¤' },
            { kanji: 'å››æœˆ', kana: 'ã—ãŒã¤' }, { kanji: 'äº”æœˆ', kana: 'ã”ãŒã¤' }, { kanji: 'å…­æœˆ', kana: 'ã‚ããŒã¤' },
            { kanji: 'ä¸ƒæœˆ', kana: 'ã—ã¡ãŒã¤' }, { kanji: 'å…«æœˆ', kana: 'ã¯ã¡ãŒã¤' }, { kanji: 'ä¹æœˆ', kana: 'ããŒã¤' },
            { kanji: 'åæœˆ', kana: 'ã˜ã‚…ã†ãŒã¤' }, { kanji: 'åä¸€æœˆ', kana: 'ã˜ã‚…ã†ã„ã¡ãŒã¤' }, { kanji: 'åäºŒæœˆ', kana: 'ã˜ã‚…ã†ã«ãŒã¤' },
            { kanji: 'ä½•æœˆ', kana: 'ãªã‚“ãŒã¤' }
        ],
        dates: [
            { kanji: 'ä¸€æ—¥', kana: 'ã¤ã„ãŸã¡' }, { kanji: 'äºŒæ—¥', kana: 'ãµã¤ã‹' }, { kanji: 'ä¸‰æ—¥', kana: 'ã¿ã£ã‹' },
            { kanji: 'å››æ—¥', kana: 'ã‚ˆã£ã‹' }, { kanji: 'äº”æ—¥', kana: 'ã„ã¤ã‹' }, { kanji: 'å…­æ—¥', kana: 'ã‚€ã„ã‹' },
            { kanji: 'ä¸ƒæ—¥', kana: 'ãªã®ã‹' }, { kanji: 'å…«æ—¥', kana: 'ã‚ˆã†ã‹' }, { kanji: 'ä¹æ—¥', kana: 'ã“ã“ã®ã‹' },
            { kanji: 'åæ—¥', kana: 'ã¨ãŠã‹' }, { kanji: 'åä¸€æ—¥', kana: 'ã˜ã‚…ã†ã„ã¡ã«ã¡' }, { kanji: 'åäºŒæ—¥', kana: 'ã˜ã‚…ã†ã«ã«ã¡' },
            { kanji: 'åä¸‰æ—¥', kana: 'ã˜ã‚…ã†ã•ã‚“ã«ã¡' }, { kanji: 'åå››æ—¥', kana: 'ã˜ã‚…ã†ã‚ˆã£ã‹' }, { kanji: 'åäº”æ—¥', kana: 'ã˜ã‚…ã†ã”ã«ã¡' },
            { kanji: 'åå…­æ—¥', kana: 'ã˜ã‚…ã†ã‚ãã«ã¡' }, { kanji: 'åä¸ƒæ—¥', kana: 'ã˜ã‚…ã†ã—ã¡ã«ã¡' }, { kanji: 'åå…«æ—¥', kana: 'ã˜ã‚…ã†ã¯ã¡ã«ã¡' },
            { kanji: 'åä¹æ—¥', kana: 'ã˜ã‚…ã†ãã«ã¡' }, { kanji: 'äºŒåæ—¥', kana: 'ã¯ã¤ã‹' }, { kanji: 'äºŒåä¸€æ—¥', kana: 'ã«ã˜ã‚…ã†ã„ã¡ã«ã¡' },
            { kanji: 'äºŒåäºŒæ—¥', kana: 'ã«ã˜ã‚…ã†ã«ã«ã¡' }, { kanji: 'äºŒåä¸‰æ—¥', kana: 'ã«ã˜ã‚…ã†ã•ã‚“ã«ã¡' }, { kanji: 'äºŒåå››æ—¥', kana: 'ã«ã˜ã‚…ã†ã‚ˆã£ã‹' },
            { kanji: 'äºŒåäº”æ—¥', kana: 'ã«ã˜ã‚…ã†ã”ã«ã¡' }, { kanji: 'äºŒåå…­æ—¥', kana: 'ã«ã˜ã‚…ã†ã‚ãã«ã¡' }, { kanji: 'äºŒåä¸ƒæ—¥', kana: 'ã«ã˜ã‚…ã†ã—ã¡ã«ã¡' },
            { kanji: 'äºŒåå…«æ—¥', kana: 'ã«ã˜ã‚…ã†ã¯ã¡ã«ã¡' }, { kanji: 'äºŒåä¹æ—¥', kana: 'ã«ã˜ã‚…ã†ãã«ã¡' }, { kanji: 'ä¸‰åæ—¥', kana: 'ã•ã‚“ã˜ã‚…ã†ã«ã¡' },
            { kanji: 'ä¸‰åä¸€æ—¥', kana: 'ã•ã‚“ã˜ã‚…ã†ã„ã¡ã«ã¡' }, { kanji: 'ä½•æ—¥', kana: 'ãªã‚“ã«ã¡' }, { kanji: 'ä¸ƒæ—¥', kana: 'ãªã®ã‹ã‚“' }
        ],
        daysOfWeek: [
            { kanji: 'æœˆæ›œæ—¥', kana: 'ã’ã¤ã‚ˆã†ã³' }, { kanji: 'ç«æ›œæ—¥', kana: 'ã‹ã‚ˆã†ã³' }, { kanji: 'æ°´æ›œæ—¥', kana: 'ã™ã„ã‚ˆã†ã³' },
            { kanji: 'æœ¨æ›œæ—¥', kana: 'ã‚‚ãã‚ˆã†ã³' }, { kanji: 'é‡‘æ›œæ—¥', kana: 'ãã‚“ã‚ˆã†ã³' }, { kanji: 'åœŸæ›œæ—¥', kana: 'ã©ã‚ˆã†ã³' },
            { kanji: 'æ—¥æ›œæ—¥', kana: 'ã«ã¡ã‚ˆã†ã³' }, { kanji: 'ä½•æ›œæ—¥', kana: 'ãªã‚“ã‚ˆã†ã³' }
        ],
        dayCounts: [
            { kanji: 'ä¸€æ—¥', kana: 'ã„ã¡ã«ã¡' }, { kanji: 'äºŒæ—¥', kana: 'ãµã¤ã‹' }, { kanji: 'ä¸‰æ—¥', kana: 'ã¿ã£ã‹' },
            { kanji: 'ä¸ƒæ—¥', kana: 'ãªã®ã‹ã‚“' }, { kanji: 'ä¸ƒæ—¥', kana: 'ã„ã£ã—ã‚…ã†ã‹ã‚“' }
        ]
    };

    const mode1Questions = [
        { kanji: 'ä¸€æ—¥', kana: 'ã¤ã„ãŸã¡', type: 'date' }, { kanji: 'äºŒæ—¥', kana: 'ãµã¤ã‹', type: 'date' },
        { kanji: 'ä¸‰æ—¥', kana: 'ã¿ã£ã‹', type: 'date' }, { kanji: 'å››æ—¥', kana: 'ã‚ˆã£ã‹', type: 'date' },
        { kanji: 'ä¸ƒæ—¥', kana: 'ãªã®ã‹', type: 'date' }, { kanji: 'åæ—¥', kana: 'ã¨ãŠã‹', type: 'date' },
        { kanji: 'åå››æ—¥', kana: 'ã˜ã‚…ã†ã‚ˆã£ã‹', type: 'date' }, { kanji: 'äºŒåæ—¥', kana: 'ã¯ã¤ã‹', type: 'date' },
        { kanji: 'äºŒåå››æ—¥', kana: 'ã«ã˜ã‚…ã†ã‚ˆã£ã‹', type: 'date' }, { kanji: 'ä½•æ—¥', kana: 'ãªã‚“ã«ã¡', type: 'date' },
        { kanji: 'å››æœˆ', kana: 'ã—ãŒã¤', type: 'month' }, { kanji: 'ä¹æœˆ', kana: 'ããŒã¤', type: 'month' },
        { kanji: 'ä¸ƒæœˆ', kana: 'ã—ã¡ãŒã¤', type: 'month' }, { kanji: 'é‡‘æ›œæ—¥', kana: 'ãã‚“ã‚ˆã†ã³', type: 'day' },
        { kanji: 'æ°´æ›œæ—¥', kana: 'ã™ã„ã‚ˆã†ã³', type: 'day' }, { kanji: 'å»å¹´', kana: 'ãã‚‡ã­ã‚“', type: 'year' },
        { kanji: 'ä»Šå¹´', kana: 'ã“ã¨ã—', type: 'year' }, { kanji: 'æ¥å¹´', kana: 'ã‚‰ã„ã­ã‚“', type: 'year' },
    ];
    
    const mode2Combinations = [
        { month: 'ä¸€æœˆ', date: 'ä¸‰æ—¥', day: 'æœˆæ›œæ—¥', text: 'ä¸€æœˆã€ä¸‰æ—¥ã€æœˆæ›œæ—¥ã§ã™ã€‚' },
        { month: 'ä¸ƒæœˆ', date: 'ä¸ƒæ—¥', day: 'åœŸæ›œæ—¥', text: 'ä¸ƒæœˆã€ä¸ƒæ—¥ã€åœŸæ›œæ—¥ã§ã™ã€‚' },
        { month: 'åäºŒæœˆ', date: 'äºŒåäº”æ—¥', day: 'é‡‘æ›œæ—¥', text: 'åäºŒæœˆã€äºŒåäº”æ—¥ã€é‡‘æ›œæ—¥ã§ã™ã€‚' },
        { month: 'äºŒæœˆ', date: 'äºŒåæ—¥', day: 'æ°´æ›œæ—¥', text: 'äºŒæœˆã€äºŒåæ—¥ã€æ°´æ›œæ—¥ã§ã™ã€‚' },
        { month: 'äº”æœˆ', date: 'äº”æ—¥', day: 'æ—¥æ›œæ—¥', text: 'äº”æœˆã€äº”æ—¥ã€æ—¥æ›œæ—¥ã§ã™ã€‚' },
        { month: 'å››æœˆ', date: 'ä¸€æ—¥', day: 'ç«æ›œæ—¥', text: 'å››æœˆã€ä¸€æ—¥ã€ç«æ›œæ—¥ã§ã™ã€‚' },
        { month: 'ä¹æœˆ', date: 'åå››æ—¥', day: 'æœ¨æ›œæ—¥', text: 'ä¹æœˆã€åå››æ—¥ã€æœ¨æ›œæ—¥ã§ã™ã€‚' },
        ...Array(20).fill(0).map(() => {
            const month = getRandomItem(dateOptions.months.slice(0, 12));
            const date = getRandomItem(dateOptions.dates.slice(0, 31));
            const day = getRandomItem(dateOptions.daysOfWeek.slice(0, 7));
            const monthKana = dateOptions.months.find(m => m.kanji === month.kanji)?.kana || month.kanji;
            const dateKana = dateOptions.dates.find(d => d.kanji === date.kanji)?.kana || date.kanji;
            const dayKana = dateOptions.daysOfWeek.find(d => d.kanji === day.kanji)?.kana || day.kanji;
            
            const text = `${monthKana}ã€${dateKana}ã€${dayKana}ã§ã™ã€‚`;
            return { month: month.kanji, date: date.kanji, day: day.kanji, text: text };
        })
    ];

    const mode3Questions = [
        { id: 1, question: 'å¹´ã®çµ‚ã‚ã‚Šã€é™¤å¤œã®é˜ã‚’èãã®ã¯ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'åäºŒæœˆ', date: 'ä¸‰åä¸€æ—¥' }, components: ['month', 'date'] },
        { id: 2, question: 'æ—¥æœ¬ã®æ–°å¹´ï¼ˆãŠæ­£æœˆï¼‰ã¯ã€ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¸€æœˆ', date: 'ä¸€æ—¥' }, components: ['month', 'date'] },
        { id: 3, question: 'æ—¥æœ¬ã®å­¦æ ¡ã‚„ä¼šç¤¾ãŒä¼‘ã¿ã«ãªã‚‹ã“ã¨ãŒå¤šã„ã®ã¯ã€ä½•æ›œæ—¥ã¨ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'åœŸæ›œæ—¥', day2: 'æ—¥æ›œæ—¥' }, components: ['day', 'day2'] }, 
        { id: 4, question: 'æ¥å¹´ã®ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ï¼ˆä»®ï¼‰ã¯ä½•å¹´ã§ã™ã‹ï¼Ÿ', answer: { year: 'æ¥å¹´' }, components: ['year'] },
        { id: 5, question: 'ã‚¯ãƒªã‚¹ãƒã‚¹ã¯ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'åäºŒæœˆ', date: 'äºŒåäº”æ—¥' }, components: ['month', 'date'] },
        { id: 6, question: 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼ã¯ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'äºŒæœˆ', date: 'åå››æ—¥' }, components: ['month', 'date'] },
        { id: 7, question: 'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¦ã‚£ãƒ¼ã‚¯ã¯ã ã„ãŸã„ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'äº”æœˆ' }, components: ['month'] },
        { id: 8, question: 'å­ã©ã‚‚ã®æ—¥ï¼ˆã“ã©ã‚‚ã®ã²ï¼‰ã¯ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'äº”æœˆ', date: 'äº”æ—¥' }, components: ['month', 'date'] },
        { id: 9, question: 'ä¸ƒå¤•ï¼ˆãŸãªã°ãŸï¼‰ã¯ä½•æœˆä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¸ƒæœˆ', date: 'ä¸ƒæ—¥' }, components: ['month', 'date'] },
        { id: 10, question: 'æ—¥æœ¬ã®å­¦æ ¡ã®å¤ä¼‘ã¿ã¯ã ã„ãŸã„ä½•æœˆã”ã‚ã§ã™ã‹ï¼Ÿ', answer: { month: 'å…«æœˆ' }, components: ['month'] },
        { id: 11, question: 'æ•¬è€ã®æ—¥ï¼ˆã‘ã„ã‚ã†ã®ã²ï¼‰ã¯ã ã„ãŸã„ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¹æœˆ' }, components: ['month'] },
        { id: 12, question: 'ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰ã¯æœˆæ›œæ—¥ã§ã™ã€‚æ˜æ—¥ã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'ç«æ›œæ—¥' }, components: ['day'] },
        { id: 13, question: 'ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰ã¯æœ¨æ›œæ—¥ã§ã™ã€‚æ˜¨æ—¥ã¯ä½•æ›œæ—¥ã§ã—ãŸã‹ï¼Ÿ', answer: { day: 'æ°´æ›œæ—¥' }, components: ['day'] },
        { id: 14, question: 'ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰ã¯é‡‘æ›œæ—¥ã§ã™ã€‚æ˜å¾Œæ—¥ï¼ˆã‚ã•ã£ã¦ï¼‰ã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'æ—¥æ›œæ—¥' }, components: ['day'] },
        { id: 15, question: 'æœˆæ›œæ—¥ã®å‰ã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'æ—¥æ›œæ—¥' }, components: ['day'] },
        { id: 16, question: 'ä¸€èˆ¬çš„ã«ã€æ—¥æœ¬ã®ä¼æ¥­ã§ãƒœãƒ¼ãƒŠã‚¹ãŒæ”¯çµ¦ã•ã‚Œã‚‹ã®ã¯ã€ä½•æœˆã¨ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¸ƒæœˆ', month2: 'åäºŒæœˆ' }, components: ['month', 'month2'] }, 
        { id: 17, question: 'é¡é–‹ãï¼ˆã‹ãŒã¿ã³ã‚‰ãï¼‰ã¯ä¸€æœˆã®ä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { date: 'åä¸€æ—¥' }, components: ['date'] },
        { id: 18, question: 'ä¸€èˆ¬çš„ã«ã€ã‚ãªãŸã®å›½ã§ä¸€ç•ªæš‘ã„å­£ç¯€ã¯ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'å…«æœˆ' }, components: ['month'] },
        { id: 19, question: '1é€±é–“ã§çœŸã‚“ä¸­ã®æ—¥ï¼ˆä¸­å¿ƒï¼‰ã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'æ°´æ›œæ—¥' }, components: ['day'] },
        { id: 20, question: 'æ˜¥åˆ†ã®æ—¥ï¼ˆã—ã‚…ã‚“ã¶ã‚“ã®ã²ï¼‰ã¯ã ã„ãŸã„ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¸‰æœˆ' }, components: ['month'] },
        { id: 21, question: 'ãŠæ­£æœˆä¼‘ã¿ãŒå§‹ã¾ã‚‹ã®ã¯ä½•æœˆä½•æ—¥ã”ã‚ã§ã™ã‹ï¼Ÿ', answer: { date: 'äºŒåä¹æ—¥', month: 'åäºŒæœˆ' }, components: ['month', 'date'] },
        { id: 22, question: '28æ—¥ã®æ¬¡ã®æ—¥ã«ã¡ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { date: 'äºŒåä¹æ—¥' }, components: ['date'] },
        { id: 23, question: '15æ—¥ã®å‰ã®æ—¥ã«ã¡ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { date: 'åå››æ—¥' }, components: ['date'] },
        { id: 24, question: 'äº”æœˆã®å‰ã¯ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'å››æœˆ' }, components: ['month'] },
        { id: 25, question: 'å…­æœˆã®æ¬¡ã¯ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'ä¸ƒæœˆ' }, components: ['month'] },
        { id: 26, question: 'å¹´æœ«ï¼ˆã­ã‚“ã¾ã¤ï¼‰ã¯ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'åäºŒæœˆ' }, components: ['month'] },
        { id: 27, question: 'æœˆåˆã‚ï¼ˆã¤ãã¯ã˜ã‚ï¼‰ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ', answer: { date: 'ä¸€æ—¥' }, components: ['date'] },
        { id: 28, question: 'ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰ã¯åœŸæ›œæ—¥ã§ã™ã€‚ä¸€é€±é–“å¾Œã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ', answer: { day: 'åœŸæ›œæ—¥' }, components: ['day'] },
        { id: 29, question: 'ä¼šç¤¾ã®æ–°ã—ã„å¹´åº¦ã¯ä½•æœˆã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ', answer: { month: 'å››æœˆ' }, components: ['month'] },
        { id: 30, question: 'å­¦æ ¡ã®æ–°ã—ã„å¹´åº¦ï¼ˆå…¥å­¦å¼ï¼‰ã¯ä½•æœˆã§ã™ã‹ï¼Ÿ', answer: { month: 'å››æœˆ' }, components: ['month'] }
    ];


    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° ---
    let currentMode = 0;
    let questionData = []; 
    let currentQuestionIndex = 0;
    let score = 0;
    const maxQuestions = 10;
    let isAnswered = false;
    let selectedChoice = null;

    // --- TTS/éŸ³å£°æ©Ÿèƒ½ ---
    const synth = window.speechSynthesis;
    let voices = [];
    setTimeout(() => { voices = synth.getVoices(); }, 500);

    function speak(text) {
        if (synth.speaking) synth.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'ja-JP'; 
        ut.rate = 0.8; // â˜… ä¿®æ­£ 2: ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è½ã¨ã™
        const jpVoices = voices.filter(v => v.lang.includes('ja') || v.lang.includes('JP'));
        let targetVoice = jpVoices.find(v => v.name.includes('Google') || v.name.includes('Female'));
        if (!targetVoice && jpVoices.length > 0) targetVoice = jpVoices[0];
        if (targetVoice) ut.voice = targetVoice;
        synth.speak(ut);
    }
    
    // â˜… ä¿®æ­£ 3: ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹é–¢æ•°
    window.goBackToModeSelection = function() {
        if (currentMode !== 0) {
            document.getElementById(`mode${currentMode}-game`).style.display = 'none';
        }
        document.getElementById('scoreboard').style.display = 'none';
        resetGame(); // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('mode-selection').style.display = 'block';
    }


    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function getRandomItem(array) {
        return array[Math.floor(Math.random() * array.length)];
    }

    function filterOptions(type, correctKanji) {
        let pool;
        if (type === 'date') {
            pool = dateOptions.dates.filter(item => item.kanji !== correctKanji);
        } else if (type === 'month') {
            pool = dateOptions.months.filter(item => item.kanji !== correctKanji);
        } else if (type === 'day') {
            pool = dateOptions.daysOfWeek.filter(item => item.kanji !== correctKanji);
        } else if (type === 'year') {
            pool = dateOptions.years.filter(item => item.kanji !== correctKanji);
        } else {
            return [];
        }

        return shuffleArray(pool).slice(0, 3).map(item => item.kana);
    }
    
    function resetGame() {
        currentMode = 0;
        questionData = [];
        currentQuestionIndex = 0;
        score = 0;
        document.getElementById('daily-point-limit').textContent = ''; 
    }


    // --- ã‚²ãƒ¼ãƒ åˆ¶å¾¡ ---

    function startGame(mode) {
        if (currentMode !== 0) return; 
        currentMode = mode;
        score = 0;
        currentQuestionIndex = 0;
        isAnswered = false;
        
        document.getElementById('mode-selection').style.display = 'none';
        const gameArea = document.getElementById(`mode${mode}-game`);
        gameArea.style.display = 'block';

        let sourceData;
        if (mode === 1) {
            sourceData = mode1Questions;
        } else if (mode === 2) {
            sourceData = mode2Combinations;
        } else if (mode === 3) {
            sourceData = mode3Questions;
        }
        questionData = shuffleArray(sourceData).slice(0, maxQuestions);

        loadQuestion(mode);
        
        if (mode === 3) {
            setTimeout(() => speakCurrentQuestion(3), 500); 
        }
    }

    function loadQuestion(mode) {
        isAnswered = false;
        selectedChoice = null;
        const currentQ = questionData[currentQuestionIndex];
        document.getElementById(`question-counter-${mode}`).textContent = `å• ${currentQuestionIndex + 1} / ${maxQuestions}`;
        document.getElementById(`feedback-message-${mode}`).innerHTML = '';
        document.getElementById(`mode${mode}-check-btn`).style.display = 'block';
        document.getElementById(`mode${mode}-next-btn`).style.display = 'none';
        
        if (mode === 1) {
            // â˜… ä¿®æ­£ 2: ã‚²ãƒ¼ãƒ 1ã®ãƒœã‚¿ãƒ³ã‚’åˆæœŸã¯disabledã«ã™ã‚‹ï¼ˆé¸æŠè‚¢ãŒé¸ã°ã‚Œã¦ã„ãªã„ãŸã‚ï¼‰
            document.getElementById(`mode1-check-btn`).disabled = true; 
            const kanji = currentQ.kanji;
            const correctKana = currentQ.kana;
            document.getElementById('mode1-question-box').textContent = kanji;
            
            let choices = [correctKana];
            const distractors = filterOptions(currentQ.type, kanji);
            choices.push(...distractors.slice(0, 3)); 

            choices = shuffleArray(choices);

            const choicesEl = document.getElementById('mode1-choices');
            choicesEl.innerHTML = '';
            
            // â˜… ä¿®æ­£ 1: é¸æŠè‚¢ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ã€å¤ã„ã‚¯ãƒ©ã‚¹ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            choices.forEach(kana => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = kana;
                btn.setAttribute('data-value', kana);
                btn.onclick = () => selectChoice(btn);
                choicesEl.appendChild(btn);
            });

        } else if (mode === 2) {
            const dropdowns = [
                { id: 'month', type: 'month' },
                { id: 'date', type: 'date' },
                { id: 'day', type: 'day' }
            ];
            setupDynamicDropdowns(2, dropdowns);
            document.getElementById('play-audio-btn').textContent = 'éŸ³å£°ã‚’å†ç”Ÿ';

        } else if (mode === 3) {
            document.getElementById('mode3-question-text').textContent = currentQ.question;
            
            const currentComponents = [];
            const answerKeys = Object.keys(currentQ.answer);
            
            answerKeys.forEach(key => {
                let baseType = key.replace(/[0-9]/g, ''); 
                
                let type;
                if (baseType === 'day') type = 'day';
                else if (baseType === 'month') type = 'month';
                else if (baseType === 'date') type = 'date';
                else if (baseType === 'year') type = 'year';

                currentComponents.push({ id: key, type: type });
            });
            
            setupDynamicDropdowns(3, currentComponents);
            
            // â˜… ä¿®æ­£ 2: ã‚²ãƒ¼ãƒ 3ã®ãƒœã‚¿ãƒ³ã‚’åˆæœŸã‹ã‚‰æŠ¼ã›ã‚‹çŠ¶æ…‹ã«æˆ»ã™
            document.getElementById(`mode3-check-btn`).disabled = false;
        }
    }
    
    function selectChoice(btn) {
        if (isAnswered) return;
        document.querySelectorAll('#mode1-choices .choice-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedChoice = btn.getAttribute('data-value');
        document.getElementById('mode1-check-btn').disabled = false;
    }

    function setupDynamicDropdowns(mode, components) {
        const container = document.getElementById(`mode${mode}-dropdowns`);
        container.innerHTML = '';
        
        const kanjiMap = {
            'year': dateOptions.years,
            'month': dateOptions.months,
            'date': dateOptions.dates,
            'day': dateOptions.daysOfWeek,
        };

        components.forEach(comp => {
            const group = document.createElement('div');
            group.className = 'dropdown-group';

            const labelText = comp.id
                .replace('day2', 'æ›œæ—¥2')
                .replace('month2', 'æœˆ2')
                .replace('day_count', 'æ—¥æ•°')
                .replace('year', 'å¹´')
                .replace('month', 'æœˆ')
                .replace('date', 'æ—¥ã«ã¡')
                .replace('day', 'æ›œæ—¥');

            const label = document.createElement('label');
            label.textContent = labelText;
            label.setAttribute('for', `mode${mode}-${comp.id}`);

            const selectEl = document.createElement('select');
            selectEl.id = `mode${mode}-${comp.id}`;
            selectEl.name = `mode${mode}-${comp.id}`;
            
            const optionsData = kanjiMap[comp.type] || [];
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `-- ${labelText}ã‚’é¸æŠ --`;
            selectEl.appendChild(defaultOption);

            optionsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.kanji; 
                option.textContent = `${item.kanji} (${item.kana})`;
                selectEl.appendChild(option);
            });

            group.appendChild(label);
            group.appendChild(selectEl);
            container.appendChild(group);
        });
    }
    
    // â˜… ä¿®æ­£ 2, 3: éŸ³å£°å†ç”Ÿé–¢æ•°ã‚’ãƒ¢ãƒ¼ãƒ‰åˆ¥ã«å†åˆ©ç”¨
    window.speakCurrentQuestion = function(mode) {
        if (isAnswered) return;
        
        let textToSpeak = '';
        if (mode === 2) {
            const currentQ = questionData[currentQuestionIndex];
            textToSpeak = currentQ.text;
            document.getElementById('play-audio-btn').textContent = 'å†ç”Ÿä¸­...';
            setTimeout(() => {
                document.getElementById('play-audio-btn').textContent = 'ã‚‚ã†ä¸€åº¦å†ç”Ÿ';
            }, 3000); 
        } else if (mode === 3) {
            textToSpeak = document.getElementById('mode3-question-text').textContent;
        }

        if (textToSpeak) {
            speak(textToSpeak);
        }
    }

    // --- å›ç­”ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ ---

    window.checkAnswer = async function(mode) { 
        if (isAnswered) return;
        isAnswered = true;
        let correct = false;
        
        const checkBtn = document.getElementById(`mode${mode}-check-btn`);
        checkBtn.disabled = true; 
        
        const currentQ = questionData[currentQuestionIndex];
        let correctKanjiText = '';

        if (mode === 1) {
            const correctKana = currentQ.kana;
            const buttons = document.querySelectorAll('#mode1-choices .choice-btn');
            
            buttons.forEach(btn => {
                const value = btn.getAttribute('data-value');
                if (value === correctKana) {
                    btn.classList.add('correct', 'answered');
                    if (value === selectedChoice) {
                        correct = true;
                    }
                } else if (value === selectedChoice) {
                    btn.classList.add('incorrect', 'answered');
                } else {
                    btn.classList.add('answered');
                }
            });
        
        } else if (mode === 2) {
            const selectedMonth = document.getElementById('mode2-month').value;
            const selectedDate = document.getElementById('mode2-date').value;
            const selectedDay = document.getElementById('mode2-day').value;
            
            const correctMonth = currentQ.month;
            const correctDate = currentQ.date;
            const correctDay = currentQ.day;

            correct = (selectedMonth === correctMonth && selectedDate === correctDate && selectedDay === correctDay);

        } else if (mode === 3) {
            const correctAnswers = currentQ.answer;
            correct = true;

            for (const key in correctAnswers) {
                const selectEl = document.getElementById(`mode3-${key}`);
                
                if (!selectEl) continue; 

                const selectedValue = selectEl.value;

                if (!selectedValue || selectedValue !== correctAnswers[key]) {
                    correct = false;
                    selectEl.style.borderColor = cssVars.incorrect; 
                } else {
                    selectEl.style.borderColor = cssVars.correct;
                }
                
                correctKanjiText += `${correctAnswers[key]}`;
            }
        }
        
        // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨é·ç§» ---
        let feedback = '';
        
        if (correct) {
            const GAME_ID = `${GAME_BASE_ID}_${mode}`; 
            const pointAdded = await window.addPuzzlePoints(currentQuestionIndex + 1, GAME_ID); 
            
            if (pointAdded) {
                score++;
                document.getElementById('daily-point-limit').textContent = `ğŸ‰ ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼ (+1pt)`;
                feedback = `<span style="color:${cssVars.correct};"><i class="fa-solid fa-circle-check"></i> å¤§æ­£è§£ï¼ (+1pt)</span>`;
            } else {
                document.getElementById('daily-point-limit').textContent = `(ä»Šæ—¥ã¯ãƒã‚¤ãƒ³ãƒˆç²å¾—æ¸ˆã¿)`;
                feedback = `<span style="color:${cssVars.correct};"><i class="fa-solid fa-circle-check"></i> æ­£è§£ã§ã™ï¼ (ä»Šæ—¥ã¯ã“ã®å•é¡Œã®ãƒã‚¤ãƒ³ãƒˆç²å¾—æ¸ˆã¿)</span>`;
            }

            // â˜… ä¿®æ­£ 1: æ­£è§£ãªã‚‰è‡ªå‹•ã§æ¬¡ã®å•é¡Œã«é€²ã‚€
            setTimeout(() => {
                nextQuestion(mode);
            }, 1500); 

        } else {
            feedback = `<span style="color:${cssVars.incorrect};"><i class="fa-solid fa-circle-xmark"></i> æ®‹å¿µã€‚ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚</span>`;
            
            // ä¸æ­£è§£ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ã—ã€å†å›ç­”ã‚’è¨±å¯
            isAnswered = false;
            checkBtn.disabled = false;
        }
        
        document.getElementById(`feedback-message-${mode}`).innerHTML = feedback;
    }

    function nextQuestion(mode) {
        currentQuestionIndex++;
        if (currentQuestionIndex < maxQuestions) {
            loadQuestion(mode);
            if (mode === 3) {
                 setTimeout(() => speakCurrentQuestion(3), 500); 
            }
        } else {
            showResults(mode);
        }
    }

    function showResults(mode) {
        document.getElementById(`mode${mode}-game`).style.display = 'none';
        
        const scoreboard = document.getElementById('scoreboard');
        scoreboard.style.display = 'block';

        document.getElementById('score-text').innerHTML = 
            `<p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>
            <p style="font-size:2em; margin:10px 0;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ã¯ <span style="color:var(--accent);">${score}</span> / ${maxQuestions} ç‚¹ã§ã™ã€‚</p>`;
        
        if (score >= maxQuestions * 0.7) { 
            document.getElementById('score-text').innerHTML += 
                `<p style="color:var(--accent); font-weight:900;">ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ãƒã‚¤ãƒ³ãƒˆç²å¾—ãƒãƒ£ãƒ³ã‚¹ã‚’æ´»ã‹ã—ã¾ã—ãŸï¼ ğŸ‰</p>`;
        } else {
            document.getElementById('score-text').innerHTML += 
                `<p style="font-weight:700;">ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã€ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼</p>`;
        }
    }


    // --- åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        resetGame();
        // â˜… ä¿®æ­£ 3: åˆæœŸåŒ–å¾Œã€ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('mode-selection').style.display = 'block';
        if (synth.getVoices().length === 0) {
            synth.addEventListener('voiceschanged', () => {
                voices = synth.getVoices();
            });
        }
    });
</script>
</body>
</html>