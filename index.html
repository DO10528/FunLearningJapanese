<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="main_title">Fun Learning Japanese</title>
<meta name="description" content="Learn Hiragana, Katakana, Kanji, and grammar with fun, free Japanese learning games! Perfect for beginners.">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#5c7aff">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FunLearnJP">
<link rel="apple-touch-icon" href="images/icons/icon-192x192.png"> 
<link rel="stylesheet" href="css/style.css">
<style>
/* ï¼ˆçœç•¥ â€” æ—¢å­˜ã® CSS ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ãã ã•ã„ï¼‰ */
.menu-group { background-color: #f0f8ff; border: 2px solid #5c7aff; border-radius: 15px; padding: 15px 20px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.menu-group h2 { text-align: center; color: #5c7aff; font-size: 1.5em; margin-bottom: 20px; }
#auth-status-bar { width: 100%; max-width: 800px; margin: 10px auto 20px; padding: 10px 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
#user-status-container { display: flex; flex-direction: column; align-items: flex-start; padding: 5px 0; } 
#user-info { font-size: 1.1em; font-weight: bold; color: #333; } 
#streak-display { font-size: 0.9em; font-weight: 800; color: #ff6b6b; } 
#points-display { font-size: 0.9em; font-weight: 800; color: #5cb85c; } 
#auth-buttons button { margin-left: 10px; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
.btn-login { background-color: #5cb85c; color: white; }
.btn-signup { background-color: #007bff; color: white; }
.btn-guest { background-color: #f0ad4e; color: white; }
.btn-logout { background-color: #d9534f; color: white; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; }
.modal-content { background-color: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.modal-content h2 { margin-top: 0; color: #005bb5; }
.modal-content input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
.modal-content button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
.modal-content .btn-submit { background-color: #007bff; color: white; }
.modal-content .btn-close { background-color: #ccc; color: #333; margin-top: 10px; }
.form-message { color: #d9534f; margin-bottom: 10px; font-weight: bold; }
#main-menu.locked { filter: blur(2px); pointer-events: none; user-select: none; }
#initial-message { text-align: center; padding: 50px 20px; font-size: 1.1em; color: #d9534f; font-weight: bold; border: 2px dashed #d9534f50; border-radius: 10px; margin-top: 20px; }
@media (max-width: 600px) { #auth-status-bar { flex-direction: column; gap: 10px; } #user-status-container { width: 100%; align-items: center; } #auth-buttons { width: 100%; display: flex; justify-content: space-between; } #auth-buttons button { margin: 0 2px; flex-grow: 1; } }
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-0BX3DD42C1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0BX3DD42C1');
</script>
</head>
<body>
    
<div id="language-switcher">
    <button onclick="setLanguage('ja')" id="lang-ja" class="lang-button active">ã«ã»ã‚“ã”</button>
    <button onclick="setLanguage('en')" id="lang-en" class="lang-button">English</button>
</div>

<div id="auth-status-bar">
    <div id="user-status-container">
        <span id="user-info" data-i18n="auth_status_default">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</span>
        <span id="streak-display" style="display: none;"></span>
        <span id="points-display" style="display: none;"></span>
    </div>
    <div id="auth-buttons">
        <button id="login-btn" class="btn-login" data-i18n="btn_login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="signup-btn" class="btn-signup" data-i18n="btn_signup">æ–°è¦ç™»éŒ²</button>
        <button id="guest-btn" class="btn-guest" data-i18n="btn_guest">ã‚²ã‚¹ãƒˆã§ãƒ—ãƒ¬ã‚¤</button>
        <button id="logout-btn" class="btn-logout" data-i18n="btn_logout" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<h1 data-i18n="main_title">Fun Learning Japanese</h1>

<div id="initial-message" style="display: none;">
    <p data-i18n="msg_initial_1">ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹ã«ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«**ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã‹ã€**æ–°è¦ç™»éŒ²**ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
    <p data-i18n="msg_initial_2">é€²æ—ã‚’ä¿å­˜ã—ãªã„å ´åˆã¯ã€**ã‚²ã‚¹ãƒˆ**ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
</div>

<div id="main-menu" class="container">
    <div class="menu-group">
        <h2 data-i18n="group_kiso">ãããƒ»ãŸã‚“ã”ãƒªã‚¹ãƒˆ</h2>
        <div class="menu-buttons-grid">
            <a href="kiso.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kiso">
                ğŸ“<br>ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠåŸºç¤
            </a>
            <a href="hiragana_video_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_video">
                ğŸ¥<br>ã²ã‚‰ãŒãªç·´ç¿’
            </a>
            <a href="keiyoshi_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_keiyoshi_list">
                ğŸ“š<br>å½¢å®¹è©ãƒªã‚¹ãƒˆ
            </a>
            <a href="kanji_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kanji_list">
                ğŸ“–<br>æ¼¢å­—ãƒªã‚¹ãƒˆ (å°1)
            </a>
        </div>
    </div>

    <div class="menu-group">
        <h2 data-i18n="group_game">ãªã«ã‚’ã—ã¦ã‚ãã¶?</h2>
        <div class="menu-buttons-grid">
            <a href="hiragana_drag_match.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_drag">
                ğŸ§©<br>ã²ã‚‰ãŒãªå˜èªã‚ã‚ã›
            </a>
            <a href="hiragana.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_game">
                ğŸ®<br>ã²ã‚‰ãŒãªå˜èªã‚²ãƒ¼ãƒ 
            </a>
            <a href="hiragana2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_game2">
                â­<br>ã²ã‚‰ãŒãªã‚²ãƒ¼ãƒ 2 (ä¸¦ã³æ›¿ãˆ)
            </a>
            <a href="katakana_drag_match.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_katakana_drag">
                ğŸ§©<br>ã‚«ã‚¿ã‚«ãƒŠå˜èªã‚ã‚ã›
            </a>
            <a href="shiritori.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_shiritori">
                ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ 
            </a>
            <a href="shiritori2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_shiritori2">
                ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ 2
            </a>
            <a href="clock.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_clock">
                ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ 
            </a>
            <a href="clock2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_clock2">
                ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ 2
            </a>
            <a href="keiyoshi.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_keiyoshi_quiz">
                ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º
            </a>
            <a href="adjective_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_adjective_quiz">
                ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º2
            </a>
            <a href="kanji_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kanji_quiz">
                ğŸˆ³<br>æ¼¢å­—ã‚¯ã‚¤ã‚º (å°1)
            </a>
            <a href="aisatsu_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_aisatsu_quiz">
                ğŸ—£ï¸<br>æŒ¨æ‹¶ã‚¯ã‚¤ã‚º
            </a>
            <a href="verb.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_verb_game">
                ğŸ—£ï¸<br>å‹•è©ã‚²ãƒ¼ãƒ 
            </a>
            <a href="sentence_puzzle.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_sentence_puzzle">
                ğŸ—£ï¸<br>æ–‡æ³•ä¸¦ã³æ›¿ãˆã‚²ãƒ¼ãƒ 
            </a>
            <a href="meteor_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_meteor_quiz">
                ğŸ—£ï¸<br>éš•çŸ³ã‚¯ã‚¤ã‚º
            </a>
            <a href="treasure_Hunt.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_treasure_hunt">
                ğŸ—£ï¸<br>ãŸã‹ã‚‰ã•ãŒã—ã‚²ãƒ¼ãƒ 
            </a>
        </div>
    </div>
</div>
<div id="game-area" class="container" style="display:none;">
    <p>ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
</div>

<div id="auth-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div id="login-view">
            <h2 data-i18n="login_title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div id="login-message" class="form-message"></div>
            <input type="text" id="login-gamename" data-i18n-placeholder="placeholder_gamename" placeholder="ã‚²ãƒ¼ãƒ å" required>
            <input type="password" id="login-password" data-i18n-placeholder="placeholder_password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
            <button id="login-submit-btn" class="btn-submit" data-i18n="btn_login">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn-close" data-i18n="btn_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        
        <div id="signup-view" style="display:none;">
            <h2 data-i18n="signup_title">æ–°è¦ç™»éŒ²</h2>
            <div id="signup-message" class="form-message"></div>
            <p style="font-size: 0.9em; color: #555;" data-i18n="msg_signup_note">â€»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã®é€²æ—ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <input type="text" id="signup-gamename" data-i18n-placeholder="placeholder_new_gamename" placeholder="æ–°ã—ã„ã‚²ãƒ¼ãƒ å (å¿…é ˆ)" required>
            <input type="password" id="signup-password" data-i18n-placeholder="placeholder_password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å¿…é ˆ)" required>
            <button id="signup-submit-btn" class="btn-submit" data-i18n="btn_signup_submit">ç™»éŒ²ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn-close" data-i18n="btn_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã²ã‚‰ãŒãªå˜èªã‚ã‚ã›ã‚²ãƒ¼ãƒ </title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        /* (ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) */
        
        body {
            font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
            background: linear-gradient(180deg, #f0f8ff 0%, #cce7ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        /* IDã¨ã‚¯ãƒ©ã‚¹åã‚’ km- ã‹ã‚‰ hg- ã«å¤‰æ›´ */
        #hg-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 30px; 
            background-color: #ffffff;
            box-shadow: 0 8px 24px rgba(0, 91, 179, 0.15); 
            border-radius: 20px; 
            border: none; 
        }

        #hg-container h1 {
            text-align: center;
            color: #005bb5;
            font-weight: 800; 
            font-size: 2.5em; 
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
        }
        
        #hg-container h2 {
            text-align: center;
            color: #5c7aff;
        }

        /* --- ãƒ¬ãƒ™ãƒ«é¸æŠ --- */
        #hg-level-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        /* ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ */
        #hg-level-selection button {
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 5px solid rgba(0,0,0,0.15);
        }
        #hg-level-selection button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        #hg-level-selection button:active {
            transform: scale(1.0) translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        #hg-level-selection button:nth-child(5n+1) { background-color: #ff6b6b; } /* èµ¤ */
        #hg-level-selection button:nth-child(5n+2) { background-color: #feca57; } /* é»„ */
        #hg-level-selection button:nth-child(5n+3) { background-color: #48dbfb; } /* æ°´è‰² */
        #hg-level-selection button:nth-child(5n+4) { background-color: #1dd1a1; } /* ç·‘ */
        #hg-level-selection button:nth-child(5n+5) { background-color: #ff9f43; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        
        /* --- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ (ç¸¦ä¸€åˆ—ãƒ‡ã‚¶ã‚¤ãƒ³) --- */
        #hg-game-area {
            display: flex;
            flex-direction: row; 
            gap: 20px;
        }
        #hg-illust-area, #hg-word-area {
            padding: 15px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
            border: 2px dashed #ccc; 
            min-height: 150px;
        }
        #hg-illust-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #hg-word-area {
            flex: 1;
        }
        #hg-illust-pool {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        #hg-illust-area h3, #hg-word-area h3 {
            text-align: center; 
            margin-top: 0; 
            color: #555;
            width: 100%;
        }
        .hg-drag-item {
            width: 100px; height: 100px; background-color: #fff;
            border: 2px solid #ddd; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab; margin: 5px; display: inline-flex;
            justify-content: center; align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;

            /* â–¼â–¼â–¼ ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®ãŸã‚ã®CSS â–¼â–¼â–¼ */
            touch-action: none;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
            /* â–²â–²â–² ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®ãŸã‚ã®CSS â–²â–²â–² */
        }
        
        .hg-drag-item img {
            width: 90%; height: 90%; object-fit: contain;
        }
        .hg-word-row {
            display: flex; align-items: center; margin-bottom: 10px;
            background-color: #fff; border-radius: 8px;
            border: 1px solid #ccc; padding: 5px;
        }
        .hg-drop-target {
            width: 100px; height: 100px; border: 2px dashed #aaa;
            border-radius: 8px; background-color: #f0f8ff;
            margin-right: 15px; transition: background-color 0.2s, border-color 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .hg-word-label {
            font-size: 1.8em; font-weight: bold; color: #333;
        }
        .hg-drop-target.drag-over {
            background-color: #e6f7ff; border-color: #5c7aff; border-style: solid;
        }
        
        .hg-drop-target.correct {
            border: 3px solid #28a745; background-color: #e6ffed; padding: 0;
        }
        
        /* é…ç½®ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« (æ­£è§£æ™‚) */
        .hg-drop-target.correct .hg-drag-item {
            width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; cursor: not-allowed;
        }
        
        /* é…ç½®ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« (æœªåˆ¤å®šæ™‚) */
        .hg-drop-target .hg-drag-item {
             width: 100%; height: 100%; margin: 0; box-shadow: none;
            border: none; opacity: 1 !important; 
            cursor: pointer; 
        }
        
        /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§æŒ‡ã«è¿½éšã•ã›ã‚‹ãŸã‚ã®ã‚´ãƒ¼ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .hg-touch-ghost {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
            transform: scale(1.1);
        }

        #hg-feedback {
            text-align: center; font-size: 1.3em; font-weight: bold;
            margin-top: 20px; min-height: 1.3em; color: #d9534f;
        }
        #hg-feedback.success { color: #28a745; }

        /* --- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ --- */
        .hg-button-area {
            text-align: center;
            margin-top: 25px;
        }
        .hg-button {
            display: inline-block;
            margin: 0 5px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 700;
            color: #fff;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-bottom: 4px solid rgba(0,0,0,0.15);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .hg-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .hg-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom-width: 2px;
        }
        .hg-button-home {
            background-color: #6c757d;
            border-bottom-color: #4a4e52;
        }
        .hg-button-reset {
            background-color: #ffc107;
            color: #333;
            border-bottom-color: #c69500;
        }

        /* --- ã‚¹ãƒãƒ›ç”¨ã®èª¿æ•´ --- */
        @media (max-width: 600px) {
            #hg-container {
                padding: 15px;
            }
            #hg-container h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            #hg-level-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            #hg-level-selection button {
                font-size: 1.2em;
                padding: 15px;
            }
            #hg-game-area {
                flex-direction: row; 
                gap: 10px;
            }
            #hg-illust-area, #hg-word-area {
                padding: 5px; 
                min-height: 100px; 
            }
            #hg-illust-area h3, #hg-word-area h3 {
                font-size: 0.8em; 
                margin-bottom: 5px;
            }
            .hg-drag-item {
                width: 60px; height: 60px; margin: 2px;
            }
            .hg-drop-target {
                width: 60px; height: 60px; margin-right: 5px;
            }
            .hg-word-label {
                font-size: 1.0em; 
            }
            .hg-button {
                padding: 10px 15px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div id="hg-container">
        <h1 id="hg-main-title">ã²ã‚‰ãŒãªå˜èªã‚ã‚ã›ã‚²ãƒ¼ãƒ </h1>
        
        <div id="hg-level-selection">
            </div>

        <h2 id="hg-level-title"></h2>
        
        <div id="hg-game-area" style="display: none;">
            <div id="hg-illust-area">
                <h3>ã‚¤ãƒ©ã‚¹ãƒˆ (ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã­)</h3>
                <div id="hg-illust-pool">
                    </div>
            </div>
            
            <div id="hg-word-area">
                <h3>ã“ã¨ã° (ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã°ã—ã‚‡)</h3>
                <div id="hg-word-list">
                    </div>
            </div>
        </div>

        <div id="hg-feedback"></div>

        <div class="hg-button-area">
            <button id="hg-reset-placed-button" class="hg-button hg-button-reset" style="display: none;">
                ã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚‚ã©ã™
            </button>
            <button id="hg-home-button" class="hg-button hg-button-home">ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹</button>
        </div>
    </div>

    <audio id="hg-sound-correct" src="assets/sounds/seikai.mp3" preload="auto"></audio>
    <audio id="hg-sound-incorrect" src="assets/sounds/bubu.mp3" preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // â˜…â˜…â˜… ä¿®æ­£ç‚¹1: èªè¨¼ã‚­ãƒ¼ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®è¿½åŠ  â˜…â˜…â˜…
            const GAME_ID = 'hiragana_drag_match'; 
            const USER_STORAGE_KEY = 'user_accounts';
            const SESSION_STORAGE_KEY = 'current_user';
            const GUEST_NAME = 'ã‚²ã‚¹ãƒˆ';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—
            function getUsers() {
                const usersJson = localStorage.getItem(USER_STORAGE_KEY);
                return usersJson ? JSON.parse(usersJson) : {};
            }
            function saveUsers(users) {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
            }
            function getCurrentUser() {
                const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY);
                return (currentUser && currentUser !== GUEST_NAME) ? currentUser : null;
            }

            // æ—¥ä»˜å–å¾—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
            function getTodayDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // â˜…â˜…â˜… ä¿®æ­£ç‚¹2: ç²å¾—å±¥æ­´ãƒã‚§ãƒƒã‚¯ï¼†æ›´æ–°é–¢æ•° (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«ç›´æ¥ä¿å­˜) â˜…â˜…â˜…
            function checkAndRecordScore(level) {
                const currentUser = getCurrentUser();
                
                // 1. æœªãƒ­ã‚°ã‚¤ãƒ³/ã‚²ã‚¹ãƒˆã€ã¾ãŸã¯ãƒã‚¤ãƒ³ãƒˆåŠ ç®—æ©Ÿèƒ½ãŒãªã„å ´åˆã¯å³åº§ã«çµ‚äº†
                if (!window.addPoints || !currentUser) {
                    return false; 
                }

                // **æœ€æ–°ã®** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ­ãƒ¼ãƒ‰
                const users = getUsers(); 
                let user = users[currentUser];
                if (!user) return false;

                const todayStr = getTodayDateString();
                const levelKey = `${GAME_ID}_L${level}`;
                
                user.progress = user.progress || {};
                user.progress[levelKey] = user.progress[levelKey] || {};

                // 2. ä»Šæ—¥ã®æ—¥ä»˜ã§æ—¢ã«ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (user.progress[levelKey][todayStr] === true) {
                    return true; // æ—¢ã«ç²å¾—æ¸ˆã¿
                }

                // 3. æœªç²å¾—ã®å ´åˆ: 1ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã—ã€å±¥æ­´ã‚’è¨˜éŒ²
                
                // (1) ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã‚’ index.html ã®é–¢æ•°ã«ä¾é ¼ (ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°)
                window.addPoints(1, GAME_ID); 
                
                // (2) ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã«ä»Šæ—¥ã®ã‚¯ãƒªã‚¢å±¥æ­´ã‚’è¨˜éŒ²
                user.progress[levelKey][todayStr] = true;

                // (3) localStorage ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’ä¿å­˜ã—ç›´ã™
                users[currentUser] = user;
                saveUsers(users);
                
                // â˜…ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ãŸã®ã§ false ã‚’è¿”ã™
                return false; 
            }


            // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
            
            const ILLUSTRATION_PATH_PREFIX = 'assets/images/hiragana_words/';
            const ILLUSTRATION_PATH_SUFFIX = '.png'; 

            const gameLevels = [
                { level: 1, words: [ { hira: 'ã‚ã‚', file: 'ã‚ã‚' }, { hira: 'ã„ã¬', file: 'ã„ã¬' }, { hira: 'ã†ã—', file: 'ã†ã—' }, { hira: 'ãˆã³', file: 'ãˆã³' }, { hira: 'ãŠã«', file: 'ãŠã«' } ] },
                { level: 2, words: [ { hira: 'ã‹ã«', file: 'ã‹ã«' }, { hira: 'ã', file: 'ã' },{ hira: 'ãã‚‹ã¾', file: 'ãã‚‹ã¾' }, { hira: 'ã‘ã‚€ã—', file: 'ã‘ã‚€ã—' }, { hira: 'ã“ã¾', file: 'ã“ã¾' } ] },
                { level: 3, words: [ { hira: 'ã•ã‚‹', file: 'ã•ã‚‹' }, { hira: 'ã—ã‹', file: 'ã—ã‹' }, { hira: 'ã™ã—', file: 'ã™ã—' }, { hira: 'ã›ã¿', file: 'ã›ã¿' }, { hira: 'ãã°', file: 'ãã°' } ] },
                { level: 4, words: [ { hira: 'ãŸã“', file: 'ãŸã“' }, { hira: 'ã¯ã¡', file: 'ã¯ã¡' },{ hira: 'ã¤ã', file: 'ã¤ã' }, { hira: 'ã¦ã‚Œã³', file: 'ã¦ã‚Œã³' }, { hira: 'ã¨ã‚Š', file: 'ã¨ã‚Š' } ] },
                { level: 5, words: [ { hira: 'ãªã™', file: 'ãªã™' }, { hira: 'ã«ã»ã‚“', file: 'ã«ã»ã‚“' }, { hira: 'ã¬ã®', file: 'ã¬ã®' }, { hira: 'ã­ã“', file: 'ã­ã“' }, { hira: 'ã®ã‚Š', file: 'ã®ã‚Š' } ] },
                { level: 6, words: [ { hira: 'ã¯ã—', file: 'ã¯ã—' }, { hira: 'ã²ã¨ã§', file: 'ã²ã¨ã§' }, { hira: 'ãµã', file: 'ãµã' }, { hira: 'ã¸ã³', file: 'ã¸ã³' }, { hira: 'ã»ã—', file: 'ã»ã—' } ] },
                { level: 7, words: [ { hira: 'ã¾ãã‚‰', file: 'ã¾ãã‚‰' }, { hira: 'ã¿ã‹ã‚“', file: 'ã¿ã‹ã‚“' }, { hira: 'ã‚€ã', file: 'ã‚€ã' }, { hira: 'ã‚ã ã‹', file: 'ã‚ã ã‹' }, { hira: 'ã‚‚ã‚‚', file: 'ã‚‚ã‚‚' } ] },
                { level: 8, words: [ { hira: 'ã‚‰ãã ', file: 'ã‚‰ãã ' }, { hira: 'ã‚Šã‚“ã”', file: 'ã‚Šã‚“ã”' }, { hira: 'ã‚‹ã‚“ã°', file: 'ã‚‹ã‚“ã°' }, { hira: 'ã‚Œã‚‚ã‚“', file: 'ã‚Œã‚‚ã‚“' }, { hira: 'ã‚ã°', file: 'ã‚ã°' } ] },
                { level: 9, words: [ { hira: 'ã‚„ã', file: 'ã‚„ã' }, { hira: 'ã‚†ã‹ãŸ', file: 'ã‚†ã‹ãŸ' }, { hira: 'ã‚ˆã†ã‹ã„', file: 'ã‚ˆã†ã‹ã„' } ] },
                { level: 10, words: [ { hira: 'ã‚ã«', file: 'ã‚ã«' }, { hira: 'ã‹ã°ã‚“', file: 'ã‹ã°ã‚“' } ] }
            ];

            // --- 2. HTMLè¦ç´ ã®å–å¾— (IDã‚’ hg- ã«å¤‰æ›´) ---
            const mainTitleEl = document.getElementById('hg-main-title'); 
            const levelSelectionEl = document.getElementById('hg-level-selection');
            const levelTitleEl = document.getElementById('hg-level-title');
            const gameAreaEl = document.getElementById('hg-game-area');
            const illustPoolEl = document.getElementById('hg-illust-pool');
            const wordListEl = document.getElementById('hg-word-list');
            const feedbackEl = document.getElementById('hg-feedback');
            const resetPlacedButton = document.getElementById('hg-reset-placed-button');
            const homeButton = document.getElementById('hg-home-button'); 

            const soundCorrect = document.getElementById('hg-sound-correct');
            const soundIncorrect = document.getElementById('hg-sound-incorrect');


            let currentLevelData = null; 
            let currentLevelWords = [];

            // --- 3. ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ---
            function initGame() {
                gameLevels.forEach(levelData => {
                    const button = document.createElement('button');
                    button.textContent = `ãƒ¬ãƒ™ãƒ« ${levelData.level}`;
                    button.onclick = () => loadLevel(levelData);
                    levelSelectionEl.appendChild(button);
                });
                
                homeButton.onclick = () => {
                    window.location.href = 'index.html'; 
                };
            }
            
            function showLevelSelect() {
                gameAreaEl.style.display = 'none';
                levelTitleEl.textContent = '';
                feedbackEl.textContent = '';
                resetPlacedButton.style.display = 'none';
                
                levelSelectionEl.style.display = 'grid'; 
                mainTitleEl.style.display = 'block';

                homeButton.onclick = () => {
                    window.location.href = 'index.html';
                };
            }

            // --- 4. ãƒ¬ãƒ™ãƒ«èª­ã¿è¾¼ã¿ ---
            function loadLevel(levelData) {
                levelSelectionEl.style.display = 'none';
                mainTitleEl.style.display = 'none';
                
                currentLevelData = levelData; 
                currentLevelWords = levelData.words;
                
                const currentUser = getCurrentUser();
                let alreadyScored = false;
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ä»Šæ—¥ã®ã‚¯ãƒªã‚¢çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (currentUser) {
                    const users = getUsers();
                    const user = users[currentUser];
                    const levelKey = `${GAME_ID}_L${levelData.level}`;
                    const todayStr = getTodayDateString();
                    
                    if (user && user.progress && user.progress[levelKey] && user.progress[levelKey][todayStr] === true) {
                        alreadyScored = true;
                    }
                }
                
                let pointStatus = '';
                if (alreadyScored) {
                    pointStatus = ' (ä»Šæ—¥ã¯ãƒã‚¤ãƒ³ãƒˆç²å¾—æ¸ˆã¿)';
                } else if (!currentUser) {
                    pointStatus = ' (æœªãƒ­ã‚°ã‚¤ãƒ³/ã‚²ã‚¹ãƒˆ: ãƒã‚¤ãƒ³ãƒˆç²å¾—ä¸å¯)';
                }
                
                levelTitleEl.textContent = `ãƒ¬ãƒ™ãƒ« ${levelData.level} ã‚¹ã‚¿ãƒ¼ãƒˆï¼${pointStatus}`;
                
                feedbackEl.textContent = '';
                feedbackEl.classList.remove('success');
                gameAreaEl.style.display = 'flex';
                
                resetPlacedButton.style.display = 'none';

                homeButton.onclick = () => showLevelSelect();

                illustPoolEl.innerHTML = '';
                wordListEl.innerHTML = '';

                const shuffledWords = shuffleArray([...currentLevelWords]);
                const shuffledIllusts = shuffleArray([...currentLevelWords]);

                // 4-1. å˜èªãƒªã‚¹ãƒˆï¼ˆãƒ‰ãƒ­ãƒƒãƒ—å…ˆï¼‰ã‚’ç”Ÿæˆ
                shuffledWords.forEach(wordData => {
                    const row = document.createElement('div');
                    row.className = 'hg-word-row';
                    const dropTarget = document.createElement('div');
                    dropTarget.className = 'hg-drop-target';
                    dropTarget.dataset.word = wordData.hira; 
                    dropTarget.id = `hg-target-${wordData.hira}`; 
                    
                    const label = document.createElement('span');
                    label.className = 'hg-word-label';
                    label.textContent = wordData.hira;
                    row.appendChild(dropTarget);
                    row.appendChild(label);
                    wordListEl.appendChild(row);
                });

                // 4-2. ã‚¤ãƒ©ã‚¹ãƒˆãƒªã‚¹ãƒˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¤ãƒ†ãƒ ï¼‰ã‚’ç”Ÿæˆ
                shuffledIllusts.forEach(wordData => {
                    const item = document.createElement('div');
                    item.className = 'hg-drag-item';
                    
                    item.draggable = true; 
                    
                    item.dataset.word = wordData.hira;
                    item.id = `hg-item-${wordData.hira}`; 
                    item.dataset.initialParentId = 'hg-illust-pool';
                    
                    const img = document.createElement('img');
                    img.src = `${ILLUSTRATION_PATH_PREFIX}${wordData.file}${ILLUSTRATION_PATH_SUFFIX}`;
                    img.alt = wordData.hira;
                    img.draggable = false; 
                    item.appendChild(img);
                    illustPoolEl.appendChild(item);
                });

                // 4-3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                addDragDropListeners();
            }
            
            // â˜…â˜…â˜… ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ—ãƒ¼ãƒ«ã«æˆ»ã™é–¢æ•° â˜…â˜…â˜…
            function returnItemToPool(event) {
                const itemToReturn = event.currentTarget; 
                const parentTarget = itemToReturn.parentElement;

                // 1. ãƒ—ãƒ¼ãƒ«ã«æˆ»ã™
                illustPoolEl.appendChild(itemToReturn);
                
                // 2. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
                itemToReturn.removeEventListener('click', returnItemToPool);
                
                // 3. è¦ªã‚¹ãƒ­ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (parentTarget && parentTarget.classList.contains('hg-drop-target')) {
                    parentTarget.classList.remove('correct');
                }

                // 4. åˆ¤å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ›´æ–°
                feedbackEl.textContent = 'ã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚‚ã©ã—ã¾ã—ãŸã€‚';
                feedbackEl.classList.remove('success');
            }


            // --- 5. ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š (â˜…PC/ã‚¿ãƒƒãƒä¸¡å¯¾å¿œç‰ˆã«ä¿®æ­£) ---

            // --- ã‚¿ãƒƒãƒæ“ä½œç”¨ã®è£œåŠ©é–¢æ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (å¤‰æ›´ãªã—) ---
            let ghostItem = null;      
            let currentDragItem = null; 
            let lastTouchTarget = null; 

            function updateGhostPosition(touch) {
                if (!ghostItem) return;
                ghostItem.style.left = (touch.clientX - ghostItem.offsetWidth / 2) + 'px';
                ghostItem.style.top = (touch.clientY - ghostItem.offsetHeight / 2) + 'px';
            }

            function addDragDropListeners() {
                const dragItems = document.querySelectorAll('.hg-drag-item');
                const dropTargets = document.querySelectorAll('.hg-drop-target');
                
                // --- 1. PC/ãƒã‚¦ã‚¹ ã‚¤ãƒ™ãƒ³ãƒˆ (æ¨™æº–ã® D&D API ã‚’ä½¿ç”¨) ---
                const transparentImage = new Image();
                transparentImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
                
                dragItems.forEach(item => {
                    // PCæ“ä½œã®æ®‹åƒé˜²æ­¢
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.id);
                        // â˜…è¿½åŠ â˜… ã‚´ãƒ¼ã‚¹ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é€æ˜ãªç”»åƒã«ç½®ãæ›ãˆã‚‹
                        if (e.dataTransfer && e.dataTransfer.setDragImage) {
                            e.dataTransfer.setDragImage(transparentImage, 0, 0);
                        }
                        setTimeout(() => item.style.opacity = '0.5', 0);
                    });
                    item.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '1';
                    });

                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å†è¨­å®š (ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ—ãƒ¼ãƒ«ã«æˆ»ã™)
                    item.removeEventListener('click', returnItemToPool);
                    // æ—¢ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
                    if (item.parentElement && item.parentElement.classList.contains('hg-drop-target')) {
                         item.addEventListener('click', returnItemToPool);
                         item.draggable = false;
                    } else {
                         // ãƒ—ãƒ¼ãƒ«å†…ã«ã‚ã‚‹ã‚‚ã®ã ã‘ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
                         item.draggable = true; 
                    }
                });

                dropTargets.forEach(target => {
                    target.addEventListener('dragover', (e) => {
                        if (target.querySelector('.hg-drag-item')) return;
                        e.preventDefault();
                        target.classList.add('drag-over');
                    });
                    target.addEventListener('dragleave', () => {
                        target.classList.remove('drag-over');
                    });
                    target.addEventListener('drop', (e) => {
                        e.preventDefault();
                        target.classList.remove('drag-over');
                        if (target.querySelector('.hg-drag-item')) return;
                        
                        const dragItemId = e.dataTransfer.getData('text/plain');
                        const dragItem = document.getElementById(dragItemId);

                        if (dragItem) {
                            target.innerHTML = ''; 
                            target.appendChild(dragItem);
                            dragItem.draggable = false; 
                            dragItem.addEventListener('click', returnItemToPool); // ã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã‚‹æ©Ÿèƒ½ã‚’å†è¨­å®š
                            checkFinalAnswers();
                        }
                    });
                });

                // --- 2. ã‚¿ãƒƒãƒ ã‚¤ãƒ™ãƒ³ãƒˆ (â˜…ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã¨åŒã˜ã€‚PCãƒã‚¦ã‚¹ã¨ä½µç”¨å¯èƒ½) ---

                // (A) ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ‡ã§æŠ¼ã—å§‹ã‚ãŸæ™‚ (touchstart)
                dragItems.forEach(item => {
                    item.addEventListener('touchstart', (e) => {
                        // æ—¢ã«ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã€ã¾ãŸã¯PCã§ãƒ‰ãƒ©ãƒƒã‚°ãŒå§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ç„¡è¦–
                        if (currentDragItem || item.draggable) return; 

                        currentDragItem = item; 
                        ghostItem = item.cloneNode(true);
                        ghostItem.classList.add('hg-touch-ghost'); 
                        document.body.appendChild(ghostItem);

                        item.style.opacity = '0.4';
                        updateGhostPosition(e.touches[0]);

                    }, { passive: true });
                });

                // (B) æŒ‡ã‚’å‹•ã‹ã—ãŸæ™‚ (touchmove)
                document.addEventListener('touchmove', (e) => {
                    if (!currentDragItem || !ghostItem) return;

                    e.preventDefault(); 
                    updateGhostPosition(e.touches[0]);

                    const touch = e.touches[0];
                    ghostItem.style.display = 'none'; 
                    const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                    ghostItem.style.display = ''; 

                    let currentTouchTarget = null;
                    if (elementUnder && (elementUnder.classList.contains('hg-drop-target') || elementUnder.parentElement?.classList.contains('hg-drop-target'))) {
                         currentTouchTarget = elementUnder.classList.contains('hg-drop-target') ? elementUnder : elementUnder.parentElement;
                    }

                    if (lastTouchTarget && lastTouchTarget !== currentTouchTarget) {
                        lastTouchTarget.classList.remove('drag-over');
                    }
                    if (currentTouchTarget && currentTouchTarget.classList.contains('hg-drop-target') && !currentTouchTarget.querySelector('.hg-drag-item')) {
                        currentTouchTarget.classList.add('drag-over');
                        lastTouchTarget = currentTouchTarget;
                    } else {
                        if (lastTouchTarget) lastTouchTarget.classList.remove('drag-over');
                        lastTouchTarget = null;
                    }

                }, { passive: false }); 

                // (C) æŒ‡ã‚’é›¢ã—ãŸæ™‚ (touchend)
                document.addEventListener('touchend', (e) => {
                    if (!currentDragItem || !ghostItem) return;

                    let dropTarget = lastTouchTarget; 
                    
                    if (dropTarget && !dropTarget.querySelector('.hg-drag-item')) {
                        // --- ãƒ‰ãƒ­ãƒƒãƒ—æˆåŠŸ ---
                        dropTarget.classList.remove('drag-over');
                        dropTarget.innerHTML = ''; 
                        dropTarget.appendChild(currentDragItem); 
                        
                        currentDragItem.style.opacity = '1'; 
                        currentDragItem.draggable = false; // é…ç½®å¾Œã¯PCã§ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã«ã™ã‚‹
                        currentDragItem.addEventListener('click', returnItemToPool); 
                        
                        checkFinalAnswers();
                        
                    } else {
                        // --- ãƒ‰ãƒ­ãƒƒãƒ—å¤±æ•— (å…ƒã®å ´æ‰€ã«æˆ»ã™) ---
                        currentDragItem.style.opacity = '1'; 
                    }
                    
                    // å¾Œç‰‡ä»˜ã‘
                    document.body.removeChild(ghostItem);
                    ghostItem = null;
                    currentDragItem = null;
                    lastTouchTarget = null;
                });
            }
            // â–²â–²â–² addDragDropListeners é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–²


            // --- 7. æœ€çµ‚åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
            function checkFinalAnswers() {
                const dropTargets = document.querySelectorAll('.hg-drop-target');
                const totalTargets = currentLevelWords.length;
                let filledCount = 0;
                let allCorrect = true;

                // 1. ã™ã¹ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆãŒåŸ‹ã¾ã£ã¦ã„ã‚‹ã‹ç¢ºèª
                dropTargets.forEach(target => {
                    if (target.querySelector('.hg-drag-item')) {
                        filledCount++;
                    }
                });

                // 2. ã‚¹ãƒ­ãƒƒãƒˆãŒã™ã¹ã¦åŸ‹ã¾ã£ã¦ã„ãªã„å ´åˆã¯çµ‚äº†
                if (filledCount < totalTargets) {
                    feedbackEl.textContent = `ã‚ã¨ ${totalTargets - filledCount} ã“ã€‚`;
                    feedbackEl.classList.remove('success');
                    return; 
                }

                // 3. ã‚¹ãƒ­ãƒƒãƒˆãŒã™ã¹ã¦åŸ‹ã¾ã£ãŸå ´åˆ (filledCount === totalTargets)
                dropTargets.forEach(target => {
                    const placedItem = target.querySelector('.hg-drag-item');
                    const targetWord = target.dataset.word;
                    const placedWord = placedItem.dataset.word;
                    
                    if (targetWord !== placedWord) {
                        allCorrect = false; 
                    }
                });

                // 4. æœ€çµ‚åˆ¤å®šçµæœ
                if (allCorrect) {
                    // â˜… å…¨å•æ­£è§£
                    soundCorrect.currentTime = 0;
                    soundCorrect.play();
                    
                    dropTargets.forEach(target => {
                         target.classList.add('correct');
                         const placedItem = target.querySelector('.hg-drag-item');
                         if (placedItem) {
                             placedItem.removeEventListener('click', returnItemToPool);
                             placedItem.style.cursor = 'not-allowed'; 
                         }
                    });
                    
                    // â˜…â˜…â˜… ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ â˜…â˜…â˜…
                    let message = 'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãœã‚“ã¶ã›ã„ã‹ã„ï¼';
                    const level = currentLevelData.level;

                    // é€²æ—è¨˜éŒ²ã¨ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã‚’è©¦è¡Œ
                    const alreadyScored = checkAndRecordScore(level);

                    if (window.addPoints && !alreadyScored) {
                        // 1ãƒã‚¤ãƒ³ãƒˆåŠ ç®—ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ›´æ–°
                        message += ' (+1 ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼)';
                    } else if (alreadyScored) {
                        message += ' (ä»Šæ—¥ã¯ãƒã‚¤ãƒ³ãƒˆç²å¾—æ¸ˆã¿)';
                    }
                    
                    feedbackEl.textContent = message;
                    feedbackEl.classList.add('success');
                    
                    
                    levelTitleEl.textContent = 'ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼';
                    resetPlacedButton.style.display = 'none'; 
                    
                    // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸
                    const currentLevelIndex = gameLevels.findIndex(lvl => lvl.level === currentLevelData.level);
                    const nextLevelIndex = currentLevelIndex + 1;
                    
                    if (nextLevelIndex < gameLevels.length) {
                        const nextLevelData = gameLevels[nextLevelIndex];
                        // ãƒã‚¤ãƒ³ãƒˆç²å¾—çŠ¶æ³ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã€å†ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒã‚§ãƒƒã‚¯
                        levelTitleEl.textContent = `ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ ${nextLevelData.level} ã«ã™ã™ã‚€ã‚ˆï¼`;
                        setTimeout(() => {
                            loadLevel(nextLevelData);
                        }, 2000); 
                    } else {
                        levelTitleEl.textContent = 'ãœã‚“ã¶ã‚¯ãƒªã‚¢ï¼';
                        feedbackEl.textContent = message; // æœ€çµ‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ãƒã‚¤ãƒ³ãƒˆçŠ¶æ³ã‚’å«ã‚ã‚‹
                    }
                    
                } else {
                    // â˜… 1ã¤ã§ã‚‚é–“é•ã„ãŒã‚ã‚‹
                    soundIncorrect.currentTime = 0;
                    soundIncorrect.play();
                    
                    feedbackEl.textContent = 'ã¡ãŒã†ã¨ã“ã‚ãŒã‚ã‚‹ã‚ˆã€‚ã¾ã¡ãŒã£ã¦ã„ã‚‹ã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚‚ã©ã—ã¦ã­ã€‚';
                    feedbackEl.classList.remove('success');
                }
            }

            // --- 8. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- 9. ã‚²ãƒ¼ãƒ é–‹å§‹ ---
            initGame();

        });
    </script>
</body>
</html>
