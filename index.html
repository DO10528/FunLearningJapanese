<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="main_title">Fun Learning Japanese</title>
<meta name="description" content="Learn Hiragana, Katakana, Kanji, and grammar with fun, free Japanese learning games! Perfect for beginners.">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#5c7aff">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FunLearnJP">
<link rel="apple-touch-icon" href="images/icons/icon-192x192.png"> 
<link rel="stylesheet" href="css/style.css">
<style>
/* ---------------------------------------------------- */
/* æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
/* ---------------------------------------------------- */
.menu-group {
    background-color: #f0f8ff; /* è–„ã„é’è‰²ã®èƒŒæ™¯ */
    border: 2px solid #5c7aff; /* kiso.html ã¨è‰²ã‚’åˆã‚ã›ã‚‹ */
    border-radius: 15px;
    padding: 15px 20px;
    margin-bottom: 25px; /* 2ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—é–“ã®ä½™ç™½ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
/* ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¿ã‚¤ãƒˆãƒ« (h2) */
.menu-group h2 {
    text-align: center;
    color: #5c7aff; /* é’è‰² */
    font-size: 1.5em;
    margin-bottom: 20px;
}

/* ---------------------------------------------------- */
/* æ–°è¦è¿½åŠ : èªè¨¼/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ ã‚¹ã‚¿ã‚¤ãƒ« */
/* ---------------------------------------------------- */
#auth-status-bar {
    width: 100%;
    max-width: 800px;
    margin: 10px auto 20px;
    padding: 10px 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}
#user-info {
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
    padding: 5px 0;
}
#auth-buttons button {
    margin-left: 10px;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.2s;
}
.btn-login { background-color: #5cb85c; color: white; }
.btn-signup { background-color: #007bff; color: white; }
.btn-guest { background-color: #f0ad4e; color: white; }
.btn-logout { background-color: #d9534f; color: white; }

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ --- */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000; /* è¨€èªã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼ã‚ˆã‚Šå‰é¢ã« */
}
.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h2 { margin-top: 0; color: #005bb5; }
.modal-content input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
}
.modal-content button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
}
.modal-content .btn-submit { background-color: #007bff; color: white; }
.modal-content .btn-close { background-color: #ccc; color: #333; margin-top: 10px; }
.form-message {
    color: #d9534f;
    margin-bottom: 10px;
    font-weight: bold;
}

/* --- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡ --- */
#main-menu.locked {
    filter: blur(2px);
    pointer-events: none;
    user-select: none;
}
#initial-message {
    text-align: center;
    padding: 50px 20px;
    font-size: 1.1em;
    color: #d9534f;
    font-weight: bold;
    border: 2px dashed #d9534f50;
    border-radius: 10px;
    margin-top: 20px;
}

@media (max-width: 600px) {
    #auth-status-bar {
        flex-direction: column;
        gap: 10px;
    }
    #auth-buttons {
        width: 100%;
        display: flex;
        justify-content: space-between;
    }
    #auth-buttons button {
        margin: 0 2px;
        flex-grow: 1;
    }
}
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-0BX3DD42C1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0BX3DD42C1');
</script>
</head>
<body>
    
<div id="language-switcher">
    <button onclick="setLanguage('ja')" id="lang-ja" class="lang-button active">ã«ã»ã‚“ã”</button>
    <button onclick="setLanguage('en')" id="lang-en" class="lang-button">English</button>
</div>

<div id="auth-status-bar">
    <span id="user-info">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</span>
    <div id="auth-buttons">
        <button id="login-btn" class="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="signup-btn" class="btn-signup">æ–°è¦ç™»éŒ²</button>
        <button id="guest-btn" class="btn-guest">ã‚²ã‚¹ãƒˆã§ãƒ—ãƒ¬ã‚¤</button>
        <button id="logout-btn" class="btn-logout" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<h1 data-i18n="main_title">Fun Learning Japanese</h1>

<div id="initial-message" style="display: none;">
    <p>ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹ã«ã¯ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«**ãƒ­ã‚°ã‚¤ãƒ³**ã™ã‚‹ã‹ã€**æ–°è¦ç™»éŒ²**ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
    <p>é€²æ—ã‚’ä¿å­˜ã—ãªã„å ´åˆã¯ã€**ã‚²ã‚¹ãƒˆ**ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
</div>

<div id="main-menu" class="container">
    <div class="menu-group">
        <h2 data-i18n="group_kiso">ãããƒ»ãŸã‚“ã”ãƒªã‚¹ãƒˆ</h2>
        <div class="menu-buttons-grid">
            <a href="kiso.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kiso">
                ğŸ“<br>ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠåŸºç¤
            </a>
            <a href="hiragana_video_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_video">
                ğŸ¥<br>ã²ã‚‰ãŒãªç·´ç¿’
            </a>
            <a href="keiyoshi_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_keiyoshi_list">
                ğŸ“š<br>å½¢å®¹è©ãƒªã‚¹ãƒˆ
            </a>
            <a href="kanji_list.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kanji_list">
                ğŸ“–<br>æ¼¢å­—ãƒªã‚¹ãƒˆ (å°1)
            </a>
        </div>
    </div>

    <div class="menu-group">
        <h2 data-i18n="group_game">ãªã«ã‚’ã—ã¦ã‚ãã¶?</h2>
        <div class="menu-buttons-grid">
            <a href="hiragana_drag_match.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_drag">
                ğŸ§©<br>ã²ã‚‰ãŒãªå˜èªã‚ã‚ã›
            </a>
            <a href="hiragana.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_game">
                ğŸ®<br>ã²ã‚‰ãŒãªå˜èªã‚²ãƒ¼ãƒ 
            </a>
            <a href="hiragana2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_hiragana_game2">
                â­<br>ã²ã‚‰ãŒãªã‚²ãƒ¼ãƒ 2 (ä¸¦ã³æ›¿ãˆ)
            </a>
            <a href="katakana_drag_match.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_katakana_drag">
                ğŸ§©<br>ã‚«ã‚¿ã‚«ãƒŠå˜èªã‚ã‚ã›
            </a>
            <a href="shiritori.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_shiritori">
                ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ 
            </a>
            <a href="shiritori2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_shiritori2">
                ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ 2
            </a>
            <a href="clock.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_clock">
                ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ 
            </a>
            <a href="clock2.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_clock2">
                ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ 2
            </a>
            <a href="keiyoshi.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_keiyoshi_quiz">
                ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º
            </a>
            <a href="adjective_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_adjective_quiz">
                ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º2
            </a>
            <a href="kanji_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_kanji_quiz">
                ğŸˆ³<br>æ¼¢å­—ã‚¯ã‚¤ã‚º (å°1)
            </a>
            <a href="aisatsu_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_aisatsu_quiz">
                ğŸ—£ï¸<br>æŒ¨æ‹¶ã‚¯ã‚¤ã‚º
            </a>
            <a href="verb.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_verb_game">
                ğŸ—£ï¸<br>å‹•è©ã‚²ãƒ¼ãƒ 
            </a>
            <a href="sentence_puzzle.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_sentence_puzzle">
                ğŸ—£ï¸<br>æ–‡æ³•ä¸¦ã³æ›¿ãˆã‚²ãƒ¼ãƒ 
            </a>
            <a href="meteor_quiz.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_meteor_quiz">
                ğŸ—£ï¸<br>éš•çŸ³ã‚¯ã‚¤ã‚º
            </a>
            <a href="treasure_Hunt.html" class="menu-card-button menu-card-reset" data-i18n-html="btn_treasure_hunt">
                ğŸ—£ï¸<br>ãŸã‹ã‚‰ã•ãŒã—ã‚²ãƒ¼ãƒ 
            </a>
        </div>
    </div>
</div>
<div id="game-area" class="container" style="display:none;">
    <p>ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
</div>

<div id="auth-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div id="login-view">
            <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div id="login-message" class="form-message"></div>
            <input type="text" id="login-gamename" placeholder="ã‚²ãƒ¼ãƒ å" required>
            <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
            <button id="login-submit-btn" class="btn-submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        
        <div id="signup-view" style="display:none;">
            <h2>æ–°è¦ç™»éŒ²</h2>
            <div id="signup-message" class="form-message"></div>
            <p style="font-size: 0.9em; color: #555;">â€»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã®é€²æ—ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <input type="text" id="signup-gamename" placeholder="æ–°ã—ã„ã‚²ãƒ¼ãƒ å (å¿…é ˆ)" required>
            <input type="password" id="signup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å¿…é ˆ)" required>
            <button id="signup-submit-btn" class="btn-submit">ç™»éŒ²ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------
    // â˜…â˜…â˜… ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯å‰Šé™¤ã—ãªã„ã§ãã ã•ã„ â˜…â˜…â˜…
    // ----------------------------------------------------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registered: ', registration);
          })
          .catch(registrationError => {
            console.log('ServiceWorker registration failed: ', registrationError);
          });
      });
    }

    // ----------------------------------------------------
    // â˜…â˜…â˜… æ—¢å­˜ã®è¨€èªãƒ‡ãƒ¼ã‚¿ã¨åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    // ----------------------------------------------------

    const translations = {
        'ja': {
            'main_title': 'Fun Learning Japanese',
            'group_kiso': 'ãããƒ»ãŸã‚“ã”ãƒªã‚¹ãƒˆ',
            'group_game': 'ãªã«ã‚’ã—ã¦ã‚ãã¶?',
            // (ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒœã‚¿ãƒ³ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒç¶šã...)
            'btn_kiso': 'ğŸ“<br>ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠåŸºç¤',
            'btn_hiragana_video': 'ğŸ¥<br>ã²ã‚‰ãŒãªç·´ç¿’',
            'btn_keiyoshi_list': 'ğŸ“š<br>å½¢å®¹è©ãƒªã‚¹ãƒˆ',
            'btn_kanji_list': 'ğŸ“–<br>æ¼¢å­—ãƒªã‚¹ãƒˆ (å°1)',
            'btn_hiragana_drag': 'ğŸ§©<br>ã²ã‚‰ãŒãªå˜èªã‚ã‚ã›',
            'btn_hiragana_game': 'ğŸ®<br>ã²ã‚‰ãŒãªå˜èªã‚²ãƒ¼ãƒ ',
            'btn_hiragana_game2': 'â­<br>ã²ã‚‰ãŒãªã‚²ãƒ¼ãƒ 2 (ä¸¦ã³æ›¿ãˆ)',
            'btn_katakana_drag': 'ğŸ§©<br>ã‚«ã‚¿ã‚«ãƒŠå˜èªã‚ã‚ã›',
            'btn_shiritori': 'ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ ',
            'btn_shiritori2': 'ğŸ—£ï¸<br>ã—ã‚Šã¨ã‚Šã‚²ãƒ¼ãƒ 2',
            'btn_clock': 'ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ ',
            'btn_clock2': 'ğŸ—£ï¸<br>ã¨ã‘ã„ã‚²ãƒ¼ãƒ 2',
            'btn_keiyoshi_quiz': 'ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º',
            'btn_adjective_quiz': 'ğŸ¤”<br>å½¢å®¹è©ã‚¯ã‚¤ã‚º2',
            'btn_kanji_quiz': 'ğŸˆ³<br>æ¼¢å­—ã‚¯ã‚¤ã‚º (å°1)',
            'btn_aisatsu_quiz': 'ğŸ—£ï¸<br>æŒ¨æ‹¶ã‚¯ã‚¤ã‚º',
            'btn_verb_game': 'ğŸ—£ï¸<br>å‹•è©ã‚²ãƒ¼ãƒ ',
            'btn_sentence_puzzle': 'ğŸ—£ï¸<br>æ–‡æ³•ä¸¦ã³æ›¿ãˆã‚²ãƒ¼ãƒ ',
            'btn_meteor_quiz': 'ğŸ—£ï¸<br>éš•çŸ³ã‚¯ã‚¤ã‚º',
            'btn_treasure_hunt': 'ğŸ—£ï¸<br>ãŸã‹ã‚‰ã•ãŒã—ã‚²ãƒ¼ãƒ ',
        },
        'en': {
            'main_title': 'Fun Learning Japanese',
            'group_kiso': 'Basics & Vocabulary Lists',
            'group_game': 'What would you like to play?',
            // (ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒœã‚¿ãƒ³ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒç¶šã...)
            'btn_kiso': 'ğŸ“<br>Hiragana/Katakana Basics',
            'btn_hiragana_video': 'ğŸ¥<br>Hiragana Practice',
            'btn_keiyoshi_list': 'ğŸ“š<br>Adjective List',
            'btn_kanji_list': 'ğŸ“–<br>Kanji List (Gr.1)',
            'btn_hiragana_drag': 'ğŸ§©<br>Hiragana Word Match',
            'btn_hiragana_game': 'ğŸ®<br>Hiragana Word Game',
            'btn_hiragana_game2': 'â­<br>Hiragana Game 2 (Order)',
            'btn_katakana_drag': 'ğŸ§©<br>Katakana Word Match',
            'btn_shiritori': 'ğŸ—£ï¸<br>Shiritori Game',
            'btn_shiritori2': 'ğŸ—£ï¸<br>Shiritori Game 2',
            'btn_clock': 'ğŸ—£ï¸<br>Clock Game',
            'btn_clock2': 'ğŸ—£ï¸<br>Clock Game 2',
            'btn_keiyoshi_quiz': 'ğŸ¤”<br>Adjective Quiz',
            'btn_adjective_quiz': 'ğŸ¤”<br>Adjective Quiz 2',
            'btn_kanji_quiz': 'ğŸˆ³<br>Kanji Quiz (Gr.1)',
            'btn_aisatsu_quiz': 'ğŸ—£ï¸<br>Greetings Quiz',
            'btn_verb_game': 'ğŸ—£ï¸<br>Verb Game',
            'btn_sentence_puzzle': 'ğŸ—£ï¸<br>Grammar Puzzle',
            'btn_meteor_quiz': 'ğŸ—£ï¸<br>Meteor Quiz',
            'btn_treasure_hunt': 'ğŸ—£ï¸<br>Treasure Hunt',
        }
    };

    // UIã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•° (æ—¢å­˜ã®è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯)
    function updateLanguageUI(lang) {
        const langData = translations[lang];

        // 1. data-i18nå±æ€§ (textContentã‚’æ›¸ãæ›ãˆã‚‹è¦ç´ : h1, h2ãªã©)
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (langData[key]) {
                el.textContent = langData[key];
            }
        });

        // 2. data-i18n-htmlå±æ€§ (innerHTMLã‚’æ›¸ãæ›ãˆã‚‹è¦ç´ : ãƒœã‚¿ãƒ³ãªã©)
        document.querySelectorAll('[data-i18n-html]').forEach(el => {
            const key = el.getAttribute('data-i18n-html');
            if (langData[key]) {
                el.innerHTML = langData[key];
            }
        });

        // 3. ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.getElementById('lang-ja')?.classList.remove('active');
        document.getElementById('lang-en')?.classList.remove('active');
        document.getElementById(`lang-${lang}`)?.classList.add('active');
    }

    // è¨€èªã‚’ä¿å­˜ã—ã€UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (onclickã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹)
    window.setLanguage = function(lang) {
        if (!translations[lang]) return;
        
        localStorage.setItem('preferredLang', lang);
        updateLanguageUI(lang);
    };


    // ----------------------------------------------------
    // â˜…â˜…â˜… æ–°è¦è¿½åŠ : èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ (localStorageã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ) â˜…â˜…â˜…
    // ----------------------------------------------------

    const USER_STORAGE_KEY = 'user_accounts';
    const SESSION_STORAGE_KEY = 'current_user';
    const GUEST_NAME = 'ã‚²ã‚¹ãƒˆ';

    // --- èªè¨¼DOMè¦ç´ ã®å–å¾— ---
    const userInfoEl = document.getElementById('user-info');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const guestBtn = document.getElementById('guest-btn');
    const logoutBtn = document.getElementById('logout-btn');
    
    const initialMessageEl = document.getElementById('initial-message');
    const mainMenuEl = document.getElementById('main-menu');
    
    const modalOverlay = document.getElementById('auth-modal');
    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    
    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function getUsers() {
        const usersJson = localStorage.getItem(USER_STORAGE_KEY);
        return usersJson ? JSON.parse(usersJson) : {};
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveUsers(users) {
        localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
    }

    // --- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† ---

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function setSession(gameName) {
        sessionStorage.setItem(SESSION_STORAGE_KEY, gameName);
        updateAuthenticationUI();
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    function logout() {
        sessionStorage.removeItem(SESSION_STORAGE_KEY);
        updateAuthenticationUI();
    }

    // ã‚²ã‚¹ãƒˆã¨ã—ã¦ãƒ—ãƒ¬ã‚¤
    function playAsGuest() {
        setSession(GUEST_NAME);
    }

    // --- UIã®æ›´æ–° (ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹) ---
    function updateAuthenticationUI() {
        const currentUser = sessionStorage.getItem(SESSION_STORAGE_KEY);
        const isLoggedIn = !!currentUser;
        const isGuest = currentUser === GUEST_NAME;

        // èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        if (isLoggedIn) {
            userInfoEl.textContent = isGuest ? 'ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰' : `${currentUser} ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
            loginBtn.style.display = 'none';
            signupBtn.style.display = 'none';
            guestBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
            initialMessageEl.style.display = 'none';
            mainMenuEl.classList.remove('locked');

        } else {
            userInfoEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“';
            loginBtn.style.display = 'inline-block';
            signupBtn.style.display = 'inline-block';
            guestBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®éè¡¨ç¤º/ãƒ­ãƒƒã‚¯
            initialMessageEl.style.display = 'block';
            mainMenuEl.classList.add('locked');
        }
    }

    // --- èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

    // 5. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
    document.getElementById('signup-submit-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const gamenameInput = document.getElementById('signup-gamename');
        const passwordInput = document.getElementById('signup-password');
        const messageEl = document.getElementById('signup-message');

        const gamename = gamenameInput.value.trim();
        const password = passwordInput.value;

        if (!gamename || !password) {
            messageEl.textContent = 'ã‚²ãƒ¼ãƒ åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™ã€‚';
            return;
        }
        if (gamename === GUEST_NAME) {
            messageEl.textContent = 'ãã®ã‚²ãƒ¼ãƒ åã¯äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚';
            return;
        }

        const users = getUsers();
        if (users[gamename]) {
            messageEl.textContent = 'ã“ã®ã‚²ãƒ¼ãƒ åã¯ã™ã§ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
            return;
        }

        // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²
        users[gamename] = { password: password, name: gamename };
        saveUsers(users);

        // ç™»éŒ²å¾Œã€è‡ªå‹•ã§ãƒ­ã‚°ã‚¤ãƒ³
        setSession(gamename);
        modalOverlay.style.display = 'none';
        messageEl.textContent = '';
        gamenameInput.value = '';
        passwordInput.value = '';
    });

    // 6. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    document.getElementById('login-submit-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const gamenameInput = document.getElementById('login-gamename');
        const passwordInput = document.getElementById('login-password');
        const messageEl = document.getElementById('login-message');

        const gamename = gamenameInput.value.trim();
        const password = passwordInput.value;

        const users = getUsers();
        const user = users[gamename];

        if (user && user.password === password) {
            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
            setSession(gamename);
            modalOverlay.style.display = 'none';
            messageEl.textContent = '';
            gamenameInput.value = '';
            passwordInput.value = '';
        } else {
            // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
            messageEl.textContent = 'ã‚²ãƒ¼ãƒ åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
        }
    });

    // 7. ãƒœã‚¿ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®š
    
    loginBtn.addEventListener('click', () => {
        loginView.style.display = 'block';
        signupView.style.display = 'none';
        modalOverlay.style.display = 'flex';
        document.getElementById('login-message').textContent = '';
        document.getElementById('signup-message').textContent = '';
    });

    signupBtn.addEventListener('click', () => {
        loginView.style.display = 'none';
        signupView.style.display = 'block';
        modalOverlay.style.display = 'flex';
        document.getElementById('login-message').textContent = '';
        document.getElementById('signup-message').textContent = '';
    });

    guestBtn.addEventListener('click', playAsGuest);
    logoutBtn.addEventListener('click', logout);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    modalOverlay.querySelectorAll('.btn-close').forEach(button => {
        button.addEventListener('click', () => {
            modalOverlay.style.display = 'none';
            document.getElementById('login-message').textContent = '';
            document.getElementById('signup-message').textContent = '';
        });
    });

    // --- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        // æ—¢å­˜ã®è¨€èªè¨­å®šã®åˆæœŸåŒ–
        const savedLang = localStorage.getItem('preferredLang') || 'ja';
        setLanguage(savedLang); 
        
        // æ–°è¦è¿½åŠ : èªè¨¼çŠ¶æ…‹ã®åˆæœŸåŒ–
        updateAuthenticationUI();
    });
</script>

</body>
</html>