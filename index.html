<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title data-i18n="main_title">Fun Learning Japanese - Next Gen</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="assets/images/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/icon.png">
<link rel="icon" sizes="192x192" href="assets/images/icon.png">
<link rel="icon" sizes="512x512" href="assets/images/icon.png">
<link rel="manifest" href="manifest.json">

<style>
/* --- åŸºæœ¬è¨­å®š --- */
:root {
  --primary: #5c7aff;
  --accent: #ffcc5c;
  --bg-color: #f4f7fc;
  --text-color: #333;
  --line-green: #06c755;
}

*, *::before, *::after { box-sizing: border-box; }

body {
  font-family: 'Zen Maru Gothic', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0; padding: 0; padding-bottom: 80px;
  overflow-x: hidden; 
  min-height: 100vh;
  width: 100%;
  -webkit-tap-highlight-color: transparent;
}

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼ (ä¿®æ­£ç‰ˆ) --- */
header {
  background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
  color: white; padding: 10px 15px; width: 100%;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
  position: sticky; top: 0; z-index: 9999; /* æœ€å‰é¢ */
  height: 60px;
}

.logo { 
  font-size: 1.2em; font-weight: 900; 
  display: flex; align-items: center; gap: 8px; 
  pointer-events: none;
  white-space: nowrap; 
  flex-shrink: 1;
  overflow: hidden;
}

.header-right { 
  display: flex; align-items: center; gap: 8px; 
  flex-shrink: 0;
  z-index: 10000; /* ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚´ã‚ˆã‚Šå‰é¢ã« */
}

.lang-switch {
  display: flex; gap: 4px;
}

.lang-switch button {
  background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
  color: white; padding: 6px 10px; border-radius: 20px; cursor: pointer; font-size: 0.8em;
  touch-action: manipulation;
  font-weight: bold;
}
.lang-switch button.active { background: white; color: var(--primary); }

.settings-trigger {
  background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
  color: white; width: 34px; height: 34px; border-radius: 50%;
  display: flex; justify-content: center; align-items: center; cursor: pointer;
  font-size: 1.1em;
}

/* --- ãƒ’ãƒ¼ãƒ­ãƒ¼ --- */
.hero-section {
  background: white; text-align: center; padding: 30px 20px;
  width: 100%; border-radius: 0 0 30px 30px; margin-bottom: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.hero-section h1 { margin: 0; color: var(--primary); font-size: 1.6em; }

/* --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ --- */
.dashboard-card {
  background: white; margin: 20px; padding: 20px;
  border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  display: flex; align-items: center; gap: 15px;
}
.avatar-circle {
  width: 60px; height: 60px; border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
  font-size: 1.8em; background: #e0e7ff; color: var(--primary);
  flex-shrink: 0;
}
.user-meta { flex-grow: 1; }
.level-bar-container {
  background: #eee; height: 10px; border-radius: 5px; margin-top: 8px; overflow: hidden;
}
.level-bar-fill {
  background: linear-gradient(90deg, #ffcc5c, #ff6f61); height: 100%; width: 0%; transition: width 0.5s ease;
}
.status-badges { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85em; font-weight: bold; }

/* --- èªè¨¼ãƒœã‚¿ãƒ³ --- */
.auth-action-area { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
.btn-auth {
  padding: 10px 20px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
  box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
}
.btn-auth:active { transform: translateY(2px); box-shadow: none; }
.btn-login { background: #4caf50; color: white; }
.btn-signup { background: var(--primary); color: white; }
.btn-guest { background: #90a4ae; color: white; }

/* --- ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.section-header { padding: 0 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
.section-title { font-size: 1.2em; color: #444; display: flex; align-items: center; gap: 8px; margin: 0; }
.btn-back {
  background: #eee; border: none; padding: 5px 15px; border-radius: 20px;
  font-size: 0.9em; font-weight: bold; color: #666; cursor: pointer; display: none;
}

.grid-container {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 15px; padding: 0 20px 40px 20px; max-width: 1000px; margin: 0 auto;
}

.game-card {
  background: white; border-radius: 20px; padding: 20px;
  text-align: center; text-decoration: none; color: var(--text-color);
  border: 4px solid transparent; box-shadow: 0 8px 15px rgba(0,0,0,0.05);
  transition: all 0.2s; cursor: pointer;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  height: 140px; position: relative; overflow: hidden;
}
.game-card:active { transform: scale(0.98); }
.card-icon { font-size: 2.5em; margin-bottom: 10px; }
.card-title { font-weight: 800; font-size: 1.1em; line-height: 1.3; color: #555; }

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒãƒƒã‚¸ç³» --- */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
  display: none; justify-content: center; align-items: center; z-index: 20000;
}
.modal-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; }

.game-card.locked { opacity: 0.8; background: #f9f9f9; cursor: not-allowed; }
.game-card.locked::after {
  content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900;
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-size: 3em; color: #555; opacity: 0.7;
}
.premium-badge {
  position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #ffd700, #ffaa00);
  color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; font-weight: bold;
}

.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 480px) {
  .logo .ver-text { display: none; }
  .grid-container { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .game-card { height: 120px; padding: 10px; }
  .card-icon { font-size: 2em; }
}
</style>
</head>
<body>

<header>
<div class="logo">
  <i class="fa-solid fa-shapes"></i> FunLearnJP <span class="ver-text" style="font-size:0.6em; margin-left:5px;">(Ver 2.2)</span>
</div>
<div class="header-right">
  <button class="settings-trigger" onclick="openSettingsModal()">
    <i class="fa-solid fa-gear"></i>
  </button>
  <div class="lang-switch">
    <button id="lang-ja" onclick="setLanguage('ja')">JP</button>
    <button id="lang-en" onclick="setLanguage('en')">EN</button>
  </div>
</div>
</header>

<div class="hero-section"><h1 data-i18n="main_title">æ¥½ã—ãæ—¥æœ¬èªã‚’å­¦ã¼ã†ï¼</h1></div>

<div id="guest-welcome" class="auth-action-area">
  <button class="btn-auth btn-login" onclick="openAuthModal('login')"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="btn_login">ãƒ­ã‚°ã‚¤ãƒ³</span></button>
  <button class="btn-auth btn-signup" onclick="openAuthModal('signup')"><i class="fa-solid fa-user-plus"></i> <span data-i18n="btn_signup">ç™»éŒ²</span></button>
  <button class="btn-auth btn-guest" onclick="loginAsGuest()"><i class="fa-solid fa-gamepad"></i> <span data-i18n="btn_guest">ã‚²ã‚¹ãƒˆ</span></button>
</div>

<div id="user-dashboard" class="dashboard-card hidden">
  <div class="avatar-circle"><i class="fa-solid fa-user-astronaut"></i></div>
  <div class="user-meta">
    <div style="display:flex; justify-content:space-between;">
      <span id="user-name" style="font-weight:bold;">Loading...</span>
      <span style="font-size:0.8em;">Lv.<span id="user-lvl">1</span></span>
    </div>
    <div class="level-bar-container"><div id="level-fill" class="level-bar-fill"></div></div>
    <div class="status-badges">
      <span style="color:#ff6f61;"><i class="fa-solid fa-fire"></i> <span id="streak-val">0</span></span>
      <span style="color:#f0ad4e;"><i class="fa-solid fa-star"></i> <span id="point-val">0</span></span>
    </div>
  </div>
  <button onclick="logout()" style="background:none; border:none; color:#ccc;"><i class="fa-solid fa-right-from-bracket"></i></button>
</div>

<div class="section-header">
  <h3 class="section-title"><i class="fa-solid fa-graduation-cap"></i> <span id="game-section-title" data-i18n="group_learning">å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></h3>
  <button id="game-back-btn" class="btn-back" onclick="renderGameCategories()">ã‚‚ã©ã‚‹</button>
</div>
<div id="game-grid" class="grid-container fade-in"></div>

<div class="section-header"><h3 class="section-title"><i class="fa-solid fa-book-open"></i> <span data-i18n="group_kiso">åŸºç¤ãƒ»å˜èª</span></h3></div>
<div class="grid-container">
  <a href="kiso.html" class="game-card" style="border-color:#ff6f61;"><i class="fa-solid fa-pen-nib card-icon" style="color:#ff6f61;"></i><span class="card-title" data-i18n="btn_kiso">ã²ã‚‰ãŒãª<br>ã‚«ã‚¿ã‚«ãƒŠ</span></a>
  <a href="hiragana_video_list.html" class="game-card" style="border-color:#ffa726;"><i class="fa-solid fa-video card-icon" style="color:#ffa726;"></i><span class="card-title" data-i18n="btn_hiragana_video">å‹•ç”»ç·´ç¿’</span></a>
  <a href="verb_list.html" class="game-card" style="border-color:#ab47bc;"><i class="fa-solid fa-book card-icon" style="color:#ab47bc;"></i><span class="card-title" data-i18n="btn_verb_list">å‹•è©ãƒªã‚¹ãƒˆ</span></a>
  <a href="kanji_list.html" class="game-card" style="border-color:#42a5f5;"><i class="fa-solid fa-scroll card-icon" style="color:#42a5f5;"></i><span class="card-title" data-i18n="btn_kanji_list">æ¼¢å­—ãƒªã‚¹ãƒˆ</span></a>
</div>

<div class="section-header"><h3 class="section-title"><i class="fa-solid fa-gamepad"></i> <span data-i18n="group_fun_games">ã‚²ãƒ¼ãƒ </span></h3></div>
<div class="grid-container">
  <a href="culture_map.html" id="static-sengoku-btn" class="game-card" style="border-color:#b71c1c;">
    <div class="premium-badge">ğŸ‘‘ PRO</div>
    <i class="fa-solid fa-khanda card-icon" style="color:#b71c1c;"></i>
    <span class="card-title" data-i18n="btn_sengoku">æˆ¦å›½ãƒ»æ—¥æœ¬èªä¼</span>
  </a>
</div>

<div id="auth-modal" class="modal-overlay"><div class="modal-box"><h2 id="modal-title"></h2><input type="email" id="auth-email" placeholder="Email"><input type="password" id="auth-pass" placeholder="Pass"><button id="modal-submit" onclick="submitAuth()" class="btn-auth btn-login" style="width:100%"></button><button onclick="closeAuthModal()" style="border:none;background:none;margin-top:10px;">Cancel</button></div></div>
<div id="settings-modal" class="modal-overlay"><div class="modal-box"><h2>Setting</h2><button onclick="closeSettingsModal()">Close</button></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls", authDomain: "funlearningjapanese-b8e08.firebaseapp.com", projectId: "funlearningjapanese-b8e08", storageBucket: "funlearningjapanese-b8e08.appspot.com", messagingSenderId: "1055688629268", appId: "1:1055688629268:web:248183b62f15c34a2d5b01" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.isUserPremium = false;
window.currentCategory = null; // â˜…è¿½åŠ ï¼šç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¿æŒ

onAuthStateChanged(auth, (user) => {
  if (user) {
    onSnapshot(doc(db, "users", user.uid), (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        window.isUserPremium = data.isPremium || false;
        document.getElementById('user-dashboard').classList.remove('hidden');
        document.getElementById('guest-welcome').classList.add('hidden');
        document.getElementById('user-name').textContent = data.displayName;
        document.getElementById('point-val').textContent = data.points;
        updateStaticCards(window.isUserPremium);
        refreshGameDisplay(); // â˜…å†æç”»
      }
    });
  } else {
    document.getElementById('user-dashboard').classList.add('hidden');
    document.getElementById('guest-welcome').classList.remove('hidden');
    updateStaticCards(false);
    refreshGameDisplay();
  }
});

function updateStaticCards(isPremium) {
  const btn = document.getElementById('static-sengoku-btn');
  if (!isPremium) {
    btn.classList.add('locked');
    btn.onclick = (e) => { e.preventDefault(); openPremiumModal(); };
  } else {
    btn.classList.remove('locked');
    btn.onclick = null;
  }
}

// â˜…ä¿®æ­£ç‰ˆï¼šæç”»ãƒ­ã‚¸ãƒƒã‚¯
window.refreshGameDisplay = () => {
  if (window.currentCategory) {
    renderGameList(window.currentCategory);
  } else {
    renderGameCategories();
  }
};

window.renderGameCategories = () => {
  window.currentCategory = null;
  const grid = document.getElementById('game-grid');
  grid.innerHTML = '';
  document.getElementById('game-back-btn').style.display = 'none';
  document.getElementById('game-section-title').textContent = window.i18nData[window.currentLang].group_learning;

  window.gameStructure.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'game-card';
    div.style.borderColor = cat.color;
    div.onclick = () => renderGameList(cat);
    div.innerHTML = `<i class="${cat.icon} card-icon" style="color:${cat.color}"></i><span class="card-title">${window.i18nData[window.currentLang][cat.titleKey]}</span>`;
    grid.appendChild(div);
  });
};

function renderGameList(category) {
  window.currentCategory = category;
  const grid = document.getElementById('game-grid');
  grid.innerHTML = '';
  document.getElementById('game-back-btn').style.display = 'block';
  document.getElementById('game-section-title').textContent = window.i18nData[window.currentLang][category.titleKey];

  category.games.forEach(game => {
    const isLocked = game.isPremium && !window.isUserPremium;
    const card = document.createElement(isLocked ? 'div' : 'a');
    card.className = 'game-card' + (isLocked ? ' locked' : '');
    card.style.borderColor = category.color;
    if (isLocked) card.onclick = () => openPremiumModal();
    else card.href = game.url;

    const badge = game.isPremium ? '<div class="premium-badge">ğŸ‘‘ PRO</div>' : '';
    card.innerHTML = `${badge}<i class="${game.icon} card-icon" style="color:${category.color}"></i><span class="card-title">${window.i18nData[window.currentLang][game.titleKey] || game.titleKey}</span>`;
    grid.appendChild(card);
  });
}

window.openPremiumModal = () => {
  if(confirm("Premium Only. Go to Payment?")) window.open("https://buy.stripe.com/test_aFa8wIcw2ezZdEe5ah3VC00", "_blank");
};
</script>

<script>
window.currentLang = 'ja';
window.i18nData = {
  ja: { main_title: "Fun Learning Japanese", group_learning: "å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼", group_kiso: "åŸºç¤ãƒ»å˜èª", group_fun_games: "ã‚²ãƒ¼ãƒ ", btn_login: "ãƒ­ã‚°ã‚¤ãƒ³", btn_signup: "ç™»éŒ²", btn_guest: "ã‚²ã‚¹ãƒˆ", cat_hiragana: "ã²ã‚‰ãŒãª", cat_kanji_game: "ã‹ã‚“ã˜", btn_kiso: "ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠ", btn_hiragana_video: "å‹•ç”»ç·´ç¿’", btn_verb_list: "å‹•è©ãƒªã‚¹ãƒˆ", btn_kanji_list: "æ¼¢å­—ãƒªã‚¹ãƒˆ", btn_kanji_sentence: "æ¼¢å­—æ–‡ç« ã‚¯ã‚¤ã‚º", btn_sengoku: "æˆ¦å›½ãƒ»æ—¥æœ¬èªä¼" },
  en: { main_title: "Fun Learn Japanese", group_learning: "Learning Menu", group_kiso: "Basics", group_fun_games: "Games", btn_login: "Login", btn_signup: "Sign Up", btn_guest: "Guest", cat_hiragana: "Hiragana", cat_kanji_game: "Kanji", btn_kiso: "Hira/Kata", btn_hiragana_video: "Videos", btn_verb_list: "Verbs", btn_kanji_list: "Kanji List", btn_kanji_sentence: "Kanji Quiz", btn_sengoku: "Sengoku Japan" }
};

window.gameStructure = [
  { id: "hiragana", icon: "fa-solid fa-h", color: "#ff6f61", titleKey: "cat_hiragana", games: [{ url: "trace_write_hiragana.html", titleKey: "btn_kiso", icon: "fa-solid fa-paintbrush" }] },
  { id: "kanji", icon: "fa-solid fa-pen-fancy", color: "#42a5f5", titleKey: "cat_kanji_game", games: [{ url: "kanji_sentence_quiz.html", titleKey: "btn_kanji_sentence", icon: "fa-solid fa-pen-to-square", isPremium: true }] }
];

window.setLanguage = (lang) => {
  window.currentLang = lang;
  document.getElementById('lang-ja').classList.toggle('active', lang === 'ja');
  document.getElementById('lang-en').classList.toggle('active', lang === 'en');
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    el.textContent = window.i18nData[lang][key];
  });
  // â˜…é‡è¦ï¼šè¨€èªã‚’å¤‰ãˆã¦ã‚‚ä»Šã®ç”»é¢ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã‹ä¸€è¦§ã‹ï¼‰ã‚’ç¶­æŒã—ã¦å†æç”»
  if (typeof window.refreshGameDisplay === 'function') window.refreshGameDisplay();
};

window.openSettingsModal = () => document.getElementById('settings-modal').style.display='flex';
window.closeSettingsModal = () => document.getElementById('settings-modal').style.display='none';
window.onload = () => { window.setLanguage('ja'); };
</script>
</body>
</html>