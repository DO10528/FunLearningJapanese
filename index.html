<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="main_title">Fun Learning Japanese - Next Gen</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
    /* --- åŸºæœ¬è¨­å®š --- */
    :root {
        --primary: #5c7aff;
        --accent: #ffcc5c;
        --bg-color: #f4f7fc;
        --text-color: #333;
        --line-green: #06c755;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0; padding: 0; padding-bottom: 80px;
        overflow-x: hidden; width: 100%;
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    header {
        background: linear-gradient(135deg, #5c7aff 0%, #4facfe 100%);
        color: white; padding: 15px 20px; width: 100%;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 15px rgba(92, 122, 255, 0.3);
        position: sticky; top: 0; z-index: 100;
    }
    .logo { font-size: 1.4em; font-weight: 900; display: flex; align-items: center; gap: 10px; }
    .header-right { display: flex; align-items: center; gap: 10px; }

    .lang-switch button {
        background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
        color: white; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 0.8em;
    }
    .lang-switch button.active { background: white; color: var(--primary); font-weight: bold; }

    .settings-trigger {
        background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
        color: white; width: 32px; height: 32px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; cursor: pointer;
        font-size: 1em; transition: background 0.2s;
    }
    .settings-trigger:active { background: rgba(255,255,255,0.4); }

    /* --- ãƒ’ãƒ¼ãƒ­ãƒ¼ --- */
    .hero-section {
        background: white; text-align: center; padding: 30px 20px;
        width: 100%; border-radius: 0 0 30px 30px; margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .hero-section h1 { margin: 0; color: var(--primary); font-size: 1.6em; }

    /* --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ --- */
    .dashboard-card {
        background: white; margin: 20px; padding: 20px;
        border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: flex; align-items: center; gap: 15px;
    }
    .avatar-circle {
        width: 60px; height: 60px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.8em; background: #e0e7ff; color: var(--primary);
        flex-shrink: 0;
    }
    .user-meta { flex-grow: 1; }
    .level-bar-container {
        background: #eee; height: 10px; border-radius: 5px; margin-top: 8px; overflow: hidden;
    }
    .level-bar-fill {
        background: linear-gradient(90deg, #ffcc5c, #ff6f61); height: 100%; width: 0%; transition: width 0.5s ease;
    }
    .status-badges { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85em; font-weight: bold; }
    .badge-streak { color: #ff6f61; }
    .badge-points { color: #f0ad4e; }

    /* --- èªè¨¼ãƒœã‚¿ãƒ³ --- */
    .auth-action-area { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
    .btn-auth {
        padding: 10px 20px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
    }
    .btn-auth:active { transform: translateY(4px); box-shadow: none; }
    .btn-login { background: #4caf50; color: white; }
    .btn-signup { background: var(--primary); color: white; }
    .btn-guest { background: #90a4ae; color: white; }

    /* --- ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .section-header {
        padding: 0 20px; margin-bottom: 15px;
        display: flex; align-items: center; justify-content: space-between;
    }
    .section-title { font-size: 1.2em; color: #444; display: flex; align-items: center; gap: 8px; margin: 0; }
    .section-title i { color: var(--primary); }
    
    .btn-back {
        background: #eee; border: none; padding: 5px 15px; border-radius: 20px;
        font-size: 0.9em; font-weight: bold; color: #666; cursor: pointer;
        display: none; 
    }
    .btn-back:hover { background: #ddd; }

    .grid-container {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px; padding: 0 20px 40px 20px; 
        max-width: 1000px; margin: 0 auto;
    }

    .game-card {
        background: white; border-radius: 20px; padding: 20px;
        text-align: center; text-decoration: none; color: var(--text-color);
        border: 4px solid transparent; /* JSã§è‰²ã‚’ã¤ã‘ã‚‹ */
        box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        transition: all 0.2s; cursor: pointer;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        height: 140px; position: relative; overflow: hidden;
    }
    .game-card:active { transform: scale(0.98); box-shadow: 0 4px 5px rgba(0,0,0,0.05); }

    .card-icon { font-size: 2.5em; margin-bottom: 10px; }
    .card-title { font-weight: 800; font-size: 1.1em; line-height: 1.3; color: #555; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-box {
        background: white; width: 90%; max-width: 400px; padding: 30px;
        border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
    }
    .modal-box input {
        width: 100%; padding: 12px; margin: 10px 0;
        border: 2px solid #eee; border-radius: 10px; box-sizing: border-box;
    }
    
    .setting-row {
        display: flex; justify-content: space-between; align-items: center;
        background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px;
        border: 1px solid #e0e0e0; text-align: left;
    }
    .line-btn {
        background-color: var(--line-green); color: white; border: none;
        padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;
        display: flex; align-items: center; gap: 8px; font-size: 0.9em;
    }
    
    .ranking-fab {
        position: fixed; bottom: 20px; right: 20px;
        background: #ffcc5c; color: #d35400; width: 60px; height: 60px;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 1.5em; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        cursor: pointer; z-index: 90; border: 3px solid white;
    }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 400px) {
        .grid-container { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .game-card { height: 120px; padding: 10px; }
        .card-icon { font-size: 2em; }
    }
</style>
</head>
<body>

<header>
    <div class="logo"><i class="fa-solid fa-shapes"></i> FunLearnJP</div>
    
    <div class="header-right">
        <button class="settings-trigger" onclick="openSettingsModal()">
            <i class="fa-solid fa-gear"></i>
        </button>

        <div class="lang-switch">
            <button id="lang-ja" onclick="setLanguage('ja')" class="active">JP</button>
            <button id="lang-en" onclick="setLanguage('en')">EN</button>
        </div>
    </div>
</header>

<div class="hero-section">
    <h1 data-i18n="main_title">æ¥½ã—ãæ—¥æœ¬èªã‚’å­¦ã¼ã†ï¼</h1>
</div>

<div id="guest-welcome" class="auth-action-area">
    <button id="login-btn" class="btn-auth btn-login"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="btn_login">ãƒ­ã‚°ã‚¤ãƒ³</span></button>
    <button id="signup-btn" class="btn-auth btn-signup"><i class="fa-solid fa-user-plus"></i> <span data-i18n="btn_signup">ç™»éŒ²</span></button>
    <button id="guest-btn" class="btn-auth btn-guest"><i class="fa-solid fa-gamepad"></i> <span data-i18n="btn_guest">ã‚²ã‚¹ãƒˆ</span></button>
</div>

<div id="user-dashboard" class="dashboard-card hidden">
    <div class="avatar-circle"><i class="fa-solid fa-user-astronaut"></i></div>
    <div class="user-meta">
        <div style="display:flex; justify-content:space-between;">
            <span id="user-name" style="font-weight:bold; font-size:1.1em;">Loading...</span>
            <span style="font-size:0.9em; color:#666;">Lv.<span id="user-lvl">1</span></span>
        </div>
        <div class="level-bar-container"><div id="level-fill" class="level-bar-fill"></div></div>
        <div class="status-badges">
            <span class="badge-streak"><i class="fa-solid fa-fire"></i> <span id="streak-val">0</span> Day</span>
            <span class="badge-points"><i class="fa-solid fa-star"></i> <span id="point-val">0</span> Pt</span>
        </div>
    </div>
    <button id="logout-btn" style="background:none; border:none; color:#999; cursor:pointer;"><i class="fa-solid fa-right-from-bracket"></i></button>
</div>

<div class="section-header">
    <h3 class="section-title"><i class="fa-solid fa-book-open"></i> <span data-i18n="group_kiso">åŸºç¤ãƒ»å˜èª</span></h3>
</div>
<div class="grid-container">
    <a href="kiso.html" class="game-card" style="border-color:#ff6f61;">
        <i class="fa-solid fa-pen-nib card-icon" style="color:#ff6f61;"></i>
        <span class="card-title" data-i18n="btn_kiso">ã²ã‚‰ãŒãª<br>ã‚«ã‚¿ã‚«ãƒŠ</span>
    </a>
    <a href="hiragana_video_list.html" class="game-card" style="border-color:#ffa726;">
        <i class="fa-solid fa-video card-icon" style="color:#ffa726;"></i>
        <span class="card-title" data-i18n="btn_hiragana_video">å‹•ç”»ç·´ç¿’</span>
    </a>
    <a href="verb_list.html" class="game-card" style="border-color:#ab47bc;">
        <i class="fa-solid fa-book card-icon" style="color:#ab47bc;"></i>
        <span class="card-title" data-i18n="btn_verb_list">å‹•è©ãƒªã‚¹ãƒˆ</span>
    </a>
    <a href="keiyoshi_list.html" class="game-card" style="border-color:#66bb6a;">
        <i class="fa-solid fa-book card-icon" style="color:#66bb6a;"></i>
        <span class="card-title" data-i18n="btn_keiyoshi_list">å½¢å®¹è©ãƒªã‚¹ãƒˆ</span>
    </a>
    <a href="kanji_list.html" class="game-card" style="border-color:#42a5f5;">
        <i class="fa-solid fa-scroll card-icon" style="color:#42a5f5;"></i>
        <span class="card-title" data-i18n="btn_kanji_list">æ¼¢å­—ãƒªã‚¹ãƒˆ</span>
    </a>
</div>

<div class="section-header">
    <h3 class="section-title"><i class="fa-solid fa-graduation-cap"></i> <span id="game-section-title" data-i18n="group_learning">å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></h3>
    <button id="game-back-btn" class="btn-back" onclick="renderGameCategories()"><i class="fa-solid fa-arrow-left"></i> ã‚‚ã©ã‚‹</button>
</div>

<div id="game-grid" class="grid-container fade-in"></div>

<div class="section-header" style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e0e0e0;">
    <h3 class="section-title"><i class="fa-solid fa-gamepad"></i> <span data-i18n="group_fun_games">ã‚²ãƒ¼ãƒ </span></h3>
</div>
<div class="grid-container">
    <a href="culture_map.html" class="game-card" style="border-color:#b71c1c;">
        <i class="fa-solid fa-khanda card-icon" style="color:#b71c1c;"></i>
        <span class="card-title" data-i18n="btn_sengoku">æˆ¦å›½ãƒ»æ—¥æœ¬èªä¼</span>
    </a>
</div>

<div id="fab-ranking" class="ranking-fab" onclick="window.toggleRanking()"><i class="fa-solid fa-trophy"></i></div>

<div id="ranking-modal" class="modal-overlay">
    <div class="modal-box" style="text-align:left;">
        <h2 style="text-align:center; color:#f0ad4e;"><i class="fa-solid fa-crown"></i> ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <div id="ranking-loading" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</div>
        <ul id="ranking-list" style="list-style:none; padding:0;"></ul>
        <button onclick="document.getElementById('ranking-modal').style.display='none'" style="width:100%; padding:10px; margin-top:10px; border:none; background:#eee;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="auth-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modal-title"></h2> <p id="modal-msg" style="color:red; font-size:0.9em;"></p>
        
        <input type="email" id="auth-email" data-i18n-placeholder="ph_email">
        <input type="password" id="auth-pass" data-i18n-placeholder="ph_pass">
        <input type="text" id="auth-display-name" data-i18n-placeholder="ph_name" class="hidden">
        
        <button id="modal-submit" class="btn-auth btn-login" style="width:100%; margin-top:10px;"></button> <button id="modal-close" data-i18n="btn_cancel" style="width:100%; margin-top:10px; border:none; background:white; color:#666; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="margin-bottom:20px; color:#555;"><i class="fa-solid fa-gear"></i> è¨­å®š</h2>

        <div class="setting-row">
            <div>
                <div style="font-weight:bold; font-size:0.95em;">ã‚µã‚¤ãƒˆé€šçŸ¥</div>
                <div style="font-size:0.75em; color:#888;">æœ€æ–°æƒ…å ±ã‚’å—ã‘å–ã‚‹</div>
            </div>
            <button onclick="requestNotificationPermission()" style="padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; font-size:0.85em;">
                <i class="fa-solid fa-bell"></i> è¨±å¯
            </button>
        </div>

        <div class="setting-row">
            <div>
                <div style="font-weight:bold; font-size:0.95em;">LINEé€£æº</div>
                <div style="font-size:0.75em; color:#888;">å­¦ç¿’é€šçŸ¥ã‚’å—ã‘å–ã‚‹</div>
            </div>
            <button class="line-btn" onclick="linkLineAccount()">
                <i class="fa-brands fa-line" style="font-size:1.3em;"></i> é€£æº
            </button>
        </div>
        
        <div style="margin-top:20px;">
             <button onclick="closeSettingsModal()" style="padding:10px 30px; border:none; background:#eee; color:#555; border-radius:20px; cursor:pointer; font-weight:bold;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
    import { 
        getFirestore, doc, setDoc, updateDoc, getDocs, collection, 
        query, orderBy, limit, onSnapshot, where, getDoc, increment 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { 
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
        signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.appspot.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    // FirebaseåˆæœŸåŒ– (ã“ã‚Œ1å›ã§OKã§ã™)
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app); 
    const messaging = getMessaging(app);

    const SESS_KEY = 'user_mode';
    let currentUserDocUnsubscribe = null;

    // é€šçŸ¥ç”¨VAPIDã‚­ãƒ¼
    const VAPID_KEY = "BOp9ikY5zWsK4tBsSWaZ2wxa_uEoS4VOnJzWN0u7HqyDNMO7K4xchPkKKQu1iEyxx-X1yrV3uLyt8mwY7NVBdo0";

    // --- é€šçŸ¥æ©Ÿèƒ½ ---
    // 1. Service Workerè‡ªå‹•ç™»éŒ²
    const registerServiceWorker = async () => {
        if ('serviceWorker' in navigator) {
            const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
            const swPath = isLocalhost ? './firebase-messaging-sw.js' : '/FunLearningJapanese/firebase-messaging-sw.js';
            try {
                // scopeã‚’æŒ‡å®šã—ãªã„ã¨ã€éšå±¤ã®é•ã†ãƒ•ã‚¡ã‚¤ãƒ«ã§å•é¡ŒãŒèµ·ãã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ä¿®æ­£
                const registration = await navigator.serviceWorker.register(swPath, { scope: isLocalhost ? './' : '/FunLearningJapanese/' });
                console.log('Service Worker è‡ªå‹•ç™»éŒ²æˆåŠŸ:', registration);
                return registration;
            } catch (err) {
                console.error('Service Worker è‡ªå‹•ç™»éŒ²å¤±æ•—:', err);
                return null;
            }
        }
    };
    registerServiceWorker();

    // 2. ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥å—ä¿¡
    onMessage(messaging, (payload) => {
        console.log("Message received (foreground)", payload);
        const title = payload.notification.title;
        const body = payload.notification.body;
        alert(`ã€é€šçŸ¥ã€‘\n${title}\n${body}`);
    });

    // 3. é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    window.requestNotificationPermission = async () => {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
            alert("é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            return;
        }

        try {
            // ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèª
            const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
            const swPath = isLocalhost ? './firebase-messaging-sw.js' : '/FunLearningJapanese/firebase-messaging-sw.js';
            let swReg = await navigator.serviceWorker.getRegistration();
            
            if (!swReg) {
                swReg = await navigator.serviceWorker.register(swPath, { scope: isLocalhost ? './' : '/FunLearningJapanese/' });
            }

            const token = await getToken(messaging, {
                vapidKey: VAPID_KEY,
                serviceWorkerRegistration: swReg
            });

            console.log("FCM Token:", token);
            alert("é€šçŸ¥è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\n(ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ)");
        } catch (err) {
            console.error("FCM Token error:", err);
            alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
        }
    };

    // --- LINEé€£æºæ©Ÿèƒ½ (LIFF) ---
    // â˜…é‡è¦: ã“ã“ã«ã‚ãªãŸã®LIFF IDã‚’å…¥ã‚Œã¦ãã ã•ã„
    const MY_LIFF_ID = "YOUR_LIFF_ID"; // ä¾‹: 1657000000-xxxxxx

    window.linkLineAccount = async () => {
        if (MY_LIFF_ID === "YOUR_LIFF_ID") {
            alert("ã€é–‹ç™ºè€…ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘\nLINE Developersã§LIFF IDã‚’å–å¾—ã—ã€\nã‚³ãƒ¼ãƒ‰å†…ã® 'YOUR_LIFF_ID' ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚");
            // window.open("https://developers.line.biz/ja/", "_blank");
            return;
        }

        try {
            // LIFFåˆæœŸåŒ–
            await liff.init({ liffId: MY_LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°LINEãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                liff.login();
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                const profile = await liff.getProfile();
                const lineUserId = profile.userId;
                const lineName = profile.displayName;
                
                alert(`LINEé€£æºæˆåŠŸï¼\nã“ã‚“ã«ã¡ã¯ã€${lineName}ã•ã‚“ã€‚`);
                
                // ã“ã“ã§Firebaseã«LINE IDã‚’ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã§ãã¾ã™
                // saveLineIdToFirestore(lineUserId);
            }
        } catch (err) {
            console.error("LIFF Error:", err);
            alert("LINEé€£æºã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
    };

    // --- UIãƒ»èªè¨¼é–¢é€£ (æ—¢å­˜ã‚³ãƒ¼ãƒ‰) ---
    window.openSettingsModal = () => document.getElementById('settings-modal').style.display = 'flex';
    window.closeSettingsModal = () => document.getElementById('settings-modal').style.display = 'none';

    window.openAuthModal = (mode) => {
        window.authMode = mode;
        const modal = document.getElementById('auth-modal');
        const displayNameInput = document.getElementById('auth-display-name');
        
        modal.style.display = 'flex';
        const titleKey = mode === 'login' ? 'modal_login' : 'modal_signup';
        document.getElementById('modal-title').textContent = i18nData[currentLang][titleKey];
        document.getElementById('modal-submit').textContent = i18nData[currentLang]['btn_exec'];
        displayNameInput.classList.toggle('hidden', mode === 'login');
        document.getElementById('modal-msg').textContent = '';
        document.getElementById('auth-email').value = ''; 
        document.getElementById('auth-pass').value = '';
        displayNameInput.value = '';
    };

    window.closeAuthModal = () => document.getElementById('auth-modal').style.display = 'none';

    window.submitAuth = async () => {
        const email = document.getElementById('auth-email').value.trim(); 
        const pass = document.getElementById('auth-pass').value.trim();
        const displayName = document.getElementById('auth-display-name').value.trim();
        const msg = document.getElementById('modal-msg');
        const errs = i18nData[currentLang]; 
        
        if (!email || !pass) { msg.textContent = errs.err_input_req; return; }
        if (pass.length < 6) { msg.textContent = errs.err_pass_len; return; }

        try {
            if (window.authMode === 'signup') {
                if (!displayName || displayName.length < 2) { msg.textContent = errs.err_name_req; return; }
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("displayName", "==", displayName), limit(1));
                const snap = await getDocs(q);
                if (!snap.empty) { msg.textContent = errs.err_name_taken; return; }

                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), {
                    email: email, displayName: displayName, points: 0, streak: 1, lastLogin: new Date().toISOString(), dailyTracker: {} 
                });
                sessionStorage.setItem(SESS_KEY, 'authenticated');
                window.closeAuthModal();
            } else {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef); 
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        email: email, displayName: email.split('@')[0] || 'UnknownUser', points: 0, streak: 1, lastLogin: new Date().toISOString(), dailyTracker: {} 
                    });
                } else {
                    if (!userSnap.data().dailyTracker) await updateDoc(userRef, { dailyTracker: {} });
                }
                sessionStorage.setItem(SESS_KEY, 'authenticated');
                window.closeAuthModal();
            }
        } catch (error) {
            console.error(error);
            let errorMsg = errs.err_generic;
            if (error.code === 'auth/email-already-in-use') errorMsg = errs.err_email_taken;
            else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') errorMsg = errs.err_auth_fail;
            msg.textContent = errorMsg;
        }
    };

    window.logout = async () => {
        if (currentUserDocUnsubscribe) currentUserDocUnsubscribe(); 
        sessionStorage.removeItem(SESS_KEY);
        await signOut(auth);
        updateUI(null);
    };

    window.loginAsGuest = () => {
        if (currentUserDocUnsubscribe) currentUserDocUnsubscribe(); 
        sessionStorage.setItem(SESS_KEY, 'guest');
        updateUI('guest');
    };

    const checkMonthlyReset = async (user) => {
        const userRef = doc(db, "users", user.uid);
        const snapshot = await getDoc(userRef);
        if (snapshot.exists()) {
            const data = snapshot.data();
            const now = new Date();
            const lastDate = data.lastLogin ? new Date(data.lastLogin) : new Date(0);
            if (now.getFullYear() !== lastDate.getFullYear() || now.getMonth() !== lastDate.getMonth()) {
                await updateDoc(userRef, { points: 0, lastLogin: now.toISOString(), dailyTracker: {} });
            } else {
                await updateDoc(userRef, { lastLogin: now.toISOString() });
            }
        }
    };

    function updateUI(userState) {
        const dash = document.getElementById('user-dashboard');
        const welcome = document.getElementById('guest-welcome');
        if (currentUserDocUnsubscribe) currentUserDocUnsubscribe(); 
        
        if (userState === 'guest') {
            welcome.classList.add('hidden');
            dash.classList.remove('hidden');
            document.getElementById('user-name').textContent = 'ã‚²ã‚¹ãƒˆ';
            document.getElementById('user-lvl').textContent = 1;
            document.getElementById('level-fill').style.width = '0%';
            document.getElementById('streak-val').textContent = 0;
            document.getElementById('point-val').textContent = 0;
        } else if (userState && userState.uid) {
            welcome.classList.add('hidden');
            dash.classList.remove('hidden');
            const userId = userState.uid;
            currentUserDocUnsubscribe = onSnapshot(doc(db, "users", userId), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    document.getElementById('user-name').textContent = data.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'; 
                    document.getElementById('streak-val').textContent = data.streak || 0;
                    document.getElementById('point-val').textContent = data.points || 0;
                    const pts = data.points || 0;
                    const level = Math.floor(pts / 100) + 1;
                    document.getElementById('user-lvl').textContent = level;
                    document.getElementById('level-fill').style.width = `${(pts % 100)}%`;
                }
            });
        } else {
            welcome.classList.remove('hidden');
            dash.classList.add('hidden');
        }
    }

    window.toggleRanking = async () => {
        const modal = document.getElementById('ranking-modal');
        const list = document.getElementById('ranking-list');
        const loading = document.getElementById('ranking-loading');
        modal.style.display = 'flex';
        list.innerHTML = '';
        loading.style.display = 'block';
        try {
            const q = query(collection(db, "users"), orderBy("points", "desc"), limit(5));
            const querySnapshot = await getDocs(q);
            loading.style.display = 'none';
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const name = data.displayName || 'Unknown'; 
                const pt = data.points || 0;
                const icon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;
                const li = document.createElement('li');
                li.style.cssText = "padding:10px; border-bottom:1px dashed #ccc; font-weight:bold; display:flex; justify-content:space-between;";
                li.innerHTML = `<span>${icon} ${name}</span><span style="color:#f0ad4e">${pt}pt</span>`;
                list.appendChild(li);
                rank++;
            });
            if (rank === 1) list.innerHTML = '<li style="padding:10px; text-align:center; color:#999;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>';
        } catch (e) {
            console.error(e);
            loading.innerText = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            sessionStorage.setItem(SESS_KEY, 'authenticated');
            await checkMonthlyReset(user);
            updateUI(user);
        } else if (sessionStorage.getItem(SESS_KEY) === 'guest') {
            updateUI('guest');
        } else {
            updateUI(null);
        }
    });
    
    document.getElementById('login-btn').onclick = () => window.openAuthModal('login');
    document.getElementById('signup-btn').onclick = () => window.openAuthModal('signup');
    document.getElementById('guest-btn').onclick = () => window.loginAsGuest();
    document.getElementById('logout-btn').onclick = () => window.logout();
    document.getElementById('modal-close').onclick = () => window.closeAuthModal();
    document.getElementById('modal-submit').onclick = () => window.submitAuth();

    const handleEnter = (e) => { if (e.key === 'Enter') window.submitAuth(); };
    document.getElementById('auth-email').onkeydown = handleEnter;
    document.getElementById('auth-pass').onkeydown = handleEnter;
    document.getElementById('auth-display-name').onkeydown = handleEnter;

    window.renderGameCategories(); 
</script>

<script>
    const i18nData = {
        ja: { 
            main_title: "Fun Learning Japanese", btn_login: "ãƒ­ã‚°ã‚¤ãƒ³", btn_signup: "æ–°è¦ç™»éŒ²", btn_guest: "ã‚²ã‚¹ãƒˆ", 
            group_kiso: "åŸºç¤ãƒ»å˜èª", 
            group_learning: "å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 
            group_fun_games: "ã‚²ãƒ¼ãƒ ",
            
            btn_kiso: "ã²ã‚‰ãŒãª<br>ã‚«ã‚¿ã‚«ãƒŠ", btn_hiragana_video: "å‹•ç”»ç·´ç¿’", btn_keiyoshi_list: "å½¢å®¹è©ãƒªã‚¹ãƒˆ", btn_verb_list: "å‹•è©ãƒªã‚¹ãƒˆ",btn_kanji_list: "æ¼¢å­—ãƒªã‚¹ãƒˆ",
            cat_hiragana: "ã²ã‚‰ãŒãª", cat_katakana: "ã‚«ã‚¿ã‚«ãƒŠ", cat_shiritori: "ã—ã‚Šã¨ã‚Š", cat_word_other: "ã“ã¨ã°",
            cat_clock: "ã¨ã‘ã„", 
            cat_date_time: "æ—¥ä»˜ãƒ»æ™‚é–“",
            cat_kanji_game: "ã‹ã‚“ã˜", cat_keiyoshi_game: "ã‘ã„ã‚ˆã†ã—", cat_verb_game: "ã©ã†ã—", cat_sentence: "ã¶ã‚“ã—ã‚‡ã†",
            cat_practice: "ã˜ã£ã›ã‚“",
            
            // ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«
            btn_h_write: "ã‹ãã‹ãŸé“å ´", btn_h_sound: "ãŠã¨ã‚¯ã‚¤ã‚º", btn_h_match: "ã²ã‚‰ãŒãªãƒãƒƒãƒ",
            btn_h_vocab: "ã²ã‚‰ãŒãªå˜èª", btn_h_reorder: "ä¸¦ã³æ›¿ãˆ", btn_h_meteor: "éš•çŸ³ã‚¯ã‚¤ã‚º",
            btn_k_write: "ã‚«ã‚¿ã‚«ãƒŠé“å ´", btn_k_sound: "ãŠã¨ã‚¯ã‚¤ã‚º", btn_k_match: "ã‚«ã‚¿ã‚«ãƒŠãƒãƒƒãƒ", 
            btn_k_pair: "ã²ã‚‰ã‚«ã‚¿ã‚ã‚ã›",
            btn_shiri1: "ã—ã‚Šã¨ã‚Š1", btn_shiri2: "ã—ã‚Šã¨ã‚Š2",
            btn_treasure: "å®æ¢ã—", btn_aisatsu: "ã‚ã„ã•ã¤",
            
            btn_imasu: "ã„ã¾ã™<br>ã‚ã‚Šã¾ã™",
            btn_money: "ãŠé‡‘ã®å­¦ç¿’",
            btn_transport: "ã“ã†ã¤ã†",
            
            btn_clock1: "ã¨ã‘ã„1", btn_clock2: "ã¨ã‘ã„2",
            btn_datetime_practice: "æ—¥ä»˜ãƒ»ç·´ç¿’", 

            btn_kanjidojo: "ã‹ãã‹ãŸé“å ´", btn_kanjiquiz: "ã‹ã‚“ã˜ã‚¯ã‚¤ã‚º",
            btn_kei1: "ã‘ã„ã‚ˆã†ã—1", btn_kei_match: "ã©ã£ã¡ãŒã€‡ã€‡ï¼Ÿ",
            btn_kei_neg: "ã²ã¦ã„ã‘ã„ (ï½ããªã„)",

            btn_verbgame: "ã©ã†ã—ã‚²ãƒ¼ãƒ ", btn_verbmasu: "ã¾ã™å½¢ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", btn_verbte: "ã¦å½¢ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", 
            btn_tekudasai: "V-ã¦ãã ã•ã„", 
            btn_tekudasaimasenka: "V-ã¦ãã ã•ã„ã¾ã›ã‚“ã‹",
            btn_mashouka: "V-ã¾ã—ã‚‡ã†ã‹", 
            btn_teimasu: "V-ã¦ã„ã¾ã™", 
            btn_temoii: "V-ã¦ã‚‚ã„ã„ã§ã™ã‹",
            btn_kata: "V-æ–¹",
            
            btn_partsort: "åŠ©è©ãƒ»ä»•åˆ†ã‘é“å ´", btn_partquiz: "ã¦ã«ã‚’ã¯ãƒã‚¹ã‚¿ãƒ¼", btn_sentencepuzzle: "ã¶ã‚“ã¥ãã‚Š",
            btn_shoptalk: "ãŠè²·ã„ç‰©ãƒˆãƒ¼ã‚¯", btn_bustalk: "ãŠä»•äº‹ãƒˆãƒ¼ã‚¯",
            
            btn_sengoku: "æˆ¦å›½ãƒ»æ—¥æœ¬èªä¼",

            // èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«
            modal_login: "ãƒ­ã‚°ã‚¤ãƒ³", modal_signup: "æ–°è¦ç™»éŒ²",
            ph_email: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", ph_pass: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", ph_name: "ã‚²ãƒ¼ãƒ å (ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¡¨ç¤º)",
            btn_exec: "å®Ÿè¡Œ", btn_cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            err_input_req: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            err_pass_len: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
            err_name_req: "Please enter a game name (2+ chars).",
            err_name_taken: "That game name is already taken.",
            err_generic: "èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",
            err_email_taken: "Email is already in use.",
            err_auth_fail: "Incorrect email or password."
        },
        en: { 
            main_title: "Fun Learning Japanese", btn_login: "Login", btn_signup: "Sign Up", btn_guest: "Guest", 
            group_kiso: "Basics", 
            group_learning: "Learning Menu", 
            group_fun_games: "Games",

            btn_kiso: "Kana Basics", btn_hiragana_video: "Video Practice", btn_keiyoshi_list: "Adj List", btn_verb_list: "Verb List", btn_kanji_list: "Kanji List",
            cat_hiragana: "Hiragana", cat_katakana: "Katakana", cat_shiritori: "Shiritori", cat_word_other: "Words",
            cat_clock: "Clock", 
            cat_date_time: "Date & Time",
            cat_kanji_game: "Kanji", cat_keiyoshi_game: "Adjectives", cat_verb_game: "Verbs", cat_sentence: "Sentence",
            cat_practice: "Practice",

            // Game Titles
            btn_h_write: "Writing Practice", btn_h_sound: "Sound Quiz", btn_h_match: "Hiragana Match",
            btn_h_vocab: "Hiragana Vocab", btn_h_reorder: "Reordering", btn_h_meteor: "Meteor Quiz",
            btn_k_write: "Writing Practice", btn_k_sound: "Sound Quiz", btn_k_match: "Katakana Match",
            btn_k_pair: "Hira/Kata Pair",
            btn_shiri1: "Shiritori 1", btn_shiri2: "Shiritori 2",
            btn_treasure: "Treasure Hunt", btn_aisatsu: "Greetings Quiz",
            
            btn_imasu: "Imasu<br>Arimasu",
            btn_money: "Money Learning",
            btn_transport: "Transport",

            btn_clock1: "Clock 1", btn_clock2: "Clock 2",
            btn_datetime_practice: "Date Practice", 

            btn_kanjidojo: "Writing Dojo", btn_kanjiquiz: "Kanji Quiz",
            btn_kei1: "Adjective Quiz 1", btn_kei_match: "Which one?",
            btn_kei_neg: "Negative Form",
            
            btn_verbgame: "Verb Game", btn_verbmasu: "-masu Typing", btn_verbte: "-te Typing", 
            btn_tekudasai: "V-te Kudasai", 
            btn_tekudasaimasenka: "V-te Kudasaimasenka",
            btn_mashouka: "V-mashouka",
            btn_teimasu: "V-te Imasu",
            btn_temoii: "May I...?",
            btn_kata: "How to V (V-kata)",
            
            btn_partsort: "Particle Sorter", btn_partquiz: "Particle Master", btn_sentencepuzzle: "Sentence Builder",
            btn_shoptalk: "Shopping Talk", btn_bustalk: "Business Talk",
            
            btn_sengoku: "Sengoku RPG",

            // Auth Modal
            modal_login: "Login", modal_signup: "Sign Up",
            ph_email: "Email Address", ph_pass: "Password", ph_name: "Game Name (for Ranking)",
            btn_exec: "Submit", btn_cancel: "Cancel",
            err_input_req: "Please enter email and password.",
            err_pass_len: "Password must be at least 6 characters.",
            err_name_req: "Please enter a game name (2+ chars).",
            err_name_taken: "That game name is already taken.",
            err_generic: "An error occurred during authentication.",
            err_email_taken: "Email is already in use.",
            err_auth_fail: "Incorrect email or password."
        }
    };

    const gameStructure = [
        { id: "hiragana", icon: "fa-solid fa-h", color: "#ff6f61", titleKey: "cat_hiragana", games: [
            { url: "trace_write_hiragana.html", titleKey: "btn_h_write", icon: "fa-solid fa-paintbrush" },
            { url: "hiragana_block.html", titleKey: "btn_h_sound", icon: "fa-solid fa-cube" },
            { url: "hiragana_drag_match.html", titleKey: "btn_h_match", icon: "fa-solid fa-hand-pointer" },
            { url: "hiragana.html", titleKey: "btn_h_vocab", icon: "fa-solid fa-shapes" },
            { url: "hiragana2.html", titleKey: "btn_h_reorder", icon: "fa-solid fa-sort-alpha-down" },
            { url: "meteor_quiz.html", titleKey: "btn_h_meteor", icon: "fa-solid fa-meteor" }
        ]},
        { id: "katakana", icon: "fa-solid fa-k", color: "#ffa726", titleKey: "cat_katakana", games: [
            { url: "trace_write_katakana.html", titleKey: "btn_k_write", icon: "fa-solid fa-pen-nib" },
            { url: "katakana_block.html", titleKey: "btn_k_sound", icon: "fa-solid fa-cube" }, 
            { url: "katakana_drag_match.html", titleKey: "btn_k_match", icon: "fa-solid fa-hand-pointer" },
            { url: "hira_kata_pair.html", titleKey: "btn_k_pair", icon: "fa-solid fa-right-left" }
        ]},
        { id: "shiritori", icon: "fa-solid fa-comments", color: "#fdd835", titleKey: "cat_shiritori", games: [
            { url: "shiritori.html", titleKey: "btn_shiri1", icon: "fa-solid fa-comment-dots" },
            { url: "shiritori2.html", titleKey: "btn_shiri2", icon: "fa-regular fa-comments" }
        ]},
        { id: "word_other", icon: "fa-solid fa-microphone", color: "#26c6da", titleKey: "cat_word_other", games: [
            { url: "treasure_Hunt.html", titleKey: "btn_treasure", icon: "fa-solid fa-gem" },
            { url: "aisatsu_quiz.html", titleKey: "btn_aisatsu", icon: "fa-solid fa-hand-spock" },
            { url: "imasu_arimasu.html", titleKey: "btn_imasu", icon: "fa-solid fa-cat" },
            { url: "money.html", titleKey: "btn_money", icon: "fa-solid fa-coins" },
            { url: "transport_game.html", titleKey: "btn_transport", icon: "fa-solid fa-car" },
        ]},
        { id: "clock", icon: "fa-solid fa-clock", color: "#5c6bc0", titleKey: "cat_clock", games: [
            { url: "clock.html", titleKey: "btn_clock1", icon: "fa-regular fa-clock" },
            { url: "clock2.html", titleKey: "btn_clock2", icon: "fa-solid fa-stopwatch" }
        ]},
        { id: "date_time", icon: "fa-solid fa-calendar-alt", color: "#3f51b5", titleKey: "cat_date_time", games: [
            { url: "date_time_practice.html", titleKey: "btn_datetime_practice", icon: "fa-solid fa-book-open" }
        ]},
        { id: "kanji_game", icon: "fa-solid fa-pen-fancy", color: "#42a5f5", titleKey: "cat_kanji_game", games: [
            { url: "kanji_dojo.html", titleKey: "btn_kanjidojo", icon: "fa-solid fa-paintbrush" },
            { url: "kanji_quiz.html", titleKey: "btn_kanjiquiz", icon: "fa-solid fa-scroll" },
        ]},
        { id: "keiyoshi_game", icon: "fa-solid fa-star-half-stroke", color: "#66bb6a", titleKey: "cat_keiyoshi_game", games: [
            { url: "keiyoshi_game.html", titleKey: "btn_kei_match", icon: "fa-solid fa-circle-question" },
            { url: "keiyoshi.html", titleKey: "btn_kei1", icon: "fa-solid fa-star-half-stroke" },
            { url: "keiyoshi_negative_practice.html", titleKey: "btn_kei_neg", icon: "fa-solid fa-circle-xmark" }
        ]},
        { id: "verbs", icon: "fa-solid fa-person-running", color: "#ab47bc", titleKey: "cat_verb_game", games: [
            { url: "verb.html", titleKey: "btn_verbgame", icon: "fa-solid fa-person-running" },
            { url: "verb_typing_masu.html", titleKey: "btn_verbmasu", icon: "fa-regular fa-keyboard" },
            { url: "verb_typing_te.html", titleKey: "btn_verbte", icon: "fa-solid fa-keyboard" },
            { url: "verb_tekudasai_practice.html", titleKey: "btn_tekudasai", icon: "fa-solid fa-list-check" },
            { url: "verb_tekudasaimasenka_practice.html", titleKey: "btn_tekudasaimasenka", icon: "fa-solid fa-hands-praying" },
            { url: "verb_mashouka_practice.html", titleKey: "btn_mashouka", icon: "fa-solid fa-hand-holding-heart" },
            { url: "verb_teimasu_practice.html", titleKey: "btn_teimasu", icon: "fa-solid fa-spinner" },
            { url: "verb_temoii_practice.html", titleKey: "btn_temoii", icon: "fa-solid fa-circle-check" },
            { url: "verb_kata_practice.html", titleKey: "btn_kata", icon: "fa-solid fa-screwdriver-wrench" }
        ]},
        { id: "sentence", icon: "fa-solid fa-layer-group", color: "#ec407a", titleKey: "cat_sentence", games: [
            { url: "particle_sorter.html", titleKey: "btn_partsort", icon: "fa-solid fa-filter" },
            { url: "particle_quiz.html", titleKey: "btn_partquiz", icon: "fa-solid fa-filter" },
            { url: "sentence_puzzle.html", titleKey: "btn_sentencepuzzle", icon: "fa-solid fa-layer-group" }
        ]},
        { id: "practice", icon: "fa-solid fa-store", color: "#8d6e63", titleKey: "cat_practice", games: [ 
            { url: "shopping_talk.html", titleKey: "btn_shoptalk", icon: "fa-solid fa-cart-shopping" },
            { url: "business_game.html", titleKey: "btn_bustalk", icon: "fa-solid fa-briefcase" }
        ]}
    ];

    const gameGrid = document.getElementById('game-grid');
    const backBtn = document.getElementById('game-back-btn');
    let currentLang = 'ja';

    window.renderGameCategories = () => {
        gameGrid.innerHTML = '';
        backBtn.style.display = 'none';
        // group_learning ã‚’ä½¿ç”¨
        document.getElementById('game-section-title').textContent = i18nData[currentLang].group_learning;

        gameStructure.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'game-card';
            div.style.borderColor = cat.color;
            div.onclick = () => renderGameList(cat);
            
            const title = i18nData[currentLang][cat.titleKey] || cat.titleKey;
            
            div.innerHTML = `
                <i class="${cat.icon} card-icon" style="color:${cat.color}"></i>
                <span class="card-title">${title}</span>
                <span style="font-size:0.8em; color:#999; margin-top:5px; font-weight:bold;">${cat.games.length} Games</span>
            `;
            gameGrid.appendChild(div);
        });
        gameGrid.classList.remove('fade-in');
        void gameGrid.offsetWidth;
        gameGrid.classList.add('fade-in');
    };

    function renderGameList(category) {
        gameGrid.innerHTML = '';
        backBtn.style.display = 'block';
        document.getElementById('game-section-title').textContent = i18nData[currentLang][category.titleKey];

        category.games.forEach(game => {
            const a = document.createElement('a');
            a.href = game.url;
            a.className = 'game-card';
            a.style.borderColor = category.color;

            const gameTitle = i18nData[currentLang][game.titleKey] || game.title;
            
            a.innerHTML = `
                <i class="${game.icon} card-icon" style="color:${category.color}"></i>
                <span class="card-title">${gameTitle}</span>
            `;
            gameGrid.appendChild(a);
        });
        gameGrid.classList.remove('fade-in');
        void gameGrid.offsetWidth;
        gameGrid.classList.add('fade-in');
    }

    window.setLanguage = (lang) => {
        currentLang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if(i18nData[lang][key]) el.textContent = i18nData[lang][key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            if(i18nData[lang][key]) el.placeholder = i18nData[lang][key];
        });

        document.getElementById('lang-ja').classList.toggle('active', lang === 'ja');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        
        if(backBtn.style.display === 'none') renderGameCategories();
        else renderGameCategories(); 

        if(document.getElementById('auth-modal').style.display === 'flex') {
             const modeKey = window.authMode === 'login' ? 'modal_login' : 'modal_signup';
             document.getElementById('modal-title').textContent = i18nData[lang][modeKey];
             document.getElementById('modal-submit').textContent = i18nData[lang]['btn_exec'];
        }
    };
    
    // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    renderGameCategories();
</script>
</body>
</html>