<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>戦国・日本語伝</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-paper: #f3e5ab;
        --urushi-red: #b71c1c;
        --indigo: #1a237e;
        --gold: #ffd700;
        --ink: #212121;
    }

    body {
        font-family: 'Yuji Syuku', serif;
        background-color: var(--bg-paper);
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        margin: 0; padding: 0;
        height: 100vh; overflow: hidden;
        color: var(--ink);
        display: flex; flex-direction: column;
    }

    header {
        background: var(--ink); color: #fff;
        padding: 10px 20px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 4px solid var(--gold);
        z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .game-title { font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
    
    /* 言語切り替えスイッチ */
    .lang-switch {
        background: #3e2723; border: 1px solid var(--gold);
        color: var(--gold); padding: 5px; border-radius: 5px;
        font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
    }

    .header-right { display: flex; gap: 15px; align-items: center; }
    .status-item { color: var(--gold); font-size: 0.9em; }

    /* --- マップ共通 --- */
    .map-wrapper {
        flex-grow: 1;
        overflow-x: auto; overflow-y: hidden;
        white-space: nowrap;
        position: relative;
        display: flex; align-items: center;
        padding: 0 100px;
        background: radial-gradient(circle at center, #fff8e1 0%, #d7ccc8 100%);
        cursor: grab;
    }
    .map-wrapper:active { cursor: grabbing; }

    .path {
        position: absolute; top: 60%; left: 0;
        height: 8px; background: #5d4037;
        z-index: 0; border-top: 2px dashed #8d6e63;
    }

    /* --- ノード --- */
    .node-container {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: flex-end;
        width: 180px; height: 300px;
        margin-right: 80px;
        position: relative;
        z-index: 2; vertical-align: bottom;
        transition: transform 0.2s;
        cursor: not-allowed; opacity: 0.6; filter: grayscale(80%);
    }

    .node-container.unlocked {
        cursor: pointer; opacity: 1; filter: grayscale(0%);
    }
    .node-container.unlocked:hover { transform: scale(1.05); }

    .node-icon-area {
        position: relative; display: flex; justify-content: center; align-items: flex-end;
        height: 180px; width: 100%;
    }
    .node-img {
        color: #5d4037; filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.2));
        transition: color 0.3s;
    }
    
    .size-s { font-size: 4em; } 
    .size-m { font-size: 6em; } 
    .size-l { font-size: 8em; } 
    .size-xl { font-size: 10em; color: var(--urushi-red); filter: drop-shadow(0 0 10px var(--gold)); }

    .node-label {
        background: var(--ink); color: #fff;
        padding: 5px 10px; border-radius: 5px;
        margin-top: 10px; text-align: center;
        border: 2px solid var(--gold);
        font-size: 1em; white-space: normal; width: 140px;
    }
    .node-sub { font-size: 0.7em; color: #bdbdbd; display: block; }

    .flag {
        position: absolute; top: 0; right: 20px;
        font-size: 2em; color: var(--gold);
        display: none; text-shadow: 2px 2px 0 #000;
        animation: wave 2s infinite ease-in-out;
    }
    .node-container.cleared .flag { display: block; }
    .node-container.cleared .node-img { color: var(--urushi-red); }

    @keyframes wave { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }

    /* --- アバター --- */
    #hero-avatar {
        position: absolute; top: 40%; left: 100px;
        width: 80px; height: 80px;
        z-index: 10; pointer-events: none;
        transition: left 0.8s ease-in-out;
    }
    .avatar-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
    .layer-body { font-size: 4em; color: #333; }
    .layer-armor { font-size: 2.5em; color: #555; margin-top: 15px; }
    .layer-helm { font-size: 2em; color: #555; margin-top: -30px; }
    .layer-weapon { font-size: 2.5em; color: #aaa; margin-left: 40px; margin-top: 10px; transform: rotate(15deg); }

    .walking { animation: hop 0.3s infinite alternate; }
    @keyframes hop { from { transform: translateY(0); } to { transform: translateY(-10px); } }

    /* --- 蔵 --- */
    .kura-btn {
        position: fixed; bottom: 30px; right: 30px;
        width: 80px; height: 80px;
        background: var(--urushi-red); color: white;
        border-radius: 50%; border: 4px solid var(--gold);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        font-size: 2em; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 90;
    }
    .kura-label { font-size: 0.4em; font-weight: bold; margin-top: -5px; }

    /* --- モーダル --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200;
        display: none; justify-content: center; align-items: center;
    }
    .kura-box {
        width: 90%; max-width: 600px; height: 80%;
        background: #fff8e1; border: 8px solid #5d4037;
        border-radius: 10px; padding: 20px;
        display: flex; flex-direction: column;
        position: relative;
    }
    .item-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px; overflow-y: auto; flex-grow: 1; padding: 10px;
    }
    .item-slot {
        background: #d7ccc8; border: 3px solid #a1887f;
        aspect-ratio: 1; border-radius: 8px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; position: relative;
    }
    .item-slot.equipped { border-color: var(--urushi-red); background: #ffccbc; }
    .item-slot.equipped::after { content: "装備中"; position: absolute; bottom: 0; font-size: 0.6em; background: var(--urushi-red); color: white; width: 100%; text-align: center; }
    .item-icon { font-size: 3em; }

</style>
</head>
<body>

<header>
    <div class="game-title"><i class="fa-solid fa-khanda"></i> 天下統一</div>
    
    <div class="header-right">
        <select id="lang-select" class="lang-switch" onchange="changeLang(this.value)">
            <option value="hiragana">ひらがな</option>
            <option value="kanji">漢字</option>
            <option value="en">English</option>
        </select>

        <div class="status-item"><i class="fa-solid fa-coins"></i> <span id="money-display">0</span> 両</div>
        <button onclick="goBack()" style="background:none; border:1px solid #fff; color:#fff; padding:5px 10px; cursor:pointer;">戻る</button>
    </div>
</header>

<div class="map-wrapper" id="map-scroll">
    <div class="path" id="path-line"></div>
    
    <div id="hero-avatar">
        <div class="avatar-layer layer-body"><i class="fa-solid fa-user"></i></div>
        <div class="avatar-layer layer-armor" id="vis-armor"></div>
        <div class="avatar-layer layer-helm" id="vis-helm"></div>
        <div class="avatar-layer layer-weapon" id="vis-weapon"></div>
    </div>

    <div id="nodes-container" style="display:flex; align-items:flex-end; height:100%; padding-bottom: 50px;"></div>
</div>

<div class="kura-btn" onclick="openKura()">
    <i class="fa-solid fa-warehouse"></i>
    <span class="kura-label">蔵</span>
</div>

<div class="modal-overlay" id="kura-modal">
    <div class="kura-box">
        <h2 style="text-align:center; margin:0 0 20px 0; color:#5d4037;">所持品一覧</h2>
        <div class="item-grid" id="inventory-grid"></div>
        <button onclick="closeKura()" style="margin-top:10px; padding:15px; background:var(--ink); color:white; border:none; font-size:1.2em; cursor:pointer;">閉じる</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebaseapp.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;

    // --- データ定義 ---
    const CATEGORIES = {
        // --- Lv.1 たべもの (Food) ---
        1: { title: "たべもの", words: [
            {hiragana:"おすし", kanji:"お寿司", en:"Sushi", icon:"fa-solid fa-fish"}, 
            {hiragana:"ラーメン", kanji:"ラーメン", en:"Ramen", icon:"fa-solid fa-bowl-food"},
            {hiragana:"うどん", kanji:"うどん", en:"Udon", icon:"fa-solid fa-bowl-rice"}, 
            {hiragana:"おにぎり", kanji:"おにぎり", en:"Rice Ball", icon:"fa-solid fa-mountain"},
            {hiragana:"てんぷら", kanji:"天ぷら", en:"Tempura", icon:"fa-solid fa-shrimp"}, 
            {hiragana:"たこやき", kanji:"たこ焼き", en:"Takoyaki", icon:"fa-solid fa-circle-dot"},
            {hiragana:"なっとう", kanji:"納豆", en:"Natto", icon:"fa-solid fa-jar"}, 
            {hiragana:"みそしる", kanji:"味噌汁", en:"Miso Soup", icon:"fa-solid fa-mug-hot"},
            {hiragana:"やきとり", kanji:"焼き鳥", en:"Yakitori", icon:"fa-solid fa-drumstick-bite"},
            {hiragana:"ぎゅうどん", kanji:"牛丼", en:"Beef Bowl", icon:"fa-solid fa-bowl-food"},
            {hiragana:"カレー", kanji:"カレー", en:"Curry", icon:"fa-solid fa-utensil-spoon"},
            {hiragana:"オムライス", kanji:"オムライス", en:"Omelette Rice", icon:"fa-solid fa-egg"},
            {hiragana:"だんご", kanji:"団子", en:"Dango", icon:"fa-solid fa-ellipsis"},
            {hiragana:"たいやき", kanji:"たい焼き", en:"Taiyaki", icon:"fa-solid fa-fish"},
            {hiragana:"そば", kanji:"そば", en:"Soba", icon:"fa-solid fa-bacon"}, 
            {hiragana:"さしみ", kanji:"刺身", en:"Sashimi", icon:"fa-solid fa-fish-fins"},
            {hiragana:"もち", kanji:"餅", en:"Mochi", icon:"fa-solid fa-circle"},
            {hiragana:"おちゃ", kanji:"お茶", en:"Green Tea", icon:"fa-solid fa-leaf"},
            {hiragana:"おべんとう", kanji:"お弁当", en:"Bento", icon:"fa-solid fa-box-open"},
            {hiragana:"すきやき", kanji:"すき焼き", en:"Sukiyaki", icon:"fa-solid fa-fire-burner"}
        ]},

        // --- Lv.2 あいさつ (Greeting) ---
        2: { title: "あいさつ", words: [
            {hiragana:"おはよう", kanji:"おはよう", en:"Good Morning", icon:"fa-solid fa-sun"},
            {hiragana:"こんにちは", kanji:"こんにちは", en:"Hello", icon:"fa-regular fa-hand-spock"},
            {hiragana:"こんばんは", kanji:"こんばんは", en:"Good Evening", icon:"fa-solid fa-moon"},
            {hiragana:"おやすみ", kanji:"おやすみ", en:"Good Night", icon:"fa-solid fa-bed"},
            {hiragana:"ありがとう", kanji:"ありがとう", en:"Thank you", icon:"fa-solid fa-heart"},
            {hiragana:"ごめんね", kanji:"ごめんね", en:"Sorry", icon:"fa-solid fa-face-sad-tear"},
            {hiragana:"いただきます", kanji:"頂きます", en:"Let's eat", icon:"fa-solid fa-utensils"},
            {hiragana:"ごちそうさま", kanji:"ご馳走様", en:"Thanks for food", icon:"fa-solid fa-check"},
            {hiragana:"いってきます", kanji:"行ってきます", en:"I'm leaving", icon:"fa-solid fa-person-walking-arrow-right"},
            {hiragana:"いってらっしゃい", kanji:"行ってらっしゃい", en:"See you", icon:"fa-solid fa-hand"},
            {hiragana:"ただいま", kanji:"ただいま", en:"I'm home", icon:"fa-solid fa-house-user"},
            {hiragana:"おかえり", kanji:"おかえり", en:"Welcome back", icon:"fa-solid fa-door-open"},
            {hiragana:"バイバイ", kanji:"バイバイ", en:"Bye Bye", icon:"fa-solid fa-hand-peace"},
            {hiragana:"またね", kanji:"またね", en:"See you later", icon:"fa-solid fa-calendar-check"},
            {hiragana:"はじめまして", kanji:"初めまして", en:"Nice to meet you", icon:"fa-solid fa-handshake"},
            {hiragana:"よろしく", kanji:"よろしく", en:"Please treat me well", icon:"fa-solid fa-circle-check"},
            {hiragana:"はい", kanji:"はい", en:"Yes", icon:"fa-solid fa-check"},
            {hiragana:"いいえ", kanji:"いいえ", en:"No", icon:"fa-solid fa-xmark"},
            {hiragana:"おねがい", kanji:"お願い", en:"Please", icon:"fa-solid fa-hands-praying"},
            {hiragana:"かんぱい", kanji:"乾杯", en:"Cheers", icon:"fa-solid fa-beer-mug-empty"}
        ]},

        // --- Lv.3 がっこう (School) ---
        3: { title: "がっこう", words: [
            {hiragana:"せんせい", kanji:"先生", en:"Teacher", icon:"fa-solid fa-chalkboard-user"},
            {hiragana:"がくせい", kanji:"学生", en:"Student", icon:"fa-solid fa-child"},
            {hiragana:"えんぴつ", kanji:"鉛筆", en:"Pencil", icon:"fa-solid fa-pencil"},
            {hiragana:"けしごむ", kanji:"消しゴム", en:"Eraser", icon:"fa-solid fa-eraser"},
            {hiragana:"ノート", kanji:"ノート", en:"Notebook", icon:"fa-solid fa-book"},
            {hiragana:"きょうかしょ", kanji:"教科書", en:"Textbook", icon:"fa-solid fa-book-open"},
            {hiragana:"ランドセル", kanji:"ランドセル", en:"School Bag", icon:"fa-solid fa-suitcase"},
            {hiragana:"つくえ", kanji:"机", en:"Desk", icon:"fa-solid fa-table"},
            {hiragana:"いす", kanji:"椅子", en:"Chair", icon:"fa-solid fa-chair"},
            {hiragana:"こくばん", kanji:"黒板", en:"Blackboard", icon:"fa-solid fa-chalkboard"},
            {hiragana:"きょうしつ", kanji:"教室", en:"Classroom", icon:"fa-solid fa-school"},
            {hiragana:"きゅうしょく", kanji:"給食", en:"School Lunch", icon:"fa-solid fa-utensils"},
            {hiragana:"テスト", kanji:"テスト", en:"Test", icon:"fa-solid fa-file-pen"},
            {hiragana:"しゅくだい", kanji:"宿題", en:"Homework", icon:"fa-solid fa-house-laptop"},
            {hiragana:"ともだち", kanji:"友達", en:"Friend", icon:"fa-solid fa-user-group"},
            {hiragana:"はさみ", kanji:"ハサミ", en:"Scissors", icon:"fa-solid fa-scissors"},
            {hiragana:"のり", kanji:"のり", en:"Glue", icon:"fa-solid fa-bottle-droplet"},
            {hiragana:"じょうぎ", kanji:"定規", en:"Ruler", icon:"fa-solid fa-ruler-horizontal"},
            {hiragana:"とけい", kanji:"時計", en:"Clock", icon:"fa-solid fa-clock"},
            {hiragana:"チャイム", kanji:"チャイム", en:"Bell", icon:"fa-solid fa-bell"}
        ]},

        // --- Lv.4 おうち (Home) ---
        4: { title: "おうち", words: [
            {hiragana:"いえ", kanji:"家", en:"House", icon:"fa-solid fa-house"},
            {hiragana:"へや", kanji:"部屋", en:"Room", icon:"fa-solid fa-door-open"},
            {hiragana:"だいどころ", kanji:"台所", en:"Kitchen", icon:"fa-solid fa-kitchen-set"},
            {hiragana:"おふろ", kanji:"お風呂", en:"Bath", icon:"fa-solid fa-bath"},
            {hiragana:"トイレ", kanji:"トイレ", en:"Toilet", icon:"fa-solid fa-toilet"},
            {hiragana:"テレビ", kanji:"テレビ", en:"TV", icon:"fa-solid fa-tv"},
            {hiragana:"ベッド", kanji:"ベッド", en:"Bed", icon:"fa-solid fa-bed"},
            {hiragana:"ソファー", kanji:"ソファー", en:"Sofa", icon:"fa-solid fa-couch"},
            {hiragana:"まど", kanji:"窓", en:"Window", icon:"fa-regular fa-window-maximize"},
            {hiragana:"れいぞうこ", kanji:"冷蔵庫", en:"Fridge", icon:"fa-solid fa-snowflake"},
            {hiragana:"せんたくき", kanji:"洗濯機", en:"Washing Machine", icon:"fa-solid fa-shirt"},
            {hiragana:"テーブル", kanji:"テーブル", en:"Table", icon:"fa-solid fa-table"},
            {hiragana:"かぎ", kanji:"鍵", en:"Key", icon:"fa-solid fa-key"},
            {hiragana:"でんわ", kanji:"電話", en:"Phone", icon:"fa-solid fa-phone"},
            {hiragana:"でんき", kanji:"電気", en:"Light", icon:"fa-solid fa-lightbulb"},
            {hiragana:"かいだん", kanji:"階段", en:"Stairs", icon:"fa-solid fa-stairs"},
            {hiragana:"にわ", kanji:"庭", en:"Garden", icon:"fa-solid fa-tree"},
            {hiragana:"かぞく", kanji:"家族", en:"Family", icon:"fa-solid fa-people-roof"},
            {hiragana:"ねこ", kanji:"猫", en:"Cat", icon:"fa-solid fa-cat"},
            {hiragana:"いぬ", kanji:"犬", en:"Dog", icon:"fa-solid fa-dog"}
        ]},

        // --- Lv.5 しぜん (Nature) ---
        5: { title: "しぜん", words: [
            {hiragana:"やま", kanji:"山", en:"Mountain", icon:"fa-solid fa-mountain"},
            {hiragana:"かわ", kanji:"川", en:"River", icon:"fa-solid fa-water"},
            {hiragana:"うみ", kanji:"海", en:"Sea", icon:"fa-solid fa-umbrella-beach"},
            {hiragana:"そら", kanji:"空", en:"Sky", icon:"fa-solid fa-cloud-sun"},
            {hiragana:"たいよう", kanji:"太陽", en:"Sun", icon:"fa-solid fa-sun"},
            {hiragana:"つき", kanji:"月", en:"Moon", icon:"fa-solid fa-moon"},
            {hiragana:"ほし", kanji:"星", en:"Star", icon:"fa-solid fa-star"},
            {hiragana:"くも", kanji:"雲", en:"Cloud", icon:"fa-solid fa-cloud"},
            {hiragana:"あめ", kanji:"雨", en:"Rain", icon:"fa-solid fa-cloud-rain"},
            {hiragana:"ゆき", kanji:"雪", en:"Snow", icon:"fa-regular fa-snowflake"},
            {hiragana:"き", kanji:"木", en:"Tree", icon:"fa-solid fa-tree"},
            {hiragana:"はな", kanji:"花", en:"Flower", icon:"fa-solid fa-plant-wilt"}, // Plant icon
            {hiragana:"はっぱ", kanji:"葉っぱ", en:"Leaf", icon:"fa-solid fa-leaf"},
            {hiragana:"むし", kanji:"虫", en:"Bug", icon:"fa-solid fa-bug"},
            {hiragana:"とり", kanji:"鳥", en:"Bird", icon:"fa-solid fa-crow"},
            {hiragana:"さかな", kanji:"魚", en:"Fish", icon:"fa-solid fa-fish"},
            {hiragana:"かぜ", kanji:"風", en:"Wind", icon:"fa-solid fa-wind"},
            {hiragana:"ひ", kanji:"火", en:"Fire", icon:"fa-solid fa-fire"},
            {hiragana:"いし", kanji:"石", en:"Stone", icon:"fa-solid fa-gem"},
            {hiragana:"にじ", kanji:"虹", en:"Rainbow", icon:"fa-solid fa-rainbow"}
        ]},

        // --- Lv.6 からだ (Body) ---
        6: { title: "からだ", words: [
            {hiragana:"あたま", kanji:"頭", en:"Head", icon:"fa-solid fa-user"},
            {hiragana:"め", kanji:"目", en:"Eye", icon:"fa-regular fa-eye"},
            {hiragana:"みみ", kanji:"耳", en:"Ear", icon:"fa-solid fa-ear-listen"},
            {hiragana:"くち", kanji:"口", en:"Mouth", icon:"fa-regular fa-face-smile"},
            {hiragana:"はな", kanji:"鼻", en:"Nose", icon:"fa-regular fa-face-flushed"},
            {hiragana:"て", kanji:"手", en:"Hand", icon:"fa-regular fa-hand"},
            {hiragana:"あし", kanji:"足", en:"Foot/Leg", icon:"fa-solid fa-shoe-prints"},
            {hiragana:"ゆび", kanji:"指", en:"Finger", icon:"fa-solid fa-hand-point-up"},
            {hiragana:"おなか", kanji:"お腹", en:"Stomach", icon:"fa-solid fa-person-pregnant"}, // Approximate
            {hiragana:"せなか", kanji:"背中", en:"Back", icon:"fa-solid fa-person-walking"},
            {hiragana:"は", kanji:"歯", en:"Tooth", icon:"fa-solid fa-tooth"},
            {hiragana:"かみのけ", kanji:"髪の毛", en:"Hair", icon:"fa-solid fa-user-hair-long"}, // Approximate
            {hiragana:"かお", kanji:"顔", en:"Face", icon:"fa-solid fa-face-smile"},
            {hiragana:"うで", kanji:"腕", en:"Arm", icon:"fa-solid fa-dumbbell"},
            {hiragana:"くび", kanji:"首", en:"Neck", icon:"fa-solid fa-user-tie"},
            {hiragana:"ひざ", kanji:"膝", en:"Knee", icon:"fa-solid fa-person-kneeling"},
            {hiragana:"しんぞう", kanji:"心臓", en:"Heart", icon:"fa-solid fa-heart-pulse"},
            {hiragana:"ち", kanji:"血", en:"Blood", icon:"fa-solid fa-droplet"},
            {hiragana:"ほね", kanji:"骨", en:"Bone", icon:"fa-solid fa-bone"},
            {hiragana:"こえ", kanji:"声", en:"Voice", icon:"fa-solid fa-microphone"}
        ]},

        // --- Lv.7 いろ・かず (Colors & Numbers) ---
        7: { title: "いろ・かず", words: [
            {hiragana:"あか", kanji:"赤", en:"Red", icon:"fa-solid fa-circle", color:"#f44336"},
            {hiragana:"あお", kanji:"青", en:"Blue", icon:"fa-solid fa-circle", color:"#2196f3"},
            {hiragana:"きいろ", kanji:"黄色", en:"Yellow", icon:"fa-solid fa-circle", color:"#ffeb3b"},
            {hiragana:"みどり", kanji:"緑", en:"Green", icon:"fa-solid fa-circle", color:"#4caf50"},
            {hiragana:"くろ", kanji:"黒", en:"Black", icon:"fa-solid fa-circle", color:"#000000"},
            {hiragana:"しろ", kanji:"白", en:"White", icon:"fa-regular fa-circle", color:"#ffffff"},
            {hiragana:"いち", kanji:"一", en:"One", icon:"fa-solid fa-1"},
            {hiragana:"に", kanji:"二", en:"Two", icon:"fa-solid fa-2"},
            {hiragana:"さん", kanji:"三", en:"Three", icon:"fa-solid fa-3"},
            {hiragana:"よん", kanji:"四", en:"Four", icon:"fa-solid fa-4"},
            {hiragana:"ご", kanji:"五", en:"Five", icon:"fa-solid fa-5"},
            {hiragana:"ろく", kanji:"六", en:"Six", icon:"fa-solid fa-6"},
            {hiragana:"なな", kanji:"七", en:"Seven", icon:"fa-solid fa-7"},
            {hiragana:"はち", kanji:"八", en:"Eight", icon:"fa-solid fa-8"},
            {hiragana:"きゅう", kanji:"九", en:"Nine", icon:"fa-solid fa-9"},
            {hiragana:"じゅう", kanji:"十", en:"Ten", icon:"fa-solid fa-1+0"}, // Approximate
            {hiragana:"ひゃく", kanji:"百", en:"Hundred", icon:"fa-solid fa-c"}, // C is 100 roman
            {hiragana:"まる", kanji:"丸", en:"Circle", icon:"fa-regular fa-circle"},
            {hiragana:"しかく", kanji:"四角", en:"Square", icon:"fa-regular fa-square"},
            {hiragana:"さんかく", kanji:"三角", en:"Triangle", icon:"fa-solid fa-play", color:"#333"} // Play looks like triangle
        ]},

        // --- Lv.8 でんとう (Tradition) ---
        8: { title: "でんとう", words: [
            {hiragana:"きもの", kanji:"着物", en:"Kimono", icon:"fa-solid fa-user-tie"},
            {hiragana:"げた", kanji:"下駄", en:"Geta", icon:"fa-solid fa-shoe-prints"},
            {hiragana:"はし", kanji:"箸", en:"Chopsticks", icon:"fa-solid fa-utensils"},
            {hiragana:"たたみ", kanji:"畳", en:"Tatami", icon:"fa-solid fa-border-all"},
            {hiragana:"じんじゃ", kanji:"神社", en:"Shrine", icon:"fa-solid fa-torii-gate"},
            {hiragana:"おてら", kanji:"お寺", en:"Temple", icon:"fa-solid fa-gopuram"}, // Approximate
            {hiragana:"にんじゃ", kanji:"忍者", en:"Ninja", icon:"fa-solid fa-user-ninja"},
            {hiragana:"さむらい", kanji:"侍", en:"Samurai", icon:"fa-solid fa-khanda"},
            {hiragana:"すもう", kanji:"相撲", en:"Sumo", icon:"fa-solid fa-users"},
            {hiragana:"おまつり", kanji:"お祭り", en:"Festival", icon:"fa-solid fa-drum"},
            {hiragana:"はなび", kanji:"花火", en:"Fireworks", icon:"fa-solid fa-explosion"},
            {hiragana:"さくら", kanji:"桜", en:"Cherry Blossom", icon:"fa-solid fa-fan"},
            {hiragana:"おんせん", kanji:"温泉", en:"Hot Spring", icon:"fa-solid fa-hot-tub-person"},
            {hiragana:"せんす", kanji:"扇子", en:"Fan", icon:"fa-solid fa-fan"},
            {hiragana:"おめん", kanji:"お面", en:"Mask", icon:"fa-solid fa-mask"},
            {hiragana:"かんじ", kanji:"漢字", en:"Kanji", icon:"fa-solid fa-font"},
            {hiragana:"さどう", kanji:"茶道", en:"Tea Ceremony", icon:"fa-solid fa-mug-hot"},
            {hiragana:"おりがみ", kanji:"折り紙", en:"Origami", icon:"fa-solid fa-note-sticky"},
            {hiragana:"ふじさん", kanji:"富士山", en:"Mt. Fuji", icon:"fa-solid fa-mountain-sun"},
            {hiragana:"おまもり", kanji:"お守り", en:"Charm", icon:"fa-solid fa-bag-shopping"}
        ]},

        // --- Lv.9 あそび (Play) ---
        9: { title: "あそび", words: [
            {hiragana:"ゲーム", kanji:"ゲーム", en:"Game", icon:"fa-solid fa-gamepad"},
            {hiragana:"ボール", kanji:"ボール", en:"Ball", icon:"fa-solid fa-baseball"},
            {hiragana:"にんぎょう", kanji:"人形", en:"Doll", icon:"fa-solid fa-robot"},
            {hiragana:"ふうせん", kanji:"風船", en:"Balloon", icon:"fa-solid fa-soap"}, // Approximate
            {hiragana:"すべりだい", kanji:"滑り台", en:"Slide", icon:"fa-solid fa-stairs"},
            {hiragana:"ブランコ", kanji:"ブランコ", en:"Swing", icon:"fa-solid fa-anchor"}, // Approximate
            {hiragana:"こうえん", kanji:"公園", en:"Park", icon:"fa-solid fa-tree"},
            {hiragana:"はしる", kanji:"走る", en:"Run", icon:"fa-solid fa-person-running"},
            {hiragana:"ジャンプ", kanji:"ジャンプ", en:"Jump", icon:"fa-solid fa-arrow-up"},
            {hiragana:"うたう", kanji:"歌う", en:"Sing", icon:"fa-solid fa-microphone"},
            {hiragana:"おどる", kanji:"踊る", en:"Dance", icon:"fa-solid fa-music"},
            {hiragana:"おえかき", kanji:"お絵かき", en:"Drawing", icon:"fa-solid fa-palette"},
            {hiragana:"えほん", kanji:"絵本", en:"Picture Book", icon:"fa-solid fa-book-open"},
            {hiragana:"プール", kanji:"プール", en:"Pool", icon:"fa-solid fa-water-ladder"},
            {hiragana:"サッカー", kanji:"サッカー", en:"Soccer", icon:"fa-solid fa-futbol"},
            {hiragana:"やきゅう", kanji:"野球", en:"Baseball", icon:"fa-solid fa-baseball-bat-ball"},
            {hiragana:"ピアノ", kanji:"ピアノ", en:"Piano", icon:"fa-solid fa-music"},
            {hiragana:"ギター", kanji:"ギター", en:"Guitar", icon:"fa-solid fa-guitar"},
            {hiragana:"カメラ", kanji:"カメラ", en:"Camera", icon:"fa-solid fa-camera"},
            {hiragana:"りょこう", kanji:"旅行", en:"Travel", icon:"fa-solid fa-plane"}
        ]},

        // --- Lv.10 ばしょ (Places) ---
        10: { title: "ばしょ", words: [
            {hiragana:"えき", kanji:"駅", en:"Station", icon:"fa-solid fa-train"},
            {hiragana:"でんしゃ", kanji:"電車", en:"Train", icon:"fa-solid fa-train-subway"},
            {hiragana:"バス", kanji:"バス", en:"Bus", icon:"fa-solid fa-bus"},
            {hiragana:"くるま", kanji:"車", en:"Car", icon:"fa-solid fa-car"},
            {hiragana:"ひこうき", kanji:"飛行機", en:"Airplane", icon:"fa-solid fa-plane-up"},
            {hiragana:"くうこう", kanji:"空港", en:"Airport", icon:"fa-solid fa-plane-arrival"},
            {hiragana:"びょういん", kanji:"病院", en:"Hospital", icon:"fa-solid fa-hospital"},
            {hiragana:"こうばん", kanji:"交番", en:"Police Box", icon:"fa-solid fa-building-shield"},
            {hiragana:"ゆうびんきょく", kanji:"郵便局", en:"Post Office", icon:"fa-solid fa-envelope"},
            {hiragana:"コンビニ", kanji:"コンビニ", en:"Conv. Store", icon:"fa-solid fa-store"},
            {hiragana:"スーパー", kanji:"スーパー", en:"Supermarket", icon:"fa-solid fa-cart-shopping"},
            {hiragana:"レストラン", kanji:"レストラン", en:"Restaurant", icon:"fa-solid fa-utensils"},
            {hiragana:"ホテル", kanji:"ホテル", en:"Hotel", icon:"fa-solid fa-hotel"},
            {hiragana:"としょかん", kanji:"図書館", en:"Library", icon:"fa-solid fa-book"},
            {hiragana:"ぎんこう", kanji:"銀行", en:"Bank", icon:"fa-solid fa-building-columns"},
            {hiragana:"はし", kanji:"橋", en:"Bridge", icon:"fa-solid fa-archway"},
            {hiragana:"みち", kanji:"道", en:"Street", icon:"fa-solid fa-road"},
            {hiragana:"まち", kanji:"町", en:"Town", icon:"fa-solid fa-city"},
            {hiragana:"うみ", kanji:"海", en:"Sea", icon:"fa-solid fa-water"},
            {hiragana:"にほん", kanji:"日本", en:"Japan", icon:"fa-solid fa-map"}
        ]}
    };

    window.ITEM_DB = {
    // --- 頭 (Helm) ---
    'helm_1': { type: 'helm', name: '足軽の笠', icon: 'fa-solid fa-hat-cowboy', rarity: 'common', color: '#8d6e63' },
    'helm_2': { type: 'helm', name: '赤備えの兜', icon: 'fa-solid fa-helmet-safety', rarity: 'rare', color: '#d32f2f' },
    'helm_3': { type: 'helm', name: '三日月の兜', icon: 'fa-brands fa-fort-awesome', rarity: 'legend', color: '#ffd700' },
    'helm_nobu': { type: 'helm', name: '魔王の兜', icon: 'fa-solid fa-crown', rarity: 'legend', color: '#212121' },
    'helm_hide': { type: 'helm', name: '日輪の兜', icon: 'fa-solid fa-sun', rarity: 'legend', color: '#ffca28' },
    'helm_ninja': { type: 'helm', name: '忍び頭巾', icon: 'fa-solid fa-user-ninja', rarity: 'rare', color: '#424242' },

    // --- 体 (Armor) ---
    'armor_1': { type: 'armor', name: 'ボロの着物', icon: 'fa-solid fa-shirt', rarity: 'common', color: '#d7ccc8' },
    'armor_2': { type: 'armor', name: '侍の鎧', icon: 'fa-solid fa-shield-halved', rarity: 'rare', color: '#1a237e' },
    'armor_nobu': { type: 'armor', name: '南蛮マント', icon: 'fa-solid fa-user-secret', rarity: 'legend', color: '#b71c1c' },
    'armor_ninja': { type: 'armor', name: '忍び装束', icon: 'fa-solid fa-user-large', rarity: 'rare', color: '#000000' },

    // --- 武器 (Weapon) ---
    'weapon_1': { type: 'weapon', name: '竹刀', icon: 'fa-solid fa-candy-cane', rarity: 'common', color: '#a1887f' },
    'weapon_2': { type: 'weapon', name: '名刀・虎徹', icon: 'fa-solid fa-khanda', rarity: 'rare', color: '#cfd8dc' },
    'weapon_3': { type: 'weapon', name: '妖刀・村正', icon: 'fa-solid fa-fire', rarity: 'legend', color: '#d50000' },
    'weapon_gun': { type: 'weapon', name: '火縄銃', icon: 'fa-solid fa-gun', rarity: 'rare', color: '#5d4037' },
    'weapon_fan': { type: 'weapon', name: '軍配', icon: 'fa-solid fa-fan', rarity: 'rare', color: '#fbc02d' },
    'weapon_shuri': { type: 'weapon', name: '手裏剣', icon: 'fa-solid fa-star', rarity: 'common', color: '#757575' }
};

    let userState = { level: 1, subLevel: 1, inventory: ['helm_1', 'armor_1', 'weapon_1'], equipped: { helm: 'helm_1', armor: 'armor_1', weapon: 'weapon_1' }, money: 100 };

    const nodesContainer = document.getElementById('nodes-container');
    const heroAvatar = document.getElementById('hero-avatar');
    const pathLine = document.getElementById('path-line');
    
    let currentView = 'world';
    let selectedRegionId = null;

    // 言語設定の初期化
    const savedLang = localStorage.getItem('culture_lang') || 'hiragana';
    document.getElementById('lang-select').value = savedLang;

    // 言語変更
    window.changeLang = (lang) => {
        localStorage.setItem('culture_lang', lang);
        // マップ再描画（ラベルなどに適用する場合）
        // 現状のマップは日本語固定ですが、レッスン画面に影響します
        alert("ことばの設定を変更しました。");
    };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            const snap = await getDoc(doc(db, "users", user.uid, "progress", "sengoku_rpg_v2"));
            if (snap.exists()) userState = snap.data();
        } else {
            const saved = sessionStorage.getItem('sengoku_save_v2');
            if (saved) userState = JSON.parse(saved);
        }
        renderWorldMap();
        updateAvatar();
        document.getElementById('money-display').innerText = userState.money || 0;
    });

    function renderWorldMap() {
        currentView = 'world';
        nodesContainer.innerHTML = '';
        pathLine.style.width = `${WARLORDS.length * 260}px`;

        WARLORDS.forEach((lord, index) => {
            const node = createNode(
                lord.id, 
                lord.name, 
                lord.title,
                'fa-solid fa-chess-rook',
                'size-l',
                (lord.id <= userState.level),
                (lord.id < userState.level)
            );
            
            if (node.classList.contains('unlocked')) {
                node.onclick = () => {
                    moveAvatarTo(index);
                    setTimeout(() => renderRegionMap(lord), 800);
                };
            }
            nodesContainer.appendChild(node);
        });
        setTimeout(() => moveAvatarTo(userState.level - 1, false), 100);
    }

    function renderRegionMap(lord) {
        currentView = 'region';
        selectedRegionId = lord.id;
        nodesContainer.innerHTML = '';
        
        const STAGE_COUNT = 10;
        pathLine.style.width = `${STAGE_COUNT * 260}px`;
        heroAvatar.style.left = '100px'; 
        document.getElementById('map-scroll').scrollLeft = 0;

        for (let i = 1; i <= STAGE_COUNT; i++) {
            let sizeClass = 'size-s';
            let iconClass = 'fa-solid fa-campground'; 
            if (i >= 4) { sizeClass = 'size-m'; iconClass = 'fa-solid fa-chess-rook'; }
            if (i >= 8) { sizeClass = 'size-l'; iconClass = 'fa-brands fa-fort-awesome'; }
            if (i === 10) { sizeClass = 'size-xl'; }

            let isUnlocked = false;
            let isCleared = false;
            
            if (lord.id < userState.level) {
                isUnlocked = true; isCleared = true;
            } else if (lord.id === userState.level) {
                if (i <= userState.subLevel) isUnlocked = true;
                if (i < userState.subLevel) isCleared = true;
            }

            const node = createNode(
                i,
                `第${i}の城`,
                i === 10 ? '本丸決戦' : '攻略せよ',
                iconClass,
                sizeClass,
                isUnlocked,
                isCleared
            );

            if (isUnlocked) {
                node.onclick = () => {
                    moveAvatarTo(i - 1);
                    setTimeout(() => {
                        window.location.href = `culture_lesson.html?level=${lord.id}&sub=${i}`;
                    }, 800);
                };
            }
            nodesContainer.appendChild(node);
        }

        let targetSub = 0;
        if(lord.id === userState.level) targetSub = userState.subLevel - 1;
        if(targetSub >= STAGE_COUNT) targetSub = STAGE_COUNT - 1;
        setTimeout(() => moveAvatarTo(targetSub, false), 100);
    }

    function createNode(id, mainText, subText, iconClass, sizeClass, isUnlocked, isCleared) {
        const div = document.createElement('div');
        div.className = `node-container ${isUnlocked ? 'unlocked' : ''} ${isCleared ? 'cleared' : ''}`;
        div.innerHTML = `
            <div class="node-icon-area">
                <i class="${iconClass} node-img ${sizeClass}"></i>
                <div class="flag"><i class="fa-solid fa-flag"></i></div>
            </div>
            <div class="node-label">
                ${mainText}
                <span class="node-sub">${subText}</span>
            </div>
        `;
        return div;
    }

    function moveAvatarTo(index, animate = true) {
        const xPos = index * 260 + 100;
        if (animate) heroAvatar.classList.add('walking');
        heroAvatar.style.left = `${xPos}px`;
        const mapScroll = document.getElementById('map-scroll');
        mapScroll.scrollTo({ left: xPos - window.innerWidth/2 + 100, behavior: 'smooth' });
        if (animate) setTimeout(() => heroAvatar.classList.remove('walking'), 800);
    }

    window.goBack = () => {
        if (currentView === 'region') renderWorldMap();
        else window.location.href = 'index.html';
    };

    function updateAvatar() {
        const eq = userState.equipped || {};
        const helm = window.ITEM_DB[eq.helm];
        const armor = window.ITEM_DB[eq.armor];
        const weapon = window.ITEM_DB[eq.weapon];

        document.getElementById('vis-helm').innerHTML = helm ? `<i class="${helm.icon}" style="${helm.color ? 'color:'+helm.color : ''}"></i>` : '';
        document.getElementById('vis-armor').innerHTML = armor ? `<i class="${armor.icon}" style="${armor.color ? 'color:'+armor.color : ''}"></i>` : '';
        document.getElementById('vis-weapon').innerHTML = weapon ? `<i class="${weapon.icon}" style="${weapon.color ? 'color:'+weapon.color : ''}"></i>` : '';
    }

    window.openKura = () => {
        const grid = document.getElementById('inventory-grid');
        grid.innerHTML = '';
        (userState.inventory || []).forEach(itemId => {
            const item = window.ITEM_DB[itemId];
            if (!item) return;
            const div = document.createElement('div');
            const isEquipped = Object.values(userState.equipped).includes(itemId);
            div.className = `item-slot ${isEquipped ? 'equipped' : ''}`;
            div.innerHTML = `<i class="${item.icon} item-icon" style="color:${item.color || '#333'}"></i>`;
            div.onclick = () => equipItem(itemId, item.type);
            grid.appendChild(div);
        });
        document.getElementById('kura-modal').style.display = 'flex';
    };
    window.closeKura = () => document.getElementById('kura-modal').style.display = 'none';

    async function equipItem(itemId, type) {
        userState.equipped[type] = itemId;
        updateAvatar();
        if(currentUser) await setDoc(doc(db, "users", currentUser.uid, "progress", "sengoku_rpg_v2"), userState);
        else sessionStorage.setItem('sengoku_save_v2', JSON.stringify(userState));
        window.openKura();
    }
</script>

</body>
</html>