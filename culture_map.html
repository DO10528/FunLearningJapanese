<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>戦国・日本語伝</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-paper: #f3e5ab;
        --urushi-red: #b71c1c;
        --indigo: #1a237e;
        --gold: #ffd700;
        --ink: #212121;
        --map-bg: #d7ccc8;
        --path-color: #5d4037;
    }

    body {
        font-family: 'Yuji Syuku', serif;
        margin: 0; padding: 0;
        height: 100vh; height: 100dvh;
        overflow: hidden;
        color: var(--ink);
        display: flex; flex-direction: column;
        background-color: var(--map-bg);
    }

    /* --- ヘッダー --- */
    header {
        background: rgba(33, 33, 33, 0.95); color: #fff;
        padding: 8px 15px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 3px solid var(--gold);
        z-index: 200; /* ヘッダーは一番上 */
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        flex-shrink: 0;
    }
    .game-title { 
        font-size: 1.2em; display: flex; align-items: center; gap: 8px; 
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 
        white-space: nowrap;
    }
    
    .lang-switch {
        background: #3e2723; border: 1px solid var(--gold);
        color: var(--gold); padding: 3px; border-radius: 5px;
        font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
        font-size: 0.8em;
    }

    .header-right { display: flex; gap: 10px; align-items: center; }
    .status-item { color: var(--gold); font-size: 0.8em; white-space: nowrap; }

    /* --- マップエリア --- */
    .map-viewport {
        flex-grow: 1;
        overflow: auto;
        position: relative;
        cursor: grab;
        background-color: var(--map-bg);
        background-image: 
            url('https://www.transparenttextures.com/patterns/aged-paper.png'),
            radial-gradient(circle at 20% 30%, #efebe9 0%, transparent 40%),
            radial-gradient(circle at 80% 70%, #efebe9 0%, transparent 40%);
        background-blend-mode: multiply, normal, normal;
        -webkit-overflow-scrolling: touch; 
    }
    .map-viewport:active { cursor: grabbing; }

    .map-world {
        position: relative;
        width: 2000px; height: 1200px;
        background-image: 
            linear-gradient(135deg, transparent 45%, #a7c0cd 48%, #a7c0cd 52%, transparent 55%),
            linear-gradient(45deg, transparent 40%, #a7c0cd 43%, #a7c0cd 47%, transparent 50%),
            radial-gradient(ellipse at 10% 90%, #546e7a 0%, transparent 30%),
            radial-gradient(ellipse at 30% 80%, #78909c 0%, transparent 40%),
            radial-gradient(ellipse at 60% 85%, #546e7a 0%, transparent 35%),
            radial-gradient(ellipse at 85% 75%, #78909c 0%, transparent 45%);
        background-size: 800px 800px, 600px 600px, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
        background-position: 0 0, 300px 300px, 0 0, 0 0, 0 0, 0 0;
        background-repeat: repeat, repeat, no-repeat, no-repeat, no-repeat, no-repeat;
        opacity: 0.8;
    }

    .road-svg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 1;
    }
    .road-path {
        fill: none; stroke: var(--path-color); stroke-width: 6;
        stroke-dasharray: 15 5; stroke-linecap: round;
        filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
    }

    .map-deco {
        position: absolute; font-size: 4em; color: #5d4037; opacity: 0.6; z-index: 1;
        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        pointer-events: none;
    }
    @media (max-width: 600px) { .map-deco { font-size: 2.5em; } }
    .deco-torii { color: #b71c1c; }
    .deco-tree { color: #33691e; font-size: 5em; }

    /* --- ノード（城・武将アイコン） --- */
    .node-container {
        position: absolute;
        display: flex; flex-direction: column; align-items: center;
        z-index: 10; /* アバター(100)より低く */
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: not-allowed; opacity: 0.7; filter: grayscale(70%);
        transform-origin: bottom center;
        backface-visibility: hidden; transform: translateZ(0); 
    }
    .node-container > * { transform: translateY(-100%); }

    .node-container.unlocked { cursor: pointer; opacity: 1; filter: grayscale(0%); }

    .node-container.unlocked:hover {
        z-index: 50; /* ホバー時もアバター(100)より低く */
        transform: scale(1.15) translateY(-10px) translateZ(0);
    }

    .node-container.unlocked::before {
        content: ''; position: absolute; top: -50%; left: 50%; width: 160px; height: 160px;
        background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,215,0,0.1) 60%, transparent 70%);
        transform: translate(-50%, -50%) scale(0.5); opacity: 0;
        transition: transform 0.4s ease-out, opacity 0.4s ease-out; z-index: -1;
        border-radius: 50%; pointer-events: none;
    }
    .node-container.unlocked:hover::before { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }

    .node-castle-area { position: relative; display: flex; justify-content: center; align-items: flex-end; }
    .node-img {
        color: #4e342e; filter: drop-shadow(3px 3px 2px rgba(0,0,0,0.5));
        transition: color 0.3s ease, filter 0.3s ease; will-change: filter, color;
    }
    .node-container.unlocked:hover .node-img {
        color: var(--urushi-red);
        filter: drop-shadow(0 0 15px var(--gold)) drop-shadow(0 0 5px var(--gold));
    }
    
    .size-s { font-size: 4em; } .size-m { font-size: 6em; } .size-l { font-size: 8em; } .size-xl { font-size: 10em; color: var(--urushi-red); }
    @media (max-width: 600px) {
        .size-s { font-size: 3em; } .size-m { font-size: 4em; } .size-l { font-size: 5em; } .size-xl { font-size: 7em; }
    }

    .nobori {
        position: absolute; top: 10px; left: -30px;
        display: flex; flex-direction: column; align-items: center;
        z-index: 2; transition: transform 0.3s ease;
    }
    .node-container.unlocked:hover .nobori { transform: translateX(-5px) rotate(-5deg); }
    
    .nobori-flag {
        writing-mode: vertical-rl; font-family: 'Yuji Syuku', serif;
        background: var(--urushi-red); color: var(--gold);
        padding: 8px 4px 5px 4px; border: 2px solid var(--ink);
        font-size: 0.85em; border-bottom: none;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
        letter-spacing: 2px;
        min-height: 60px; /* 名前が短くても旗らしく */
    }
    .nobori-pole { width: 4px; height: 90px; background: var(--ink); margin-top: -2px; }
    .clan-crest {
        position: absolute; top: -15px; background: var(--gold); color: var(--ink);
        width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--ink);
        display: flex; justify-content: center; align-items: center; font-size: 1.2em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .clear-flag {
        position: absolute; top: -20px; right: -20px; font-size: 2.5em; color: var(--gold);
        display: none; text-shadow: 2px 2px 0 #000; animation: wave 2s infinite ease-in-out; z-index: 3;
    }
    .node-container.cleared .clear-flag { display: block; }
    .node-container.cleared .node-img { color: var(--urushi-red); }
    .node-container.cleared .nobori-flag { background: var(--indigo); }

    .node-label {
        background: rgba(33, 33, 33, 0.9); color: #fff;
        padding: 5px 12px; border-radius: 4px;
        /* ★修正: お城との距離を縮めるためにマイナスのマージンを設定 ★ */
        margin-top: -15px; 
        text-align: center;
        border: 2px solid var(--gold);
        font-size: 0.9em; white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        transition: background-color 0.3s, border-color 0.3s, transform 0.3s;
        z-index: 10; /* ラベルは城の手前 */
    }
    .node-container.unlocked:hover .node-label {
        background: var(--urushi-red); border-color: var(--gold); color: var(--gold); transform: scale(1.1);
    }
    .node-sub { font-size: 0.7em; color: #ccc; display: block; margin-top: 2px;}

    @keyframes wave { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }

    /* --- アバター --- */
    #hero-avatar {
        position: absolute; width: 60px; height: 80px; 
        z-index: 100; /* ★修正: お城(50)より常に手前 ★ */
        pointer-events: none; 
        transition: all 1.5s ease-in-out;
        transform: translate(-50%, -100%); 
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4));
    }
    /* ★修正: アニメーション(pawa-walk)の定義を削除し、揺れないようにしました ★ */

    .avatar-parts { position: absolute; }
    .pawa-head { width: 50px; height: 45px; background: #fdd835; border-radius: 50%; top: 0; left: 5px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2); z-index: 10; }
    .pawa-body { width: 40px; height: 35px; background: #1a237e; border-radius: 20px 20px 10px 10px; top: 35px; left: 10px; z-index: 5; }
    .pawa-arm { width: 15px; height: 25px; background: #fdd835; border-radius: 10px; top: 38px; z-index: 6; }
    .pawa-arm.left { left: -5px; transform: rotate(20deg); }
    .pawa-arm.right { right: -5px; transform: rotate(-20deg); }
    .pawa-leg { width: 18px; height: 25px; background: #5d4037; border-radius: 10px; top: 60px; z-index: 4; }
    .pawa-leg.left { left: 5px; }
    .pawa-leg.right { right: 5px; }

    /* 装備CSS */
    .helm-part { position: absolute; z-index: 11; pointer-events: none; display: none; }
    .helm-1 { width: 60px; height: 30px; background: #8d6e63; border-radius: 50% 50% 10% 10%; top: -5px; left: 0; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.3); }
    .helm-2 { width: 54px; height: 40px; background: #d32f2f; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-2::before { content: ''; position: absolute; top: -15px; left: 10px; width: 34px; height: 20px; background: #ffd700; clip-path: polygon(0 100%, 50% 0, 100% 100%, 50% 80%); }
    .helm-3 { width: 54px; height: 40px; background: #212121; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-3::before { content: ''; position: absolute; top: -25px; left: 5px; width: 44px; height: 25px; background: #ffd700; border-radius: 50%; box-shadow: inset -5px -5px 0 #212121; }
    .helm-nobu { width: 54px; height: 45px; background: #212121; border-radius: 20% 20% 10% 10%; top: -15px; left: 3px; }
    .helm-nobu::before { content: ''; position: absolute; top: -10px; left: 0; width: 54px; height: 20px; background: #ffd700; clip-path: polygon(0 0, 20% 100%, 80% 100%, 100% 0, 50% 30%); }
    .helm-hide { width: 54px; height: 40px; background: #ffca28; border-radius: 30% 30% 10% 10%; top: -10px; left: 3px; }
    .helm-hide::before { content: ''; position: absolute; top: -30px; left: -10px; width: 74px; height: 74px; background: #ffca28; border-radius: 50%; z-index: -1; opacity: 0.5; }
    .helm-ninja { width: 54px; height: 50px; background: #424242; border-radius: 50% 50% 10% 10%; top: -5px; left: 3px; }
    .helm-ninja::after { content: ''; position: absolute; top: 20px; left: 10px; width: 34px; height: 10px; background: #fdd835; }

    .armor-part { position: absolute; z-index: 5; pointer-events: none; display: none; }
    .armor-1 { background: #d7ccc8; } 
    .armor-2 { background: #1a237e; border: 2px solid #ffd700; } 
    .armor-nobu { background: #b71c1c; } 
    .armor-nobu::after { content: ''; position: absolute; top: 0; left: -10px; width: 60px; height: 50px; background: #b71c1c; border-radius: 10px; z-index: -1; transform: rotate(-5deg); }
    .armor-ninja { background: #000000; } 

    .weapon-part { position: absolute; z-index: 7; pointer-events: none; display: none; }
    .weapon-katana { width: 8px; height: 50px; background: #cfd8dc; border-radius: 4px; top: 25px; right: -15px; transform: rotate(45deg); border: 1px solid #546e7a; }
    .weapon-katana::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 8px; height: 15px; background: #3e2723; }
    .weapon-2 { background: #cfd8dc; }
    .weapon-3 { background: #d50000; box-shadow: 0 0 10px #d50000; }
    .weapon-gun { width: 10px; height: 40px; background: #5d4037; border-radius: 2px; top: 30px; right: -15px; transform: rotate(30deg); }
    .weapon-gun::before { content: ''; position: absolute; top: 0; left: 2px; width: 6px; height: 30px; background: #8d6e63; }
    .weapon-fan { width: 30px; height: 30px; background: #fbc02d; border-radius: 50% 50% 5px 5px; top: 30px; right: -20px; transform: rotate(20deg); }
    .weapon-fan::after { content: ''; position: absolute; bottom: -15px; left: 12px; width: 6px; height: 20px; background: #3e2723; }
    .weapon-shuri { width: 20px; height: 20px; background: #757575; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); top: 35px; right: -15px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- 蔵ボタン --- */
    .kura-btn {
        position: fixed; bottom: 20px; right: 20px;
        width: 80px; height: 80px;
        background: var(--urushi-red); color: white;
        border-radius: 50%; border: 4px solid var(--gold);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        font-size: 2em; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 150;
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        background-blend-mode: multiply;
        transition: transform 0.1s;
    }
    .kura-btn:active { transform: scale(0.95); }
    .kura-label { font-size: 0.5em; font-weight: bold; margin-top: -5px; color: var(--gold); text-shadow: 1px 1px 0 #000; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .kura-box {
        width: 95%; max-width: 600px; height: 90%;
        background: #fff8e1; border: 8px solid #5d4037;
        border-radius: 10px; padding: 15px;
        display: flex; flex-direction: column;
        position: relative;
        background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        box-sizing: border-box;
    }
    .item-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 10px; overflow-y: auto; flex-grow: 1; padding: 5px;
        -webkit-overflow-scrolling: touch; 
    }
    .item-slot {
        background: #d7ccc8; border: 3px solid #a1887f;
        aspect-ratio: 1; border-radius: 12px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; position: relative;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .item-slot.equipped { border-color: var(--urushi-red); background: #ffccbc; box-shadow: 0 0 10px var(--urushi-red); }
    .item-slot.equipped::after { content: "装備中"; position: absolute; bottom: 0; font-size: 0.6em; background: var(--urushi-red); color: white; width: 100%; text-align: center; border-radius: 0 0 8px 8px; padding: 2px 0; }
    .item-icon { font-size: 3em; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); }

    @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .kura-btn { bottom: calc(20px + env(safe-area-inset-bottom)); }
    }
</style>
</head>
<body>

<header>
    <div class="game-title"><i class="fa-solid fa-khanda"></i> 天下統一</div>
    
    <div class="header-right">
        <select id="lang-select" class="lang-switch" onchange="changeLang(this.value)">
            <option value="hiragana">ひらがな</option>
            <option value="kanji">漢字</option>
            <option value="en">English</option>
        </select>

        <div class="status-item"><i class="fa-solid fa-coins"></i> <span id="money-display">0</span> 両</div>
        <button onclick="goBack()" style="background:none; border:1px solid #fff; color:#fff; padding:5px 10px; cursor:pointer; border-radius:5px;">戻る</button>
    </div>
</header>

<div class="map-viewport" id="map-scroll">
    <div class="map-world" id="map-world-content">
        <svg class="road-svg"><path id="road-path" class="road-path" d=""/></svg>

        <i class="fa-solid fa-torii-gate map-deco deco-torii" style="top:150px; left:250px;"></i>
        <i class="fa-solid fa-tree map-deco deco-tree" style="top:400px; left:50px;"></i>
        <i class="fa-solid fa-tree map-deco deco-tree" style="top:600px; left:700px;"></i>
        <i class="fa-solid fa-mountain-sun map-deco" style="top:50px; left:800px; font-size:6em; color:#795548;"></i>
        <i class="fa-solid fa-water map-deco" style="top:300px; left:500px; font-size:5em; color:#29b6f6; opacity:0.4;"></i>
        <i class="fa-solid fa-village map-deco" style="top:550px; left:300px; font-size:3em;"></i>

        <div id="hero-avatar">
            <div class="avatar-parts pawa-head"></div>
            <div class="avatar-parts pawa-body"></div>
            <div class="avatar-parts pawa-arm left"></div>
            <div class="avatar-parts pawa-arm right"></div>
            <div class="avatar-parts pawa-leg left"></div>
            <div class="avatar-parts pawa-leg right"></div>
            
            <div id="helm-parts">
                <div class="helm-part helm-1"></div>
                <div class="helm-part helm-2"></div>
                <div class="helm-part helm-3"></div>
                <div class="helm-part helm-nobu"></div>
                <div class="helm-part helm-hide"></div>
                <div class="helm-part helm-ninja"></div>
            </div>
            
            <div id="weapon-parts">
                <div class="weapon-part weapon-1 weapon-katana" style="background:#a1887f; border-color:#5d4037;"></div>
                <div class="weapon-part weapon-2 weapon-katana"></div>
                <div class="weapon-part weapon-3 weapon-katana"></div>
                <div class="weapon-part weapon-gun"></div>
                <div class="weapon-part weapon-fan"></div>
                <div class="weapon-part weapon-shuri"></div>
            </div>
        </div>

        <div id="nodes-container"></div>
    </div>
</div>

<div class="kura-btn" onclick="openKura()">
    <i class="fa-solid fa-warehouse"></i>
    <span class="kura-label">蔵</span>
</div>

<div class="modal-overlay" id="kura-modal">
    <div class="kura-box">
        <h2 style="text-align:center; margin:0 0 15px 0; color:#5d4037; font-family:'Yuji Syuku', serif; font-size:1.5em;"><i class="fa-solid fa-treasure-chest"></i> 所持品一覧</h2>
        <div class="item-grid" id="inventory-grid"></div>
        <button onclick="closeKura()" style="margin-top:10px; padding:10px; background:var(--ink); color:white; border:none; font-size:1.1em; cursor:pointer; border-radius: 5px; font-family:'Yuji Syuku', serif;">閉じる</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpfbjezbYxrW3XMDegBSC5iFPEQEyD0Ls",
      authDomain: "funlearningjapanese-b8e08.firebaseapp.com",
      projectId: "funlearningjapanese-b8e08",
      storageBucket: "funlearningjapanese-b8e08.firebaseapp.com",
      messagingSenderId: "1055688629268",
      appId: "1:1055688629268:web:248183b62f15c34a2d5b01",
      measurementId: "G-LCMXVLPS81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;
    let playerName = "ゲスト";

    const WARLORDS = [
        { id: 1, name: "織田 信長", title: "たべもの", castle: "岐阜城", x: 150, y: 650, crest: "fa-flower" },
        { id: 2, name: "豊臣 秀吉", title: "あいさつ", castle: "大阪城", x: 450, y: 450, crest: "fa-sun" },
        { id: 3, name: "上杉 謙信", title: "がっこう", castle: "春日山城", x: 750, y: 250, crest: "fa-dragon" },
        { id: 4, name: "武田 信玄", title: "おうち", castle: "躑躅ヶ崎館", x: 1050, y: 400, crest: "fa-horse-head" },
        { id: 5, name: "伊達 政宗", title: "しぜん", castle: "仙台城", x: 1350, y: 200, crest: "fa-moon" },
        { id: 6, name: "真田 幸村", title: "からだ", castle: "上田城", x: 1600, y: 350, crest: "fa-coins" },
        { id: 7, name: "毛利 元就", title: "いろ・かず", castle: "吉田郡山城", x: 1400, y: 600, crest: "fa-arrow-up-from-bracket" },
        { id: 8, name: "明智 光秀", title: "でんとう", castle: "坂本城", x: 1100, y: 750, crest: "fa-bell" },
        { id: 9, name: "源 義経", title: "あそび", castle: "平泉", x: 800, y: 850, crest: "fa-crow" },
        { id: 10, name: "徳川 家康", title: "ばしょ", castle: "江戸城", x: 1750, y: 700, crest: "fa-leaf" }
    ];

    window.ITEM_DB = {
        'helm_1': { type: 'helm', name: '足軽の笠', icon: 'fa-solid fa-hat-cowboy', rarity: 'common', color: '#8d6e63' },
        'helm_2': { type: 'helm', name: '赤備えの兜', icon: 'fa-solid fa-helmet-safety', rarity: 'rare', color: '#d32f2f' },
        'helm_3': { type: 'helm', name: '三日月の兜', icon: 'fa-brands fa-fort-awesome', rarity: 'legend', color: '#ffd700' },
        'helm_nobu': { type: 'helm', name: '魔王の兜', icon: 'fa-solid fa-crown', rarity: 'legend', color: '#212121' },
        'helm_hide': { type: 'helm', name: '日輪の兜', icon: 'fa-solid fa-sun', rarity: 'legend', color: '#ffca28' },
        'helm_ninja': { type: 'helm', name: '忍び頭巾', icon: 'fa-solid fa-user-ninja', rarity: 'rare', color: '#424242' },
        'armor_1': { type: 'armor', name: 'ボロの着物', icon: 'fa-solid fa-shirt', rarity: 'common', color: '#d7ccc8' },
        'armor_2': { type: 'armor', name: '侍の鎧', icon: 'fa-solid fa-shield-halved', rarity: 'rare', color: '#1a237e' },
        'armor_nobu': { type: 'armor', name: '南蛮マント', icon: 'fa-solid fa-user-secret', rarity: 'legend', color: '#b71c1c' },
        'armor_ninja': { type: 'armor', name: '忍び装束', icon: 'fa-solid fa-user-large', rarity: 'rare', color: '#000000' },
        'weapon_1': { type: 'weapon', name: '竹刀', icon: 'fa-solid fa-candy-cane', rarity: 'common', color: '#a1887f' },
        'weapon_2': { type: 'weapon', name: '名刀・虎徹', icon: 'fa-solid fa-khanda', rarity: 'rare', color: '#cfd8dc' },
        'weapon_3': { type: 'weapon', name: '妖刀・村正', icon: 'fa-solid fa-fire', rarity: 'legend', color: '#d50000' },
        'weapon_gun': { type: 'weapon', name: '火縄銃', icon: 'fa-solid fa-gun', rarity: 'rare', color: '#5d4037' },
        'weapon_fan': { type: 'weapon', name: '軍配', icon: 'fa-solid fa-fan', rarity: 'rare', color: '#fbc02d' },
        'weapon_shuri': { type: 'weapon', name: '手裏剣', icon: 'fa-solid fa-star', rarity: 'common', color: '#757575' }
    };

    let userState = { level: 1, subLevel: 1, inventory: ['helm_1', 'armor_1', 'weapon_1'], equipped: { helm: 'helm_1', armor: 'armor_1', weapon: 'weapon_1' }, money: 100 };

    const nodesContainer = document.getElementById('nodes-container');
    const heroAvatar = document.getElementById('hero-avatar');
    const roadPath = document.getElementById('road-path');
    const mapScroll = document.getElementById('map-scroll');
    
    let currentView = 'world'; 
    let selectedRegionId = null;

    const savedLang = localStorage.getItem('culture_lang') || 'hiragana';
    document.getElementById('lang-select').value = savedLang;

    window.changeLang = (lang) => {
        localStorage.setItem('culture_lang', lang);
    };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            // ★ 修正: ユーザー名を取得 ★
            playerName = user.displayName || "ゲスト";
            const snap = await getDoc(doc(db, "users", user.uid, "progress", "sengoku_rpg_v2"));
            if (snap.exists()) userState = snap.data();
        } else {
            playerName = "ゲスト";
            const saved = sessionStorage.getItem('sengoku_save_v2');
            if (saved) userState = JSON.parse(saved);
        }
        renderWorldMap();
        updateAvatar();
        document.getElementById('money-display').innerText = userState.money || 0;
    });

    function renderWorldMap() {
        currentView = 'world';
        nodesContainer.innerHTML = '';
        
        let pathD = "";

        WARLORDS.forEach((lord, index) => {
            if (index > 0) {
                const prev = WARLORDS[index - 1];
                const midX = (prev.x + lord.x) / 2;
                const midY = (prev.y + lord.y) / 2;
                const cpX = midX + (lord.y - prev.y) * 0.2;
                const cpY = midY - (lord.x - prev.x) * 0.2;
                pathD += ` M ${prev.x} ${prev.y} Q ${cpX} ${cpY} ${lord.x} ${lord.y}`;
            }

            const node = createNode(
                lord.id, 
                lord.name, 
                lord.title,
                'fa-solid fa-chess-rook',
                'size-l',
                (lord.id <= userState.level),
                (lord.id < userState.level),
                lord.x, lord.y,
                lord.crest
            );
            
            if (node.classList.contains('unlocked')) {
                node.onclick = () => {
                    moveAvatarTo(lord.x, lord.y);
                    setTimeout(() => renderRegionMap(lord), 1500);
                };
            }
            nodesContainer.appendChild(node);
        });
        
        roadPath.setAttribute('d', pathD);

        const currentLord = WARLORDS[userState.level - 1];
        if (currentLord) {
            setTimeout(() => moveAvatarTo(currentLord.x, currentLord.y, false), 300);
        }
    }

    function renderRegionMap(lord) {
        currentView = 'region';
        selectedRegionId = lord.id;
        nodesContainer.innerHTML = '';
        roadPath.setAttribute('d', '');
        
        const STAGE_COUNT = 10;
        document.getElementById('map-world-content').style.width = `${STAGE_COUNT * 260 + 200}px`;

        for (let i = 1; i <= STAGE_COUNT; i++) {
            let sizeClass = 'size-s';
            let iconClass = 'fa-solid fa-campground';
            if (i >= 4) { sizeClass = 'size-m'; iconClass = 'fa-solid fa-chess-rook'; }
            if (i >= 8) { sizeClass = 'size-l'; iconClass = 'fa-brands fa-fort-awesome'; }
            if (i === 10) { sizeClass = 'size-xl'; }

            let isUnlocked = false;
            let isCleared = false;
            
            if (lord.id < userState.level) {
                isUnlocked = true; isCleared = true;
            } else if (lord.id === userState.level) {
                if (i <= userState.subLevel) isUnlocked = true;
                if (i < userState.subLevel) isCleared = true;
            }

            const posX = i * 260;
            const posY = 600;

            const node = createNode(
                i,
                `第${i}の城`,
                i === 10 ? '本丸決戦' : '攻略せよ',
                iconClass,
                sizeClass,
                isUnlocked,
                isCleared,
                posX, posY,
                lord.crest
            );

            if (isUnlocked) {
                node.onclick = () => {
                    moveAvatarTo(posX, posY);
                    setTimeout(() => {
                        window.location.href = `culture_lesson.html?level=${lord.id}&sub=${i}`;
                    }, 1000);
                };
            }
            nodesContainer.appendChild(node);
        }

        let targetSub = 1;
        if(lord.id === userState.level) targetSub = userState.subLevel;
        const targetX = targetSub * 260;
        setTimeout(() => moveAvatarTo(targetX, 600, false), 100);
    }

    // ★ 修正: 旗の名前を動的に設定 ★
    function createNode(id, mainText, subText, iconClass, sizeClass, isUnlocked, isCleared, x, y, crestIcon) {
        const div = document.createElement('div');
        div.className = `node-container ${isUnlocked ? 'unlocked' : ''} ${isCleared ? 'cleared' : ''}`;
        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
        
        // 名前が長すぎる場合は省略
        const displayName = playerName.length > 6 ? playerName.substring(0,5)+".." : playerName;

        div.innerHTML = `
            <div class="node-castle-area">
                <div class="nobori">
                    <div class="clan-crest"><i class="fa-solid ${crestIcon || 'fa-circle'}"></i></div>
                    <div class="nobori-flag">${displayName}</div>
                    <div class="nobori-pole"></div>
                </div>
                <i class="${iconClass} node-img ${sizeClass}"></i>
                <div class="clear-flag"><i class="fa-solid fa-flag"></i></div>
            </div>
            <div class="node-label">
                ${mainText}
                <span class="node-sub">${subText}</span>
            </div>
        `;
        return div;
    }

    function moveAvatarTo(x, y, animate = true) {
        // ★ 修正: walkingクラスの付与を削除 ★
        heroAvatar.style.left = `${x}px`;
        heroAvatar.style.top = `${y}px`;
        
        const viewportWidth = mapScroll.clientWidth;
        const viewportHeight = mapScroll.clientHeight;
        
        mapScroll.scrollTo({ 
            left: x - viewportWidth / 2, 
            top: y - viewportHeight / 2, 
            behavior: 'smooth' 
        });
    }

    window.goBack = () => {
        if (currentView === 'region') renderWorldMap();
        else window.location.href = 'index.html';
    };

    function updateAvatar() {
        const eq = userState.equipped || {};
        document.querySelectorAll('.helm-part, .weapon-part').forEach(el => el.style.display = 'none');
        
        if (eq.helm) {
            const helmClass = eq.helm.replace(/_/g, '-');
            const helmEl = document.querySelector(`.${helmClass}`);
            if (helmEl) helmEl.style.display = 'block';
        }
        if (eq.weapon) {
            const weaponClass = eq.weapon.replace(/_/g, '-');
            const weaponEl = document.querySelector(`.${weaponClass}`);
            if (weaponEl) weaponEl.style.display = 'block';
        }

        const body = document.querySelector('.pawa-body');
        if (eq.armor) {
            const armorClass = eq.armor.replace(/_/g, '-');
            body.className = 'avatar-parts pawa-body ' + armorClass;
        } else {
            body.className = 'avatar-parts pawa-body armor-1';
        }
    }

    window.openKura = () => {
        const grid = document.getElementById('inventory-grid');
        grid.innerHTML = '';
        (userState.inventory || []).forEach(itemId => {
            const item = window.ITEM_DB[itemId];
            if (!item) return;
            const div = document.createElement('div');
            const isEquipped = Object.values(userState.equipped).includes(itemId);
            div.className = `item-slot ${isEquipped ? 'equipped' : ''}`;
            div.innerHTML = `<i class="${item.icon} item-icon" style="color:${item.color || '#333'}"></i>`;
            div.onclick = () => equipItem(itemId, item.type);
            grid.appendChild(div);
        });
        document.getElementById('kura-modal').style.display = 'flex';
    };
    window.closeKura = () => document.getElementById('kura-modal').style.display = 'none';

    async function equipItem(itemId, type) {
        userState.equipped[type] = itemId;
        updateAvatar();
        if(currentUser) await setDoc(doc(db, "users", currentUser.uid, "progress", "sengoku_rpg_v2"), userState);
        else sessionStorage.setItem('sengoku_save_v2', JSON.stringify(userState));
        window.openKura();
    }
</script>

</body>
</html>