<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>日本旅行サバイバル - Final Edition</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #1565c0;
        --accent: #ffca28;
        --bg-color: #e3f2fd;
        --road-color: #78909c;
        --block-color: #c8e6c9;
        --water-color: #81d4fa;
        --bridge-color: #d7ccc8;
        --text: #333;
    }

    body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: var(--bg-color);
        color: var(--text);
        margin: 0; padding: 0;
        height: 100dvh;
        display: flex; flex-direction: column;
        user-select: none;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    header {
        background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
        color: white; padding: 8px 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0; z-index: 100;
    }
    .logo { font-size: 1.0em; font-weight: 900; color: white; text-decoration: none; }
    .home-link { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; color: white; text-decoration: none; font-size: 0.8em; }

    #main-container {
        flex-grow: 1; position: relative; overflow-y: auto;
        padding: 10px; display: flex; flex-direction: column; align-items: center;
    }

    .screen { display: none; width: 100%; max-width: 700px; flex-direction: column; align-items: center; padding-bottom: 60px; }
    .screen.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* メニュー */
    .menu-btn {
        background: white; color: var(--primary); border: 2px solid var(--primary);
        padding: 15px; width: 100%; margin-bottom: 10px; border-radius: 12px;
        font-weight: bold; font-size: 1.0em; cursor: pointer;
        display: flex; align-items: center; gap: 15px;
        box-shadow: 0 4px 0 #bbdefb;
    }
    .menu-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #bbdefb; }
    .menu-icon { font-size: 1.5em; width: 40px; text-align: center; }

    /* 単語練習 */
    .vocab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
    .vocab-card {
        background: white; border-radius: 10px; padding: 10px;
        text-align: center; cursor: pointer;
        box-shadow: 0 2px 0 #ddd; border: 1px solid #eee;
    }

    /* マップエリア (横長 9x5) */
    #map-wrapper {
        width: 98vw; aspect-ratio: 9/5; max-width: 600px;
        background: var(--block-color); 
        border: 4px solid #fff; border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        position: relative; margin: 10px 0;
        display: grid; 
        grid-template-columns: repeat(9, 1fr); 
        grid-template-rows: repeat(5, 1fr);
    }

    .cell { position: relative; display: flex; justify-content: center; align-items: center; overflow: visible; }
    
    .road { background-color: var(--road-color); }
    .road::after { content: ''; position: absolute; background: rgba(255,255,255,0.4); }
    .road.v-road::after { width: 2px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
    .road.h-road::after { width: 100%; height: 2px; top: 50%; left: 0; transform: translateY(-50%); }
    .road.cross::after { width: 6px; height: 6px; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    .water { background-color: var(--water-color); }
    .bridge { 
        background-color: var(--bridge-color); 
        background-image: repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(0,0,0,0.1) 4px, rgba(0,0,0,0.1) 8px);
        z-index: 1;
    }
    
    .block { background-color: #a5d6a7; border: 1px solid rgba(0,0,0,0.05); }
    .building-icon { 
        font-size: 1.5em; z-index: 5; 
        filter: drop-shadow(0 2px 0 rgba(255,255,255,0.9));
        pointer-events: none;
    }

    #player {
        position: absolute; width: 30%; height: 30%;
        background: #f44336; border: 2px solid white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; color: white;
        z-index: 20; transition: top 0.3s linear, left 0.3s linear;
        box-shadow: 0 4px 5px rgba(0,0,0,0.4); font-size: 0.8em;
        pointer-events: none;
    }

    /* コントローラー */
    .d-pad { display: grid; grid-template-columns: 60px 60px 60px; gap: 5px; margin-bottom: 10px; }
    .d-btn {
        width: 60px; height: 60px; background: #eceff1; border: none; border-radius: 12px;
        font-size: 1.5em; color: #546e7a; cursor: pointer; box-shadow: 0 4px 0 #cfd8dc;
    }
    .d-btn:active { transform: translateY(4px); box-shadow: none; background: #cfd8dc; }
    .d-up { grid-column: 2; } .d-left { grid-column: 1; } .d-right { grid-column: 3; } .d-down { grid-column: 2; }

    .speech-box {
        background: white; padding: 15px; border-radius: 15px; width: 100%;
        text-align: center; margin-bottom: 10px; border-left: 5px solid var(--accent);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .mic-btn {
        width: 60px; height: 60px; border-radius: 50%; border: none;
        background: var(--primary); color: white; font-size: 1.5em;
        cursor: pointer; box-shadow: 0 0 0 4px rgba(21, 101, 192, 0.2);
        margin: 10px auto; display: block;
    }
    .mic-btn.listening { background: #f44336; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); } }

    .action-btn {
        background: #43a047; color: white; width: 100%; padding: 12px;
        border: none; border-radius: 25px; font-weight: bold; font-size: 1.1em;
        box-shadow: 0 4px 0 #2e7d32; cursor: pointer;
    }
    .action-btn:active { transform: translateY(4px); box-shadow: none; }
    .nav-btn { background: #90a4ae; font-size: 0.9em; padding: 10px 20px; color: white; border: none; border-radius: 20px; margin-top: 20px; }

</style>
</head>
<body>

<header>
    <a href="#" class="logo"><i class="fa-solid fa-map"></i> 道案内サバイバル</a>
    <a href="#" onclick="showScreen('menu-screen')" class="home-link">メニュー</a>
</header>

<div id="main-container">

    <div id="menu-screen" class="screen active">
        <h2 style="color:#555; margin-bottom:15px;">メニュー</h2>
        <button class="menu-btn" onclick="showScreen('vocab-screen')">
            <span class="menu-icon"><i class="fa-solid fa-book"></i></span>
            <div>1. 言葉のれんしゅう</div>
        </button>
        <button class="menu-btn" onclick="showScreen('ask-screen')">
            <span class="menu-icon"><i class="fa-solid fa-microphone"></i></span>
            <div>2. 質問してみよう</div>
        </button>
        <button class="menu-btn" onclick="showScreen('listen-screen')">
            <span class="menu-icon"><i class="fa-solid fa-ear-listen"></i></span>
            <div>3. 聞いて動こう</div>
        </button>
        <button class="menu-btn" onclick="initGame4()">
            <span class="menu-icon"><i class="fa-solid fa-map-location-dot"></i></span>
            <div>4. 道案内ミッション</div>
        </button>
        <button class="menu-btn" onclick="initGame5()">
            <span class="menu-icon"><i class="fa-solid fa-user-secret"></i></span>
            <div>5. 上級・聞き込み</div>
        </button>
    </div>

    <div id="vocab-screen" class="screen">
        <h3><i class="fa-solid fa-book"></i> 場所・方向・数</h3>
        <div class="vocab-grid" id="vocab-grid"></div>
        <button class="action-btn" style="margin-top:20px; background:#90a4ae;" onclick="showScreen('menu-screen')">戻る</button>
    </div>

    <div id="ask-screen" class="screen">
        <h3><i class="fa-solid fa-microphone"></i> 質問しよう</h3>
        <div class="speech-box">
            <div id="ask-target-icon" style="font-size:2.5em; color:#555;"><i class="fa-solid fa-store"></i></div>
            <div id="ask-target-text" style="font-size:1.2em; font-weight:bold; margin:5px 0;">コンビニ</div>
            <div style="font-size:0.9em; color:#666;">「<b><span id="ask-target-kana">コンビニ</span>は どこですか？</b>」</div>
        </div>
        
        <button id="mic-btn-ask" class="mic-btn" onclick="checkSpeechGame2()"><i class="fa-solid fa-microphone"></i></button>
        <div id="ask-feedback" style="font-weight:bold; height:20px;"></div>
        
        <button class="action-btn" style="margin-top:20px; background:#ff9800;" onclick="setupAskGame()">次の場所へ</button>
        <button class="action-btn" style="margin-top:10px; background:#90a4ae;" onclick="showScreen('menu-screen')">戻る</button>
    </div>

    <div id="listen-screen" class="screen">
        <h3><i class="fa-solid fa-ear-listen"></i> 聞いて動こう</h3>
        <div class="speech-box">
            <button onclick="playRandomCommand()" style="background:var(--accent); border:none; width:60px; height:60px; border-radius:50%; font-size:1.5em; cursor:pointer;"><i class="fa-solid fa-play"></i></button>
            <div style="margin-top:10px; font-weight:bold;">音声を聞いてボタンを押そう</div>
        </div>
        <div id="listen-feedback" style="height:20px; font-weight:bold; color:#d32f2f; margin-bottom:10px;"></div>
        <div class="d-pad">
            <button class="d-btn d-up" onclick="checkListenAnswer('up')"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="d-btn d-left" onclick="checkListenAnswer('left')"><i class="fa-solid fa-arrow-left"></i></button>
            <button class="d-btn d-right" onclick="checkListenAnswer('right')"><i class="fa-solid fa-arrow-right"></i></button>
            <button class="d-btn d-down" onclick="checkListenAnswer('down')"><i class="fa-solid fa-arrow-down"></i></button>
        </div>
        <button class="action-btn" style="margin-top:10px; background:#90a4ae;" onclick="showScreen('menu-screen')">戻る</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <div id="game-title" style="font-weight:bold;">Mission</div>
            <button id="replay-nav-btn" onclick="speakNavigation()" style="display:none; background:#ff9800; color:white; border:none; border-radius:20px; padding:5px 15px; font-size:0.9em;"><i class="fa-solid fa-volume-high"></i> 道順を聞く</button>
            <button id="replay-task-btn" onclick="speakTask()" style="display:none; background:#ff9800; color:white; border:none; border-radius:20px; padding:5px 15px; font-size:0.9em;"><i class="fa-solid fa-volume-high"></i> 指示を聞く</button>
        </div>

        <div id="game5-phase1" style="display:none; width:100%; margin-top:10px;">
            <div class="speech-box">
                <div>質問してください：</div>
                <div style="font-weight:bold; font-size:1.1em; margin:5px 0;">「<span id="g5-target-name"></span>は どこですか？」</div>
                <button id="g5-mic-btn" class="mic-btn" style="width:50px; height:50px; font-size:1.2em;" onclick="game5SpeechCheck()"><i class="fa-solid fa-microphone"></i></button>
                <div id="g5-status" style="font-size:0.8em; height:20px; color:#d32f2f;"></div>
            </div>
        </div>

        <div id="map-wrapper">
            <div id="player"><i class="fa-solid fa-person-walking"></i></div>
        </div>

        <div id="map-controls" style="display:none;">
            <div class="d-pad">
                <button class="d-btn d-up" onclick="movePlayer(0, -1)"><i class="fa-solid fa-caret-up"></i></button>
                <button class="d-btn d-left" onclick="movePlayer(-1, 0)"><i class="fa-solid fa-caret-left"></i></button>
                <button class="d-btn d-right" onclick="movePlayer(1, 0)"><i class="fa-solid fa-caret-right"></i></button>
                <button class="d-btn d-down" onclick="movePlayer(0, 1)"><i class="fa-solid fa-caret-down"></i></button>
            </div>
            <button class="action-btn" onclick="checkArrival()">
                <i class="fa-solid fa-location-dot"></i> 着きました！ (Arrived)
            </button>
        </div>

        <button class="action-btn" style="margin-top:10px; background:#90a4ae; font-size:0.9em;" onclick="showScreen('menu-screen')">メニューに戻る</button>
    </div>

</div>

<script>
    // --- データ ---
    const places = [
        { id: 10, name: "コンビニ", kana: "こんびに", icon: "fa-store", color: "#ff9800" },
        { id: 11, name: "駅", kana: "えき", icon: "fa-train", color: "#795548" },
        { id: 12, name: "ホテル", kana: "ほてる", icon: "fa-hotel", color: "#3f51b5" },
        { id: 13, name: "郵便局", kana: "ゆうびんきょく", icon: "fa-envelope", color: "#f44336" },
        { id: 14, name: "トイレ", kana: "といれ", icon: "fa-restroom", color: "#00bcd4" },
        { id: 15, name: "レストラン", kana: "れすとらん", icon: "fa-utensils", color: "#4caf50" },
        { id: 16, name: "学校", kana: "がっこう", icon: "fa-school", color: "#9c27b0" },
        { id: 17, name: "病院", kana: "びょういん", icon: "fa-hospital", color: "#e91e63" },
        { id: 18, name: "空港", kana: "くうこう", icon: "fa-plane", color: "#2196f3" },
        { id: 19, name: "お土産屋", kana: "おみやげや", icon: "fa-gift", color: "#ff5722" }
    ];

    const commands = [
        { key: "up", text: "まっすぐ いってください" },
        { key: "down", text: "うしろに もどってください" },
        { key: "left", text: "ひだりに まがってください" },
        { key: "right", text: "みぎに まがってください" }
    ];

    // --- 音声合成 ---
    const synth = window.speechSynthesis;
    let voices = [];
    if(speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => { voices = synth.getVoices(); };
    }
    setTimeout(() => { voices = synth.getVoices(); }, 500);

    // 発音修正用辞書
    function cleanTextForSpeech(text) {
        let t = text.replace(/\(.*?\)/g, "").replace(/（.*?）/g, "");
        t = t.replace(/行く/g, "いく");
        t = t.replace(/行って/g, "いって");
        t = t.replace(/行き/g, "いき");
        t = t.replace(/右/g, "みぎ");
        t = t.replace(/左/g, "ひだり");
        t = t.replace(/角/g, "かど");
        t = t.replace(/1つ目/g, "ひとつめ");
        t = t.replace(/2つ目/g, "ふたつめ");
        t = t.replace(/3つ目/g, "みっつめ");
        t = t.replace(/4つ目/g, "よっつめ");
        return t;
    }

    function speak(text) {
        if (synth.speaking) synth.cancel();
        const t = cleanTextForSpeech(text);
        const utter = new SpeechSynthesisUtterance(t);
        utter.lang = 'ja-JP';
        utter.rate = 0.9;
        const jp = voices.find(v => v.lang.includes('ja'));
        if(jp) utter.voice = jp;
        synth.speak(utter);
    }

    // --- 音声認識 ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if(SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = false;
        recognition.interimResults = false;
    }

    function isSimilar(transcript, keyword) {
        return transcript.includes(keyword); 
    }

    window.showScreen = (id) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    };

    // ==========================================
    // 1. 単語練習 (カウンター追加)
    // ==========================================
    const vGrid = document.getElementById('vocab-grid');
    places.forEach(p => {
        const div = document.createElement('div');
        div.className = 'vocab-card';
        div.textContent = `<div class="vocab-icon"><i class="fa-solid ${p.icon}" style="color:${p.color}"></i></div><div>${p.name}</div><div style="font-size:0.8em; color:#888;">${p.kana}</div>`;
        div.onclick = () => speak(p.kana);
        vGrid.appendChild(div);
    });
    // 方向・数
    const extras = [
        {n:"1つ目",k:"ひとつめ",i:"fa-1"}, {n:"2つ目",k:"ふたつめ",i:"fa-2"},
        {n:"3つ目",k:"みっつめ",i:"fa-3"}, {n:"4つ目",k:"よっつめ",i:"fa-4"},
        {n:"右",k:"みぎ",i:"fa-arrow-right"}, {n:"左",k:"ひだり",i:"fa-arrow-left"},
        {n:"まっすぐ",k:"まっすぐ",i:"fa-arrow-up"}, {n:"角",k:"かど",i:"fa-turn-up"}
    ];
    extras.forEach(d => {
        const div = document.createElement('div');
        div.className = 'vocab-card';
        div.textContent = `<div class="vocab-icon"><i class="fa-solid ${d.i}" style="color:#555"></i></div><div>${d.n}</div><div style="font-size:0.8em; color:#888;">${d.k}</div>`;
        div.onclick = () => speak(d.k);
        vGrid.appendChild(div);
    });

    // ==========================================
    // 2. 質問練習
    // ==========================================
    let askTarget = null;
    window.setupAskGame = () => {
        askTarget = places[Math.floor(Math.random() * places.length)];
        document.getElementById('ask-target-text').textContent = askTarget.name;
        document.getElementById('ask-target-kana').textContent = askTarget.name;
        document.getElementById('ask-target-icon').textContent = `<i class="fa-solid ${askTarget.icon}" style="color:${askTarget.color}"></i>`;
        document.getElementById('ask-feedback').textContent = "";
    };
    window.checkSpeechGame2 = () => {
        if(!recognition) return alert("マイクが使えません");
        const btn = document.getElementById('mic-btn-ask');
        btn.classList.add('listening');
        document.getElementById('ask-feedback').textContent = "聞いています...";
        
        recognition.start();
        recognition.onresult = (e) => {
            const tr = e.results[0][0].transcript;
            if(isSimilar(tr, askTarget.name)) {
                document.getElementById('ask-feedback').textContent = "OK! すばらしい！";
                document.getElementById('ask-feedback').style.color = "#4caf50";
                speak("すばらしいです");
            } else {
                document.getElementById('ask-feedback').textContent = `もう一度！`;
                document.getElementById('ask-feedback').style.color = "#f44336";
                speak("もういちど おねがいします");
            }
            btn.classList.remove('listening');
        };
        recognition.onend = () => btn.classList.remove('listening');
    };
    setupAskGame();

    // ==========================================
    // 3. 聞いて動こう
    // ==========================================
    let currentListenCmd = null;
    window.playRandomCommand = () => {
        currentListenCmd = commands[Math.floor(Math.random() * commands.length)];
        document.getElementById('listen-feedback').textContent = "聞いてください...";
        speak(currentListenCmd.text);
    };
    window.checkListenAnswer = (key) => {
        if(!currentListenCmd) return;
        if(key === currentListenCmd.key) {
            document.getElementById('listen-feedback').textContent = "せいかい！";
            document.getElementById('listen-feedback').style.color = "#4caf50";
            speak("せいかいです");
            currentListenCmd = null;
        } else {
            document.getElementById('listen-feedback').textContent = "ちがいます";
            document.getElementById('listen-feedback').style.color = "#f44336";
            speak("ちがいます");
        }
    };

    // ==========================================
    // 4 & 5. マップ生成 (横長 9x5)
    // ==========================================
    const GRID_W = 9;
    const GRID_H = 5;
    let mapGrid = []; 
    let playerPos = {x:0, y:0};
    let targetObj = null; 
    let targetPos = {x:0, y:0};
    let distractions = []; 
    let navigationText = ""; 
    let currentGameMode = 4; 

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateCityMap() {
        // 初期化: 建物(2)
        mapGrid = Array(GRID_H).fill().map(() => Array(GRID_W).fill(2));
        
        // 道路(1)
        for(let x=0; x<GRID_W; x+=2) for(let y=0; y<GRID_H; y++) mapGrid[y][x] = 1;
        for(let y=0; y<GRID_H; y+=2) for(let x=0; x<GRID_W; x++) mapGrid[y][x] = 1;

        // ランダムで川(3)と橋(4) (奇数列 x=3 or 5 or 7)
        if(Math.random() > 0.3) {
            const riverX = 3 + (Math.floor(Math.random()*2) * 2); // 3, 5, 7? No, roads are even. Buildings are odd. River replaces building column.
            for(let y=0; y<GRID_H; y++) {
                if(mapGrid[y][riverX] === 1) mapGrid[y][riverX] = 4; // Bridge
                else mapGrid[y][riverX] = 3; // River
            }
        }

        // スタート地点
        let validStart = false;
        while(!validStart) {
            let sx = (Math.floor(Math.random()*5))*2;
            let sy = (Math.floor(Math.random()*3))*2;
            if(sx < GRID_W && sy < GRID_H && mapGrid[sy][sx] === 1) {
                playerPos = {x:sx, y:sy};
                validStart = true;
            }
        }

        // 建物配置
        let availablePlaces = shuffleArray([...places]);
        targetObj = availablePlaces.pop();
        distractions = [];
        let placedCoords = [];

        function getValidBuildingPos() {
            for(let i=0; i<100; i++) {
                let bx = 1 + (Math.floor(Math.random()*4))*2;
                let by = 1 + (Math.floor(Math.random()*2))*2;
                if(bx >= GRID_W || by >= GRID_H) continue;
                if(mapGrid[by][bx] === 3) continue; // River
                let occupied = placedCoords.some(c => c.x === bx && c.y === by);
                if(!occupied) return {x:bx, y:by};
            }
            return null;
        }

        targetPos = getValidBuildingPos();
        placedCoords.push(targetPos);

        const dummyCount = 5;
        for(let i=0; i<dummyCount; i++) {
            let p = getValidBuildingPos();
            if(p && availablePlaces.length > 0) {
                let dummy = availablePlaces.pop();
                distractions.push({pos:p, obj:dummy});
                placedCoords.push(p);
            }
        }
    }

    function renderMap() {
        const wrapper = document.getElementById('map-wrapper');
        Array.from(wrapper.children).forEach(c => { if(c.id !== 'player') c.remove(); });

        for(let y=0; y<GRID_H; y++) {
            for(let x=0; x<GRID_W; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const type = mapGrid[y][x];

                if(type === 1 || type === 4) { 
                    if(type === 4) cell.className += ' bridge';
                    else cell.className += ' road';
                    if(type === 1) {
                        let neighbors = 0;
                        if(y>0 && mapGrid[y-1][x]!==2 && mapGrid[y-1][x]!==3) neighbors++;
                        if(y<GRID_H-1 && mapGrid[y+1][x]!==2 && mapGrid[y+1][x]!==3) neighbors++;
                        if(x>0 && mapGrid[y][x-1]!==2 && mapGrid[y][x-1]!==3) neighbors++;
                        if(x<GRID_W-1 && mapGrid[y][x+1]!==2 && mapGrid[y][x+1]!==3) neighbors++;
                        
                        if(neighbors > 2) cell.className += ' cross';
                        else if(x%2===0 && y%2!==0) cell.className += ' v-road';
                        else cell.className += ' h-road';
                    }
                } else if (type === 3) {
                    cell.className += ' water';
                } else {
                    cell.className += ' block';
                }

                // アイコン描画
                if(currentGameMode === 5) {
                    // Game 5: 全て同じアイコン
                    if((x === targetPos.x && y === targetPos.y) || distractions.some(d => d.pos.x===x && d.pos.y===y)) {
                        cell.textContent = `<i class="fa-solid fa-building building-icon" style="color:#607d8b;"></i>`;
                    }
                } else {
                    // Game 4: アイコンのみ（文字なし）
                    if(x === targetPos.x && y === targetPos.y) {
                        cell.textContent = `<i class="fa-solid ${targetObj.icon} building-icon" style="color:${targetObj.color}"></i>`;
                    }
                    distractions.forEach(d => {
                        if(d.pos.x === x && d.pos.y === y) {
                            cell.textContent = `<i class="fa-solid ${d.obj.icon} building-icon" style="color:${d.obj.color}"></i>`;
                        }
                    });
                }
                wrapper.appendChild(cell);
            }
        }
        updatePlayerUI();
    }

    function updatePlayerUI() {
        const p = document.getElementById('player');
        const wPct = 100 / GRID_W;
        const hPct = 100 / GRID_H;
        p.style.left = (playerPos.x * wPct + 1) + "%";
        p.style.top = (playerPos.y * hPct + 2) + "%";
        p.style.width = (wPct * 0.6) + "%";
        p.style.height = (hPct * 0.6) + "%";
    }

    // --- ナビ生成ロジック ---
    function calculateRoute() {
        let queue = [{x:playerPos.x, y:playerPos.y, path:[]}];
        let visited = new Set();
        let goalNode = null;

        // BFSでターゲット(建物)へ
        while(queue.length > 0) {
            let curr = queue.shift();
            let key = `${curr.x},${curr.y}`;
            if(visited.has(key)) continue;
            visited.add(key);
            
            if(curr.x === targetPos.x && curr.y === targetPos.y) {
                goalNode = curr;
                break;
            }
            const dirs = [[0,-1],[1,0],[0,1],[-1,0]]; // 0:Up, 1:Right, 2:Down, 3:Left
            dirs.forEach((d, i) => {
                let nx = curr.x + d[0];
                let ny = curr.y + d[1];
                if(nx>=0 && nx<GRID_W && ny>=0 && ny<GRID_H) {
                    // 川以外は通れる (建物はゴールのみOK)
                    const type = mapGrid[ny][nx];
                    if(type !== 3) { 
                        queue.push({x:nx, y:ny, path:[...curr.path, i]});
                    }
                }
            });
        }

        if(!goalNode) return "すぐ ちかく です。";
        let steps = goalNode.path;
        if(steps.length === 0) return "めのまえ です。";

        // --- ルート解説 ---
        // 1. 最初の直進
        let currentDir = steps[0];
        let dirName = ["うえ","みぎ","した","ひだり"][currentDir];
        let script = `まずは、${dirName}に まっすぐ いって、`;

        // 2. 曲がるポイントを探す
        let turnIndex = -1;
        let turnDir = -1;
        for(let i=1; i<steps.length; i++) {
            if(steps[i] !== currentDir) {
                turnIndex = i;
                turnDir = steps[i];
                break;
            }
        }

        // 3. 曲がるか直進か
        if(turnIndex === -1) {
            // 曲がらない -> 最後に左右どちらか
            // 到着直前の道(last road)からターゲット(target)への向き
            // stepsの最後の1つは「道路から建物へ」の動き
            let lastMove = steps[steps.length-1];
            // ずっと直進してきた場合、lastMove == currentDir。つまり「正面の建物」
            script += "そのまま まっすぐ いけば あります。";
        } else {
            // 曲がる
            // 交差点を数える
            let cornerCount = 0;
            let checkX = playerPos.x;
            let checkY = playerPos.y;
            const dx = [0,1,0,-1];
            const dy = [-1,0,1,0];
            
            for(let k=0; k<turnIndex; k++) {
                checkX += dx[currentDir];
                checkY += dy[currentDir];
                let roads = 0;
                for(let d=0; d<4; d++) {
                    let tx = checkX + dx[d];
                    let ty = checkY + dy[d];
                    if(tx>=0 && tx<GRID_W && ty>=0 && ty<GRID_H && (mapGrid[ty][tx]===1 || mapGrid[ty][tx]===4)) roads++;
                }
                if(roads > 2) cornerCount++;
            }

            let rel = turnDir - currentDir;
            if(rel === -3) rel = 1;
            if(rel === 3) rel = -1;
            let turnWord = (rel === 1) ? "みぎ" : "ひだり";
            let countWord = (cornerCount === 0) ? "すぐ" : (cornerCount + 1) + "つめの かどを";
            
            script += `${countWord} ${turnWord}に まがって ください。`;
        }

        // 4. 最後に「その右/左の建物です」を追加
        // ゴール直前のステップを取得
        // path配列があれば楽だが、stepsしか保存していないので簡易計算
        // stepsの最後のアクションが「道路 -> 建物」
        // stepsの最後から2番目のアクションが「曲がった後の道路移動」
        
        // 最終的な進行方向 (建物に入る直前の道路上の向き)
        let finalRoadDir = -1;
        // turnIndex以降、再度曲がる可能性もあるが、今回は「1回曲がる」前提の簡易案内
        if(turnIndex !== -1) finalRoadDir = turnDir;
        else finalRoadDir = currentDir;

        // 建物へ入る方向 (stepsの最後)
        let enterDir = steps[steps.length-1];

        // 道路進行方向(finalRoadDir)に対して、建物(enterDir)がどっちにあるか
        // 例: 北(0)に進んでいて、建物へは東(1)に入る -> 右側
        let sideRel = enterDir - finalRoadDir;
        if(sideRel === -3) sideRel = 1;
        if(sideRel === 3) sideRel = -1;

        if(sideRel === 1) script += " その みぎがわの たてもの です。";
        else if(sideRel === -1) script += " その ひだりがわの たてもの です。";
        else script += " その つきあたりの たてもの です。";

        return script;
    }

    // --- Game 4 ---
    window.initGame4 = () => {
        currentGameMode = 4;
        showScreen('game-screen');
        generateCityMap();
        renderMap();
        
        document.getElementById('game5-phase1').style.display = 'none';
        document.getElementById('map-controls').style.display = 'block';
        document.getElementById('replay-nav-btn').style.display = 'none';
        document.getElementById('replay-task-btn').style.display = 'block';
        
        document.getElementById('game-title').textContent = "Mission: 探せ！";
        setTimeout(() => speakTask(), 500);
    };

    window.speakTask = () => {
        speak(`${targetObj.kana} に いって ください`);
    }

    // --- Game 5 ---
    window.initGame5 = () => {
        currentGameMode = 5;
        showScreen('game-screen');
        generateCityMap();
        renderMap();
        
        document.getElementById('game5-phase1').style.display = 'block';
        document.getElementById('map-controls').style.display = 'none';
        document.getElementById('replay-nav-btn').style.display = 'none';
        document.getElementById('replay-task-btn').style.display = 'none';
        
        document.getElementById('g5-target-name').textContent = targetObj.name;
        document.getElementById('game-title').textContent = "Mission: 聞き込み";
        document.getElementById('g5-status').textContent = "";
    };

    window.game5SpeechCheck = () => {
        if(!recognition) return alert("マイク不可");
        const btn = document.getElementById('g5-mic-btn');
        btn.classList.add('listening');
        document.getElementById('g5-status').textContent = "聞いています...";
        
        recognition.start();
        recognition.onresult = (e) => {
            const tr = e.results[0][0].transcript;
            if(isSimilar(tr, targetObj.name)) {
                btn.classList.remove('listening');
                startNavigationPhase();
            } else {
                document.getElementById('g5-status').textContent = "もういちど...";
                speak("もういちど おねがいします");
                btn.classList.remove('listening');
            }
        };
        recognition.onend = () => btn.classList.remove('listening');
    };

    function startNavigationPhase() {
        document.getElementById('game5-phase1').style.display = 'none';
        document.getElementById('map-controls').style.display = 'block';
        document.getElementById('replay-nav-btn').style.display = 'block';
        
        navigationText = calculateRoute();
        speak("はい、わかりました。" + navigationText);
    }

    window.speakNavigation = () => {
        speak(navigationText);
    };

    // 移動
    window.movePlayer = (dx, dy) => {
        const nx = playerPos.x + dx;
        const ny = playerPos.y + dy;
        
        if(nx<0 || nx>=GRID_W || ny<0 || ny>=GRID_H) return;
        
        // 川(3)の上は通れない
        if(mapGrid[ny][nx] === 3) return;

        // 建物(2)の上に乗ることも許可する（乗ってゴール）
        
        playerPos.x = nx;
        playerPos.y = ny;
        updatePlayerUI();
    };

    window.checkArrival = () => {
        if(playerPos.x === targetPos.x && playerPos.y === targetPos.y) {
            speak("とうちゃくしました！");
            alert("Congratulations! 正解です！");
            if(currentGameMode===4) initGame4();
            else initGame5();
        } else {
            speak("ここじゃ ありません");
            alert("建物の上に乗ってからボタンを押してください。");
        }
    };

</script>
</body>
</html>